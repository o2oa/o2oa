MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,false);MWF.xApplication.cms.ColumnManager.DictionaryExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],options:{create:MWF.CMSCM.LP.dictionary.create,search:MWF.CMSCM.LP.dictionary.search,searchText:MWF.CMSCM.LP.dictionary.searchText,noElement:MWF.CMSCM.LP.dictionary.noDictionaryNoticeText},keyCopy:function(i){if(this.selectMarkItems.length){var e=[];var n=0;var o=function(t){if(n>=this.selectMarkItems.length){if(e.length){var i=JSON.encode(e);if(t){t.clipboardData.setData("text/plain",i)}else{window.clipboardData.setData("Text",i)}this.app.notice(this.app.lp.copyed,"success")}}}.bind(this);this.selectMarkItems.each(function(t){this.app.restActions.getDictionary(t.data.id,function(t){t.data.elementType="dictionary";e.push(t.data);n++;o(i)}.bind(this),null,false)}.bind(this))}},keyPaste:function(t){var i="";if(t){i=t.clipboardData.getData("text/plain")}else{i=window.clipboardData.getData("Text")}var e=JSON.decode(i);this.pasteItem(e,0)},pasteItem:function(t,i){if(i<t.length){var e=t[i];if(e.elementType==="dictionary"){this.saveItemAs(e,function(){i++;this.pasteItem(t,i)}.bind(this),function(){i++;this.pasteItem(t,i)}.bind(this),function(){this.reload()}.bind(this))}else{i++;this.pasteItem(t,i)}}else{this.reload()}},saveItemAs:function(p,l,d,h){this.app.restActions.listDictionary(this.app.options.application.id,function(t){var i=1;var e=t.data.filter(function(t){return t.id===p.id});if(e.length){var n=e[0];var o=this.app.lp;var a=this;var s=(new Date).parse(p.updateTime);var r=(new Date).parse(n.updateTime);var c="<div>"+o.copyConfirmInfor+"</div>";c+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+o.copySource+" "+n.name+"</div>";c+="<div style='font-size:12px; color: #666666; float: left'>"+n.updateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div>"+"<div style='color: red; float: right;'>"+(s>=r?"":o.copynew)+"</div></div>";c+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+o.copyTarget+" "+p.name+"</div>";c+="<div style='font-size:12px; color: #666666; float: left;'>"+p.updateTime+"</div>"+"<div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div>"+"<div style='color: red; float: right;'>"+(s<=r?"":o.copynew)+"</div></div>";this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:c},500,290,[{text:o.copyConfirm_overwrite,action:function(){a.saveItemAsUpdate(n,p,l,d);this.close()}},{text:o.copyConfirm_new,action:function(){a.saveItemAsNew(t,p,l,d);this.close()}},{text:o.copyConfirm_skip,action:function(){this.close();if(l)l()}},{text:o.copyConfirm_cancel,action:function(){this.close();if(h)h()}}])}else{this.saveItemAsNew(t,p,l,d)}}.bind(this),function(){if(d)d()}.bind(this))},saveItemAsUpdate:function(t,i,e,n){i.id=t.id;i.application=t.application;i.applicationName=t.applicationName;i.name=t.name;i.alias=t.alias;this.app.restActions.saveDictionary(i,function(){if(e)e()}.bind(this),function(){if(n)n()}.bind(this))},saveItemAsNew:function(t,i,e,n){var o=this.app.options.application;var a=o.id;var s=o.name;var r=i.name;var c=1;while(t.data.some(function(t){return t.name==i.name||t.alias==i.name})){i.name=r+"_copy"+c;i.alias=r+"_copy"+c;c++}i.id="";i.application=a;i.applicationName=s;i.appId=a;i.appName=s;this.app.restActions.saveDictionary(i,function(){if(e)e()}.bind(this),function(){if(n)n()}.bind(this))},_createElement:function(t){var i=this;var e={onQueryLoad:function(){this.actions=i.app.restActions;this.application=i.app.options.column;this.column=i.app.options.column},onPostSave:function(){i.reload()}};this.app.desktop.openApplication(t,"cms.DictionaryDesigner",e)},_loadItemDataList:function(t){this.actions.listDictionary(this.app.options.column.id,t)},_getItemObject:function(t,i){return new MWF.xApplication.cms.ColumnManager.DictionaryExplorer.Dictionary(this,t,{index:i})},setTooltip:function(){this.options.tooltip={create:MWF.CMSCM.LP.dictionary.create,search:MWF.CMSCM.LP.dictionary.search,searchText:MWF.CMSCM.LP.dictionary.searchText,noElement:MWF.CMSCM.LP.dictionary.noDictionaryNoticeText}},loadElementList:function(e){this._loadItemDataList(function(t){if(t.data.length){t.data.each(function(t){var i=this._getItemObject(t,this.itemArray.length+1);i.load();this.itemObject[t.id]=i;this.itemArray.push(i)}.bind(this));if(e)e()}else{var i=new Element("div",{styles:this.css.noElementNode,text:this.options.noCreate?MWF.CMSCM.LP.dictionary.noDictionaryNoCreateNoticeText:this.options.tooltip.noElement}).inject(this.elementContentListNode);if(!this.options.noCreate){i.addEvent("click",function(t){this._createElement(t)}.bind(this))}}}.bind(this))},deleteItems:function(){while(this.deleteMarkItems.length){var t=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){t.deleteDictionary()}else{t.deleteDictionary(function(){this.hideDeleteAction();this.reload()}.bind(this))}}}});MWF.xApplication.cms.ColumnManager.DictionaryExplorer.Dictionary=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer.Item,_customNodes:function(){},_open:function(t){var i=this;var e={onQueryLoad:function(){this.actions=i.explorer.actions;this.category=i;this.options.id=i.data.id;this.column=i.explorer.app.options.column;this.application=i.explorer.app.options.column;this.options.noModifyName=i.explorer.options.noModifyName;this.options.readMode=i.explorer.options.readMode}};this.explorer.app.desktop.openApplication(t,"cms.DictionaryDesigner",e)},_getIcon:function(){var t=(Math.random()*33).toInt();return"process_icon_"+t+".png"},_getLnkPar:function(){var t={icon:this.explorer.path+this.explorer.options.style+"/dictionaryIcon/lnk.png",title:this.data.name,par:'cms.DictionaryDesigner#{"id": "'+this.data.id+'", "application" : '+JSON.stringify(this.explorer.app.options.column)+"}"};return t},deleteDictionary:function(t){this.explorer.app.restActions.deleteDictionary(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))}});