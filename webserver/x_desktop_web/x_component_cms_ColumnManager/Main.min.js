MWF.xDesktop.requireApp("cms.ColumnManager","package",null,false);MWF.xDesktop.requireApp("Template","MDomItem",null,false);MWF.xDesktop.requireApp("Selector","package",null,false);MWF.require("MWF.xAction.org.express.RestActions",null,false);MWF.require("MWF.widget.O2Identity",null,false);MWF.xApplication.cms.ColumnManager.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{column:null,application:null,style:"default",name:"cms.ColumnManager",icon:"icon.png",width:"1100",height:"700",title:MWF.xApplication.cms.ColumnManager.LP.title,currentCategoryId:""},onQueryLoad:function(){if(this.options.column)this.options.column.icon=this.options.column.appIcon;if(!this.options.application)this.options.application=this.options.column;this.lp=MWF.xApplication.cms.ColumnManager.LP;this.currentContentNode=null},loadApplication:function(t){this.restActions=MWF.Actions.get("x_cms_assemble_control");if(this.status&&!this.options.currentCategoryId){if(this.status.categoryId){this.options.currentCategoryId=this.status.categoryId}}this.getColumn(function(){this.setTitle(this.options.column.appName+this.lp.setting);this.loadController(function(){if(!this.isAdmin){this.notice(MWF.CMSCM.LP.noAdministratorAccess,"error");this.close()}else{this.createNode();this.loadApplicationContent();if(window.clipboardData){this.addKeyboardEvents()}else{this.keyCopyItemsFun=this.keyCopyItems.bind(this);this.keyPasteItemsFun=this.keyPasteItems.bind(this);document.addEventListener("copy",this.keyCopyItemsFun);document.addEventListener("paste",this.keyPasteItemsFun);this.addEvent("queryClose",function(){debugger;if(this.keyCopyItemsFun)document.removeEventListener("copy",this.keyCopyItemsFun);if(this.keyPasteItemsFun)document.removeEventListener("paste",this.keyPasteItemsFun)}.bind(this))}if(t)t()}}.bind(this))}.bind(this),function(){this.close()}.bind(this))},addKeyboardEvents:function(){this.addEvent("copy",function(){this.keyCopyItems()}.bind(this));this.addEvent("paste",function(){this.keyPasteItems()}.bind(this))},keyCopyItems:function(t){debugger;if(layout.desktop.currentApp&&layout.desktop.currentApp.appId===this.appId){if(this.formConfigurator){this.formConfigurator.keyCopy(t)}if(this.processConfigurator){this.processConfigurator.keyCopy(t)}if(this.dataConfigurator){this.dataConfigurator.keyCopy(t)}if(this.scriptConfigurator){this.scriptConfigurator.keyCopy(t)}}if(t)t.preventDefault()},keyPasteItems:function(t){debugger;if(layout.desktop.currentApp&&layout.desktop.currentApp.appId===this.appId){if(this.formConfigurator){this.formConfigurator.keyPaste(t)}if(this.processConfigurator){this.processConfigurator.keyPaste(t)}if(this.dataConfigurator){this.dataConfigurator.keyPaste(t)}if(this.scriptConfigurator){this.scriptConfigurator.keyPaste(t)}}if(t)t.preventDefault()},loadController:function(e){this.restActions.isAppInfoManager(this.options.column.id,function(t){this.isAdmin=MWF.AC.isCMSManager()||t.data.value;if(e)e(this.isAdmin)}.bind(this))},getColumn:function(e,i){if(!this.options.column){if(this.status){if(this.status.column){this.restActions.getColumn(this.status.column,function(t){if(t.data){this.options.column=t.data;this.options.application=t.data;if(e)e()}else{if(i)i()}}.bind(this),function(){if(i)i()}.bind(this),false)}else{if(i)i()}}else{if(i)i()}}else{if(e)e()}},loadApplicationContent:function(){this.loadStartMenu();this.loadApplicationLayout()},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},loadApplicationLayout:function(){},loadStartMenu:function(t){this.leftContentNode=new Element("div",{styles:this.css.leftContentNode}).inject(this.node);this.leftTitleNode=new Element("div",{styles:this.css.leftTitleNode}).inject(this.leftContentNode);this.leftTitleIconNode=new Element("div",{styles:this.css.leftTitleIconNode}).inject(this.leftTitleNode);if(this.options.column){var e=this.options.column.icon||this.options.column.appIcon;if(e){this.leftTitleIconNode.setStyle("background-image","url(data:image/png;base64,"+e+")")}else{this.leftTitleIconNode.setStyle("background-image","url("+"/x_component_cms_Column/$Main/default/icon/column.png)")}}this.leftTitleTextNode=new Element("div",{styles:this.css.leftTitleTextNode,text:this.options.column.appName+this.lp.setting,title:this.options.column.appName+this.lp.setting}).inject(this.leftTitleNode);this.startMenuNode=new Element("div",{styles:this.css.normalStartMenuNode}).inject(this.leftContentNode);this.menu=new MWF.xApplication.cms.ColumnManager.Menu(this,this.startMenuNode,{onPostLoad:function(){var t="categoryConfig";if(this.status){if(this.status.navi!=null&&this.menu.itemObject[this.status.navi]){this.menu.doAction(this.menu.itemObject[this.status.navi])}else{this.menu.doAction(this.menu.itemObject[t])}}else{this.menu.doAction(this.menu.startNavis[0])}}.bind(this)})},clearContent:function(){if(this.categoryConfiguratorContent){this.categoryConfiguratorContent.setStyle("display","none")}if(this.formConfiguratorContent){if(this.formConfigurator)delete this.formConfigurator;this.formConfiguratorContent.destroy();this.formConfiguratorContent=null}if(this.propertyConfiguratorContent){if(this.property)delete this.property;this.propertyConfiguratorContent.destroy();this.propertyConfiguratorContent=null}if(this.dataConfiguratorContent){if(this.dataConfigurator)delete this.dataConfigurator;this.dataConfiguratorContent.destroy();this.dataConfiguratorContent=null}if(this.scriptConfiguratorContent){if(this.scriptConfigurator)delete this.scriptConfigurator;this.scriptConfiguratorContent.destroy();this.scriptConfiguratorContent=null}if(this.viewConfiguratorContent){if(this.viewConfigurator)delete this.viewConfigurator;this.viewConfiguratorContent.destroy();this.viewConfiguratorContent=null}if(this.queryViewConfiguratorContent){if(this.queryViewConfigurator)delete this.queryViewConfigurator;this.queryViewConfiguratorContent.destroy();this.queryViewConfiguratorContent=null}},applicationProperty:function(){this.clearContent();this.propertyConfiguratorContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);this.property=new MWF.xApplication.cms.ColumnManager.ApplicationProperty(this,this.propertyConfiguratorContent);this.property.load()},cagetoryConfig:function(t){this.clearContent();if(this.categoryConfiguratorContent){this.categoryConfiguratorContent.setStyle("display","");if(this.menu.itemObject["categoryConfig"]){this.menu.expend(this.menu.itemObject["categoryConfig"])}if(!t)this.categoryConfigurator.refresh()}else{this.categoryConfiguratorContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);this.loadCategoryConfig()}},loadCategoryConfig:function(){MWF.xDesktop.requireApp("cms.ColumnManager","CategoryExplorer",function(){var t=this.menu.itemObject.categoryConfig;var e=t.retrieve("subNode");this.categoryConfigurator=new MWF.xApplication.cms.ColumnManager.CategoryExplorer(this.categoryConfiguratorContent,e,this.restActions,{currentCategoryId:this.options.currentCategoryId,onPostLoadCategoryList:function(){}.bind(this),onPostClickSub:function(){this.menu.cancelCurrentNavi()}.bind(this)});this.categoryConfigurator.app=this;this.categoryConfigurator.load();this.options.currentCategoryId=""}.bind(this))},createCategory:function(){this.cagetoryConfig(true);if(this.categoryConfigurator){this.categoryConfigurator.categoryList.newCategory()}},setCategory:function(t){this.cagetoryConfig(true);if(this.categoryConfigurator){this.categoryConfigurator.categoryList.setCurrentCategoryById(t)}},formConfig:function(){this.clearContent();this.formConfiguratorContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);this.loadFormConfig()},loadFormConfig:function(){MWF.xDesktop.requireApp("cms.ColumnManager","FormExplorer",function(){this.formConfigurator=new MWF.xApplication.cms.ColumnManager.FormExplorer(this.formConfiguratorContent,this.restActions,{title:"表单配置"});this.formConfigurator.app=this;this.formConfigurator.load()}.bind(this))},createForm:function(){if(this.formConfigurator){this.formConfigurator._createElement()}else{MWF.xDesktop.requireApp("cms.ColumnManager","FormExplorer",function(){this.formConfigurator=new MWF.xApplication.cms.ColumnManager.FormExplorer(this.formConfiguratorContent,this.restActions);this.formConfigurator.app=this;this.formConfigurator._createElement()}.bind(this))}},dataConfig:function(){this.clearContent();this.dataConfiguratorContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);this.loadDataConfig()},loadDataConfig:function(){MWF.xDesktop.requireApp("cms.ColumnManager","DictionaryExplorer",function(){this.dataConfigurator=new MWF.xApplication.cms.ColumnManager.DictionaryExplorer(this.dataConfiguratorContent,this.restActions,{title:"数据配置"});this.dataConfigurator.app=this;this.dataConfigurator.load()}.bind(this))},createDataConfig:function(){if(this.dataConfigurator){this.dataConfigurator._createElement()}else{MWF.xDesktop.requireApp("cms.ColumnManager","DictionaryExplorer",function(){this.dataConfigurator=new MWF.xApplication.cms.ColumnManager.DictionaryExplorer(this.dataConfiguratorContent,this.restActions);this.dataConfigurator.app=this;this.dataConfigurator._createElement()}.bind(this))}},scriptConfig:function(){this.clearContent();this.oContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);this.loadScriptConfig()},loadScriptConfig:function(){MWF.xDesktop.requireApp("cms.ColumnManager","ScriptExplorer",function(){this.scriptConfigurator=new MWF.xApplication.cms.ColumnManager.ScriptExplorer(this.scriptConfiguratorContent,this.restActions,{title:"脚本配置"});this.scriptConfigurator.app=this;this.scriptConfigurator.load()}.bind(this))},createScriptConfig:function(){if(this.scriptConfigurator){this.scriptConfigurator._createElement()}else{MWF.xDesktop.requireApp("cms.ColumnManager","ScriptExplorer",function(){this.scriptConfigurator=new MWF.xApplication.cms.ColumnManager.ScriptExplorer(this.scriptConfiguratorContent,this.restActions);this.scriptConfigurator.app=this;this.scriptConfigurator._createElement()}.bind(this))}},viewConfig:function(){this.clearContent();this.viewConfiguratorContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);this.loadViewConfig()},loadViewConfig:function(){MWF.xDesktop.requireApp("cms.ColumnManager","ViewExplorer",function(){this.viewConfigurator=new MWF.xApplication.cms.ColumnManager.ViewExplorer(this.viewConfiguratorContent,this.restActions,{title:"列表配置"});this.viewConfigurator.app=this;this.viewConfigurator.load()}.bind(this))},createView:function(){if(this.viewConfigurator){this.viewConfigurator._createElement()}else{MWF.xDesktop.requireApp("cms.ColumnManager","ViewExplorer",function(){this.viewConfigurator=new MWF.xApplication.cms.ColumnManager.ViewExplorer(this.viewConfiguratorContent,this.restActions);this.viewConfigurator.app=this;this.viewConfigurator._createElement()}.bind(this))}},queryViewConfig:function(){this.clearContent();this.queryViewConfiguratorContent=new Element("div",{styles:this.css.rightContentNode}).inject(this.node);this.loadQueryViewConfig()},loadQueryViewConfig:function(){MWF.xDesktop.requireApp("cms.ColumnManager","QueryViewExplorer",function(){this.queryViewConfigurator=new MWF.xApplication.cms.ColumnManager.QueryViewExplorer(this.queryViewConfiguratorContent,this.restActions,{title:"数据视图配置"});this.queryViewConfigurator.app=this;this.queryViewConfigurator.load()}.bind(this))},createQueryView:function(){if(this.queryViewConfigurator){this.queryViewConfigurator._createElement()}else{MWF.xDesktop.requireApp("cms.ColumnManager","QueryViewExplorer",function(){this.queryViewConfigurator=new MWF.xApplication.cms.ColumnManager.QueryViewExplorer(this.queryViewConfiguratorContent,this.restActions);this.queryViewConfigurator.app=this;this.queryViewConfigurator._createElement()}.bind(this))}},getCategoryCount:function(){if(this.categoryConfigurator){var t=this.categoryConfigurator.categoryNode.getSize();categoryCount=parseInt(t.x/401)*parseInt(t.y/101)+10;return categoryCount}return 20},showContentNode:function(t){if(this.currentContentNode){this.currentContentNode.fade("hide");t.fade("show");t.setStyle("display","node");this.currentContentNode=null}t.setStyle("display","block");t.fade("show");this.currentContentNode=t},recordStatus:function(){var t=null;var e="";if(this.menu.currentNavi){var i=this.menu.currentNavi.retrieve("naviData");t=i.id}if(t=="categoryConfig"){if(this.categoryConfigurator&&this.categoryConfigurator.categoryList){var n=this.categoryConfigurator.categoryList;if(n.currentCategory&&n.currentCategory.data){e=n.currentCategory.data.id}}}return{navi:t,column:this.options.column.id,categoryId:e}}});MWF.xApplication.cms.ColumnManager.Menu=new Class({Implements:[Options,Events],initialize:function(t,e,i){this.setOptions(i);this.app=t;this.node=$(e);this.currentNavi=null;this.status="start";this.startNavis=[];this.itemObject={};this.load()},load:function(){this.areaNode=new Element("div.startMenuAreaNode",this.app.css.startMenuAreaNode).inject(this.node);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.node,{style:"xApp_ProcessManager_StartMenu",distance:100,friction:4,axis:{x:false,y:true}})}.bind(this));var t=this.app.path+"startMenu.json";MWF.getJSON(t,function(t){t.each(function(t){var e=new Element("div",{styles:this.app.css.startMenuNaviNode});e.store("naviData",t);if(t.expand){var i=new Element("div",{styles:this.app.css.startMenuExpandNode});i.inject(e);e.store("expandNode",i)}else{new Element("div",{styles:this.app.css.startMenuEmptyNode}).inject(e)}var n=new Element("div",{styles:this.app.css.startMenuIconNode}).inject(e);n.setStyle("background-image","url("+this.app.path+this.app.options.style+"/icon/"+t.icon+")");e.store("iconNode",n);var s=new Element("div",{styles:this.app.css.startMenuTextNode,text:t.title});s.inject(e);if(t.create){var o=new Element("div",{styles:this.app.css.startMenuCreateNode,title:"新建"+t.title});o.inject(e);e.store("createNode",o);o.addEvents({click:function(t){this.obj.app[this.navi.createAction]();t.stopPropagation()}.bind({obj:this,navi:t}),mouseover:function(t){if(this.obj.currentNavi==this.naviNode&&!this.naviData.unselected){this.createNode.setStyles(this.obj.app.css.startMenuCreateNode_current_over)}else{this.createNode.setStyles(this.obj.app.css.startMenuCreateNode_over)}}.bind({obj:this,createNode:o,naviNode:e,naviData:t}),mouseout:function(t){if(this.obj.currentNavi==this.naviNode&&!this.naviData.unselected){this.createNode.setStyles(this.obj.app.css.startMenuCreateNode_current)}else{this.createNode.setStyles(this.obj.app.css.startMenuCreateNode)}}.bind({obj:this,createNode:o,naviNode:e,naviData:t})})}e.inject(this.areaNode);if(t.expand){var a=new Element("div",{styles:this.app.css.startMenuSubContentNode});a.inject(this.areaNode);e.store("subNode",a)}this.startNavis.push(e);this.itemObject[t.id]=e;this.setStartNaviEvent(e,t)}.bind(this));this.setContentSize();this.app.addEvent("resize",this.setContentSize.bind(this));this.fireEvent("postLoad")}.bind(this))},setStartNaviEvent:function(t){var e=this;t.addEvents({mouseover:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.startMenuNaviNode_over)},mouseout:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.startMenuNaviNode)},mousedown:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.startMenuNaviNode_down)},mouseup:function(){if(e.currentNavi!=this)this.setStyles(e.app.css.startMenuNaviNode_over)},click:function(){e.doAction.apply(e,[this])}})},expend:function(t){var e=t.retrieve("isExpand");if(!e){var i=t.retrieve("expandNode");i.setStyles(this.app.css.startMenuCollapseNode);var n=t.retrieve("subNode");n.setStyle("display","");t.store("isExpand",true)}},collapse:function(t){var e=t.retrieve("isExpand");if(e){var i=t.retrieve("expandNode");i.setStyles(this.app.css.startMenuExpandNode);var n=t.retrieve("subNode");n.setStyle("display","none");t.store("isExpand",false)}},cancelCurrentNavi:function(){if(this.currentNavi){this.currentNavi.setStyles(this.app.css.startMenuNaviNode);var t=this.currentNavi.retrieve("iconNode");var e=this.currentNavi.retrieve("naviData");t.setStyle("background-image","url("+this.app.path+this.app.options.style+"/icon/"+e.icon+")")}},doAction:function(t){if(this.currentNavi&&this.currentNavi==t){var e=this.currentNavi.retrieve("naviData");if(e.expand){var i=this.currentNavi.retrieve("isExpand");if(i){var n=this.currentNavi.retrieve("expandNode");n.setStyles(this.app.css.startMenuExpandNode);var s=this.currentNavi.retrieve("subNode");s.setStyle("display","none");this.currentNavi.store("isExpand",false)}else{var n=this.currentNavi.retrieve("expandNode");n.setStyles(this.app.css.startMenuCollapseNode);var s=this.currentNavi.retrieve("subNode");s.setStyle("display","");this.currentNavi.store("isExpand",true)}}return}if(this.currentNavi){this.currentNavi.setStyles(this.app.css.startMenuNaviNode);var o=this.currentNavi.retrieve("iconNode");var e=this.currentNavi.retrieve("naviData");o.setStyle("background-image","url("+this.app.path+this.app.options.style+"/icon/"+e.icon+")");if(e.expand){var n=this.currentNavi.retrieve("expandNode");n.setStyles(this.app.css.startMenuExpandNode);var s=this.currentNavi.retrieve("subNode");s.setStyle("display","none");this.currentNavi.store("isExpand",false)}if(e.create){var a=this.currentNavi.retrieve("createNode");a.setStyles(this.app.css.startMenuCreateNode)}}if(t){var e=t.retrieve("naviData");var r=e.action;if(!e.unselected){t.setStyles(this.app.css.startMenuNaviNode_current);var o=t.retrieve("iconNode");o.setStyle("background-image","url("+this.app.path+this.app.options.style+"/icon/"+e.selectedIcon+")")}if(e.expand){if(!e.unselected){var n=t.retrieve("expandNode");n.setStyles(this.app.css.startMenuCollapseNode_current)}else{var n=t.retrieve("expandNode");n.setStyles(this.app.css.startMenuCollapseNode)}var s=t.retrieve("subNode");s.setStyle("display","");t.store("isExpand",true)}if(e.create){var a=t.retrieve("createNode");if(!e.unselected){a.setStyles(this.app.css.startMenuCreateNode_current)}else{a.setStyles(this.app.css.startMenuCreateNode)}}if(this.app[r])this.app[r].apply(this.app)}this.currentNavi=t},setContentSize:function(){var t=this.app.content.getSize();this.node.setStyle("height",t.y-82)}});MWF.xApplication.cms.ColumnManager.ApplicationProperty=new Class({initialize:function(t,e){this.app=t;this.node=$(e);this.data=this.app.options.application;this.controllerData=[];this.controllerList=[]},load:function(){this.propertyTitleBar=new Element("div.propertyTitleBar",{styles:this.app.css.propertyTitleBar,text:"栏目属性"}).inject(this.node);this.contentNode=new Element("div.propertyContentNode",{styles:this.app.css.propertyContentNode}).inject(this.node);this.contentAreaNode=new Element("div.propertyContentAreaNode",{styles:this.app.css.propertyContentAreaNode}).inject(this.contentNode);this.setContentHeight();this.setContentHeightFun=this.setContentHeight.bind(this);this.app.addEvent("resize",this.setContentHeightFun);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.contentNode,{indent:false})}.bind(this));this.baseActionAreaNode=new Element("div.baseActionAreaNode",{styles:this.app.css.baseActionAreaNode}).inject(this.contentAreaNode);this.baseActionNode=new Element("div.propertyInforActionNode",{styles:this.app.css.propertyInforActionNode}).inject(this.baseActionAreaNode);this.baseTextNode=new Element("div.baseTextNode",{styles:this.app.css.baseTextNode,text:this.app.lp.application.property}).inject(this.baseActionAreaNode);this.createEditBaseNode();this.createPropertyContentNode();this.createIconContentNode();this.viewerContainer=new Element("div").inject(this.contentAreaNode);MWF.xDesktop.requireApp("cms.ColumnManager","widget.ColumnViewerSetting",null,false);this.viewerSetting=new MWF.xApplication.cms.ColumnManager.ColumnViewerSetting(this.app,this.app.lp.application.viewerSetting,this.viewerContainer,{objectId:this.data.id});this.viewerSetting.dataParent=this;this.viewerSetting.load();this.publisherContainer=new Element("div").inject(this.contentAreaNode);MWF.xDesktop.requireApp("cms.ColumnManager","widget.ColumnPublisherSetting",null,false);this.publisherSetting=new MWF.xApplication.cms.ColumnManager.ColumnPublisherSetting(this.app,this.app.lp.application.publisherSetting,this.publisherContainer,{objectId:this.data.id});this.publisherSetting.dataParent=this;this.publisherSetting.load();this.managerContainer=new Element("div").inject(this.contentAreaNode);MWF.xDesktop.requireApp("cms.ColumnManager","widget.ColumnManagerSetting",null,false);this.viewerSetting=new MWF.xApplication.cms.ColumnManager.ColumnManagerSetting(this.app,this.app.lp.application.managerSetting,this.managerContainer,{objectId:this.data.id});this.viewerSetting.dataParent=this;this.viewerSetting.load()},setContentHeight:function(){var t=this.app.content.getSize();var e=this.propertyTitleBar.getSize();var i=t.y-e.y;this.contentNode.setStyle("height",""+i+"px")},createIconContentNode:function(){this.iconContentTitleNode=new Element("div.iconContentTitleNode",{styles:this.app.css.iconContentTitleNode,text:this.app.lp.application.icon}).inject(this.contentAreaNode);this.iconContentNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.contentAreaNode);var t="<table cellspacing='0' cellpadding='0' border='0' width='95%' align='center' style='margin-top: 20px'>";t+="<tr><td class='formTitle'><div id='formIconPreview'></div></td><td id='formChangeIconAction'></td></tr>";t+="</table>";this.iconContentNode.set("html",t);this.iconContentNode.getElements("td.formTitle").setStyles(this.app.css.propertyBaseContentTdTitle);this.iconPreviewNode=this.iconContentNode.getElement("div#formIconPreview");this.iconActionNode=this.iconContentNode.getElement("td#formChangeIconAction");this.iconPreviewNode.setStyles({height:"72px",width:"72px",float:"right"});var e=this.data.icon||this.data.appIcon;if(e){this.iconPreviewNode.setStyle("background","url(data:image/png;base64,"+e+") center center no-repeat")}else{this.iconPreviewNode.setStyle("background","url("+"/x_component_cms_Column/$Main/default/icon/column.png) center center no-repeat")}var i=new Element("div",{styles:this.app.css.selectButtonStyle,text:"更改图标"}).inject(this.iconActionNode);i.addEvent("click",function(){this.changeIcon()}.bind(this))},changeIcon:function(){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");var t='<input name="file" type="file"/>';this.uploadFileAreaNode.set("html",t);this.fileUploadNode=this.uploadFileAreaNode.getFirst();this.fileUploadNode.addEvent("change",function(){var t=s.files;if(t.length){for(var e=0;e<t.length;e++){var i=t.item(e);var n=new FormData;n.append("file",i);this.app.restActions.updataColumnIcon(this.data.id,function(){this.app.restActions.getColumn(this.data.id,function(t){if(t.data){this.data=t.data;if(this.data.appIcon){this.iconPreviewNode.setStyle("background","url(data:image/png;base64,"+this.data.appIcon+") center center no-repeat")}else{this.iconPreviewNode.setStyle("background","url("+"/x_component_cms_Column/$Main/default/icon/category2.png) center center no-repeat")}}}.bind(this),false)}.bind(this),null,n,i)}}}.bind(this))}var s=this.uploadFileAreaNode.getFirst();s.click()},createPropertyContentNode:function(){this.propertyContentNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.contentAreaNode);var t="<table cellspacing='0' cellpadding='0' border='0' width='95%' align='center' style='margin-top: 20px'>";t+="<tr><td class='formTitle'>"+this.app.lp.application.id+"</td><td id='formApplicationId' class='formValue'>"+this.data.id+"</td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.application.name+"</td><td id='formApplicationName'></td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.application.sign+"</td><td id='formApplicationAlias' class='formValue'>"+(this.data.alias||this.data.appAlias||"")+"</td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.application.documentType+"</td><td id='formApplicationType' class='formValue'>"+(this.data.documentType||"信息")+"</td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.application.description+"</td><td id='formApplicationDescription'></td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.application.sort+"</td><td id='formApplicationSort'></td></tr>";t+="</table>";this.propertyContentNode.set("html",t);this.propertyContentNode.getElements("td.formTitle").setStyles(this.app.css.propertyBaseContentTdTitle);this.propertyContentNode.getElements("td.formValue").setStyles(this.app.css.propertyBaseContentTdValue);this.nameInput=new MWF.xApplication.cms.ColumnManager.Input(this.propertyContentNode.getElement("#formApplicationName"),this.data.name||this.data.appName,this.app.css.formInput);this.typeSelect=new MDomItem(this.propertyContentNode.getElement("#formApplicationType"),{type:"select",value:this.data.documentType||"信息",selectValue:["信息","数据"]});this.descriptionInput=new MWF.xApplication.cms.ColumnManager.Input(this.propertyContentNode.getElement("#formApplicationDescription"),this.data.description,this.app.css.formInput);this.sortInput=new MWF.xApplication.cms.ColumnManager.Input(this.propertyContentNode.getElement("#formApplicationSort"),this.data.appInfoSeq,this.app.css.formInput)},createEditBaseNode:function(){this.editBaseNode=new Element("button.editBaseNode",{styles:this.app.css.editBaseNode,text:this.app.lp.edit,events:{click:this.editBaseInfor.bind(this)}}).inject(this.baseActionNode)},createCancelBaseNode:function(){this.cancelBaseNode=new Element("button.cancelBaseNode",{styles:this.app.css.cancelBaseNode,text:this.app.lp.cancel,events:{click:this.cancelBaseInfor.bind(this)}}).inject(this.baseActionNode)},createSaveBaseNode:function(){this.saveBaseNode=new Element("button.saveBaseNode",{styles:this.app.css.saveBaseNode,text:this.app.lp.save,events:{click:this.saveBaseInfor.bind(this)}}).inject(this.baseActionNode)},editBaseInfor:function(){this.baseActionNode.empty();this.editBaseNode=null;this.createCancelBaseNode();this.createSaveBaseNode();this.editMode()},editMode:function(){this.nameInput.editMode();this.descriptionInput.editMode();this.sortInput.editMode();this.typeSelect.editMode();this.isEdit=true},readMode:function(){this.nameInput.readMode();this.descriptionInput.readMode();this.sortInput.readMode();this.typeSelect.readMode();this.isEdit=false},cancelBaseInfor:function(){if(this.data.name||this.data.appName||this.data.id){this.baseActionNode.empty();this.cancelBaseNode=null;this.saveBaseNode=null;this.createEditBaseNode();this.readMode()}else{this.destroy()}},saveBaseInfor:function(){if(!this.nameInput.input.get("value")){this.app.notice(this.app.lp.application.inputApplicationName,"error",this.node);return false}this.save(function(){this.baseActionNode.empty();this.cancelBaseNode=null;this.saveBaseNode=null;this.createEditBaseNode();this.readMode()}.bind(this),function(t,e,i){var n=i;if(t)n=t.responseText;this.app.notice("request json error: "+n,"error")}.bind(this))},save:function(e,n){this.data.name=this.nameInput.input.get("value");this.data.appName=this.data.name;this.data.description=this.descriptionInput.input.get("value");this.data.appInfoSeq=this.sortInput.input.get("value");this.data.documentType=this.typeSelect.getValue();this.app.restActions.saveColumn(this.data,function(t){this.propertyTitleBar.set("text",this.data.name);this.data.id=t.data.id;this.nameInput.save();this.descriptionInput.save();this.sortInput.save();this.typeSelect.save();this.app.notice(this.app.lp.application.saveSuccess,"success");if(e)e()}.bind(this),function(t,e,i){if(n)n(t,e,i)}.bind(this))}});MWF.xApplication.cms.ColumnManager.Input=new Class({Implements:[Events],initialize:function(t,e,i){this.node=$(t);this.value=e||"";this.style=i;this.load()},load:function(){this.content=new Element("div",{styles:this.style.content,text:this.value}).inject(this.node)},editMode:function(){this.content.empty();this.input=new Element("input",{styles:this.style.input,value:this.value}).inject(this.content);this.input.addEvents({focus:function(){this.input.setStyles(this.style.input_focus)}.bind(this),blur:function(){this.input.setStyles(this.style.input)}.bind(this)})},readMode:function(){this.content.empty();this.input=null;this.content.set("text",this.value)},save:function(){if(this.input)this.value=this.input.get("value");return this.value}});