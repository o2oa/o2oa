MWF.widget=MWF.widget||{};MWF.widget.chart=MWF.widget.chart||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.widget.chart.d3",null,false);MWF.widget.chart.Bar=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",xais:true,direction:{x:"bottom",y:"left"},ticks:10,xText:"",yText:"text",marginLeft:40,marginRight:0,marginTop:20,marginBottom:46,tickFormat:"",dataFormat:"",delay:80,duration:200,transition:Fx.Transitions.Back.easeIn},initialize:function(t,s,i,e){this.setOptions(e);this.bars=[];this.item=i;this.node=$(t);this.data=s;this.path=MWF.defaultPath+"/widget/chart/$Bar/";this.cssPath=MWF.defaultPath+"/widget/chart/$Bar/"+this.options.style+"/css.wcss";this._loadCss();this.colors=this.css.colors||d3.schemeCategory10},setItem:function(t){this.item=t},addBar:function(t){this.bars.push(t)},load:function(){this.svgNode=new Element("div",{styles:this.css.svgNode}).inject(this.node);if(this.fireEvent("queryLoad")){this.size=this.node.getSize();MWF.widget.chart.d3.load(function(){this.svg=d3.select(this.svgNode).append("svg");this.group=this.svg.append("g");this.setSvgSize();this.loadScales();this.loadXaes();this.loadBars();this.setStyles();this.setEvents()}.bind(this));this.fireEvent("postLoad")}},loadScales:function(){this.xScale=d3.scaleBand().domain(this.data.map(function(t){return t[this.item]}.bind(this))).rangeRound(this.getXScaleRange()).paddingOuter(.3).paddingInner(.3);this.barsData=[];this.bars.each(function(t,s){this.barsData.push(this.data.map(function(i,e){return typeOf(t)=="function"?{name:i[this.item],data:t(i,s)}:{name:i[this.item],data:i[t]}}.bind(this)))}.bind(this));var t=d3.max(this.barsData,function(t){return d3.max(t,function(t){return t.data})});this.yScale=d3.scaleLinear().domain([0,t]).range(this.getYScaleRange())},loadBars:function(){this.rectClass=Math.round(Math.random()*100);var t=this.xScale.bandwidth()/this.barsData.length;this.rectCluster=[];this.textCluster=[];this.barsData.each(function(s,i){var e=this.group.selectAll(".MWFBar_"+this.rectClass+"_"+i).data(s).enter().append("rect").attr("class",".MWFBar_"+this.rectClass+"_"+i).attr("x",function(s){return this.xScale(s.name)+i*t}.bind(this)).attr("width",t).attr("y",this.size.y).attr("height",0).attr("fill",this.colors[i]);this.rectCluster.push(e);var a=this.group.selectAll(".MWFBarText_"+this.rectClass+"_"+i).data(s).enter().append("text").text(function(t){return this.options.dataFormat?d3.format(this.options.dataFormat)(t.data):t.data}.bind(this)).attr("x",function(s){var e=MWF.getTextSize(this.options.dataFormat?d3.format(this.options.dataFormat)(s.data):s.data).x;return e<t?this.xScale(s.name)+i*t+t/2-e/2:this.xScale(s.name)+i*t}.bind(this)).attr("y",function(t){return this.yScale(t.data)-5}.bind(this));this.textCluster.push(a)}.bind(this));this.transition()},transition:function(t){if(!t)t=this.group.selectAll("rect");t.attr("y",this.size.y).attr("height",0);t.transition().delay(function(t,s){return s*this.options.delay}.bind(this)).duration(this.options.duration).ease(d3.easeExpOut).attr("height",function(t){return this.size.y-this.yScale(t.data)}.bind(this)).attr("y",function(t){return this.yScale(t.data)}.bind(this))},loadXaes:function(){var t=("axis-"+this.options.direction.x).camelCase();this.xAxis=d3[t]().scale(this.xScale);var s=("axis-"+this.options.direction.y).camelCase();this.yAxis=d3[s]().scale(this.yScale).ticks(this.options.ticks);if(this.options.tickFormat){this.yAxis.tickFormat(d3.format(this.options.tickFormat))}this.xais_x_group=this.svg.append("g").attr("transform","translate("+this.options.marginLeft+","+(this.size.y+this.options.marginTop)+")").call(this.xAxis);if(this.options.xais){this.xais_y_group=this.svg.append("g").attr("transform","translate("+this.options.marginLeft+","+this.options.marginTop+")");this.xais_y_group.call(this.yAxis)}},getXScaleRange:function(){return[0,this.size.x]},getYScaleRange:function(){return[this.size.y,0]},setSvgSize:function(){var t=this.size.x-(this.options.marginLeft+this.options.marginRight);var s=this.size.y-(this.options.marginTop+this.options.marginBottom);this.svg.attr("width",this.size.x).attr("height",this.size.y);this.group.attr("width",t).attr("height",s).attr("transform","translate("+this.options.marginLeft+","+this.options.marginTop+")");this.size={x:t,y:s}},setStyles:function(){var t=this;var s=this.xais_x_group.selectAll("text");var i=this.xais_x_group.selectAll("path");var e=this.xais_x_group.selectAll("line");Object.each(this.css.xxais_text,function(i,e){s.attr(e,function(s){return typeOf(i)=="function"?i.apply(t,[s,this]):i})}.bind(this));Object.each(this.css.xxais_path,function(t,s){i.attr(s,t)}.bind(this));Object.each(this.css.xxais_line,function(t,s){e.attr(s,t)}.bind(this));this.setDefs("xxais_text_defs",s);this.setDefs("xxais_path_defs",i);this.setDefs("xxais_line_defs",e);if(this.xais_y_group){s=this.xais_y_group.selectAll("text");i=this.xais_y_group.selectAll("path");e=this.xais_y_group.selectAll("line");Object.each(this.css.yxais_text,function(t,i){s.attr(i,t)}.bind(this));Object.each(this.css.yxais_path,function(t,s){i.attr(s,t)}.bind(this));Object.each(this.css.yxais_line,function(t,s){e.attr(s,t)}.bind(this));this.setDefs("yxais_text_defs",s);this.setDefs("yxais_path_defs",i);this.setDefs("yxais_line_defs",e)}var a=this.group.selectAll("rect");s=this.group.selectAll("text");Object.each(this.css.rect,function(t,s){a.attr(s,t)}.bind(this));Object.each(this.css.rectText,function(i,e){s.attr(e,function(s){return typeOf(i)=="function"?i.apply(t,[s,this]):i})}.bind(this));this.setDefs("rect_defs",a);this.setDefs("rectText_defs",s)},setEvents:function(){var t=this.group.selectAll("rect");var s=this.group.selectAll("text");t.on("mouseover",function(i,e,a){this.fireEvent("mouseover",[t,s,i,e])}.bind(this)).on("mouseout",function(i,e,a){this.fireEvent("mouseout",[t,s,i,e])}.bind(this)).on("click",function(i,e,a){this.fireEvent("click",[t,s,i,e])}.bind(this))},setDefs:function(t,s){if(this.css[t]){var i=this.svg.append("defs");this.createDefs(i,this.css[t]);i.select(function(){return this.getFirst()}).attr("id",this.classId+"_"+t);s.attr(this.css[t].urlAttr,"url(#"+this.classId+"_"+t+")")}},createDefs:function(t,s){var i=t.append(s.tag);Object.each(s.attrs,function(t,s){i.attr(s,t)});if(s.subs){s.subs.each(function(t){this.createDefs(i,t)}.bind(this))}},destroy:function(){this.svgNode.destroy();MWF.release(this)}});