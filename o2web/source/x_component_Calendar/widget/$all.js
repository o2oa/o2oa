o2.widget = o2.widget || {};
if( !o2.widget.UUID )o2.require("o2.widget.UUID", null, false);
o2.widget.AttachmentController = o2.widget.ATTER  = new Class({
    Extends: o2.widget.Common,
	Implements: [Options, Events],
	options: {
		"style": "default",
        "listStyle": "icon",
        "size": "max",
        "resize": true,
        "attachmentCount": 0,
        "isUpload": true,
        "isDelete": true,
        "isReplace": true,
        "isDownload": true,
        "isPreviewAtt": true,
        "isSizeChange": true,
        "isConfig": true,
        "isOrder": true,
        "readonly": false,
        "availableListStyles" : ["list","seq","icon","preview"],
        "toolbarGroupHidden" : [], //edit read list view
        "singleToolbarHidden" : [], //delete edit config open edit
        "images": ["bmp", "gif", "png", "jpeg", "jpg", "jpe", "ico"],
        "audios": ["mp3", "wav", "wma", "wmv"],
        "videos": ["avi", "mkv", "mov", "ogg", "mp4", "mpa", "mpe", "mpeg", "mpg", "rmvb"],
        "actionShowText" : false
	},
	initialize: function(container, module, options){
		this.setOptions(options);
		this.pages = [];

		this.path = o2.session.path+"/widget/$AttachmentController/";
		this.cssPath = o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/css.wcss";
		this._loadCss();

        var iconUrl = this.options.iconConfigUrl ? this.options.iconConfigUrl : "../x_component_File/$Main/icon.json";
        o2.getJSON(iconUrl, function(json){
            this.icons = json;
        }.bind(this), false);

        this.module = module;

        this.actions = [];
        this.attachments = [];
        this.selectedAttachments = [];
		this.container = $(container);
	},
    load: function(){
        // if (!layout.mobile){
            if (this.options.size==="min"){
                this.loadMin();
            }else{
                this.loadMax();
            }
        // }else{
        //     this.loadMobile();
        // }
    },
    reloadAttachments: function(){
        if (this.options.size==="min"){
            this.minContent.empty();
            var atts = this.attachments;
            this.attachments = [];
            while (atts.length){
                var att = atts.shift();
                this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(att.data, this));
            }
        }else{
            this.content.empty();
            var atts = this.attachments;
            this.attachments = [];
            while (atts.length){
                var att = atts.shift();
                this.attachments.push(new o2.widget.AttachmentController.Attachment(att.data, this));
            }
        }
        this.checkActions();
    },
    getAttachmentById: function(attId){
        for( var i=0; i<this.attachments.length; i++ ){
            if( this.attachments[i].data.id === attId ){
                return this.attachments[i];
            }
        }
        return null;
    },
	loadMax: function(){
        if (!this.node) this.node = new Element("div", {"styles": this.css.container});

        this.createTopNode();

        if (!this.contentScrollNode){
            //this.createTopNode();
            this.createContentNode();


            if (this.options.resize){
                this.createBottomNode();
                this.createResizeNode();
            }

            this.node.inject(this.container);

            //if (this.options.readonly) this.setReadonly();
            this.checkActions();

            this.setEvent();
        }else{
            // this.contentScrollNode.setStyle("display", "block");
            // if (this.bottomNode) this.bottomNode.setStyle("display", "block");
            // if (this.titleNode) this.titleNode.setStyle("display", "block");

            this.contentScrollNode.show();
            if (this.bottomNode) this.bottomNode.show();
            if (this.titleNode) this.titleNode.show();

            //this.topNode.setStyle("display", "block");
            this.content.empty();
        }
        var atts = this.attachments;
        this.attachments = [];
        while (atts.length){
            var att = atts.shift();
            this.attachments.push(new o2.widget.AttachmentController.Attachment(att.data, this));
        }
        this.checkActions();
        //this.attachments = atts;
        if( layout.mobile ){
            this.checkActionsZoom();
        }
	},
    loadMin: function(){

        if (!this.node) this.node = new Element("div", {"styles": this.css.container_min});

        if (!this.minActionAreaNode){
            this.minActionAreaNode = new Element("div", {"styles": this.css.minActionAreaNode }).inject(this.node);
            //this.minContent = new Element("div", {"styles": this.css.minContentNode}).inject(this.node);

            this.loadMinActions();

            this.node.inject(this.container);

            //if (this.options.readonly) this.setReadonly();
            //this.checkActions();

            this.setEvent();
        }else{
            this.minActionAreaNode.show();
            //this.minContent.setStyle("display", "block");
            //this.minContent.empty();
            this.minActionAreaNode.empty();

            this.loadMinActions();

            this.setEvent();
        }
        var hiddenGroup = this.options.toolbarGroupHidden;
        var flag = hiddenGroup.contains("edit") && hiddenGroup.contains("read")  && hiddenGroup.contains("view");

        if( flag )this.minActionAreaNode.setStyle("display","none");

        if( !this.minContent ){

            this.minContent = new Element("div", {"styles":
                layout.mobile ? this.css.minContentNode_mobile : this.css.minContentNode
            }).inject(this.node);
            if( layout.mobile ){
                this.minContent.setStyle("clear","both");
            }
        }else{
            this.minContent.setStyle("display", "block");
            this.minContent.empty();
        }

        var atts = this.attachments;
        this.attachments = [];
        while (atts.length){
            var att = atts.shift();
            this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(att.data, this));
        }
        this.checkActions();
        //this.attachments = atts;
    },
    loadMobile: function(){

    },


    loadMinActions: function(){
        var hiddenGroup = this.options.toolbarGroupHidden;
        if (!hiddenGroup.contains("edit")) {

            this.min_uploadAction = this.createAction(this.minActionAreaNode, "upload", o2.LP.widget.upload, function (e, node) {
                this.uploadAttachment(e, node);
            }.bind(this));

            this.min_deleteAction = this.createAction(this.minActionAreaNode, "delete", o2.LP.widget["delete"], function (e, node) {
                this.deleteAttachment(e, node);
            }.bind(this));

            if( !this.options.isReplaceHidden ){
                this.min_replaceAction = this.createAction(this.minActionAreaNode, "replace", o2.LP.widget.replace, function (e, node) {
                    this.replaceAttachment(e, node);
                }.bind(this));
            }
        }
        if (!hiddenGroup.contains("read")) {
            this.min_downloadAction = this.createAction(this.minActionAreaNode, "download", o2.LP.widget.download, function (e, node) {
                this.downloadAttachment(e, node);
            }.bind(this));
        }

        var hasChangeSize = this.options.isSizeChange && !hiddenGroup.contains("view");

        if(  (!hiddenGroup.contains("edit") || !hiddenGroup.contains("read")) && hasChangeSize ) {
            this.createSeparate(this.minActionAreaNode);
        }

        if (hasChangeSize){
            this.sizeAction = this.createAction(this.minActionAreaNode, "max", o2.LP.widget.min, function () {
                this.changeControllerSize();
            }.bind(this));
        }
    },

    setEvent: function(){
        if (this.contentScrollNode && !this.isContentSetEvent){
            this.contentScrollNode.addEventListener("dragover", function( e ) {
                e.preventDefault();
                e.stopPropagation();
            }, false);
            this.contentScrollNode.addEventListener("drop", function( e ) {
                this.uploadAttachment(e, null, e.dataTransfer.files);
                event.preventDefault();
            }.bind(this), false);
            this.contentScrollNode.addEvents({
                "mousedown": this.unSelectedAttachments.bind(this)
            });
            this.isContentSetEvent = true;
        }
        if (this.minContent && !this.isMinContentSetEvent){
            this.minContent.addEventListener("dragover", function( e ) {
                e.preventDefault();
                e.stopPropagation();
            }, false);
            this.minContent.addEventListener("drop", function (e) {
                this.uploadAttachment(e, null, e.dataTransfer.files);
                event.preventDefault();
            }.bind(this), false);
            this.minContent.addEvents({
                "mousedown": this.unSelectedAttachments.bind(this)
            });
            this.isMinContentSetEvent = true;
        }
    },
    resetToolbarGroupHidden : function( hiddenGroup ){
        this.options.toolbarGroupHidden = hiddenGroup;
        if( this.options.size == "max" ){
            this.reloadTopNode();
        }else{
            this.loadMin();
        }
    },
    resetToolbarAvailableListStyle : function( availableListStyle ){
        this.options.availableListStyles = availableListStyle;
        if( this.options.size == "max" ){
            this.reloadTopNode();
        }else{
            this.loadMin();
        }
    },
    createContentNode: function(){
        this.contentScrollNode = new Element("div.contentScrollNode", {"styles": this.css.contentScrollNode}).inject(this.node);
        this.content = new Element("div.content", {"styles": this.css.contentNode}).inject(this.contentScrollNode);

        var scrollFlag = this.contentScrollNode.getStyle("overflow-y");
        if (scrollFlag!=="auto" && scrollFlag!=="scroll"){
            o2.require("o2.widget.ScrollBar", function(){
                new o2.widget.ScrollBar(this.contentScrollNode, {
                    "style":"attachment", "where": "before", "distance": 30, "friction": 4,	"axis": {"x": false, "y": true}
                });
            }.bind(this));
        }
    },
    createBottomNode: function(){
        this.bottomNode = new Element("div", {"styles": this.css.bottomNode}).inject(this.node);
    },
    createResizeNode: function(){
        this.resizeNode = new Element("div", {"styles": this.css.resizeNode}).inject(this.bottomNode);
        this.resizeDrag = new Drag(this.resizeNode, {
            "snap": "2",
            "onStart": function(el, e){
                el.store("startY", e.event.y);
                el.store("nodeHeight", this.node.getSize().y);

                var minHeight = this.node.getStyle("min-height");
                el.store("nodeMinHeight", minHeight ? minHeight.toFloat() : "");

                var contentScrollNodeMinHeight = this.contentScrollNode.getStyle("min-height");
                el.store("contentScrollNodeMinHeight", contentScrollNodeMinHeight ? contentScrollNodeMinHeight.toFloat() : "");

                if (!this.nodeHeight){
                    this.nodeHeight = minHeight.toFloat();
                }
            }.bind(this),
            "onDrag": function(el, e){
                var y = el.retrieve("startY");
                var nodeHeight = el.retrieve("nodeHeight");
                var nodeMinHeight = el.retrieve("nodeMinHeight");
                var contentScrollNodeMinHeight = el.retrieve("contentScrollNodeMinHeight");

                var setY = (e.event.y-y)+nodeHeight;

                if( nodeMinHeight && setY < nodeMinHeight && e.event.y<y)return;

                if (setY<this.nodeHeight) setY = this.nodeHeight;

                var setContentY = setY-81;

                if( contentScrollNodeMinHeight && setContentY < contentScrollNodeMinHeight && e.event.y<y )return;

                this.node.setStyle("height", ""+setY+"px");
                this.contentScrollNode.setStyle("height", ""+setContentY+"px");
            }.bind(this)
        });
    },

    createTopNode: function(){
        if (this.options.title){
            if (!this.titleNode) this.titleNode = new Element("div", {"styles": this.css.titleNode, "text": this.options.title}).inject(this.node);
        }

        if( !this.topNode ){
            this.topNode = new Element("div", {"styles": this.css.topNode}).inject(this.node);
        }else{
            this.topNode.empty();
            this.editActionBoxNode = null;
            this.editActionsGroupNode=null;
            // this.topNode.setStyle("display","");
            this.topNode.show();

            if( this.isHiddenTop ){
                if( this.oldContentScrollNodeHeight && this.contentScrollNode ){
                    this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight);
                    this.oldContentScrollNodeHeight = null;
                }
                this.isHiddenTop = false;
            }
        }
        var hiddenGroup = this.options.toolbarGroupHidden;
        if( hiddenGroup.contains("edit") && hiddenGroup.contains("read") && hiddenGroup.contains("list") && hiddenGroup.contains("view")){
            if(this.contentScrollNode){
                this.oldContentScrollNodeHeight = this.contentScrollNode.getStyle("min-height");
                this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height"));
                this.topNode.setStyle("display","none");
            }
            this.isHiddenTop = true;
            return;
        }
        if( !hiddenGroup.contains("edit") )this.createEditGroupActions();
        if( !hiddenGroup.contains("read") )this.createReadGroupActions();
        if( !hiddenGroup.contains("list") )this.createListGroupActions();
        if( !hiddenGroup.contains("view") )this.createViewGroupActions();

        if( layout.mobile ){
            this.checkActionsZoom();
        }

        //this.topNode = new Element("div", {"styles": this.css.topNode}).inject(this.node);
        //this.createEditGroupActions();
        //this.createReadGroupActions();
        //this.createListGroupActions();
        //this.createViewGroupActions();

        //this.createConfigGroupActions();
    },
    checkActionsZoom: function(){
        var width = 0;
        this.topNode.getChildren().each(function( node ){
            if(node.offsetParent)width = width + node.getSize().x + this.getOffsetX(node)
        }.bind(this));
        var topSize = this.topNode.getSize();
        if( (topSize.x - 5) < width ){
            var zoom = this.getDecimals((topSize.x - 5) / width);
            this.topNode.setStyle( "zoom",  zoom*100+"%" );
        }
    },
    getDecimals: function(v){ //截取两位小数
        var decimals = 4;

        var p = Math.pow(10,decimals);
        var f_x = Math.round(v*p)/p;
        var str = f_x.toString();

        if (decimals>0){
            var pos_decimal = str.indexOf('.');
            if (pos_decimal < 0){
                pos_decimal = str.length;
                str += '.';
            }
            var decimalStr = (str).substr(pos_decimal+1, (str).length);
            while (decimalStr.length < decimals){
                str += '0';
                decimalStr += 0;
            }
        }
        return str;
    },
    getOffsetX : function(node){
        return (node.getStyle("margin-left").toInt() || 0 ) +
            (node.getStyle("margin-right").toInt() || 0 ) +
            (node.getStyle("padding-left").toInt() || 0 ) +
            (node.getStyle("padding-right").toInt() || 0 )+
            (node.getStyle("border-left-width").toInt() || 0 ) +
            (node.getStyle("border-right-width").toInt() || 0 );
    },
    reloadTopNode : function(){
        this.createTopNode();
    },
    createEditGroupActions: function(){
        if(!this.editActionBoxNode)this.editActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        if(!this.editActionsGroupNode)this.editActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.editActionBoxNode);
        this.uploadAction = this.createAction(this.editActionsGroupNode, "upload", o2.LP.widget.upload, function(e, node){
            this.uploadAttachment(e, node);
        }.bind(this));

        this.deleteAction = this.createAction(this.editActionsGroupNode, "delete", o2.LP.widget["delete"], function(e, node){
            this.deleteAttachment(e, node);
        }.bind(this));

        if( !this.options.isReplaceHidden ){
            this.replaceAction = this.createAction(this.editActionsGroupNode, "replace", o2.LP.widget.replace, function(e, node){
                this.replaceAttachment(e, node);
            }.bind(this));
        }

        // this.officeAction = this.createAction(this.editActionsGroupNode, "office", o2.LP.widget.office, function(e, node){
        //     this.openInOfficeControl(e, node);
        // }.bind(this));

        if( !this.options.toolbarGroupHidden.contains("read") )this.editActionSeparateNode = this.createSeparate(this.editActionsGroupNode);
    },

    createReadGroupActions: function(){
        //this.readActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        //this.readActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.readActionBoxNode);
        if(!this.editActionBoxNode)this.editActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        if(!this.editActionsGroupNode)this.editActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.editActionBoxNode);
        this.downloadAction = this.createAction(this.editActionsGroupNode, "download", o2.LP.widget.download, function(){
            this.downloadAttachment();
        }.bind(this));

        //this.createAction(this.readActionsGroupNode, "share", o2.LP.widget.share, function(){
        //    this.transAttachment();
        //}.bind(this));

        //this.downloadAllAction = this.createAction(this.editActionsGroupNode, "downloadAll", o2.LP.widget.downloadAll, function(){
        //    this.downloadAllAttachment();
        //}.bind(this));

    },
    createListGroupActions: function(){
        var availableListStyles = this.options.availableListStyles;
        if( availableListStyles && availableListStyles.length > 0 ){
            this.listActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
            this.listActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.listActionBoxNode);

            if( availableListStyles.contains("list") ){
                this.listAction = this.createAction(this.listActionsGroupNode, "list", o2.LP.widget.list, function(){
                    this.changeListStyle("list");
                }.bind(this));
            }

            if( availableListStyles.contains("seq") ) {
                this.sequenceAction = this.createAction(this.listActionsGroupNode, "seq", o2.LP.widget.sequence, function () {
                    this.changeListStyle("sequence");
                }.bind(this));
            }

            if( availableListStyles.contains("icon") ) {
                this.iconAction = this.createAction(this.listActionsGroupNode, "icon", o2.LP.widget.icon, function () {
                    this.changeListStyle("icon");
                }.bind(this));
            }

            if( availableListStyles.contains("preview") ) {
                this.previewAction = this.createAction(this.listActionsGroupNode, "preview", o2.LP.widget.preview, function () {
                    this.changeListStyle("preview");
                }.bind(this));
            }
        }

    },

    createViewGroupActions: function(){
        if (this.options.isSizeChange){
            this.viewActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
            this.viewActionBoxNode.setStyles({"float": "right", "margin-right": "7px"});
            this.viewActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.viewActionBoxNode);
            this.sizeAction = this.createAction(this.viewActionsGroupNode, "min", o2.LP.widget.min, function(){
                this.changeControllerSize();
            }.bind(this));
        }
    },



    createSeparate: function(groupNode){
        var separateNode = new Element("div.separateNode", {"styles": this.css.separateNode}).inject(groupNode);
        return separateNode;
    },
    createAction: function(groupNode, img, title, click){
        var actionNode = new Element("div", {"styles": this.css.actionNode, "title": title}).inject(groupNode);
        var actionIconNode = new Element("div", {"styles": this.css.actionIconNode}).inject(actionNode);
        actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/icon/"+img+".png)");

        var _self = this;
        actionNode.addEvents({
            "mouseover": function(){
                if (!this.retrieve("disabled")) if (!this.retrieve("selected")) this.setStyle("background", "url("+o2.session.path+"/widget/$AttachmentController/"+_self.options.style+"/overbg.png)");
            },
            "mouseout": function(){
                if (!this.retrieve("disabled")) if (!this.retrieve("selected")) this.setStyle("background", "transparent");
            },
            "click": function(e){
                if (!this.retrieve("disabled")) _self.doAction(e, this, click);
                e.stopPropagation();
            }
        });
        this.actions.push(actionNode);
        return actionNode;
    },
    checkActions: function(){
    //    if (this.options.readonly){
    //        this.setReadonly();
    //    }else{
            this.checkUploadAction();
            this.checkDeleteAction();

            this.checkReplaceAction();

            //this.checkOfficeAction();
            this.checkDownloadAction();

            this.checkSizeAction();

            this.checkListStyleAction();

        if( this.options.size === "max" ){
            this.checkEditActionBox();
        }
    },
    checkEditActionBox: function(){
        var isShowEdit = false;
        ["isUpload", "isDelete", "isReplace"].each(function( key ){
            if( key === "isReplace" && this.options.isReplaceHidden )return;
            if( this.options[key] !== "hidden" )isShowEdit = true;
        }.bind(this));

        var isShowRead = false;
        ["isDownload"].each(function( key ){
            if( this.options[key] !== "hidden" )isShowRead = true;
        }.bind(this));

        if(this.editActionSeparateNode)this.editActionSeparateNode.setStyle( "display", isShowEdit && isShowRead ? "" : "none" );
        if(this.editActionBoxNode )this.editActionBoxNode.setStyle( "display", isShowEdit || isShowRead ? "" : "none" );
    },
    checkUploadAction: function(){
        if (this.options.readonly) {
            if (this.options.isUpload === "hidden") {
                this.setActionHidden(this.uploadAction);
                this.setActionHidden(this.min_uploadAction);
            } else {
                this.setActionDisabled(this.uploadAction);
                this.setActionDisabled(this.min_uploadAction);
            }
            return false;
        }
        if (this.options.isUpload === "hidden" ){
            this.setActionHidden(this.uploadAction);
            this.setActionHidden(this.min_uploadAction);
        }else if (!this.options.isUpload){
            this.setActionDisabled(this.uploadAction);
            this.setActionDisabled(this.min_uploadAction);
        }else{
            if (this.options.attachmentCount.toInt() > 0){
                if (this.attachments.length>=this.options.attachmentCount.toInt()){
                    this.setActionDisabled(this.uploadAction);
                    this.setActionDisabled(this.min_uploadAction);
                }else{
                    this.setActionEnabled(this.uploadAction);
                    this.setActionEnabled(this.min_uploadAction);
                }
            }else{
                this.setActionEnabled(this.uploadAction);
                this.setActionEnabled(this.min_uploadAction);
            }
        }
    },
    checkDeleteAction: function(){
        if (this.options.readonly){
            if (this.options.isDelete === "hidden") {
                this.setActionHidden(this.deleteAction);
                this.setActionHidden(this.min_deleteAction);
            } else {
                this.setActionDisabled(this.deleteAction);
                this.setActionDisabled(this.min_deleteAction);
            }
            this.setAttachmentsAction("delete", false );
            return false;
        }
        if (this.options.isDelete === "hidden") {
            this.setActionHidden(this.deleteAction);
            this.setActionHidden(this.min_deleteAction);
            this.setAttachmentsAction("delete", false );
        } else if (!this.options.isDelete){
            this.setActionDisabled(this.deleteAction);
            this.setActionDisabled(this.min_deleteAction);
            this.setAttachmentsAction("delete", false );
        }else{
            if (this.selectedAttachments.length){
                this.setActionEnabled(this.deleteAction);
                this.setActionEnabled(this.min_deleteAction);
            }else{
                this.setActionDisabled(this.deleteAction);
                this.setActionDisabled(this.min_deleteAction);
            }
            this.setAttachmentsAction("delete", true );
        }
    },
    isAttDeleteAvailable : function( att ){
        if (this.options.readonly)return false;
        if( this.options.toolbarGroupHidden.contains("edit") )return false;
        return this.options.isDelete && this.options.isDelete !== "hidden";
    },
    isAttEditAvailable : function( att ){
        if (this.options.readonly)return false;
        if( this.options.toolbarGroupHidden.contains("edit") )return false;
        return this.options.isEditAtt && this.options.isEditAtt !== "hidden";
    },
    // checkOfficeAction: function(){
    //     if (this.officeAction) this.officeAction.setStyle("display", "none");
    //     if (this.min_officeAction) this.min_officeAction.setStyle("display", "none");
    // },
    checkReplaceAction: function(){
        if( this.options.isReplaceHidden )return;
        if (this.options.readonly){
            if( this.options.isReplace === "hidden" ){
                this.setActionHidden(this.replaceAction);
                this.setActionHidden(this.min_replaceAction);
            }else{
                this.setActionDisabled(this.replaceAction);
                this.setActionDisabled(this.min_replaceAction);
            }
            this.setAttachmentsAction("replace", false );
            return false;
        }

        if( this.options.isReplace === "hidden" ){
            this.setActionHidden(this.replaceAction);
            this.setActionHidden(this.min_replaceAction);
            this.setAttachmentsAction("replace", false );
        }else if (!this.options.isReplace){
            this.setActionDisabled(this.replaceAction);
            this.setActionDisabled(this.min_replaceAction);
            this.setAttachmentsAction("replace", false );
        }else{
            if (this.selectedAttachments.length && this.selectedAttachments.length==1){
                this.setActionEnabled(this.replaceAction);
                this.setActionEnabled(this.min_replaceAction);
            }else{
                this.setActionDisabled(this.replaceAction);
                this.setActionDisabled(this.min_replaceAction);
            }
            this.setAttachmentsAction("replace", true );
        }
    },
    isAttReplaceAvailable : function( att ){
        if (this.options.readonly)return false;
        if( this.options.toolbarGroupHidden.contains("edit") )return false;
        return this.options.isReplace && this.options.isReplace !== "hidden";
    },
    checkDownloadAction: function(){
        if( this.options.isDownload === "hidden" ){
            this.setActionHidden(this.downloadAction);
            this.setActionHidden(this.min_downloadAction);
            this.setActionHidden(this.downloadAllAction);
            this.setAttachmentsAction("download", false );
        }else if (!this.options.isDownload){
            this.setActionDisabled(this.downloadAction);
            this.setActionDisabled(this.min_downloadAction);
            this.setActionDisabled(this.downloadAllAction);
            this.setAttachmentsAction("download", false );
        }else{
            if (this.selectedAttachments.length){
                this.setActionEnabled(this.downloadAction);
                this.setActionEnabled(this.min_downloadAction);
            }else{
                this.setActionDisabled(this.downloadAction);
                this.setActionDisabled(this.min_downloadAction);
            }
            this.setActionEnabled(this.downloadAllAction);
            this.setAttachmentsAction("download", true );
        }
    },
    isAttDblclickAvailable : function( att ){
        return this.options.dblclick && this.options.dblclick !== "hidden";
    },
    isAttDownloadAvailable : function( att ){
        if( this.options.toolbarGroupHidden.contains("read") )return false;
        return this.options.isDownload && this.options.isDownload !== "hidden";
    },
    checkSizeAction: function(){
        if( this.sizeAction ){
            if (this.options.isSizeChange){
                this.setActionEnabled(this.sizeAction);
            }else{
                this.setActionDisabled(this.sizeAction);
            }
        }
    },
    checkListStyleAction: function(){
        switch (this.options.listStyle){
            case "list":
                this.setActionSelcted(this.listAction);
                this.setActionUnSelcted(this.iconAction);
                this.setActionUnSelcted(this.previewAction);
                this.setActionUnSelcted(this.sequenceAction);
                break;
            case "icon":
                this.setActionUnSelcted(this.listAction);
                this.setActionSelcted(this.iconAction);
                this.setActionUnSelcted(this.previewAction);
                this.setActionUnSelcted(this.sequenceAction);
                break;
            case "preview":
                this.setActionUnSelcted(this.listAction);
                this.setActionUnSelcted(this.iconAction);
                this.setActionSelcted(this.previewAction);
                this.setActionUnSelcted(this.sequenceAction);
                break;
            case "sequence":
                this.setActionUnSelcted(this.listAction);
                this.setActionUnSelcted(this.iconAction);
                this.setActionUnSelcted(this.previewAction);
                this.setActionSelcted(this.sequenceAction);
                break;
        }
    },
    setActionSelcted: function(action){
        if (action){
            if (!action.retrieve("selected")){
                action.setStyle("background", "url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/selectedbg.png)");
                action.store("selected", true);
            }
        }

    },
    setActionUnSelcted: function(action){
        if (action){
            if (action.retrieve("selected")){
                action.setStyle("background", "");
                action.store("selected", false);
            }
        }
    },

    setActionEnabled: function(action){
        if (action){
            action.show();
            if (action.retrieve("disabled")){
                var iconNode = action.getFirst();
                var icon = iconNode.getStyle("background-image");
                var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
                icon = icon.substr(0, icon.lastIndexOf("_gray"))+"."+ext;
                iconNode.setStyle("background-image", icon);
                action.store("disabled", false);
            }
        }
    },
    setActionDisabled: function(action){
        if (action){
            if (!action.retrieve("disabled")){
                var iconNode = action.getFirst();
                var icon = iconNode.getStyle("background-image");
                var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
                icon = icon.substr(0, icon.lastIndexOf("."))+"_gray."+ext;
                iconNode.setStyle("background-image", icon);
                action.store("disabled", true);
            }
        }
    },
    setActionHidden: function(action){
        if (action)action.hide();
    },
    setReadonly: function() {
        this.actions.each(function(action){
            this.setActionDisabled(action);
            this.setAttachmentsAction("all", false );
        }.bind(this));
    },
    setAttachmentsAction : function(type, enable){
        this.attachments.each( function( att ){
            this.setAttachmentAction( att, type, enable )
        }.bind(this))
    },
    setAttachmentAction : function(att, type, enable){
        var action;
        if( type === "all" ){
            ( att.actions || [] ).each( function(action){
                att[ enable ? "setActionEnabled" : "setActionDisabled" ](action);
            })
        }else{
            switch( type ){
                case "download" :
                    action = att.downloadAction;
                    break;
                case "config" :
                    action = att.configAction;
                    break;
                case "delete" :
                    action = att.deleteAction;
                    break;
                case "replace" :
                    action = att.replaceAction;
                    break;
            }
            if( !action )return;
            if( type === "config" ){
                var flag = enable;
                if( flag ){
                    var user = layout.session.user.distinguishedName;

                    if( !att.data.person && att.data.creatorUid )att.data.person = att.data.creatorUid;

                    if ((!att.data.control.allowControl ) && att.data.person!==user){ //|| !att.data.control.allowEdit
                        flag = false;
                    }
                }
                att[ flag ? "setActionEnabled" : "setActionDisabled" ](action);
            }else{
                att[ enable ? "setActionEnabled" : "setActionDisabled" ](action);
            }
        }
    },

    doAction: function(e, node, action){
        if (action){
            action.apply(this, [e, node]);
        }
    },

    uploadAttachment: function(e, node, files){
        if (this.module) this.module.uploadAttachment(e, node, files);
    },
    doUploadAttachment: function(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery, files){
        if ( !this.options.readonly && ( this.options.isUpload && this.options.isUpload !== "hidden") ){
            if (FormData.expiredIE){
                this.doInputUploadAttachment(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery);
            }else{
                this.doFormDataUploadAttachment(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery, files);
            }
        }else{
            var text = o2.LP.widget.notUploadNotice;
            if (o2 && o2.xDesktop && o2.xDesktop.notice) o2.xDesktop.notice("info", {"x": "right", "y": "top"}, text, this.node);
        }
    },
    orderAttachments: function (attDataList){
        var preNode;
        var attachments = [];
        var index = 0;
        attDataList.each( function( att ){
            var matchAttachments = this.attachments.filter( function( attachment ){
                return attachment.data.id === att.id || (attachment.data.businessId && attachment.data.businessId === att.businessId);
            });
            if( matchAttachments.length ){
                index++;
                attachments.push(matchAttachments[0]);
                var content = this.options.size === 'min' ? this.minContent : this.content;
                var node = matchAttachments[0].node;
                preNode ? node.inject( preNode, "after" ) : node.inject( content, "top" );
                preNode = node;
                matchAttachments[0].setSequence(index);
            }
        }.bind(this));
        this.attachments = attachments;
    },
    addUploadMessage: function(fileName){
        var contentHTML = "";
        contentHTML = "<div style=\"overflow: hidden\"><div style=\"height: 2px; border:0px solid #999; margin: 3px 0px\">" +
            "<div style=\"height: 2px; background-color: #acdab9; width: 0px;\"></div></div>" +
            "<div style=\"height: 20px; line-height: 20px\">"+o2.LP.desktop.action.uploadTitle+"</div></div>" +
            "<iframe name='o2_upload_iframe' style='display:none'></iframe>" ;
        var msg = {
            "subject": o2.LP.desktop.action.uploadTitle,
            "content": fileName+"<br/>"+contentHTML
        };
        if (layout.desktop.message){
            var messageItem = layout.desktop.message.addMessage(msg);
            messageItem.close = function(callback, e){
                if (!messageItem.completed){

                }else{
                    messageItem.closeItem(callback, e);
                }
            };
        }
        window.setTimeout(function(){
            if (layout.desktop.message) if (!layout.desktop.message.isShow) layout.desktop.message.show();
        }.bind(this), 300);

        return messageItem;
    },
    setMessageTitle: function(messageItem, text){
        if (messageItem) messageItem.subjectNode.set("text", text);
    },
    setMessageText: function(messageItem, text){
        if (messageItem){
            var progressNode = messageItem.contentNode.getFirst("div").getFirst("div");
            var progressPercentNode = progressNode.getFirst("div");
            var progressInforNode = messageItem.contentNode.getFirst("div").getLast("div");
            progressInforNode.set("text", text);
            messageItem.dateNode.set("text", (new Date()).format("db"));
        }

    },
    doInputUploadAttachment: function(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, failureEvery){
        var restActions = action;
        if (typeOf(action)=="string"){
            restActions = o2.Actions.get(action).action;
        }
        restActions.getActions(function(){
            var url = restActions.actions[invokeUrl];
            url = restActions.address+url.uri;

            Object.each(parameter, function(v, k){
                url = url.replace("{"+k+"}", v);
            });

            var maskNode = this.module.content;
            if (!maskNode){
                if (this.module.form){
                    maskNode = this.module.form.app.content;
                }
            }
            if (!maskNode) maskNode = this.node;
            //var maskNode = this.module.content || this.module.node;
            if (maskNode){
                maskNode.mask({
                    "style": {
                        "opacity": 0.7,
                        "background-color": "#999"
                    }
                });
            }

            this.inputUploadAreaNode = new Element("div", {"styles": this.css.inputUploadAreaNode}).inject(this.container);
            this.inputUploadAreaNode.position({
                relativeTo: this.module.content,
                position: "center"
            });

            var messageItem = null;
            document.O2UploadCallbackFun = function(str){
                var json = JSON.decode(str);
                messageItem.completed = true;
                if (json.type==="success"){
                    if (every) every(json.data);
                    this.setMessageTitle(messageItem, o2.LP.desktop.action.uploadComplete);
                    this.setMessageText(messageItem, o2.LP.desktop.action.uploadComplete);
                    if(finish) finish();
                }else{
                    //formNode.unmask();
                    // if(failureEvery)failureEvery(json);
                    this.setMessageTitle(messageItem, o2.LP.desktop.action.sendError);
                    this.setMessageText(messageItem, o2.LP.desktop.action.sendError+": "+json.message);
                    o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                }
            }.bind(this);

            var formNode = new Element("form", {
                "method": "POST",
                "action": url+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",
                //"action": url,
                "enctype": "multipart/form-data",
                "target": "o2_upload_iframe"
            }).inject(this.inputUploadAreaNode);

            var titleNode = new Element("div", {"styles": this.css.inputUploadAreaTitleNode, "text": o2.LP.widget.uploadTitle}).inject(formNode);
            var inforNode = new Element("div", {"styles": this.css.inputUploadAreaInforNode, "text": o2.LP.widget.uploadInfor}).inject(formNode);
            var inputAreaNode = new Element("div", {"styles": this.css.inputUploadAreaInputAreaNode}).inject(formNode);
            var inputNode = new Element("input", {"name":"file", "type": "file", "styles": this.css.inputUploadAreaInputNode}).inject(inputAreaNode);
            var inputNameNode = new Element("input", {"type": "hidden", "name": "fileName"}).inject(inputAreaNode);

            Object.each(obj, function(v, k){
                new Element("input", {"type": "hidden", "name": k, "value": v}).inject(inputAreaNode);
            });

            var actionNode = new Element("div", {"styles": this.css.inputUploadActionNode}).inject(formNode);
            var cancelButton = new Element("button", {"styles": this.css.inputUploadCancelButton, "text": o2.LP.widget.cancel}).inject(actionNode);
            var okButton = new Element("input", {"type": "button", "styles": this.css.inputUploadOkButton, "value": o2.LP.widget.ok}).inject(actionNode);

            inputNode.addEvent("change", function(){
                var fileName = inputNode.get("value");
                if (fileName){
                    var tmpv = fileName.replace(/\\/g, "/");
                    var i = tmpv.lastIndexOf("/");
                    var fname = (i===-1) ? tmpv : tmpv.substr(i+1, tmpv.length-i);
                    inputNameNode.set("value", fname);
                }
            }.bind(this));

            cancelButton.addEvent("click", function(){
                if (maskNode) maskNode.unmask();
                this.inputUploadAreaNode.destroy();
            }.bind(this));

            okButton.addEvent("click", function(){
                formNode.mask({
                    "style": {
                        "opacity": 0.7,
                        "background-color": "#999"
                    }
                });

                var isContinue = true;
                if (beforeUpload) isContinue = beforeUpload([inputNameNode.get("value")]);
                if (isContinue){
                    messageItem = this.addUploadMessage(inputNameNode.get("value"));
                    formNode.submit();
                    if (maskNode) maskNode.unmask();
                    if (this.inputUploadAreaNode) this.inputUploadAreaNode.destroy();
                }
            }.bind(this));
        }.bind(this));
    },
    doFormDataUploadAttachment: function(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery, files){
        var uploadChange = function(uploadfiles){
            var files = uploadfiles || this.fileUploadNode.files;
            if (files.length){
                var count = files.length;
                var current = 0;
                var hasFailUpload = false;

                var restActions = action;
                if (typeOf(action)=="string"){
                    restActions = o2.Actions.get(action).action;
                }
                //var url = restActions.action.actions[invokeUri];

                var callback = function(){
                    if (current == count){
                        if(finish) finish( hasFailUpload );
                    }
                };

                var isContinue = true;
                if (beforeUpload) isContinue = beforeUpload(files);
                if (isContinue){
                    var accepts = (accept) ? accept.split(o2.splitStr) : null;

                    for (var i = 0; i < files.length; i++) {
                        var file = files.item(i);
                        var ext = file.name.substr(file.name.lastIndexOf("."), file.name.length);
                        ext = ext.toLowerCase();
                        if (accepts && (accepts.indexOf(ext)===-1 && accepts.indexOf("*")===-1 && accepts.indexOf("*/*")===-1)){
                            var msg = {
                                "subject": o2.LP.widget.refuseUpload,
                                "content": o2.LP.widget.refuseUploadHTML.replace("{filename}", file.name)
                            };
                            if (layout.desktop.message) layout.desktop.message.addTooltip(msg);
                            if (layout.desktop.message) layout.desktop.message.addMessage(msg);
                            var text = o2.LP.widget.refuseUploadNotice.replace("{filename}", file.name);
                            if (o2 && o2.xDesktop && o2.xDesktop.notice) o2.xDesktop.notice("info", {"x": "right", "y": "top"}, text, this.node);
                        }else if (size && file.size> size*1024*1024){
                            var msg = {
                                "subject": o2.LP.widget.refuseUpload,
                                "content": o2.LP.widget.refuseUploadHTML_size.replace("{filename}", file.name).replace("{size}", size)
                            };
                            if (layout.desktop.message) layout.desktop.message.addTooltip(msg);
                            if (layout.desktop.message) layout.desktop.message.addMessage(msg);
                            var text = o2.LP.widget.refuseUploadNotice_size.replace("{filename}", file.name).replace("{size}", size);
                            if (o2 && o2.xDesktop && o2.xDesktop.notice) o2.xDesktop.notice("info", {"x": "right", "y": "top"}, text, this.node);
                        }else{
                            var formData = new FormData();
                            Object.each(obj, function(v, k){
                                formData.append(k, v)
                            });
                            formData.append('file', file);
                            if(parameter.fileMd5){
                                o2.load("../o2_lib/CryptoJS/components/spark-md5-min.js", function(){

                                    var fileReader = new FileReader(), box = document.getElementById('box');
                                    var blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice;
                                    var chunkSize = 20971520;
                                    // read in chunks of 20MB
                                    var chunks = Math.ceil(file.size / chunkSize), currentChunk = 0, spark = new SparkMD5();

                                    fileReader.onload = function(e) {
                                        console.log("read chunk nr", currentChunk + 1, "of", chunks);
                                        spark.appendBinary(e.target.result);
                                        currentChunk++;

                                        if (currentChunk < chunks) {
                                            loadNext();
                                        } else {
                                            console.log("finished loading");
                                            var fileMd5 = spark.end();

                                            restActions.invoke({
                                                "name": "checkFileExist",
                                                "async": true,
                                                "parameter": {"fileMd5":fileMd5},
                                                "success": function(json){
                                                    if(json.data.value){
                                                        var formData2 = new FormData();
                                                        formData2.append("fileMd5",fileMd5);
                                                        formData2.append("fileName",file.name);
                                                        restActions.invoke({
                                                            "name": "addAttachmentMd5",
                                                            "async": true,
                                                            "data": formData2,
                                                            "parameter": parameter,
                                                            "success": function(json){
                                                                current++;
                                                                if (every) every(json, current, count);
                                                                callback();
                                                            },
                                                            "failure": function (xhr) {
                                                                var json = JSON.decode(xhr.responseText);
                                                                if( json && json.message )o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                                                                current++;
                                                                hasFailUpload = true;
                                                                if (failureEvery) failureEvery(xhr, current, count);
                                                                callback();
                                                            }
                                                        });
                                                    }else{
                                                        restActions.invoke({
                                                            "name": invokeUrl,
                                                            "async": true,
                                                            "data": formData,
                                                            "file": file,
                                                            "parameter": parameter,
                                                            "success": function(json){
                                                                current++;
                                                                if (every) every(json, current, count);
                                                                callback();
                                                            },
                                                            "failure": function (xhr) {
                                                                var json = JSON.decode(xhr.responseText);
                                                                if( json && json.message )o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                                                                current++;
                                                                hasFailUpload = true;
                                                                if (failureEvery) failureEvery(xhr, current, count);
                                                                callback();
                                                            }
                                                        });
                                                    }

                                                }
                                            });
                                            // compute hash
                                        }
                                    };

                                    function loadNext() {
                                        var start = currentChunk * chunkSize, end = start + chunkSize >= file.size ? file.size : start + chunkSize;

                                        fileReader.readAsBinaryString(blobSlice.call(file, start, end));
                                    }

                                    loadNext();
                                }.bind(this),null,false);

                            }else{
                                restActions.targetModule = {"module": this, "file": file};
                                restActions.invoke({
                                    "name": invokeUrl,
                                    "async": true,
                                    "data": formData,
                                    "file": file,
                                    "parameter": parameter,
                                    "success": function(json){
                                        current++;
                                        if (every) every(json, current, count);
                                        callback();
                                    },
                                    "failure": function (xhr) {
                                        var json = JSON.decode(xhr.responseText);
                                        if( json && json.message )o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                                        current++;
                                        hasFailUpload = true;
                                        if (failureEvery) failureEvery(xhr, current, count);
                                        callback();
                                    }
                                });
                            }

                        }
                    }
                }
                this.uploadFileAreaNode.destroy();
                this.uploadFileAreaNode = null;
            }
        }.bind(this);
        if (!this.uploadFileAreaNode){
            this.uploadFileAreaNode = new Element("div");
            var html = "<input name=\"file\" multiple type=\"file\" accept=\"*/*\"/>";
            this.uploadFileAreaNode.set("html", html);

            this.fileUploadNode = this.uploadFileAreaNode.getFirst();
            this.fileUploadNode.addEvent("change", function(){
                uploadChange();
            });
        }
        this.fileUploadNode.set("accept", accept || "*/*");
        this.fileUploadNode.set("multiple", (multiple!==false));
        if (!files || !files.length){
            this.fileUploadNode.click();
        }else{
            uploadChange(files)
        }

    },

    addFormDataMessage: function(file){
        return this.addAttachmentMessage(file);
    },

    addAttachmentMessage: function(file){
        var messageItem;
        if (this.options.size=="min"){
            messageItem = new o2.widget.AttachmentController.AttachmentMessageMin(file, this);
        }else{
            messageItem = new o2.widget.AttachmentController.AttachmentMessage(file, this);
        }
        if (!this.messageItemList) this.messageItemList = {};
        this.messageItemList[messageItem.data.id] = messageItem;
        return messageItem;
    },

    openInOfficeControl: function(e, node){},
    deleteAttachment: function(e, node){
        if (this.selectedAttachments.length){
            if (this.module) this.module.deleteAttachments(e, node, this.selectedAttachments);
        }
    },
    replaceAttachment: function(e, node){
        if (this.selectedAttachments.length && this.selectedAttachments.length==1){
            if (this.module) this.module.replaceAttachment(e, node, this.selectedAttachments[0]);
        }
    },
    doReplaceAttachment: function(obj, action, invokeUrl, parameter, callback, multiple, accept, accept, size){
        if (FormData.expiredIE){
            this.doInputUploadAttachment(obj, action, invokeUrl, parameter, callback, multiple, accept, accept, size);
        }else{
            this.doFormDataUploadAttachment(obj, action, invokeUrl, parameter, callback, multiple, accept, accept, size);
        }
    },
    previewAttachment: function(e, node){
        if (this.selectedAttachments.length){
            if (this.module) this.module.previewAttachment(this.selectedAttachments);
        }
    },
    editAttachment: function(e, node){
        if (this.selectedAttachments.length){
            if (this.module) this.module.editAttachment(this.selectedAttachments);
        }
    },
    downloadAttachment: function(e, node){
        if (this.selectedAttachments.length){
            if (this.module) this.module.downloadAttachment(e, node, this.selectedAttachments);
        }
    },

    openAttachment: function(e, node, attachment){
        if( !this.options.dblclick ){
            if( !this.options.isDownload || this.options.isDownload === "hidden" )return; //兼容以前的配置
        }
        if (attachment){
            if (this.module) this.module.openAttachment(e, node, attachment);
        }
    },
    dblclickAttachment: function(e, node, attachment){
        if( !attachment || !this.module || this.options.dblclick === "disable" ){
            return;
        }else if( this.options.dblclick === "preview" ){
            if( this.checkPreviewAttachment ){
                this.checkPreviewAttachment(e, node, attachment);
            }else{
                this.module.openAttachment(e, node, attachment);
            }
        }else{
            this.module.openAttachment(e, node, attachment);
        }
    },

    downloadAllAttachment: function(e, node){
        if (this.module) this.module.downloadAttachment(e, node, this.attachments);
    },
    changeListStyle: function(style){
        this.options.listStyle = style;
        this.listStyle = style;
        this.attachments.each(function(attachment){
            attachment.changeListStyle(style);
        }.bind(this));
        this.checkListStyleAction();
    },
    changeControllerSize: function(e, node){
        if (this.options.size=="max"){
            this.changeControllerSizeToMin();
        }else{
            this.changeControllerSizeToMax();
        }
    },

    changeControllerSizeToMin: function(){
        if (this.options.size!="min"){
            // if (this.contentScrollNode) this.contentScrollNode.setStyle("display", "none");
            // if (this.bottomNode) this.bottomNode.setStyle("display", "none");
            // if (this.topNode) this.topNode.setStyle("display", "none");
            // if (this.titleNode) this.titleNode.setStyle("display", "none");

            if (this.contentScrollNode) this.contentScrollNode.hide();
            if (this.bottomNode) this.bottomNode.hide();
            if (this.topNode) this.topNode.hide();
            if (this.titleNode) this.titleNode.hide();

            if (!this.nodeMorph) this.nodeMorph = new Fx.Morph(this.node, {"duration": 100});

            this.nodeMorph.start(this.css.container_min).chain(function(){
                this.options.size = "min";
                this.loadMin();
            }.bind(this));
        }
    },
    changeControllerSizeToMax: function(){
        if (this.options.size!="max") {
            // if (this.minActionAreaNode) this.minActionAreaNode.setStyle("display", "none");
            // if (this.minContent) this.minContent.setStyle("display", "none");

            if (this.minActionAreaNode) this.minActionAreaNode.hide();
            if (this.minContent) this.minContent.hide();

            if (!this.nodeMorph) this.nodeMorph = new Fx.Morph(this.node, {"duration": 100});

            this.nodeMorph.start(this.css.container).chain(function () {
                this.options.size = "max";
                this.loadMax();
            }.bind(this));
        }
    },

    getAttachmentNames: function(){
        var names = [];
        this.attachments.each(function(attachment){
            names.push(attachment.data.name);
        });
        return names;
    },

    addAttachment: function(data, messageId, isCheckPosition){
        if (this.options.size=="min"){
            this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(data, this, messageId, isCheckPosition));
        }else{
            this.attachments.push(new o2.widget.AttachmentController.Attachment(data, this, messageId, isCheckPosition));
        }
        this.checkActions();
    },
    removeAttachment: function(attachment){
        this.attachments.erase(attachment);
        this.selectedAttachments.erase(attachment);
        attachment.node.destroy();
        delete attachment;
    },

    unSelectedAttachments: function(){
        while (this.selectedAttachments.length){
            var attachment = this.selectedAttachments.shift();
            attachment.unSelected();
        }
        this.checkActions();
    },
    clear: function(){
        this.selectedAttachments = [];
        this.attachments.each(function(att){
            att.node.destroy();
            o2.release(att);
        });
        this.attachments = [];
        var content = (this.minContent || this.content);
        if (content) content.empty();
    }

});

o2.widget.AttachmentController.Attachment = new Class({
	Implements: [Events],
	initialize: function(data, controller, messageId, isCheckPosition){
		this.data = data;

        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.listStyle = this.controller.options.listStyle;
        this.content = this.controller.content;
        this.isSelected = false;
        this.seq = this.controller.attachments.length+1;
        this.isCheckPosition = isCheckPosition;
        this.actions = [];

        if (messageId && this.controller.messageItemList) {
            this.message = this.controller.messageItemList[messageId];
        }

        this.load();
	},
    setSequence: function (seq){
        this.seq = seq;
        if( this.controller.options.listStyle === 'sequence' && this.sequenceNode ){
            this.sequenceNode.set('text', seq);
        }
    },
    _getLnkPar: function(url){
        return {
            "icon": this.getIcon(),
            "title": this.data.name,
            "par": "@url#"+url
        };
    },
    isNumber : function( d ){
        return parseFloat(d).toString() !== "NaN"
    },
    load: function(){
        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("beforeLoadAttachment", [this]);
        }

	    if (this.message){
            this.node = new Element("div").inject(this.message.node, "after");
            //this.node = new Element("div").inject(this.content);
            this.message.node.destroy();
            delete this.controller.messageItemList[this.message.data.id];
        }else{
            this.node = new Element("div").inject(this.content);
        }
	    if( this.isCheckPosition && this.isNumber(this.data.orderNumber) ){
	        var attList = this.controller.attachments;
            for( var i=0; i<attList.length; i++ ){
                var att = attList[i];
                if( !this.isNumber(att.data.orderNumber) || this.data.orderNumber < att.data.orderNumber ){
                    this.node.inject( att.node, "before" );
                    break;
                }
            }
        }

        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.controller.module.getAttachmentUrl(this, function(url){
            this.node.makeLnk({
                "par": this._getLnkPar(url)
            });
        }.bind(this));

        this.createInforNode(function(){
            if (!Browser.Platform.ios){
                this.tooltip = new mBox.Tooltip({
                    content: this.inforNode,
                    setStyles: {content: {padding: 15, lineHeight: 20}},
                    attach: this.node,
                    transition: 'flyin'
                });
            }
        }.bind(this));

        this.setEvent();

        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("loadAttachment", [this]);
        }
    },
    createInforNode: function(callback){
        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.inforNode = new Element("div", {"styles": this.css.attachmentInforNode});
        var html = "<div style='overflow:hidden; font-weight: bold'>"+this.data.name+"</div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploader+": </div><div style='width:120px; float:left; margin-left:10px'>"+( this.data.person || this.data.creatorUid )+"</div></div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.createTime+"</div></div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.modifyTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.lastUpdateTime+"</div></div>";
        if(this.data.activityName)html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadActivity+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.activityName || o2.LP.widget.unknow)+"</div></div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.size+": </div><div style='width:120px; float:left; margin-left:10px'>"+size+"</div></div>";
        this.inforNode.set("html", html);

        if (callback) callback();
    },
    getIcon: function(){
        if (!this.data.extension) this.data.extension="unkonw";

        var iconName = this.controller.icons[this.data.extension.toLowerCase()] || this.controller.icons.unknow;
        var iconFolderUrl = this.controller.options.iconFolderUrl ? this.controller.options.iconFolderUrl : "../x_component_File/$Main/default/file/";
        return iconFolderUrl+iconName;
    },

    loadList: function(){
        this.node.setStyles(this.css.attachmentNode_list);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_list_selected);

        this.iconNode = new Element("div", {"styles": this.css.attachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.attachmentTextNode_list}).inject(this.node);
        this.textTitleNode = new Element("div", {"styles": this.css.attachmentTextTitleNode_list}).inject(this.textNode);
        // this.textTitleNode.set("text", this.data.name);
        if (this.data.objectSecurityPromise){
            this.data.objectSecurityPromise.then(function(label){
                this.textTitleNode.set("text", "("+label+") " + this.data.name);
            }.bind(this));
        }else{
            this.textTitleNode.set("text", this.data.name);
        }

        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.attachmentTextSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", size);

        this.textUploaderNode = new Element("div", {"styles": this.css.attachmentTextUploaderNode_list}).inject(this.textNode);
        this.textUploaderNode.set("text", o2.name.cn(this.data.person || this.data.creatorUid ));

        this.textTimeNode = new Element("div", {"styles": this.css.attachmentTextTimeNode_list}).inject(this.textNode);
        this.textTimeNode.set("text", this.data.lastUpdateTime);

        if(this.data.activityName){
            this.textActivityNode = new Element("div", {"styles": this.css.attachmentTextActivityNode_list}).inject(this.textNode);
            this.textActivityNode.set("text", this.data.activityName || o2.LP.widget.unknow);
        }

        this.custom_List();
    },
    custom_List: function(){},
    loadSequence: function(){
        this.node.setStyles(this.css.attachmentNode_sequence);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_sequence_selected);

        this.sequenceNode = new Element("div", {"styles": this.css.attachmentSeqNode_sequence, "text": (this.seq || 1)}).inject(this.node);

        this.iconNode = new Element("div", {"styles": this.css.attachmentIconNode_sequence || this.css.attachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.attachmentTextNode_sequence}).inject(this.node);
        this.textTitleNode = new Element("div", {"styles": this.css.attachmentTextTitleNode_list}).inject(this.textNode);
        // this.textTitleNode.set("text", this.data.name);
        if (this.data.objectSecurityPromise){
            this.data.objectSecurityPromise.then(function(label){
                this.textTitleNode.set("text", "("+label+") " + this.data.name);
            }.bind(this));
        }else{
            this.textTitleNode.set("text", this.data.name);
        }

        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.attachmentTextSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", size);

        this.textUploaderNode = new Element("div", {"styles": this.css.attachmentTextUploaderNode_list}).inject(this.textNode);
        this.textUploaderNode.set("text", o2.name.cn(this.data.person || this.data.creatorUid));

        this.textTimeNode = new Element("div", {"styles": this.css.attachmentTextTimeNode_list}).inject(this.textNode);
        this.textTimeNode.set("text", this.data.lastUpdateTime);

        if(this.data.activityName){
            this.textActivityNode = new Element("div", {"styles": this.css.attachmentTextActivityNode_list}).inject(this.textNode);
            this.textActivityNode.set("text", this.data.activityName || o2.LP.widget.unknow);
        }

        this.custom_Sequence();
    },
    custom_Sequence: function(){},

    loadIcon: function(){
        this.node.setStyles(this.css.attachmentNode_icon);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_icon_selected);

        this.iconNode = new Element("div", {"styles": this.css.attachmentIconNode}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentIconImgAreaNode}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentIconImgNode}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.attachmentTextNode}).inject(this.node);
        if (this.data.objectSecurityPromise){
            this.data.objectSecurityPromise.then(function(label){
                this.textNode.set("text", "("+label+") " + this.data.name);
            }.bind(this));
        }else{
            this.textNode.set("text", this.data.name);
        }

        this.custom_Icon();
    },
    custom_Icon: function(){},

    loadPreview: function(){
        this.node.setStyles(this.css.attachmentNode_preview);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_preview_selected);

        this.iconNode = new Element("div", {"styles": this.css.attachmentPreviewIconNode}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentPreviewIconImgAreaNode}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentPreviewIconImgNode}).inject(this.iconImgAreaNode);

        var icon = this.getIcon();
        if (this.controller.options.images.indexOf(this.data.extension.toLowerCase())!==-1){
            if (this.type!=="message") this.controller.module.getAttachmentUrl(this, function(url){
                this.iconImgAreaNode.hide();
                this.iconImgNode.hide();
                this.iconNode.setStyles({
                    "background-image": "url("+url+")",
                });
            }.bind(this));
            this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
            if (this.data.objectSecurityPromise){
                this.data.objectSecurityPromise.then(function(label){
                    this.textNode.set("text", "("+label+") " + this.data.name);
                }.bind(this));
            }else{
                this.textNode.set("text", this.data.name);
            }

            // this.textNode.set("text", this.data.name);
        }else if (this.controller.options.audios.indexOf(this.data.extension.toLowerCase())!==-1){
            this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
            if (this.data.objectSecurityPromise){
                this.data.objectSecurityPromise.then(function(label){
                    this.textNode.set("text", "("+label+") " + this.data.name);
                }.bind(this));
            }else{
                this.textNode.set("text", this.data.name);
            }
            // this.textNode.set("text", this.data.name);

            this.controller.module.getAttachmentUrl(this, function(url){
                this.iconImgNode.set({"src": icon, "border": 0});
                this.iconAudioNode = new Element("div", {
                    "styles": this.css.attachmentPreviewAudioNode,
                    "html": "<audio preload=\"metadata\" controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+url+"\" type=\"audio/mpeg\"></source></audio>"
                    //"html": "<audio controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+o2.session.path+"/xApplication/File/$Main/qnyh.mp3\"></source></audio>"
                }).inject(this.textNode, "after");
                this.iconAudioNode.addEvent("dblclick", function(e){e.stopPropagation();});
            }.bind(this));
        }else if (this.controller.options.videos.indexOf(this.data.extension.toLowerCase())!==-1){
            this.controller.module.getAttachmentUrl(this, function(url){
                this.iconNode.empty();
                this.iconVideoNode = new Element("div", {
                    "styles": this.css.attachmentPreviewVideoNode,
                    //"html": "<video preload=\"metadata\" controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+o2.session.path+"/xApplication/File/$Main/IMG_1615.MOV\"></source></video>"
                    "html": "<video preload=\"metadata\" controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+url+"\"></source></video>"
                }).inject(this.iconNode);
                this.iconVideoNode.addEvent("dblclick", function(e){e.stopPropagation();});

                this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
                if (this.data.objectSecurityPromise){
                    this.data.objectSecurityPromise.then(function(label){
                        this.textNode.set("text", "("+label+") " + this.data.name);
                    }.bind(this));
                }else{
                    this.textNode.set("text", this.data.name);
                }
                // this.textNode.set("text", this.data.name);
            }.bind(this));
        }else{
            this.iconImgNode.set({"src": icon, "border": 0});
            this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
            if (this.data.objectSecurityPromise){
                this.data.objectSecurityPromise.then(function(label){
                    this.textNode.set("text", "("+label+") " + this.data.name);
                }.bind(this));
            }else{
                this.textNode.set("text", this.data.name);
            }
            // this.textNode.set("text", this.data.name);
        }
        this.custom_Preview();
    },
    custom_Preview: function(){},

    getPreviewImgSize: function(icon, callback){
        var areaSize = this.iconNode.getSize();
        var img = new Element("img", {"src": icon}).inject($(document.body));
        img.set("src", icon);
        var size = img.getSize();
        img.destroy();
        var x, y;
        var zoom = areaSize.x/size.x;
        var y = size.y*zoom;
        if (y<=areaSize.y){
            x = areaSize.x;
        }else{
            zoom = areaSize.y/size.y;
            x = size.x*zoom;
            y = areaSize.y;
        }
        var size = {"x": x, "y": y, "top": (areaSize.y-y)/2};
        if (callback) callback(size);
    },

    setEvent: function(){
        this.node.addEvents({
            "mouseover": function(){if (!this.isSelected) this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),
            "mouseout": function(){if (!this.isSelected) this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),
            "mousedown": function(e){this.selected(e); e.stopPropagation();}.bind(this),
            "click": function(e){e.stopPropagation();}.bind(this),
            "dblclick": function(e){
                if( this.controller.options.dblclick ){
                    this.controller.dblclickAttachment(e, null, [this]);
                }else{
                    this.openAttachment(e);
                }
            }.bind(this)
        });

        if (this.iconImgNode){
            this.iconImgNode.set("draggable", false);
        }
    },

    selected: function(e){
        if (!e.event.ctrlKey) this.controller.unSelectedAttachments();
        //if (!this.isSelected){
        this.controller.selectedAttachments.push(this);
        this.isSelected = true;
        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]);
        //}

        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("select", [this]);
        }

        if (e) e.stopPropagation();
        this.controller.checkActions();
    },

    unSelected: function(){
        this.isSelected = false;
        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);
        this.controller.selectedAttachments.erase(this);

        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("unselect", [this]);
        }
    },

    changeListStyle: function(style){
        if (this.listStyle!=style){
            this.node.empty();
            switch (style){
                case "list":
                    this.loadList();
                    break;
                case "icon":
                    this.loadIcon();
                    break;
                case "preview":
                    this.loadPreview();
                    break;
                case "sequence":
                    this.loadSequence();
                    break;
            }
            this.listStyle = style;
        }
    },
    reload: function(){
        var node = new Element("div").inject(this.node, "after");

        this.inforNode.destroy();
        this.inforNode = null;
        if (this.tooltip) this.tooltip.destroy();
        this.tooltip = null;

        this.node.destroy();
        delete this.node;
        this.node = node;

        switch (this.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.createInforNode();
        if (!Browser.Platform.ios){
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.node,
                transition: 'flyin'
            });
        }


        this.setEvent();
    },
    openAttachment: function(e){
	    if( !this.controller.options.dblclick ){
            if (!this.controller.options.isDownload || this.controller.options.isDownload === "hidden") return; //兼容以前的配置
        }
        if (this.controller.module) this.controller.module.openAttachment(e, null, [this]);
    },
    setActionEnabled: function(action){
        if (action){
            action.setStyle("display","");
            action.store("disabled", false);
            //if (action.retrieve("disabled")){
            //    var iconNode = action.getFirst();
            //    var icon = iconNode.getStyle("background-image");
            //    var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
            //    icon = icon.substr(0, icon.lastIndexOf("_gray"))+"."+ext;
            //    iconNode.setStyle("background-image", icon);
            //    action.store("disabled", false);
            //}
        }
    },
    setActionDisabled: function(action){
        if (action){
            action.setStyle("display","none");
            action.store("disabled", true);
            //if (!action.retrieve("disabled")){
            //    var iconNode = action.getFirst();
            //    var icon = iconNode.getStyle("background-image");
            //    var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
            //    icon = icon.substr(0, icon.lastIndexOf("."))+"_gray."+ext;
            //    iconNode.setStyle("background-image", icon);
            //    action.store("disabled", true);
            //}
        }
    },
    createAction: function(node, img, img_over, title, click, text){

        var actionNode;

        if( this.controller.options.actionShowText ){
            actionNode = new Element("div", {"styles": this.controller.css.minActionNode, "text": text || title, "title" : title }).inject(node);

            var _self = this;
            actionNode.addEvents({
                "mouseover": function( e ){
                    if (!this.actionNode.retrieve("disabled") && _self.controller.css.minActionNode_over){
                        actionNode.setStyles( _self.controller.css.minActionNode_over );
                    }
                }.bind( { actionNode : actionNode } ),
                "mouseout": function(){
                    if (!this.actionNode.retrieve("disabled") && _self.controller.css.minActionNode_over ){
                        actionNode.setStyles( _self.controller.css.minActionNode );
                    }
                }.bind( { actionNode : actionNode } ),
                "click": function(e){
                    if (!this.retrieve("disabled")){
                        click.apply(_self.controller, [e, this]);
                        e.stopPropagation();
                    }
                }
            });
        }else{
            actionNode = new Element("div", {"styles": this.controller.css.minActionNode, "title": title}).inject(node);

            var actionIconNode = new Element("div", {"styles": this.controller.css.minActionIconNode}).inject(actionNode);
            actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+this.controller.options.style+"/icon/"+img+".png)");

            var _self = this;
            actionNode.addEvents({
                "mouseover": function( e ){
                    if (!this.actionNode.retrieve("disabled")){
                        this.actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+_self.controller.options.style+"/icon/"+this.img+".png)");
                    }
                }.bind( { actionNode : actionNode, actionIconNode: actionIconNode, img : img_over } ),
                "mouseout": function(){
                    if (!this.actionNode.retrieve("disabled")){
                        this.actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+_self.controller.options.style+"/icon/"+this.img+".png)");
                    }
                }.bind( { actionNode : actionNode, actionIconNode: actionIconNode,  img : img } ),
                "click": function(e){
                    if (!this.retrieve("disabled")){
                        click.apply(_self.controller, [e, this]);
                        e.stopPropagation();
                    }
                }
            });
        }
        if( !this.actions )this.actions = [];
        this.actions.push(actionNode);
        return actionNode;
    }
});

o2.widget.AttachmentController.AttachmentMin = new Class({
    Extends: o2.widget.AttachmentController.Attachment,

    initialize: function(data, controller, messageId, isCheckPosition){
        this.data = data;

        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.listStyle = this.controller.options.listStyle;
        this.content = this.controller.minContent;
        this.isSelected = false;
        this.isCheckPosition = isCheckPosition;
        this.seq = this.controller.attachments.length+1;

        if (messageId && this.controller.messageItemList) {
            this.message = this.controller.messageItemList[messageId];
        }

        this.load();
    },
    load: function(){
        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("beforeLoadAttachment", [this]);
        }

        if (this.message){
            this.node = new Element("div").inject(this.message.node, "after");
            // this.node = new Element("div").inject(this.content);
            this.message.node.destroy();
            delete this.controller.messageItemList[this.message.data.id];
        }else{
            this.node = new Element("div").inject(this.content);
        }

        if( this.isCheckPosition && this.isNumber(this.data.orderNumber) ){
            var attList = this.controller.attachments;
            for( var i=0; i<attList.length; i++ ){
                var att = attList[i];
                if( !this.isNumber(att.data.orderNumber) || this.data.orderNumber < att.data.orderNumber ){
                    this.node.inject( att.node, "before" );
                    break;
                }
            }
        }

        //this.node = new Element("div").inject(this.content);
        //this.loadList();
        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.createInforNode();
        if (!Browser.Platform.ios && !layout.mobile){
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.iconImgNode,
                transition: 'flyin'
            });
        }
        this.setEvent();

        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("loadAttachment", [this]);
        }
    },
    loadList: function() {
        this.node.setStyles( layout.mobile ? this.css.minAttachmentNode_list_mobile : this.css.minAttachmentNode_list);

        if( !layout.mobile ){
            this.sepNode = new Element("div", {"styles": this.css.minAttachmentSepNode_list}).inject(this.node);
        }

        this.actionAreaNode = new Element("div", {"styles": this.css.minAttachmentActionAreaNode}).inject(this.node);

        var hiddenList = this.controller.options.singleToolbarHidden;
        if( this.controller.isAttDblclickAvailable(this) && !hiddenList.contains('open') ){
            this.openAction = this.createAction(this.actionAreaNode, "open_single", "open_single_over", o2.LP.widget.open, function (e, node) {
                this.controller.dblclickAttachment(e, node, [this]);
            }.bind(this));
        }

        if ( this.controller.isAttDownloadAvailable(this) && !hiddenList.contains('download') ) {
            this.downloadAction = this.createAction(this.actionAreaNode, "download_single", "download_single_over", o2.LP.widget.download, function (e, node) {
                this.controller.downloadAttachment(e, node);
            }.bind(this));
        }
        //this.actions.push( this.downloadAction );

        if ( this.controller.isAttDeleteAvailable(this) && !hiddenList.contains('delete')) {
            this.deleteAction = this.createAction(this.actionAreaNode, "delete_single", "delete_single_over", o2.LP.widget["delete"], function (e, node) {
                this.controller.deleteAttachment(e, node);
            }.bind(this));
        }

        if ( this.controller.isAttEditAvailable(this) && !hiddenList.contains('edit')) {
            this.editAction = this.createAction(this.actionAreaNode, "edit_single", "edit_single_over", o2.LP.widget["editAtt"], function (e, node) {
                this.controller.editAttachment(e, node);
            }.bind(this));
        }

        //this.actions.push( this.deleteAction );

        if (this.controller.configAttachment) {
            if ( this.controller.isAttConfigAvailable(this) && !hiddenList.contains('config')) {
                this.configAction = this.createAction(this.actionAreaNode, "config_single", "config_single_over", o2.LP.widget.configAttachment, function (e, node) {
                    this.controller.configAttachment(e, node);
                }.bind(this), o2.LP.widget.configAttachmentText );
                //this.actions.push( this.configAction );
            }
        }

        if (this.isSelected) this.node.setStyles(this.css.minAttachmentNode_list_selected);

        this.iconNode = new Element("div", {"styles": this.css.minAttachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.minAttachmentTextNode_list}).inject(this.node);
        if (this.data.objectSecurityPromise){
            this.data.objectSecurityPromise.then(function(label){
                this.textNode.set("text", "("+label+") " + this.data.name);
            }.bind(this));
        }else{
            this.textNode.set("text", this.data.name);
        }
        // this.textNode.set("text", this.data.name);

        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.minAttachmentSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", "（"+size+"）");

        this.node.set("title",this.data.name + "（"+size+"）");

    },
    loadSequence: function(){
        this.node.setStyles(this.css.minAttachmentNode_sequence);

        this.actionAreaNode = new Element("div", {"styles":this.css.minAttachmentActionAreaNode}).inject(this.node);

        debugger;

        var hiddenList = this.controller.options.singleToolbarHidden;

        if( this.controller.isAttDblclickAvailable(this) && !hiddenList.contains('open') ){
            this.openAction = this.createAction(this.actionAreaNode, "open_single", "open_single_over", o2.LP.widget.open, function (e, node) {
                this.controller.dblclickAttachment(e, node, [this]);
            }.bind(this));
        }

        if ( this.controller.isAttDownloadAvailable(this) && !hiddenList.contains('download') ) {
            this.downloadAction = this.createAction(this.actionAreaNode, "download_single", "download_single_over", o2.LP.widget.download, function (e, node) {
                this.controller.downloadAttachment(e, node);
            }.bind(this));
        }
        //this.actions.push( this.downloadAction );

        if ( this.controller.isAttDeleteAvailable(this) && !hiddenList.contains('delete') ) {
            this.deleteAction = this.createAction(this.actionAreaNode, "delete_single", "delete_single_over", o2.LP.widget["delete"], function (e, node) {
                this.controller.deleteAttachment(e, node);
            }.bind(this));
        }

        if ( this.controller.isAttEditAvailable(this) && !hiddenList.contains('edit') ) {
            this.editAction = this.createAction(this.actionAreaNode, "edit_single", "edit_single_over", o2.LP.widget["editAtt"], function (e, node) {
                this.controller.editAttachment(e, node);
            }.bind(this));
        }

        //this.actions.push( this.deleteAction );


        if (this.controller.configAttachment) {
            if ( this.controller.isAttConfigAvailable(this) && !hiddenList.contains('config') ) {
                this.configAction = this.createAction(this.actionAreaNode, "config_single", "config_single_over", MWF.LP.widget.configAttachment, function (e, node) {
                    this.controller.configAttachment(e, node);
                }.bind(this));
                //this.actions.push( this.configAction );
            }
        }

        if (this.isSelected) this.node.setStyles(this.css.minAttachmentNode_list_selected);

        this.sequenceNode = new Element("div", {"styles": this.css.attachmentSeqNode_sequence, "text": (this.seq || 1)}).inject(this.node);
        this.iconNode = new Element("div", {"styles": this.css.minAttachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.minAttachmentTextNode_list}).inject(this.node);
        if (this.data.objectSecurityPromise){
            this.data.objectSecurityPromise.then(function(label){
                this.textNode.set("text", "("+label+") " + this.data.name);
            }.bind(this));
        }else{
            this.textNode.set("text", this.data.name);
        }
        // this.textNode.set("text", this.data.name);
        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.minAttachmentSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", "（"+size+"）");
    },
    setEvent: function(){
        this.node.addEvents({
            "mouseover": function(){
                if (!this.isSelected){
                    if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
                        this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_over"]);
                    }else{
                        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"]);
                    }
                }
            }.bind(this),
            "mouseout": function(){
                if (!this.isSelected){
                    if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
                        var cssKey = "minAttachmentNode_"+this.controller.options.listStyle + ( layout.mobile ? "_mobile" : "" );
                        this.node.setStyles(this.css[cssKey]);
                    }else{
                        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);
                    }
                }
            }.bind(this),
            "mousedown": function(e){this.selected(e);e.stopPropagation();}.bind(this),
            "click": function(e){e.stopPropagation();}.bind(this),
            "dblclick": function(e){
                if( this.controller.options.dblclick ){
                    this.controller.dblclickAttachment(e, null, [this]);
                }else{
                    this.openAttachment(e);
                }
            }.bind(this)
        });

        if (this.iconImgNode){
            this.iconImgNode.set("draggable", false);
        }
    },

    selected: function(e){
        if (!e.event.ctrlKey) this.controller.unSelectedAttachments();
        //if (!this.isSelected){
        this.controller.selectedAttachments.push(this);
        this.isSelected = true;
        if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
            //this.node.setStyles(this.css["minAttachmentNode_list_selected"]);
            this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_selected"]);
        }else{
            this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]);
            //this.node.setStyles(this.css["minAttachmentNode_list_selected"]);
        }

        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("select", [this]);
        }

        //}
        if (e) e.stopPropagation();
        this.controller.checkActions();
    },
    reload: function(){
        var node = new Element("div").inject(this.node, "after");

        this.inforNode.destroy();
        this.inforNode = null;
        if (this.tooltip) this.tooltip.destroy();
        this.tooltip = null;

        this.node.destroy();
        delete this.node;
        this.node = node;

        switch (this.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.createInforNode();
        if (!Browser.Platform.ios){
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.node,
                transition: 'flyin'
            });
        }

        this.setEvent();
    },
    unSelected: function(){
        this.isSelected = false;
        //this.node.setStyles(this.css["minAttachmentNode_list"]);
        if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
            var cssKey = "minAttachmentNode_"+this.controller.options.listStyle + ( layout.mobile ? "_mobile" : "" );
            this.node.setStyles(this.css[cssKey]);
        }else{
            this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);
        }

        if( this.controller.module && this.controller.module.fireEvent ){
            this.controller.module.fireEvent("unselect", [this]);
        }

        this.controller.selectedAttachments.erase(this);
    }

});

o2.widget.AttachmentController.AttachmentMessage = new Class({
    Extends: o2.widget.AttachmentController.Attachment,
    Implements: [Events],
    initialize: function(file, controller){
        var d = (new Date).format("db");
        var extension = file.name.substring(file.name.lastIndexOf(".")+1, file.name.length);
        this.file = file;
        this.type = "message";
        this.data = {
            activity: "",
            activityName: "",
            activityToken: "",
            activityType: "manual",
            application: "",
            completed: false,
            control: {allowRead:true, allowEdit:false, allowControl:false},
            controllerIdentityList: [],
            controllerUnitList: [],
            createTime: d,
            deepPath: false,
            divisionList: [],
            editIdentityList: [],
            editUnitList: [],
            extension: extension,
            id: (new o2.widget.UUID()).toString(),
            job: "",
            lastUpdatePerson: (layout) ? layout.session.user.name : "",
            lastUpdateTime: d,
            length: file.size,
            name: file.name,
            person: (layout) ? layout.session.user.name : "",
            process: "",
            readIdentityList: [],
            readUnitList: [],
            site: "$doc",
            storage: file.size,
            type: "",
            updateTime: d,
            workCreateTime: ""
        }


        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.listStyle = this.controller.options.listStyle;
        this.content = this.controller.content;
        this.isSelected = false;
        this.seq = this.controller.attachments.length+1;
        this.actions = [];
        this.load();
    },
    load: function(){
        this.node = new Element("div").inject(this.content);
        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.setEvent();
        this.loadMessage();
    },
    loadMessage: function(){
        var size = this.node.getSize();
        this.node.setStyle("position", "relative");

        this.messageMaskNode = new Element("div", { "styles": this.css.messageMaskNode }).inject(this.node);
        this.messageMaskNode.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px"
        });


        this.messageNode = new Element("div", { "styles": this.css.messageNode }).inject(this.node);
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                this.messageNode.setStyles({
                    "width": "0px",
                    "height": ""+size.y+"px"
                });
                break;
            case "icon":
            case "preview":
                this.messageNode.setStyles({
                    "width": ""+size.x+"px",
                    "height": ""+size.y+"px"
                });
                break;
        }

        this.messageText = new Element("div", {
            "styles": this.css.messageText,
            "text": "0%"
        }).inject(this.node);
        this.messageText.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px",
            "line-height": ""+size.y+"px"
        });
    },
    updateProgress: function(percent){
        var size = this.node.getSize();
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                var w = size.x*(percent/100);
                this.messageNode.setStyles({
                    "width":""+w+"px"
                });
                break;
            case "icon":
            case "preview":
                var h = size.y*(1-percent/100);
                this.messageNode.setStyle("height", ""+h+"px");
                break;
        }

        var p = (percent*100).toInt()/100;
        this.messageText.set("text", ""+p+"%")
    },
    transferComplete: function(){
        this.messageText.set("text", "loading...")
    }
});
o2.widget.AttachmentController.AttachmentMessageMin = new Class({
    Extends: o2.widget.AttachmentController.AttachmentMin,
    Implements: [Events],
    initialize: function(file, controller){
        var d = (new Date).format("db");
        var extension = file.name.substring(file.name.lastIndexOf(".")+1, file.name.length);
        this.file = file;
        this.data = {
            activity: "",
            activityName: "",
            activityToken: "",
            activityType: "manual",
            application: "",
            completed: false,
            control: {allowRead:true, allowEdit:false, allowControl:false},
            controllerIdentityList: [],
            controllerUnitList: [],
            createTime: d,
            deepPath: false,
            divisionList: [],
            editIdentityList: [],
            editUnitList: [],
            extension: extension,
            id: (new o2.widget.UUID()).toString(),
            job: "",
            lastUpdatePerson: (layout) ? layout.session.user.name : "",
            lastUpdateTime: d,
            length: file.size,
            name: file.name,
            person: (layout) ? layout.session.user.name : "",
            process: "",
            readIdentityList: [],
            readUnitList: [],
            site: "$doc",
            storage: file.size,
            type: "",
            updateTime: d,
            workCreateTime: ""
        }


        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.listStyle = this.controller.options.listStyle;
        this.content = this.controller.minContent;
        this.isSelected = false;
        this.seq = this.controller.attachments.length+1;
        this.actions = [];
        this.load();
    },
    load: function(){
        this.node = new Element("div").inject(this.content);
        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.setEvent();
        this.loadMessage();
    },
    loadMessage: function(){
        var size = this.node.getSize();
        this.node.setStyle("position", "relative");

        this.messageMaskNode = new Element("div", { "styles": this.css.messageMaskNode }).inject(this.node);
        this.messageMaskNode.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px"
        });


        this.messageNode = new Element("div", { "styles": this.css.messageNode }).inject(this.node);
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                this.messageNode.setStyles({
                    "width": "0px",
                    "height": ""+size.y+"px"
                });
                break;
            case "icon":
            case "preview":
                this.messageNode.setStyles({
                    "width": ""+size.x+"px",
                    "height": ""+size.y+"px"
                });
                break;
        }

        this.messageText = new Element("div", {
            "styles": this.css.messageText,
            "text": "0%"
        }).inject(this.node);
        this.messageText.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px",
            "line-height": ""+size.y+"px"
        });
    },
    updateProgress: function(percent){
        var size = this.node.getSize();
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                var w = size.x*(percent/100);
                this.messageNode.setStyles({
                    "width":""+w+"px"
                });
                break;
            case "icon":
            case "preview":
                var h = size.y*(1-percent/100);
                this.messageNode.setStyle("height", ""+h+"px");
                break;
        }

        var p = (percent*100).toInt()/100;
        this.messageText.set("text", ""+p+"%")
    },
    transferComplete: function(){
        this.messageText.set("text", "loading...")
    }
});

MWF.xScript = MWF.xScript || {};
MWF.xScript.Macro = MWF.Macro = {
    "swapSpace": {},
    "scriptSpace": {},

    expression: function(code, bind){},
    runEvent: function(code, bind, arg){},

    exec: function(code, bind){
        var returnValue;
        //try{
        if (!bind) bind = window;
        //this.bind = bind || window;

        var n = 0;
        var o = "f"+"_"+n;
        while (MWF.Macro.scriptSpace[o]){ n++; o = "f"+"_"+n; }
        //MWF.Macro.scriptSpace[o] = bind;

        if (o2.session.isDebugger){
            var f = "MWF.Macro.scriptSpace[\""+o+"\"] = function(){\n"+code+"\n}";
            Browser.exec(f);
            returnValue = (o2.Macro.scriptSpace[o]) ? o2.Macro.scriptSpace[o].apply(bind) : null;
        }else{
            var f = "MWF.Macro.scriptSpace[\""+o+"\"] = function(){try{\n"+code+"\n}catch(e){console.error(e)}}";
            Browser.exec(f);
            returnValue = (o2.Macro.scriptSpace[o]) ? o2.Macro.scriptSpace[o].apply(bind) : null;
        }
        o2.Macro.scriptSpace[o] = null;

        // if (o2.session.isDebugger){
        //     this.run(code, bind)
        // }else{
        //     try {
        //         var n = 0;
        //         var o = "o"+"_"+n;
        //         while (MWF.Macro.swapSpace[o]){
        //             n++;
        //             o = "o"+"_"+n;
        //         }
        //         MWF.Macro.swapSpace[o] = bind;
        //         var f = "try {(function(){\n"+code+"\n}).apply(MWF.Macro.swapSpace[\""+o+"\"])} catch(e){console.log(e);}";
        //         Browser.exec(f);
        //         o2.Macro.swapSpace[o] = null;
        //     }catch(e){
        //         console.log(o2.LP.script.error);
        //         if (code.length>500){
        //             var t = code.substr(0,500)+"\n...\n";
        //             console.log(t);
        //         }else{
        //             console.log(code);
        //         }
        //
        //         console.log(e);
        //         //throw e;
        //     }
        // }
        return returnValue;
    }
};
//try {


// var f = eval("(function(){return function(){\n"+code+"\n}})();");
// returnValue = f.apply(bind);
// }catch(e){
//     console.log(o2.LP.script.error);
//     if (code.length>500){
//         var t = code.substr(0,500)+"\n...\n";
//         console.log(t);
//     }else{
//         console.log(code);
//     }
//
//     console.log(e);
//     debugger;
//     throw e;
// }

MWF.Macro.FormContext = new Class({
    macroFunction: null,
    environment: {},

    initialize: function(form){
        this.form = form;
        var environment = {
            "form": form,
            "forms": form.forms,
            "all": form.all,
            "data": form.businessData.data,
            "work": form.businessData.work,
            "workCompleted": form.businessData.workCompleted,
            "taskList": form.businessData.taskList,
            "readList": form.businessData.readList,
            "control": form.businessData.control,
            "activity": form.businessData.activity,
            "task": form.businessData.task,
            "taskCompletedList": form.businessData.taskCompletedList,
            "workLogList": form.businessData.workLogList,
            "recordList": form.businessData.recordList,
            "attachmentList": form.businessData.attachmentList,
            "inheritedAttachmentList": form.businessData.inheritedAttachmentList,
            "formInfor": form.businessData.formInfor,
            "status": form.businessData.status,
            "target": null,
            "event": null
        };
        MWF.require("MWF.xScript.Environment", null, false);
        this.environment = new MWF.xScript.Environment(environment);
    },
    setTarget: function(target){
        if (target){
            this.environment.target = target;
        }else{
            this.environment.target = null;
        }
    },
    setEvent: function(event){
        if (event){
            this.environment.event = event;
        }else{
            this.environment.event = null;
        }
    },
    exec: function(code, target){
        this.setTarget(target);
        var returnValue = MWF.Macro.exec(code, this.environment);
        //this.form.businessData.data = Object.merge(this.form.businessData.data, this.environment.data);

        return returnValue;
        //this.environment.data

    },
    fire: function(code, target, event){
        this.setTarget(target);
        this.setEvent(event);
        return MWF.Macro.exec(code, this.environment);
    }
});
MWF.Macro.PageContext = new Class({
    macroFunction: null,
    environment: {},
    initialize: function(page){
        this.form = page;
        var environment = {
            "form": page,
            "forms": page.forms,
            "all": page.all,
            "data": page.businessData.data,
            "status": page.businessData.status,
            "pageInfor": page.businessData.pageInfor,
            "target": null,
            "event": null
        };
        MWF.require("MWF.xScript.PageEnvironment", null, false);
        this.environment = new MWF.xScript.PageEnvironment(environment);
    },
    setTarget: function(target){
        if (target){
            this.environment.target = target;
        }else{
            this.environment.target = null;
        }
    },
    setEvent: function(event){
        if (event){
            this.environment.event = event;
        }else{
            this.environment.event = null;
        }
    },
    exec: function(code, target){
        this.setTarget(target);
        var returnValue = MWF.Macro.exec(code, this.environment);
        //this.form.businessData.data = Object.merge(this.form.businessData.data, this.environment.data);

        return returnValue;
        //this.environment.data

    },
    fire: function(code, target, event){
        this.setTarget(target);
        this.setEvent(event);
        return MWF.Macro.exec(code, this.environment);
    }
});

if( !MWF.Macro.ViewContext ) {
    MWF.Macro.ViewContext = new Class({
        macroFunction: null,
        environment: {},
        initialize: function (view) {
            this.form = view;
            var environment = {
                "view": view,
                "viewInfor": view.viewInfor,
                "target": null,
                "event": null
            };
            MWF.require("MWF.xScript.ViewEnvironment", null, false);
            this.environment = new MWF.xScript.ViewEnvironment(environment);
        },
        setTarget: function (target) {
            if (target) {
                this.environment.target = target;
            } else {
                this.environment.target = null;
            }
        },
        setEvent: function (event) {
            if (event) {
                this.environment.event = event;
            } else {
                this.environment.event = null;
            }
        },
        exec: function (code, target) {
            this.setTarget(target);
            var returnValue = MWF.Macro.exec(code, this.environment);
            //this.form.businessData.data = Object.merge(this.form.businessData.data, this.environment.data);

            return returnValue;
            //this.environment.data

        },
        fire: function (code, target, event) {
            this.setTarget(target);
            this.setEvent(event);
            return MWF.Macro.exec(code, this.environment);
        }
    });
}

JSONObject = function(o){
};

o2.widget = o2.widget || {};
o2.widget.Tab = new Class({
	Implements: [Options, Events],
    Extends: o2.widget.Common,
	options: {
		"style": "default"
	},
	initialize: function(container, options){
		this.setOptions(options);
		this.pages = [];

		this.path = o2.session.path+"/widget/$Tab/";
		this.cssPath = o2.session.path+"/widget/$Tab/"+this.options.style+"/css.wcss";
		this._loadCss();
        this.css = Object.clone(this.css);
		this.showPage = null;

		this.node = $(container);
	},
	load: function(){
		if (this.fireEvent("queryLoad")){

			if (!this.tabNodeContainer) this.tabNodeContainer = new Element("div");
			this.tabNodeContainer.set("styles", this.css.tabNodeContainer);
			this.tabNodeContainer.inject(this.node);

			if (!this.tabNodeContainerRight) this.tabNodeContainerRight = new Element("div.tabNodeContainerRight");
            this.tabNodeContainerRight.set("styles", this.css.tabNodeContainerRight);
            this.tabNodeContainerRight.inject(this.tabNodeContainer);

            if (!this.tabNodeContainerLeft) this.tabNodeContainerLeft = new Element("div.tabNodeContainerLeft");
            this.tabNodeContainerLeft.set("styles", this.css.tabNodeContainerLeft);
            this.tabNodeContainerLeft.inject(this.tabNodeContainer);

            if (!this.tabNodeContainerArea) this.tabNodeContainerArea = new Element("div.tabNodeContainerArea");
            this.tabNodeContainerArea.set("styles", this.css.tabNodeContainerArea);
            this.tabNodeContainerArea.inject(this.tabNodeContainerLeft);


			if (!this.contentNodeContainer) this.contentNodeContainer = new Element("div");
			this.contentNodeContainer.set("name", "MWFcontentNodeContainer");
			this.contentNodeContainer.set("styles", this.css.contentNodeContainer);
			this.contentNodeContainer.inject(this.node);

            this.tabNodeContainerRight.addEvents({
                "mouseover": function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight_over)}.bind(this),
                "mouseout": function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight)}.bind(this)
            });

            o2.require("o2.xDesktop.Menu", function(){
                this.tabMenu = new o2.xDesktop.Menu(this.tabNodeContainerRight, {
                    "style": "tab",
                    "event": "click",
                    "container": this.tabNodeContainerRight,
                    "where": {"x": "right", "y": "bottom"},
                    "onQueryShow": function(){
                        this.loadOverMenu();
                    }.bind(this)
                });
                this.tabMenu.load();
            }.bind(this));
            this.tabNodeContainerRight.hide();
			
			this.fireEvent("postLoad");
		}
	},
	rebuildTab: function(contentAreaNode,contentNode, pageNode){

		var tabPage = new o2.widget.TabPage(contentNode, "", this, {"isClose": false});
		
		tabPage.contentNodeArea = contentAreaNode;
		tabPage.tabNode = pageNode;
		tabPage.textNode = pageNode.getFirst();
		tabPage.closeNode = tabPage.textNode.getFirst();
		tabPage.options.title = tabPage.textNode.get("text");
		
		tabPage.load();
		this.pages.push(tabPage);
		return tabPage;
		
	},
	addTab: function(node, title, isclose, pageNode){
		var tabPage = new o2.widget.TabPage(node, title, this, {"isClose": isclose, "tabNode": pageNode});
		tabPage.load();
		this.pages.push(tabPage);
		return tabPage;
	},
    loadOverMenu: function(e){
        this.tabMenu.clearItems();
        var _self = this;
		for (var n=this.showTabIndex; n<this.pages.length; n++){
			var page = this.pages[n];
            var menuItem = this.tabMenu.addMenuItem(page.options.title || page.tabNode.get("text"), "click", function(){
				_self.showOverPage(this);
			});
            menuItem.tabPage = page;
		}
	},
    showOverPage: function(item){
		var page = item.tabPage;
		if (page){
            this.pages.erase(page);
            this.pages.unshift(page);
            page.tabNode.inject(this.tabNodeContainerArea, "top");
            page.showTabIm();
            this.resize();
		}
	},

    resize: function(){
		var size = this.tabNodeContainerLeft.getSize();
		var tabWidth = 0;
        for (var i=0; i<this.pages.length; i++){
            var tabSize = this.pages[i].tabNode.getSize();
            tabWidth += tabSize.x;
            if (tabWidth>size.x) break;
		}
        this.showTabIndex = i;
		if (tabWidth>size.x && i<this.pages.length){
            this.tabNodeContainerRight.show();
		}else{
            this.tabNodeContainerRight.hide();
		}
	}

});

o2.widget.TabPage = new Class({
	Implements: [Options, Events],
	options: {
		"isClose": true,
		"tabNode": null,
		"title": ""
	},

	initialize: function(node, title, tab, options){
		this.setOptions(options);
		this.options.title = title;
		this.tab = tab;
		this.contentNode = $(node);
	},
	load: function(){
		if (!this.contentNodeArea) this.contentNodeArea = new Element("div");
		this.contentNodeArea.set("styles", this.tab.css.contentNodeArea);
		
		if (!this.tabNode) this.tabNode = new Element("div");
		this.tabNode.set("styles", this.tab.css.tabNode);
		// this.tabNode.addEvent("mousedown", function(event){event.stop();});
		
		if (!this.textNode) this.textNode = new Element("div").inject(this.tabNode);
		this.textNode.set({
			"styles": this.tab.css.tabTextNode,
			"text": this.options.title
		});
		this.tabNode.addEvent("click", this._showTab.bind(this));
		this.tabNode.addEvent("mousedown", function(e){ e.stopPropagation();});

		if (this.options.isClose){
			if (!this.closeNode) this.closeNode = new Element("div").inject(this.tabNode);
			this.closeNode.set({
				"styles": this.tab.css.tabCloseNode
			});
			this.closeNode.addEvent("click", this.closeTab.bind(this));
		}
		
		this.contentNodeArea.inject(this.tab.contentNodeContainer);
		this.tabNode.inject(this.tab.tabNodeContainerArea);
		this.contentNode.inject(this.contentNodeArea);

		this.tab.resize();
	},
	loadExisted: function(){
		// this.tabNode.addEvent("mousedown", function(event){event.stop();});
		this.tabNode.addEvent("click", this._showTab.bind(this));
		this.tab.resize();
	},
	_showTab: function(){
		this.showTabIm();
	},
	showTabIm: function(callback){
		if (!this.isShow){
			// if (!this.tabNode.isIntoView()){
             //    this.tab.pages.erase(this);
             //    this.tab.pages.unshift(this);
             //    this.tabNode.inject(this.tab.tabNodeContainerArea, "top");
             //    this.tab.resize();
			// }
			this.tab.pages.each(function(page){
				if (page.isShow) page.hideIm();
			});
			this.showIm(callback);
		}
	},
	showTab: function(callback){
		if (!this.isShow){
			this.tab.pages.each(function(page){
				if (page.isShow) page.hide();
			});
			this.show(callback);
		}
	},
	showIm: function(callback){
		this.fireEvent("queryShow");
		this.tabNode.setStyle("display","");
		this.tabNode.set("styles", this.tab.css.tabNodeCurrent);
		if( this.tab.options.useMainColor ){
			this.tabNode.addClass("mainColor_color");
			this.tabNode.addClass("mainColor_border");
		}
		this.textNode.set("styles", this.tab.css.tabTextNodeCurrent);
		if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNodeCurrent);
		
		this.contentNodeArea.setStyle("display", "block");
		this.contentNodeArea.setStyle("opacity", 1);
		
		this.isShow = true;
		this.tab.showPage = this;
		if (callback) callback();
		this.fireEvent("show");
		this.fireEvent("postShow");
	},
	show: function(callback){
		this.fireEvent("queryShow");
		this.tabNode.setStyle("display","");
		this.tabNode.set("styles", this.tab.css.tabNodeCurrent);
		if( this.tab.options.useMainColor ){
			this.tabNode.addClass("mainColor_color");
			this.tabNode.addClass("mainColor_border");
		}
		this.textNode.set("styles", this.tab.css.tabTextNodeCurrent);
		if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNodeCurrent);
		
		this.contentNodeArea.setStyle("display", "block");
		this.contentNodeArea.setStyle("opacity", 1);
		if (!this.morph){
			this.morph = new Fx.Morph(this.contentNodeArea, {duration: 100});
		}
		this.morph.start({
			"opacity": 1
		}).chain(function(){
			this.isShow = true;
			this.tab.showPage = this;
			if (callback) callback();
			this.fireEvent("postShow");
		}.bind(this));
		this.fireEvent("show");
	},
	hideIm: function(){
		if (this.isShow){
			this.fireEvent("queryHide");
			this.tabNode.set("styles", this.tab.css.tabNode);
			if( this.tab.options.useMainColor ){
				this.tabNode.removeClass("mainColor_color");
				this.tabNode.removeClass("mainColor_border");
			}
			this.textNode.set("styles", this.tab.css.tabTextNode);
			if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNode);
		
			this.contentNodeArea.setStyle("display", "none");
			this.contentNodeArea.setStyle("opacity", 0);

			this.isShow = false;
			this.fireEvent("hide");
			this.fireEvent("postHide");
		}
	},
	hide: function(){
		if (this.isShow){
			this.fireEvent("queryHide");
			this.tabNode.set("styles", this.tab.css.tabNode);
			if( this.tab.options.useMainColor ){
				this.tabNode.removeClass("mainColor_color");
				this.tabNode.removeClass("mainColor_border");
			}
			this.textNode.set("styles", this.tab.css.tabTextNode);
			if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNode);
		
			if (!this.morph){
				this.morph = new Fx.Morph(this.contentNodeArea, {duration: 100});
			}
			this.morph.start({
				"opacity": 0
			}).chain(function(){

				this.contentNodeArea.setStyle("display", "none");
				this.isShow = false;
				this.fireEvent("postHide");
			}.bind(this));
			this.fireEvent("hide");
		}
	},
	enableTab : function( notShow ){
		this.disabled = false;
		if( notShow ){
			this.tabNode.show();
		}else{
			this.showTab();
		}
	},
	disableTab : function( notShowSibling ){
		this.disabled = true;
		this.hideTab( notShowSibling );
	},
	hideTab: function( notShowSibling ){
		this.fireEvent("queryHide");
		this.tabNode.hide();
		this.contentNodeArea.hide();
		var tmp = [];

		if( !notShowSibling ){
			var prevPage = this.getPrevPage();
			if (prevPage && !prevPage.disabled){
				prevPage.showTab();
			}else{
				if (this.tab.pages.length){
					for( var i=0; i<this.tab.pages.length;  i++ ){
						var page = this.tab.pages[i];
						if( !page.disabled ){
							page.showTab();
							break;
						}
					}
					//this.tab.pages[this.tab.pages.length-1].showTab();
				}
			}
		}
		this.isShow = false;
		this.fireEvent("hide");
	},
	closeTab: function(){
        this.fireEvent("queryClose");
		var prevPage = this.getPrevPage();
		this.contentNodeArea.destroy();
		this.tabNode.destroy();
		var tmp = [];
		
		this.tab.pages = this.tab.pages.erase(this);
		
//		this.tab.pages.each(function(item){
//			if (item!=this){
//				tmp.push(item);
//			}
//		});
//		this.tab.pages = tmp;
		
		if (prevPage && !prevPage.disabled){
			prevPage.showTab();
		}else{
			if (this.tab.pages.length){
				for( var i=0; i<this.tab.pages.length;  i++ ){
					var page = this.tab.pages[i];
					if( !page.disabled ){
						page.showTab();
						break;
					}
				}
			}
			//if (this.tab.pages.length) this.tab.pages[this.tab.pages.length-1].showTab();
		}
		this.fireEvent("close");
	},
	getPrevPage: function(){
		var idx = this.tab.pages.indexOf(this);
		var prevIdx = idx-1;
		if (prevIdx<0){
			return null;
		}else{
			return this.tab.pages[prevIdx];
		}
	}
});

o2.widget = o2.widget || {};
o2.require("o2.widget.Common", null, false);
o2.require("o2.xDesktop.Common", null, false);
o2.require("o2.xDesktop.Actions.RestActions", null, false);
o2.widget.O2Identity = new Class({
	Implements: [Options, Events],
	Extends: o2.widget.Common,
	options: {
		"style": "default",
        "canRemove": false,
        "lazy": false,
        "disableInfor" : false,
        "removeByClick": false,
        "styles": "",
        "delay": false
	},
	initialize: function(data, container, options){

		this.setOptions(options);
		this.loadedInfor = false;

		this.path = o2.session.path+"/widget/$O2Identity/";
		this.cssPath = o2.session.path+"/widget/$O2Identity/"+this.options.style+"/css.wcss";
		this._loadCss();

        this.container = $(container);
        this.data = data;
        this.style = this.css;

        this.action = new o2.xDesktop.Actions.RestActions("", "x_organization_assemble_control", "x_component_Org");
        // this.explorer = explorer;
        // this.removeAction = removeAction;
        if(!this.options.delay)this.load();

        //o2.widget.O2Identity.iditems.push(this);
	},
    setText: function(){
	    var disply;
	    if( this.data.displayName ){
            disply = this.data.displayName;
        }else{
	        var name = this.data.name || o2.name.cn(this.data.distinguishedName);
	        var unit;
            if(this.data.unitName){
                unit = this.data.unitName;
            }else if( this.data.unitLevelName ){
                var list = this.data.unitLevelName.split("/");
                unit = list[ list.length - 1 ];
            }
            disply = name + (unit ? "("+unit+")" : "")
        }
        this.node.set("text", this.data.displayName || disply );
    },
    load: function(){
        this.fireEvent("queryLoad");
        var style = ( layout.mobile && this.style.identityNode_mobile ) ?
            this.style.identityNode_mobile : this.style.identityNode;

        if (!this.options.lazy && !this.options.disableInfor) this.getPersonData();
        this.node = new Element("div", {"styles": style }).inject(this.container);
        if( this.options.styles ){
            this.node.setStyles( this.options.styles );
        }
        this.setText();

        if( this.options.removeByClick ){
            this.node.addEvent("click", function(e){
                this.fireEvent("remove", [this, e]);
                e.stopPropagation();
            }.bind(this));
        }

        if (this.options.canRemove){
            this.removeNode = new Element("div", {"styles": this.style.identityRemoveNode}).inject(this.node);
            this.removeNode.addEvent("click", function(e){
                this.fireEvent("remove", [this, e]);
                e.stopPropagation();
            }.bind(this));
        }

        if( !this.options.disableInfor && !layout.mobile){
            if (!this.options.lazy ){
                this.createInforNode(function(){
                    this.fireEvent("loadedInfor", [this]);
                }.bind(this));
            }else{
                this.node.addEvents({
                    "mouseover": function(){
                        if (!this.loadedInfor){
                            this.getPersonData();
                            this.createInforNode(function(){
                                this.fireEvent("loadedInfor", [this]);
                            }.bind(this));
                        }
                    }.bind(this)
                });
            }
        }
        this.setEvent();
        if( !layout.mobile ){
            this.node.addEvents({
                "mouseover": function(){

                    // var style_over = ( layout.mobile && this.style.identityNode_over_mobile ) ?
                    //     this.style.identityNode_over_mobile : this.style.identityNode_over;

                    this.node.setStyles( this.style.identityNode_over ); //style_over
                    if( this.options.styles ){
                        this.node.setStyles( this.options.styles );
                    }
                }.bind(this),
                "mouseout": function(){

                    // var style = ( layout.mobile && this.style.identityNode_mobile ) ?
                    //     this.style.identityNode_mobile : this.style.identityNode;

                    this.node.setStyles( this.style.identityNode ); //style
                    if( this.options.styles ){
                        this.node.setStyles( this.options.styles );
                    }
                }.bind(this)
            });
        }
        this.fireEvent("postLoad");
    },
    setEvent: function(){
	    if( this.open ){
            this.node.addEvents({
                "click": function(ev){
                    this.open(ev);
                    ev.stopPropagation();
                }.bind(this)
            });
        }
    },
    getPersonData: function(){
        if (!this.data.dutys){
            var action = o2.Actions.get("x_organization_assemble_control");
            var id = this.data.distinguishedName || this.data.id || this.data.unique;
            if (id) action.listUnitdutyByIdentity(id, function(json){
                this.data.dutys = json.data;
            }.bind(this), null, false);
        }

        if (!this.data.woPerson){
            // var uri = "/jaxrs/person/{flag}";
            // //uri = uri.replace("{flag}", this.data.person);
            // var uriIdentity = "/jaxrs/identity/{id}";
            this.action.actions = {
                "getPerson": {"uri": "/jaxrs/person/{flag}"},
                "getIdentity": {"uri": "/jaxrs/identity/{id}"}
            };
            var woPerson;
            if (this.data.person){
                this.action.invoke({"name": "getPerson", "async": false, "parameter": {"flag": this.data.person}, "success": function(json){
                    this.data.woPerson = woPerson;
                    woPerson = json.data;
                }.bind(this)});
            }else{
                this.action.invoke({"name": "getIdentity", "async": false, "parameter": {"id": this.data.distinguishedName || this.data.id || this.data.name}, "success": function(json){
                    this.data = json.data;
                    woPerson = json.data.woPerson;
                }.bind(this)});
            }

            return woPerson;
        }else{
            return this.data.woPerson;
        }


        //listDutyNameWithIdentity
    },
    createInforNode: function(callback){
        var person = this.getPersonData();
        if (person){
            this.inforNode = new Element("div", {
                "styles": this.style.identityInforNode
            });
            var nameNode = new Element("div", {
                "styles": this.style.identityInforNameNode
            }).inject(this.inforNode);

            var uri = "/jaxrs/person/{flag}/icon";
            uri = uri.replace("{flag}", person.id || person.unique || person.distinguishedName );
            this.action.getAddress();
            uri = this.action.address+uri;

            uri = o2.filterUrl(uri);

            img = "<img width='50' height='50' border='0' src='"+uri+"' style='border-radius:25px'/>";

            var picNode = new Element("div", {
                "styles": this.style.identityInforPicNode,
                "html": img
            }).inject(nameNode);
            var rightNode = new Element("div", {
                "styles": this.style.identityInforRightTextNode
            }).inject(nameNode);
            var nameTextNode = new Element("div", {
                "styles": this.style.identityInforNameTextNode,
                "text": person.name
            }).inject(rightNode);
            var employeeTextNode = new Element("div", {
                "styles": this.style.identityInforEmployeeTextNode,
                "text": person.employee || ""
            }).inject(rightNode);

            // var phoneNode = new Element("div", {
            //     "styles": this.style.identityInforPhoneNode,
            //     "html": "<div style='width:30px; float:left'>"+o2.LP.desktop.person.personMobile+": </div><div style='width:90px; float:left; margin-left:10px'>"+(person.mobile || "")+"</div>"
            // }).inject(this.inforNode);
            // var mailNode = new Element("div", {
            //     "styles": this.style.identityInforPhoneNode,
            //     "html": "<div style='width:30px; float:left'>"+o2.LP.desktop.person.personMail+": </div><div style='width:90px; float:left; margin-left:10px'>"+(person.mail || "")+"</div>"
            // }).inject(this.inforNode);

            var dutys = [];
            if (this.data.dutys && this.data.dutys.length){
                this.data.dutys.each(function(d){
                    var n = d.name+"("+d.woUnit.levelName+")";
                    dutys.push(n);
                });
            }
            var dutyNode = new Element("div", {
                "styles": this.style.identityInforPhoneNode,
                "html": "<div style='width:30px; float:left'>"+o2.LP.desktop.person.duty+": </div><div style='width:160px; float:left; margin-left:10px'>"+(dutys.join(","))+"</div>"
            }).inject(this.inforNode);

            this.loadedInfor = true;
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.node,
                transition: 'flyin'
            });
        }
        if (callback) callback();
    },
    destroy: function(){
        if (this.tooltip) this.tooltip.destroy();
        this.node.destroy();
        o2.release(this);
    }
});
// o2.widget.Person = new Class({
//     Implements: [Options, Events],
//     Extends: o2.widget.Identity,
//     getPerson: function(callback){
//         if (this.data.name && this.data.id){
//             if (callback) callback({"data": this.data});
//         }else{
//             var key = this.data.name;
//             this.explorer.actions["getPerson"](function(json){
//                 if (callback) callback(json);
//             }, null, key);
//         }
//     }
// });

console.log('load o2.widget.O2Identity ..............');

o2.widget.O2Person = new Class({
    Extends: o2.widget.O2Identity,
    options: {
        "lazy": true
    },
    getPersonData: function(){
        if (!this.data.distinguishedName || !this.data.dutys ){
            this.action.actions = {"getPerson": {"uri": "/jaxrs/person/{id}"}};
            this.action.invoke({"name": "getPerson", "async": false, "parameter": {"id": (this.data.distinguishedName || this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
                var dutyList = [];
                if( this.data.woIdentityList && this.data.woIdentityList.length ){
                    this.data.woIdentityList.each(function (id) {
                        if(id.woUnitDutyList && id.woUnitDutyList.length)dutyList = dutyList.concat(id.woUnitDutyList);
                    })
                }
                this.data.dutys = dutyList;
            }.bind(this)});
        }
        return this.data;
    },
    setText: function(){
        var displayName;
        if(this.data.displayName){
            displayName = this.data.displayName;
        }else if(this.data.name && this.data.name.indexOf("@") > -1){
            displayName = this.data.name.split("@")[0];
        }else if( this.data.name && this.data.name.length === 36 ){
            this.data.id = this.data.name;
            this.getPersonData();
            displayName = this.data.name || this.data.distinguishedName.split("@")[0];
        }else{
            displayName = this.data.name || "";
        }
        this.node.set("text", displayName);
    }
});
o2.widget.O2Unit = new Class({
    Extends: o2.widget.O2Identity,
    getPersonData: function(){
        if (!this.data.distinguishedName || !this.data.levelName){
            this.action.actions = {"getUnit": {"uri": "/jaxrs/unit/{id}"}};
            this.action.invoke({"name": "getUnit", "async": false, "parameter": {"id": (this.data.id || this.data.distinguishedName || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.levelName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    setText: function(){
        this.node.set("text", this.data.displayName || this.data.name);
    }
});
o2.widget.O2Duty = new Class({
    Extends: o2.widget.O2Identity,
    getPersonData: function(){
        return this.data;
        // if (!this.data.woUnit){
        //     this.action.actions = {"getUnitduty": {"uri": "/jaxrs/unitduty/{id}"}};
        //     this.action.invoke({"name": "getUnitduty", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
        //         this.data = json.data;
        //     }.bind(this)});
        // }
    },
    createInforNode: function(){
        if( this.options.showUnit && this.data.woUnit && this.data.woUnit.levelName ){
            this.inforNode = new Element("div", {
                "styles": this.style.identityInforNode
            });
            var nameNode = new Element("div", {
                "text": this.data.displayName || this.data.name
            }).inject(this.inforNode);

            var nameTextNode = new Element("div", {
                "text": this.data.woUnit.levelName
            }).inject(this.inforNode);
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.node,
                transition: 'flyin'
            });
        }else{
            return false;
        }
        // this.inforNode = new Element("div", {
        //     "styles": this.style.identityInforNode
        // });
        // var nameNode = new Element("div", {
        //     "styles": this.style.identityInforNameNode,
        //     "text": this.data.woUnit.levelName
        // }).inject(this.inforNode);
        // this.tooltip = new mBox.Tooltip({
        //     content: this.inforNode,
        //     setStyles: {content: {padding: 15, lineHeight: 20}},
        //     attach: this.node,
        //     transition: 'flyin'
        // });
    },
    setText: function(){
        if( this.options.showUnit && this.data.woUnit ){
            var unit = this.data.woUnit.name ? ("("+this.data.woUnit.name+")") : "";
            this.node.set("text", (this.data.displayName || this.data.name)+unit);
        }else{
            this.node.set("text", this.data.displayName || this.data.name);
        }
    }
});
o2.widget.O2Group = new Class({
    Extends: o2.widget.O2Unit,
    getPersonData: function(){
        if (!this.data.distinguishedName){
            this.action.actions = {"getGroup": {"uri": "/jaxrs/group/{id}"}};
            this.action.invoke({"name": "getGroup", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    },
    setText: function(){
        this.node.set("text", this.data.displayName || this.data.name);
    },
    createInforNode: function(){
        return false;
    }
});
o2.widget.O2Application = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            this.action = new o2.xDesktop.Actions.RestActions("", "x_processplatform_assemble_surface", "");
            this.action.actions = {"getApplication": {"uri": "/jaxrs/application/{id}"}};
            this.action.invoke({"name": "getApplication", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    }
});
o2.widget.O2Portal = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            this.action = new o2.xDesktop.Actions.RestActions("", "x_portal_assemble_surface", "");
            this.action.actions = {"getPortal": {"uri": "/jaxrs/portal/{id}"}};
            this.action.invoke({"name": "getPortal", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                    this.data = json.data;
                }.bind(this)});
        }
    }
});
o2.widget.O2CMSApplication = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            o2.Actions.get("x_cms_assemble_control").getApplication(this.data.id || this.data.name, function(json){
                this.data = json.data;
                if(!this.data.name)this.data.name = this.data.appName;
                if(!this.data.alias)this.data.alias = this.data.appAlias;
            }.bind(this), null, false);
            // this.action = new o2.xDesktop.Actions.RestActions("", "x_cms_assemble_control", "");
            // this.action.actions = {"getApplication": {"uri": "/jaxrs/application/{id}"}};
            // this.action.invoke({"name": "getApplication", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
            //     this.data = json.data;
            // }.bind(this)});
        }
    }
});



o2.widget.O2Process = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            this.action = new o2.xDesktop.Actions.RestActions("", "x_processplatform_assemble_surface", "");
            this.action.actions = {"getProces": {"uri": "/jaxrs/process/{id}/complex"}};
            this.action.invoke({"name": "getProces", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.name || this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open : function (e) {
        if( this.data.id && this.data.application ){
            var appId = "process.ProcessManager" + this.data.application;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = { "application": {
                    "id": this.data.application,
                     "name": this.data.applicationName || ""
                }};
                layout.desktop.openApplication(e, "process.ProcessManager", options);
            }
        }
    }
});
o2.widget.O2CMSCategory = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            o2.Actions.get("x_cms_assemble_control").getCategory((this.data.id || this.data.name), function(json){
                this.data = json.data;
                this.data.name = this.data.categoryName;
            }.bind(this), null, false);
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open : function (e) {
        if( this.data.id && this.data.appId ){
            // var appId = "cms.ColumnManager" + this.data.id;
            // if (layout.desktop.apps[appId]){
            //     layout.desktop.apps[appId].setCurrent();
            // }else {
                var options = {
                    "navi":"categoryConfig",
                    "column":{
                        "id" : this.data.appId,
                        "appName": this.data.appName || ""
                    },
                    "currentCategoryId":this.data.id
                };
                layout.desktop.openApplication(e, "cms.ColumnManager", options);
            // }
        }
    }
});


o2.widget.O2View = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.applicationName || this.data.appName || this.data.name
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    }
});
o2.widget.O2CMSView = new Class({
    Extends: o2.widget.O2View
});
o2.widget.O2QueryView = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getViewById(this.data.id, function(json){
                data = json.data;
            }, function(){
                data = {};
                return true;
            }, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query ){
            var appId = "query.ViewDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {
                    "id": this.data.id,
                    "application": {
                        "id": this.data.query,
                        "name": this.data.name || this.data.queryName || ""
                    },
                    "appId": appId
                };
                layout.desktop.openApplication(e, "query.ViewDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryStatement = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.load("x_query_assemble_designer").StatementAction.get(this.data.id, function(json){
                data = json.data;
            }, function () {
                data = {};
                return true;
            }, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query ){
            var appId = "query.StatementDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {
                    "id": this.data.id,
                    "application": {
                        "id": this.data.query,
                        "name": this.data.name || this.data.queryName || ""
                    },
                    "appId": appId};
                layout.desktop.openApplication(e, "query.StatementDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryStat = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query){
            var appId = "query.StatDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {
                    "id": this.data.id,
                    "application": {
                        "id": this.data.query,
                        "name": this.data.name || this.data.queryName
                    },
                    "appId": appId
                };
                layout.desktop.openApplication(e, "query.StatDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryTable = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getTableById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query){
            var appId = "query.TableDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {
                    "id": this.data.id,
                    "application": {
                        "id": this.data.query,
                        "name": this.data.name || this.data.queryName
                    },
                    "appId": appId};
                layout.desktop.openApplication(e, "query.TableDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryImportModel = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getImportModelById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query){
            var appId = "query.ImporterDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {
                    "id": this.data.id,
                    "application": {
                        "id": this.data.query,
                        "name": this.data.name || this.data.queryName || ""
                    },
                    "appId": appId};
                layout.desktop.openApplication(e, "query.ImporterDesigner", options);
            }
        }
    }
});

o2.widget.O2FormField = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    }
});
o2.widget.O2Role = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.distinguishedName){
            this.action.actions = {"getRole": {"uri": "/jaxrs/role/{id}"}};
            this.action.invoke({"name": "getRole", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    }
});
o2.widget.O2File = new Class({
    Extends: o2.widget.O2Group,
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var extName = this.data.fileName.substring(this.data.fileName.lastIndexOf(".")+1, this.data.fileName.length).toLowerCase();
        if (["png","jpg","bmp","gif","jpeg","jpe"].indexOf(extName)!==-1){
            var url;
            if(this.data.portal) {
                url = MWF.xDesktop.getPortalFileUr(this.data.id, this.data.portal);
            }else if( this.data.appId ){
                url = MWF.xDesktop.getCMSFileUr(this.data.id, this.data.appId);
            }else{
                url = MWF.xDesktop.getProcessFileUr(this.data.id, this.data.application)
            };
            var img = new Element("img", {"src": url, "styles": {"max-width": "280px", "max-height": "140px"}}).inject(this.inforNode);
        }else{
            var nameNode = new Element("div", {
                "styles": this.style.identityInforNameNode,
                "text": this.data.applicationName || this.data.appName || this.data.name
            }).inject(this.inforNode);
        }

        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },

    getPersonData: function(){
        return this.data;
    }
});

o2.widget.O2Script = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    },
    createInforNode: function(){
        if( !this.data.appType )return false;

        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "text": o2.LP[this.data.appType+"Name"]
        }).inject(this.inforNode);
        var nameTextNode = new Element("div", {
            "text": this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open: function(e){
        if( this.data.id && this.data.appId && this.data.appType) {
            this._open();
        }else{
            var app = this.data.appId || this.data.application || this.data.appName || this.data.applicationName;
            var name = this.data.id || this.data.name;
            if( this.data.appType === "service" )app = "service";
            if( name && app && this.data.appType ){
                var p, type = this.data.appType;
                if( type === "process" ){
                    p = o2.Actions.load("x_processplatform_assemble_surface").ScriptAction.getImported(this.data.name, app);
                }else if( type === "portal" ){
                    p = o2.Actions.load("x_portal_assemble_surface").ScriptAction.getImported(app, this.data.name);
                }else if( type === "cms" ){
                    p = o2.Actions.load("x_cms_assemble_control").ScriptAction.load(this.data.name, app);
                }else if( type === "service" ){
                    p = o2.Actions.load("x_program_center").ScriptAction.getImported(this.data.name);
                }
                p.then(function (json) {
                    if( json.data.importedList && json.data.importedList.length ){
                        this.data.id = json.data.importedList[0];
                        this._open(e);
                    }
                }.bind(this))
            }
        }
    },
    _open : function (e) {
        var appName;
        if( this.data.appType === "cms" ){
            appName = "cms.ScriptDesigner";
        }else if( this.data.appType === "portal" ){
            appName = "portal.ScriptDesigner";
        }else if( this.data.appType === "process" ) {
            appName = "process.ScriptDesigner";
        }else if( this.data.appType === "service" ) {
            appName = "service.ScriptDesigner";
        }
        var appId = appName + this.data.id;
        if (layout.desktop.apps[appId]){
            layout.desktop.apps[appId].setCurrent();
        }else {
            var options = {
                "id": this.data.id,
                "appId": appId,
                "application":{
                    "name": this.data.appName || this.data.applicationName || "",
                    "id": this.data.appId
                }
            };
            layout.desktop.openApplication(e, appName, options);
        }
    }
});

o2.widget.O2FormStyle = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    },
    open : function (e) {
        if( typeOf(this.data)==="object" && this.data.id && this.data.appId && this.data.type === "script"){
            var appName;
            switch (this.data.appType){
                case "service":
                    appName = "service.ScriptDesigner";
                    break;
                case "cms":
                    appName = "cms.ScriptDesigner";
                    break;
                default:
                    appName = "process.ScriptDesigner";
            }
            var appId = appName + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options;
                if( this.data.appType === 'service' ){
                    options = {
                        "id": this.data.id
                    };
                }else{
                    options = {
                        "id": this.data.id,
                        "appId": appId,
                        "application":{
                            "name": this.data.appName || this.data.applicationName || "",
                            "id": this.data.appId
                        }
                    };
                }
                layout.desktop.openApplication(e, appName, options);
            }
        }
    }
});

o2.widget.O2Dictionary = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    },
    createInforNode: function(){
        if( !this.data.appType )return false;

        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "text": o2.LP[this.data.appType+"Name"]
        }).inject(this.inforNode);
        var nameTextNode = new Element("div", {
            "text": this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open : function (e) {
        if( this.data.id && this.data.appId && this.data.appType){
            var appName;
            switch (this.data.appType) {
                case "cms":
                    appName = "cms.DictionaryDesigner"; break;
                case "process":
                    appName = "process.DictionaryDesigner"; break;
                case "portal":
                    appName = "portal.DictionaryDesigner"; break;
                default:
                    appName = "service.DictionaryDesigner"; break;
            }
            var appId = appName + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {
                    "id": this.data.id
                };
                if( this.data.appType !== "service" ){
                    options.appId = appId;
                    options.application = {
                        "id": this.data.appId,
                        "name": this.data.appName || this.data.applicationName || ""
                    };
                }
                layout.desktop.openApplication(e, appName, options);
            }
        }
    }
});
o2.widget.O2ProcessActivity = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var name =  this.data.alias ? this.data.name +"("+this.data.alias+")"  : this.data.name;
        var showName = this.data.processName + ' - '+name;
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": showName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    }
});

o2.widget.O2Other = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    }
});

/**
 * @return {null}
 */
o2.widget.O2Org = function(value, container, options){
    var v = (o2.typeOf(value)==="string") ? {"name": value} : value.distinguishedName;
    var t = v.distinguishedName || v.name || "";
    if (t) {
        var flag = t.substr(t.length - 1, 1);
        switch (flag.toLowerCase()) {
            case "i":
                return new o2.widget.O2Identity(v, container, options);
            case "p":
                return new o2.widget.O2Person(v, container, options);
            case "u":
                return new o2.widget.O2Unit(v, container, options);
            case "g":
                return new o2.widget.O2Group(v, container, options);
            case "r":
                return new o2.widget.O2Role(v, container, options);
            case "d":
                return new o2.widget.O2Duty(v, container, options);
            default:
                return new o2.widget.O2Other(v, container, options);
        }
    }
    return null;
};

//MWF.require(["MWF.widget.Common", "MWF.widget.Identity", "MWF.widget.O2Identity"], null, false);
MWF.require(["MWF.widget.Common", "MWF.widget.O2Identity"], null, false);
MWF.xApplication.process = MWF.xApplication.process || {};
MWF.xApplication.process.Xform = MWF.xApplication.process.Xform || {};
MWF.xDesktop.requireApp("process.Xform", "lp." + MWF.language, null, false);
//MWF.xDesktop.requireApp("process.Xform", "Package", null, false);

/** @class Form 流程表单。
 * @o2cn 流程表单
 * @o2category FormComponents
 * @o2range {Process}
 * @example
 * //可以在脚本中获取表单
 * //方法1：
 * var form = this.form.getApp().appForm; //获取表单
 * //方法2
 * var form = this.target; //在表单本身的事件脚本中获取
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Form = MWF.APPForm = new Class(
    /** @lends MWF.xApplication.process.Xform.Form# */
{
    Implements: [Options, Events],
    Extends: MWF.widget.Common,
    options: {
        "style": "default",
        "readonly": false,
        "cssPath": "",
        "macro": "FormContext",
        "parameters": null,
        "moduleEvents": [
            /**
             * 表单加载前触发。数据（businessData）、预加载脚本和表单html已经就位。
             * @event MWF.xApplication.process.Xform.Form#queryLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "queryLoad",
            /**
             * 表单加载前触发。如果是流程表单，已提示抢办锁定。
             * @event MWF.xApplication.process.Xform.Form#beforeLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeLoad",
            /**
             * 表单的所有组件加载前触发，此时表单的样式和js head已经加载。
             * @event MWF.xApplication.process.Xform.Form#beforeModulesLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeModulesLoad",
            /**
             * 表单加载后触发。主表单的组件加载完成，但不保证子表单、子页面、部件加载完成。
             * @event MWF.xApplication.process.Xform.Form#postLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "postLoad",
            /**
             * 表单的所有组件加载后触发。表单包含有子表单、子页面、部件时，此事件会在这些组件加载后触发。
             * 如果包含异步加载的组件，如异步加载的下拉框选项等，会在这些组件加载完成后执行。
             * 一些组件比如视图、数据源的加载完成需要在组件本身事件中处理。
             * @event MWF.xApplication.process.Xform.Form#afterModulesLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterModulesLoad",
            /**
             * 表单加载后触发。表单包含有子表单、子页面、部件时，此事件会在这些组件加载后触发。
             * @event MWF.xApplication.process.Xform.Form#afterLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterLoad",
            /**
             * 保存前触发。如果是流程表单，流转前也会触发本事件。
             * @event MWF.xApplication.process.Xform.Form#beforeSave
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeSave",
            /**
             * 保存后触发。如果是流程表单，流转后也会触发本事件。
             * @event MWF.xApplication.process.Xform.Form#afterSave
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterSave",
            /**
             * 关闭前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeClose
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeClose",
            /**
             * 弹出提交界面前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeProcessWork
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeProcessWork",
            /**
             * 流转前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeProcess
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeProcess",
            /**
             * 流转后触发。
             * @event MWF.xApplication.process.Xform.Form#afterProcess
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterProcess",
            /**
             * 加载弹出的提交界面以后执行，this.event指向弹出界面对象。
             * @event MWF.xApplication.process.Xform.Form#afterLoadProcessor
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterLoadProcessor",
            /**
             * 关闭弹出的提交界面以后执行。
             * @event MWF.xApplication.process.Xform.Form#closeProcessor
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "closeProcessor",
            /**
             * 重置处理人前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeReset
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeReset",
            /**
             * 重置处理人后触发。
             * @event MWF.xApplication.process.Xform.Form#afterReset
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterReset",
            /**
             * 撤回前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeRetract
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeRetract",
            /**
             * 撤回后触发。
             * @event MWF.xApplication.process.Xform.Form#afterRetract
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterRetract",
            /**
             * 添加拆分分支前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeAddSplit
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeAddSplit",
            /**
             * 添加拆分分支后触发。
             * @event MWF.xApplication.process.Xform.Form#afterAddSplit
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterAddSplit",
            /**
             * 调度前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeReroute
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeReroute",
            /**
             * 调度后触发。
             * @event MWF.xApplication.process.Xform.Form#afterReroute
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterReroute",
            /**
             * 删除工作前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeDelete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeDelete",
            /**
             * 删除工作后触发。
             * @event MWF.xApplication.process.Xform.Form#afterDelete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterDelete",
            "resize",
            /**
             * 已阅前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeReaded
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeReaded",
            /**
             * 已阅后触发。
             * @event MWF.xApplication.process.Xform.Form#afterReaded
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterReaded",

            /**
             * 加签前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeAddTask
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeAddTask",

            /**
             * 加签后触发。
             * @event MWF.xApplication.process.Xform.Form#afterAddTask
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterAddTask",

            /**
             * 退回前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeGoBack
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeGoBack",

            /**
             * 退回后触发。
             * @event MWF.xApplication.process.Xform.Form#afterGoBack
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterGoBack",

            /**
             * 回溯前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeRollback
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeRollback",

            /**
             * 回溯后触发。
             * @event MWF.xApplication.process.Xform.Form#afterRollback
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterRollback"
        ]
    },
    initialize: function (node, data, options) {
        this.setOptions(options);

        /**
         * @summary 表单容器
         * @see https://mootools.net/core/docs/1.6.0/Element/Element
         * @member {Element}
         * @example
         *  //可以在脚本中获取表单容器
         * var formContainer = this.form.getApp().appForm.container;
         */
        this.container = $(node);
        this.container.setStyle("-webkit-user-select", "text");
        if (Browser.firefox) this.container.setStyle("opacity", 0);

        this.data = data;
        //var jsonData = JSON.parse(data)

        /**
         * @summary 表单的配置信息，比如表单名称，提交方式等等.
         * @member {Object}
         * @example
         *  //可以在脚本中获取表单配置信息
         * var json = this.form.getApp().appForm.json; //表单配置信息
         * var name = json.name; //表单名称
         */
        this.json = data.json;
        this.html = data.html;

        this.path = "../x_component_process_Xform/$Form/";
        this.cssPath = this.options.cssPath || "../x_component_process_Xform/$Form/" + this.options.style + "/css.wcss";
        this._loadCss();

        this.sectionListObj = {};

        if (layout.mobile){
            this.json.mode = "Mobile";
        }

        /**
         * @summary 表单中的所有组件数组.
         * @member {Array}
         * @example
         * //下面的样例对表单组件进行循环，并且判断是输入类型的组件
         * var modules = this.form.getApp().appForm.modules; //获取所有表单组件
         * for( var i=0; i<modules.length; i++ ){ //循环处理组件
         *   //获取组件的类型
            var moduleName = module.json.moduleName;
            if( !moduleName ){
                moduleName = typeOf(module.json.type) === "string" ? module.json.type.toLowerCase() : "";
            }
            if( ["calendar","combox","number","textfield"].contains( moduleName )){ //输入类型框
                //do something
             }
         * }
         */
        this.modules = [];

        /**
         * 该对象的key是组件标识，value是组件对象，可以使用该对象根据组件标识获取组件。<br/>
         * 需要注意的是，在子表单中嵌入不绑定数据的组件（比如div,common,button等等），系统允许重名。<br/>
         * 在打开表单的时候，系统会根据重名情况，自动在组件的标识后跟上 "_1", "_2"。
         * @summary 表单中的所有组件对象.
         * @member {Object}
         * @example
         * var moduleAll = this.form.getApp().appForm.all; //获取组件对象
         * var subjectField = moduleAll["subject"] //获取名称为subject的组件
         */
        this.all = {};
        this.allForName = {};
        this.forms = {};

        //if (!this.personActions) this.personActions = new MWF.xAction.org.express.RestActions();
    },
    parseCSS: function (css) {
        var rex = /(url\(.*\))/g;
        var match;
        while ((match = rex.exec(css)) !== null) {
            var pic = match[0];

            var len = pic.length;
            var s = pic.substring(pic.length - 2, pic.length - 1);
            var n0 = (s === "'" || s === "\"") ? 5 : 4;
            var n1 = (s === "'" || s === "\"") ? 2 : 1;
            pic = pic.substring(n0, pic.length - n1);

            if ((pic.indexOf("x_processplatform_assemble_surface") != -1 || pic.indexOf("x_portal_assemble_surface") != -1)  && !pic.startsWith("..")) {
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (pic.indexOf("/x_processplatform_assemble_surface") !== -1 && pic.indexOf(host1) === -1) {
                    pic = pic.replace("/x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                } else if (pic.indexOf("x_processplatform_assemble_surface") !== -1 && pic.indexOf(host1) === -1) {
                    pic = pic.replace("x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                }
                if (pic.indexOf("/x_portal_assemble_surface") !== -1 && pic.indexOf(host2) === -1) {
                    pic = pic.replace("/x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                } else if (pic.indexOf("x_portal_assemble_surface") !== -1 && pic.indexOf(host2) === -1) {
                    pic = pic.replace("x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                }
                pic = o2.filterUrl(pic);
            }
            pic = "url('" + pic + "')";
            var len2 = pic.length;

            css = css.substring(0, match.index) + pic + css.substring(rex.lastIndex, css.length);
            rex.lastIndex = rex.lastIndex + (len2 - len);
        }
        return css;
    },
    loadCss: function () {
        var cssText = (this.json.css) ? this.json.css.code : "";
        //var head = (document.head || document.getElementsByTagName("head")[0] || document.documentElement);
        var styleNode = $("style" + this.json.id);
        //if (styleNode) styleNode.destroy();
        if (!styleNode && cssText) {


            //删除注释
            // cssText = cssText.replace(/\/\*[\s\S]*?\*\/\n|([^:]|^)\/\/.*\n$/g, '').replace(/\\n/, '');

            //cssText = cssText.replace(/\/\*[\s\S]*?\*\/|(?<!:)\/\/.*/g, '').replace(/\\n/, '');

            cssText = cssText.replace(/\/\*[\s\S]*?\*\//g, '')  // 移除多行注释
                .replace(/\/\/.*/g, '')           // 移除单行注释
                .replace(/\\n/g, '');             // 移除\n

            cssText = this.parseCSS(cssText);

            var rex = new RegExp("(.+)(?=\\{)", "g");
            var match;
            var id = this.json.id.replace(/\-/g, "");
            var prefix = ".css" + id + " ";

            while ((match = rex.exec(cssText)) !== null) {
                var rulesStr = match[0];
                var startWith = rulesStr.substring(0, 1);
                if (startWith === "@" || startWith === ":" || rulesStr.indexOf("%") !== -1) {

                }else if (rulesStr.trim()==='from' || rulesStr.trim()==='to'){

                } else {
                    if (rulesStr.indexOf(",") != -1) {
                        //var rules = rulesStr.split(/\s*,\s*/g);
                        var rules = rulesStr.split(/,/g);
                        rules = rules.map(function (r) {
                            return prefix + r;
                        });
                        var rule = rules.join(",");
                        cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                        rex.lastIndex = rex.lastIndex + (prefix.length * rules.length);

                    } else {
                        var rule = prefix + match[0];
                        cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                        rex.lastIndex = rex.lastIndex + prefix.length;
                    }
                }
            }

            styleNode = document.createElement("style");
            styleNode.setAttribute("type", "text/css");
            styleNode.id = "style" + this.json.id;
            styleNode.inject(document.head, "bottom");

            if (styleNode.styleSheet) {
                var setFunc = function () {
                    styleNode.styleSheet.cssText = cssText;
                };
                if (styleNode.styleSheet.disabled) {
                    setTimeout(setFunc, 10);
                } else {
                    setFunc();
                }
            } else {
                var cssTextNode = document.createTextNode(cssText);
                styleNode.appendChild(cssTextNode);
            }
            return "css" + id;
        }
        return "css" + this.json.id.replace(/\-/g, "");
    },
    keyLock: function (async) {
        var lockData = null;
        var key = this.businessData.work.id + "-" + this.businessData.work.activityToken;
        o2.Actions.load("x_processplatform_assemble_surface").KeyLockAction.lock({ "key": key }, function (json) {
            flagData = json.data;
            if (async && flagData.success) this.keyLockTimeoutId = window.setTimeout(function () { this.keyLock(true) }.bind(this), 90000);
            if (async && !flagData.success) this.app.reload();
        }.bind(this), null, !!async);
        return flagData;
    },
    checkLock: function () {
        if (this.businessData.control.allowProcessing && this.businessData.activity && this.businessData.activity.manualMode == "grab") {
            this.app.addEvent("queryClose", function () {
                if (this.keyLockTimeoutId) window.clearTimeout(this.keyLockTimeoutId);
            }.bind(this));
            var lockData = this.keyLock();
            if (lockData.success) {
                this.keyLock(true);
            } else {
                this.businessData.control.allowFlow = false;
                this.businessData.control.allowProcessing = false;
                this.businessData.control.allowSave = false;
                this.businessData.control.allowReset = false;
                this.businessData.control.allowReroute = false;
                this.businessData.control.allowDelete = false;
                this.businessData.control.allowAddSplit = false;
                this.businessData.control.allowRetract = false;
                this.businessData.control.allowRollback = false;
                this.lockDataPerson = lockData.person;
                // var text = MWF.xApplication.process.Xform.LP.keyLockInfor;
                // text = text.replace("{name}", o2.name.cn(lockData.person));
                // var title = MWF.xApplication.process.Xform.LP.keyLockTitle;
                // this.app.alert("info", "center", title, text, 400, 160);

                // o2.DL.open({
                //     "title": title,
                //     "text": text,
                //     "width": 400
                // })
            }
        }
    },
    load: function (callback) {

        this.loadMacro(function () {
            this.loadLanguage(function(flag){
                this.isParseLanguage = flag;
                if (flag && this.formDataText){
                    var data = o2.bindJson(this.formDataText,  {"lp": MWF.xApplication.process.Xform.LP.form});
                    this.data = JSON.parse(data);

                    this.json = this.data.json;
                    this.html = this.data.html;
                }
                this.checkLock();

                this.loadExtendStyle(function () {
                    if (this.app) {
                        if (this.app.formNode) this.app.formNode.setStyles(this.json.styles);
                        if (this.app.addEvent) {
                            this.app.addEvent("resize", function () {
                                this.fireEvent("resize");
                            }.bind(this));
                            this.app.addEvent("queryClose", function () {
                                this.beforeCloseWork();
                            }.bind(this));
                        }
                    }
                    if (!this.businessData.control.allowSave) this.setOptions({ "readonly": true });

                    // var cssClass = "";
                    // if (this.json.css && this.json.css.code) cssClass = this.loadCss();
                    var cssClass = this.loadCss();

                    //this.container.setStyle("opacity", 0);


                    this.container.set("html", this.html);
                    this.node = this.container.getFirst();

                    if (cssClass && !this.node.hasClass(cssClass)) this.node.addClass(cssClass);

                    this._loadEvents();

                    this.loadRelatedScript();
                    //this.loadResource( function () {
                    // this.loadDictionaryList(function () {

                    this.fireEvent("queryLoad");

                    if (!this.json) return;
                    var cssPromise = [];
                    if (this.json.cssUrl){
                        cssPromise.push(new Promise(function(resolve){
                            this.container.loadCss(this.json.cssUrl, null, function(){resolve()});
                        }.bind(this)));
                    }
                    if (this.json.cssLink){
                        cssPromise.push(new Promise(function(resolve){
                            this.container.loadCss(this.json.cssLink, null, function(){resolve()});
                        }.bind(this)));
                    }
                    if (cssPromise.length){
                        Promise.all(cssPromise).then(function(){
                            if (this.event_resolve) {
                                this.event_resolve(function () {
                                    this.loadForm(callback);
                                }.bind(this));
                            } else {
                                this.loadForm(callback);
                            }
                        }.bind(this));
                    }else{
                        if (this.event_resolve) {
                            this.event_resolve(function () {
                                this.loadForm(callback);
                            }.bind(this));
                        } else {
                            this.loadForm(callback);
                        }
                    }

                    // if (this.json.cssUrl) this.container.loadCss(this.json.cssUrl);
                    // if (this.json.cssLink) this.container.loadCss(this.json.cssLink, null, function(){
                    //
                    // }.bind(this));

                }.bind(this));



                // }.bind(this));

                //}.bind(this));

            }.bind(this));
        }.bind(this));
    },
    loadLanguage: function(callback){
        if (this.json.languageType!=="script" && this.json.languageType!=="default" && this.json.languageType!=="lib" && this.json.languageType!=="dict"){
            if (callback) callback();
            return true;
        }

        var language = MWF.xApplication.process.Xform.LP.form;
        var languageJson = null;
        var name = "lp-"+o2.language;
        var app;
        if (this.options.macro==="PageContext") {
            app = (this.app.portal && this.app.portal.id) ? this.app.portal.id : this.json.application;
        }else{
            app = (this.businessData.work || this.businessData.workCompleted).application;
        }

        if (this.json.languageType=="script"){
            if (this.json.languageScript && this.json.languageScript.code){
                languageJson = this.Macro.exec(this.json.languageScript.code, this);
            }
        }else if (this.json.languageType=="default") {
            var p1, p2;
            if (this.options.macro==="PageContext"){
                var portal = (this.app.portal && this.app.portal.id) ? this.app.portal.id : this.json.application;

                p1 = this.workAction.getDictRoot(name, portal, function(d){
                    return d.data;
                }, function(){
                    return true;
                });

                p2 = new Promise(function(resolve, reject){
                    this.workAction.getScriptByNameV2(portal, name, function(d){
                        if (d.data.text) {
                            resolve(this.Macro.exec(d.data.text, this));
                        }
                    }.bind(this), function(){reject("");});
                }.bind(this));
                languageJson = Promise.any([p1, p2]);
            }else{
                var application = (this.businessData.work || this.businessData.workCompleted).application;
                p1 = this.workAction.getDictRoot(name, application, function(d){
                    return d.data;
                }, function(){
                    return true;
                });
                p2 = new Promise(function(resolve, reject){
                    this.workAction.getScriptByNameV2(name, application, function(d){
                        if (d.data.text) {
                            resolve(this.Macro.exec(d.data.text, this));
                        }
                    }.bind(this), function(){reject("");});
                }.bind(this));
                languageJson = Promise.any([p1, p2]);
            }
        }else if (this.json.languageType=="lib") {
            var par1 = (this.options.macro==="PageContext") ? app : name;
            var par2 = (this.options.macro==="PageContext") ? name : app;
            languageJson = new Promise(function(resolve, reject){
                this.workAction.getScriptByNameV2(par1, par2, function(d){
                    if (d.data.text) {
                        resolve(this.Macro.exec(d.data.text, this));
                    }
                }.bind(this), function(){reject("");});
            }.bind(this));

        }else if (this.json.languageType=="dict") {
            languageJson = this.workAction.getDictRoot(name, app, function(d){
                return d.data;
            }, function(){
                return true;
            });
        }

        if (languageJson){
            if (languageJson.then && o2.typeOf(languageJson.then)=="function"){
                languageJson.then(function(json) {
                    if (!json.data){
                        var o = Object.clone(json);
                        json.data = o;
                    }
                    MWF.xApplication.process.Xform.LP.form = Object.merge(MWF.xApplication.process.Xform.LP.form, json);
                    if (callback) callback(true);
                }, function(){
                    if (callback) callback(true);
                })
            }else{
                MWF.xApplication.process.Xform.LP.form = Object.merge(MWF.xApplication.process.Xform.LP.form, languageJson);
                if (callback) callback(true);
            }
        }else{
            if (callback) callback(true);
        }

    },
    loadRelatedScript: function () {

        if (this.json.includeScripts && this.json.includeScripts.length) {
            var includeScriptText = "";
            var includedIds = [];
            this.json.includeScripts.each(function (s) {
                if (this.app.relatedScriptMap && this.app.relatedScriptMap[s.id]) {
                    includeScriptText += "\n" + this.app.relatedScriptMap[s.id].text;
                    includedIds.push(s.id);
                }
            }.bind(this));

            if (includeScriptText) this.Macro.exec(includeScriptText, this);
        }
    },
    loadForm: function (callback) {
        if (this.lockDataPerson) {
            var text = MWF.xApplication.process.Xform.LP.keyLockInfor;
            text = text.replace("{name}", o2.name.cn(this.lockDataPerson));
            var title = MWF.xApplication.process.Xform.LP.keyLockTitle;
            this.app.alert("info", "center", title, text, 400, 160);
        }

        if (this.app) if (this.app.fireEvent) this.app.fireEvent("queryLoad");
        this._loadBusinessData();
        this.fireEvent("beforeLoad");
        if (this.app) if (this.app.fireEvent) this.app.fireEvent("beforeLoad");
        this.loadContent(callback);
    },
    loadExtendStyle: function (callback) {
        if (!this.json.styleConfig || !this.json.styleConfig.extendFile) {
            if (callback) callback();
            return;
        }
        // if (this.json["$version"] == "5.2") {
        //     if (callback) callback();
        //     return;
        // }
        var stylesUrl = "../x_component_process_FormDesigner/Module/Form/skin/" + this.json.styleConfig.extendFile;
        MWF.getJSON(stylesUrl, {
                "onSuccess": function (responseJSON) {
                    if (responseJSON && responseJSON.form) {
                        this.json = Object.merge(this.json, responseJSON.form);
                    }
                    if (callback) callback();
                }.bind(this),
                "onRequestFailure": function () {
                    if (callback) callback();
                }.bind(this),
                "onError": function () {
                    if (callback) callback();
                }.bind(this)
            }
        );
    },
    loadMacro: function (callback) {
        //if (!MWF.Macro[this.options.macro || "FormContext"]){
        MWF.require("MWF.xScript.Macro", function () {
            this.Macro = new MWF.Macro[this.options.macro || "FormContext"](this);
            if (callback) callback();
        }.bind(this));
        // }else{
        //     this.Macro = new MWF.Macro[this.options.macro || "FormContext"](this);
        //     if (callback) callback();
        // }
    },
    loadContent: function (callback) {
        this.subformCount = 0;
        this.subformLoadedCount = 0;
        this.subformLoaded = [this.json.id];

        this.subpageCount = 0;
        this.subpageLoadedCount = 0;
        this.subpageLoaded = [];

        this.widgetCount = 0;
        this.widgetLoadedCount = 0;
        this.widgetLoaded = [];

        this._loadHtml();
        this._loadForm();
        this.fireEvent("beforeModulesLoad");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeModulesLoad");
        this._loadModules(this.node);
        if (Browser.firefox) this.container.setStyle("opacity", 1);

        if (this.json.mode === "Mobile" || layout.mobile) {
            var node = document.body.getElement(".o2_form_mobile_actions");
            if (node && this.businessData.work) {
                node.empty();
                this._loadMobileActions(node, callback);
            } else {
                if (callback) callback();
                //console.log("没有找到移动端底部操作栏！")
            }
        } else {
            if (callback) callback();
        }

        this.fireEvent("postLoad");
        if (this.app && this.app.fireEvent) this.app.fireEvent("postLoad");
        this.checkSubformLoaded(true);
    },
    checkSubformLoaded: function (isAllSubformLoaded) {
        if (isAllSubformLoaded) {
            this.isAllSubformLoaded = true;
        }
        if (!this.isAllSubformLoaded) return;
        if (this.isLoaded)return;
        //console.log( "checkSubformLoaded this.subformCount="+ this.subformCount + " this.subformLoadedCount="+this.subformLoadedCount );
        if ((!this.subformCount || this.subformCount === this.subformLoadedCount) &&
            (!this.subpageCount || this.subpageCount === this.subpageLoadedCount) &&
            (!this.widgetCount || this.widgetCount === this.widgetLoadedCount)
        ) {
            //this.container.setStyle("opacity", 1);

            var moduleAgList = [];
            this.modules.each( function(module){
                if( !module )return;
                if( module.moduleValueAG )moduleAgList.push( module.moduleValueAG );
                if( module.moduleSelectAG && module.moduleValueAG !== module.moduleSelectAG )moduleAgList.push(module.moduleSelectAG);
            });


            Promise.all( moduleAgList ).then(function () {
                this.fireEvent("afterModulesLoad");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterModulesLoad");

                this.fireEvent("afterLoad");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterLoad");
                this.isLoaded = true;
            }.bind(this));

        }
    },
    _loadMobileDefaultTools: function (callback) {
        if (this.json.multiTools) {
            if (callback) callback();
        }else if (this.json.defaultTools) {
            if (callback) callback();
        } else {
            this.json.defaultTools = o2.JSON.get("../x_component_process_FormDesigner/Module/Form/toolbars.json", function (json) {
                tools = json.filter( function (d) { return !d.hidden; } );
                // this.json.multiTools = tools;
                this.json.defaultTools = tools;
                if (callback) callback();
            }.bind(this));
        }
    },

    _loadMobileActions: function (node, callback) {
        var tools = [];
        this._loadMobileDefaultTools(function () {
            var jsonStr;
            if( this.json.multiTools ){
                jsonStr = JSON.stringify(this.json.multiTools);
                jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.process.Xform.LP.form});
                this.multiToolsJson = JSON.parse(jsonStr);
                var json = Array.clone(this.multiToolsJson);
                json.each(function (tool) {
                    var flag;
                    if( tool.system ){
                        flag = this._checkDefaultMobileActionItem(tool, this.options.readonly);
                    }else{
                        flag = this._checkCustomMobileActionItem(tool, this.options.readonly)
                    }
                    if (flag) tools.push(tool);
                }.bind(this));
            }else{
                if (this.json.defaultTools) {
                    jsonStr = JSON.stringify(this.json.defaultTools);
                    jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.process.Xform.LP.form});
                    this.json.defaultTools = JSON.parse(jsonStr);
                    this.json.defaultTools.each(function (tool) {
                        var flag = this._checkDefaultMobileActionItem(tool, this.options.readonly);
                        if (flag) tools.push(tool);
                    }.bind(this));
                }
                if (this.json.tools) {
                    jsonStr = JSON.stringify(this.json.tools);
                    jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.process.Xform.LP.form});
                    this.json.tools = JSON.parse(jsonStr);
                    this.json.tools.each(function (tool) {
                        var flag = this._checkCustomMobileActionItem(tool, this.options.readonly);
                        if (flag) tools.push(tool);
                    }.bind(this));
                }
            }
            this.mobileTools = tools;
            if (tools.length <= 0) {
                if (node) {
                    node.hide();
                    const prevNode = node.previousElementSibling;
                    if (prevNode) {
                        prevNode.style.bottom = '0px';
                    }
                }
            } else {
                // app上用原来的按钮样式
                if (window.o2android || window.flutter_inappwebview || (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.o2mLog)) {
                    if (node) this._createMobileActions(node, tools);
                } else {
                    if (node) this._createMobileActionsDingdingStyle(node, tools);
                }
            }
            if (callback) callback();
        }.bind(this));
    },
    // 钉钉 企业微信的按钮样式
    _createMobileActionsDingdingStyle: function (node, tools) {
        node.show();
        var count = tools.length;
        if (count <= 2) {
            //左边 间隔
            var dingdingSplitLeft = new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            var splitSize = dingdingSplitLeft.getSize();
            var size = document.body.getSize();
            var buttonWidth = (size.x - splitSize.x * (count + 1) - (count * 2)) / count;
            tools.each(function (tool) {
                var actionStyle = this.css.html5ActionButtonDingdingNormal;
                var classBg = "";
                if (tool.action === "processWork" || tool.action === "flowWork" || tool.action === "retractWork" || tool.id === "action_processWork" || tool.id === "action_retract" || tool.id === "action_flowWork") {
                    actionStyle = this.css.html5ActionButtonDingdingPrimary;
                    classBg = "mainColor_bg mainColor_border";
                } else if (tool.action === "deleteWork" || tool.id === "action_delete") {
                    actionStyle = this.css.html5ActionButtonDingdingDanger;
                }
                actionStyle.width = buttonWidth + "px";
                var action = new Element("div", { "styles": actionStyle, "class": classBg, "text": tool.text }).inject(node);
                if (tool.id && tool.id !== "") {
                    action.set("id", tool.id);
                }
                if( o2.typeOf(tool.properties) === "object" && Object.keys(tool.properties).length )action.set(tool.properties);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var clickFun = function () {
                        var t = e.target.retrieve("tool");
                        e.setDisable = function () { };
                        if (t.actionScript) {
                            this._runCustomAction(t.actionScript);
                        } else {
                            if (this[t.action]) this[t.action](e);
                        }
                    }.bind(this);
                    if (tool.action === "processWork" || tool.id === "action_processWork" || tool.action === "flowWork" || tool.id === "action_flowWork") {
                        //输入法激活的时候，需要一段时间等待输入法关闭
                        window.setTimeout(clickFun, 100)
                    } else {
                        clickFun();
                    }
                }.bind(this));
                new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            }.bind(this));
        } else {
            //左边 间隔
            var dingdingSplitLeft = new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            var splitSize = dingdingSplitLeft.getSize();
            var size = document.body.getSize();
            var buttonWidth = (size.x - splitSize.x * 4 - 6) / 5;
            for (var i = 0; i < 3; i++) {
                tool = tools[i];
                var actionStyle = this.css.html5ActionButtonDingdingNormal;
                var classBg = "";
                if (tool.action === "processWork" || tool.action === "flowWork" || tool.action === "retractWork") {
                    actionStyle = this.css.html5ActionButtonDingdingPrimary;
                    classBg = "mainColor_bg mainColor_border";
                } else if (tool.action === "deleteWork") {
                    actionStyle = this.css.html5ActionButtonDingdingDanger;
                }
                if (i == 2) {
                    this.css.html5ActionButtonDingdingMore.width = buttonWidth + "px";
                    var action = new Element("div", { "styles": this.css.html5ActionButtonDingdingMore, "text": "…"}).inject(node);
                    action.addEvent("click", function (e) {
                        this._loadMoreMobileActionsDingdingStyle(tools, 2, node);
                    }.bind(this));
                } else {
                    actionStyle.width = (buttonWidth * 2) + "px";
                    var action = new Element("div", { "styles": actionStyle, "class": classBg, "text": tool.text }).inject(node);
                    if (tool.id && tool.id !== "") {
                        action.set("id", tool.id);
                    }
                    if( o2.typeOf(tool.properties) === "object" && Object.keys(tool.properties).length )action.set(tool.properties);
                    action.store("tool", tool);
                    action.addEvent("click", function (e) {
                        var t = e.target.retrieve("tool");
                        e.setDisable = function () { }
                        if (t.actionScript) {
                            this._runCustomAction(t.actionScript);
                        } else {
                            if (this[t.action]) this[t.action](e);
                        }
                    }.bind(this));
                }
                new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            }
        }
    },
    _loadMoreMobileActionsDingdingStyle: function (tools, n, node) {
        document.body.mask({
            "style": {
                "background-color": "#cccccc",
                "opacity": 0.6,
                "z-index": 300
            },
            "hideOnClick": true,
            "onHide": function () {
                this.actionMoreArea.style.scale = '1 0';
                this.actionMoreArea.style.opacity = '0';
                // this.actionMoreArea.setStyle("display", "none");
            }.bind(this)
        });
        if (this.actionMoreArea) {
            this.actionMoreArea.setStyle("display", "block");
            this.actionMoreArea.style.scale = '1 1';
            this.actionMoreArea.style.opacity = '1';
        } else {
            var size = document.body.getSize();
            this.actionMoreArea = new Element("div.mobileMoreArea", { "styles": this.css.html5ActionOtherArea }).inject(document.body);
            var pl = this.actionMoreArea.getStyle("padding-left").toInt();
            var pr = this.actionMoreArea.getStyle("padding-right").toInt();
            var w = size.x - pl - pr;
            this.actionMoreArea.setStyle("width", "" + w + "px");
            this.actionMoreArea.style.transition = "scale 0.2s, opacity 0.2s";
            this.actionMoreArea.style.scale = '1 0';
            this.actionMoreArea.style.opacity = '0';
            this.actionMoreArea.style.transformOrigin = 'bottom center';

            requestAnimationFrame(function () {
                this.actionMoreArea.style.scale = '1 1';
                this.actionMoreArea.style.opacity = '1';
            }.bind(this));

            for (var i = n; i < tools.length; i++) {
                tool = tools[i];
                var actionStyle = this.css.html5ActionButtonDingdingNormal;
                if (tool.action === "processWork" || tool.action === "flowWork" || tool.action === "retractWork") {
                    actionStyle = this.css.html5ActionButtonDingdingPrimary;
                } else if (tool.action === "deleteWork") {
                    actionStyle = this.css.html5ActionButtonDingdingDanger;
                }
                actionStyle.width = "100%";
                var action = new Element("div", { "styles": actionStyle, "text": tool.text }).inject(this.actionMoreArea);
                if (tool.id && tool.id !== "") {
                    action.set("id", tool.id);
                }
                if( o2.typeOf(tool.properties) === "object" && Object.keys(tool.properties).length )action.set(tool.properties);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                    // 关闭
                    if (this.actionMoreArea) {
                        this.actionMoreArea.setStyle("display", "none");
                        document.body.unmask();
                    }
                }.bind(this));
            }
        }
    },

    _createMobileActions: function (node, tools) {
        node.show();
        var count = tools.length;
        if (count <= 2) {
            this.css.html5ActionButton.width = "100%";
            if (count == 2) this.css.html5ActionButton.width = "49%";
            tools.each(function (tool) {
                var action = new Element("div", { "styles": this.css.html5ActionButton, "class": "mainColor_color", "text": tool.text }).inject(node);
                if (tool.id && tool.id !== "") {
                    action.set("id", tool.id);
                }
                if( o2.typeOf(tool.properties) === "object" && Object.keys(tool.properties).length )action.set(tool.properties);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                }.bind(this));
                this._setMobileBottonStyle(action);
            }.bind(this));
            if (count == 2) new Element("div", { "styles": this.css.html5ActionButtonSplit }).inject(node.getLast(), "before");
        } else {
            this.css.html5ActionButton.width = "38%"
            for (var i = 0; i < 2; i++) {
                tool = tools[i];
                var action = new Element("div", { "styles": this.css.html5ActionButton, "class": "mainColor_color", "text": tool.text }).inject(node);
                if (tool.id && tool.id !== "") {
                    action.set("id", tool.id);
                }
                if( o2.typeOf(tool.properties) === "object" && Object.keys(tool.properties).length )action.set(tool.properties);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                }.bind(this));
                this._setMobileBottonStyle(action);
            }
            new Element("div", { "styles": this.css.html5ActionButtonSplit }).inject(node.getLast(), "before");
            new Element("div", { "styles": this.css.html5ActionButtonSplit }).inject(node);
            this.css.html5ActionButton.width = "23%"
            var action = new Element("div", { "styles": this.css.html5ActionButton, "class": "mainColor_color", "text": "…" }).inject(node);
            action.addEvent("click", function (e) {
                this._loadMoreMobileActions(tools, 2, node);
            }.bind(this));
            this._setMobileBottonStyle(action);
        }
    },
    _loadMoreMobileActions: function (tools, n, node) {
        document.body.mask({
            "style": {
                "background-color": "#cccccc",
                "opacity": 0.6
            },
            "hideOnClick": true,
            "onHide": function () {
                this.actionMoreArea.setStyle("display", "none");
            }.bind(this)
        });
        if (this.actionMoreArea) {
            this.actionMoreArea.setStyle("display", "block");
        } else {

            var size = document.body.getSize();
            this.actionMoreArea = new Element("div", { "styles": this.css.html5ActionOtherArea }).inject(document.body);
            var pl = this.actionMoreArea.getStyle("padding-left").toInt();
            var pr = this.actionMoreArea.getStyle("padding-right").toInt();
            var w = size.x - pl - pr;
            this.actionMoreArea.setStyle("width", "" + w + "px");
            for (var i = n; i < tools.length; i++) {
                tool = tools[i];
                var action = new Element("div", { "styles": this.css.html5ActionOtherButton, "class": "mainColor_color", "text": tool.text }).inject(this.actionMoreArea);
                if (tool.id && tool.id !== "") {
                    action.set("id", tool.id);
                }
                if( o2.typeOf(tool.properties) === "object" && Object.keys(tool.properties).length )action.set(tool.properties);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                     // 关闭
                     if (this.actionMoreArea) {
                        this.actionMoreArea.setStyle("display", "none");
                        document.body.unmask();
                    }
                }.bind(this));
                this._setMobileBottonStyle(action);
            }
        }

        // actionArea.position({
        //     relativeTo: node,
        //     position: 'topCenter',
        //     edge: 'bottomCenter'
        // });
    },
    _setMobileBottonStyle: function (action) {
        var _self = this;
        action.addEvents({
            "mouseover": function (e) { this.setStyles(_self.css.html5ActionButton_over) },
            "mouseout": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "mousedown": function (e) { this.setStyles(_self.css.html5ActionButton_over) },
            "mouseup": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "touchstart": function (e) { this.setStyles(_self.css.html5ActionButton_over) },
            "touchcancel": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "touchend": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "touchmove": function (e) { this.setStyles(_self.css.html5ActionButton_over) }
        });
    },
    _runCustomAction: function (actionScript) {
        //var script = bt.node.retrieve("script");
        this.Macro.exec(actionScript, this);
    },
    _checkCustomMobileActionItem: function (tool, readonly) {
        var flag = true;
        if (readonly) {
            flag = tool.readShow;
        } else {
            flag = tool.editShow;
        }
        if (flag) {
            flag = true;
            if (tool.control) {
                flag = this.form.businessData.control[tool.control]
            }
            if (tool.condition) {
                var hideFlag = this.Macro.exec(tool.condition, this);
                flag = !hideFlag;
            }
        }
        return flag;
    },
    _checkDefaultMobileActionItem: function (tool, readonly, noCondition) {
        var flag = true;
        if (tool.control) {
            flag = this.businessData.control[tool.control]
        }
        if (!noCondition) if (tool.condition) {
            var hideFlag = this.Macro.exec(tool.condition, this);
            flag = flag && (!hideFlag);
        }
        if (tool.id == "action_processWork" || tool.id == "action_flowWork") {
            if (this.businessData.work.startTime) { // 正常模式
                if (!this.businessData.task || !this.businessData.work || !this.businessData.work.startTime) {
                    flag = false;
                }
            } else { // 草稿模式
                if (!this.businessData.work) {
                    flag = false;
                }
            }
        }
        if (tool.id == "action_rollback") tool.read = true;
        if (readonly) if (!tool.read) flag = false;
        return flag;
    },
    _loadBusinessData: function () {
        if (!this.businessData) {
            this.businessData = {};
            // this.businessData = {
            //     "data": {
            //         "select": "222",
            //         "radio": "bbb",
            //         "checkbox": ["check1", "check3"],
            //         "orderData": [
            //             {
            //                 "orderName": {"namefield": "电脑"},
            //                 "orderCount": {"countField": "3"},
            //                 "priceCount": {"priceField": "9000"}
            //             },
            //             {
            //                 "orderName": {"namefield": "路由器"},
            //                 "orderCount": {"countField": "2"},
            //                 "priceCount": {"priceField": "1000"}
            //             },
            //             {
            //                 "orderName": {"namefield": "网线"},
            //                 "orderCount": {"countField": "10"},
            //                 "priceCount": {"priceField": "200"}
            //             }
            //         ]
            //
            //     }
            // };
        }
    },

    _loadHtml: function () {
        // this.container.set("html", this.html);
        // this.node = this.container.getFirst();
        //this.node.setStyle("overflow", "hidden");
        this.node.addEvent("selectstart", function (e) {
            var select = "text";
            if (e.target.getStyle("-webkit-user-select")) {
                select = e.target.getStyle("-webkit-user-select").toString().toLowerCase();
            }

            if (select !== "text" && select !== "auto") e.preventDefault();
        });
    },

    _loadForm: function () {
        this._loadStyles();
        this._loadCssLinks();
        this._loadScriptSrc();
        this._loadJsheader();
        //this._loadEvents();
    },
    _loadStyles: function () {
        if (this.json.styles) Object.each(this.json.styles, function (value, key) {
            if ((value.indexOf("x_processplatform_assemble_surface") != -1 || value.indexOf("x_portal_assemble_surface") != -1) && !value.includes("../")) {
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (value.indexOf("/x_processplatform_assemble_surface") !== -1 && value.indexOf(host1) === -1) {
                    value = value.replace("/x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                } else if (value.indexOf("x_processplatform_assemble_surface") !== -1 && value.indexOf(host1) === -1) {
                    value = value.replace("x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface") !== -1 && value.indexOf(host2) === -1) {
                    value = value.replace("/x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                } else if (value.indexOf("x_portal_assemble_surface") !== -1 && value.indexOf(host2) === -1) {
                    value = value.replace("x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                }
            }
            value = o2.filterUrl(value);
            this.node.setStyle(key, value);

        }.bind(this));
        //this.node.setStyles(this.json.styles);
    },
    _loadCssLinks: function () {
        var urls = this.json.cssLinks;
        urls.each(function (url) {
            new Element("link", {
                "rel": "stylesheet",
                "type": "text/css",
                "href": url
            }).inject($(document.head));
        });
    },
    _loadScriptSrc: function () {
        var urls = this.json.scriptSrc;
        urls.each(function (url) {
            new Element("script", {
                "src": url
            }).inject($(document.head));
        });
    },
    _loadJsheader: function () {
        var code = (this.json.jsheader) ? this.json.jsheader.code : "";
        if (code) Browser.exec(code);
    },
    _loadEvents: function () {
        Object.each(this.json.events, function (e, key) {
            if (e.code) {
                if (this.options.moduleEvents.indexOf(key) !== -1) {
                    this.addEvent(key, function (event) {
                        return this.Macro.fire(e.code, this, event);
                    }.bind(this));
                } else {
                    if (key === "load") {
                        this.addEvent("postLoad", function () {
                            return this.Macro.fire(e.code, this);
                        }.bind(this));
                    } else if (key === "submit") {
                        this.addEvent("beforeProcess", function () {
                            return this.Macro.fire(e.code, this);
                        }.bind(this));
                    } else {
                        this.node.addEvent(key, function (event) {
                            return this.Macro.fire(e.code, this, event);
                        }.bind(this));
                    }
                }
            }
        }.bind(this));
    },
    addModuleEvent: function (key, fun) {
        if (this.options.moduleEvents.indexOf(key) !== -1) {
            this.addEvent(key, function (event) {
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        } else {
            if (key === "load") {
                this.addEvent("postLoad", function (event) {
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            } else if (key === "submit") {
                this.addEvent("beforeProcess", function (event) {
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            } else {
                this.node.addEvent(key, function (event) {
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            }
        }
    },

    _getDomjson: function (dom) {
        var mwfType = dom.get("MWFtype") || dom.get("mwftype");
        switch (mwfType) {
            case "form":
                return this.json;
            case "":
                return null;
            default:
                var id = dom.get("id");
                if (!id) id = dom.get("MWFId");
                if (id) {
                    return this.json.moduleList[id];
                } else {
                    return null;
                }
        }
    },
    _getModuleNodes: function (dom, dollarFlag ) {
        var moduleNodes = [];
        var subDom = dom.getFirst();
        while (subDom) {
            var mwftype = subDom.get("MWFtype") || subDom.get("mwftype");
            if (mwftype) {
                var type = mwftype;
                if (type.indexOf("$") === -1 || dollarFlag===true) {
                    moduleNodes.push(subDom);
                }
                // && mwftype !== "tab$Content"
                if (mwftype !== "datagrid" && mwftype !== "datatable" && mwftype !== "subSource" && mwftype !== "tab$Content" && mwftype !== "datatemplate") {
                    moduleNodes = moduleNodes.concat(this._getModuleNodes(subDom, dollarFlag));
                }
            } else {
                moduleNodes = moduleNodes.concat(this._getModuleNodes(subDom, dollarFlag));
            }
            subDom = subDom.getNext();
        }
        return moduleNodes;
    },

    _loadModules: function (dom, beforeLoadModule, replace, callback) {
        var moduleNodes = this._getModuleNodes(dom);
        var modules = [], jsons = [];

        moduleNodes.each(function (node) {
            var json = this._getDomjson(node);
            jsons.push( json );

            var module = this._loadModule(json, node, beforeLoadModule, replace);
            this.modules.push(module);
            modules.push( module );
        }.bind(this));
        if( callback )callback( moduleNodes, jsons, modules )
    },
    _loadModule: function (json, node, beforeLoad, replace) {
        if( !json )return null;
        //console.log( json.id );
        if (json.type === "Subform" || json.moduleName === "subform") this.subformCount++;
        //if( json.type === "Subform" || json.moduleName === "subform" ){
        //    console.log( "add subformcount ， this.subformCount = " + this.subformCount );
        //}
        if (json.type === "Subpage" || json.moduleName === "subpage") this.subpageCount++;
        if (json.type === "Widget" || json.moduleName === "widget") this.widgetCount++;
        if (!MWF["APP" + json.type]) {
            var moduleType = json.type;
            if(moduleType === "AttachmentDg")moduleType = "Attachment";
            MWF.xDesktop.requireApp("process.Xform", moduleType, null, false);
        }
        var module = new MWF["APP" + json.type](node, json, this);
        if (beforeLoad) beforeLoad.apply(module);
        if (replace || !this.all[json.id]) this.all[json.id] = module;

        if (json.name) {
            if (this.allForName[json.name]) {
                var item = this.allForName[json.name];
                typeOf(item) === "array" ? item.push(module) : this.allForName[json.name] = [item, module];
            } else {
                this.allForName[json.name] = module;
            }
        }

        if (module.field) {
            if (replace || !this.forms[json.id]) this.forms[json.id] = module;
        }
        module.readonly = this.options.readonly;
        module.load();
        return module;
    },
    saveOpinion: function (module) {
        var op = module._getBusinessSectionDataByPerson();
        MWF.UD.getDataJson("userOpinion", function (json) {
            if (!json) json = [];
            var idx = json.indexOf(op);
            if (idx == -1) {
                if (json.length >= 50) json.shift();

            } else {
                json.splice(idx, 1);
            }
            json.push(op);
            MWF.UD.putData("userOpinion", json);
        }.bind(this), false);
    },
    loadPathData: function (path) {
        var data = null;
        this.workAction.getJobDataByPath(this.businessData.work.job, path, function (json) {
            data = json.data || null;
        }, null, false);
        return data;
    },
    /**
     * @summary 获取表单的所有数据.
     * @example
     * var data = this.form.getApp().appForm.getData();
     * @return {Object}
     */
    getData: function (issubmit) {
        //var data = Object.clone(this.businessData.data);
        var data = this.businessData.data;
        Object.each(this.forms, function (module, id) {

            if (!module.isEditable) return;

            //对id类似于 xx..0..xx 的字段 不处理
            if( id.indexOf("..") > 0 )return;

            if (module.json.type === "Opinion") {

                if (issubmit) {
                    this.saveOpinion(module);

                    var key = layout.desktop.session.user.id;
                    if (typeOf(data[id]) === "object" && typeOf(data[id][key]) === "string") {
                        data[id][key] = "";
                    } else if (typeOf(data[id]) === "string") {
                        data[id] = "";
                    }
                    // delete data[id];
                } else {
                    var v = module.getData();
                    // var d = this.loadPathData(id);
                    // if (d) data[id] = d;
                    data[id] = this.getSectionDataByPerson(v, data[id]);
                }
            } else {
                if (module.json.section === "yes") {
                    //     var d = this.loadPathData(id);
                    //     if (d) data[id] = d;
                    var v = this.getSectionData(module, data[id]);
                    //if (o2.typeOf(v)==="string") v = o2.txt(v);
                    data[id] = v
                } else {
                    if (module.fieldModuleLoaded!==false && module.readonly!==true){
                        var v = module.getData();
                        //if (o2.typeOf(v)==="string") v = o2.txt(v);
                        data[id] = v;
                    }
                }
            }
        }.bind(this));
        this.fireEvent("getData", [data]);
        this.businessData.data = data;
        this.Macro.environment.setData(this.businessData.data);
        return data;
    },
    getSectionData: function (module, obj) {
        var v = module.getData();
        switch (module.json.sectionBy) {
            case "person":
                return this.getSectionDataByPerson(v, obj);
            case "unit":
                return this.getSectionDataByUnit(v, obj);
            case "activity":
                return this.getSectionDataByPActivity(v, obj);
            case "splitValue":
                return this.getSectionDataBySplitValue(v, obj);
            case "script":
                return this.getSectionDataByScript(module.json.sectionByScript.code, v, obj);
            default:
                return v;
        }
    },
    getSectionDataByPerson: function (v, obj) {
        var key = layout.desktop.session.user.id;
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        obj[key] = v;
        return obj;
    },
    getSectionDataByUnit: function (v, obj) {
        var key = (this.businessData.task) ? (this.businessData.task.unitDn || this.businessData.task.unit) : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },
    getSectionDataByPActivity: function (v, obj) {
        var key = (this.businessData.work) ? this.businessData.work.activity : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },
    getSectionDataBySplitValue: function (v, obj) {
        var key = (this.businessData.work) ? this.businessData.work.splitValue : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },

    getSectionDataByScript: function (code, v, obj) {
        var key = this.Macro.exec(code, this);
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },

    setSection: function (json, data) {
        var obj = data[json.name];
        switch (json.sectionBy) {
            case "person":
                return this.setSectionByPerson(obj, json.name);
            case "unit":
                return this.setSectionByUnit(obj, json.name);
            case "activity":
                return this.setSectionByPActivity(obj, json.name);
            case "splitValue":
                return this.setSectionBySplitValue(obj, json.name);
            case "script":
                return this.setSectionByScript(json.sectionByScript.code, obj, json.name);
            default:
                return v;
        }
    },
    setSectionByPerson: function (obj, name) {
        var key = layout.desktop.session.user.id;
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        //obj[key] = v;
        this.sectionListObj[name] = key;
        return obj;
    },
    setSectionByUnit: function (obj, name) {
        var key = (this.businessData.task) ? (this.businessData.task.unitDn || this.businessData.task.unit) : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },
    setSectionByPActivity: function (obj, name) {
        var key = (this.businessData.work) ? this.businessData.work.activity : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },
    setSectionBySplitValue: function (obj, name) {
        var key = (this.businessData.work) ? this.businessData.work.splitValue : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },

    setSectionByScript: function (code, obj, name) {
        var key = this.Macro.exec(code, this);
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },
    saveWork: function (callback, silent) {

        if( this.disallowSaving )return;

        if (this.businessData.control["allowSave"]) {

            if (!this.formSaveValidation()) {
                if (callback) callback();
                return false;
            }

            this.fireEvent("beforeSave");
            this.fireEvent("beforeSaveWork");

            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeSave");
            this.saveFormData(function (json) {
                if (this.app && !silent) this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved, "success");
                if (callback && typeOf(callback) === "function") callback(json);
                this.fireEvent("afterSave");
                this.fireEvent("afterSaveWork");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterSave");
            }.bind(this));

        } else {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            //if (failure) failure(null, "Permission Denied", "");
        }
    },

    getSectionList: function () {
        return Object.keys(this.sectionListObj).map(function (p) {
            var o = { "path": p };
            if (this.sectionListObj[p]) o.key = this.sectionListObj[p];
            return o;
        }.bind(this));
    },


    setModifedDataByPathList: function (data, pathList) {
        var d = this.modifedData;
        for (var i = 0; i < pathList.length; i++) {
            if (i === pathList.length - 1) {
                d[pathList[i]] = data;
            } else {
                if (typeOf(d[pathList[i]]) === "object" || typeOf(d[pathList[i]]) === "array") {
                    d = d[pathList[i]]
                } else if (typeOf(pathList[i]) === "number") {
                    d = d[pathList[i]] = [];
                } else {
                    d = d[pathList[i]] = {};
                }
            }
        }
    },
    getOrigianlPathData: function (pathList) {
        var d = this.businessData.originalData;
        for (var i = 0; i < pathList.length; i++) {
            if (i === pathList.length - 1) {
                d = d[pathList[i]];
            } else {
                if (typeOf(d[pathList[i]]) === "object" || typeOf(d[pathList[i]]) === "array") {
                    d = d[pathList[i]];
                } else {
                    return null;
                }
            }
        }
        return d;
    },
    setModifedData: function (data, pathList) {
        pathList = pathList || [];
        if (typeOf(data) === "object") {
            for (var key in data) {
                //if (key.substring(0,2)!=="__"){
                var pList = Array.clone(pathList);
                pList.push(key);
                this.setModifedData(data[key], pList);
                //}
            }
        } else if (typeOf(data) === "array") {
            var od = this.getOrigianlPathData(pathList);
            // if (typeOf(od) !== "array" || od.length !== data.length || JSON.stringify(od) !== JSON.stringify(data)) {
            if (typeOf(od) !== "array" || od.length !== data.length || !this.compareObjects( od, data ) ) {
                this.setModifedDataByPathList(data, pathList);
            }
            //}else{
            //    for( var i=0; i<data.length; i++ ){
            //        this.setModifedData(data[i], pathList.push(i));
            //    }
            //}
        } else if (typeOf(data) !== "null") { //后台对null是忽略处理的，认为值没有变化
            var od = this.getOrigianlPathData(pathList);
            if (typeOf(data) !== typeOf(od) || data !== od) {
                this.setModifedDataByPathList(data, pathList);
            }
        }
    },
    compareObjects: function(o, p, deep){
        if( !deep )deep = 0;
        if( deep > 15 )return false; //最大层数，避免相互嵌套
        var type1 = typeOf( o ), type2 = typeOf( p );
        if( type1 !== type2 )return false;

        if( type1 === "object" ){
            for( var k in o ){
                if( o[k] === null || o[k] === undefined )delete o[k]
            }
            for( var k in p ){
                if( p[k] === null || p[k] === undefined )delete p[k]
            }
        }
        switch (type1) {
            case "object":
            case "array":
                var i, keysO = Object.keys(o), keysP = Object.keys(p);
                if (keysO.length !== keysP.length){
                    return false;
                }
                keysO.sort();
                keysP.sort();
                deep++;
                for ( i=0; i<keysO.length; i++ ){
                    var key = keysO[i];
                    if( type1 === "array" )key = key.toInt();
                    var valueO = o[key], valueP = p[key];
                    if( this.compareObjects( valueO, valueP, deep ) === false ){
                        return false;
                    }
                }
                break;
            case "function":
               break;
            default:
                if  (o!==p){
                    return false;
                }
        }
        return true;
    },

    saveFormData: function (callback, failure, history, data, issubmit, isstart) {
        if (this.businessData.work.startTime) {
            this.saveFormDataInstance(callback, failure, history, data, issubmit);
        } else {
            this.saveFormDataDraft(callback, failure, history, data, issubmit, isstart);
        }
    },
    saveFormDataInstance: function (callback, failure, history, data, issubmit) {
        this.saving = true;
        if (this.officeList) {
            this.officeList.each(function (module) {
                module.save(history);
            });
        }
        var data = data || this.getData(issubmit);

        this.modifedData = {};
        this.setModifedData(data);

        if (this.toWordSaveList && this.toWordSaveList.length){
            var p = [];
            this.toWordSaveList.each(function(editor){
                if (editor.docToWord) p.push(new Promise(function(resolve){ editor.docToWord(resolve) }));
            });
            var copyData = Object.clone(data);
            Promise.all(p).then(function(){
                this.workAction.saveData(function () {
                    this.businessData.originalData = null;
                    this.businessData.originalData = copyData;
                    if(callback)callback();
                    this.saving = false;
                }.bind(this), failure, this.businessData.work.id, this.modifedData);
            }.bind(this));
        }else{
            var copyData = Object.clone(data);
            this.workAction.saveData(function () {
                this.businessData.originalData = null;
                this.businessData.originalData = copyData;
                if(callback)callback();
            }.bind(this), failure, this.businessData.work.id, this.modifedData);
        }
    },
    saveFormDataDraft: function (callback, failure, history, data, issubmit, isstart) {
        this.saving = true;
        if (this.officeList) {
            this.officeList.each(function (module) {
                module.save(history);
            });
        }
        var data = data || this.getData(issubmit);
        var draft = {
            "data": data,
            "work": this.businessData.work,
            "identity": this.businessData.work.creatorIdentityDn
        }
        var copyData = Object.clone(data);
        this.workAction.saveDraft(draft, function (json) {

            this.businessData.originalData = null;
            this.businessData.originalData = copyData;

            this.workAction.getDraft(json.data.id, function (json) {
                this.businessData.work = json.data.work;
                this.app.options.draftId = json.data.work.id;

                if (layout.app && layout.app.inBrowser) {
                    if (layout.app) layout.app.$openWithSelf = true;
                    if (callback) callback();
                    this.saving = false;
                    if (!isstart) layout.desktop.openApplication(null, "process.Work", { "draftId": this.app.options.draftId });
                } else {
                    this.app.options.desktopReload = true;

                    this.app.appId = "process.Work" + json.data.work.id;
                    if (layout.desktop.apps) {
                        delete layout.desktop.apps[this.app.options.appId];
                    } else {
                        layout.desktop.apps = {};
                    }
                    layout.desktop.apps[this.app.appId] = this.app;

                    if (callback) callback();
                    this.saving = false;

                    if (!isstart) this.app.reload();
                }

            }.bind(this));
        }.bind(this), failure);
    },
    setProcessorSectionOrgList: function (data) {
        if (!this.routeDataList) this.getRouteDataList();
        var routeList = this.routeDataList;
        //var processorSectionOrg = [];
        for (var i = 0; i < routeList.length; i++) {
            (routeList[i].selectConfigList || []).each(function (config, j) {
                if (config.section == "yes") {
                    this.setSection(config, data);
                }
            }.bind(this))
        }
    },

    /**
     * @summary 获取当前工作的路由配置数据.
     * @example
     * this.form.getApp().appForm.getRouteDataList();
     * @return {Object[]}
     */
    getRouteDataList: function () {
        if (!this.routeDataList) {
            o2.Actions.get("x_processplatform_assemble_surface").listRoute({ "valueList": this.businessData.task.routeList }, function (json) {
                json.data.each(function (d) {
                    d.selectConfigList = JSON.parse(d.selectConfig || "[]");
                }.bind(this));
                this.routeDataList = json.data;
            }.bind(this), null, false);
        }
        return this.routeDataList;
    },

    beforeCloseWork: function () {
        this.fireEvent("beforeClose");
        if (this.app && this.app.fireEvent) {
            this.app.fireEvent("beforeClose");
            //    this.fireEvent("afterClose");
        }
        if (!this.options.readonly) {
            if (this.businessData.work && this.businessData.work.id) {
                if (!this.isSendBeacon) {
                    if (this.app.inBrowser && navigator.sendBeacon) {
                        var obj = this.workAction.action.actions["checkDraft"];
                        var url = this.workAction.action.address + obj.uri;
                        url = url.replace("{id}", this.businessData.work.id);
                        navigator.sendBeacon(url);
                    } else {
                        this.workAction.checkDraft(this.businessData.work.id, function () {
                            if (layout.desktop.apps) {
                                if (layout.desktop.apps["TaskCenter"] && layout.desktop.apps["TaskCenter"].window) {
                                    layout.desktop.apps["TaskCenter"].content.unmask();
                                    layout.desktop.apps["TaskCenter"].refreshAll();
                                }
                            }
                        }.bind(this), null, false);
                    }
                    this.isSendBeacon = true;
                }
            }
        } else {
            this.app.refreshTaskCenter();
        }
    },
    closeWork: function () {
        // this.fireEvent("beforeClose");
        // if (this.app && this.app.fireEvent){
        //     this.app.fireEvent("beforeClose");
        // //    this.fireEvent("afterClose");
        // }
        // if (!this.options.readonly)
        //     if (this.businessData.work) this.workAction.checkDraft(this.businessData.work.id);

        // this.app.close();

        if (layout.mobile) {
            //移动端页面关闭
            this.finishOnMobileReal();
        } else {
            this.app.close();
        }

    },
    getMessageContent: function (data, maxLength, titlelp) {
        var content = "";
        if (data.completed) {
            content += MWF.xApplication.process.Xform.LP.workCompleted;
        } else {
            if (data.occurSignalStack) {
                if (data.signalStack && data.signalStack.length) {
                    var activityUsers = [];
                    data.signalStack.each(function (stack) {
                        var idList = [];
                        if (stack.splitExecute) {
                            idList = stack.splitExecute.splitValueList || [];
                        }
                        if (stack.manualExecute) {
                            idList = stack.manualExecute.identities || [];
                        }
                        var count = 0;
                        var ids = [];
                        idList.each( function(i){
                            var cn = o2.name.cn(i);
                            if( !ids.contains( cn ) ){
                                ids.push(cn)
                            }
                        });
                        if (ids.length > 8) {
                            count = ids.length;
                            ids = ids.slice(0, 8);
                        }
                        ids = o2.name.cns(ids);
                        var lp = MWF.xApplication.process.Xform.LP;
                        var t = "<b>" + lp.nextActivity + "</b><span style='color: #ea621f'>" + stack.name + "</span>；<b>" + lp.nextUser + "</b><span style='color: #ea621f'>" + ids.join(",") + "</span> <b>" + ((count) ? "," + lp.next_etc.replace("{count}", count) : "") + "</b>";
                        activityUsers.push(t);
                    }.bind(this));
                    content += activityUsers.join("<br>");
                } else {
                    content += MWF.xApplication.process.Xform.LP.taskCompleted;
                }
            } else {
                if (data.properties.nextManualList && data.properties.nextManualList.length) {
                    var activityUsers = [];
                    data.properties.nextManualList.each(function (a) {
                        var ids = [];
                        a.taskIdentityList.each(function (i) {
                            var cn = o2.name.cn(i);
                            if( !ids.contains( cn ) ){
                                ids.push(cn)
                            }
                        });
                        var t = "<b>" + MWF.xApplication.process.Xform.LP.nextActivity + "</b><span style='color: #ea621f'>" + o2.txt(a.activityName) + "</span>；<b>" + MWF.xApplication.process.Xform.LP.nextUser + "</b><span style='color: #ea621f'>" + ids.join(",") + "</span>";
                        activityUsers.push(t);
                    });
                    content += activityUsers.join("<br>");

                    if (data.manualTaskIdentityMatrix && data.manualTaskIdentityMatrix.matrix){
                        var manualTaskIdentityMatrix = data.manualTaskIdentityMatrix.matrix;
                        manualTaskIdentityMatrix = (manualTaskIdentityMatrix.flat) ? manualTaskIdentityMatrix.flat() :  manualTaskIdentityMatrix.reduce(function(acc, val){
                            return acc.concat(val);
                        }, []);
                        manualTaskIdentityMatrix = manualTaskIdentityMatrix.filter(function(id){
                            return !data.properties.nextManualTaskIdentityList.contains(id);
                        });
                        var len = manualTaskIdentityMatrix.length
                        if (len){
                            var idText = (len>8) ? o2.name.cns(manualTaskIdentityMatrix.slice(0.8)).join(", ")+" ..." : o2.name.cns(manualTaskIdentityMatrix).join(", ");
                            content += "<br><b>"+MWF.xApplication.process.Xform.LP.nextTaskMatrix+"</b><span style='color: #ea621f'>"+idText+ "</span>";
                        }
                    }

                } else {
                    if (data.arrivedActivityName) {
                        content += MWF.xApplication.process.Xform.LP.arrivedActivity + o2.txt(data.arrivedActivityName);
                    } else {
                        content += MWF.xApplication.process.Xform.LP.taskCompleted;
                    }

                }
            }
        }
        var title = this.businessData.data.title || this.businessData.data.subject || this.businessData.work.title
        if (maxLength && title.length > maxLength) {
            title = title.substr(0, maxLength) + "..."
        }
        return "<div>" + (titlelp || MWF.xApplication.process.Xform.LP.taskProcessedMessage) + "“" + o2.txt(title) + "”</div>" + content;
    },
    addMessage: function (data, notShowBrowserDkg) {
        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.taskProcessed,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.taskProcessedMessage)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser && !notShowBrowserDkg) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.taskProcessedMessage));
            }
        }
    },
    getCurrentRouteAlias: function (){
        if( this.flow && this.flow.currentAction === 'process'){
            var processor = this.flow.processor;
            if( processor && processor.routeRadio  ){
                return processor.routeRadio.getData().data.alias;
            }
        }
        return null;
    },
    formSaveValidation: function(){
        var flag = true;
        Object.each(this.forms, function (field, key) {
            if( !field.json.id || field.json.id.indexOf("..") > 0 )return;
            field.validationMode();
            if (!field.saveValidation()) flag = false;
        }.bind(this));
        return flag;
    },
    formValidation: function (routeName, opinion, medias) {
        if (this.options.readonly) return true;
        this.Macro.environment.form.currentRouteAlias = this.getCurrentRouteAlias();
        this.Macro.environment.form.currentRouteName = routeName;
        this.Macro.environment.form.opinion = opinion;
        this.Macro.environment.form.medias = medias;

        var flag = true;
        //flag = this.validation();
        Object.each(this.forms, function (field, key) {
            field.validationMode();
            if (!field.validation(routeName, opinion, medias)) flag = false;
        }.bind(this));
        return flag;
    },
    validationOtherFlow: function (routeName, opinion, processor, flowData) {
        this.Macro.environment.form.currentRouteAlias = null;
        this.Macro.environment.form.currentRouteName = routeName;
        this.Macro.environment.form.opinion = opinion;
        this.Macro.environment.form.flowData = flowData;
        if (!this.json.validationOtherFlow) return true;
        if (!this.json.validationOtherFlow.code) return true;
        var flag = this.Macro.exec(this.json.validationOtherFlow.code, this);
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() !== "true") {
            MWF.xDesktop.notice(
                "error",
                (processor) ? { "x": "center", "y": "top" } : { "x": "right", "y": "top" },
                flag,
                (processor) ? processor.container : (layout.mobile ? $(document.body) : this.app.content),
                null,  //{"x": 0, "y": 30}
                { "closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000 }
            );
            return false;
        }
        return true;
    },
    validation: function (routeName, opinion, processor, medias) {
        this.Macro.environment.form.currentRouteAlias = this.getCurrentRouteAlias();
        this.Macro.environment.form.currentRouteName = routeName;
        this.Macro.environment.form.opinion = opinion;
        this.Macro.environment.form.medias = medias;
        var routeFlag = this.validationRoute(processor);
        var opinionFlag = this.validationOpinion(processor);
        return routeFlag && opinionFlag;
    },
    validationRoute: function (processor) {
        if (!this.json.validationRoute) return true;
        if (!this.json.validationRoute.code) return true;
        var flag = this.Macro.exec(this.json.validationRoute.code, this);
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() != "true") {
            this.notValidationRouteMode(flag, processor);
            return false;
        }
        return true;
    },
    validationOpinion: function (processor) {
        if (!this.json.validationOpinion) return true;
        if (!this.json.validationOpinion.code) return true;
        var flag = this.Macro.exec(this.json.validationOpinion.code, this);
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() != "true") {
            this.notValidationOpinionMode(flag, processor);
            return false;
        }
        return true;
    },
    formCustomValidation: function () {
        if (!this.json.validationFormCustom) return true;
        if (!this.json.validationFormCustom.code) return true;
        var flag = this.Macro.exec(this.json.validationFormCustom.code, this);
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() != "true") {
            this.notValidationOpinionMode(flag);
            return false;
        }
        return true;
    },
    notValidationRouteMode: function (flag, processor) {
        if (processor) {
            var node = (processor.routeSelectorArea || processor.routeWraper);
            if(node)node.setStyle("background-color", "#ffe9e9");
        }
        MWF.xDesktop.notice(
            "error",
            { "x": "center", "y": "top" },
            flag,
            (processor) ? processor.routeSelectorArea : (layout.mobile ? $(document.body) : this.app.content),
            null,  //{"x": 0, "y": 30}
            { "closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000 }
        );
        //new mBox.Notice({
        //    type: "error",
        //    position: {"x": "center", "y": "top"},
        //    move: false,
        //    target: (processor) ? processor.routeSelectorArea : this.app.content,
        //    delayClose: 6000,
        //    content: flag
        //});
    },
    notValidationOpinionMode: function (flag, processor) {
        if (processor) {
            var node = (processor.inputTextarea || processor.opinionTextarea);
            if(node)node.setStyle("background-color", "#ffe9e9");
        }
        MWF.xDesktop.notice(
            "error",
            (processor) ? { "x": "center", "y": "top" } : { "x": "right", "y": "top" },
            flag,
            (processor) ? processor.inputTextarea : (layout.mobile ? $(document.body) : this.app.content),
            null,  //{"x": 0, "y": 30}
            { "closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000 }
        );
        //new mBox.Notice({
        //    type: "error",
        //    position: (processor) ? {"x": "center", "y": "top"} : {"x": "right", "y": "top"},
        //    move: false,
        //    target: (processor) ? processor.inputTextarea : this.app.content,
        //    delayClose: 6000,
        //    content: flag
        //});
    },


    //fireRtEvent: function(type, args, delay){
    //    type = removeOn(type);
    //    var events = this.$events[type];
    //    if (!events) return this;
    //    if (!events.length) return this;
    //    var event = events[events.length-1];
    //    args = Array.from(args);
    //    if (delay) fn.delay(delay, this, args);
    //    else return fn.apply(this, args);
    //    return this;
    //},
    getIgnoreImpowerIdentity: function (processorOrgList) {

        var list = [];
        var check = function (org, isProcessOrg) {
            var moduleData = isProcessOrg ? org.getValue() : org.getData();
            var flag = false;
            if (typeOf(moduleData) === "array" && moduleData.length) {
                moduleData.each(function (d) {
                    if (d.ignoreEmpower) {
                        list.push(d.distinguishedName || d.unique || d.id);
                        d.ignoredEmpower = true;
                        delete d.ignoreEmpower;
                        flag = true;
                    }
                })
            }
            if (flag) org.setData(moduleData);
        }

        var modules = this.modules;
        for (var i = 0; i < modules.length; i++) {
            var module = modules[i];
            var moduleName = module.json.moduleName;
            if (!moduleName) moduleName = typeOf(module.json.type) === "string" ? module.json.type.toLowerCase() : "";
            if (moduleName === "org") {
                check(module)
            }
        }
        if (processorOrgList && processorOrgList.length > 0) {
            for (var i = 0; i < processorOrgList.length; i++) {
                check(processorOrgList[i], true)
            }
        }

        return list;
    },
    //saveDocumentEditor
    submitWork: function (routeName, opinion, medias, callback, processor, data, appendTaskIdentityList, processorOrgList, callbackBeforeSave) {
        if (!this.businessData.control["allowProcessing"] && !this.businessData.control["allowFlow"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            this.app.content.unmask();
            if (processor && processor.node) processor.node.unmask();
            return false;
        }

        if (!this.formValidation(routeName, opinion, medias)) {
            this.app.content.unmask();
            if (callback) callback();
            return false;
        }
        if (!this.validation(routeName, opinion, processor, medias)) {
            if (processor && processor.node) processor.node.unmask();
            if (callback) callback();
            return false;
        }
        if (!opinion) {
            var idx = this.businessData.task.routeNameList.indexOf(routeName);
            if (this.businessData.task.routeOpinionList[idx]) {
                opinion = this.businessData.task.routeOpinionList[idx];
            }
        }
        this.fireEvent("beforeProcess", {routeName: routeName, opinion: opinion});
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcess");

        //处理忽略授权
        var ignoreEmpowerIdentityList = this.getIgnoreImpowerIdentity(processorOrgList);

        var _self = this;
        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            // 适配移动端
            if (layout.mobile) {
                this.mask.load();
            } else {
                this.mask.loadNode(this.app.content);
            }
            if (callbackBeforeSave) callbackBeforeSave();
            this.fireEvent("beforeSave");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeSave");
            this.saveFormData(function (json) {
                this.businessData.task.routeName = routeName;
                this.businessData.task.opinion = opinion || "";

                // var mediaIds = [];
                // if (medias && medias.length) {
                //     medias.each(function (file, i) {
                //         var formData = new FormData();
                //         var fileName = "mediaOpinion_"+i+"_"+new Date().getTime();
                //         if( file.type && file.type.contains("/") ) {
                //             file.name = fileName + "." + file.type.split("/")[1];
                //         }else{
                //             file.name = fileName + ".unknow";
                //         }
                //
                //         formData.append("file", file, file.name);
                //         formData.append("site", "$mediaOpinion");
                //
                //
                //         this.workAction.uploadAttachment(this.businessData.work.id, formData, file, function (json) {
                //             mediaIds.push(json.data.id);
                //         }.bind(this), null, false);
                //     }.bind(this));
                // }
                // if (mediaIds.length) this.businessData.task.mediaOpinion = mediaIds.join(",");

                this.saveMedias(medias).then(function(){
                    if (appendTaskIdentityList && appendTaskIdentityList.length) {
                        var list = [];
                        appendTaskIdentityList.each(function (identity) {
                            if (typeOf(identity) === "object") {
                                list.push(identity.distinguishedName || identity.unique || identity.id)
                            } else {
                                list.push(identity);
                            }
                        }.bind(this));
                        this.businessData.task.appendTaskIdentityList = list;
                    }

                    this.businessData.task.ignoreEmpowerIdentityList = ignoreEmpowerIdentityList;

                    this.fireEvent("afterSave");
                    if (this.app && this.app.fireEvent) this.app.fireEvent("afterSave");

                    // var promiseList = [];
                    // if (this.documenteditorList && this.documenteditorList.length) {
                    //     var promiseList = [];
                    //     this.documenteditorList.each(function (module) {
                    //         promiseList.push(module.checkSaveNewHistroy());
                    //     });
                    // }
                    // Promise.all(promiseList).then(function(){
                    this.workAction.processTask(function (json) {
                        //if (processor) processor.destroy();
                        //if (processNode) processNode.destroy();
                        if (callback) callback(json);

                        this.taskList = json.data;
                        this.fireEvent("afterProcess", {routeName: routeName, opinion: opinion});
                        if (this.app && this.app.fireEvent) this.app.fireEvent("afterProcess");
                        //    this.notice(MWF.xApplication.process.Xform.LP.taskProcessed, "success");
                        this.addMessage(json.data, true);

                        if (this.app.taskObject) this.app.taskObject.destroy();

                        this.finishOnFlow("process", json.data);

                        //window.setTimeout(function(){this.app.close();}.bind(this), 2000);
                    }.bind(this), null, this.businessData.task.id, this.businessData.task);
                    // }.bind(this), function(){});

                }.bind(this));


            }.bind(this), null, true, data, true);

        }.bind(this));
    },

    saveMedias: function(medias){
        return new Promise(function(resolve){
            var mediaIds = [];

            if (medias && medias.length) {
                var mPs = [];
                medias.each(function (file, i) {
                    var formData = new FormData();
                    var fileName = "mediaOpinion_"+i+"_"+new Date().getTime();
                    if( file.type && file.type.contains("/") ) {
                        file.name = fileName + "." + file.type.split("/")[1];
                    }else{
                        file.name = fileName + ".unknow";
                    }

                    formData.append("file", file, file.name);
                    formData.append("site", "$mediaOpinion");

                    mPs.push(this.uploadMedia(formData, file).then(function(id){
                        mediaIds.push(id);
                    }));
                }.bind(this));

                Promise.all(mPs).then(function(){
                    if (mediaIds.length) this.businessData.task.mediaOpinion = mediaIds.join(",");
                    resolve();
                }.bind(this));
            }else{
                resolve();
            }
        }.bind(this))
    },
    uploadMedia(formData, file){
        return new Promise(function(resolve){
            this.workAction.uploadAttachment(this.businessData.work.id, formData, file, function(json){
                // mediaIds.push(json.data.id);
                resolve(json.data.id);
            }.bind(this))
        }.bind(this));
    },


    finishOnFlow: function(type, data, notCloseWindow){
        if (this.closeImmediatelyOnProcess && !notCloseWindow) {
            this.app.close();
        } else if (typeOf(this.showCustomSubmitedDialog) === "function") {
            this.showCustomSubmitedDialog(data);
        } else if (layout.mobile) {
            //移动端页面关闭
            this.finishOnMobile();
        } else {
            if (this.app.inBrowser) {
                if (this.mask) this.mask.hide();
                if (this.json.isPrompt !== false) {
                    switch (type) {
                        case "process":
                        case "goBack":
                            this.showSubmitedDialog(data);
                            break;
                        case "reset":
                            this.addResetMessage(data, notCloseWindow);
                            break;
                        case "addTask":
                            this.addAddTaskMessage(data, notCloseWindow);
                            break;
                    }
                } else {
                    if (this.json.afterProcessAction == "redirect" && this.json.afterProcessRedirectScript && this.json.afterProcessRedirectScript.code) {
                        var url = this.Macro.exec(this.json.afterProcessRedirectScript.code, this);
                        (new URI(url)).go();
                    } else {
                        // this.app.close();
                        this.dingTalkPcCloseOrAppClose();
                    }
                }
                //}

            } else {
                switch (type) {
                    // case "process":
                    //     this.showSubmitedDialog(data);
                    //     break;
                    case "reset":
                        this.addResetMessage(data, notCloseWindow);
                        break;
                    case "addTask":
                        this.addAddTaskMessage(data, notCloseWindow);
                        break;
                    case "goBack":
                        this.showSubmitedDialog(data, notCloseWindow);
                        break;
                }
                if( notCloseWindow ){
                    this.app.refresh();
                }else{
                    this.app.close();
                }
            }
        }
    },
    showSubmitedDialog: function (data) {
        var content = this.getMessageContent(data, this.json.submitedDlgStyle ? this.json.submitedDlgStyle.maxTitleLength : 60);
        //if( this.json.submitedDlgUseNotice ){
        //    MWF.xDesktop.notice("success", {x: "right", y:"top"}, content);
        //    if (this.json.isPrompt!==false){
        //        if (this.json.promptCloseTime!=0){
        //            var t = this.json.promptCloseTime || 2;
        //            t = t.toInt()*1000;
        //            var _work = this;
        //            window.setTimeout(function(){ _work.app.close();}, t);
        //        }
        //    }else{
        //        this.app.close();
        //    }
        //}else{
        var div = new Element("div", { "styles": { "margin": "10px 10px 0px 10px", "padding": "5px", "overflow": "hidden", "width": "270px" } }).inject(this.app.content);
        div.set("html", content);
        var timerNode = new Element("div", { "styles": { "margin-top": "5px" } }).inject(div);
        var options = {
            "content": div,
            "isTitle": false,
            "width": 350,
            "height": 180,
            "buttonList": [
                {
                    "text": this.app.lp.closePage,
                    "action": function () {
                        dlg.close();
                        if (this.json.afterProcessAction == "redirect" && this.json.afterProcessRedirectScript && this.json.afterProcessRedirectScript.code) {
                            var url = this.Macro.exec(this.json.afterProcessRedirectScript.code, this);
                            (new URI(url)).go();
                        } else {
                            // this.app.close();
                            this.dingTalkPcCloseOrAppClose();
                        }
                    }.bind(this)
                }
            ]
        };
        if (this.json.submitedDlgStyle) {
            options = Object.merge(options, this.json.submitedDlgStyle);
            if (this.json.submitedDlgStyle.contentStyle) {
                div.setStyles(this.json.submitedDlgStyle.contentStyle);
                delete options.contentStyle;
            }
        }
        var size = this.app.content.getSize();
        switch (options.promptPosition || this.json.promptPosition || "righttop") {
            case "lefttop":
                options.top = 10;
                options.left = 10;
                options.fromTop = 10;
                options.fromLeft = 10;
                break;
            case "righttop":
                options.top = 10;
                options.left = size.x - options.width - 10;
                options.fromTop = 10;
                options.fromLeft = size.x - 10;
                break;
            case "leftbottom":
                options.top = size.y - options.height - 10;
                options.left = 10;
                options.fromTop = size.y - 10;
                options.fromLeft = 10;
                break;
            case "rightbottom":
                options.top = size.y - options.height - 10;
                options.left = size.x - options.width - 10;
                options.fromTop = size.y - 10;
                options.fromLeft = size.x - 10;
                break;
            default:
                delete options.top;
                delete options.left;
                delete options.fromTop;
                delete options.fromLeft;
        }
        var _work = this;
        options.onPostLoad = function () {

            var dialog = this;
            dialog.node.setStyle("display", "block");
            var nodeSize = div.getSize();
            dialog.content.setStyles({
                //"width" : nodeSize.x,
                "height": nodeSize.y
            });
            dialog.setContentSize();

            if ((options.promptCloseTime || _work.json.promptCloseTime) != 0) {
                var t = options.promptCloseTime || _work.json.promptCloseTime || 2;
                t = t.toInt() * 1000;

                if (options.isCountDown) {
                    timerNode.set("text", _work.app.lp.closePageCountDownText.replace("{second}", Math.ceil(t / 1000).toString()));
                    t = t - 1000;

                    var countDown = function () {
                        if (t > 0) {
                            timerNode.set("text", _work.app.lp.closePageCountDownText.replace("{second}", Math.ceil(t / 1000).toString()));
                            t = t - 1000;
                            window.setTimeout(countDown, 1000);
                        } else {
                            dlg.close();

                            if (_work.json.afterProcessAction == "redirect" && _work.json.afterProcessRedirectScript && _work.json.afterProcessRedirectScript.code) {
                                var url = _work.Macro.exec(_work.json.afterProcessRedirectScript.code, _work);
                                (new URI(url)).go();
                            } else {
                                // _work.app.close();
                                _work.dingTalkPcCloseOrAppClose();
                            }
                        }
                    };
                    window.setTimeout(countDown, 1000);
                } else {
                    window.setTimeout(function () {
                        if (_work.json.afterProcessAction == "redirect" && _work.json.afterProcessRedirectScript && _work.json.afterProcessRedirectScript.code) {
                            var url = _work.Macro.exec(_work.json.afterProcessRedirectScript.code, _work);
                            (new URI(url)).go();
                        } else {
                            // _work.app.close();
                            _work.dingTalkPcCloseOrAppClose();
                        }
                    }, t);
                }
            }
        };
        var dlg = o2.DL.open(options);

    },
    startDraftProcess: function ( action ) {
        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        this.saveFormData(function () {
            this.workAction.startDraft(this.businessData.work.id, function (json) {
                this.app.options.workId = json.data[0].work;
                if (layout.mobile || !layout.desktop.message) {
                    if (layout.notice) {
                        layout.notice(MWF.xApplication.process.Xform.LP.processStartedMessage + "“[" + o2.txt(json.data[0].processName) + "]" + o2.txt(this.businessData.data.title || this.businessData.data.subject));
                    }
                } else {
                    if (layout.desktop.message) {
                        var msg = {
                            "subject": MWF.xApplication.process.Xform.LP.processStarted,
                            "content": "<div>" + MWF.xApplication.process.Xform.LP.processStartedMessage + "“[" + o2.txt(json.data[0].processName) + "]" + o2.txt(this.businessData.data.title || this.businessData.data.subject) + "”</div>"
                        };

                        var tooltip = layout.desktop.message.addTooltip(msg);
                        var item = layout.desktop.message.addMessage(msg);
                    }
                }
                // 多次加载的bug
                // if (layout.app && layout.app.inBrowser) {
                //     if (layout.app) layout.app.$openWithSelf = true;
                //     layout.desktop.openApplication(null, "process.Work", { "workId": this.app.options.workId, "action": "processTask" });
                // }
                this.app.options.action = action || "processTask";
                this.app.reload();

                //this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved, "success");
                //草稿模式暂时不能上传附件，不能直接流转文件
                // o2.Actions.invokeAsync([
                //     {"action": this.workAction, "name": "loadWork"},
                //     {"action": this.workAction, "name": "getWorkControl"},
                //     {"action": this.workAction, "name": "getWorkLog"},
                //     {"action": this.workAction, "name": "getRecordLog"},
                //     {"action": this.workAction, "name": "listAttachments"}
                // ], {"success": function(json_work, json_control, json_log, json_record, json_att){
                //     if (json_work && json_control && json_log && json_att){
                //         this.app.parseData(json_work.data, json_control.data, null, json_log.data, json_record.data, json_att.data);
                //         var workData = json_work.data;
                //         this.businessData.activity = workData.activity;
                //         this.businessData.originalData = Object.clone( this.businessData.data );
                //         this.businessData.taskList = workData.taskList;
                //         this.businessData.task = this.getCurrentTaskData(workData);
                //         this.businessData.taskList = workData.taskList;
                //         this.businessData.readList = workData.readList;
                //         this.businessData.work = workData.work;
                //         this.businessData.workCompleted = (workData.work.completedTime) ? workData.work : null;
                //
                //         this.businessData.workLogList = json_log.data;
                //         this.businessData.recordList = json_record.data;
                //         this.businessData.attachmentList = json_att.data;
                //         this.businessData.control = json_control.data;
                //
                //         if (this.businessData.task){
                //             this.processWork();
                //         }else{
                //             this.app.options.workId = json.data[0].work;
                //             this.app.reload();
                //         }
                //     }
                // }.bind(this), "failure": function(){}}, json.data[0].work);

            }.bind(this));
        }.bind(this), null, false, null, false, true)
    },
    getCurrentTaskData: function (data) {
        if ((data.currentTaskIndex || data.currentTaskIndex === 0) && data.currentTaskIndex != -1) {
            this.app.options.taskId = this.businessData.taskList[data.currentTaskIndex].id;
            return this.businessData.taskList[data.currentTaskIndex];
        }
        return null;
    },

    /**
     * @summary 弹出四合一的提交框.
     * @example
     * this.form.getApp().appForm.flowWork();
     */
    flowWork: function ( defaultRoute ) {
        if( !this.isLoaded ){ //未加载完成需要等待加载完成再执行
            var flowWorkFun = function () {
                this.removeEvent( "afterLoad", flowWorkFun );
                this._flowWork( defaultRoute )
            }.bind(this);
            this.addEvent("afterLoad", flowWorkFun)
        }else{
            this._flowWork( defaultRoute );
        }
    },
    _flowWork: function( defaultRoute ){
        if (!this.checkUploadAttachment()) return false;

        if (!this.businessData.work.startTime) {
            this.startDraftProcess();
        } else {
            if (this.json.mode == "Mobile") {
                setTimeout(function () {
                    this.flowWork_mobile( defaultRoute );
                }.bind(this), 100);
            } else {
                this.flowWork_pc( defaultRoute );
            }
        }
    },
    flowWork_pc: function ( defaultRoute ) {
        var _self = this;
        //? 添加事件
        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        var flowNode = new Element("div", { "styles": this.app.css.flowNode_Area }).inject(this.node);
        flowNode.setStyle("opacity", 0);

        var setSize = function (notRecenter) {

            var dlg = this;
            if (!dlg || !dlg.node) return;
            dlg.node.setStyle("display", "block");
            //var size = flowNode.getSize();

            //希望滚动条在flow里面
            var maxHeight = dlg.getContentMaxHeight();
            var s = _self.flow.getSize();

            //如果出现了滚动条，希望意见框能够自适应缩小
            if( s.y > maxHeight ){
                _self.flow.redeuceOpinionHeight( s.y - maxHeight );
            }

            dlg.content.setStyles({
                "height": Math.min(s.y, maxHeight),
                "width": s.x,
                "padding-right": "0px"
            });

            s = dlg.setContentSize();
            if (!notRecenter) dlg.reCenter();
        };

        var setSizeFun = function (){
            setSize.call(this.flowDlg);
        }.bind(this)

        this.loadFlow(flowNode, (this.json.flowStyle || "default"), function (flow) {
            this.flowDlg = o2.DL.open({
                "title": this.app.lp.flowWork,
                "style": this.json.dialogStyle || "user",
                "zindex": 20001,
                "isResize": false,
                "content": flowNode,
                "container": this.app.content,
                "maskNode": this.app.content,
                "positionHeight": 900,
                "maxHeight": 900,
                "maxHeightPercent": "98%",
                "minTop": 5,
                "width": "auto",
                "height": "auto",
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            //避免双击
                            if (this.flowTimer) {
                                clearTimeout(this.flowTimer);
                                this.flowTimer = null;
                            }
                            this.flowTimer = setTimeout(function(){
                                if (this.flow) this.flow.submit();
                                this.flowTimer = null;
                            }.bind(this), 200)
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () {
                            this.flowDlg.close();
                        }.bind(this)
                    }
                ],
                "onQueryClose": function(){
                    if (this.flow) this.flow.destroy();
                    _self.app.removeEvent('resize', setSizeFun);
                }.bind(this),
                "onPostLoad": function () {
                    flowNode.setStyle("opacity", 1);
                    setSize.call(this);
                    _self.app.addEvent('resize', setSizeFun);
                }
            })
        }.bind(this), function () {
            if (this.flowDlg) setSize.call(this.flowDlg, true)
        }.bind(this), defaultRoute);
    },
    flowWork_mobile: function ( defaultRoute ) {
        // if (this.app.inBrowser) {
        //     this.app.content.setStyle("height", document.body.getSize().y);
        // }

        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");

        // if (this.json.mode != "Mobile") {
        //     this.app.content.mask({
        //         "destroyOnHide": true,
        //         "style": this.app.css.maskNode,
        //         "useIframeShim": true,
        //         "iframeShimOptions": { "browsers": true },
        //         "onShow": function () {
        //             this.shim.shim.setStyles({
        //                 "opacity": 0,
        //                 "top": "" + position.y + "px",
        //                 "left": "" + position.x + "px"
        //             });
        //         }
        //     });
        // }

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            return false;
        }

        var processNode = new Element("div.flowNode_mobile", { "styles": this.app.css.flowNode_mobile }).inject(document.body);
        // processNode.position({
        //     relativeTo: this.app.content,
        //     position: "topcenter",
        //     edge: "topcenter"
        // });
        this.loadFlow(processNode, null, null, null, defaultRoute);
    },
    loadFlow: function (hanlderNode, style, postLoadFun, resizeFun, defaultRoute) {
        var _self = this;
        MWF.xDesktop.requireApp("process.Work", layout.mobile ? "FlowMobile" : "Flow", null, false);
        var op = this.getOpinion();
        var mds = op.medias;
        var innerNode;
        if (layout.mobile) {
            innerNode = new Element("div").inject(hanlderNode);
        }

        var options = {
            "style": style || "default",
            "isQuickSelect": this.json.isQuickSelect !== 'no',
            "onResize": function () {
                if (resizeFun) resizeFun();
            },
            "onLoad": function () {
                if (postLoadFun) postLoadFun(this);

                _self.fireEvent("afterLoadProcessor", [this]);
                if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterLoadProcessor", [this]);
            },
            "onCancel": function () {
                //this.destroy();
                hanlderNode.destroy();
                //_self.app.content.unmask();
                _self.fireEvent("closeProcessor", [this]);
                if (_self.app && _self.app.fireEvent) _self.app.fireEvent("closeProcessor", [this]);
                _self.flow = null;
            },
            "opinionOptions": {
                "opinion": op.opinion,
                "tabletToolHidden": this.json.tabletToolHidden || [],
                "tabletWidth": this.json.tabletWidth || 0,
                "tabletHeight": this.json.tabletHeight || 0,
            },
            "processOptions": {
                "defaultRoute": defaultRoute,
                "isHandwriting": this.json.isHandwriting === "no" ? false : true,
                "onSubmit": function (routeName, opinion, medias, appendTaskIdentityList, processorOrgList, callbackBeforeSave) {
                    if (!medias || !medias.length) {
                        medias = mds;
                    } else {
                        medias = medias.concat(mds)
                    }

                    var promise;
                    if (_self.toWordSubmitList && _self.toWordSubmitList.length){
                        var p = [];
                        _self.toWordSubmitList.each(function(editor){
                            if (editor.docToWord) p.push(new Promise(function(resolve){ editor.docToWord(resolve) }));
                        });
                        Promise.all(p).then(function(){
                            _self.submitWork(routeName, opinion, medias, function () {
                                this.destroy();
                                hanlderNode.destroy();
                                if (_self.flowDlg) _self.flowDlg.close();
                                delete this;
                            }.bind(this), this, null, appendTaskIdentityList, processorOrgList, callbackBeforeSave);
                        }.bind(this));
                    }else{
                        _self.submitWork(routeName, opinion, medias, function () {
                            this.destroy();
                            hanlderNode.destroy();
                            if (_self.flowDlg) _self.flowDlg.close();
                            delete this;
                        }.bind(this), this, null, appendTaskIdentityList, processorOrgList, callbackBeforeSave);
                    }
                }
            },
            "addTaskOptions":{
                "isHandwriting": false,
                "onSubmit": function (names, opinion, mode, before, routeName, userOpinion) {
                    MWF.require("MWF.widget.Mask", function () {
                        var data = {mode: mode, opinion: opinion, before: before, names:names, userOpinion:userOpinion};
                        _self.fireEvent("beforeAddTask", data);
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeAddTask");

                        _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                        if (layout.mobile) {
                            _self.mask.load();
                        } else {
                            _self.mask.loadNode(_self.app.content);
                        }

                        if( !_self.validationOtherFlow('addTask', userOpinion, this, data) ){
                            if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                            return;
                        }

                        _self.fireEvent("beforeSave");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeSave");
                        _self.saveFormData(function (json) {

                            _self.fireEvent("afterSave");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterSave");

                            _self.AddTaskToPeson(names, opinion, mode, before, routeName, function (workJson) {
                                _self.fireEvent("afterAddTask", data);
                                if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterAddTask");
                                // _self.addResetMessage(workJson.data);
                                this.destroy();
                                hanlderNode.destroy();
                                if (_self.flowDlg) _self.flowDlg.close();

                                _self.finishOnFlow("addTask", workJson.data);

                            }.bind(this), function (xhr, text, error) {
                                var errorText = error + ":" + text;
                                if (xhr) errorText = xhr.responseText;
                                _self.app.notice("request json error: " + errorText, "error", _self.flowDlg.node);
                                if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                            }.bind(this));
                        }.bind(this))
                    }.bind(this));
                }
            },
            "resetOptions":{
                "isHandwriting": false,
                "onSubmit": function (names, opinion, routeName, userOpinion) {
                    MWF.require("MWF.widget.Mask", function () {
                        var data = {routeName: routeName, opinion: opinion, userOpinion:userOpinion, names:names};
                        _self.fireEvent("beforeReset", data);
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeReset");

                        _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                        if (layout.mobile) {
                            _self.mask.load();
                        } else {
                            _self.mask.loadNode(_self.app.content);
                        }

                        if( !_self.validationOtherFlow('reset', userOpinion, this, data) ){
                            if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                            return;
                        }

                        _self.fireEvent("beforeSave");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeSave");
                        _self.saveFormData(function (json) {

                            _self.fireEvent("afterSave");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterSave");

                            _self.resetToPeson(names, opinion, routeName, function (workJson) {
                                _self.fireEvent("afterReset", data);
                                if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterReset");
                                // _self.addResetMessage(workJson.data);
                                this.destroy();
                                hanlderNode.destroy();
                                // if (!_self.app.inBrowser) _self.app.close();
                                if (_self.flowDlg) _self.flowDlg.close();
                                // if (_self.mask) { _self.mask.hide(); _self.mask = null; }

                                _self.finishOnFlow("reset", workJson.data);

                            }.bind(this), function (xhr, text, error) {
                                var errorText = error + ":" + text;
                                if (xhr) errorText = xhr.responseText;
                                _self.app.notice("request json error: " + errorText, "error", _self.flowDlg.node);
                                if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                            }.bind(this));
                        }.bind(this))
                    }.bind(this));
                }
            },
            "goBackOptions":{
                "isHandwriting": false,
                "onSubmit": function (opinion, routeName, activity, way, userOpinion) {
                    MWF.require("MWF.widget.Mask", function () {
                        var data = {routeName: routeName, opinion: opinion, activity:activity, way:way, userOpinion:userOpinion};
                        _self.fireEvent("beforeGoBack", data);
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeGoBack");

                        _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                        if (layout.mobile) {
                            _self.mask.load();
                        } else {
                            _self.mask.loadNode(_self.app.content);
                        }

                        if( !_self.validationOtherFlow('goBack', userOpinion, this, data) ){
                            if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                            return;
                        }

                        _self.fireEvent("beforeSave");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeSave");
                        _self.saveFormData(function (json) {

                            _self.fireEvent("afterSave");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterSave");

                            _self.goBackToPerson(routeName, opinion, activity, way, function (workJson) {
                                _self.fireEvent("afterGoBack", data);
                                if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterGoBack");
                                this.destroy();
                                hanlderNode.destroy();
                                if (_self.flowDlg) _self.flowDlg.close();
                                _self.addMessage(workJson.data, true);
                                if (_self.app.taskObject) _self.app.taskObject.destroy();
                                _self.finishOnFlow("goBack", workJson.data);
                            }.bind(this));
                        }.bind(this))
                    }.bind(this));
                }
            }
        };


        if( this.json.mode == "Mobile" ){
            this.flow = new MWF.xApplication.process.Work.FlowMobile(innerNode || hanlderNode, this.businessData.task, options, this);
        }else{
            this.flow = new MWF.xApplication.process.Work.Flow(innerNode || hanlderNode, this.businessData.task, options, this);
        }
    },

    resetToPeson: function (identityList, opinion, routeName, success, failure) {
        var data = {
            "opinion": opinion,
            "routeName": routeName || MWF.xApplication.process.Xform.LP.reset,
            "identityList": identityList
            // "keep": !!keep
        };
        o2.Actions.load("x_processplatform_assemble_surface").TaskAction.V2Reset(
            //this.workAction.resetWork(
            function (json) {
                if (success) success(json);
            }.bind(this),
            function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            },
            this.businessData.task.id, data
        );
    },

    AddTaskToPeson: function (names, opinion, mode, before, routeName, success, failure) {
        var data = {
            "mode": mode,
            "before": !!before,
            "opinion": opinion,
            "routeName": routeName || MWF.xApplication.process.Xform.LP.addTask,
            "distinguishedNameList": names
        };
        o2.Actions.load("x_processplatform_assemble_surface").TaskAction.v3Add(
            //this.workAction.resetWork(
            function (json) {
                if (success) success(json);
            }.bind(this),
            function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            },
            this.businessData.task.id, data
        );
    },

    goBackToPerson: function(routeName, opinion, activity, way, callback){
        this.businessData.task.decision = routeName;
        this.businessData.task.routeName = routeName;
        this.businessData.task.opinion = opinion;
        this.businessData.task.action = "goBack";
        this.businessData.task.option = {
            "activity": activity,
            "way": way
        };

        // this.submitWork(routeName, opinion, null, function () {
        //     if(callback)callback();
        // }.bind(this));

        this.workAction.processTask(function (json) {
            if (callback) callback(json);
        }.bind(this), null, this.businessData.task.id, this.businessData.task);
    },


    processWork: function ( defaultRoute ) {
        if( !this.isLoaded ){ //未加载完成需要等待加载完成再执行
            var processWorkFun = function () {
                this.removeEvent( "afterLoad", processWorkFun );
                this._processWork( defaultRoute )
            }.bind(this);
            this.addEvent("afterLoad", processWorkFun)
        }else{
            this._processWork( defaultRoute );
        }
    },
    checkUploadAttachment: function(){
        if (o2.runningRequestsList.length){
            var runningRequests = [];
            var reg = /\/jaxrs\/attachment\/upload\/work\/([\w-]*)/;
            o2.runningRequestsList.forEach(function(r){
                var method = (r.requestOptions[0] || "get").toLowerCase();
                var url = r.requestOptions[1] || "";

                var m = url.match(reg);
                if (m && m[1]===this.businessData.work.id && method==="post"){
                    runningRequests.push(r);
                }
            }.bind(this));

            if (runningRequests.length){
                this.app.notice(MWF.xApplication.process.Xform.LP.uploading, "info");
                return false;
            }
        }
        return true;
    },
    _processWork: function( defaultRoute ) {
        if (!this.checkUploadAttachment()) return false;

        var _self = this;

        if (!this.businessData.work.startTime) {
            this.startDraftProcess();
        } else if (this.json.submitFormType === "select") {
            this.processWork_custom( defaultRoute );
        } else if (this.json.submitFormType === "script") {
            this.processWork_custom( defaultRoute );
        } else {
            if (this.json.mode == "Mobile") {
                setTimeout(function () {
                    this.processWork_mobile( defaultRoute );
                }.bind(this), 100);
            } else {
                this.processWork_pc( defaultRoute );
            }
        }
    },
    processWork_custom: function ( defaultRoute ) {
        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        if (!this.submitFormModule) {
            if (!MWF["APPSubmitform"]) {
                MWF.xDesktop.requireApp("process.Xform", "Subform", null, false);
            }
            var submitFormContainer = new Element("div").inject(layout.mobile ? $(document.body) : this.app.content);
            this.submitFormModule = new MWF["APPSubmitform"](submitFormContainer, {
                id: this.json.id,
                submitFormSelected: this.json.submitFormSelected,
                submitFormAppSelected: this.json.submitFormAppSelected,
                submitFormType: this.json.submitFormType,
                submitFormScript: this.json.submitFormScript,
                submitScript: this.json.submitScript
            }, this);
            this.submitFormModule.addEvent("afterModulesLoad", function () {
                this.submitFormModule.show( defaultRoute );
                this.fireEvent("afterLoadProcessor", [this.submitFormModule]);
            }.bind(this))
            this.submitFormModule.load();
        } else {
            this.submitFormModule.show( defaultRoute );
            this.fireEvent("afterLoadProcessor", [this.submitFormModule]);
        }
    },
    processWork_pc: function ( defaultRoute ) {
        var _self = this;
        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        // MWF.require("MWF.widget.Mask", function() {
        //     this.mask = new MWF.widget.Mask({"style": "desktop", "zIndex": 50000});
        //     this.mask.loadNode(this.app.content);

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        var setSize = function (notRecenter) {

            var dlg = this;
            if (!dlg || !dlg.node) return;
            dlg.node.setStyle("display", "block");
            var size = processNode.getSize();
            dlg.content.setStyles({
                "height": size.y,
                "width": size.x
            });

            var s = dlg.setContentSize();
            // if ( dlg.content.getStyle("overflow-y") === "auto" && dlg.content.getStyle("overflow-x") !== "auto" ) {
            //     var paddingRight = (dlg.content.getStyle("padding-right").toInt() || 0 );
            //     if( paddingRight < 20 ){
            //         dlg.node.setStyle("width", dlg.node.getStyle("width").toInt() + 20 + "px");
            //         dlg.content.setStyle("width", dlg.content.getStyle("width").toInt() + 20 + "px");
            //     }
            // }
            if (!notRecenter) dlg.reCenter();
        }

        //var node = new Element("div", {"styles": this.css.rollbackAreaNode});
        var processNode = new Element("div", { "styles": this.app.css.processNode_Area }).inject(this.node);
        processNode.setStyle("opacity", 0);
        this.setProcessNode(processNode, "process", function (processor) {
            this.processDlg = o2.DL.open({
                "title": this.app.lp.process,
                "style": this.json.dialogStyle || "user",
                "isResize": false,
                "content": processNode,
                "maskNode": this.app.content,
                "positionHeight": 800,
                "maxHeight": 800,
                "maxHeightPercent": "98%",
                "minTop": 5,
                "width": "auto", //processNode.retrieve("width") || 1000, //600,
                "height": "auto", //processNode.retrieve("height") || 401,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            //避免双击
                            if (this.processTimer) {
                                clearTimeout(this.processTimer);
                                this.processTimer = null;
                            }
                            this.processTimer = setTimeout(function(){
                                if (this.processor) this.processor.okButton.click();
                                this.processTimer = null;
                            }.bind(this), 200)
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () {
                            _self.fireEvent("closeProcessor", [this]);
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("closeProcessor", [this]);
                            this.processDlg.close();
                        }.bind(this)
                    }
                ],
                "onQueryClose": function(){
                    if (this.processor) this.processor.destroy();
                }.bind(this),
                "onPostLoad": function () {
                    processNode.setStyle("opacity", 1);
                    processor.options.mediaNode = this.content;
                    setSize.call(this)
                }
            })
        }.bind(this), function () {
            if (this.processDlg) setSize.call(this.processDlg, true)
        }.bind(this), defaultRoute);
    },
    processWork_mobile: function ( defaultRoute ) {
        if (this.app.inBrowser) {
            this.app.content.setStyle("height", document.body.getSize().y);
        }

        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");
        var position = this.app.content.getPosition(this.app.content.getOffsetParent());

        if (this.json.mode != "Mobile") {
            this.app.content.mask({
                "destroyOnHide": true,
                "style": this.app.css.maskNode,
                "useIframeShim": true,
                "iframeShimOptions": { "browsers": true },
                "onShow": function () {
                    this.shim.shim.setStyles({
                        "opacity": 0,
                        "top": "" + position.y + "px",
                        "left": "" + position.x + "px"
                    });
                }
            });
        }

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        // MWF.require("MWF.widget.Mask", function() {
        //     this.mask = new MWF.widget.Mask({"style": "desktop", "zIndex": 50000});
        //     this.mask.loadNode(this.app.content);

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        var processNode = this.createProcessNode();

        //this.setProcessNode(processNode);
        this.setProcessNode(processNode, null, null, null, defaultRoute);

        this.showProcessNode(processNode);
        processNode.setStyle("overflow", "auto");
        //}.bind(this));
    },

    createProcessNode: function () {
        var fromCss = this.app.css.processNode_from;
        var css = this.app.css.processNode;
        if (layout.mobile) {
            fromCss = this.app.css.processNodeMobile_from;
            css = this.app.css.processNodeMobile;

            // var contentSize = this.app.content.getSize();
            fromCss.width = "100%";
            css.width = "100%";
            fromCss.height = "100%";
            css.height = "100%";
        }

        if (this.json.mode == "Mobile") {
            var processNode = new Element("div", { "styles": fromCss }).inject(document.body);
        } else {
            var processNode = new Element("div", { "styles": fromCss }).inject(this.app.content);
        }


        processNode.position({
            relativeTo: this.app.content,
            position: "topcenter",
            edge: "topcenter"
        });
        return processNode;
    },
    getOpinion: function () {
        var opinion = "";
        var medias = [];
        Object.each(this.forms, function (m, id) {
            if (m.json.type === "Opinion") if (this.businessData.data[id]) opinion += " " + m._getBusinessSectionDataByPerson();
            if (m.handwritingFile) if (m.handwritingFile[layout.session.user.distinguishedName]) medias.push(m.handwritingFile[layout.session.user.distinguishedName]);
            if (m.soundFile) if (m.soundFile[layout.session.user.distinguishedName]) medias.push(m.soundFile[layout.session.user.distinguishedName]);
            if (m.videoFile) if (m.videoFile[layout.session.user.distinguishedName]) medias.push(m.videoFile[layout.session.user.distinguishedName]);
        }.bind(this));
        return { "opinion": opinion.trim(), "medias": medias };
    },
    setProcessNode: function (processNode, style, postLoadFun, resizeFun, defaultRoute) {
        var _self = this;
        MWF.xDesktop.requireApp("process.Work", "Processor", function () {
            var op = this.getOpinion();
            var mds = op.medias;

            var innerNode;
            if (layout.mobile) {
                innerNode = new Element("div").inject(processNode);
            }
            this.processor = new MWF.xApplication.process.Work.Processor(innerNode || processNode, this.businessData.task, {
                "style": (layout.mobile) ? "mobile" : (style || "default"),
                "opinion": op.opinion,
                "isHandwriting": this.json.isHandwriting === "no" ? false : true,
                "tabletToolHidden": this.json.tabletToolHidden || [],
                "tabletWidth": this.json.tabletWidth || 0,
                "tabletHeight": this.json.tabletHeight || 0,
                "defaultRoute": defaultRoute,
                "onPostLoad": function () {
                    if (postLoadFun) postLoadFun(this);
                    _self.fireEvent("afterLoadProcessor", [this]);
                },
                "onResize": function () {
                    if (resizeFun) resizeFun();
                },
                "onCancel": function () {
                    processNode.destroy();
                    _self.app.content.unmask();
                    delete this;
                },
                "onSubmit": function (routeName, opinion, medias, appendTaskIdentityList, processorOrgList, callbackBeforeSave) {
                    if (!medias || !medias.length) {
                        medias = mds;
                    } else {
                        medias = medias.concat(mds)
                    }

                    var promise;
                    if (_self.toWordSubmitList && _self.toWordSubmitList.length){
                        var p = [];
                        _self.toWordSubmitList.each(function(editor){
                            if (editor.docToWord) p.push(new Promise(function(resolve){ editor.docToWord(resolve) }));
                        });
                        Promise.all(p).then(function(){
                            _self.submitWork(routeName, opinion, medias, function () {
                                this.destroy();
                                processNode.destroy();
                                if (_self.processDlg) _self.processDlg.close();
                                delete this;
                            }.bind(this), this, null, appendTaskIdentityList, processorOrgList, callbackBeforeSave);
                        }.bind(this));
                    }else{
                        _self.submitWork(routeName, opinion, medias, function () {
                            this.destroy();
                            processNode.destroy();
                            if (_self.processDlg) _self.processDlg.close();
                            delete this;
                        }.bind(this), this, null, appendTaskIdentityList, processorOrgList, callbackBeforeSave);
                    }
                }
            }, this);
        }.bind(this));
    },
    showProcessNode: function (processNode) {
        if (layout.mobile) {
            processNode.setStyles(this.app.css.processNodeMobile)
        } else {
            var size = this.app.content.getSize();
            var nodeSize = processNode.getSize();

            var top = size.y / 2 - nodeSize.y / 2 - 20;
            var left = size.x / 2 - nodeSize.x / 2;
            if (top < 0) top = 0;

            this.app.css.processNode.top = "" + top + "px";
            this.app.css.processNode.left = "" + left + "px";

            var morph = new Fx.Morph(processNode, {
                "duration": 300,
                "transition": Fx.Transitions.Expo.easeOut
            });
            morph.start(this.app.css.processNode);
        }

    },


    confirm: function (type, e, title, text, width, height, ok, cancel, callback, mask, style, zindex) {
        MWF.require("MWF.xDesktop.Dialog", function () {
            var size = this.container.getSize();
            var x = 0;
            var y = 0;
            if (typeOf(e) === "element") {
                var position = e.getPosition(this.app.content);
                x = position.x;
                y = position.y;
            } else {
                if (Browser.name == "firefox") {
                    x = parseFloat(e.event.clientX || e.event.x);
                    y = parseFloat(e.event.clientY || e.event.y);
                } else {
                    x = parseFloat(e.event.x);
                    y = parseFloat(e.event.y);
                }

                if (e.target) {
                    var position = e.target.getPosition(layout.mobile ? $(document.body) : this.app.content);
                    //var position =  e.target.getPosition();
                    x = position.x;
                    y = position.y;
                }
            }

            // if (Browser.Platform.ios){
            //     $("textdiv").set("text", "$(document.body).getScroll().y: "+$(document.body).getScroll().y);
            //     y = y-$(document.body).getScroll().y;
            // }

            if (x + parseFloat(width) > size.x) {
                x = x - parseFloat(width);
            }
            if (x < 0) x = 10;
            if (y + parseFloat(height) > size.y) {
                y = y - parseFloat(height);
            }
            if (y < 0) y = 10;

            //var x = parseFloat((Browser.name==="firefox") ? e.event.clientX : e.event.x);
            //var y = parseFloat((Browser.name==="firefox") ? e.event.clientY : e.event.y);

            // if (x+parseFloat(width)>size.x){
            //     x = x-parseFloat(width);
            // }
            if (x < 0) x = 20;
            if (!layout.mobile) { // pc上鼠标位置偏移20
                x = x - 20
            }


            var opt = {
                "title": title,
                "style": style || "o2",
                "zindex": zindex,
                "top": y,
                "left": x,
                "fromTop": e.event.y,
                "fromLeft": (Browser.name === "firefox") ? e.event.clientX - 20 : e.event.x - 20,
                "width": width,
                "height": height,
                "container": layout.mobile ? $(document.body) : this.app.content,
                "maskNode": mask || (layout.mobile ? $(document.body) : this.app.content),
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": ok
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": cancel
                    }
                ],
                "onPostLoad": function (){
                    switch (typeOf(callback)){
                        case 'function': callback(this); break;
                        case 'object':
                            if( callback.postLoad )callback.postLoad(this);
                            break;
                    }
                },
                "onPostShow": function (){
                    if( typeOf(callback) === 'object' ){
                        if( callback.postShow )callback.postShow(this);
                    }
                }
            };


            if (typeOf(text).toLowerCase() === "object") {
                if( text.html )opt.html = text.html;
                if( text.text )opt.text = text.text;
            } else {
                if( /<\/?[a-z][\s\S]*>/i.test(text||"")){
                    opt.html = text;
                }else{
                    opt.text = text
                }
            }

            var dlg = new MWF.xDesktop.Dialog(opt);

            switch (type.toLowerCase()) {
                case "success":
                    if (this.json.confirmIcon && this.json.confirmIcon.success) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.success + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAB1hJREFUeNqsWGtsVEUUPnMf+y6rLcW2tDxUKARaikqgiWh8BlH8IwYkaozhh4nhB1FMTKkxQtQYQzRGE2JEfMRHYhQSVChgFYIGqLSUtoKUQmlp2b53u233de94zuzcZbfdbhdwkpPZmbl3zjffnHPuOcue/WgxZNnc3OT3cQ4rGIMlwNg8BjATGEwDDgHOeZdpQis3eKMR5Sd62kaO/PHp5QDub2ba9OtNTYnf2lQIcOO5igpr8eeT3kL9XneuCi6vAvYcFWxOBqrO6BlvZIx7w8PGwlG/uWZkwADNzo4//e7CfQMdYz/88t6F8/i+icB4Jl0sEzPIxEbsXiwotVd6C3TwTFezZRGCfQb4r0bhSnPo78io8dWP1ed24nRkPFNTMoMnnYNsbGYK2zR/pYsRGxJc1mDcuQqKHbwF2t3/Hh29a+3bC8oHOkM7UPk5UpGOpQQzFsINHyxahDaxdeYix/r8223AFLjpxpGL3rYIXDw5um+gc+ydwx9fqsPpKC0lP6eWr54hfjT+2gPP7Fg0R1HgreIyx/rpc2zxjfjNCzXXrSo4PMr8sWFecEuRo6mjMdBPdpQMJuWa6GoKF9jX55bo13UlE5jg8szobshyotG+RtT1OJrBAA43o/hRYhOYKVuVvxFtZPusCie7GUbQvcnmIBbh4noEoqR15zQV/N1GeXFZzvD5Y4P1ydclwJD7om1sn3uPs0S3x1++ESHlJgJB74FiXgkD4XZQLGr4NQtBh2DDvWa+3aOd7D4b7CGDFjcjr2dt3mxbpQNjB53sRsTA7YiN0IgBRWYlrJz2suhpTPO0bj1LegpKHWWFpZ6nUL0ngYOAUkBz34JAYjytEO1GJN5Pth4LmRAajkGxuQJWFb0CLpdL9DSmeVpPfp/0uXP1B2+b5y5A/cJbVLSVh9252uu5M/WM1BMYSLKBdFczS6mEx0peBbfbDU6nE1RVhdnOZdDj78AruyyvLP6+ZmMQDQMCYc3tp/xnKSAq9K2xuxmYBp8oeIJY2ITwSAxm8uWip7E43bj1ErYCHpsVB0KsOBwO0dOY5mdrlXhdSe+ikN6cPNtSeTsqgV2iOxRchFRBh4uGOSpCY8QTP5C/SfQ0pnkjmrq+es6WBBBN0wQrNpsNvF4vFBYWwgvL3ofFeY/EmZQ6SK/do5YiECeFGYW+vprGUu0AaY/iHYeDceqfmLtFKKGexjRP15K8ngxEUa6FbfpNwH5qfQua+w8lGCUhvbpDLZE2g8xgGkAhP4WRCJ3YhFk6KrozrignJ0f0NKb50LCRsp4OCJNu/X3LG3Cm92Dcm5LYJ71oO9MtMJrIRyguGzwRPelu5zoqYc28a4rodLqui2eexPk9/3DRTwXku6ZqaOo7KOw2bdqgMLf8EigaJUaxCHgT+yCY8hmPwrrFb4oNLbEUkGITj7iuoloozwTk28ZqONMzOZA4U3w07mLANMrQ0CO85GpWO+M7iKsMNlRsk2zxxP2TYo/HIwBZ43RAvmmohkZfzaRAqIlgGDH7rEChUaqIXrFQUVPfauiqEcifvWubUJAMiLwkLeUSyNenEMjVzECokTdGQman/FiaGuWs6DlrdNvENxs6DwCuw3PLtqcAygTkq5Nb4XT31EAEGIragVgrBTz6PmmUPBNdppH+hfrOGhEbnl8+OSALyJfHtwpGswFiXdNgV6jFAqPm3+7yOb36A5pdKaY906UF3f4LcNXfDhUlDyUUjwey+6+qOPAs0w8KH0NXI00nvu/aFQoaPnxtWKFyAhHui4Yw/0B20goyU3+5BnYfq0oASPYymqd1em7SPcYJ6fP7wn8OdYcp0RoRzFBiHPCFexRdqdR0VsRkzjpBiKGhC+BDhpbOfijBzOdHq+BU+4H4ic3sJIYRPtAbbWk+1Pv54JXQRdxmiExI+CTVNVROjI2YPGPeggrrLh2AXUeqBCvU09jk15f7kJ6+S6P7244PUT0VkDYTz/QoGf+ntr9h/srcIs2mLFVY5oyua7AVfIF2qGvbn5rFZSHESn9HaG/Nhxc/wxmylUErDxbMyBomQnVNcDC2Lyq9a1LB051o3T/hWzOV0L6D3eHalsN936K+PgkkYiWkyVWR+dsnl85RXRP0R3+OxbioEP4vof2GfOHac0f6v7h4cqhZghlNLldS6iZCiA/6qK7RnapLtSvlwCm43ES1QFdjco6s722q6d2NFcFp1NMjbSWWsdbGypIshj7POatfu+MlT55tnd2lljHOso1l18yIYYIeNFrIWGt3tv8o2SAZJu8h80iutRPMWE0aNFEXobqGygk0ar+iM5eqswIrqE0w3ASAeD8WjDX1d4ztIfet3+v7XRprL/0nQIxYtba8kan/hUDUikx8PJTFl96fdx/lrJQqUoZGiRHlI5QG0NeXPnr0raEQf7a2r04GtICU4FT/QmTDPJOGTqAcMnl2yrFNJkZWMIhJ7yAZk5E1JMfm+EI/naLraQRKlQBUKUoSGFNWh4YEZowv7jO1/wQYAIxJoZGb/Cz/AAAAAElFTkSuQmCC)");
                    }
                    break;
                case "error":
                    if (this.json.confirmIcon && this.json.confirmIcon.error) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.error + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABsVJREFUeNqkWFtsFGUU/nZn2r21IqX3llp6AQmkWDVGAgIlGI0EeMAHffAFa998MCQaE8JDxZCgSHzQKIm3qPHFGC7GW0xqkIgIKhhEwFJaKSDQUtplu73s7vidmX/q32F2uw2TnOzMv2fO+f5z/8fci7yvWAZYRXo4CCwLAM1cq+HvXRYwQrrM/7rTwB+TwC/dwKG3uU75mVxCO7T7wExgKHiBATzJ2411wMoy3pSQ5gg6UiFpgpQgDZNukK6TLgBHuf7lAPD5q8DfXMpQl5U3mA4P4ztAO3+2tADLCQSV+VsR/5L+If0G/EqgH78EvKtwT1lqr0en6SfoLaCe1niB7nj+CQIuV+uZWYApV8RNPPAVcP/rQMtF4I03gbNcpjdvt5KxQXs4SKKflxBI54PAs20EElNvZTQJucjLFyUtpZwioJVurFtMD/4MXBXWDUqnL5jHHYt0PgQ8da/4UFMwThpTz0HF7wfEj0/kSKwVAwsZU5U1wKkTwOBBj7GD08xE17QSSJPanVCKlCSNkM5s2mT/JtV6epZ8InclsH4R9TjYRKWPZQixnch2POJsZNpOb5HOb9yIi5s3I5XJIHb2rL2LoBZL+fBZKhOZaS3LgPgh4HcnYZ34scFI+goQxsj8iA+QHipItrejrKwMiaVLMZJIIEpFAaUkH76AFrEVfLxEzzEej/0FXFOGc8CQ8bmFTOE6DciEUnCBCsapoLGxETU1NYhGo7i+YAHiSlFauWMmvqAGKOzcVzDlh2mdo2o/loCJkeEVRnldSMsGUdCrKaiqqkJxcTEikQgKCgpsRbJzk4oukm8iB1+CfEUKkLtZub/CZOsFvht0Qi1lrAfW0WwvN3gyI7J1K+7ZswfNzc0oLS1FKBRCMBiEaZoIh8OOovp6jI6NYXLLFjQ1NdlAxCKGYaCwsBAlJSWoJ08lwQZTKaSPHJmSL9YZZWZx438eZ8yLMwwWtWeYaqvv9oBJ8UWDyovWrUMgEPi/ZPPeBWT/rlhhx0h1dbUNRABPpSrvBVhixw4kd+26rRyMOq3jCl31kzya0vSiKgW91/DOnbZJ53V22iAsy5pSIopra2vtNflP3KIDcTcwuH074pQT8JEvelkMF4kjpBuY0n1Dbjj7XDcpSCCU+gCKxWK+77hABghkOAsQuUIOivmq3xrSm2qMLJZxrwEKlGJQ5QGUC8gVBSSYQ67hoCidAiPzSCCHZSxVlXopeHhiAk30v8RBtivFQO3etg1Du3fbbihQKe0L3MmqmGrYwaAMRuPKMl6aVCkeJ11jRvSuWYO+vj4kk0lf4bIu/wuf8MfV+5NZ5I87RhhVuAKmTGhsbHPCWSwiwoYoOMQ60tDQgPLycjvNfWOA6/J/Op3GefJzsMLcAwfs6PSz0JhTXAfcBDNlVCS0xaYHSEql3jCBRLSC5k3faV1XZZnwySWABmUqJKCo8oUOaNTZbL9SlzE4Niwh8lURLf/TyoQzAZFgdcmvDklhjKsKXKAqsF5rZEztAboOAz+KA4xHmeo0+tNFqky7VMkKfJ+nAnuV2rtn1pS0td32n16B67kpRjZuqQrs6pB5mW37s5OswoLNaOTUdRfQRjPWGhrqOF80aYVSTwXWgfQQSL8URiqa6wGkV+B+ZuAlTwUWF/VxyPoUeD/uTH5x4xhjiNapoHXWhj3l+ubhw0hTkbtz3SXdBNJHIJgFn+Vx0Tlg37eOi+RAkTTk+MDueY1WWc64qQ5oZpSXhpSiedrOz1HBBVWZZ8Pn0phzcjj9DfBBvz1r4aYkrz3PvEhZq9lIyfgY3RXwzrY3lKKytWtxhgp6fHaaL5+AoU8stulPvgB+UFZJuPOMPaF/D5wgoGq6q9XMosianER3FiD58iWcDNr/GvCegwtDbjeywShAGQ5Y3aYzZC00PELsDkxFmOGokosv6cy/XV8DHyr3XFfL1rSBnL/WNqKUcw3rQWWhD6A7oaSTPV1dwEecX07CmX1v6W3Re4iz5IAl5xqCiTIMW0zJ5DsAkXKOLxbHy/1iEQ3IiHdYmAbGdZccsBhDXXKcoMAyWqjCynJwywVCqjgbz2kJVokR5RoXyKRkctYTpQ5Iepica+Q4QesMU0GUoCozPjGS0QZ5t9uzJ51ioO6T9FVZc1XFiLgm5X6ROJjvJ5EOZ4iXwaeIs2Elz1WreExtlVFRJjQZjGQekTFAuq80PRazbp6JTtOyxy87FX9EkYCY8H6v6fDMNzNdagayQYXVZ5mIei7UmrHrnQlFSZXJY9qnECuXIjMPMJZ2lHIPj6aaGg0FNOD5CJHWjtl5f0n5T4ABAFHaXG6UVjGNAAAAAElFTkSuQmCC)");
                    }
                    break;
                case "info":
                    if (this.json.confirmIcon && this.json.confirmIcon.info) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.info + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABvBJREFUeNqsWF1sFFUUPndm9n+3W5aWLi2VGgJtgy3UEn6MQGI0GgmC0UgfTEjEBxPDA29qYqLGGOODifGBGGOUYOKDPIg2QgykWgUtP1WgLT+lFKFCf9l2uz+z83c9Z3p3u1u6u4Pxpqczd+7MPd8999xzvrPskb2fgsMW4NzaBpxvBsbWMWCrgUEdAKsA4HHO+R2wrOucmxe5qZ9Jjt3ovtX1eRznt0pN2ndof+5eKYcAJ34YJPlFvH3OFV7+uOyPgOQLg+wJAXP5gMkueifM9XTYzMw2W+mZnWbqHjDF09Pc8WFneur2kaHOjwbxewuB8VK6WCnLoCVexcsrnmWNW1zhKMiBKqdWBDM5CfrMKKh3+8+bWurw1W/f/gwfawstVdYyuNIGtMYBxqT9/lVbmRyIZMFlUeKfCdyiPi0WN02ScPdkvGX2KxJa0IOiVETbU0O/Ptr00getamzkY1R+lbAuZiV52fpnC4FY5lqQpPe80bX7/A2bmIRbQcpzggAQLFhaGiw1aV+5nqEPEQcjWDnAJJLLC57q1Ux2+9tATzwUXN40PH3j7Nj4hWMW6cbr4mDmLIJAals63Esbsk8LhFsGAkjBY3UaPN8M8HKbBGsiHBRmwK1pEy0kC+Pkf4eK/EtA8gTX8Mxs1Lukti9+6+IUAco3ROE24dZ4apo6XEvq57dkQbPQKtsQ575NleB1z30erQbYsMoApScJ3bd1kMRWLWw0r9/Ud+Ci72H3AMoMinGfZchZ0Ufe961Yz/LNvFBoi/ZuDMKaukoIBAIQDofB7XaD1+MGl8Thl6EMWkYq+r3srQAzfrc1VN8yG7t26k/UpGfNJ+WOL54ab30746TQMkuIBVuaaiAUCoHf7wdFUewr9ek5jZf8HucnPe7Q0j3R9t0tqNdtn4AsGIoj7sjKLbI3ZDtiKSEnvTyqgSzLhScB+/ScxsvNQXq8NY0twdrGF/DTYBYH/QtQQJN9lbZzlhOa7MRADHRDnB4h1KfnNO5kHtLnCkSeCERXR4V1QK5e98yTij/ypquyrug+Fwhu7+BoGsbjGngVCaoq3NA7PAuHT4/BjxdjUMrf8oUpqN/IRNGO/TM3e69QQFQo1zB3wN7PMokht+802Q/nUij/5MVyNnesJTnrAmUb6UXfacPb71ESCiU9CkxQBsxcfFHB0tXFjz2CkRQP5iw/AlIcgSG9sjfYiLc+CjMKZV8mk4GM0mBw/MDTUdjc4ANVVUHXdftk5AIWnqozf6tw8FQc44yz/EV6ZZe3XvgM9ogGUFwoYxmav7IyAitXLgNN0yCRSNiAcgHN5YJdyyU42N2LSzYdopHId6rmwdh8BBz4DMA7Ry7D71fG4d2OFjvQFVqOg2EY837lsGGADIhMIFGojIOpoWUMB2LCsd4RSGdKbKmjeYSgXgSeEoZnCjE0y8iEMa06Wgk3DQxOJiZvdFhJWsTRnVuGIxjL0CazGVWxqaKeaba5iLMZcoGu2Dg4BYPUA0/niEiWlkKc1TLUnXYQcjKBZZQd55azhaFeMNLx6xTwiHApRJ65oTleTdn3rAewDOpVY3cGcmCIxQfrPD3I6DYRuS5vGbPsuBOfISqiJyb7Jge6zmE3TVslUTmBCDs5miy3qqJCJ6CMItPMnbxSQvoyM2OnM9N3iWglbcsQW6dyAq2yW5Hk9rncUiQ3oSKT9hnjCTkwRd15DKb93DRwkQwToVw8R5Hl0CoDscE/TmI3jqLSBttnk+oaKiesTJIT4V5MuGHY5Ht7cxWk00jGrcL8RH16TuM2STcMKDYX6UlN3Dw+PdQzKMBoOdpJDH1qoOuvSOPWWklxt9krWkg3cTVv7NkAr+3aaFNNsko+n6G+z+eDra0PQU2lD37rv7MonSBfUaduHx0+/skXODqGEsvyYNsyoobRqK4xUrFOCkZ2vMgThqYPBUMQDAbtYJcPJCv0nMbpPXp/4Rw0L/pI12T/yW9Q36QAomU5cEFFiQWW0vDU6xu9kRVvuXwVO+wE+n81pB2Z+HjX1JXuQ1NzJ2i0aHVADbeLU4FFdY3s9vkll6eVAWcLa6cHFeQ/XL03cnTi0k9fYUVwgVQJXzGKVpTCfywqsBB9F5UTyDmq8aTVsP8Cgk5ZJjGQHL32NfkIBrjhPCA6uUfRijIfEO0l1TWKJ3gWnXoG61w/U1zRnFPC/VVjlvFRM9REH4aM7yYunfhy7PzRn4WzThC9pOFsrZ0PpuSvEOhDkiA+QWLxS5u2byPOSlSRGBoRI+IjRAMo+1LSo1xDIZ4iqwhocSGJcr9COCGITJw6AuUVpY1P9N2CGDFhHkOcDk2E+KQIaNS3Ck24uKIHaQRKFgBkIVIeGFJoCjHE1XI6+b8CDABnZtjY0mkIGQAAAABJRU5ErkJggg==)");
                    }
                    break;
                case "warn":
                    if (this.json.confirmIcon && this.json.confirmIcon.warn) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.warn + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABgtJREFUeNqsWG2IlFUUft6vmdlZd539GFdTY5VMomy1oBJUSPLXkmQt5I8gCIMK+iH0K4ooEvtTRP7JX9JKWCC1mUUkIkQKSoaZH60t2pboOK37Mc6Ozsw779t57t5xx5ndnTvhC4d373nnnnPuOeee85y1Jr+G6dNcCrBB6AnbQo9tY4UFLLYstIYhMsK/IjRULOF0voATx87jp60fICPygzmFbpn+26pnzK0ilrk2+kTp5kgC6+w4YDfJxpiQJ+QAYUmoKHQLCG4K5YDsCI7fzOPgcBr7172BP0VUILrC/22MnHSbvF6KLcRap1WMmGfsRQRZ2Z8BJv7BybEs9t6/DbuFXaj2VKUx7ize6BZvbHcdvB67D5bdrD/ocwUiruiLZPFGSbziiHci4iVPpEn41MM9pPZWPBofwiOX9uDh05fwkSgf5Dln8lKNZwo+HnRsvBVbjK1eJ39RdWIxJCfhGB0HxjNTBtGQhHiuPQHEY9MG3X5EbXEESA3i4KmL2Ln5Xfwi3CINmjVM9IjnYGeTGOJ2zOx+SU5cE8Hp/DMIopvgxFejlDsFO38IC6ID6JIDRCMz7/WvA1cG8d2PJ/H2y5/gLA2a9ndVmBia2CIxpL3yJ1XG5MUzTh8S3e/B9Zo09x74xSeRS7vyfT+i3sx7KXfRCvSuz2NUltuFJmhj+btdmazMEa+NsZidfIYlsQXzE51oa2tDV1eXenNNPr/PtZ/ylybxwtEP8Ypw4pU22OXrq27NvZIh4dzCeI07lvQiHo8jFovBdV315pp8fp9rP+VTT/cCPL/jRawSTqScma4OT1+sA2vtqN4w552V03meMsKyprLblowlj2s/qC+DepJLsWpjD56T5aDOnRI908yC5jTVOVEl1THWhKhPwrVx/UNYqL0DmyU+0iyVNWooKKxjTGgmh/o6k+h5tRcbhBNTDla9JtKAV+6SZ5RBondZF9YwOkKOq5qeZ6CkUpmJMQYP9Xa0YqX8ySRxXdV9bXMBloShnLg134RvhQ3IEr2tTViqc8ZxNQwwFuCJANsqiOJ4jSHke40cTPQ2RdFZNsYmHrEaiHVEmqI/drTGO+paC5/fTWVRghTaZl1ibJvAqG6hqqygIsG+/iXCID8VFk1ck+9Z5rKoV8BYThc9yyVCE2A0nyDJKOmEoiP98GV7mNwKO7EOwfjPwL9fKL7q2CUzWTRGANiILgghjRkKfTwAyxw4cWt4pR+F4X72NAn2FIxQzg4aECMtcmISl3WzDFxi1sDH046hZ4JQ45kbgmeyFXhGUGB7i8YzhgcTvbg2jiHCKPrTJXgmE56ZgKIoH5XGn/YEz3QLnpm/GrcmTiE9dkiOOaBuU9QzN+bsMM7dNoYo/qk1OC597vEahDbDU5BtuVbBMysr8ExS45lBV74LnjHwMhFjahRndn2rUN9NhsrmOEEUX/LNbgB/F13yLBJtyTvwDNfkNyLnj8s4dv5vBbQmVdcmWuc4IYl0MjC44jz0guWb0NLSojAMoQTfXJPvGNQs6hGvnNt7GIeFkyGk4hcVGM41HCcEZIV1ix53jJ+QieDOWKi18CN2fWOo58QF/PD5ETVPZXTO3IZ8Aeea9Dj2FOt4R7WDq1L0SlVFT9bke3WMofzf/8I3fTvwlXAYomy5IChj9AxT4FyTmsBBPyyXoVpSRe9qP8LfXkNw7ZAaIfnmmnwbs++l3AspHPl4APuEw2I3pr0S1owqMsO4B97BYz3L8eaiFvR6uHsPceWFNI7s/h6f7TqgblBq1umgPCRwwOJcc3EEe3NsOXN4yYRUkRQ5vw5j4P19+FQbkha6Ud04aiZK8Y6lS2ALxwmi+GQcqxyGKDT3RCBSSkKpLM4xWXWOjGi6UXeirDKI1yXOcYIonuC5s1lQoTbKKlPZCdYUBZpSGZxhHeH11bdmVOdIrnLWNv4vhPzQ1sBnHlE8wTMxK6EiERqBEfEIYQC7L5seew1LPCurLmgZTdl6/4UwaWmWzq2IRvHNGrNGNLmYdpCvb0dBl/hJXdAKJrOF1eClsHX4XP12NM+qGFJKmnz9NgYV/wkwAMYATK0QLuhAAAAAAElFTkSuQmCC)");
                    }
                    break;
                default:
                    if (this.json.confirmIcon && this.json.confirmIcon.warn) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.warn + ")");
                    }
                    break;
            }
            dlg.show();
        }.bind(this));
    },
    alert: function (type, title, text, width, height) {
        this.app.alert(type, "center", title, text, width, height);
    },
    notice: function (content, type, target, where, offset, option) {
        if (!where) where = { "x": "right", "y": "top" };
        //if (!target) target = this.node;
        if (!type) type = "ok";
        var type2;
        switch (type) {
            case "warn":
            case "wran":
                type2 = "notice";
                break;
            case "success":
                type2 = "ok";
                break;
            default:
                type2 = type;
        }
        var noticeTarget = target || ((layout.mobile && document && document.body) ? $(document.body) : this.app.window.content);
        var off = offset;
        if (!off) {
            off = {
                x: 10,
                y: where.y.toString().toLowerCase() == "bottom" ? 10 : 10
            };
        }
        var options = {
            type: type2,
            position: where,
            move: false,
            target: noticeTarget,
            delayClose: (type === "error") ? 10000 : 5000,
            //delayClose: 20000000,
            offset: off,
            content: content
        }
        if (this.json.noticeStyle) {
            options = Object.merge(options, this.json.noticeStyle);
        }
        if (this.json["notice" + type2.capitalize() + "Style"]) {
            options = Object.merge(options, this.json["notice" + type2.capitalize() + "Style"]);
        }
        if (option && typeOf(option) === "object") {
            options = Object.merge(options, option);
        }
        new mBox.Notice(options);
    },
    dialog: function( options ){
        if( !options )options = {};
        var opts = {
            "style" : options.style || "user",
            "title": options.title || "",
            "width": options.width || 300,
            "height" : options.height || 150,
            "isMax": o2.typeOf( options.isMax ) === "boolean" ? options.isMax : false,
            "isClose": o2.typeOf( options.isClose ) === "boolean"  ? options.isClose : true,
            "isResize": o2.typeOf( options.isResize ) === "boolean"  ? options.isResize : true,
            "isMove": o2.typeOf( options.isMove ) === "boolean"  ? options.isMove : true,
            "isTitle": o2.typeOf( options.isTitle ) === "boolean"  ? options.isTitle : true,
            "offset": options.offset || null,
            "mask": o2.typeOf( options.mask ) === "boolean"  ? options.mask : true,
            "container": options.container ||  ( layout.mobile ? $(document.body) : this.app.content ),
            "duration": options.duration || 200,
            "lp": options.lp || null,
            "zindex": ( options.zindex || 100 ).toInt(),
            "buttonList": options.buttonList || [
                {
                    "type": "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function(){
                        if(options.ok){
                            var flag = options.ok.call( this );
                            if( flag === true || o2.typeOf(flag) === "null" )this.close();
                        }else{
                            this.close();
                        }

                    }
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function(){
                        if(options.close){
                            var flag = options.close.call(this);
                            if( flag === true || o2.typeOf(flag) === "null" )this.close();
                        }else{
                            this.close();
                        }
                    }
                }
            ]
        };

        var positionNode;
        if( options.moduleName ){
            var module, name = options.moduleName, subformName = options.subformName;
            if( subformName && this.all[subformName +"_"+ name] ){
                module = this.all[subformName +"_"+ name];
            }else{
                module = this.all[name];
            }
            if( module ){
                opts.content = module.node;
                positionNode = new Element("div", {style:"display:none;"}).inject( opts.content, "before" );
            }
        }else if( options.content ) {
            opts.content = options.content;
            var parent = opts.content.getParent();
            if(parent)positionNode = new Element("div", {style:"display:none;"}).inject( opts.content, "before" );
        }
        if( options.url )opts.url = options.url;
        if( options.html )opts.html = options.html;
        if( options.text )opts.text = options.text;

        opts.onQueryClose = function(){
            if( positionNode && opts.content ){
                opts.content.inject( positionNode, "after" );
                positionNode.destroy();
            }
            if( o2.typeOf(options.onQueryClose) === "function" )options.onQueryClose.call( this );
        }
        if(opts.onPostClose)opts.onPostClose = options.onPostClose;
        if(opts.onQueryLoad)opts.onQueryLoad = options.onQueryLoad;
        if(opts.onPostLoad)opts.onPostLoad = options.onPostLoad;
        if(opts.onQueryShow)opts.onQueryShow = options.onQueryShow;
        if(opts.onPostShow)opts.onPostShow = options.onPostShow;

        for( var key in options ){
            if( !opts.hasOwnProperty( key ) ){
                opts[key] = options[key];
            }
        }
        var dialog;
        MWF.require("MWF.xDesktop.Dialog", function(){
            dialog = o2.DL.open(opts)
        }, null, false);
        return dialog;
    },
    addSplit: function () {
        if (!this.businessData.control["allowAddSplit"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 600;
            var height = 330;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            var dlg = new MWF.xDesktop.Dialog({
                "title": this.app.lp.addSplit,
                //"style": "work","
                "style": this.json.dialogStyle || "user",
                "top": p.y - 100,
                "left": p.x,
                "fromTop": p.y - 100,
                "fromLeft": p.x,
                "width": width,
                "height": height,
                "url": this.app.path + "split.html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            //this.doResetWork(dlg);
                            var input = dlg.content.getElement("input");
                            var checks = dlg.content.getElements(".o2_addSplit_radio");
                            var value = input.get("value");
                            var trimExist = true;
                            if (checks[1].checked) trimExist = false;

                            var opinion="";
                            var textarea = dlg.content.getElement(".addSplit_opinion");
                            if(textarea)opinion = textarea.get("value");

                            _self.doAddSplit(dlg, value, trimExist, opinion);
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostShow": function () {
                    //var okButton = dlg.content.getElement(".o2_addSplit_okButton");
                    //var cancelButton = dlg.content.getElement(".o2_addSplit_cancelButton");
                    var selectButton = dlg.content.getElement(".o2_addSplit_selector");
                    var input = dlg.content.getElement("input");
                    var checks = dlg.content.getElements(".o2_addSplit_radio");

                    //okButton.addEvent("click", function(){
                    //    var value = input.get("value");
                    //    var trimExist = true;
                    //    if (checks[1].checked) trimExist = false;
                    //    _self.doAddSplit(this, value, trimExist);
                    //}.bind(this));
                    //cancelButton.addEvent("click", function(){
                    //    this.close();
                    //}.bind(this));
                    selectButton.addEvent("click", function () {
                        var value = input.get("value");
                        MWF.xDesktop.requireApp("Selector", "package", function () {
                            new o2.O2Selector(_self.app.content, {
                                "type": "",
                                "count": 0,
                                "values": (value) ? value.split(o2.splitStr) : [],
                                "types": ["unit", "identity", "group", "role"],
                                "onComplete": function (items) {
                                    var v = [];
                                    items.each(function (item) {
                                        v.push(item.data.distinguishedName);
                                    });
                                    input.set("value", v.join(", "));
                                }
                            });
                        }.bind(this));
                        //_self.selectSplitUnit(this);
                    }.bind(this));
                }
            });
            dlg.show();
        }.bind(this));
    },
    doAddSplit: function (dlg, splitValues, trimExist, opinion) {
        if (!splitValues) {
            this.app.notice(MWF.xApplication.process.Xform.LP.inputSplitValue, "error", dlg.node);
            return false;
        }
        MWF.require("MWF.widget.Mask", function () {
            var splitValue = splitValues.split(o2.splitStr);

            var splitText = splitValue.map(function (sValue) {
                return sValue.split("@")[0];
            })
            var routeName = MWF.xApplication.process.Xform.LP.form.split+":"+splitText.join(", ");
            if(!opinion)opinion = routeName;

            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            var d = {splitValue:splitValue, trimExist:trimExist, opinion:opinion};
            this.fireEvent("beforeAddSplit", [d]);
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeAddSplit", [d]);

            this.addSplitWork(splitValue, trimExist, function (json) {
                this.fireEvent("afterAddSplit");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterAddSplit");
                this.addAddSplitMessage(json.data);
                // this.workAction.loadWork(function(workJson){
                //     this.fireEvent("afterAddSplit");
                //     if (this.app && this.app.fireEvent) this.app.fireEvent("afterAddSplit");
                //     this.addAddSplitMessage(workJson.data);
                // }.bind(this), null, this.businessData.work.id);
                dlg.close();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", dlg.node);
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), routeName, opinion);
        }.bind(this));
    },
    addSplitWork: function (splitValue, trimExist, success, failure, routeName, opinion) {
        var data = {
            "splitValueList": splitValue,
            "trimExist": trimExist,
            "routeName": routeName,
            "opinion": opinion
        };
        if (this.options.readonly) {
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id, data, function (json) {
                if (success) success(json);
            }.bind(this),
                function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                });
            // this.workAction.addSplit(
            //     function (json) {
            //         if (success) success(json);
            //     }.bind(this),
            //     function (xhr, text, error) {
            //         if (failure) failure(xhr, text, error);
            //     },
            //     this.businessData.work.id, data
            // );
        } else {
            this.saveFormData(
                function (json) {
                    o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id, data, function (json) {
                        if (success) success(json);
                    }.bind(this),
                        function (xhr, text, error) {
                            if (failure) failure(xhr, text, error);
                        });
                    // this.workAction.addSplit(
                    //     function (json) {
                    //         if (success) success(json);
                    //     }.bind(this),
                    //     function (xhr, text, error) {
                    //         if (failure) failure(xhr, text, error);
                    //     },
                    //     this.businessData.work.id, data
                    // );
                }.bind(this),
                function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                }, true, null, true
            );
        }

    },
    setRollBackChecked: function (item) {
        item.store("isSelected", true);
        item.setStyles(this.css.rollbackItemNode_current);

        item.getFirst().setStyles(this.css.rollbackItemIconNode_current);

        var node = item.getLast().getFirst();
        node.getFirst().setStyles(this.css.rollbackItemActivityNode_current);
        node.getLast().setStyles(this.css.rollbackItemTimeNode_current);

        node = item.getLast().getLast();
        node.getFirst().setStyles(this.css.rollbackItemTaskTitleNode_current);
        node.getLast().setStyles(this.css.rollbackItemTaskBodyNode_current);

        var checkeds = item.getElements("input");
        if (checkeds){
            checkeds.set("checked", true);
            checkeds.set("disabled", false);
        }
    },
    setRollBackUnchecked: function (item) {
        item.store("isSelected", false);
        item.setStyles(this.css.rollbackItemNode);

        item.getFirst().setStyles(this.css.rollbackItemIconNode);

        var node = item.getLast().getFirst();
        node.getFirst().setStyles(this.css.rollbackItemActivityNode);
        node.getLast().setStyles(this.css.rollbackItemTimeNode);

        node = item.getLast().getLast();
        node.getFirst().setStyles(this.css.rollbackItemTaskTitleNode);
        node.getLast().setStyles(this.css.rollbackItemTaskBodyNode);

        var checkeds = item.getElements("input");
        if (checkeds) {
            checkeds.set("checked", false);
            checkeds.set("disabled", true);
        }
    },
    getRollbackLogs: function (rollbackItemNode) {
        var _self = this;
        o2.Actions.load("x_processplatform_assemble_surface").WorkLogAction.listRollbackWithWorkOrWorkCompleted(this.businessData.work.id, function (json) {

            json.data.each(function (log) {
                //if (!log.splitting && log.connected && (log.taskCompletedList.length || log.readList.length || log.readCompletedList.length)) {
                if (!log.splitting && log.connected) {
                    var node = new Element("div", { "styles": this.css.rollbackItemNode }).inject(rollbackItemNode);
                    node.store("log", log);
                    var iconNode = new Element("div", { "styles": this.css.rollbackItemIconNode }).inject(node);
                    var contentNode = new Element("div", { "styles": this.css.rollbackItemContentNode }).inject(node);

                    var div = new Element("div", { "styles": { "overflow": "hidden" } }).inject(contentNode);
                    var activityNode = new Element("div", { "styles": this.css.rollbackItemActivityNode, "text": log.fromActivityName }).inject(div);
                    var timeNode = new Element("div", { "styles": this.css.rollbackItemTimeNode, "text": log.arrivedTime }).inject(div);
                    div = new Element("div", { "styles": { "overflow": "hidden" } }).inject(contentNode);
                    var taskTitleNode = new Element("div", { "styles": this.css.rollbackItemTaskTitleNode, "text": this.app.lp.taskCompletedPerson + ": " }).inject(div);

                    var taskBodyNode = new Element("div", {
                        "styles": this.css.rollbackItemTaskBodyNode
                    }).inject(div);

                    if (log.taskCompletedList.length) {
                        log.taskCompletedList.each(function (o) {
                            var itemNode = new Element("div", {
                                style: "float:left;overflow:hidden;"
                            }).inject(taskBodyNode);
                            var vfor = Math.random().toString();
                            var text = o2.name.cn(o.person) + "(" + o.completedTime + ")";
                            var check = new Element("input", {
                                "id": vfor,
                                "value": o.identity,
                                "type": "checkbox",
                                "disabled": true,
                                "styles": this.css.rollbackItemTaskCheckNode
                            }).inject(itemNode);
                            check.addEvent("click", function (e) {
                                e.stopPropagation();
                            });
                            var taskNode = new Element("label", { "styles": this.css.rollbackItemTaskNode, "text": text, "for": vfor }).inject(itemNode);
                            taskNode.addEvent("click", function (e) {
                                e.stopPropagation();
                            });
                        }.bind(this));
                    } else {
                        var text = this.app.lp.systemFlow;
                        var taskNode = new Element("div", { "styles": this.css.rollbackItemTaskNode, "text": text }).inject(taskBodyNode);
                    }



                    node.addEvents({
                        "mouseover": function () {
                            var isSelected = this.retrieve("isSelected");
                            if (!isSelected) this.setStyles(_self.css.rollbackItemNode_over);
                        },
                        "mouseout": function () {
                            var isSelected = this.retrieve("isSelected");
                            if (!isSelected) this.setStyles(_self.css.rollbackItemNode)
                        },
                        "click": function () {
                            var isSelected = this.retrieve("isSelected");
                            if (isSelected) {
                                _self.setRollBackUnchecked(this);
                            } else {
                                var items = rollbackItemNode.getChildren();
                                items.each(function (item) {
                                    _self.setRollBackUnchecked(item);
                                });
                                _self.setRollBackChecked(this);
                            }
                        }
                    });
                }
            }.bind(this));

        }.bind(this), null, false);

    },
    rollback: function () {
        if (!this.businessData.control["allowRollback"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        var lp = MWF.xApplication.process.Xform.LP;
        var node = new Element("div", { "styles": this.css.rollbackAreaNode });
        var html = "<div style=\"line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:left;\">"+lp.selectRollbackActivity+"</div>";
        //html += "<div style=\"line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:right;\"><input class='rollback_flowOption' checked type='checkbox' />"+lp.tryToProcess+"</div>";
        html += "<div style=\"clear:both; max-height: 300px; margin-bottom:10px; margin-top:10px; overflow-y:auto;\"></div>";
        node.set("html", html);
        if( layout.mobile ){
            node.getFirst().setStyle("float", "none");
            node.getFirst().getNext().setStyle("float", "none");
        }
        var rollbackItemNode = node.getLast();
        this.getRollbackLogs(rollbackItemNode);
        node.inject(this.app.content);

        var options = {
            "title": this.app.lp.rollback,
            "style": this.json.dialogStyle || "user",
            "isResize": false,
            "content": node,
            "width": layout.mobile ? "100%" : 600,
            "buttonList": [
                {
                    "type": "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function (d, e) {
                        this.doRollback(node, e, dlg);
                    }.bind(this)
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function () { dlg.close(); }
                }
            ]
        };
        if( layout.mobile ){
            options.height = '100%';
            options.container = $(document.body);
        }

        var dlg = o2.DL.open(options);
    },
    doRollback: function (node, e, dlg) {
        var rollbackItemNode = node.getLast();
        var items = rollbackItemNode.getChildren();
        //var flowOption = (node.getElement(".rollback_flowOption").checked);
        var _self = this;
        for (var i = 0; i < items.length; i++) {
            if (items[i].retrieve("isSelected")) {
                var text = this.app.lp.rollbackConfirmContent;
                var log = items[i].retrieve("log");
                var checks = items[i].getElements("input:checked");

                var idList = [];
                checks.each(function (check) {
                    var id = check.get("value");
                    if (idList.indexOf(id) == -1) idList.push(id);
                });

                text = text.replace("{log}", log.fromActivityName + "(" + log.arrivedTime + ")");
                this.app.confirm("infor", e, this.app.lp.rollbackConfirmTitle, text, 450, 120, function () {
                    _self.doRollbackAction(log.id, dlg, idList, log);

                    dlg.close();

                    this.close();
                }, function () {
                    this.close();
                }, null, null, this.json.confirmStyle);
                break;
            }
        }
    },

    doRollbackAction: function (log, dlg, idList, logObj) {
        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeRollback");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeRollback");

            this.doRollbackActionInvoke(log, idList, function (json) {
                if (json.data.properties) {
                    this.fireEvent("afterRollback");
                    if (this.app && this.app.fireEvent) this.app.fireEvent("afterRollback");
                    this.addRollbackMessage(json.data);

                    if (!this.app.inBrowser) this.app.close();
                    if (this.mask) { this.mask.hide(); this.mask = null; }
                } else {
                    var id = json.data.id;
                    this.workAction.listTaskByWork(function (workJson) {
                        this.fireEvent("afterRollback");
                        if (this.app && this.app.fireEvent) this.app.fireEvent("afterRollback");
                        this.addRollbackMessage_old(workJson.data);
                        //this.app.notice(MWF.xApplication.process.Xform.LP.rollbackOk+": "+MWF.name.cns(names).join(", "), "success");
                        //if (!this.app.inBrowser) this.app.close();

                        if (!this.app.inBrowser) this.app.close();
                        if (this.mask) { this.mask.hide(); this.mask = null; }
                    }.bind(this), null, id);
                }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error");
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), logObj);
        }.bind(this));
    },
    doRollbackActionInvoke: function (id, idList, success, failure, logObj) {
        var opinion = MWF.xApplication.process.Xform.LP.rollbackTo+":"+logObj.fromActivityName;
        if (this.businessData.work.completedTime) {
            var method = "rollbackWorkcompleted";
            o2.Actions.get("x_processplatform_assemble_surface")[method](this.businessData.work.id, {
                "workLog": id,
                "distinguishedNameList": idList,
                //"processing": !!flowOption,
                "opinion": opinion
            }, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error)
            }.bind(this));
        } else {
            var body = {
                "workLog": id,
                "distinguishedNameList": idList,
                //"processing": !!flowOption,
                "opinion": opinion
            }
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Rollback(this.businessData.work.id, body, function (json) {
                //o2.Actions.get("x_processplatform_assemble_surface")[method](this.businessData.work.id, { "workLog": id }, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error)
            }.bind(this));
        }

    },

    inBrowserDkg: function (content, notCloseWindow) {
        if (this.mask) this.mask.hide();

        if (this.json.submitedDlgUseNotice) {
            MWF.xDesktop.notice("success", { x: "right", y: "top" }, content);
            if (this.json.isPrompt !== false) {
                if (this.json.promptCloseTime != 0) {
                    var t = this.json.promptCloseTime || 2;
                    t = t.toInt() * 1000;
                    var _work = this;
                    window.setTimeout(function () { _work.app.close(); }, t);
                }
            } else {
                this.app.close();
            }
        } else {
            var div = new Element("div", { "styles": { "margin": "10px 10px 0px 10px", "padding": "5px", "overflow": "hidden" } }).inject(this.app.content);
            div.set("html", content);

            if (this.json.isPrompt !== false) {
                var options = {
                    "content": div,
                    "isTitle": false,
                    "width": 350,
                    "height": 180,
                    "buttonList": [
                        {
                            "text": MWF.xApplication.process.Xform.LP.ok,
                            "action": function () { dlg.close(); this.app.close(); }.bind(this)
                        }
                    ]
                }
                var size = this.app.content.getSize();
                switch (this.json.promptPosition || "righttop") {
                    case "lefttop":
                        options.top = 10;
                        options.left = 10;
                        options.fromTop = 10;
                        options.fromLeft = 10;
                        break;
                    case "righttop":
                        options.top = 10;
                        options.left = size.x - 360;
                        options.fromTop = 10;
                        options.fromLeft = size.x - 10;
                        break;
                    case "leftbottom":
                        options.top = size.y - 190;
                        options.left = 10;
                        options.fromTop = size.y - 10;
                        options.fromLeft = 10;
                        break;
                    case "rightbottom":
                        options.top = size.y - 190;
                        options.left = size.x - 360;
                        options.fromTop = size.y - 10;
                        options.fromLeft = size.x - 10;
                        break;
                    default:
                        delete options.top;
                        delete options.left;
                        delete options.fromTop;
                        delete options.fromLeft;
                }
                var dlg = o2.DL.open(options);
                if (this.json.promptCloseTime != 0) {
                    var t = this.json.promptCloseTime || 2;
                    t = t.toInt() * 1000;
                    var _work = this;
                    window.setTimeout(function () {
                        dlg.close();
                        if (notCloseWindow){
                            window.location.reload();
                        }else{
                            _work.app.close();
                        }
                    }, t);
                }
            } else {
                if (notCloseWindow){
                    window.location.reload();
                }else{
                    this.app.close();
                }
            }
        }
    },
    addRollbackMessage_old: function (data) {
        var users = [];
        data.each(function (task) {
            users.push(MWF.name.cn(task.person) + "(" + MWF.name.cn(task.unit) + ")");
        }.bind(this));
        var content = "<div><b>" + MWF.xApplication.process.Xform.LP.currentActivity + "<font style=\"color: #ea621f\">" + o2.txt(data[0].activityName) + "</font>, " + MWF.xApplication.process.Xform.LP.nextUser + "<font style=\"color: #ea621f\">" + users.join(", ") + "</font></b></div>";


        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workRollback,
                "content": "<div>" + MWF.xApplication.process.Xform.LP.rollbackWorkInfor + "“" + o2.txt(this.businessData.work.title) + "”</div>" + content
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg("<div>" + MWF.xApplication.process.Xform.LP.rollbackWorkInfor + "“" + o2.txt(this.businessData.work.title) + "”</div>" + content);
            }
        }
    },

    addRollbackMessage: function (data) {


        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workRollback,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rollbackWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rollbackWorkInfor));
            }
        }
    },

    /**
     * 需要判断权限
     * @summary 给待办人发送提醒(催促办理).
     * @example
     * if( this.workContext.getControl().allowPress ){ //判断流程节点是否设置了催办并且当前人员是否有催办权限
     *     this.form.getApp().appForm.pressWork();
     * }
     */
    pressWork: function (e) {
        if (e && e.setDisable) e.setDisable(true);
        o2.Actions.get("x_processplatform_assemble_surface").press(this.businessData.work.id, function (json) {
            var users = o2.name.cns(json.data.valueList).join(", ");
            this.app.notice(MWF.xApplication.process.Xform.LP.sendTaskNotice.replace("{users}", users), "success");
            if (e && e.setDisable) e.setDisable(false);
        }.bind(this), function (xhr, text, error) {
            //e.setDisable(false);
            if (xhr.status != 0) {
                var errorText = error;
                if (xhr) {
                    var json = JSON.decode(xhr.responseText);
                    if (json) {
                        errorText = json.message.trim() || "request json error";
                    } else {
                        errorText = "request json error: " + xhr.responseText;
                    }
                }
                MWF.xDesktop.notice("error", { x: "right", y: "top" }, errorText);
            }
        });
    },

    /**
     * @summary 退回到之前流转过的活动（根据活动配置列出可退回的活动）.
     * @example
     * this.form.getApp().appForm.goBack();
     */
    goBack: function(){
        if (!this.businessData.control["allowGoBack"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        if( !this.businessData.task ){
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, MWF.xApplication.process.Xform.LP.form.noTaskToReset);
            return false;
        }
        if (!this.formValidation('','')) {
            return false;
        }

        if (!this.checkUploadAttachment()) return false;

        o2.Actions.load('x_processplatform_assemble_surface').WorkAction.V2ListActivityGoBack(this.businessData.task.work, function(json){
            var activitys = json.data;
        // var activitys = [{
        //     name: "拟稿",
        //     activity: "123",
        //     way: "custom",
        //     lastModifyTime: "2023-01-23 12:34:12",
        //     lastIdentityList: ["张三", "李四"],
        //     activityTokenList: ["", ""]
        // },{
        //     name: "拟稿",
        //     activity: "345",
        //     way: "jump",
        //     lastModifyTime: "2023-01-23 12:34:12",
        //     lastIdentityList: ["王五六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六", "赵六六"],
        //     activityTokenList: ["", ""]
        // }];
            if (activitys.length){
                var h = this.app.content.getSize().y*0.7-271;
                var size = activitys.length*61;
                h = (size<h) ? size+271 : "70%";
                var _self = this;
                o2.DL.open({
                    "title": this.app.lp.goBack,
                    "style": this.json.dialogStyle || "user", //|| "work",
                    "width":   (layout.mobile) ? "100%" : 680,
                    "height":  (layout.mobile) ? "100%" : h,
                    "url": this.app.path + ( (layout.mobile) ? "goBackMobile" : "goBack") +".html",
                    "lp": o2.xApplication.process.Xform.LP.form,
                    "container": (layout.mobile) ? document.body : this.app.content,
                    "maskNode": this.app.content,
                    "offset": (layout.mobile) ? null : {y: -50},
                    "buttonList": [
                        {
                            "type": "ok",
                            "text": o2.LP.process.button.ok,
                            "action": function (d, e) {
                                _self.doGoBack(this, activitys);
                            }
                        },
                        {
                            "type": "cancel",
                            "text": MWF.LP.process.button.cancel,
                            "action": function () {
                                this.close();
                            }
                        }
                    ],
                    "onPostShow": function () {
                        var node = this.node.getElement('.activesArea');
                        activitys.forEach(function(a, i){
                            _self.createGoBackActivity(node, a, i);
                        });
                    }

                });
            }
        }.bind(this));
    },

    createGoBackActivity: function(area, activity, i){
        var item = new Element('div.item', {styles: this.css[layout.mobile ? 'goBack_activity_mobile' : 'goBack_activity']}).inject(area);

        var itemCheck = new Element('div', {styles: this.css.goBack_activity_check, html: "<input type='radio' name='goBackActivity' value='"+activity.activity+"' data-text='"+activity.name+"'/>"}).inject(item);
        var radio = itemCheck.getElement('input');

        var itemContent = new Element('div', {styles: this.css.goBack_activity_content}).inject(item);
        var html = activity.name + "<span style='color:#999999; font-size: 12px; margin-left: 10px'>("+activity.lastModifyTime+")</span>"
        var itemName = new Element('div', {styles: this.css.goBack_activity_name, html: html}).inject(itemContent);

        var ids = o2.name.cns(activity.lastIdentityList);
        var idsStr = (ids.length>8) ? ids.slice(0,8).join(', ')+' ...' : ids.join(', ');
        var itemInfo = new Element('div', {styles: this.css.goBack_activity_info, text: '处理人：'+idsStr, title: ids.join(',')}).inject(itemContent);


        item.addEvent("click", function(e){
            // var radio = this.getPrevious('div').getElement('input');

            var radio = this.getElement('input');
            radio.click();

            var items = area.getElements(".item");
            items.each(function(i){
                var actRadio = i.getFirst().getElement('input');
                var wayArea = i.getElement('.wayArea'); //i.getLast().getFirst();
                if (actRadio.checked){
                    if(wayArea)wayArea.getFirst().show();
                    i.addClass('lightColor_bg');
                }else{
                    if(wayArea)wayArea.getFirst().hide();
                    i.removeClass('lightColor_bg');
                }
            });

        });

        var wayRadio = "<div value='"+activity.way+"'></div>";
        if (activity.way==="custom"){
            wayRadio = "<div><div><label style='cursor: pointer'><input type='radio' checked name='"+activity.activity+"goBackWay' value='step'/>"+o2.xApplication.process.Xform.LP.form.goBackActivityWayStep+"</label></div>" +
                "<div><label style='cursor: pointer'><input type='radio' name='"+activity.activity+"goBackWay' value='jump'/>"+o2.xApplication.process.Xform.LP.form.goBackActivityWayJump+"</label></div></div>"
        }
        var itemWay = new Element('div.wayArea', {styles: this.css[ layout.mobile ? 'goBack_activity_way_mobile' : 'goBack_activity_way' ], html:wayRadio}).inject( layout.mobile ? itemContent : item);
        itemWay.getFirst().hide();
    },

    doGoBack: function(dlg, activitys){
        var node = dlg.node;
        var check = node.querySelector('input[name="goBackActivity"]:checked');

        if (!check) {
            this.app.notice(MWF.xApplication.process.Xform.LP.form.selectGoBackActivity, "error", dlg.node);
            return false;
        }

        var wayNode = check.getParent().getParent().getLast().getFirst();

        // var wayNode = node.getElement('.item').getLast().getFirst();
        var wayCheckNode = wayNode.querySelector('input:checked');
        var opinionNode = node.querySelector('textarea');

        var activity = check.value;
        var way = (wayCheckNode) ? wayCheckNode.value : wayNode.value;
        var opinion = opinionNode.value || o2.xApplication.process.Xform.LP.form.goBackTo+check.dataset.text;
        var decision = o2.xApplication.process.Xform.LP.form.goBack;


        this.businessData.task.decision = decision;
        this.businessData.task.opinion = opinion;
        this.businessData.task.action = "goBack";
        this.businessData.task.option = {
            "activity": activity,
            "way": way
        }

        var flowData = {routeName: "", opinion: opinion, activity:activity, way:way, userOpinion:opinionNode.value};
        if( !this.validationOtherFlow('goBack', opinionNode.value, null, flowData) ){
            if (this.mask) { this.mask.hide(); this.mask = null; }
            return;
        }

        this.submitWork(decision, opinion, null, function () {
            dlg.close();
        }.bind(this));
    },


    /**
     * @summary 将待办设置为挂起状态，不计算工作时长.
     * @example
     * this.form.getApp().appForm.pauseTask();
     */
    pauseTask: function (e) {
        if (!this.businessData.control["allowPause"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }

        if (this.businessData.task){
            if (e && e.disable) e.disable(true);
            return o2.Actions.get("x_processplatform_assemble_surface").pauseTask(this.businessData.task.id, function (json) {
                this.app.notice(MWF.xApplication.process.Xform.LP.pauseWork, "success");
                this.businessData.control["allowResume"] = true;
                if (e && e.enable) e.enable(false);
            }.bind(this), function (xhr, text, error) {
                //e.setDisable(false);
                if (xhr.status != 0) {
                    var errorText = error;
                    if (xhr) {
                        var json = JSON.decode(xhr.responseText);
                        if (json) {
                            errorText = json.message.trim() || "request json error";
                        } else {
                            errorText = "request json error: " + xhr.responseText;
                        }
                    }
                    MWF.xDesktop.notice("error", { x: "right", y: "top" }, errorText);
                }
            });
        }
    },

    /**
     * @summary 将待办从挂起状态恢复为正常状态.
     * @example
     * this.form.getApp().appForm.resumeTask();
     */
    resumeTask: function (e) {
        if (!this.businessData.control["allowResume"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        if (this.businessData.task){
            if (e && e.disable) e.disable(true);
            return o2.Actions.get("x_processplatform_assemble_surface").resumeTask(this.businessData.task.id, function (json) {
                this.app.notice(MWF.xApplication.process.Xform.LP.resumeWork, "success");
                this.businessData.control["allowPause"] = true;
                if (e && e.enable) e.enable(false);
            }.bind(this), function (xhr, text, error) {
                //e.setDisable(false);
                if (xhr.status != 0) {
                    var errorText = error;
                    if (xhr) {
                        var json = JSON.decode(xhr.responseText);
                        if (json) {
                            errorText = json.message.trim() || "request json error";
                        } else {
                            errorText = "request json error: " + xhr.responseText;
                        }
                    }
                    MWF.xDesktop.notice("error", { x: "right", y: "top" }, errorText);
                }
            });
        }
    },

    downloadAll: function (){
        if( this.options.readonly || this.json.isReadonly ){
            this._downloadAll();
        }else{
            this._downloadAllEditMode();
        }
    },
    _downloadAllEditMode: function (){
        var iframe;
        var downloadWithIframe = (appForm)=>{
            var html = appForm.app.content.get('html');
            setTimeout(()=>{
                this._downloadAll(html, ()=>{
                    iframe?.destroy();
                    if (this.mask) { this.mask.hide(); this.mask = null; }
                });
            }, 2000)
        }
        var openFormInIframe = ()=>{
            MWF.require("MWF.widget.Mask", null, false);
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);
            iframe = new Element('iframe', {
                src: `../x_desktop/${layout.mobile?'workmobile.html':'work.html'}?workid=${this.businessData.work.id}&readonly=true`,
                "width": "100%",
                "height": "100%",
                "frameborder": "0px",
                "scrolling": "auto",
                "seamless": "seamless",
                "styles": {
                    "position": "absolute",
                    "top": "0px",
                    "left": "0px",
                    "z-index": 2,
                    "background-color": "#fff"
                }
            }).inject(this.app.content);
            iframe.addEventListener('load', ()=>{
                var checkAppForm = function(){
                    if( !iframe.contentWindow?.layout?.app?.appForm ){
                        setTimeout(checkAppForm, 1000)
                    }else{
                        var appForm = iframe.contentWindow.layout.app.appForm;
                        if( appForm.isLoaded ){
                            downloadWithIframe(appForm)
                        }else{
                            appForm.addEvent('afterModulesLoad', ()=>{
                                downloadWithIframe(appForm)
                            })
                        }
                    }
                }
                setTimeout(checkAppForm, 100)
            });
        }

        var p = MWF.getCenterPosition(this.app.content, 300, 150);
        var event = {
            "event": {
                "x": p.x,
                "y": p.y - 200,
                "clientX": p.x,
                "clientY": p.y - 200
            }
        };
        var _self = this;
        this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.downloadAllTitle, "需要先保存表单，是否继续？", 300, 120, function () {
            _self.saveFormData(
                function(json){
                    openFormInIframe();
                }.bind(this),
                function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                });
                this.close();
        }, function () {
            this.close();
        }, null, null, this.json.confirmStyle);
    },
    _downloadAll: function (htmlString, callback) {

        var htmlFormId = "";
        var html = htmlString || this.app.content.get("html");
        var port = layout.port === "" ? "" : ":" + port;

        html = html.replace(/\.\.\/(x_|o2_)/g, "http://127.0.0.1" + port + "/$1");

        o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.uploadWorkInfo(this.businessData.work.id, "pdf", {
            "workHtml": encodeURIComponent(html),
            "pageWidth": 1000
        }, function (json) {
            htmlFormId = json.data.id;
            if(callback)callback();
        }.bind(this), null, false);
        htmlFormId = htmlFormId.replace("#", "%23");
        var url = "/x_processplatform_assemble_surface/jaxrs/attachment/batch/download/work/" + this.businessData.work.id + "/site/(0)/stream";
        url = o2.filterUrl(o2.Actions.getHost("x_processplatform_assemble_surface") + url);

        var downloadUrl = o2.filterUrl(url + "?fileName=&flag=" + htmlFormId);
        if ((o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC())) {
            var xtoken = layout.session.token;
            downloadUrl += "&" + o2.tokenName + "=" + xtoken;
        }
        window.open(downloadUrl);
    },
    monitor: function () {
        var node = new Element("div");
        var container = new Element("div").inject(node);
        var monitor;
        var monitorDlg = o2.DL.open({
            "style":  this.json.dialogStyle || "user",
            "title": MWF.xApplication.process.Xform.LP.monitor,
            "width": layout.mobile ? "100%" : "1100",
            "isResize" : !layout.mobile,
            "height" : layout.mobile ? "100%" : "720px",
            "maxHeightPercent" : layout.mobile ? "100%" : "98%",
            "mask": true,
            "isMax" : !layout.mobile,
            "content": node,
            "container": layout.mobile ? $(document.body) : this.app.content,
            "maskNode": layout.mobile ? $(document.body) : this.app.content,
            "onQueryClose": function(){

            }.bind(this),
            "buttonList": [
                {
                    "text": MWF.xApplication.process.Xform.LP.close,
                    "action": function(){
                        monitorDlg.close();
                    }.bind(this)
                }
            ],
            "onMax" : function(){
                monitor.logProcessChartNode.setStyle("height",this.contentHeight+"px");
                monitor.paperNode.setStyle("height",(this.contentHeight - 60)+"px");
            },
            "onRestore" : function(){
                monitor.logProcessChartNode.setStyle("height",this.contentHeight+"px");
                monitor.paperNode.setStyle("height",(this.contentHeight - 60)+"px");
            },
            "onPostShow": function(){

                var dlg = monitorDlg;
                var size = dlg.content.getSize();
                dlg.options.contentWidth = size.x;
                dlg.options.contentHeight = size.y; //+100;
                dlg.setContentSize();
                dlg.node.setStyles({
                    "height": ""+dlg.options.height+"px",
                    "width": ""+(dlg.options.width)+"px"
                });
                dlg.reCenter();
                dlg.content.setStyle("overflow","hidden");


                MWF.xDesktop.requireApp("process.Xform", "widget.Monitor", null, false);
                var process = (this.businessData.work) ? this.businessData.work.process : this.businessData.workCompleted.process;

                monitor = new MWF.xApplication.process.Xform.widget.Monitor(container, this.businessData.workLogList, this.businessData.recordList,process,{
                    onPostLoad : function(){
                        if( !layout.mobile ){
                            monitor.paperNode.setStyles({
                                "box-shadow":"none",
                                "margin-bottom" : "0px"
                            });
                            var logProcessChartNode =  monitor.logProcessChartNode;
                            logProcessChartNode.setStyle("border","0px");

                            logProcessChartNode.setStyle("height",(size.y) +"px");
                            monitor.paperNode.setStyle("height",(size.y-48)+"px");
                        }
                    }.bind(this),
                    onShowWorklog: function(logNode){
                        if(layout.mobile){
                            var pSize = this.paperNode.getSize();
                            var bodySize =  dlg.content.getSize();
                            if( this.paperNode.getPosition().y + pSize.y > bodySize.y ){
                                dlg.content.setStyle("position", "relative");
                                logNode.inject( dlg.content );
                                logNode.setStyles({
                                    "display": "block",
                                    "position": "absolute",
                                    "width": "calc( 100% - 28px )",
                                    "max-width": "500px",
                                    "bottom": "1px",
                                    "left": "0px"
                                });
                                logNode.setStyle("left", (bodySize.x - logNode.getSize().x)/2 + "px");
                            }
                        }
                    }
                });

            }.bind(this)
        });

    },
    resetWork: function () {
        if (!this.businessData.control["allowReset"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        if (!this.checkUploadAttachment()) return false;

        if( !this.businessData.task ){
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, MWF.xApplication.process.Xform.LP.form.noTaskToReset);
            return false;
        }
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 680;
            var height = 300;
            var p;
            if(!layout.mobile)p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            o2.DL.open({
                "title": this.app.lp.reset,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": (layout.mobile) ? 0 : (p.y - 100),
                "left": (layout.mobile) ? 0 : p.x,
                "fromTop": (layout.mobile) ? 0 : (p.y - 100),
                "fromLeft": (layout.mobile) ? 0 : p.x,
                "width": (layout.mobile) ? "100%" : width,
                "height": (layout.mobile) ? "100%" : height,
                "url": this.app.path + ( (layout.mobile) ? "resetMobile" : "reset") + ".html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": (layout.mobile) ? document.body : this.app.content,
                "isClose": !(layout.mobile),
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            _self.doResetWork(this);
                        }
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { this.close(); }
                    }
                ],
                "onPostShow": function () {
                    //$("resetWork_okButton").addEvent("click", function(){
                    //    _self.doResetWork(this);
                    //}.bind(this));
                    //$("resetWork_cancelButton").addEvent("click", function(){
                    //    this.close();
                    //}.bind(this));

                    $("resetWork_selPeopleButton").addEvent("click", function () {
                        _self.selectPeople(this);
                    }.bind(this));
                }
            });
        }.bind(this));
    },
    selectPeople: function(dlg){
        // o2.Actions.get("x_processplatform_assemble_surface").listTaskByWork(this.businessData.work.id, function(json){
            var identityList = [];
            // json.data.each(function(task){
            //     identityList.push(task.identity);
            // });
            this._selectPeople(dlg, identityList);
        // }.bind(this))
    },
    _selectPeople: function (dlg, exclude) {
        var range = this.businessData.activity.resetRange || "department";
        var count = this.businessData.activity.resetCount || 0;
        switch (range) {
            case "unit":
                this.selectPeopleUnit(dlg, this.businessData.task.unitDn, count, null,  exclude);
                // this.personActions.getDepartmentByIdentity(function(json){
                //     this.selectPeopleDepartment(dlg, json.data, count);
                // }.bind(this), null, this.businessData.task.identity);
                break;
            case "topUnit":
                MWF.require("MWF.xScript.Actions.UnitActions", function () {
                    orgActions = new MWF.xScript.Actions.UnitActions();
                    var data = { "unitList": [this.businessData.task.unitDn] };
                    orgActions.listUnitSupNested(data, function (json) {
                        v = json.data[0];
                        this.selectPeopleUnit(dlg, v, count, null, exclude);
                    }.bind(this));
                }.bind(this));
                // this.personActions.getCompanyByIdentity(function(json){
                //     this.selectPeopleCompany(dlg, json.data, count)
                // }.bind(this), null, this.businessData.task.identity);
                break;
            case "script":
                o2.Actions.load("x_processplatform_assemble_surface").ProcessAction.getActivity(this.businessData.work.activity, "manual", function (activityJson) {
                    var scriptText = activityJson.data.activity.resetRangeScriptText;
                    if (!scriptText) return;
                    var resetRange = this.Macro.exec(activityJson.data.activity.resetRangeScriptText, this);
                    this.selectPeopleUnit(dlg, "", count, resetRange, exclude);
                }.bind(this))
                break;
            default:
                this.selectPeopleAll(dlg, count);
        }
    },
    selectPeopleUnit: function (dlg, unit, count, include, exclude) {
        var names = dlg.identityList || [];
        var areaNode = $("resetWork_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "count": count,
            "units": (unit) ? [unit] : [],
            "onComplete": function (items) {
                areaNode.empty();
                var identityList = [];
                items.each(function (item) {
                    new MWF.widget.O2Identity(item.data, areaNode, { "style": "reset" });
                    identityList.push(item.data.distinguishedName);
                }.bind(this));
                dlg.identityList = identityList;
            }.bind(this)
        };
        if (include) {
            options.noUnit = true;
            options.include = typeOf(include) === "array" ? include : [include];
        }
        if( exclude ){
            options.exclude = exclude;
        }
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));

    },
    selectPeopleAll: function (dlg, count) {
        var names = dlg.identityList || [];
        var areaNode = $("resetWork_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "count": count,
            "onComplete": function (items) {
                areaNode.empty();
                var identityList = [];
                items.each(function (item) {
                    new MWF.widget.O2Identity(item.data, areaNode, { "style": "reset" });
                    identityList.push(item.data.distinguishedName);
                }.bind(this));
                dlg.identityList = identityList;
            }.bind(this)
        };
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));

    },


    doResetWork: function (dlg) {
        var names = dlg.identityList || [];
        if (!names.length) {
            this.app.notice(MWF.xApplication.process.Xform.LP.inputResetPeople, "error", dlg.node);
            return false;
        }
        var opinion = $("resetWork_opinion").get("value");
        // var checkbox = dlg.content.getElement(".resetWork_keepOption");
        // var keep = (checkbox.checked);

        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            var data = {routeName: "", opinion: opinion, names:names, userOpinion:opinion};

            if( !this.validationOtherFlow('reset', opinion, null, data) ){
                if (this.mask) { this.mask.hide(); this.mask = null; }
                return;
            }

            this.fireEvent("beforeReset", data);
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeReset");

            this.resetWorkToPeson(names, opinion, "", function (workJson) {
                //this.workAction.loadWork(function (workJson) {
                this.fireEvent("afterReset", data);
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterReset");
                this.addResetMessage(workJson.data);
                //this.app.notice(MWF.xApplication.process.Xform.LP.resetOk + ": " + MWF.name.cns(names).join(", "), "success");
                if (!this.app.inBrowser) this.app.close();
                //}.bind(this), null, this.businessData.work.id);
                dlg.close();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", dlg.node);
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this));
        }.bind(this));

        //var data = {
        //    "opinion": opinion,
        //    "routeName": MWF.xApplication.process.Xform.LP.reset,
        //    "identityList": names
        //}
        //
        //this.workAction.resetWork(function(json){
        //
        //}.bind(this), null, this.businessData.task.id, data);
    },
    resetWorkToPeson: function (identityList, opinion, routeName, success, failure) {

        var nameText = [];
        (identityList || []).each(function (n) { nameText.push(MWF.name.cn(n)); });
        if (!opinion) {
            opinion = MWF.xApplication.process.Xform.LP.resetTo + ": " + nameText.join(", ");
        }

        var n = nameText.length > 3 ? (nameText[0]+"、"+nameText[1]+"、"+nameText[2]+"...") : nameText.join(", ");
        if(!routeName)routeName = MWF.xApplication.process.Xform.LP.resetTo+":"+n;

        var data = {
            "opinion": opinion,
            "routeName": routeName,
            "identityList": identityList,
            //"keep": !!keep
        };
        this.saveFormData(
            function (json) {
                o2.Actions.load("x_processplatform_assemble_surface").TaskAction.V2Reset(
                    //this.workAction.resetWork(
                    function (json) {
                        if (success) success(json);
                    }.bind(this),
                    function (xhr, text, error) {
                        if (failure) failure(xhr, text, error);
                    },
                    this.businessData.task.id, data
                );
            }.bind(this),
            function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            }, true, null, true
        );
    },
    addAddSplitMessage: function (data) {
        // var content = "";
        // if (data && data.length) {
        //     data.each(function (work) {
        //         var users = [];
        //         work.taskList.each(function (task) {
        //             users.push(MWF.name.cn(task.person) + "(" + MWF.name.cn(task.unit) + ")");
        //         }.bind(this));
        //         content += "<div><b>" + MWF.xApplication.process.Xform.LP.nextActivity + "<font style=\"color: #ea621f\">" + work.activityName + "</font>, " + MWF.xApplication.process.Xform.LP.nextUser + "<font style=\"color: #ea621f\">" + users.join(", ") + "</font></b></div>";
        //     }.bind(this));
        // } else {
        //     content += MWF.xApplication.process.Xform.LP.workCompleted;
        // }

        if (layout.desktop.message) {
            //var content = "<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+"<font style=\"color: #ea621f\">"+data.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+"<font style=\"color: #ea621f\">"+users.join(", ")+"</font></b></div>";
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.addSplitWork,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.addSplitWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.addSplitWorkInfor));
            }
        }
    },
    addResetMessage: function (data) {
        // var content = "";
        // if (data.completed){
        //     content += MWF.xApplication.process.Xform.LP.workCompleted;
        // }else{
        //     if (data.properties.nextManualList && data.properties.nextManualList.length){
        //         var activityUsers = [];
        //         data.properties.nextManualList.each(function(a){
        //             var ids = [];
        //             a.taskIdentityList.each(function(i){
        //                 ids.push(o2.name.cn(i))
        //             });
        //             var t = "<b>"+MWF.xApplication.process.Xform.LP.nextActivity + "</b><span style='color: #ea621f'>"+a.activityName+"</span>；<b>"+ MWF.xApplication.process.Xform.LP.nextUser+ "</b><span style='color: #ea621f'>"+ids.join(",")+"</span>";
        //             activityUsers.push(t);
        //         });
        //         content += activityUsers.join("<br>");
        //     }else{
        //         content += MWF.xApplication.process.Xform.LP.taskCompleted;
        //     }
        // }

        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workReset,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.resetWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.resetWorkInfor));
            }
        }
    },

    retractWork: function (e, ev) {
        var _self = this;
        if (this.json.mode == "Mobile") {
            //window.confirm 在ios移动端不可用 ??
            // if (window.confirm(MWF.xApplication.process.Xform.LP.retractText)) {

            var p = MWF.getCenterPosition(document.body, 300, 150);
            console.log("position x:" + p.x + " , y:" + p.y);
            var x = p.x;
            if (p.x < 20) {
                x = 20;
            } else {
                x = p.x;
            }
            var event = {
                "event": {
                    "x": x,
                    "y": p.y - 200,
                    "clientX": x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.retractTitle, MWF.xApplication.process.Xform.LP.retractText, 300, 120, function () {
                _self.app.content.mask({
                    "style": {
                        "background-color": "#999",
                        "opacity": 0.6
                    }
                });

                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.fireEvent("beforeRetract");
                    if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeRetract");

                    _self.doRetractWork(function () {
                        //_self.workAction.getJobByWork(function(workJson){
                        _self.fireEvent("afterRetract");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterRetract");
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workRetract, "success");
                        _self.app.content.unmask();
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }

                        _self.finishOnMobile();
                    }.bind(this), function (xhr, text, error) {
                        _self.app.content.unmask();
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                    });
                }.bind(this));
            }, function () {
                this.close();
            }, null, null, this.json.confirmStyle);





        } else {
            var p = MWF.getCenterPosition(this.app.content, 300, 150);
            var event = {
                "event": {
                    "x": p.x,
                    "y": p.y - 200,
                    "clientX": p.x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.retractTitle, MWF.xApplication.process.Xform.LP.retractText, 300, 120, function () {
                _self.app.content.mask({
                    "style": {
                        "background-color": "#999",
                        "opacity": 0.6
                    }
                });

                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.fireEvent("beforeRetract");
                    if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeRetract");

                    _self.doRetractWork(function (json) {
                        //_self.workAction.getJobByWork(function(workJson){
                        _self.fireEvent("afterRetract");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterRetract");
                        //_self.addRetractMessage(json.data);
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workRetract, "success");
                        _self.app.content.unmask();
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                        _self.app.reload();
                        //}, null, _self.businessData.work.id);
                        this.close();
                    }.bind(this), function (xhr, text, error) {
                        _self.app.content.unmask();
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                    });
                }.bind(this));

                //this.close();
            }, function () {
                this.close();
            }, null, null, this.json.confirmStyle);
        }
    },
    doRetractWork: function (success, failure) {
        if (this.businessData.control["allowRetract"]) {
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Retract(this.businessData.work.id, null, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            });
            // this.workAction.retractWork(function (json) {
            //     if (success) success();
            // }.bind(this), function (xhr, text, error) {
            //     if (failure) failure(xhr, text, error);
            // }, this.businessData.work.id);
        } else {
            if (failure) failure(null, "Permission Denied", "");
        }
    },
    addRetractMessage: function (data) {
        // var users = [];
        // data.taskList.each(function (task) {
        //     users.push(MWF.name.cn(task.person) + "(" + MWF.name.cn(task.unit) + ")");
        // }.bind(this));
        // var content = "<div><b>" + MWF.xApplication.process.Xform.LP.currentActivity + "<font style=\"color: #ea621f\">" + data.work.activityName + "</font>, " + MWF.xApplication.process.Xform.LP.nextUser + "<font style=\"color: #ea621f\">" + users.join(", ") + "</font></b></div>";

        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workRetract,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.retractWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.retractWorkInfor));
            }
        }
    },
    /**
     * 如果当前人员没有调度权限或者流程节点未配置调度，则提醒Permission Denied.
     * @summary 弹出调度界面
     * @example
     * this.form.getApp().appForm.rerouteWork();
     */
    rerouteWork: function (e, ev) {
        if (!this.businessData.control["allowReroute"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        if (!this.checkUploadAttachment()) return false;

        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 660;
            var height = 350;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            var dlg = new MWF.xDesktop.Dialog({
                "title": this.app.lp.reroute,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": p.y - 100,
                "left": p.x,
                "fromTop": p.y - 100,
                "fromLeft": p.x,
                "width": width,
                "height": height,
                "url": this.app.path + "reroute.html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": this.app.content,
                "maskNode": this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            _self.doRerouteWork(dlg);
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostShow": function () {
                    o2.Actions.load("x_processplatform_assemble_surface").JobAction.findWorkWorkCompleted( _self.businessData.work.job, function(json){
                        if( json.data.workList && json.data.workList.length > 1 ){
                            var checkbox = this.node.getElement(".rerouteWork_mergeWork");
                            if(checkbox)checkbox.getParent().getParent().show();
                        }
                    }.bind(this));

                    var select = $("rerouteWork_selectActivity");
                    var createActivityOption = function(list, name){
                        list.each(function (activity) {
                            var activityType = name.replace("List", "");
                            var op = new Element("option", {
                                "value": activity.id + "#"+activityType,
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));
                    }
                    _self.workAction.getRerouteTo(_self.businessData.work.process, function (json) {
                        [
                            "agentList",
                            "cancelList",
                            "choiceList",
                            "delayList",
                            "embedList",
                            "publishList",
                            "endList",
                            "invokeList",
                            "manualList",
                            "mergeList",
                            "parallelList",
                            "serviceList",
                            "splitList"
                        ].forEach(function(name){
                            createActivityOption(json.data[name], name);
                        });
                    }.bind(_self));

                    var selPeopleButton = this.content.getElement(".rerouteWork_selPeopleButton");
                    selPeopleButton.addEvent("click", function () {
                        _self.selectReroutePeople(this);
                    }.bind(this));
                }
            });
            dlg.show();
        }.bind(this));
    },
    selectReroutePeople: function (dlg) {
        var names = dlg.identityList || [];
        var areaNode = dlg.content.getElement(".rerouteWork_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "count": 0,
            "title": this.app.lp.reroute,
            "onComplete": function (items) {
                areaNode.empty();
                var identityList = [];
                items.each(function (item) {
                    new MWF.widget.O2Identity(item.data, areaNode, { "style": "reset" });
                    identityList.push(item.data.distinguishedName);
                }.bind(this));
                dlg.identityList = identityList;
            }.bind(this)
        };
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));
    },
    doRerouteWork: function (dlg) {
        var opinion = $("rerouteWork_opinion").get("value");
        var select = $("rerouteWork_selectActivity");

        var checkbox = dlg.node.getElement(".rerouteWork_mergeWork");
        var mergeWork = !!(checkbox && checkbox.checked);

        var activity = select.options[select.selectedIndex].get("value");
        var activityName = select.options[select.selectedIndex].get("text");
        var tmp = activity.split("#");
        activity = tmp[0];
        var type = tmp[1];


        var nameArr = [];
        var names = dlg.identityList || [];
        names.each(function (n) { nameArr.push(n); });

        var nameCNs = names.map(function(id){
            return o2.name.cn(id);
        });

        var routeName = MWF.xApplication.process.Xform.LP.rerouteTo + activityName;
        if( nameArr.length ){
            routeName += ":" + nameCNs.join(", ");
        }

        if( !opinion )opinion = routeName;

        //var nameText = nameArr.join(", ");
        // if (!opinion) {
        //     opinion = MWF.xApplication.process.Xform.LP.resetTo + ": " + nameText.join(", ");
        // }

        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeReroute");
            if (this.app && this.app.fireEvent) this.app.fireEvent("afterRetract");

            this.rerouteWorkToActivity(activity, type, opinion, nameArr, function (workJson) {
                //this.workAction.loadWork(function (workJson) {
                this.fireEvent("afterReroute");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterReroute");
                this.addRerouteMessage(workJson.data);
                this.app.notice(MWF.xApplication.process.Xform.LP.rerouteOk + ": " + activityName, "success");
                if (!this.app.inBrowser) this.app.close();
                //}.bind(this), null, this.businessData.work.id);
                dlg.close();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", dlg.node);
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), mergeWork, routeName);
        }.bind(this));
    },
    rerouteWorkToActivity: function (activity, type, opinion, nameArr, success, failure, mergeWork, routeName) {
        var body = {
            "activity": activity,
            "activityType": type,
            "mergeWork": mergeWork || false,
            "distinguishedNameList": nameArr,
            "routeName": routeName,
            "opinion": opinion
        };
        if (this.businessData.task) {
            this.saveFormData(function (json) {
                o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id, body, function (json) {
                    if (success) success(json);
                }.bind(this), function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                });
                // this.workAction.rerouteWork(function (json) {
                //     if (success) success();
                // }.bind(this), function (xhr, text, error) {
                //     if (failure) failure(xhr, text, error);
                // }, this.businessData.work.id, activity, type);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            }, true, null, true);
        } else {
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id, body, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            });

            // this.workAction.rerouteWork(function (json) {
            //     if (success) success();
            // }.bind(this), function (xhr, text, error) {
            //     if (failure) failure(xhr, text, error);
            // }, this.businessData.work.id, activity, type);
        }
    },
    addRerouteMessage: function (data) {

        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workReroute,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rerouteWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rerouteWorkInfor));
            }
        }
    },

    deleteDraftWork: function () {
        var _self = this;
        if (this.json.mode === "Mobile") {
            var p = MWF.getCenterPosition(document.body, 300, 150);
            console.log("position x:" + p.x + " , y:" + p.y);
            var x = p.x;
            if (p.x < 20) {
                x = 20;
            } else {
                x = p.x;
            }
            var event = {
                "event": {
                    "x": x,
                    "y": p.y - 200,
                    "clientX": x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText.text, 300, 120, function () {
                _self.app.content.mask({
                    "style": {
                        "background-color": "#999",
                        "opacity": 0.6
                    }
                });
                // if (window.confirm(MWF.xApplication.process.Xform.LP.deleteWorkText.text)) {
                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.doDeleteWork(function () {
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + o2.txt(_self.businessData.work.title) + "”", "success");
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                        _self.finishOnMobile()
                    }.bind(this), function (xhr, text, error) {
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                    }.bind(this));
                }.bind(this));
            }, function () {
                this.close();
            }, null, null, this.json.confirmStyle);
        } else {
            var p = MWF.getCenterPosition(this.app.content, 380, 150);
            var event = {
                "event": {
                    "x": p.x,
                    "y": p.y - 200,
                    "clientX": p.x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText, 380, 120, function () {
                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.doDeleteWork(function () {
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + _self.businessData.work.title + "”", "success");
                        _self.app.close();
                        this.close();
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                    }.bind(this), function (xhr, text, error) {
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                    }.bind(this));
                }.bind(this));
            }, function () {
                this.close();
            }, null, this.app.content, this.json.confirmStyle);
        }
    },
    deleteWork: function () {
        if (!this.businessData.work.startTime) {
            this.deleteDraftWork();
        } else {
            var _self = this;
            if (this.json.mode === "Mobile") {
                var p = MWF.getCenterPosition(document.body, 300, 150);
                console.log("position x:" + p.x + " , y:" + p.y);
                var x = p.x;
                if (p.x < 20) {
                    x = 20;
                } else {
                    x = p.x;
                }
                var event = {
                    "event": {
                        "x": x,
                        "y": p.y - 200,
                        "clientX": x,
                        "clientY": p.y - 200
                    }
                };
                this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText.text, 300, 120, function () {
                    _self.app.content.mask({
                        "style": {
                            "background-color": "#999",
                            "opacity": 0.6
                        }
                    });
                    // if (window.confirm(MWF.xApplication.process.Xform.LP.deleteWorkText.text)) {
                    MWF.require("MWF.widget.Mask", function () {
                        _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                        _self.mask.loadNode(_self.app.content);

                        _self.fireEvent("beforeDelete");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeDelete");

                        _self.doDeleteWork(function () {
                            _self.fireEvent("afterDelete");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterDelete");
                            _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + o2.txt(_self.businessData.work.title) + "”", "success");
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                            _self.finishOnMobile()
                        }.bind(this), function (xhr, text, error) {
                            var errorText = error + ":" + text;
                            if (xhr) errorText = xhr.responseText;
                            _self.app.notice("request json error: " + errorText, "error", dlg.node);
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                        }.bind(this));
                    }.bind(this));
                }, function () {
                    this.close();
                }, null, this.app.content, this.json.confirmStyle);
            } else {
                var p = MWF.getCenterPosition(this.app.content, 380, 150);
                var event = {
                    "event": {
                        "x": p.x,
                        "y": p.y - 200,
                        "clientX": p.x,
                        "clientY": p.y - 200
                    }
                };
                this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText, 380, 120, function () {
                    // _self.app.content.mask({
                    //    "style": {
                    //        "background-color": "#999",
                    //        "opacity": 0.6
                    //    }
                    // });


                    MWF.require("MWF.widget.Mask", function () {
                        _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                        _self.mask.loadNode(_self.app.content);

                        _self.fireEvent("beforeDelete");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeDelete");

                        _self.doDeleteWork(function () {
                            _self.fireEvent("afterDelete");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterDelete");
                            _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + o2.txt(_self.businessData.work.title) + "”", "success");
                            _self.app.close();
                            this.close();
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                        }.bind(this), function (xhr, text, error) {
                            var errorText = error + ":" + text;
                            if (xhr) errorText = xhr.responseText;
                            _self.app.notice("request json error: " + errorText, "error", dlg.node);
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                        }.bind(this));
                    }.bind(this));


                    //_self.workAction.deleteWork(function(json){
                    //    _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+_self.businessData.work.title+"”", "success");
                    //    _self.app.close();
                    //    this.close();
                    //}.bind(this), null, _self.businessData.work.id);
                    //this.close();
                }, function () {
                    this.close();
                }, null, this.app.content, this.json.confirmStyle);
            }
        }
    },
    doDeleteDraftWork: function (success, failure) {
        this.workAction.deleteDraftWork(function (json) {
            if (success) success(json);
        }.bind(this), function (xhr, text, error) {
            if (failure) failure(xhr, text, error);
        }, this.businessData.work.id);
    },
    doDeleteWork: function (success, failure) {
        if (!this.businessData.work.startTime) {
            this.doDeleteDraftWork(success, failure);
        } else {
            if (this.businessData.control["allowDelete"]) {
                //this.workAction.deleteWork(function (json) {
                this.workAction.abandoned(function (json) {
                    if (success) success(json);
                }.bind(this), function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                }, this.businessData.work.id);
            //}
            }else {
                if (failure) failure(null, "Permission Denied", "");
            }
        }
    },

    //printWork: function(){
    //    var form = this.json.id;
    //    if (this.json.printForm){
    //        form = this.json.printForm;
    //    }
    //    window.open("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+form);
    //},
    printWork: function (app, form) {
        var application = app || (this.businessData.work) ? this.businessData.work.application : this.businessData.workCompleted.application;
        var form = form;
        if (!form || form === "none") {
            form = this.json.id;
            if (this.json.printForm && this.json.printForm!=="none" ) form = this.json.printForm;
        }
        if (this.businessData.workCompleted) {
            var application = app || this.businessData.workCompleted.application;
            var url = o2.filterUrl("../x_desktop/printWork.html?workCompletedId=" + this.businessData.workCompleted.id + "&app=" + application + "&form=" + form);
            if ((o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC())) {
                var xtoken = layout.session.token;
                url += "&" + o2.tokenName + "=" + xtoken;
            }
            window.open(url);
        } else {
            var application = app || this.businessData.work.application;
            var url = o2.filterUrl("../x_desktop/printWork.html?workid=" + this.businessData.work.id + "&app=" + application + "&form=" + form);
            if ((o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC())) {
                var xtoken = layout.session.token;
                url += "&" + o2.tokenName + "=" + xtoken;
            }
            window.open(url);
        }
    },
    /**
     * @summary 将当前处理人的待阅设置为已阅.
     * @param {Event|Element} [e] - Event 或者Mootools Element，指定提示框弹出的位置
     * @example
     * if( this.workContext.getControl().allowReadProcessing ){ //是否有待阅
     *     this.form.getApp().appForm.readedWork();
     * }
     */
    readedWork: function (e) {
        if (!this.businessData.control["allowReadProcessing"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        MWF.require("MWF.xDesktop.Dialog", function () {
            // 判断是否在移动端
            var content = layout.mobile ? $(document.body) : this.app.content || $(document.body);
			var size = content.getSize();

            var width = 680;
            var height = 300;
            if (layout.mobile) {
                width = size.x - 40;
            }

            var p = MWF.getCenterPosition(content, width, height);

            var _self = this;

            //"您确定要将“" + title + "”标记为已阅吗？";
            var title = o2.txt(this.businessData.work.title);
            var text = MWF.xApplication.process.Xform.LP.setReadedConfirmContent.replace("{title}",title);
            MWF.xApplication.process.Xform.LP.form.setReadedConfirmInfo = text;

            var dlg = new MWF.xDesktop.Dialog({
                "title": MWF.xApplication.process.Xform.LP.setReadedConfirmTitle,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": layout.mobile ? p.y : p.y - 100,
                "left": p.x,
                "fromTop": layout.mobile ? p.y : p.y - 100,
                "fromLeft": p.x,
                "width": width,
                "height": height,
                "url": this.app.path + ( layout.mobile ? "readedmobile.html" : "readed.html" ),
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": layout.mobile ? content : this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            this.doReadedWork(dlg);
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ]
            });
            dlg.show();
        }.bind(this));

        // if( !e )e = new Event(event);
        // this.fireEvent("beforeReaded");
        // var _self = this;
        // var title = this.businessData.work.title;
        // if (title.length > 75) {
        //     title = title.substr(0, 74) + "..."
        // }
        // //"您确定要将“" + title + "”标记为已阅吗？";
        // var text = MWF.xApplication.process.Xform.LP.setReadedConfirmContent.replace("{title}",title);
        //
        // this.app.confirm("infor", e,  MWF.xApplication.process.Xform.LP.setReadedConfirmTitle, text, 300, 120, function () {
        //     var confirmDlg = this;
        //     var read = null;
        //     for (var i = 0; i < _self.businessData.readList.length; i++) {
        //         if (_self.businessData.readList[i].person === layout.session.user.distinguishedName) {
        //             read = _self.businessData.readList[i];
        //             break;
        //         }
        //     }
        //
        //     if (read) {
        //         _self.app.action.setReaded(function () {
        //             _self.fireEvent("afterReaded");
        //             _self.app.reload();
        //             if (layout.mobile) {
        //
        //                 //移动端页面关闭
        //                 _self.finishOnMobile()
        //             } else {
        //                 confirmDlg.close();
        //             }
        //         }, null, read.id, read);
        //     } else {
        //         _self.app.reload();
        //         if (layout.mobile) {
        //
        //             //移动端页面关闭
        //             _self.finishOnMobile()
        //         } else {
        //             confirmDlg.close();
        //         }
        //     }
        //
        // }, function () {
        //     this.close();
        // }, null, this.app.content, this.json.confirmStyle);
    },
    doReadedWork: function(dlg){
        var opinion = dlg.content.getElement(".readedWork_opinion").get("value");

        var read = null;
        for (var i = 0; i < this.businessData.readList.length; i++) {
            if (this.businessData.readList[i].person === layout.session.user.distinguishedName) {
                read = this.businessData.readList[i];
                break;
            }
        }

        var _self = this;
        if (read) {
            MWF.require("MWF.widget.Mask", function () {
                this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                this.mask.loadNode(this.app.content);

                read.opinion = opinion;

                this.fireEvent("beforeReaded");

                this.app.action.setReaded(function () {
                    if (_self.mask) { _self.mask.hide(); _self.mask = null; }

                    _self.fireEvent("afterReaded");

                    if (layout.mobile) {
                        _self.finishOnMobile();
                    } else {
                        _self.app.reload();
                        dlg.close();
                    }
                }, null, read.id, read);
            }.bind(this));
        } else {
            if (layout.mobile) {
                _self.finishOnMobile();
            } else {
                _self.app.reload();
                dlg.close();
            }
        }
    },

    openWindow: function (form, app) {
        //var application = app || (this.businessData.work) ? this.businessData.work.application : this.businessData.workCompleted.application;
        var form = form;
        if (!form) {
            form = this.json.id;
            //if (this.json.printForm) form = this.json.printForm;
        }
        if (this.businessData.workCompleted) {
            var application = app || this.businessData.workCompleted.application;
            var url = o2.filterUrl("../x_desktop/printWork.html?workCompletedId=" + this.businessData.workCompleted.id + "&app=" + application + "&form=" + form);
            if ((o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC())) {
                var xtoken = layout.session.token;
                url += "&" + o2.tokenName + "=" + xtoken;
            }
            window.open(url);
        } else {
            var application = app || this.businessData.work.application;
            var url = o2.filterUrl("../x_desktop/printWork.html?workid=" + this.businessData.work.id + "&app=" + application + "&form=" + form);
            if ((o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC())) {
                var xtoken = layout.session.token;
                url += "&" + o2.tokenName + "=" + xtoken;
            }
            window.open(url);
        }
        //window.open("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+form);
    },
    /**
     * @summary 将新上传的附件在指定的附件组件中展现.
     * @param {String} site - 附件组件的标识
     * @param {String} id - 新上传的附件id
     * @example
     * this.form.getApp().appForm.uploadedAttachment(site, id);
     */
    uploadedAttachment: function (site, id) {
        this.workAction.getAttachment(id, this.businessData.work.id, function (json) {

            var flag = this.businessData.attachmentList.some(function (attData) {
                return json.data.id === attData.id;
            }.bind(this));
            if( !flag ){
                this.businessData.attachmentList.push(json.data);
            }

            var att = this.all[site];
            if (att) {
                if (json.data) att.attachmentController.addAttachment(json.data);
                att.attachmentController.checkActions();
                att.fireEvent("upload", [json.data]);
            }
        }.bind(this));
    },
    replacedAttachment: function (site, id) {
        this.workAction.getAttachment(id, this.businessData.work.id, function (json) {

            var att = this.all[site];
            if (att) {
                var attachmentController = att.attachmentController;
                var attachment = null;
                for (var i = 0; i < attachmentController.attachments.length; i++) {
                    if (attachmentController.attachments[i].data.id === id) {
                        attachment = attachmentController.attachments[i];
                        break;
                    }
                }
                attachment.data = json.data;
                attachment.reload();
                attachmentController.checkActions();
            }
        }.bind(this))
    },
    uploadedAttachmentDatagrid: function (site, id, moduleId) {
        this.workAction.getAttachment(id, this.businessData.work.id, function (json) {

            var flag = this.businessData.attachmentList.some(function (attData) {
                return json.data.id === attData.id;
            }.bind(this));
            if( !flag ){
                this.businessData.attachmentList.push(json.data);
            }

            var att = this.all[moduleId];
            if (att) {
                if (json.data) att.attachmentController.addAttachment(json.data);
                att.setAttachmentBusinessData();
                att.attachmentController.checkActions();
                att.fireEvent("upload", [json.data]);
                att.fireEvent("change", [json.data]);
            }
        }.bind(this));
    },
    replacedAttachmentDatagrid: function (site, id, moduleId) {
        this.workAction.getAttachment(id, this.businessData.work.id, function (json) {

            var att = this.all[moduleId];
            if (att) {
                var attachmentController = att.attachmentController;
                var attachment = null;
                for (var i = 0; i < attachmentController.attachments.length; i++) {
                    if (attachmentController.attachments[i].data.id === id) {
                        attachment = attachmentController.attachments[i];
                        break;
                    }
                }
                attachment.data = json.data;
                att.setAttachmentBusinessData();
                attachment.reload();
                attachmentController.checkActions();
                att.fireEvent("change", [json.data]);
            }
        }.bind(this))
    },

    // 打开工作关联聊天
    openIMChatStarter: function(jobId) {
        MWF.xDesktop.requireApp("IMV2", "Starter", function () {
            var starter = new MWF.xApplication.IMV2.Starter({}, this.app, {
                "businessId":jobId,
                "businessType": "process"
            });
            starter.load();
        }.bind(this));
    },
    // 分享到IM聊天
    shareToIMChat: function() {
        // app端 分享到聊天
        if (window.o2android && window.o2android.postMessage) {
            var body = {
                type: "shareToIMChat",
            }
            window.o2android.postMessage(JSON.stringify(body));
        } else {
            var imJson = {}
            if (this.businessData.workCompleted) {
                imJson = {
                    type: "process",
                    title: this.businessData.workCompleted.title,
                    work: this.businessData.workCompleted.id,
                    process: this.businessData.workCompleted.process,
                    processName: this.businessData.workCompleted.processName,
                    application: this.businessData.workCompleted.application,
                    applicationName: this.businessData.workCompleted.applicationName,
                    job: this.businessData.workCompleted.job,
                }
            } else if (this.businessData.work) {
                imJson = {
                    type: "process",
                    title: this.businessData.work.title,
                    work: this.businessData.work.id,
                    process: this.businessData.work.process,
                    processName: this.businessData.work.processName,
                    application: this.businessData.work.application,
                    applicationName: this.businessData.work.applicationName,
                    job: this.businessData.work.job,
                }
            } else {
                this.app.notice(o2.txt(MWF.xApplication.process.Xform.LP.noPermissionOrWorkNotExisted), "error")
                return
            }
            MWF.xDesktop.requireApp("IMV2", "Starter", function () {
                var share = new MWF.xApplication.IMV2.ShareToConversation({
                    msgBody: imJson
                }, this.app);
                share.load();
            }.bind(this));
        }
    },

    //移动端页面 工作处理完成后
    finishOnMobile: function () {
        var _self = this;
        //新建检查
        // if (this.json.checkDraft){
        //     this.workAction.checkDraft(this.businessData.work.id, function (json) {
        //         // var str = JSON.stringify(json);
        //         _self.finishOnMobileReal();
        //     }.bind(this), function () {
        //         _self.finishOnMobileReal();
        //     }, false);
        // }else {
        //     _self.finishOnMobileReal();
        // }
        this.workAction.checkDraft(this.businessData.work.id, function (json) {
            // var str = JSON.stringify(json);
            _self.finishOnMobileReal();
        }.bind(this), function () {
            _self.finishOnMobileReal();
        }, false);
    },

    finishOnMobileReal: function () {
        if (window.o2android && window.o2android.postMessage) {
            var body = {
                type: "closeWork",
            }
            window.o2android.postMessage(JSON.stringify(body));
        } else if (window.o2android && window.o2android.closeWork) {
            window.o2android.closeWork("");
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.closeWork) {
            window.webkit.messageHandlers.closeWork.postMessage("");
        } else if (window.wx && window.__wxjs_environment === 'miniprogram') { //微信小程序 关闭页面
            wx.miniProgram.navigateBack({ delta: 1 });
        } else if (window.uni && window.uni.navigateBack) { // uniapp 关闭页面
            window.uni.navigateBack();
        } else if (this.json.afterProcessAction === "redirect" && this.json.afterProcessRedirectScript && this.json.afterProcessRedirectScript.code) {
            var url = this.Macro.exec(this.json.afterProcessRedirectScript.code, this);
            (new URI(url)).go();
        } else {
            // var len = window.history.length;
            // if (len > 1) {
            //     history.back();
            // } else {
            //     var uri = new URI(window.location.href);
            //     var redirectlink = uri.getData("redirectlink");
            //     if (redirectlink) {
            //         history.replaceState(null, "work", redirectlink);
            //         redirectlink.toURI().go();
            //     } else {
            //         // window.location = o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter");
            //         history.replaceState(null, "work", o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter"));
            //         o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter").toURI().go();
            //     }
            // }
            var uri = new URI(window.location.href);
            var redirectlink = uri.getData("redirectlink");
            if (redirectlink) {
                history.replaceState(null, "work", redirectlink);
                redirectlink.toURI().go();
            } else {
                // window.location = o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter");
                history.replaceState(null, "work", o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter"));
                o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter").toURI().go();
            }
        }
    },
    // 判断是否是钉钉pc上
    dingTalkPcCloseOrAppClose: function () {
        if ((o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC()) && layout.inBrowser) { // 如果是钉钉pc上 并且是浏览器模式
            var centerUrl = o2.filterUrl("../x_desktop/app.html?app=process.TaskCenter");
            history.replaceState(null, "work", centerUrl);
            centerUrl.toURI().go();
        } else {
            this.app.close();
        }
    },
    /**
     * @summary 获取组件的类型(小写).
     * @param {Object|String} module - 组件或组件Id
     * @return {String} 组件类型（小写）
     * @example
     * //假设有一个文本输入组件id为subject
     * var module = this.form.get("subject");
     * //moduleType 为 textfield;
     * var moduleType = this.form.getApp().appForm.getModuleType();
     * @example
     * //假设有一个附件组件id为att,
     * var moduleType = this.form.getApp().appForm.getModuleType("att");
     * //moduleType 为 attachment;
     */
    getModuleType : function (module) {
        if( typeOf(module) === "string" )module = this.all[module];
        if( module ){
            var moduleType = module.json.moduleName || "";
            if( !moduleType ){
                moduleType = typeOf(module.json.type) === "string" ? module.json.type.toLowerCase() : "";
            }
            return moduleType.toLowerCase();
        }else{
            return "";
        }
    },

    sendRead: function () {
        var opt = {};
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 560;
            var height = 270;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            var dlg = o2.DL.open({
                "title": MWF.xApplication.process.Xform.LP.sendRead,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": (layout.mobile) ? 0 : (p.y - 100),
                "left": (layout.mobile) ? 0 : p.x,
                "fromTop": (layout.mobile) ? 0 : (p.y - 100),
                "fromLeft": (layout.mobile) ? 0 : p.x,
                "width": (layout.mobile) ? "100%" : width,
                "height": (layout.mobile) ? "100%" :height,
                "url": this.app.path + ( (layout.mobile) ? "sendReadMobile" : "sendRead") +".html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": (layout.mobile) ? document.body : this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            if( !opt.identityList || !opt.identityList.length ){
                                _self.app.notice(MWF.xApplication.process.Xform.LP.inputSendReadPeople, "error", dlg.node);
                            }else{
                                var notify = dlg.content.getElement(".sendRead_notify").get("checked");
                                opt.notify = !!notify;
                                _self.doSendRead(opt);
                            }
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostShow": function () {
                    opt.dlg = this;
                    opt.workId = (_self.businessData.work || _self.businessData.workCompleted).id;
                    opt.complete = !!(_self.businessData.work || _self.businessData.workCompleted).completedTime;
                    var selPeopleButton = this.content.getElement(".sendRead_selPeopleButton");
                    selPeopleButton.addEvent("click", function () {
                        _self.selectReadPeople(this, opt);
                    }.bind(this));
                }
            });
            // dlg.show();
        }.bind(this));
    },
    selectReadPeople: function (dlg, opt ) {
        var names = opt.identityList || [];
        var areaNode = dlg.content.getElement(".sendRead_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "count": 0,
            "title": MWF.xApplication.process.Xform.LP.sendRead,
            "onComplete": function (items) {
                areaNode.empty();
                var identityList = [];
                items.each(function (item) {
                    new MWF.widget.O2Identity(item.data, areaNode, { "style": "reset" });
                    identityList.push(item.data.distinguishedName);
                }.bind(this));
                opt.identityList = identityList;
            }.bind(this)
        };
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));
    },
    doSendRead: function(opt){
        if( !opt.identityList || !opt.identityList.length ) {
            this.app.notice(MWF.xApplication.process.Xform.LP.sendReadPeopleCanNotEmpty, "error", opt.dlg ? opt.dlg.node : null);
            return false;
        }

        var nameArr = [];
        var names = opt.identityList || [];
        names.each(function (n) { nameArr.push(n.split("@")[0]); });


        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeSendRead");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeSendRead");

            if( !opt.workId ){
                opt.workId = (this.businessData.work || this.businessData.workCompleted).id;
                opt.complete = !!(this.businessData.work || this.businessData.workCompleted).completedTime;
            }

            var method = opt.complete ? "createWithWorkCompleted" : "createWithWork";

            o2.Actions.load("x_processplatform_assemble_surface").ReadAction[method](opt.workId, {
                "identityList": opt.identityList,
                "notify": opt.notify
            }, function () {
                this.fireEvent("afterSendRead");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterSendRead");
                this.app.notice(MWF.xApplication.process.Xform.LP.sendReadOk + ": " + nameArr, "success");
                if(opt.dlg)opt.dlg.close();
                if(opt.success)opt.success();
                if (this.mask) { this.mask.hide(); this.mask = null; }
                this.app.reload();
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", opt.dlg ? opt.dlg.node : null);
                if(opt.failure)opt.failure();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this));
        }.bind(this));
    },

    addReview: function () {
        var opt = {};
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 560;
            var height = 270;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            var dlg = o2.DL.open({
                "title": MWF.xApplication.process.Xform.LP.sendReview,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": (layout.mobile) ? 0 : (p.y - 100),
                "left": (layout.mobile) ? 0 : p.x,
                "fromTop": (layout.mobile) ? 0 : (p.y - 100),
                "fromLeft": (layout.mobile) ? 0 : p.x,
                "width": (layout.mobile) ? "100%" : width,
                "height": (layout.mobile) ? "100%" : height,
                "url": this.app.path + ( (layout.mobile) ? "sendReviewMobile" : "sendReview") + ".html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": (layout.mobile) ? document.body : this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            if( !opt.personList || !opt.personList.length ){
                                _self.app.notice(MWF.xApplication.process.Xform.LP.inputSendReviewPeople, "error", dlg.node);
                            }else{
                                _self.doAddReview(opt);
                            }
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostShow": function () {
                    opt.dlg = this;
                    opt.workId = (_self.businessData.work || _self.businessData.workCompleted).id;
                    opt.complete = !!(_self.businessData.work || _self.businessData.workCompleted).completedTime;
                    var selPeopleButton = this.content.getElement(".sendReview_selPeopleButton");
                    selPeopleButton.addEvent("click", function () {
                        _self.selectReviewPeople(this, opt);
                    }.bind(this));
                }
            });
            //dlg.show();
        }.bind(this));
    },
    selectReviewPeople: function (dlg, opt ) {
        var names = opt.personList || [];
        var areaNode = dlg.content.getElement(".sendReview_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "resultType": "person",
            "count": 0,
            "title": MWF.xApplication.process.Xform.LP.sendReview,
            "onComplete": function (items) {
                areaNode.empty();
                var personList = [];
                items.each(function (item) {
                    new MWF.widget.O2Person(item.data, areaNode, { "style": "reset" });
                    personList.push(item.data.distinguishedName);
                }.bind(this));
                opt.personList = personList;
            }.bind(this)
        };
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));
    },
    doAddReview: function(opt){
        if( !opt.personList || !opt.personList.length ) {
            this.app.notice(MWF.xApplication.process.Xform.LP.sendReviewPeopleCanNotEmpty, "error", opt.dlg ? opt.dlg.node : null);
            return false;
        }

        var nameArr = [];
        var names = opt.personList || [];
        names.each(function (n) { nameArr.push(n.split("@")[0]); });


        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeAddReview");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeAddReview");

            if( !opt.workId ){
                opt.workId = (this.businessData.work || this.businessData.workCompleted).id;
                opt.complete = !!(this.businessData.work || this.businessData.workCompleted).completedTime;
            }

            var method = opt.complete ? "createWithWorkCompleted" : "createWithWork";
            var data = { "personList": opt.personList };
            if( opt.complete ){
                data.workCompleted = opt.workId;
            }else{
                data.work = opt.workId;
            }

            o2.Actions.load("x_processplatform_assemble_surface").ReviewAction[method]( data, function () {
                this.fireEvent("afterAddReview");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterAddReview");
                this.app.notice(MWF.xApplication.process.Xform.LP.sendReviewOk + ": " + nameArr, "success");
                if(opt.dlg)opt.dlg.close();
                if(opt.success)opt.success();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", opt.dlg ? opt.dlg.node : null);
                if(opt.failure)opt.failure();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this));
        }.bind(this));
    },

    checkControl: function(key){
        if (!this.businessData.control[key]) {
            o2.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        if( !this.businessData.task ){
            o2.xDesktop.notice("error", { x: "right", y: "top" }, o2.xApplication.process.Xform.LP.form.noTaskToReset);
            return false;
        }
        return true;
    },
    addTask: function(){
        if (!this.checkUploadAttachment()) return false;
        if (this.checkControl("allowAddTask")){
            var _self = this;
            var opt = {};

            o2.DL.open({
                "title": o2.xApplication.process.Xform.LP.form.addTask,
                "style": this.json.dialogStyle || "user",
                "width":   (layout.mobile) ? "100%" : 680,
                "height":  (layout.mobile) ? "100%" : 380,
                "url": this.app.path + ( (layout.mobile) ? "addTaskMobile" : "addTask") +".html",
                "lp": o2.xApplication.process.Xform.LP.form,
                "container": (layout.mobile) ? document.body : this.app.content,
                "maskNode": this.app.content,
                "offset": (layout.mobile) ? null : {y: -120},
                // "top": (layout.mobile) ? 0 : undefined,
                // "left": (layout.mobile) ? 0 : undefined,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": o2.LP.process.button.ok,
                        "action": function (d, e) {
                            if( !this.identityList || !this.identityList.length ){
                                _self.app.notice(o2.xApplication.process.Xform.LP.inputAddTaskPeople, "error", this.node);
                            }else{
                                _self.doAddTask(this);
                            }
                        }
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () {
                            this.close();
                        }
                    }
                ],
                "onPostShow": function () {
                    var selPeopleButton = this.content.getElement(".addTask_selPeopleButton");
                    selPeopleButton.addEvent("click", function () {
                        _self.selectPeople(this);
                    }.bind(this));
                }

            });
        }
    },
    getRadioValue: function(node, selector){
        var nodes = node.getElements(selector);
        for (var i=0; i<nodes.length; i++){
            if (nodes[i].checked){
                return nodes[i].value;
            }
        }
        return "";
    },
    // checkAddTaskIdentity: function(identityList, position, node, callback){
    //     var manualTaskIdentityMatrix = this.businessData.work.manualTaskIdentityMatrix.matrix;
    //     manualTaskIdentityMatrix = (manualTaskIdentityMatrix.flat) ? manualTaskIdentityMatrix.flat() :  manualTaskIdentityMatrix.reduce(function(acc, val){
    //         return acc.concat(val);
    //     }, []);
    //     var repeated = [];
    //
    //     var optionList = identityList.reduce(function(pv, cv){
    //         if (manualTaskIdentityMatrix.indexOf(cv)===-1){
    //             return pv.concat({
    //                 position: position,
    //                 identityList: [cv]
    //             });
    //         }else{
    //             repeated.push(o2.name.cn(cv));
    //             return pv;
    //         }
    //     }, []);
    //
    //     if (repeated.length){
    //         var content = o2.xApplication.process.Xform.LP.form.addTaskRepeatedInfo;
    //         content = content.replace("{repeated}", repeated.join(", "));
    //         o2.DL.open({
    //             isClose: false,
    //             title: o2.xApplication.process.Xform.LP.form.addTaskRepeatedTitle,
    //             html: content,
    //             container: node,
    //             buttonList: [{
    //                 "text": MWF.xApplication.process.Xform.LP.ok,
    //                 "action": function(){
    //                     this.close();
    //                     if (callback) callback(optionList);
    //                 }
    //             }]
    //         })
    //     }else{
    //         if (callback) callback(optionList);
    //     }
    // },
    // doAddTask: function(dlg){
    //     MWF.require("MWF.widget.Mask", function () {
    //
    //         var position = this.getRadioValue(dlg.content, ".addTask_type") || "after";
    //
    //         this.checkAddTaskIdentity(dlg.identityList, position, dlg.node, function(optionList){
    //             if (optionList && optionList.length){
    //                 this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
    //                 this.mask.loadNode(this.app.content);
    //
    //                 var nameArr = optionList.map(function(op){
    //                     return o2.name.cn(op.identityList[0]);
    //                 });
    //
    //                 var opinion = dlg.content.getElement(".addTask_opinion").get("value");
    //                 if (!opinion) opinion = o2.xApplication.process.Xform.LP.form.addTask+":"+nameArr.join(", ");
    //                 var taskId = this.businessData.task.id;
    //
    //                 var addTaskOptions = {
    //                     optionList: optionList,
    //                     remove: false,
    //                     opinion: opinion,
    //                     routeName: o2.xApplication.process.Xform.LP.form.addTask+":"+nameArr.join(", ")
    //                 }
    //                 this.fireEvent("beforeAddTask");
    //                 if (this.app && this.app.fireEvent) this.app.fireEvent("beforeAddTask");
    //
    //                 this.saveFormData(function(){
    //                     o2.Actions.load("x_processplatform_assemble_surface").TaskAction.V2Add(taskId, addTaskOptions, function (json) {
    //                         this.fireEvent("afterAddTask");
    //                         if (this.app && this.app.fireEvent) this.app.fireEvent("afterAddTask");
    //                         this.app.notice(MWF.xApplication.process.Xform.LP.addTaskOk + ": " + nameArr, "success");
    //
    //                         dlg.close();
    //                         if (this.mask) this.mask.hide();
    //
    //                         var notCloseWindow = position!=="before";
    //                         this.addAddTaskMessage(json.data, notCloseWindow);
    //                         if (!this.app.inBrowser){
    //                             this.app[(notCloseWindow ? "refresh" : "close")]();
    //                         }
    //
    //                     }.bind(this), function (xhr, text, error) {
    //                         var errorText = error + ":" + text;
    //                         if (xhr) errorText = xhr.responseText
    //                         this.app.notice("request json error: " + errorText, "error", dlg ? dlg.node : null);
    //
    //                         if (this.mask) this.mask.hide();
    //                     }.bind(this)).catch(function(){});
    //                 }.bind(this));
    //             }else{
    //                 if (this.mask)  this.mask.hide();
    //             }
    //         }.bind(this));
    //
    //     }.bind(this));
    // },
    doAddTask: function(dlg){
        MWF.require("MWF.widget.Mask", function () {

            var position = this.getRadioValue(dlg.content, ".addTask_type") || "after";
            var mode = this.getRadioValue(dlg.content, ".mode_type") || "single";

            if (dlg.identityList && dlg.identityList.length){
                this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                if( layout.mobile ){
                    this.mask.load();
                }else{
                    this.mask.loadNode(this.app.content);
                }

                var nameArr = dlg.identityList.map(function(id){
                    return o2.name.cn(id);
                });

                var opinion = dlg.content.getElement(".addTask_opinion").get("value");

                var data = {mode: mode, opinion: opinion, before: position === "before", names: dlg.identityList, userOpinion: opinion};

                if( !this.validationOtherFlow('addTask', opinion, null, data) ){
                    if (this.mask) { this.mask.hide(); this.mask = null; }
                    return;
                }

                this.fireEvent("beforeAddTask", {mode: mode, opinion: opinion, before: position === "before", names: dlg.identityList});
                if (this.app && this.app.fireEvent) this.app.fireEvent("beforeAddTask");

                this.doAddTaskToPeople(dlg.identityList, opinion, mode, position === "before", "", function (json) {
                        this.fireEvent("afterAddTask", data);
                        if (this.app && this.app.fireEvent) this.app.fireEvent("afterAddTask");
                        this.app.notice(MWF.xApplication.process.Xform.LP.addTaskOk + ": " + nameArr, "success");

                        dlg.close();
                        if (this.mask) this.mask.hide();

                        var notCloseWindow = false; //position!=="before";
                        this.addAddTaskMessage(json.data, notCloseWindow);
                        if (!this.app.inBrowser){
                            this.app[(notCloseWindow ? "refresh" : "close")]();
                        }

                    }.bind(this), function (xhr, text, error) {
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        this.app.notice("request json error: " + errorText, "error", dlg ? dlg.node : null);

                        if (this.mask) this.mask.hide();
                    }.bind(this))

            }else{
                if (this.mask)  this.mask.hide();
            }

        }.bind(this));
    },
    doAddTaskToPeople: function (names, opinion, mode, before, routeName, success, failure) {

        var lp = o2.xApplication.process.Xform.LP.form;

        var leftText = (!!before ? lp.addTaskBefore : lp.addTaskAfter)+lp[mode];

        var nameArr = names.map(function(id){
            return o2.name.cn(id);
        });
        var n = nameArr.length > 3 ? (nameArr[0]+"、"+nameArr[1]+"、"+nameArr[2]+"...") : nameArr.join(", ");
        var routeName = leftText+":"+n;

        if (!opinion) opinion = leftText+":"+nameArr.join(", "); //o2.xApplication.process.Xform.LP.form.addTask+":"+nameArr.join(", ");

        var data = {
            "mode": mode,
            "before": !!before,
            "opinion": opinion,
            "routeName": routeName,
            "distinguishedNameList": names
        };
        this.saveFormData(
            function(json){
                o2.Actions.load("x_processplatform_assemble_surface").TaskAction.v3Add(
                    //this.workAction.resetWork(
                    function (json) {
                        if (success) success(json);
                    }.bind(this),
                    function (xhr, text, error) {
                        if (failure) failure(xhr, text, error);
                    },
                    this.businessData.task.id, data
                );
            }.bind(this),
            function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            });
    },

    addAddTaskMessage: function (data, notCloseWindow) {
        var content = this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.addTaskInfor);
        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.form.addTask,
                "content": content
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(content, notCloseWindow);
            }
        }
    },

    terminateWork: function(){
        if (!this.businessData.control["allowTerminate"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }

        var _self = this;
        var opt = {};

        o2.DL.open({
            "title": o2.xApplication.process.Xform.LP.terminateWorkTitle,
            "style": this.json.dialogStyle || "user",
            "width":   (layout.mobile) ? "100%" : 620,
            "height":  (layout.mobile) ? "100%" : 300,
            "url": this.app.path + ( (layout.mobile) ? "terminateMobile" : "terminate") +".html",
            "lp": o2.xApplication.process.Xform.LP,
            "container": (layout.mobile) ? document.body : this.app.content,
            "maskNode": this.app.content,
            "offset": (layout.mobile) ? null : {y: -120},
            "buttonList": [
                {
                    "type": "ok",
                    "text": o2.LP.process.button.ok,
                    "action": function (d, e) {
                        _self.fireEvent("beforeTerminat");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeTerminat");

                        var opinion = this.content.getElement(".terminateWork_opinion").get("value");

                        _self.doTerminateWork(function () {
                            _self.fireEvent("afterTerminat");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterTerminat");
                            _self.app.notice(MWF.xApplication.process.Xform.LP.workTerminate + ": “" + o2.txt(_self.businessData.work.title) + "”", "success");
                            _self.json.mode === "Mobile" ? _self.finishOnMobile() : _self.app.close();
                            this.close();
                        }.bind(this), function (xhr, text, error) {
                            var errorText = error + ":" + text;
                            if (xhr) errorText = xhr.responseText;
                            _self.app.notice("request json error: " + errorText, "error");
                        }.bind(this), opinion);
                    }
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function () {
                        this.close();
                    }
                }
            ]

        });
    },
    // terminateWork: function(e, ev){
    //     var _self = this;
    //     if (this.json.mode === "Mobile") {
    //         var p = MWF.getCenterPosition(document.body, 300, 150);
    //         var x = p.x;
    //         if (p.x < 20) {
    //             x = 20;
    //         } else {
    //             x = p.x;
    //         }
    //         var event = {
    //             "event": {
    //                 "x": x,
    //                 "y": p.y - 200,
    //                 "clientX": x,
    //                 "clientY": p.y - 200
    //             }
    //         };
    //         this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.terminateWorkTitle, MWF.xApplication.process.Xform.LP.terminateWorkText, 300, 120, function () {
    //             _self.app.content.mask({
    //                 "style": {
    //                     "background-color": "#999",
    //                     "opacity": 0.6
    //                 }
    //             });
    //             MWF.require("MWF.widget.Mask", function () {
    //                 _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
    //                 _self.mask.loadNode(_self.app.content);
    //
    //                 _self.fireEvent("beforeTerminat");
    //                 if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeTerminat");
    //
    //                 _self.doTerminateWork(function () {
    //                     _self.fireEvent("afterTerminat");
    //                     if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterTerminat");
    //                     _self.app.notice(MWF.xApplication.process.Xform.LP.workTerminate + ": “" + _self.businessData.work.title + "”", "success");
    //                     if (_self.mask) {
    //                         _self.mask.hide();
    //                         _self.mask = null;
    //                     }
    //                     _self.finishOnMobile()
    //                 }.bind(this), function (xhr, text, error) {
    //                     var errorText = error + ":" + text;
    //                     if (xhr) errorText = xhr.responseText;
    //                     _self.app.notice("request json error: " + errorText, "error");
    //                     if (_self.mask) {
    //                         _self.mask.hide();
    //                         _self.mask = null;
    //                     }
    //                 }.bind(this));
    //             }.bind(this));
    //         }, function () {
    //             this.close();
    //         }, null, this.app.content, this.json.confirmStyle);
    //     } else {
    //         var p = MWF.getCenterPosition(this.app.content, 380, 150);
    //         var event = {
    //             "event": {
    //                 "x": p.x,
    //                 "y": p.y - 200,
    //                 "clientX": p.x,
    //                 "clientY": p.y - 200
    //             }
    //         };
    //         this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.terminateWorkTitle, MWF.xApplication.process.Xform.LP.terminateWorkText, 380, 120, function () {
    //             // _self.app.content.mask({
    //             //    "style": {
    //             //        "background-color": "#999",
    //             //        "opacity": 0.6
    //             //    }
    //             // });
    //
    //
    //             MWF.require("MWF.widget.Mask", function () {
    //                 _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
    //                 _self.mask.loadNode(_self.app.content);
    //
    //                 _self.fireEvent("beforeTerminat");
    //                 if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeTerminat");
    //
    //                 _self.doTerminateWork(function () {
    //                     _self.fireEvent("afterTerminat");
    //                     if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterTerminat");
    //                     _self.app.notice(MWF.xApplication.process.Xform.LP.workTerminate + ": “" + _self.businessData.work.title + "”", "success");
    //                     _self.app.close();
    //                     this.close();
    //                     if (_self.mask) {
    //                         _self.mask.hide();
    //                         _self.mask = null;
    //                     }
    //                 }.bind(this), function (xhr, text, error) {
    //                     var errorText = error + ":" + text;
    //                     if (xhr) errorText = xhr.responseText;
    //                     _self.app.notice("request json error: " + errorText, "error", dlg.node);
    //                     if (_self.mask) {
    //                         _self.mask.hide();
    //                         _self.mask = null;
    //                     }
    //                 }.bind(this));
    //             }.bind(this));
    //         }, function () {
    //             this.close();
    //         }, null, this.app.content, this.json.confirmStyle);
    //     }
    // },


    doTerminateWork: function (success, failure, opinion) {
        if (this.businessData.control["allowTerminate"]) {
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Terminate(this.businessData.work.id, {
                opinion: opinion || "",
                routeName: MWF.xApplication.process.Xform.LP.terminateWork
            }, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            });
        }else {
            if (failure) failure(null, "Permission Denied", "");
        }
    }

});


/**
 * @class PortalPage 门户页面。
 * @o2cn 门户页面
 * @o2category FormComponents
 * @o2range {Portal}
 * @extends MWF.xApplication.process.Xform.Form
 * @example
 * //可以在脚本中获取页面
 * //方法1：
 * var page = this.form.getApp().appForm; //获取页面
 * //方法2
 * var page = this.target; //在页面本身的事件脚本中获取
 * @hideconstructor
 */
var PortalPage="";

/**
 * @event PortalPage#beforeProcessWork
 * @ignore
 */
/**
 * @event PortalPage#beforeProcess
 * @ignore
 */
/**
 * @event PortalPage#afterProcess
 * @ignore
 */
/**
 * @event PortalPage#beforeReset
 * @ignore
 */
/**
 * @event PortalPage#afterReset
 * @ignore
 */
/**
 * @event PortalPage#beforeRetract
 * @ignore
 */
/**
 * @event PortalPage#afterRetract
 * @ignore
 */
/**
 * @event PortalPage#beforeReroute
 * @ignore
 */
/**
 * @event PortalPage#afterReroute
 * @ignore
 */
/**
 *  @event PortalPage#beforeDelete
 * @ignore
 */
/**
 * @event PortalPage#afterDelete
 * @ignore
 */
/**
 *  @event PortalPage#beforeReaded
 * @ignore
 */
/**
 * @event PortalPage#afterReaded
 * @ignore
 */
/**
 * @event PortalPage#afterLoadProcessor
 * @ignore
 */
/**
 * @event PortalPage#beforeAddTask
 * @ignore
 */
/**
 * @event PortalPage#afterAddTask
 * @ignore
 */
/**
 * @method PortalPage#getRouteDataList
 * @ignore
 */
/**
 * @method PortalPage#pressWork
 * @ignore
 */
/**
 * @method PortalPage#rerouteWork
 * @ignore
 */
/**
 * @method PortalPage#readedWork
 * @ignore
 */
/**
 * @method PortalPage#uploadedAttachment
 * @ignore
 */
/**
 * @method PortalPage#pauseTask
 * @ignore
 */
/**
 * @method PortalPage#resumeTask
 * @ignore
 */

MWF.require("MWF.widget.Common", null, false);
/** @classdesc $Module 组件类，此类为所有组件的父类。
 * @class
 * @o2category FormComponents
 * @hideconstructor
 * */
MWF.xApplication.process.Xform.$Module = MWF.APP$Module =  new Class(
    /** @lends MWF.xApplication.process.Xform.$Module# */
    {
    Implements: [Events],
    options: {
        /**
         * 组件加载前触发。queryLoad执行的时候，当前组件没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取。
         * @event MWF.xApplication.process.Xform.$Module#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.$Module#postLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.$Module#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad"]
    },
    initialize: function(node, json, form, options){
        /**
         * @summary 组件的节点，mootools封装过的Dom对象，可以直接使用原生的js和moootools方法访问和操作该对象。
         * @see https://mootools.net/core/docs/1.6.0/Element/Element
         * @member {Element}
         * @example
         *  //可以在脚本中获取该组件
         * var field = this.form.get("fieldId"); //获取组件对象
         * field.node.setStyle("font-size","12px"); //给节点设置样式
         */
        this.node = $(node);
        this.node.store("module", this);

        /**
         * @summary 组件的配置信息，比如id,类型,是否只读等等。可以在组件的queryLoad事件里修改该配置来对组件做一些改变。
         * @member {JsonObject}
         * @example
         *  //可以在脚本中获取该组件
         * var json = this.form.get("fieldId").json; //获取组件对象
         * var id = json.id; //获取组件的id
         * var type = json.type; //获取组件的类型，如Textfield 为文本输入组件，Select为下拉组件
         *
         * //在组件queryLoad事件里设置组件只读。
         * //当前组件的queryLoad事件运行时还没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取。
         * var json = this.target.json;
         * json.isReadonly = true; //设置组件为只读。
         */
        this.json = json;

        /**
         * @summary 组件的所在表单对象.
         * @member {MWF.xApplication.process.Xform.Form}
         * @example
         * var form = this.form.get("fieldId").form; //获取组件所在表单对象
         * var container = form.container; //获取表单容器
         */
        this.form = form;


        /**
         * 当前组件在数据表格或者数据模板中时，可以通过此属性获取所在行（条目）对象.
         * @member {MWF.xApplication.process.Xform.Datatemplate.Line|MWF.xApplication.process.Xform.DatatablePC.Line|MWF.xApplication.process.Xform.DatatableMobile.Line}
         * @example
         * //获取当前组件所在数据模板/数据表格的行（条目）对象
         * var line = this.target.parentLine;
         * //获取当前字段所在行下标
         * var index = line.getIndex();
         * //获取当前字段所在条目的subject字段的值
         * var data = line.getModule("subject").getData();
         * //设置当前字段所在条目的subject字段的值
         * line.getModule("subject").setData("test1");
         */
        this.parentLine = null;
    },
    /**
     * @summary 根据组件的校验设置进行校验。
     *  @param {String} [routeName] - 可选，路由名称.
     *  @example
     *  if( !this.form.get('fieldId').validate() ){
     *      return false;
     *  }
     *  @return {Boolean} 是否通过校验
     */
    validate: function (routeName, opinion) {
        if( this.validationMode )this.validationMode();
        if( this.validation ){
            return this.validation(routeName, opinion);
        }else{
            return true;
        }
    },
    validation: function (routeName, opinion) {
        if (!this.isReadonly() && this.json.showMode!=="disabled"){
            if (this.getInputData){
                this._setBusinessData(this.getInputData("change"));
            }
            if (this.node.checkValidity){
                if (!this.node.checkValidity()) return false;
            }
            if (this.validationFormat){
                if (!this.validationFormat()) return false;
            }
            if (!this.validationConfig(routeName, opinion)) return false;

            if (!this.json.validation) return true;
            if (!this.json.validation.code) return true;

            this.currentRouteName = routeName;
            var flag = this.form.Macro.exec(this.json.validation.code, this);
            this.currentRouteName = "";

            if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
            if (flag.toString() !== "true") {
                this.notValidationMode(flag);
                return false;
            }
        }
        return true;
    },
    saveValidation: function () {
        return true;
    },
    /**
     * 当前组件在数据源组件中时，可以通过此方法获取所在的上级数据源/子数据源/子数项组件.
     * @param {String} [type] 需要获取的类型，"source"为表示数据源,"subSource"表示子数据源,"subSourceItem"表示子数据项组件。
     * 如果该参数省略，则获取离当前组件最近的上述组件。
     * @return {Source|SubSource|SubSourceItem}。
     * @example
     * var source = this.target.getSource(); //获取当前组件的所在子上级数据源/子数据源/子数项组件.
     * var data = source.data; //获取数据
     *
     * var source = this.form.get("fieldId").getSource("source"); //获取数据源组件
     * var data = source.data; //获取数据
     */
    getSource: function( type ){
        if( type ){
            var parent = this.node.getParent();
            while(parent && parent.get("MWFtype")!= type ){
                parent = parent.getParent();
            }
            return (parent) ? parent.retrieve("module") : null;
        }else{
            return this._getSource();
        }
    },
    _getSource: function(){
        var parent = this.node.getParent();
        while(parent && (
            parent.get("MWFtype")!="source" &&
            parent.get("MWFtype")!="subSource" &&
            parent.get("MWFtype")!="subSourceItem"
        )) parent = parent.getParent();
        return (parent) ? parent.retrieve("module") : null;
    },
    /**
     * 获取当前组件所在的祖先组件.
     * @param {String} [type] 需要获取的组件类型。
     * 如果该参数省略，则获取离当前组件最近的祖先组件。type有效值如下：
     * <div>form- 表单</div>
     * <div>common- 通用组件</div>
     * <div>datatable- 数据表格</div>
     * <div>datatableline- 数据表格行</div>
     * <div>datatemplate- 数据模板</div>
     * <div>datatemplateline- 数据模板行</div>
     * <div>div- 容器组件</div>
     * <div>elcommon- Element通用组件</div>
     * <div>elcontainer- Element容器组件</div>
     * <div>subform- 子表单</div>
     * <div>source- 数据源组件</div>
     * <div>subsource- 子数据源</div>
     * <div>subsourceitem- 子数据项组件</div>
     * <div>tab- 分页组件</div>
     * <div>tabpage- 分页组件的某个分页</div>
     * <div>table- 表格</div>
     * <div>tabletd- 单元格</div>
     * <div>widget- 部件</div>
     * @param {Function} [validateFunction] 进一步校验，参数为获取到匹配到类型的组件，返回false继续往上取对应类型的组件，返回true返回该组件。
     * @return {MWF.xApplication.process.Xform.$Module}。
     * @example
     * var module = this.target.getParentModule(); //获取最近的祖先。
     *
     * var datatemplateLine = this.target.getParentModule("datatemplateline"); //获取当前组件所在的数据模板行.
     *
     * var module = this.target.getParentModule(null, function(module){
     *     return module.json.id === "div_1";
     * }); //获取当前组件id为div_1的父组件。
     */
    getParentModule: function( type, validateFunction ){
        var lcType = ( type || "" ).toLowerCase();
        if( lcType === "form" )return this.form;

        var module, vm;

        var parent;
        if( ["datatableline","datatemplateline", "tabpage", "tab", "widget", "table"].contains( lcType ) ){
            parent = this.node;
        }else{
            parent = this.node.getParent();
        }
        while(parent) {
            module = null;
            vm = null;
            var MWFtype = parent.get("MWFtype");
            if( MWFtype ){
                module = parent.retrieve("module");
                if( module ){
                    switch (lcType) {
                        case "":
                            vm = module;
                            break;
                        case "table":
                            if( module.table )vm = module.table;
                            break;
                        case "widget":
                            if( module.widget )vm = module.widget;
                            break;
                        case "tab":
                            if( module.tab )vm = module.tab;
                            break;
                        case "tabpage":
                            if( module.page && module.tab )vm = module.page;
                            break;
                        case "datatableline":
                            if( module.parentLine && module.parentDatatable )vm = module.parentLine;
                            break;
                        case "datatemplateline":
                            if( module.parentLine && module.parentDatatemplate )vm = module.parentLine;
                            break;
                        case "subsourceitem":
                            if( MWFtype.toLowerCase() === "subsourceitem" )vm = module;
                            break;
                        case "tabletd":
                            if( module.json.type === "Table$Td" )vm = module;
                            break;
                        default:
                            if( module.json.type.toLowerCase() === lcType )vm = module;
                            break;
                    }
                }
                if( vm ){
                    if( !validateFunction ){
                        return vm;
                    }else if( validateFunction && validateFunction.call(this.form.Macro, vm) ){
                        return vm;
                    }
                }
                parent = parent.getParent();
            }else{
                parent = parent.getParent();
            }
        }
        return null;
    },
    isReadonly : function(){
        return !!(!this.isEditable || this.readonly || this.json.isReadonly || this.form.json.isReadonly || this.json.showMode==="read" || this.isSectionMergeRead());
    },
    isAllSectionShow: function(){
        return this.json.showAllSection && this.json.section === "yes" && this.isSectionData();
    },
    isSectionMergeRead: function(){
        return this.json.sectionMerge === "read" && this.json.section !== "yes" && this.isSectionData()
    },
    isSectionMergeEdit: function(){
        return this.json.sectionMerge === "edit" && this.json.section !== "yes" && this.isSectionData()
    },
    isSectionData: function(){ //数据是否经过区段处理
        var data = this.getBusinessDataById();
        return o2.typeOf( data ) === "object";
    },
    getSortedSectionData: function(){ //获取合并排序后的数据
        var data = this.getBusinessDataById();
        var array = [];
        for( var key in data ){
            array.push({
                sectionKey: key,
                key: key,
                data: data[key]
            })
        }
        if( this.json.sectionMergeSortScript && this.json.sectionMergeSortScript.code){
            array.sort( function(a, b){
                this.form.Macro.environment.event = {
                    "a": a,
                    "b": b
                };
                var flag = this.form.Macro.exec(this.json.sectionMergeSortScript.code, this);
                this.form.Macro.environment.event = null;
                return flag;
            }.bind(this))
        }
        return array;
    },
    //区段合并的区段值
    _getMergeSectionKey: function( data ){
        switch (this.json.sectionKey){
            case "person":
                return layout.desktop.session.user.id;
            case "unit":
                return (this.form.businessData.task) ? (this.form.businessData.task.unitDn || this.form.businessData.task.unit) : "";
            case "activity":
                return (this.form.businessData.work) ? this.form.businessData.work.activity : "";
            case "splitValue":
                return (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
            case "script":
                var d;
                if( this.json.sectionKeyScript && this.json.sectionKeyScript.code){
                    this.form.Macro.environment.event = data;
                    d = this.form.Macro.exec(this.json.sectionKeyScript.code, this);
                    this.form.Macro.environment.event = null;
                }else{
                    d = "";
                }
                return d;
            default:
                return "";
        }
    },
    getSectionKeyWithMerge: function(data, callback){
        switch (this.json.sectionKey) {
            case "person":
                if( !this.form.sectionKeyPersonMap )this.form.sectionKeyPersonMap = {};
                if( this.form.sectionKeyPersonMap[data.key] ){
                    callback(this.form.sectionKeyPersonMap[data.key]);
                    return;
                }

                //只获取一次。把callback存起来，等异步调用完成后一次性执行callback
                if( !this.form.sectionKeyCallbackMap )this.form.sectionKeyCallbackMap = {};
                var map = this.form.sectionKeyCallbackMap;
                if( !map[ data.key ] )map[ data.key ] = [];
                if( !map[ data.key ].length ){
                    Promise.resolve( o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({
                        "personList": [data.key]
                    })).then(function(json){
                        var key = json.data.length ? json.data[0].name : data.key;
                        this.form.sectionKeyPersonMap[data.key] = key;
                        while( map[ data.key ].length ){
                            map[ data.key ].shift()( key );
                        }
                    }.bind(this));
                }
                map[ data.key ].push( callback );

                break;
            case "unit":
                callback( data.key.split("@")[0] );
                break;
            case "activity":
            case "splitValue":
                callback( data.key );
                break;
            case "script":
                var d;
                if( this.json.sectionKeyScript && this.json.sectionKeyScript.code){
                    this.form.Macro.environment.event = data;
                    d = this.form.Macro.exec(this.json.sectionKeyScript.code, this);
                    this.form.Macro.environment.event = null;
                }else{
                    d = "";
                }
                callback( d );
                break;
        }
    },
    _loadMergeReadNode: function(keepHtml, position) {
        if (!keepHtml) {
            this.node.empty();
            this.node.set({
                "nodeId": this.json.id,
                "MWFType": this.json.type
            });
        }
        switch (this.json.mergeTypeRead) {
            case "htmlScript":
                this._loadMergeReadNodeByHtml();
                break;
            case "dataScript":
                this._loadMergeReadNodeByData();
                break;
            default:
                this._loadMergeReadNodeByDefault(position);
                break;
        }
    },
    _loadMergeReadNodeByHtml: function(){
        if (this.json.sectionMergeReadHtmlScript && this.json.sectionMergeReadHtmlScript.code) {
            var html = this.form.Macro.exec(this.json.sectionMergeReadHtmlScript.code, this);
            this.node.set("html", html);
        }
    },
    _loadMergeReadNodeByData: function(){
        if (this.json.sectionMergeReadDataScript && this.json.sectionMergeReadDataScript.code) {
            var data = this.form.Macro.exec(this.json.sectionMergeReadDataScript.code, this);

        }
    },
    _loadMergeReadNodeByDefault: function( position ){
        var data = this.getSortedSectionData();
        var sectionNodeStyles = this._parseStyles(this.json.sectionNodeStyles);
        var sectionKeyStyles = this._parseStyles(this.json.sectionKeyStyles);
        var sectionContentStyles = this._parseStyles(this.json.sectionContentStyles);
        data.each(function(d){
            var node = new Element("div.mwf_sectionnode", {
                styles : sectionNodeStyles
            }).inject(this.node, position || "bottom");

            if( this.json.showSectionKey ){
                var keyNode = new Element("div.mwf_sectionkey", {
                    styles : sectionKeyStyles
                }).inject(node);
                this.getSectionKeyWithMerge( d, function (key) {
                    if( o2.typeOf(key) === "string" ){
                        keyNode.set("text", key + (this.json.keyContentSeparator || ""));
                    }else{
                        Promise.resolve(key).then(function (k) {
                            keyNode.set("text", k + (this.json.keyContentSeparator || ""));
                        }.bind(this))
                    }
                }.bind(this));
            }
            var contentNode = new Element("div.mwf_sectioncontent", {
                styles : sectionContentStyles
            }).inject(node);
            this._loadMergeReadContentNode( contentNode, d )
        }.bind(this))
    },
    _loadMergeReadContentNode: function( contentNode, data ){
        contentNode.set("text", data.data)
    },
    _loadMergeEditNode: function(){
        if( this.json.mergeTypeEdit === "script" ){
            this._loadMergeEditNodeByScript();
        }else{
            this._loadMergeEditNodeByDefault();
        }
    },
    _loadMergeEditNodeByScript: function(){
        if (this.json.sectionMergeEditScript && this.json.sectionMergeEditScript.code) {
            var data = this.form.Macro.exec(this.json.sectionMergeEditScript.code, this);
            this._setBusinessData( data );
            this._loadNode();
        }
    },
    _loadMergeEditNodeByDefault: function(){
        var data = this.getSortedSectionData();
        data = data.map(function(d){ return d.data; });
        this._setBusinessData( data.join("") );
        this._loadNode();
    },
    /**
     * @summary 隐藏组件.
     * @example
     * this.form.get("fieldId").hide(); //隐藏组件
     */
    hide: function(){
        var dsp = this.node.getStyle("display");
        if (dsp!=="none") this.node.store("mwf_display", dsp);
        this.node.setStyle("display", "none");
        if (this.iconNode) this.iconNode.setStyle("display", "none");
    },
    /**
     * @summary 显示组件.
     * @example
     * this.form.get("fieldId").show(); //显示组件
     */
    show: function(){
        var dsp = this.node.retrieve("mwf_display", "block");
        this.node.setStyle("display", dsp);
        if (this.iconNode) this.iconNode.setStyle("display", "block");
    },
    load: function(){
        this._loadModuleEvents();
        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
            this._loadStyles();
            this._loadDomEvents();
            //this._loadEvents();
            this._afterLoaded();
            this.fireEvent("postLoad");

            if( this.moduleSelectAG && typeOf(this.moduleSelectAG.then) === "function" ){
                this.moduleSelectAG.then(function () {
                    this.fireEvent("load");
                    this.isLoaded = true;
                }.bind(this))
            }else{
                this.fireEvent("load");
                this.isLoaded = true;
            }
        }
    },

    _queryLoaded: function(){
        this._loadReadEditAbeld();
    },
    _afterLoaded: function(){},
    
    _loadReadEditAbeld: function(){
        this._loadPoweer();
        this.isReadable = this._isReadable();
        this.isEditable = !this.isReadable ? false : this._isEditable();
        this.isHideUnreadable = this._isHideUnreadable();
    },
    _isEditable: function () {
        //如果可编辑判定是no，则一定不可编辑
        if (this.editable==='no') return false;

        //如果当前可编辑判定不是no，则需要查找父元素，以便确定是否可编辑。
        let p = this.getParentModule();
        while (p) {
            //如果父元素可编辑判定是no，则当前元素也不可编辑
            if (p.editable=== 'no') return false;
            p = p.getParentModule();
        }

        //剩下的情况是，父元素的可编辑判定不为no，当前元素的可编辑判定也不为no，则只要当前元素可读，即可编辑
        return this.readable!=='no';
    },
    _isReadable: function () {
        //如果可读判定是no，则一定不可读
        if (this.readable==='no') return false;

        //如果当前可读判定不是no，则需要查找父元素，以便确定是否可读。
        let p = this.getParentModule();
        while (p) {
            //如果父元素可读判定是no，则当前元素也不可读
            if (p.readable=== 'no') return false;
            p = p.getParentModule();
        }

        //剩下的情况是，父元素的可读判定不为no，当前元素的可读判定也不为no，则当前元素可读
        return true;
    },
    _isHideUnreadable: function(){
        if (this.json.hideCannotRead === 'no') return false;
        if (this.json.hideCannotRead === 'yes') return true;
        let p = this.getParentModule();
        while (p) {
            if (p.json.hideCannotRead === 'yes') return true;
            if (p.json.hideCannotRead === 'no') return false;
            p = p.getParentModule();
        }
        return false;
    },
    _loadPoweer: function () {
        this.editable = this._checkEditAbled();
        //如果可编辑已设置，并判断为yes，则readable一定为yes，忽略可读配置。
        this.readable = this.editable==='yes' ? 'yes' : this._checkReadAbled();
    },
    _checkReadAbled: function () {
        return this._checkpowerAbled('readByActivity', 'readByOrg', 'readByScript', 'readByActivityValue', 'readByOrgValue', 'readByScriptValue');
    },
    _checkEditAbled: function () {
        return this._checkpowerAbled('editByActivity', 'editByOrg', 'editByScript', 'editByActivityValue', 'editByOrgValue', 'editByScriptValue');
    },
    _checkpowerAbled: function (activity, org, script, activityValue, orgValue, scriptValue) {
        const hasByActivity = this.json[activity] && this.json[activity].includes('true') && this.json[activityValue] && this.json[activityValue].length;
        const hasByOrg = this.json[org] && this.json[org].includes('true') && this.json[orgValue] && this.json[orgValue].length;
        const hasByScript = this.json[script] && this.json[script].includes('true') && this.json[scriptValue] && this.json[scriptValue].code;

        if (hasByActivity || hasByOrg || hasByScript){
            if (hasByActivity){
                const i = this.json[activityValue].findIndex((act)=>{
                    return act.id === this.form.businessData.activity.id;
                });
                if (i!==-1) return 'yes';
            }
            if (hasByOrg){
                const i = this.json[orgValue].findIndex((org)=>{
                    return layout.session.userDetail.distinguishedName === org.distinguishedName || layout.session.userDetail.list.includes(org.distinguishedName);
                });
                if (i!==-1) return 'yes';
            }
            if (hasByScript){
                var flag = this.form.Macro.exec(this.json[scriptValue].code, this);
                return !!flag ? 'yes' : 'no';
            }
            return 'no';
        }
        return 'unset'
    },
    
    _loadUserInterface: function(){
        //	this.node = this.node;
    },

    _loadStyles: function(){
        if (this.json.styles){
            this.node.setStyles( this._parseStyles(this.json.styles) );
        }
        // if (this.json.styles) Object.each(this.json.styles, function(value, key){
        //     if ((value.indexOf("x_processplatform_assemble_surface")!=-1 || value.indexOf("x_portal_assemble_surface")!=-1 || value.indexOf("x_cms_assemble_control")!=-1)){
        //         var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
        //         var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
        //         var host3 = MWF.Actions.getHost("x_cms_assemble_control");
        //         if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
        //             value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
        //         }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
        //             value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
        //         }
        //         if (value.indexOf("/x_portal_assemble_surface")!==-1){
        //             value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
        //         }else if (value.indexOf("x_portal_assemble_surface")!==-1){
        //             value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
        //         }
        //         if (value.indexOf("/x_cms_assemble_control")!==-1){
        //             value = value.replace("/x_cms_assemble_control", host3+"/x_cms_assemble_control");
        //         }else if (value.indexOf("x_cms_assemble_control")!==-1){
        //             value = value.replace("x_cms_assemble_control", host3+"/x_cms_assemble_control");
        //         }
        //         value = o2.filterUrl(value);
        //     }
        //     this.node.setStyle(key, value);
        // }.bind(this));
    },
    _parseStyles: function( styles ){
        var s = {};
        Object.each(styles || {}, function(v, key){
            var value = v.toString();
            if ((value.indexOf("x_processplatform_assemble_surface")!=-1 || value.indexOf("x_portal_assemble_surface")!=-1 || value.indexOf("x_cms_assemble_control")!=-1) && !value.includes("../")){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                var host3 = MWF.Actions.getHost("x_cms_assemble_control");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                if (value.indexOf("/x_cms_assemble_control")!==-1){
                    value = value.replace("/x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }else if (value.indexOf("x_cms_assemble_control")!==-1){
                    value = value.replace("x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }
                value = o2.filterUrl(value);
            }
            s[key] = value;
        }.bind(this));
        return s;
    },
    _loadModuleEvents : function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!==-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!==-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            this.node.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }
    },
    _getBusinessData: function(id){
        var v;
        if (this.json.section=="yes"){
            v = this._getBusinessSectionData(id);
        }else {
            if (this.json.type==="Opinion"){
                v = this._getBusinessSectionDataByPerson(id);
            }else{
                // return this.form.businessData.data[this.json.id] || "";
                var value = this.getBusinessDataById(null, id);
                return (o2.typeOf(value)!=="null") ? value : "";
                //return this.getBusinessDataById() || "";
            }
        }
        //if (o2.typeOf(v)==="string") v = o2.dtxt(v);
        return v;
    },
    _getBusinessSectionData: function(id){
        switch (this.json.sectionBy){
            case "person":
                return this._getBusinessSectionDataByPerson(id);
            case "unit":
                return this._getBusinessSectionDataByUnit(id);
            case "activity":
                return this._getBusinessSectionDataByActivity(id);
            case "splitValue":
                return this._getBusinessSectionDataBySplitValue(id);
            case "script":
                return this._getBusinessSectionDataByScript(((this.json.sectionByScript) ? this.json.sectionByScript.code : ""), id);
            default:
                // return this.form.businessData.data[this.json.id] || "";
                return this.getBusinessDataById(null, id) || "";
        }
    },
    _getBusinessSectionDataByPerson: function(id){
        this.form.sectionListObj[id||this.json.id] = layout.desktop.session.user.id;
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById(null, id);
        return (dataObj) ? (dataObj[layout.desktop.session.user.id] || "") : "";
    },
    _getBusinessSectionDataByUnit: function(id){
        this.form.sectionListObj[id || this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById(null, id);
        if (!dataObj) return "";
        var key = (this.form.businessData.task) ? (this.form.businessData.task.unitDn || this.form.businessData.task.unit) : "";
        if (key) this.form.sectionListObj[id||this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },
    _getBusinessSectionDataByActivity: function(id){
        this.form.sectionListObj[id||this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById(null, id);
        if (!dataObj) return "";
        var key = (this.form.businessData.work) ? this.form.businessData.work.activity : "";
        if (key) this.form.sectionListObj[id||this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },
    _getBusinessSectionDataBySplitValue: function(id){
        this.form.sectionListObj[id||this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById(null, id);
        if (!dataObj) return "";
        var key = (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
        if (key) this.form.sectionListObj[id||this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },
    _getBusinessSectionDataByScript: function(code, id){
        this.form.sectionListObj[id||this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById(null, id);
        if (!dataObj) return "";
        var key = this.form.Macro.exec(code, this);
        if (key) this.form.sectionListObj[id||this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },
    _setEnvironmentData: function(v){
        if (this.json.section=="yes"){
            this._setEnvironmentSectionData(v);
        }else {
            if (this.json.type==="Opinion"){
                this._setEnvironmentSectionDataByPerson(v);
            }else{
                this.setEnvironmentDataById(v);
            }
        }
    },
    _setEnvironmentSectionData: function(v){
        switch (this.json.sectionBy){
            case "person":
                var key = layout.desktop.session.user.id;
                this._setEnvironmentSectionDataByKey(key, v);
                break;
            case "unit":
                var key = (this.form.businessData.task) ? (this.form.businessData.task.unitDn || this.form.businessData.task.unit) : "";
                this._setEnvironmentSectionDataByKey(key, v);
                break;
            case "activity":
                var key = (this.form.businessData.work) ? this.form.businessData.work.activity : "";
                this._setEnvironmentSectionDataByKey(key, v);
                break;
            case "splitValue":
                var key = (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
                this._setEnvironmentSectionDataByKey(key, v);
                break;
            case "script":
                var key = this.form.Macro.exec(this.json.sectionByScript.code, this);
                this._setEnvironmentSectionDataByKey(key, v);
                break;
            default:
                this.setEnvironmentDataById(v);
        }
    },
    _setEnvironmentSectionDataByKey: function(key, v){
        if (key){
            var evdata = this.getBusinessDataById(this.form.Macro.environment.data);
            var evdata;
            if (!evdata){
                evdata = this.setEnvironmentDataById({});
            }
            if (!evdata.hasOwnProperty(key)){
                evdata.add(key, v);
            }else{
                evdata[key] = v;
            }
        }
    },
    setEnvironmentDataById: function(v){
        //对id类似于 xx..0..xx 的字段进行拆分
        var evdata = this.form.Macro.environment.data;
        if(this.json.id.indexOf("..") < 1){
            if (!evdata.hasOwnProperty(this.json.id)){
                evdata.add(this.json.id, v);
            }else{
                evdata[this.json.id] = v;
            }

        }else{
            var idList = this.json.id.split("..");
            idList = idList.map( function(d){ return d.test(/^\d+$/) ? d.toInt() : d; });

            //var data = this.form.businessData.data;
            var lastIndex = idList.length - 1;

            for(var i=0; i<=lastIndex; i++){
                var id = idList[i];
                if( !id && id !== 0 )return;

                if( i === lastIndex ){
                    if (!evdata.hasOwnProperty(id)){
                        evdata.add(id, v);
                    }else{
                        evdata[id] = v;
                    }
                }else{
                    var nexId = idList[i+1];
                    if(o2.typeOf(nexId) === "number"){ //下一个ID是数字
                        if( !evdata[id] && o2.typeOf(evdata[id]) !== "array" ){
                            evdata.add(id, []);
                        }
                        if( nexId > evdata[id].length ){ //超过了最大下标，丢弃
                            return;
                        }
                    }else{ //下一个ID是字符串
                        if( !evdata[id] || o2.typeOf(evdata[id]) !== "object"){
                            evdata.add(id, {});
                        }
                    }
                    evdata = evdata[id];
                }
            }
        }
        return evdata;
    },

    _setBusinessData: function(v, id){
        //if (o2.typeOf(v)==="string") v = o2.txt(v);
        if (!this.isEditable) return;
        if (this.json.section=="yes"){
            this._setBusinessSectionData(v, id);
        }else {
            if (this.json.type==="Opinion"){
                this._setBusinessSectionDataByPerson(v, id);
            }else{
                this.setBusinessDataById(v, id);
                if (this.json.isTitle) this.form.businessData.data.$work.title = v;
            }
        }
    },
    _setBusinessSectionData: function(v, id){
        switch (this.json.sectionBy){
            case "person":
                this._setBusinessSectionDataByPerson(v, id);
                break;
            case "unit":
                this._setBusinessSectionDataByUnit(v, id);
                break;
            case "activity":
                this._setBusinessSectionDataByActivity(v, id);
                break;
            case "splitValue":
                this._setBusinessSectionDataBySplitValue(v, id);
                break;
            case "script":
                this._setBusinessSectionDataByScript(this.json.sectionByScript.code, v, id);
                break;
            default:
                this.setBusinessDataById(v, id);
        }
    },
    _setBusinessSectionDataByPerson: function(v, id){
        var key = layout.desktop.session.user.id;
        this._setBusinessSectionDataByKey(key, v, id);
    },
    _setBusinessSectionDataByUnit: function(v, id){
        var key = (this.form.businessData.task) ? (this.form.businessData.task.unitDn || this.form.businessData.task.unit) : "";
        this._setBusinessSectionDataByKey(key, v, id);
    },
    _setBusinessSectionDataByActivity: function(v, id){
        var key = (this.form.businessData.work) ? this.form.businessData.work.activity : "";
        this._setBusinessSectionDataByKey(key, v, id);
    },
    _setBusinessSectionDataBySplitValue: function(v, id){
        var key = (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
        this._setBusinessSectionDataByKey(key, v, id);
    },
    _setBusinessSectionDataByScript: function(code, v, id){
        var key = this.form.Macro.exec(code, this);
        this._setBusinessSectionDataByKey(key, v, id);
    },
    _setBusinessSectionDataByKey: function(key, v, id){
        if (key){
            var dataObj = this.getBusinessDataById(null, id);
            var evdata;
            if (!dataObj){
                dataObj = {};
                evdata = this.setBusinessDataById(dataObj, id);
            }
            dataObj[key] = v;
            if (evdata) evdata.check(key, v);
        }
    },
    getBusinessDataById: function(d, id){
        var data = d || this.form.businessData.data;
        var thisId = id || this.json.id;
        //对id类似于 xx..0..xx 的字段进行拆分
        if(thisId.indexOf("..") < 1){
            return data[thisId];
        }else{
            var idList = thisId.split("..");
            idList = idList.map( function(d){ return d.test(/^\d+$/) ? d.toInt() : d; });

            var lastIndex = idList.length - 1;

            for(var i=0; i<=lastIndex; i++){
                var id = idList[i];
                if( !id && id !== 0 )return null;
                if( ["object","array"].contains(o2.typeOf(data)) ){
                    if( i === lastIndex ){
                        return data[id];
                    }else{
                        data = data[id];
                    }
                }else{
                    return null;
                }
            }
        }
    },
    _checkEvdata: function(evdata, id, v){
        switch (o2.typeOf(evdata)){
            case "array":

                break;
            default:
                evdata.check(id, v);
        }
    },
    setBusinessDataById: function(v, id){
        //对id类似于 xx..0..xx 的字段进行拆分
        var evdata = this.form.Macro.environment.data;
        var data = this.form.businessData.data;
        var thisId = id || this.json.id;
        if(thisId.indexOf("..") < 1){
            data[thisId] = v;
            this._checkEvdata(evdata, thisId, v);
            //this.form.businessData.data[this.json.id] = v;
        }else{
            var idList = thisId.split("..");
            idList = idList.map( function(d){ return d.test(/^\d+$/) ? d.toInt() : d; });

            //var data = this.form.businessData.data;
            var lastIndex = idList.length - 1;

            for(var i=0; i<=lastIndex; i++){
                var id = idList[i];
                if( !id && id !== 0 )return;

                if( i === lastIndex ){
                    data[id] = v;
                    //evdata.check(id, v);
                    this._checkEvdata(evdata, id, v);
                }else{
                    var nexId = idList[i+1];
                    if(o2.typeOf(nexId) === "number"){ //下一个ID是数字
                        if( !data[id] && o2.typeOf(data[id]) !== "array" ){
                            data[id] = [];
                            //evdata.check(id, []);
                            this._checkEvdata(evdata, id, []);
                        }
                        if( nexId > data[id].length ){ //超过了最大下标，丢弃
                            return;
                        }
                    }else{ //下一个ID是字符串
                        if( !data[id] || o2.typeOf(data[id]) !== "object"){
                            data[id] = {};
                            //evdata.check(id, {});
                            this._checkEvdata(evdata, id, {});
                        }
                    }
                    data = data[id];
                    evdata = evdata[id];
                }
            }
        }
        return evdata;
    },

    setValue: function(){
    },
    focus: function(){
        this.node.focus();
    },

    _getModuleByPath: function( path ){
        /*
        注: 系统的数据中允许多层路径，id上通过..来区分层次：
        1、单层或者是最外层，填"fieldId"，表示表单上的直接组件。
        2、如果有多层数据模板，"./fieldId"表示和当前组件id同层次的组件，"../fieldId"表示和上一层组件同层次的组件，以此类推。
        3、如果有多层数据模板，也可通过"datatemplateId.*.datatemplateId2.*.fieldId"来表示全层次路径。datatemplateId表示第一层数据模板的id，datatemplateId2表示第二层的id。
         */
        if(!path)return;
        var idList = this.json.id.split("..");
        if( path.contains("*") ){ //允许path中包含*，替代当前path的层次
            var paths = path.split(".");
            for( var i=0; i<paths.length; i++ ){
                if( paths[i].contains("*") && idList[i] ){
                    var key = paths[i].replace("*", idList[i]);
                    key = this.form.Macro.exec("return "+key, this);
                    paths[i] = (key||"").toString();
                }
            }
            path = paths.join("..");
        }else if( path.contains("./") ){

            var lastName = path.substring(path.indexOf("./")+2, path.length);
            var level = (path.substring(0, path.indexOf("./"))+".").split(".").length-1; // /前面有几个.

            var idList_copy = Array.clone(idList);
            if( idList_copy.length > level*2 ){
                for( var i=0; i<level; i++ ){
                    idList_copy.pop();
                    if( i > 0)idList_copy.pop();
                }
                path = idList_copy.join("..")+".."+lastName;
            }else{
                idList_copy[idList_copy.length-1] = lastName;
                path = idList_copy.join("..")
            }
        }

        return this.form.all[path];
    },
    clearDefaultMargin: function (){
        var marginStyle = this.node.getStyle('margin-right');
        var paddingStyle = this.node.getStyle('padding-right');
        if( marginStyle === '20px' || paddingStyle === '4px' ){
            var map = {};
            Object.each(this.json.recoveryStyles || {}, function(value, key){
                var k = key.toLowerCase();
                if( ['margin','margin-right','padding', 'padding-right'].contains(k) ){
                    map[k] = value;
                }
            });
            if( marginStyle === '20px' && map['margin'] !== '20px' && map['margin-right'] !== '20px') {
                this.node.setStyle('margin-right', '0');
            }
            if( paddingStyle === '4px' && map['padding'] !== '4px' && map['padding-right'] !== '4px') {
                this.node.setStyle('padding-right', '0');
            }
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class $Input 组件类，此类为所有输入组件的父类
 * @hideconstructor
 * @o2category FormComponents
* @extends MWF.xApplication.process.Xform.$Module
 * @abstract
 */
MWF.xApplication.process.Xform.$Input = MWF.APP$Input =  new Class(
    /** @lends MWF.xApplication.process.Xform.$Input# */
    {
	Implements: [Events],
	Extends: MWF.APP$Module,
	iconStyle: "personfieldIcon",
    options: {
        "moduleEvents": ["change", "load", "queryLoad", "postLoad"]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
        this.nodeHtml = this.node.get("html");
    },
	_loadUserInterface: function(){
        if ( this.isSectionMergeRead() ) { //区段合并显示
            this._loadMergeReadNode();
        }else{
            if( this.isSectionMergeEdit() ){
                this._loadMergeEditNode();
            }else{
                this._loadNode();
            }
            if (this.json.compute === "show"){
                this._setValue(this._computeValue());
            }else{
                this._loadValue();
            }
        }
	},
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    (this.node.getFirst() || this.node).addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!==-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    (this.node.getFirst() || this.node).addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            (this.node.getFirst() || this.node).addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }
    },
    /**
     * @summary 重新加载组件。会执行postLoad事件。
     * @example
     * this.form.get("fieldId").reload(); //重新加载事件
     */
    reload: function(){
        if( this.iconNode ){
            this.iconNode.destroy();
            this.iconNode = null;
        }
        if( this.descriptionNode ){
            this.descriptionNode.destroy();
            this.descriptionNode = null;
        }
        this.node.empty();
        this._beforeReloaded();
        this._loadUserInterface();
        this._loadStyles();
        this._afterLoaded();
        this._afterReloaded();
        this.fireEvent("postLoad");
    },
    _loadNode: function(){
        if (this.isReadonly()){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        this.clearDefaultMargin();
    },
    loadDescription: function(){
        if (this.isReadonly())return;
        var v = this._getBusinessData();
        if (!v){
            if (this.json.description){
                var size, w;
                if( this.node.offsetParent === null ){ //隐藏
                    size = { y: 26 }
                }else{
                    size = this.node.getFirst().getSize();
                    // w = size.x-3;
                    // if( this.hasIcon() ){
                    //     if (COMMON.Browser.safari) w = w-20;
                    // }
                }

                /**
                 * @summary 描述信息节点，允许用户手工输入的组件才有此节点，只读情况下无此节点.
                 * @member {Element}
                 */
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                // if( w )this.descriptionNode.setStyles({
                //     "width": ""+w+"px"
                // });
                this.descriptionNode.setStyles({
                    "width": "auto",
                    "overflow": "auto"
                });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function(){
                    this.descriptionNode.setStyle("display", "none");
                    this.clickSelect();
                }.bind(this)
            });
            this.node.getFirst().addEvents({
                "focus": function(){
                    if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
                }.bind(this),
                "blur": function(){
                    if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
                }.bind(this)
            });
        }
    },
    checkDescription: function(){
        if (!this.node.getFirst().get("value")){
            if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
        }else{
            if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
        }
    },
    _resetNodeEdit: function(){
        var input = new Element("input", {
            "styles": {
                "background": "transparent",
                "width": "100%",
                "border": "0px"
            },
            "readonly": true
        });

        var node = new Element("div", {"styles": {
                "overflow": (this.json.styles && this.json.styles.overflow) ? this.json.styles.overflow : "hidden",
                "position": "relative",
                "margin-right": this.hasIcon() ? "20px" : "0px",
                "padding-right": "4px"
            }}).inject(this.node, "after");
        input.inject(node);

        this.node.destroy();
        this.node = node;
    },
    hasIcon: function(){
	    return this.json.showIcon!='no' && ( !this.form.json || !this.form.json.hideModuleIcon );
    },
    _loadNodeEdit: function(){
	    if (!this.json.preprocessing) this._resetNodeEdit();
	    var input = this.node.getFirst();
        if( !input && this.nodeHtml ){
            this.node.set("html", this.nodeHtml);
            input = this.node.getFirst();
        }
        input.set(this.json.properties);
		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type,
			"readonly": true,
			"events": {
				"click": this.clickSelect.bind(this)
			}
		});
        if ( this.hasIcon() ){
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.node.getFirst().addEvent("change", function(){
            this.validationMode();
            if (this.validation()) {
                this._setBusinessData(this.getInputData("change"));
                this.fireEvent("change");
            }
        }.bind(this));
        //
        // var inputNode = this.node.getFirst();
        // if (inputNode) inputNode.addEvent("input", function(e){
        //     var v=e.target.get("value");
        //     this._setEnvironmentData(v);
        // }.bind(this));
	},
    _loadStyles: function(){
        if (this.json.styles) this.node.setStyles(this.json.styles);
        if (this.json.inputStyles) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
        if (this.iconNode && this.iconNode.offsetParent !== null){
            var size = this.node.getSize();
            //if (!size.y){
            //    var y1 = this.node.getStyle("height");
            //    var y2 = this.node.getFirst().getStyle("height");
            //    alert(y1+"," +y2);
            //    var y = ((y1!="auto" && y1>y2) || y2=="auto") ? y1 : y2;
            //    size.y = (y=="auto") ? "auto" : y.toInt();
            //    //alert(size.y)
            //}
            this.iconNode.setStyle("height", ""+size.y+"px");
            //alert(this.iconNode.getStyle("height"))
        }
    },
    _computeValue: function(value){
        return (this.json.defaultValue && this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
    },
	getValue: function(){
        if (!this.isReadable) return '';
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if (o2.typeOf(value)==="null" || value==='') value = this._computeValue();
		return value ?? "";
	},
    _setValue: function(value){
        if (!!value && o2.typeOf(value.then)=="function"){
            var p = Promise.resolve(value).then(function(v){
                this.__setValue(v);
            }.bind(this), function(){});
            this.moduleValueAG = p;
        }else{
            this.moduleValueAG = null;
            this.__setValue(value);
        }
    },
    __setValue: function(value){
        this.moduleValueAG = null;
        this._setBusinessData(value);
        if (this.node.getFirst()) this.node.getFirst().set("value", value || "");
        if (this.isReadonly()) this.node.set("text", value);
        this.moduleValueAG = null;
        this.fieldModuleLoaded = true;
        return value;
    },

	_loadValue: function(){
        this._setValue(this.getValue());
	},
	clickSelect: function(){
	},
	_afterLoaded: function(){
//		if (this.iconNode){
////			var p = this.node.getPosition();
////			var s = this.node.getSize();
////			var is = this.iconNode.getSize();
////
////			var y = p.y;
////			var x = p.x+s.x-is.x;
//			this.iconNode.setStyles({
//				"top": "5px",
//				"left": "-18px"
//			});
//		}
        if (!this.isReadonly()){
            this.loadDescription();
        }
	},
    _beforeReloaded: function(){},
    _afterReloaded: function(){},
    /**
     * @summary 判断组件是否只读.
     * @example
     * var readonly = this.form.get('subject').isReadonly();
     * @return {Boolean} 是否只读.
     */
	isReadonly : function(){
        return !!(!this.isEditable || this.readonly || this.json.isReadonly || this.form.json.isReadonly || this.json.showMode==="read" || this.isSectionMergeRead());
    },
	getTextData: function(){
		//var value = this.node.get("value");
		//var text = this.node.get("text");
        var value = (this.node.getFirst()) ? this.node.getFirst().get("value") : this.node.get("text");
        var text = (this.node.getFirst()) ? this.node.getFirst().get("text") : this.node.get("text");
		return {"value": [value || ""] , "text": [text || value || ""]};
	},
    /**
     * @summary 判断组件值是否为空.
     * @example
     * if( this.form.get('subject').isEmpty() ){
     *     this.form.notice('标题不能为空', 'warn');
     * }
     * @return {Boolean} 值是否为空.
     */
    isEmpty : function(){
	    var data = this.getData();
	    return !data || !data.trim();
    },
    /**
     * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
     * 区别如下：<br/>
     * 1、当使用Promise的时候<br/>
     * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
     * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
     * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
     * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
     * @summary 获取组件值。
     * @example
     * var data = this.form.get('fieldId').getData(); //没有使用promise的情况、
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  var data;
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      data = this.form.get('fieldId').getData();
     *  }else{
     *      data = this.data['fieldId']; //直接从数据中获取字段值
     *  }
     * @example
     *  //使用Promise的情况
     *  var field = this.form.get("fieldId");
     *  var dict = new this.Dict("test"); //test为数据字典名称
     *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
     *  promise.then( function(){
     *      var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获取到了数据字典的值
     *  })
     *  field.setData( promise );
     * @return 组件的数据.
     */
	getData: function(when){
        if (this.json.compute == "save") this._setValue(this._computeValue());
        return this.getInputData();
	},
    getInputData: function(){
        if (this.node.getFirst()){
            return this.node.getFirst().get("value");
        }else{
            return this._getBusinessData();
        }
    },
    // /**
    //  * @summary 重置组件的值为默认值或置空。
    //  *  @example
    //  * this.form.get('subject').resetData();
    //  */
    resetData: function(){
        this.setData(this.getValue());
    },
    /**当参数为Promise的时候，请参考文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
     * 当表单上没有对应组件的时候，可以使用this.data.add(fieldId, data, true) 赋值。
     * @summary 为组件赋值。
     * @param data{String|Promise} .
     * @param fireChange{boolean} 可选，是否触发change事件，默认false.
     * @example
     *  this.form.get("fieldId").setData("test"); //赋文本值
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      this.form.get('fieldId').setData( data );
     *  }else{
     *      this.data.add(fieldId, data, true);
     *  }
     * @example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var dict = new this.Dict("test"); //test为数据字典名称
     *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
     *  field.setData( promise );
     */
	setData: function(data, fireChange){
        // if (data && data.isAG){
        //     var ag = o2.AG.all(data).then(function(v){
        //         if (o2.typeOf(v)=="array") v = v[0];
        //         this.__setData(v);
        //     }.bind(this));
        //     this.moduleValueAG = ag;
        //     ag.then(function(){
        //         this.moduleValueAG = null;
        //     }.bind(this));
        // }else{
        if (!!data && o2.typeOf(data.then)=="function"){
            var p = o2.promiseAll(data).then(function(v){
                this.__setData(v, fireChange);
                // if (this.node.getFirst() && !this.readonly && !this.json.isReadonly) {
                //     this.checkDescription();
                //     this.validationMode();
                // }
            }.bind(this), function(){});
            this.moduleValueAG = p;
            p.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
        }else{
            this.moduleValueAG = null;
            this.__setData(data, fireChange);
            // if (this.node.getFirst() && !this.readonly && !this.json.isReadonly) {
            //     this.checkDescription();
            //     this.validationMode();
            // }
        }
            //this.__setData(data);
        //}
	},
    __setData: function(data, fireChange){
	    var old = this.getInputData();
        this._setBusinessData(data);
        if (this.node.getFirst()){
            this.node.getFirst().set("value", data);
            this.checkDescription();
            this.validationMode();
        }else{
            this.node.set("text", data);
        }
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },


    createErrorNode: function(text){

        //var size = this.node.getFirst().getSize();
        //var w = size.x-3;
        //if (COMMON.Browser.safari) w = w-20;
        //node.setStyles({
        //    "width": ""+w+"px",
        //    "height": ""+size.y+"px",
        //    "line-height": ""+size.y+"px",
        //    "position": "absolute",
        //    "top": "0px"
        //});
        var node;
        if( this.form.json.errorStyle ){
            if( this.form.json.errorStyle.type === "notice" ){
                if( !this.form.errorNoticing ){ //如果是弹出
                    this.form.errorNoticing = true;
                    this.form.notice(text, "error", this.node, null, null, {
                        onClose : function () {
                            this.form.errorNoticing = false;
                        }.bind(this)
                    });
                }
            }else{
                node = new Element("div",{
                    "styles" : this.form.json.errorStyle.node,
                    "text": text
                });
                if( this.form.json.errorStyle.close ){
                    var closeNode = new Element("div",{
                        "styles" : this.form.json.errorStyle.close ,
                        "events": {
                            "click" : function(){
                                //this.destroy();
                                this.validationMode();
                            }.bind(this)
                        }
                    }).inject(node);
                }
            }
        }else{
            node = new Element("div", {styles:{
                "margin-top": "0.3em"  
            }});
            var iconNode = new Element("div.ooicon-error", {
                "styles": {
                    "width": "20px",
                    "height": "1.2em",
                    "float": "left",
                    "display": "flex",
                    "color": "red",
                    "align-items": "center",
                    "justify-content": "center"
                    // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                }
            }).inject(node);
            var textNode = new Element("div", {
                "styles": {
                    "height": "auto",
                    "line-height": "1.2em",
                    "margin-left": "20px",
                    "color": "red",
                    "word-break": "keep-all"
                },
                "text": text
            }).inject(node);
        }
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border-color", "red");

            this.errNode = this.createErrorNode(text);
            //if (this.iconNode){
            //    this.errNode.inject(this.iconNode, "after");
            //}else{
                this.errNode.inject(this.node, "after");
            //}
            this.showNotValidationMode(this.node);

            var parentNode = this.errNode;
            while( parentNode && parentNode.offsetParent === null ){
                parentNode = parentNode.getParent();
            }

            if ( parentNode && !parentNode.isIntoView()) parentNode.scrollIntoView(false);
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            var mwftype = p.get("MWFtype") || p.get("mwftype");
            if (mwftype == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function(routeName, data){
        var flag = (data.status==="all") ? true: (routeName === data.decision);
        if (flag){
            var n = this.getInputData();
            var v = (data.valueType==="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if ((!v && v!==0) || (o2.typeOf(v)==="array" && !v.length)){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },

    getExcelData: function(){
        return this.getData();
    },
    setExcelData: function(data){
	    if( typeOf(data) === "string" )data = data.replace(/&#10;/g,""); //excel字段换行是 &#10
        this.excelData = data;
        this.setData(data, true);
    },
    stringToArray: function(string){ //excel字段换行是 &#10;，换行和逗号作为数组分隔符
        return string.replace(/&#10;/g,",").split(/\s*,\s*/g ).filter(function(s){
            return !!s;
        });
    },
    validationExcel: function () {
        if (!this.isReadonly()){
            var errorList = this.validationConfigExcel();
            if (errorList.length) return errorList;

            if (!this.json.validation) return [];
            if (!this.json.validation.code) return [];

            var flag = this.form.Macro.exec(this.json.validation.code, this);

            if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
            if (flag.toString() !== "true") {
                return [flag];
            }
        }
        return [];
    },
    validationConfigExcel: function () {
	    var errorList = [];
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var flag = this.validationConfigItemExcel(this.json.validationConfig[i]);
                    if ( flag !== true ){
                        errorList.push( flag );
                    }
                }
            }
        }
        return errorList;
    },
    validationConfigItemExcel: function(data){
        if ( data.status==="all"){
            var n = this._getBusinessData();
            var ed = typeOf( this.excelData ) === "null" ? "" : this.excelData;
            var v, ev;
            if(data.valueType==="value"){
                v = n;
                ev = ed;
            }else{
                v = n.length;
                ev = ed.length || 0;
            }
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        return !ev ? data.prompt : "不在选项中";
                    }
                    break;
                case "notnull":
                    if (v)return data.prompt;
                    break;
                case "gt":
                    if (v>data.value)return data.prompt;
                    break;
                case "lt":
                    if (v<data.value)return data.prompt;
                    break;
                case "equal":
                    if (v===data.value)return data.prompt;
                    break;
                case "neq":
                    if (v!==data.value)return data.prompt;
                    break;
                case "contain":
                    if (v.indexOf(data.value)!==-1) return data.prompt;
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)===-1)return data.prompt;
                    break;
            }
        }
        return true;
    }
});

o2.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @classdesc $Selector 组件类，此类为所有可选组件的父类
 * @class
 * @hideconstructor
 * @o2category FormComponents
 * @extends MWF.xApplication.process.Xform.$Input
 * @abstract
 */
MWF.xApplication.process.Xform.$Selector = MWF.APP$Selector = new Class(
    /** @lends MWF.xApplication.process.Xform.$Selector# */
{
    Extends: MWF.APP$Input,

    /**
     * 组件加载后触发。如果选项加载为异步，则异步处理完成后触发此事件
     * @event MWF.xApplication.process.Xform.$Selector#load
     * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
     */

    _showValue: function (node, value) {
        var optionItems = this.getOptions();
        if (optionItems && typeOf(optionItems.then) === "function") {
            optionItems.then(function (opt) {
                this.__showValue(node, value, opt)
            }.bind(this));
        } else {
            this.__showValue(node, value, optionItems)
        }
    },
    /**
     * @summary 刷新选择项，如果选择项是脚本，重新计算。
     * @example
     * this.form.get('fieldId').resetOption();
     */
    resetOption: function () {
        this.node.empty();
        this.setOptions();
        if( this.moduleSelectAG && this.moduleSelectAG.then ){
            this.moduleSelectAG.then(function(){
                if( this.json.type === 'Select' )this._checkData();
                this.fireEvent("resetOption");
            }.bind(this));
        }else{
            if( this.json.type === 'Select' )this._checkData();
            this.fireEvent("resetOption");
        }
    },
    _checkData: function (){
        var d1 = this.getData(), d2 = this._getBusinessData();
        switch (o2.typeOf(d1)) {
            case "string":
                if( d1 !== d2 )this._setBusinessData(d1);
                break;
            case 'array':
                if (d1.join(",") !== d2.join(",")) {
                    this._setBusinessData(d1);
                }
                break;
        }
    },
    setBusinessDataById: function(v, id ){
        //对id类似于 xx..0..xx 的字段进行拆分
        var evdata = this.form.Macro.environment.data;
        var data = this.form.businessData.data;
        var thisId = id || this.json.id;
        var text = this.getText();

        if(thisId.indexOf("..") < 1){
            data[thisId] = v;
            data[thisId+"$text"] = text;
            this._checkEvdata(evdata, thisId, v);
            this._checkEvdata(evdata, thisId+"$text", text);

            //console.log(thisId)
            //this.form.businessData.data[this.json.id] = v;
        }else{

            var idList = thisId.split("..");
            idList = idList.map( function(d){ return d.test(/^\d+$/) ? d.toInt() : d; });

            //var data = this.form.businessData.data;
            var lastIndex = idList.length - 1;

            for(var i=0; i<=lastIndex; i++){

                var id = idList[i];
                if( !id && id !== 0 )return;

                if( i === lastIndex ){
                    data[id] = v;
                    data[id + "$text"] = text;
                    //evdata.check(id, v);
                    this._checkEvdata(evdata, id, v);
                    this._checkEvdata(evdata, id + "$text", text);
                }else{
                    var nexId = idList[i+1];
                    if(o2.typeOf(nexId) === "number"){ //下一个ID是数字
                        if( !data[id] && o2.typeOf(data[id]) !== "array" ){
                            data[id] = [];
                            //evdata.check(id, []);
                            this._checkEvdata(evdata, id, []);
                        }
                        if( nexId > data[id].length ){ //超过了最大下标，丢弃
                            return;
                        }
                    }else{ //下一个ID是字符串
                        if( !data[id] || o2.typeOf(data[id]) !== "object"){
                            data[id] = {};
                            //evdata.check(id, {});
                            this._checkEvdata(evdata, id, {});
                        }
                    }
                    data = data[id];
                    evdata = evdata[id];
                }
            }
        }
        return evdata;
    },
    /**
     * @summary 获取选择项。
     * @return {Array | Promise} 返回选择项数组或Promise，如：<pre><code class='language-js'>[
     *  "女|female",
     *  "男|male"
     * ]</code></pre>
     * @example
     * this.form.get('fieldId').getOptions();
     * @example
     * //异步
     * var opt = this.form.get('fieldId').getOptions();
     * Promise.resolve(opt).then(function(options){
     *     //options为选择项数组
     * })
     */
    getOptions: function (async, refresh) {
        this.optionsCache = null;
        var opt = this._getOptions(async, refresh);
        if ((opt && typeOf(opt.then) === "function")) {
            var p = Promise.resolve(opt).then(function (option) {
                this.moduleSelectAG = null;
                this.optionsCache = (option || []);
                return this.optionsCache;
            }.bind(this));
            this.moduleSelectAG = p;
            return p;
        } else {
            this.optionsCache = (opt || []);
            return this.optionsCache;
        }
    },
    _getOptions: function (async, refresh) {
        switch (this.json.itemType) {
            case "values":
                return this.json.itemValues;
            case "script":
                return this.form.Macro.exec(((this.json.itemScript) ? this.json.itemScript.code : ""), this);
            default:
                break;
        }

        var opts, firstOpts = this.getFirstOption();
        switch (this.json.itemType) {
            case "dict":
                opts = this.getOptionsWithDict(async, refresh);
                break;
            case "view":
                opts = this.getOptionsWithView(async, refresh);
                break;
            case "statement":
                opts = this.getOptionsWithStatement(async, refresh);
                break;
        }
        if (opts && typeOf(opts.then) === "function") {
            return Promise.resolve(opts).then(function (opts) {
                return this._contactOption(firstOpts, opts);
            }.bind(this));
        } else {
            return this._contactOption(firstOpts, opts);
        }
        // if( (defaultOpts && typeOf(defaultOpts.then) === "function" ) || (opts && typeOf(opts.then) === "function" ) ){
        //     return Promise.all( [defaultOpts, opts] ).then(function (arr) {
        //         return this._contactOption( arr[0], arr[1] );
        //     }.bind(this));
        // }else{
        //     return this._contactOption( defaultOpts, opts );
        // }
    },
    _contactOption: function (opt1, opt2) {
        var optA, optB;
        if (!opt1) opt1 = [];
        if (!opt2) opt2 = [];
        optA = typeOf(opt1) !== "array" ? [opt1] : opt1;
        optB = typeOf(opt2) !== "array" ? [opt2] : opt2;
        optA.each(function (o) {
            if (o) optB.unshift(o);
        });
        return optB;
    },
    getFirstOption: function () {
        //return this.form.Macro.exec(((this.json.defaultOptionsScript) ? this.json.defaultOptionsScript.code : ""), this);
        if (!this.json.firstOptionEnable) return [];
        return [this.json.firstOption || "|"];
    },

    /**
     * @summary 获取整理后的选择项。
     * @param {Boolean} [refresh] 是否忽略缓存重新计算可选项。
     * @return {Object} 返回整理后的选择项数组或Promise，如：
     * <pre><code class='language-js'>{"valueList": ["","female","male"], "textList": ["","女","男"]}
     * </code></pre>
     * @example
     * var optionData = this.form.get('fieldId').getOptionsObj();
     * @example
     * //异步
     * var opt = this.form.get('fieldId').getOptionsObj(true);
     * Promise.resolve(opt).then(function(optionData){
     *     //optionData为选择项
     * })
     */
    getOptionsObj: function (refresh) {
        var optionItems = (refresh !== true && this.optionsCache) ? this.optionsCache : this.getOptions();
        if (optionItems && typeOf(optionItems.then) === "function") {
            return Promise.resolve(optionItems).then(function (optItems) {
                return this._getOptionsObj(optItems);
            }.bind(this));
        } else {
            return this._getOptionsObj(optionItems);
        }
    },
    _getOptionsObj: function (optItems) {
        var textList = [];
        var valueList = [];
        optItems.each(function (item) {
            switch (o2.typeOf(item)){
                case 'string':
                    var tmps = item.split("|");
                    textList.push(tmps[0]);
                    valueList.push(tmps[1] || tmps[0]);
                    break;
                case 'object':
                    textList.push(item.label || item.text);
                    valueList.push(item.value);
                    break;
            }
        });
        return {textList: textList, valueList: valueList};
    },

    setOptions: function () {
        var optionItems = this.getOptions();
        this._setOptions(optionItems);
    },

    /**
     * @summary 获取选中项的value和text。
     * @return {Object} 返回选中项的value和text，如：
     * <pre><code class='language-js'>{"value": ["male"], "text": ["男"]}
     * {"value": [""], "text": [""]}
     * </code></pre>
     * @example
     * var data = this.form.get('fieldId').getTextData();
     * var text = data.text[0] //获取选中项的文本
     */
    getTextData: function () {
        var ops;
        if (this.isReadonly() || !this._getInputTextData || (this.json.type || '').substring(0, 2) === 'El' ) {
            ops = this.getOptionsObj();
            var data = this._getBusinessData();
            var d = typeOf(data) === "array" ? data : [data];
            if (ops && typeOf(ops.then) === "function") {
                return Promise.resolve(ops).then(function (opts) {
                    return this._getTextData(d, opts)
                }.bind(this));
            } else {
                return this._getTextData(d, ops)
            }
        } else {
            return this._getInputTextData();
        }
    },
    _getTextData: function (d, opts) {
        var value = [], text = [];
        d.each(function (v) {
            var idx = opts.valueList.indexOf(v);
            value.push(v || "");
            text.push(idx > -1 ? opts.textList[idx] : (v || ""));
        });
        if (!value.length) value = [""];
        if (!text.length) text = [""];
        return {"value": value, "text": text};
    },
    getOptionsWithDict: function (async, refresh) {
        if (!this.json.itemDict || !this.json.itemDict.length) return [];
        var obj = this.json.itemDict[0];
        var dict = new this.form.Macro.environment.Dict({
            "type": obj.appType,
            "application": obj.appId,
            "name": obj.id
        });

        var paths = (this.json.itemDictPath || "").split("/");
        paths.splice(0, 1); //第一个是root，删掉
        var path = paths.length ? paths.join(".") : null;

        var asy = o2.typeOf(async) === "boolean" ? async : (this.json.itemDictAsync !== false);
        var data = dict.get(path, null, null, asy, !this.json.dictUseCache);
        if (data && typeOf(data.then) === "function") {
            return data.then(function (data) {
                return this.parseDictOptions(data);
            }.bind(this));
        } else {
            return this.parseDictOptions(data);
        }
    },
    getString: function (d) {
        switch (o2.typeOf(d)) {
            case "null":
                return "";
            case "string":
                return d;
            case "boolean":
            case "number":
            case "date":
                return d.toString();
            default:
                return "";
        }
    },
    parseDictOptions: function (d) {
        var arr = [], value, text, valuekey = this.json.dictValueKey, textkey = this.json.dictTextKey;
        switch (o2.typeOf(d)) {
            case "array":
                d.each(function (i) {
                    switch (o2.typeOf(i)) {
                        case "object":
                            if (valuekey && textkey) {
                                value = this.getString(i[valuekey]);
                                text = this.getString(i[textkey]);
                                arr.push(text + "|" + value);
                            } else if (valuekey) {
                                arr.push(this.getString(i[valuekey]));
                            } else if (textkey) {
                                arr.push(this.getString(i[textkey]));
                            }
                            break;
                        case "null":
                            break;
                        default:
                            arr.push(i.toString());
                            break;
                    }
                }.bind(this));
                return arr;
            case "object":
                Object.each(d, function (i, key) {
                    switch (o2.typeOf(i)) {
                        case "object":
                            if (valuekey && textkey) {
                                value = this.getString(i[valuekey]);
                                text = this.getString(i[textkey]);
                                arr.push(value + "|" + text);
                            } else if (valuekey) {
                                arr.push(this.getString(i[valuekey]));
                            } else if (textkey) {
                                arr.push(this.getString(i[textkey]));
                            }
                            break;
                        case "null":
                            break;
                        default:
                            arr.push(i.toString() + "|" + key.toString());
                            break;
                    }
                }.bind(this))
                return arr;
            case "null":
                return [];
            default:
                return [d.toString()];
        }
    },
    getOptionsWithView: function (async, refresh) {
        if (!this.json.itemView) return [];
        var obj = this.json.itemView;

        var asy = o2.typeOf(async) === "boolean" ? async : (this.json.itemViewAsync !== false);

        var filter = [];
        if (this.json.viewFilterList && this.json.viewFilterList.length) {
            this.json.viewFilterList.each(function (entry) {
                entry.value = this.form.Macro.exec(entry.code.code, this);
                filter.push(entry);
            }.bind(this));
        }

        var data = this.form.Macro.environment.view.lookup({
            "view": obj.id,
            "application": obj.application,
            "filter": filter
        }, null, asy);
        if (data && typeOf(data.then) === "function") {
            return data.then(function (data) {
                return this.parseViewOptions(data);
            }.bind(this));
        } else {
            return this.parseViewOptions(data);
        }
    },
    parseViewOptions: function (json) {
        var arr = [], value, text, valuekey = this.json.viewValueColumn, textkey = this.json.viewTextColumn;
        json.grid.each(function (d) {
            var i = d.data || {};
            if (valuekey && textkey) {
                value = valuekey === "bundle" ? d.bundle : (this.getString(i[valuekey]));
                text = textkey === "bundle" ? d.bundle : (this.getString(i[textkey]));
                arr.push(text + "|" + value);
            } else if (valuekey) {
                arr.push(valuekey === "bundle" ? d.bundle : (this.getString(i[valuekey])));
            } else if (textkey) {
                arr.push(textkey === "bundle" ? d.bundle : (this.getString(i[textkey])));
            }
        }.bind(this))
        return arr.unique();
    },

    getOptionsWithStatement: function (async, refresh) {
        if (!this.json.itemStatement) return [];
        var obj = this.json.itemStatement;

        var asy = o2.typeOf(async) === "boolean" ? async : (this.json.itemViewAsync !== false);

        var filter = [];
        if (this.json.statementFilterList && this.json.statementFilterList.length) {
            this.json.statementFilterList.each(function (entry) {
                entry.value = this.form.Macro.exec(entry.code.code, this);
                filter.push(entry);
            }.bind(this));
        }

        var parameter = {};
        if(this.json.statementParameterList && this.json.statementParameterList.length) {
            this.json.statementParameterList.each(function (entry) {
                parameter[entry.parameter] = this.parseParameter(entry);
            }.bind(this));
        }

        var data = this.form.Macro.environment.statement.execute({
            "name": obj.name,
            "mode": "data",
            "page": 1, //（number）可选，当前页码，默认为1
            "pageSize": 1000, //（number）可选，每页的数据条数，默认为20
            "filter": filter,
            "parameter": parameter,
            "parameterList": this.json.parameterList
        }, null, asy);
        if (data && typeOf(data.then) === "function") {
            return data.then(function (data) {
                return this.parseStatementOptions(data);
            }.bind(this));
        } else {
            return this.parseStatementOptions(data);
        }
    },
    parseStatementOptions: function (json) {
        var arr = [], value, text, valuekey = this.json.statementValueColumn,
            textkey = this.json.statementTextColumn;
        json.data.each(function (d) {
            if (valuekey && textkey) {
                value = this.getDataByPath(d, valuekey);
                text = this.getDataByPath(d, textkey);
                arr.push(text + "|" + value);
            } else if (valuekey) {
                value = this.getDataByPath(d, valuekey);
                arr.push(value);
            } else if (textkey) {
                text = this.getDataByPath(d, textkey);
                arr.push(text);
            }
        }.bind(this));
        return arr.unique();
    },
    parseParameter: function (f) {
        var value = f.value;
        if (f.valueType === "script") {
            value = this.form.Macro.exec(f.valueScript ? f.valueScript.code : "", this);
        }
        if (typeOf(value) === "date") {
            value = value.format("db");
        }
        var user = layout.user;
        switch (value) {
            case "@year":
                value = (new Date().getFullYear()).toString();
                break;
            case "@season":
                var m = new Date().format("%m");
                if (["01", "02", "03"].contains(m)) {
                    value = "1"
                } else if (["04", "05", "06"].contains(m)) {
                    value = "2"
                } else if (["07", "08", "09"].contains(m)) {
                    value = "3"
                } else {
                    value = "4"
                }
                break;
            case "@month":
                value = new Date().format("%Y-%m");
                break;
            case "@time":
                value = new Date().format("db");
                break;
            case "@date":
                value = new Date().format("%Y-%m-%d");
                break;
            default:
        }

        if (f.formatType === "dateTimeValue" || f.formatType === "datetimeValue") {
            value = "{ts '" + value + "'}"
        } else if (f.formatType === "dateValue") {
            value = "{d '" + value + "'}"
        } else if (f.formatType === "timeValue") {
            value = "{t '" + value + "'}"
        }
        return value;
    },
    getDataByPath: function (obj, path, isUppcase) {
        var pathList = isUppcase ? path.toUpperCase().split(".") : path.split(".");
        for (var i = 0; i < pathList.length; i++) {
            var p = pathList[i];
            if ((/(^[1-9]\d*$)/.test(p))) p = p.toInt();
            if (obj[p]) {
                obj = obj[p];
            } else if (obj[p] === undefined || obj[p] === null) {
                if (!isUppcase && i === 0) {
                    return this.getDataByPath(obj, path, true);
                } else {
                    obj = "";
                }
                break;
            } else {
                obj = obj[p];
                break;
            }
        }
        return this.getString(obj);
    }

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Div 容器组件。
 * @o2cn 容器组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var div = this.form.get("name"); //获取组件
 * //方法2
 * var div = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Div = MWF.APPDiv =  new Class({
    Extends: MWF.APP$Module
});
MWF.xDesktop.requireApp("process.Xform", "$Selector", null, false);
/** @class Combox 组合框组件。
 * @o2cn 组合框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 * @extends MWF.xApplication.process.Xform.$Selector
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Combox = MWF.APPCombox =  new Class(
    /** @lends MWF.xApplication.process.Xform.Combox# */
{
	Implements: [Events],
	Extends: MWF.APP$Selector,
	iconStyle: "selectIcon",
    options: {
        /**
         * 手工输入完成后触发。
         * @event MWF.xApplication.process.Xform.Combox#commitInput
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 值改变时触发。
         * @event MWF.xApplication.process.Xform.Combox#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "commitInput", "change"]
    },

    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
    },
    _loadUserInterface: function(){
        if ( this.isSectionMergeRead() ) { //区段合并显示
            this._loadMergeReadNode();
        }else{
            if( this.isSectionMergeEdit() ){
                this._loadMergeEditNode();
            }else{
                this._loadNode();
            }
            // if (this.json.compute === "show"){
            //     this._setValue(this._computeValue());
            // }else{
            //     this._loadValue();
            // }
        }
    },
    loadVal: function(){
        if (this.json.compute === "show"){
            this._setValue(this._computeValue());
        }else{
            this._loadValue();
        }
    },
	/**
	 * @summary 重新加载组件。会执行postLoad事件。
	 * @example
	 * this.form.get("fieldId").reload(); //重新加载事件
	 */
	reload: function(){
		if (this.areaNode){
			this.node = this.areaNode;
			this.areaNode.empty();
			this.areaNode = null;
		}
		this._beforeReloaded();
		this._loadUserInterface();
        this._loadStyles();
		this._afterLoaded();
		this._afterReloaded();
		this.fireEvent("postLoad");
	},
    _loadNode: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                this._loadNodeEdit();
            }
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        this.loadVal();
        //new Element("select").inject(this.node);
    },
    _loadMergeReadContentNode: function( contentNode, data ){
	    this.mergeRead = true;
        contentNode.setStyles({ "overflow": "hidden"});
		var textList = this.getTextListByValue( data.data );

        if( typeOf(textList.then) === "function" ){
            Promise.resolve(textList).then(function (tList) {
                this.__setValueRead( data.data, tList, contentNode );
            }.bind(this))
        }else{
            this.__setValueRead( data.data, textList, contentNode );
        }
        // textList.each(function(text, i){
        //     if (i<data.data.length-1) text += this.json.splitShow;
        //     new Element("div", {"styles": {
        //             "float": "left",
        //             "margin-right": "5px"
        //         },"text": text}).inject( contentNode ); //.inject(this.node.getFirst() || this.node);
        // }.bind(this));
    },
    _loadNodeEdit: function(){
        var options = this.getOptions();
        if( typeOf(options.then) === "function" ){
            Promise.resolve(options).then(function (opt) {
                this.__loadNodeEdit(opt);
                this.loadVal();
                this._loadStyles();
            }.bind(this))
        }else{
            this.__loadNodeEdit(options);
            this.loadVal();
        }
    },
    __loadNodeEdit: function(opt){
        this.node.empty();
        var select;
        MWF.require("MWF.widget.Combox", function(){
            select = this.combox = new MWF.widget.Combox({
                "style": this.form.json.comboxStyle ? this.form.json.comboxStyle.style : "default",
                "positionX": this.form.json.addressStyle ? this.form.json.addressStyle.positionX : "left",
                "onlySelect": this.json.onlySelect==="y",
                "count": this.json.count.toInt() || 0,
                "splitStr": this.json.splitStr || ",\\s*|;\\s*|，\\s*|；\\s*",
                "splitShow": this.json.splitShow || ", ",
                "focusList": this.json.showOptions === "focus",
                "list": opt,
                "onCommitInput": function(item){
                    this.fireEvent("commitInput");
                }.bind(this),
                "onChange": function(){
                    this.fireEvent("change");
                }.bind(this),
                "optionsMethod": this._searchOptions()
            });
        }.bind(this), false);


        // var select = new Element("select");
        // select.set(this.json.properties);
        select.inject(this.node);
        //this.node.destroy();
        // this.areaNode = this.node;
        // this.node = select;
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });

        this.combox.addEvent("change", function(){
            this.validationMode();
            if (this.validation()){
                var v = this.getInputData("change");
                this._setBusinessData(v);
            }
        }.bind(this));

    },
    _loadStyles: function(){
        if (this.json.styles) this.node.setStyles(this.json.styles);
        if (this.json.inputStyles && !this.mergeRead) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
        if (this.iconNode && this.iconNode.offsetParent !== null){
            var size = this.node.getSize();
            //if (!size.y){
            //    var y1 = this.node.getStyle("height");
            //    var y2 = this.node.getFirst().getStyle("height");
            //    alert(y1+"," +y2);
            //    var y = ((y1!="auto" && y1>y2) || y2=="auto") ? y1 : y2;
            //    size.y = (y=="auto") ? "auto" : y.toInt();
            //    //alert(size.y)
            //}
            this.iconNode.setStyle("height", ""+size.y+"px");
            //alert(this.iconNode.getStyle("height"))
        }
    },
    _searchOptions: function(){
        if (this.json.itemType === "dynamic"){
			return function(value, callback){
				var event = {
					"value": value,
					"callback": callback
				};
                this.form.Macro.fire(((this.json.itemDynamic) ? this.json.itemDynamic.code : ""), this, event);
			}.bind(this);
		}else{
        	return null;
		}
	},
    /**
     * @summary 获取选择项。
     * @return {Array | Promise} 返回选择项数组或Promise，如：<pre><code class='language-js'>[
     *  "女|female",
     *  "男|male"
     * ]</code></pre>
     * @example
     * this.form.get('fieldId').getOptions();
     * @example
     * //异步
     * var opt = this.form.get('fieldId').getOptions();
     * Promise.resolve(opt).then(function(options){
     *     //options为选择项数组
     * })
     */
    getOptions: function(async, refresh){
        if( this.optionsCache && !refresh )return this.optionsCache;
        this.optionsCache = null;
        var opt = this._getOptions(async, refresh);
        if( (opt && typeOf(opt.then) === "function") ){
            var p = Promise.resolve( opt ).then(function(option){
                this.moduleSelectAG = null;
                this.optionsCache = this.parseOptions(option || []);
                return this.optionsCache;
            }.bind(this));
            this.moduleSelectAG = p;
            return p;
        }else{
            this.optionsCache = this.parseOptions(opt || []);
            return this.optionsCache;
        }
    },
    parseOptions: function(list){
    	// var list = [];
        // if (this.json.itemType === "values"){
        //     list = this.json.itemValues;
        // }else if (this.json.itemType === "script"){
        //     list = this.form.Macro.exec(((this.json.itemScript) ? this.json.itemScript.code : ""), this);
        // }

        if (list.length){
            var options = [];
            list.each(function(v){
                if (typeOf(v)==="object"){
                    options.push(v);
                }else{
                	v = v.toString();
                	var arr = v.split("|");
                	var o = { "text": "", "keyword": "", "value": "" };
                	switch (arr.length){
                        case 0: break;
						case 1:
                            o.text = arr[0];
                            o.keyword = arr[0];
                            o.value = arr[0];
							break;
						case 2:
                            o.text = arr[0];
                            o.keyword = arr[0];
                            o.value = arr[1];
							break;
						case 3:
                            o.text = arr[0];
                            o.keyword = arr[1];
                            o.value = arr[2];
							break;
						default:
                            o.text = arr[0];
                            o.keyword = arr[1];
                            o.value = arr[2];
					}
                    options.push(o);
				}
			}.bind(this));
            return options;
		}
        return [];
    },
    /**
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
     * @summary 为组件赋值。
     * @param value{String} .
     * @example
     *  this.form.get("fieldId").setData("test"); //赋文本值
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      this.form.get('fieldId').setData( data );
     *  }else{
     *      this.data['fieldId'] = data;
     *  }
     */
    setData: function(value){
        this._setBusinessData(value);
        this._setValue(value);
	},
    _setValue: function(value){
        if (!value) value = [];
        if (value.length==1 && (!value[0])) value = [];
        if (typeOf(value) !=="array") value = [value];

		if (this.combox){
            var textData = this.getTextData( value );
            if( typeOf(textData.then) === "function" ){
                Promise.resolve(textData).then(function (tData) {
                    this.combox.clear();
                    this.__setValueEdit( tData );
                }.bind(this))
            }else{
                this.combox.clear();
                this.__setValueEdit( textData )
            }
		}else{
		    var textList = this.getTextListByValue( value );
            if( typeOf(textList.then) === "function" ){
                Promise.resolve(textList).then(function (tList) {
                    this.__setValueRead( value, tList );
                }.bind(this))
            }else{
                this.__setValueRead( value, textList );
            }
		}
    },
    __setValueEdit: function(textData){
        var comboxValues = [];
        textData.value.each(function(v, i){
            comboxValues.push({
                "text": textData.text[i] || v,
                "value": v
            });
        }.bind(this));
        this.combox.addNewValues(comboxValues);
        this.fieldModuleLoaded = true;
    },
    __setValueRead: function(value, textList, contentNode){
        if(!contentNode)contentNode = new Element("div", {
            "styles": { "overflow": "hidden"}
        }).inject(this.node);
        textList.each(function(text, i){
            if (i<value.length-1) text += this.json.splitShow;
            new Element("div", {"styles": {
                    "float": "left",
                    "margin-right": "5px"
                },"text": text}).inject( contentNode ); //.inject(this.node.getFirst() || this.node);
        }.bind(this));
        this.fieldModuleLoaded = true;
    },
    /**
     * @summary 重新计算下拉选项.
     * @param {Function} callback 回调方法
     * @example
     * this.form.get('fieldId').resetOption();
     * @example
     * this.form.get('fieldId').resetOption(function(){
     *   //设置完成后的回调
     * });
     */
    resetOption: function( callback ){
        if (this.combox){
            var list = this.getOptions(true, true);
            if( typeOf(list.then) === "function" ){
                Promise.resolve(list).then(function (array) {
                    this.combox.setOptions({"list": array});
                    if(callback)callback();
                })
            }else{
                this.combox.setOptions({"list": list});
                if(callback)callback();
            }
        }
    },
    /**
     * @summary 添加下拉选项.
     * @param text  {String} 下拉选项文本
     * @param value {String} 下拉选项值
     * @example
     * this.form.get('fieldId').addOption("秘密","level1");
     */
	addOption: function(text, value){
        if (this.combox){
            var list = this.combox.options.list || [];
            list.push({
				"text": text,
                "value": value
			});
            this.combox.setOptions({"list": list});
        }
	},
    isEmpty : function(){
        var data = this.getData();
        if( typeOf(data) === "array" ){
            return data.length === 0;
        }else{
            return !data;
        }
    },
    getInputData: function(){
        if (this.combox) return this.combox.getData();
        return this._getBusinessData();
    },
    _beforeReloaded: function(){
	    if( this.combox )this.combox.clear();
        this.combox = null;
    },
    /**
     * @summary 获取选中项的text。
     * @return {Array|Promise} 返回选中项的text
     * @example
     * var text = this.form.get('fieldId').getText(); //获取选中项的文本
     * @example
     * //如果选项是异步的，比如数据字典、视图、查询视图
     * var p = this.form.get('fieldId').getText(); //获取选中项Promise
     * Promise.resolve(p).then(function(text){
     *     //text 为选选中项的文本
     * })
     */
    getText: function(){
        var d = this.getTextData();
        if( typeOf(d.then) === "function" ){
            return d.then(function( d1 ){
                return d1.text;
            });
        }else{
            return d.text;
        }
    },
    /**
     * @summary 获取选中的值和文本.
     * @example
     * var array = this.form.get('fieldId').getTextData();
     * @example
     * //异步
     * var array = this.form.get('fieldId').getTextData();
     * Promise.resolve(array).then(function(arr){
     *     //arr为选中项值和文本
     * })
     * @return {Object|Promise} 返回选中项值和文本，格式为 { 'value' : [value], 'text' : [text] }.
     */
    getTextData: function( value ){
	    var v = value || this.getData();
	    var textList = this.getTextListByValue( v );
        if( typeOf(textList.then) === "function" ){
            return Promise.resolve(textList).then(function (tList) {
                return {"value": v, "text": tList.length ? tList : v};
            }.bind(this));
        }else{
            return {"value": v, "text": textList.length ? textList : v};
        }
        //return this.node.get("text");
    },
    getTextListByValue: function( v ){
        var options, textList=[];
        if( this.json.itemType === "dynamic" ){
            var fun = this._searchOptions();
            if( fun ){
                v.each(function ( i ) {
                    var text;
                    if (typeOf(i)==="object"){
                        text = i.text || i.title || i.subject  || i.name;
                    }else{
                        i = i.toString();
                        fun(i, function( options ){
                            var matchList = options.filter(function (o) {
                                if( o.value === i )return true;
                            });
                            text = (matchList[0] && matchList[0].text) ? matchList[0].text : i;
                            textList.push( text );
                        }.bind(this));
                    }
                }.bind(this));
                return textList;
            }
        }else{
            options = this.getOptions();
            if( typeOf(options.then) === "function" ){
                return Promise.resolve(options).then(function (opt) {
                    return this._getTextListByValue(v, opt);
                }.bind(this));
            }else{
                return this._getTextListByValue(v, options);
            }
        }
        v.each(function ( i ) {
            var text;
            if (typeOf(i)==="object"){
                text = i.text || i.title || i.subject  || i.name;
            }else{
                text = i.toString();
            }
            textList.push( text );
        }.bind(this));
        return textList;
    },
    _getTextListByValue: function(v, options){
        var textList = [];
        v.each(function ( i ) {
            var text;
            if (typeOf(i)==="object"){
                text = i.text || i.title || i.subject  || i.name;
            }else{
                i = i.toString();
                var matchList = options.filter(function (o) {
                    if( o.value === i )return true;
                });
                text = (matchList[0] && matchList[0].text) ? matchList[0].text : i;
            }
            textList.push( text );
        }.bind(this));
        return textList;
    },

    getValueListByText: function( text ){
        var options, valueList=[];
        if( this.json.itemType === "dynamic" ){
        }else{
            options = this.getOptions();
            if( typeOf(options.then) === "function" ){
                return Promise.resolve(options).then(function (opt) {
                    return this._getValueListByText(text, opt);
                }.bind(this));
            }else{
                return this._getValueListByText(text, options);
            }
        }
        text.each(function ( i ) {
            var value;
            if (typeOf(i)==="object"){
                value = i.name || i.text || i.title || i.subject ;
            }else{
                value = i.toString();
            }
            valueList.push( value );
        }.bind(this));
        return valueList;
    },
    _getValueListByText: function(text, options){
        var valueList = [];
        text.each(function ( i ) {
            var value;
            if (typeOf(i)==="object"){
                value = i.name || i.text || i.title || i.subject;
            }else{
                i = i.toString();
                var matchList = options.filter(function (o) {
                    if( o.text === i )return true;
                });
                value = (matchList[0] && matchList[0].text) ? matchList[0].value : i;
            }
            valueList.push( value );
        }.bind(this));
        return valueList;
    },

    resetData: function(){
        //this._setBusinessData(this.getValue());
        this.setData(this.getValue());
    },

    getExcelData: function( type ){
        var value = this.getData();
        if( type === "value" )return o2.typeOf(value) === "array" ? value.join(", ") : value;

        var textList = this.getTextListByValue( value );
		return Promise.resolve(textList).then(function (tList) {
			return tList.join(", ");
		});
    },
    setExcelData: function(data, type){
        var arr = this.stringToArray(data);
        this.excelData = arr;
        if( type === "value" ){
            this.setData(arr, true);
        }else{
            var values = this.getValueListByText( arr );
            this.moduleExcelAG = Promise.resolve(values).then(function (vs) {
                this.setData(vs, true);
                this.moduleExcelAG = null;
            }.bind(this));
        }
    }
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class DatagridMobile 数据网格组件（移动端）。从v6.2开始建议用数据表格(Datatable)代替。
 * @o2cn 数据网格移动端（过时）
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datagrid = this.form.get("name"); //获取组件
 * //方法2
 * var datagrid = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @deprecated
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.DatagridMobile = new Class(
/** @lends MWF.xApplication.process.Xform.DatagridMobile# */
{
    Implements: [Events],
    Extends: MWF.APP$Module,
    isEdit: false,
    options: {
        /**
         * 当前条目编辑完成时触发。通过this.event可以获取对应的table。
         * @event MWF.xApplication.process.Xform.DatagridMobile#completeLineEdit
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 添加条目时触发。通过this.event可以获取对应的table。
         * @event MWF.xApplication.process.Xform.DatagridMobile#addLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除条目前触发。通过this.event可以获取对应的table。
         * @event MWF.xApplication.process.Xform.DatagridMobile#deleteLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除条目后触发。
         * @event MWF.xApplication.process.Xform.DatagridMobile#afterDeleteLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 编辑条目时触发。
         * @event MWF.xApplication.process.Xform.DatagridMobile#editLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["queryLoad","postLoad","load","completeLineEdit", "addLine", "deleteLine", "afterDeleteLine","editLine"]
    },

    initialize: function(node, json, form, options){
        /**
         * @ignore
         * @member parentLine
         * @memberOf MWF.xApplication.process.Xform.DatagridMobile#
         */

        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
    },
    load: function(){
        this._loadModuleEvents();
        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
            this._loadStyles();
            this._loadDomEvents();
            //this._loadEvents();

            this._afterLoaded();
            this.fireEvent("afterLoad");
            // this.fireEvent("load");
        }
    },
    _loadUserInterface: function(){
        // this.fireEvent("queryLoad");

        this.editModules = [];
        this.node.setStyle("overflow-x", "hidden");
        this.node.setStyle("overflow-y", "hidden");
        this.table = this.node.getElement("table");

        this.createMobileTable();


        this.editable = (!this.readonly);
        if (this.editable && this.json.editableScript && this.json.editableScript.code){
            this.editable = this.form.Macro.exec(((this.json.editableScript) ? this.json.editableScript.code : ""), this);
        }
        //this.editable = false;

        this.deleteable = this.json.deleteable !== "no";
        this.addable = this.json.addable !== "no";

        this.gridData = this._getValue();

        if( this.gridData.data && typeOf(this.gridData.data)==="object"){
            this.gridData.data = [];
        }

        this.totalModules = [];
        this._loadDatagridTitleModules();

        if (this.editable!=false){
            this._loadDatagridDataModules();
            //this._addTitleActionColumn();
            // this._loadEditDatagrid();
            // //this._loadReadDatagrid();
            // this.fireEvent("postLoad");
            // this.fireEvent("load");
            this._loadEditDatagrid(function(){
                this.fieldModuleLoaded = true;
                this.fireEvent("postLoad");
                this.fireEvent("load");
            }.bind(this));
        }else{
            this._loadDatagridDataModules();
            this._loadReadDatagrid(function(){
                this.fieldModuleLoaded = true;
                this.fireEvent("postLoad");
                this.fireEvent("load");
            }.bind(this));

            // this._loadReadDatagrid();
            // this.fireEvent("postLoad");
            // this.fireEvent("load");
        }
    },
    createMobileTable: function(){
        var mobileTable = new Element("table").inject(this.node);
        mobileTable.set(this.json.properties);
        //mobileTable.setStyle("display", "none");
        //mobileTable.setStyle("margin-bottom", "10px");
        var trs = this.table.getElements("tr");
        var titleTds = trs[0].getElements("th");
        var contentTds = trs[1].getElements("td");
        titleTds.each(function(titleTd, i){
            var mobileTr = mobileTable.insertRow();
            //var mobileTr = new Element("tr").inject(mobileTable);
            var th = new Element("th").inject(mobileTr);
            th.set({
                "html": titleTd.get("html"),
                "id": titleTd.get("id"),
                "mwftype": titleTd.get("mwftype")
            });
            var td = new Element("td").inject(mobileTr);
            td.set({
                "html": contentTds[i].get("html"),
                "id": contentTds[i].get("id"),
                "mwftype": contentTds[i].get("mwftype")
            });

            var json = this.form._getDomjson(titleTd);
            if( json && json.isShow === false )mobileTr.hide();
        }.bind(this));
        this.table.destroy();
        this.table = null;
        this.table = mobileTable;
    },

    _loadStyles: function(){
        //this.table.setStyles(this.json.tableStyles);
        this.node.setStyles(this.json.styles);
        var tables = this.node.getElements("table");
        tables.each(function(table){
            table.setStyles(this.json.tableStyles);
        }.bind(this));

    },
    _getValue: function(){
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = [];
        value = this._getBusinessData();
        if (!value){
            if (this.json.defaultData && this.json.defaultData.code) value = this.form.Macro.exec(this.json.defaultData.code, this);
            if (value && !value.then) if (o2.typeOf(value)=="array") value = {"data": value || []};
        }
        return value || [];
    },
    getValue: function(){
        if (!this.isReadable) return [];
        return this._getValue();
    },

    _getValueText: function(idx, value){
        var module = this.editModules[idx];
        if (module){
            switch (module.json.type){
                case "Select":
                    for (var i=0; i<module.json.itemValues.length; i++){
                        var itemv = module.json.itemValues[i];
                        var arr = itemv.split(/\|/);
                        var text = arr[0];
                        var v = (arr.length>1) ? arr[1] : arr[0];
                        if (value===v) return text;
                    }

                    // var ops = module.node.getElements("option");
                    // for (var i=0; i<ops.length; i++){
                    // 	if (ops[i].value == value){
                    // 		return ops[i].get("text");
                    // 	}
                    // }
                    break;
                case "Radio":
                    var ops = module.node.getElements("input");
                    for (var i=0; i<ops.length; i++){
                        if (ops[i].value == value){
                            return ops[i].get("showText");
                        }
                    }
                    break;
                case "Checkbox":
                    var ops = module.node.getElements("input");
                    var texts = [];
                    for (var i=0; i<ops.length; i++){
                        if (value.indexOf(ops[i].value) != -1) texts.push(ops[i].get("showText"));
                    }
                    if (texts.length) return texts.join(", ");
                    break;
                case "Orgfield":
                case "Personfield":
                case "Org":
                    //var v = module.getTextData();
                    //return v.text[0];

                    if (typeOf(value)==="array"){
                        var textArray = [];
                        value.each( function( item ){
                            if (typeOf(item)==="object"){
                                textArray.push( item.name+((item.unitName) ? "("+item.unitName+")" : "") );
                            }else{
                                textArray.push(item);
                            }
                        }.bind(this));
                        return textArray.join(", ");
                    }else if (typeOf(value)==="object"){
                        return value.name+((value.unitName) ? "("+value.unitName+")" : "");
                    }else{
                        return value;
                    }
                    break;
                case "Textarea":
                    var reg = new RegExp("\n","g");
                    var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
                    var reg3 = new RegExp("\u003e","g");
                    value = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
                    break;
            }
        }
        return value;
    },

    editValidation: function(){
        var flag = true;
        this.editModules.each(function(field, key){
            if (field.json.type!="sequence"){
                field.validationMode();
                if (!field.validation()) flag = false;
            }
        }.bind(this));
        return flag;
    },

    _loadReadDatagrid: function(callback){
        var p = o2.promiseAll(this.gridData).then(function(v){
            this.gridData = v;
            if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
            this.__loadReadDatagrid(callback);
            this.moduleValueAG = null;
            return v;
        }.bind(this), function(){});
        this.moduleValueAG = p;
        if (this.moduleValueAG) this.moduleValueAG.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));

        // if (this.gridData && this.gridData.isAG){
        //     this.moduleValueAG = this.gridData;
        //     this.gridData.addResolve(function(v){
        //         this.gridData = v;
        //         this._loadReadDatagrid(callback);
        //     }.bind(this));
        // }else{
        //     if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
        //     this.__loadReadDatagrid(callback);
        //     this.moduleValueAG = null;
        // }
    },

    __loadReadDatagrid: function(callback){
        //this.gridData = this._getValue();


        var titleHeaders = this.table.getElements("th");
        var tds = this.table.getElements("td");

        if (this.gridData.data){
            this.gridData.data.each(function(data, idx){
                var dataDiv = new Element("div.dataDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}); //.inject(this.node);

                if (this.totalDiv){
                    dataDiv.inject(this.totalDiv, "before");
                }else{
                    dataDiv.inject(this.node);
                }

                this._createItemTitleNode(dataDiv, idx);

                var tableDiv = new Element("div", {"styles": this.form.css.gridMobileTableNode }).inject(dataDiv);
                var table = new Element("table").inject(tableDiv);
                table.set(this.json.properties);
                table.store("data", data);
                //table.setStyle("margin-bottom", "10px");
                titleHeaders.each(function(th, index){
                    var tr = table.insertRow(index);
                    var datath = new Element("th").inject(tr);
                    datath.set("text", th.get("text"));
                    datath.setStyle("width", "30%");

                    var cell = tr.insertCell(1);
                    cell.set("MWFId", tds[index].get("id"));

                    var cellData = data[th.get("id")];

                    if( typeOf( cellData ) !== "array" ) {
                        if (cellData) {
                            for (key in cellData) {
                                var v = cellData[key];

                                var module = this.editModules[index];
                                if (module && module.json.type == "ImageClipper") {
                                    this._createImage(cell, module, v);
                                } else if (module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg")) {
                                    this._createAttachment(cell, module, v);
                                } else {
                                    text = this._getValueText(index, v);
                                    if (module && module.json.type == "Textarea") {
                                        cell.set("html", text);
                                    } else {
                                        cell.set("text", text);
                                    }
                                    //cell.set("text", text);
                                }


                                // if (typeOf(v)==="array"){
                                //     var textArray = [];
                                //     v.each( function( item ){
                                //         if (typeOf(item)==="object"){
                                //             textArray.push( item.name+((item.unitName) ? "("+item.unitName+")" : "") );
                                //         }else{
                                //             textArray.push(item);
                                //         }
                                //     }.bind(this));
                                //     cell.set("text", textArray.join(", "));
                                // }else if (typeOf(v)==="object"){
                                //     cell.set("text", v.name+((v.unitName) ? "("+v.unitName+")" : ""));
                                // }else{
                                //     cell.set("text", v);
                                // }
                                break;
                                //
                                // cell.set("text", cellData[key]);
                                // break;
                            }
                        } else { //Sequence
                            cell.setStyle("text-align", "left");
                            cell.set("text", idx + 1);
                        }
                    }

                    var json = this.form._getDomjson(th);
                    if( json && json.isShow === false )tr.hide();

                }.bind(this));
            }.bind(this));
        }
        if (callback) callback();
        //this._loadTotal();
    },

    _loadEditDatagrid: function(callback){
        var p = o2.promiseAll(this.gridData).then(function(v){
            this.gridData = v;
            if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
            this.__loadEditDatagrid(callback);
            this.moduleValueAG = null;
            return v;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));
        this.moduleValueAG = p;
        if (this.moduleValueAG) this.moduleValueAG.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));


        // if (this.gridData && this.gridData.isAG){
        //     this.moduleValueAG = this.gridData;
        //     this.gridData.addResolve(function(v){
        //         this.gridData = v;
        //         this._loadEditDatagrid(callback);
        //     }.bind(this));
        // }else{
        //     if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
        //     this.__loadEditDatagrid(callback);
        //     this.moduleValueAG = null;
        // }
    },
    __loadEditDatagrid: function(callback){
        //this._createHelpNode();

        //this.gridData = this._getValue();

        var titleHeaders = this.table.getElements("th");
        var tds = this.table.getElements("td");

        var _self = this;

        if (this.gridData.data.length){
            if( this.addAction )this.addAction.setStyle("display","none");
            this.gridData.data.each(function(data, idx){
                var dataDiv = new Element("div.dataDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}); //.inject(this.node);

                if (this.totalDiv){
                    dataDiv.inject(this.totalDiv, "before");
                }else{
                    dataDiv.inject(this.node);
                }

                this._createItemTitleNode(dataDiv, idx);

                var tableDiv = new Element("div", {"styles": this.form.css.gridMobileTableNode }).inject(dataDiv);
                var table = new Element("table").inject(tableDiv);
                table.set(this.json.properties);
                table.store("data", data);
                //table.setStyle("margin-bottom", "10px");
                titleHeaders.each(function(th, index){
                    var tr = table.insertRow(index);
                    var datath = new Element("th").inject(tr);
                    datath.set("text", th.get("text"));
                    datath.setStyle("width", "30%");

                    var cell = tr.insertCell(1);
                    cell.set("MWFId", tds[index].get("id"));

                    var cellData = data[th.get("id")];
                    if( typeOf( cellData ) !== "array" ){
                        if ( cellData ){
                            for (key in cellData){
                                var v = cellData[key];

                                var module = this.editModules[index];
                                if( module && module.json.type == "ImageClipper" ){
                                    this._createImage( cell, module, v )
                                }else if( module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg") ){
                                    this._createAttachment( cell, module, v );
                                }else{
                                    text = this._getValueText(index, v);
                                    if( module && module.json.type == "Textarea" ){
                                        cell.set("html", text);
                                    }else{
                                        cell.set("text", text);
                                    }
                                    //cell.set("text", text);
                                }

                                // if (typeOf(v)==="object"){
                                //     cell.set("text", v.name+((v.unitName) ? "("+v.unitName+")" : ""));
                                // }else{
                                //     cell.set("text", v);
                                // }
                                break;
                                //
                                // cell.set("text", cellData[key]);
                                // break;
                            }
                        }else{ //Sequence
                            cell.setStyle("text-align", "left");
                            cell.set("text", idx+1);
                        }
                    }

                    var json = this.form._getDomjson(th);
                    if( json && json.isShow === false )tr.hide();
                }.bind(this));
                var size = dataDiv.getSize();
                //dataDiv.setStyle("height", ""+size.y+"px");

                //dataDiv.addEvent("touchstart", function(e){_self.actionTouchstart(this, e);});
                //dataDiv.addEvent("touchmove", function(e){_self.actionTouchmove(this, e);});
                //dataDiv.addEvent("touchend", function(e){_self.actionTouchend(this, e);});
                //dataDiv.addEvent("touchcancel", function(e){_self.actionTouchcancel(this, e);});
                //
                //dataDiv.addEvent("mousedown", function(e){_self._actionMousedown(this, e);});
                //dataDiv.addEvent("mouseup", function(e){_self._actionMouseup(this, e);});

                //this.showMoveAction(dataDiv, 60);
                //this.showEndMoveAction(dataDiv);
            }.bind(this));
        }else{
            if (this.addAction){
                if( this.addable )this.addAction.setStyle("display", "block");
            }else{
                if( this.addable )this._loadAddAction();
            }
            // this._loadAddAction();
        }
        if (callback) callback();
        //this._loadTotal();
    },
    _loadActions: function(titleDiv){
        var actionNode = new Element("div", {
            "styles": this.form.css.mobileDatagridActionNode
        }).inject(titleDiv);

        var delAction = new Element("div", {
            "styles": this.form.css.mobileDatagridDelActionNode,
            "text": MWF.xApplication.process.Xform.LP["delete"]
        }).inject(actionNode);
        if( !this.deleteable )delAction.hide();

        var editAction = new Element("div", {
            "styles": this.form.css.mobileDatagridEditActionNode,
            "text": MWF.xApplication.process.Xform.LP.edit
        }).inject(actionNode);

        var addAction = new Element("div", {
            "styles": this.form.css.mobileDatagridAddActionNode,
            "text": MWF.xApplication.process.Xform.LP.add
        }).inject(actionNode);
        if( !this.addable )addAction.hide();

        var cancelAction = new Element("div", {
            "styles": this.form.css.mobileDatagridCancelActionNode,
            "text": MWF.xApplication.process.Xform.LP.cancelEdit
        }).inject(actionNode);
        var completeAction = new Element("div", {
            "styles": this.form.css.mobileDatagridCompleteActionNode,
            "text": MWF.xApplication.process.Xform.LP.completedEdit
        }).inject(actionNode);


        var _self = this;
        if( this.deleteable )delAction.addEvent("click", function(e){
            _self._deleteLine(this.getParent().getParent().getParent(), e);
        });
        editAction.addEvent("click", function(e){
            _self._editLine(this.getParent().getParent().getParent(), e);
        });
        completeAction.addEvent("click", function(e){
            _self._completeLineEdit();
        });
        cancelAction.addEvent("click", function(e){
            _self._cancelLineEdit(e);
        });
        if( this.addable )addAction.addEvent("click", function(e){
            _self._addLine();
        });
    },
    _createImage : function( cell, module, data ){
        cell.empty();
        if( !data )return;
        var img = new Element("img",{
            src : MWF.xDesktop.getImageSrc( data )
        }).inject( cell, "top" );
        img.setStyles({
            "max-width": "90%"
        })
    },
    _createAttachment: function ( cell, module, data ){
        cell.empty();
        var options = {
            "style": module.json.style || "default",
            "title": MWF.xApplication.process.Xform.LP.attachmentArea,
            "listStyle": module.json.dg_listStyle || "icon",
            "size": module.json.dg_size || "min",
            "resize": (module.json.dg_resize === "y" || this.json.dg_resize === "true"),
            "attachmentCount": 0,
            "isUpload": false,
            "isDelete": false,
            "isReplace": false,
            "isDownload": true,
            "isSizeChange": (module.json.dg_isSizeChange === "y" || module.json.dg_isSizeChange === "true"),
            "readonly": true,
            "availableListStyles": module.json.dg_availableListStyles ? module.json.dg_availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": "n",
            "isReplaceOption": "n",
            "toolbarGroupHidden": module.json.dg_toolbarGroupHidden || []
        };
        if (this.readonly) options.readonly = true;
        if(!this.editable && !this.addable)options.readonly = true;

        var atts = [];
        data.each(function(d){
            var att = module.attachmentController.attachments.find(function(a){
                return d.id == a.data.id;
            });
            if (att) module.attachmentController.removeAttachment(att);
        });
        module.setAttachmentBusinessData();


        var attachmentController = new MWF.xApplication.process.Xform.AttachmentController(cell, module, options);
        attachmentController.load();

        data.each(function (att) {
            var attachment = this.form.businessData.attachmentList.find(function(a){
                return a.id==att.id;
            });
            var attData = attachment || att;
            //if (att.site===this.json.id || (this.json.isOpenInOffice && this.json.officeControlName===att.site)) this.attachmentController.addAttachment(att);
            attachmentController.addAttachment(attData);
        }.bind(this));
    },
    _createItemTitleNode: function(node, idx){
        var n = idx+1;
        var titleDiv = new Element("div", {"styles": this.json.itemTitleStyles}).inject(node);
        titleDiv.setStyle("overflow", "hidden");
        var textNode = new Element("div.sequenceDiv", {
            "styles": {"float": "left"},
            "text": MWF.xApplication.process.Xform.LP.item+n
        }).inject(titleDiv);
        //if (idx==0){
        if( this.editable != false ){
            this._loadActions(titleDiv);
        }

        //}
    },
    _createHelpNode: function(){
        this.helpNode = new Element("div", {"styles": this.form.css.mobileGridHelpNode}).inject(this.node, "top");
        this.helpContentNode = new Element("div", {"styles": this.form.css.mobileGridHelpContentNode}).inject(this.helpNode);
        this.helpContentNode.set("html", MWF.xApplication.process.Xform.LP.mobileGridHelp);
        new mBox.Tooltip({
            content: this.helpContentNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.helpNode,
            transition: 'flyin',
            position: {
                x: ['right'],
                y: ['center']
            },
            event: 'click'
        });
    },
    _editLine:function(node){
        if (this.isEdit){
            if (!this._completeLineEdit()) return false;
        }

        this.currentEditLine = node;
        var currentEditTable = node.getElement("table");
        if (this.currentEditLine){
            this.table.setStyles({
                "background-color": "#fffeb5",
                "display": "table"
            });
            this.table.inject(currentEditTable, "after");
            //this.currentEditLine.setStyle("display", "none");
            currentEditTable.setStyle("display", "none");

            var actions = this.currentEditLine.getFirst("div").getLast("div").getElements("div");
            if (actions[0]) actions[0].setStyle("display", "none");
            if (actions[1]) actions[1].setStyle("display", "none");
            if (actions[2]) actions[2].setStyle("display", "none");
            if (actions[3]) actions[3].setStyle("display", "block");
            if (actions[4]) actions[4].setStyle("display", "block");

            //this.addAction.inject(this.table, "after");
            //this.addAction.set("text", MWF.xApplication.process.Xform.LP.completedEdit);
            //this.addAction.removeEvents("click");
            //this.addAction.addEvent("click", function(){
            //    this._completeLineEdit();
            //}.bind(this));


            var data = this.currentEditLine.getElement("table").retrieve("data");
            var titleThs = this.table.getElements("th");
            titleThs.each(function(th, idx){
                var id = th.get("id");
                var module = this.editModules[idx];
                if (module){
                    if (module.json.type=="sequence"){
                        module.node.set("text", this.currentEditLine.getElement("table").getElements("tr")[idx].getElement("td").get("text"));
                    }else {
                        if (data[id]) {
                            module.setData(data[id][module.json.id]);
                        } else {
                            module.setData(null);
                        }
                    }
                }
            }.bind(this));

            //var cellIdx = this.currentEditLine.getElements("td").indexOf(td);
            //var module = this.editModules[cellIdx-1];
            //if (module) module.focus();

            this.fireEvent("editLine");

            this.isEdit =true;
        }
        this.validationMode();
    },
    _loadAddAction: function(){
        if( !this.addAction ){
            this.addAction = new Element("div", {"styles": this.form.css.gridMobileActionNode}).inject(this.node, "top");
            this.addAction.set("text", MWF.xApplication.process.Xform.LP.addLine);
            this.addAction.addEvent("click", function(){
                this._addLine();
            }.bind(this));
        }
    },
    _addLine: function(){
        if (this.isEdit){
            if (!this._completeLineEdit()) return false;
        }
        if (this.addAction) this.addAction.setStyle("display", "none");

        var tables = this.node.getElements("table");
        var idx;
        var dataDiv = new Element("div.datagridDataDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}});
        if (this.totalDiv){
            idx = tables.length-2;
            dataDiv.inject(this.totalDiv, "before");
        }else{
            idx = tables.length-1;
            dataDiv.inject(this.node);
        }
        this._createItemTitleNode(dataDiv, idx);

        var tableDiv = new Element("div", {"styles":  this.form.css.gridMobileTableNode }).inject(dataDiv);

        this.table.setStyles({
            "background-color": "#fffeb5",
            "display": "table"
        });

        this.currentEditLine = null;
        this.table.inject(tableDiv);


        var titleThs = this.table.getElements("th");
        titleThs.each(function(th, i){
            var id = th.get("id");
            var module = this.editModules[i];
            if (module){
                if (module.json.type=="sequence"){
                    module.node.set("text", idx+1);
                }
            }
        }.bind(this));

        this.isEdit = true;

        var actions = dataDiv.getFirst("div").getLast("div").getElements("div");
        if (actions[0]) actions[0].setStyle("display", "none");
        if (actions[1]) actions[1].setStyle("display", "none");
        if (actions[2]) actions[2].setStyle("display", "none");
        if (actions[3]) actions[3].setStyle("display", "block");
        if (actions[4]) actions[4].setStyle("display", "block");

        if (!dataDiv.isIntoView()) dataDiv.scrollIntoView(true);

        //this.addAction.set("text", MWF.xApplication.process.Xform.LP.completedEdit);
        //this.addAction.removeEvents("click");
        //this.addAction.addEvent("click", function(){
        //    this._completeLineEdit();
        //}.bind(this));

        this.validationMode();
        this.fireEvent("addLine", [this.table]);
    },
    _cancelLineEdit : function(e){
        var datagrid = this;
        var _self = this;
        this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle, MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit, 300, 120, function(){

            datagrid.isEdit = false;

            if (datagrid.currentEditLine) {
                // datagrid.currentEditLine.setStyle("display", "table-row");

                var currentEditTable = datagrid.currentEditLine.getElement("table");
                currentEditTable.setStyle("display", "table");

                var actions = datagrid.currentEditLine.getFirst("div").getLast("div").getElements("div");
                if (actions[0] && this.deleteable ) actions[0].setStyle("display", "block");
                if (actions[1] ) actions[1].setStyle("display", "block");
                if (actions[2] && this.addable ) actions[2].setStyle("display", "block");
                if (actions[3]) actions[3].setStyle("display", "none");
                if (actions[4]) actions[4].setStyle("display", "none");

                datagrid._editorTrGoBack();
            }else{
                var datagridDataDiv = e.target.getParent(".datagridDataDiv");
                datagrid._editorTrGoBack();
                if(datagridDataDiv)datagridDataDiv.destroy();
            }

            datagrid.editModules.each(function(module){
                if (module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
                    module.attachmentController.attachments.each(function(att){
                        datagrid.form.workAction.deleteAttachment(att.data.id, datagrid.form.businessData.work.id);
                    });
                    module.attachmentController.clear();
                }
            });

            datagrid.currentEditLine = null;

            if (!_self.gridData.data.length){
                if (_self.addAction){
                    if( _self.addable )_self.addAction.setStyle("display", "block");
                }else{
                    if( _self.addable )_self._loadAddAction();
                }
            }

            this.close();

            datagrid.fireEvent("cancelLineEdit");
        }, function(){
            // var color = currentTr.retrieve("bgcolor");
            // currentTr.tween("background", color);
            this.close();
        }, null, null, this.form.json.confirmStyle);
    },
    _completeLineEdit: function( ev ){
        if (!this.editValidation()){
            return false;
        }

        this.isEdit = false;
        var saveFlag = false;
        //var flag = true;

        var griddata = {};
        var dataNode = null;
        var table;

        if (this.currentEditLine){
            dataNode = this.currentEditLine;
            griddata = dataNode.getElement("table").retrieve("data");
            this.currentEditLine.getElement("table").setStyle("display", "table");
            table = dataNode.getElement("table");

            var actions = this.currentEditLine.getFirst("div").getLast("div").getElements("div");
            if (actions[0] && this.deleteable ) actions[0].setStyle("display", "block");
            if (actions[1]) actions[1].setStyle("display", "block");
            if (actions[2] && this.addable ) actions[2].setStyle("display", "block");
            if (actions[3]) actions[3].setStyle("display", "none");
            if (actions[4]) actions[4].setStyle("display", "none");
        }else{
            //dataNode = new Element("div", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}).inject(this.table, "before");
            //var tableDiv = new Element("div", {"styles": {"overflow": "hidden"}}).inject(dataNode);

            var dataDiv = this.table.getParent(".datagridDataDiv");
            if(dataDiv){
                dataDiv.removeClass("datagridDataDiv").addClass("dataDiv");
            }

            var actions = this.table.getParent().getPrevious("div").getLast("div").getElements("div");
            if (actions[0] && this.deleteable ) actions[0].setStyle("display", "block");
            if (actions[1]) actions[1].setStyle("display", "block");
            if (actions[2] && this.addable ) actions[2].setStyle("display", "block");
            if (actions[3]) actions[3].setStyle("display", "none");
            if (actions[4]) actions[4].setStyle("display", "none");

            table = new Element("table", {
                styles : this.json.tableStyles
            }).inject(this.table, "before");
            table.set(this.json.properties);
            griddata = {};

            //dataNode.addEvent("touchstart", function(e){_self.actionTouchstart(this, e);});
            //dataNode.addEvent("touchmove", function(e){_self.actionTouchmove(this, e);});
            //dataNode.addEvent("touchend", function(e){_self.actionTouchend(this, e);});
            //dataNode.addEvent("touchcancel", function(e){_self.actionTouchcancel(this, e);});
        }

        var tables = this.node.getElements("table");
        var titleHeaders = this.table.getElements("th");
        var tds = this.table.getElements("td");
        var dataRows = table.getElements("tr");

        titleHeaders.each(function(th, idx){
            var dataRow = dataRows[idx];
            var id = th.get("id");
            var module = this.editModules[idx];
            if (module){
                var data;
                if (module.json.type=="sequence"){
                    var i;
                    if (!this.currentEditLine){
                        i = tables.length-1;
                        if (this.totalTable) i = tables.length-2;
                    }else{
                        i = this.currentEditLine.getElement("table").getElements("tr")[idx].getElement("td").get("text");
                    }
                    data = {"value": [i], "text": [i]};
                }else if( module.json.type=="Attachment" || module.json.type == "AttachmentDg" ) {
                    saveFlag = true;
                    var data = module.getTextData();
                    //data.site = module.json.site;
                    if (!griddata[id]) griddata[id] = {};
                    griddata[id][module.json.id] = data;
                // }else if( ["Orgfield","Personfield","Org","Address"].contains(module.json.type) ){
                //     data = module.getTextData();
                //     if (!griddata[id]) griddata[id] = {};
                //     griddata[id][module.json.id] = data.value;
                }else{
                    data = module.getTextData();
                    //if (data.value[0]) flag = false;
                    if (data.value.length<2){
                        if (!griddata[id]) griddata[id] = {};
                        griddata[id][module.json.id] = data.value[0];
                    }else{
                        if (!griddata[id]) griddata[id] = {};
                        griddata[id][module.json.id] = data.value;
                    }
                }

                var cell;
                // var text = this._getValueText(idx, data.text.join(", "));

                if (dataRow){
                    cell = dataRow.getElement("td");
                    if( module.json.type == "ImageClipper" ){
                        this._createImage( cell, module, data.text );
                    }else if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
                        this._createAttachment( cell, module, data );
                    }else{
                        var text = this._getValueText(idx, data.text.join(", "));
                        if( module && module.json.type == "Textarea" ){
                            cell.set("html", text);
                        }else{
                            cell.set("text", text);
                        }
                        //cell.set("text", data.text.join(", "));
                    }
                }else{
                    dataRow = table.insertRow(idx);
                    var datath = new Element("th").inject(dataRow);
                    datath.set("text", th.get("text"));
                    datath.setStyle("width", "30%");

                    cell = dataRow.insertCell(1);
                    cell.set("MWFId", tds[idx].get("id"));

                    var cellData = data[th.get("id")];
                    if( module.json.type == "ImageClipper" ){
                        this._createImage( cell, module, data.text );
                    }else if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
                        this._createAttachment( cell, module, data );
                    }else{
                        var text = this._getValueText(idx, data.text.join(", "));
                        if( module && module.json.type == "Textarea" ){
                            cell.set("html", text);
                        }else{
                            cell.set("text", text);
                        }
                        //cell.set("text", data.text.join(", "));
                    }
                }
            }else{
                if (!dataRow) {
                    dataRow = table.insertRow(idx);
                    var datath1 = new Element("th").inject(dataRow);
                    datath1.set("text", th.get("text"));
                    datath1.setStyle("width", "30%");
                    cell = dataRow.insertCell(1);
                }
            }

            var json = this.form._getDomjson(th);
            if( json && json.isShow === false )dataRow.hide();

            module = null;
        }.bind(this));

        table.store("data", griddata);
        table.setStyle("display", "table");

        //if (flag){
        //    newTr.destroy();
        //}
        this.currentEditLine = null;

        this._editorTrGoBack();

        this.getData();
        this._loadDatagridStyle();

        this.validationMode();
        this.fireEvent("completeLineEdit", [table]);

        if (this.addAction){
            this.addAction.set("text", MWF.xApplication.process.Xform.LP.addLine);
            this.addAction.removeEvents("click");
            this.addAction.addEvent("click", function(){
                this._addLine();
            }.bind(this));
        }

        if(saveFlag){
            this.form.saveFormData();
        }
        return true;
    },
    _editorTrGoBack: function(){
        this.table.setStyle("display", "none");
        this.table.inject(this.node, "top");

        //if (this.totalDiv){
        //    this.addAction.inject(this.totalDiv, "before");
        //}else{
        //    this.addAction.inject(this.node);
        //}

//		this.editTr.removeEvents("blur");
//        if (this.totalTr){
//            this.editorTr.inject(this.totalTr, "before");
//        }else{
//            var lastTrs = this.table.getElements("tr");
//            var lastTr = lastTrs[lastTrs.length-1];
//            this.editorTr.inject(lastTr, "after");
//        }
    },

    _actionMousedown: function(node, e){
        var status = node.retrieve("editStatus");
        if (!status){
            node.store("editStatus", new Date());
        }
        this._checkMouseDown(node);
    },
    _checkMouseDown: function(node){
        var status = node.retrieve("editStatus");
        if (status){
            var d = (new Date()).getTime();
            if (d-status.getTime()>1000){
                this._editLine(node);
                node.eliminate("editStatus");
            }else{
                window.setTimeout(function(){
                    this._checkMouseDown(node);
                }.bind(this), 1000)
            }
        }
    },
    _actionMouseup: function(node, e){
        node.eliminate("editStatus");
    },

    actionTouchstart: function(node, e){
        var p = {"x": e.touches[0].pageX, "y": e.touches[0].pageY};
        //node.store("start", p);
        var action = node.retrieve("action");
        if (action){
            node.store("touchStatus", {"p": p, "status": "hide", "isHide": false});
        }else{
            node.store("touchStatus", {"p": p, "status": "show"});
        }
        this._actionMousedown(node, e);
        //e.preventDefault();
    },
    actionTouchmove: function(node, e){
        var touchStatus = node.retrieve("touchStatus");
        var p = touchStatus.p;
        var status = touchStatus.status;
        var x = e.touches[0].pageX;
        var y = e.touches[0].pageY;

        if (Math.abs(p.x-x)>10 || Math.abs(p.y-y)>10){
            this._actionMouseup(node);
        }
        if (status=="show"){
            if ((p.x-x > 20) && Math.abs(p.y-y)<40){
                this.showMoveAction(node, p.x-x);
                e.preventDefault();
            }
        }else{
            if ((x-p.x > 20) && Math.abs(p.y-y)<40){
                touchStatus.isHide = true;
                this.hideMoveAction(node, x- p.x);
                e.preventDefault();
            }
        }

    },
    actionTouchend: function(node, e){
        var touchStatus = node.retrieve("touchStatus");
        var p = touchStatus.p;
        var status = touchStatus.status;
        if (status=="show"){
            var action = node.retrieve("action");
            if (action) this.showEndMoveAction(node);
        }else{
            if (touchStatus.isHide) this.hideEndMoveAction(node);
        }
    },
    actionTouchcancel: function(node, e){
        this._actionMouseup(node);
    },
    showEndMoveAction: function(node){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");
        new Fx.Tween(action, {"duration": 100}).start("width", "60px");
        new Fx.Tween(tableNode, {"duration": 100}).start("margin-right", "60px");

        var _self = this;
        action.addEvent("click", function(e){
            _self._deleteLine(node, e);
        });
    },
    _deleteLine: function(node, e){
        var saveFlag = false;
        var currentTable = node.getElement("table");
        if (currentTable){

            var datagrid = this;
            var _self = this;
            this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteDatagridLine, 300, 120, function(){
                _self.fireEvent("deleteLine", [currentTable]);

                var data = currentTable.retrieve("data");

                //var attKeys = [];

                var titleThs = _self.table.getElements("th");
                titleThs.each(function(th, i){
                    var key = th.get("id");
                    var module = _self.editModules[i];
                    if (key && module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
                        saveFlag = true;
                        data[key][module.json.id].each(function(d){
                            _self.form.workAction.deleteAttachment(d.id, _self.form.businessData.work.id);
                        });
                    }
                });

                node.destroy();
                //datagrid._loadZebraStyle();
                datagrid._loadSequence();
                datagrid._loadTotal();
                datagrid.getData();

                if (!_self.gridData.data.length){
                    if (_self.addAction){
                        if( _self.addable )_self.addAction.setStyle("display", "block");
                    }else{
                        if( _self.addable )_self._loadAddAction();
                    }
                }
                this.close();

                _self.fireEvent("afterDeleteLine");

                if(saveFlag){
                    _self.form.saveFormData();
                }

            }, function(){
                //var color = currentTr.retrieve("bgcolor");
                //currentTr.tween("background-color", color);
                this.close();
            }, null, null, this.form.json.confirmStyle);
        }
        this.validationMode();
    },
    hideEndMoveAction: function(node){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");

        new Fx.Tween(action, {"duration": 100}).start("width", "0px");
        new Fx.Tween(tableNode, {"duration": 100}).start("margin-right", "0px").chain(function(){
            action.destroy();
            node.eliminate("action");
        });

    },
    showMoveAction: function(node, length){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");
        if (!action){
            var size = node.getSize();
            action = new Element("div", {
                "styles": this.form.css.gridMobileDeleteActionAreaNode
            }).inject(node, "top");
            var button = new Element("div", {
                "styles": this.form.css.gridMobileDeleteActionNode,
                "text": MWF.xApplication.process.Xform.LP["delete"]
            }).inject(action);

            action.setStyle("height",""+size.y+"px");
            action.setStyle("line-height",""+size.y+"px");
            node.store("action", action);
        }
        if (length>60) length = 60;
        action.setStyle("width", ""+length+"px");
        tableNode.setStyle("margin-right", ""+length+"px");
    },
    hideMoveAction: function(node, length){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");
        var width = 60-length;
        if (width<0) width=0;
        if (action) action.setStyle("width", ""+width+"px");
        tableNode.setStyle("margin-right", ""+width+"px");
    },

    _loadDatagridStyle: function(){
        //var ths = this.node.getElements("th");
        //ths.setStyles(this.form.css.datagridTitle);

        this.loadGridTitleStyle();
        this.loadGridContentStyle();
        //this.loadGridActionStyle();
        this.loadGridEditStyle();

        this._loadTotal();
        this._loadBorderStyle();
        this._loadZebraStyle();
        this._loadSequence();
    },

    loadGridEditStyle: function(){
        if (this.table){
            if (this.json.editStyles){
                var tds = this.table.getElements("td");
                tds.setStyles(this.json.editStyles);
            }
        }
    },
    //loadGridActionStyle: function(){
    //    if (this.editable!=false){
    //        if (this.json.actionStyles){
    //            var trs = this.table.getElements("tr");
    //            trs.each(function(tr, idx){
    //                if (idx != 0) tr.getFirst().setStyles(this.json.actionStyles);
    //            }.bind(this));
    //        }
    //    }
    //},
    loadGridTitleStyle: function(){
        if (this.json.titleStyles){
            var ths = this.node.getElements("th");
            ths.setStyles(this.json.titleStyles);
        }
    },
    loadGridContentStyle: function(){
        if (this.json.contentStyles){
            var tds = this.node.getElements("td");
            tds.setStyles(this.json.contentStyles);
        }
    },

    _loadZebraStyle: function(){
        if (this.json.zebraColor || this.json.backgroundColor){
            var tables = this.node.getElements("table");
            tables.each(function(table){
                this._loadTableZebraStyle(table);
            }.bind(this));
        }
    },
    _loadTableZebraStyle: function(table){
        var trs = table.getElements("tr");
        for (var i=0; i<trs.length; i++){
            if (this.json.backgroundColor) trs[i].setStyle("background-color", this.json.backgroundColor);
            if ((i%2)==0){
                if (this.json.zebraColor) trs[i].setStyle("background-color", this.json.zebraColor);
            }
        }
    },

    createTotalDiv: function(){
        this.totalDiv = new Element("div.totalDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}).inject(this.node);
        var titleNode = new Element("div", {"styles": this.json.itemTitleStyles}).inject(this.totalDiv);
        titleNode.set("text", MWF.xApplication.process.Xform.LP.amount);
        var tableNode = new Element("div", {"styles": this.form.css.gridMobileTableNode }).inject(this.totalDiv);
        this.totalTable = new Element("table", {
            styles : this.json.tableStyles
        }).inject(tableNode);
        this.totalTable.set(this.json.properties);
    },

    _loadTotal: function(){
        var data = {};
        this.totalResaults = {};
        if (this.totalModules.length){
            if (!this.totalDiv){
                this.createTotalDiv();
            }
            var totalResaults = [];
            //this.totalModules.each(function(m. i){
            //    totalResaults.push(0);
            //}.bind(this));
            var tables = this.node.getElements("table");
            //var totalTds = this.totalTr.getElements("td");
            for (var i=1; i<tables.length-1; i++){

                var cells = tables[i].getElements("td");
                this.totalModules.each(function(m, idx){
                    if (!totalResaults[idx]) totalResaults.push(0);
                    var tmpV = new Decimal(totalResaults[idx]);
                    if (m.type=="number"){
                        var cell = cells[m.index];
                        var addv = ( cell.get("text") || "0" ).toFloat();
                        tmpV = tmpV.plus(addv||0);
                        //tmpV = tmpV + addv;
                    }
                    if (m.type=="count"){
                        tmpV = tmpV.plus(1);
                        //tmpV = tmpV+1;
                    }
                    totalResaults[idx] = tmpV.toString();
                    data[m.module.json.id] = totalResaults[idx];
                }.bind(this));
            }

            var trs = this.totalTable.getElements("tr");
            this.totalModules.each(function(m, i){
                var tr = trs[i];
                if (!tr){
                    tr = this.totalTable.insertRow(i);
                    var datath = new Element("th").inject(tr);
                    datath.set("text", m.module.node.get("text"));
                    //    datath.setStyle("width", "30%");
                    datath.setStyles(this.json.titleStyles);
                    tr.insertCell(1).setStyles(this.json.amountStyles).set("text", totalResaults[i] || "");
                }else{
                    tr.getElement("td").set("text", totalResaults[i] || "");
                }

                if( m.isShow === false )tr.hide();

                this.totalResaults[m.module.json.id] = totalResaults[i];
            }.bind(this));
            if (this.totalTable){
                var ths = this.totalTable.getElements("th");
                ths.setStyles(this.json.titleStyles);
                //if (this.json.border) this._loadTableBorderStyle(this.totalTable);
                //if (this.json.zebraColor || this.json.backgroundColor) this._loadTableZebraStyle(this.totalTable);
            }
        }
        return data;
    },
    getSequeceTrIndex: function(){
        var indexList = [];
        this.table.getElements("th").each(function(th, idx) {
            var module = this.editModules[idx];
            if (module) {
                if (module.json.type == "sequence") {
                    indexList.push( module.index );
                }
            }
        }.bind(this))
        return indexList;
    },
    _loadSequence: function(){
        var indexList = this.getSequeceTrIndex();
        var tables = this.node.getElements("table");
        if( indexList.length && tables.length ){
            tables.each(function (table, tableIndex) {
                table.getElements("tr").each(function (tr, trIndex) {
                    if( indexList.contains(trIndex) ){
                        tr.getElements("td").getLast().set("text", tableIndex);
                    }
                })
            })
        }

        var sequenceDivs = this.node.getElements(".sequenceDiv");
        sequenceDivs.each( function(div, index){
            div.set("text", MWF.xApplication.process.Xform.LP.item+(index+1))
        })
    },

    _loadBorderStyle: function(){
        if (this.json.border){
            var tables = this.node.getElements("table");
            tables.each(function(table){
                this._loadTableBorderStyle(table)
            }.bind(this));
        }
    },
    _loadTableBorderStyle: function(table){
        table.setStyles({
            "border-top": this.json.border,
            "border-left": this.json.border
        });
        var ths = table.getElements("th");
        ths.setStyles({
            "border-bottom": this.json.border,
            "border-right": this.json.border
        });
        var tds = table.getElements("td");
        tds.setStyles({
            "border-bottom": this.json.border,
            "border-right": this.json.border,
            "background": "transparent"
        });
    },
    _loadDatagridTitleModules: function(){
        var ths = this.node.getElements("th");
        ths.each(function(th){
            var json = this.form._getDomjson(th);
            th.store("dataGrid", this);
            if (json){
                var module = this.form._loadModule(json, th);
                this.form.modules.push(module);
            }
        }.bind(this));
    },
    _loadDatagridDataModules: function(){
        var tds = this.node.getElements("td");
        tds.each(function(td){
            var json = this.form._getDomjson(td);
            td.store("dataGrid", this);
            if (json){
                var isField = false;
                var module = this.form._loadModule(json, td, function(){
                    isField = this.field;
                    this.field = false;
                });
                if( isField ){
                    module.node.setStyle("padding-right","0px");
                }
                td.store("module", module);
                this.form.modules.push(module);
            }
        }.bind(this));
    },
    _afterLoaded: function(){
        if (this.moduleValueAG){
            this.moduleValueAG.then(function(){
                this._loadDatagridStyle();
                if (this.table) this.table.setStyle("display", "none");
            }.bind(this));
        }else{
            this._loadDatagridStyle();
            if (this.table) this.table.setStyle("display", "none");
        }
    },
    // /**
    //  * @summary 重置数据网格的值为默认值或置空。
    //  *  @example
    //  * this.form.get('fieldId').resetData();
    //  */
    resetData: function(){
        this.setData(this._getValue());
    },
    /**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
     * @summary 为数据网格赋值。
     * @param data{DatagridData|Promise|Array} 必选，数组或Promise.
     * @example
     *  this.form.get("fieldId").setData([]); //赋空值
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      this.form.get('fieldId').setData( data );
     *  }else{
     *      this.data['fieldId'] = data;
     *  }
     *@example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var promise = new Promise(function(resolve, reject){ //发起异步请求
     *    var oReq = new XMLHttpRequest();
     *    oReq.addEventListener("load", function(){ //绑定load事件
     *      resolve(oReq.responseText);
     *    });
     *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
     *    oReq.send();
     *  });
     *  promise.then( function(){
     *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
     * })
     *  field.setData( promise );
     */
    setData: function(data){
        if (!data){
            data = this._getValue();
        }
        this._setData(data);
    },
    _setData: function(data){
        var p = o2.promiseAll(this.data).then(function(v){
            this.gridData = v;
            if (o2.typeOf(data)=="array") data = {"data": data};
            this.__setData(data);
            this.moduleValueAG = null;
            return v;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));
        this.moduleValueAG = p;
        if (this.moduleValueAG) this.moduleValueAG.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));

        // if (data && data.isAG){
        //     this.moduleValueAG = data;
        //     data.addResolve(function(v){
        //         this._setData(v);
        //     }.bind(this));
        // }else{
        //     if (o2.typeOf(data)=="array") data = {"data": data};
        //     this.__setData(data);
        //     this.moduleValueAG = null;
        // }
    },
    __setData: function(data){
        // if( typeOf( data ) === "object" && typeOf(data.data) === "array"  ){
        // if (data){
        //     this._setBusinessData(data);
        //     this.gridData = data;
        // }else{
        //     this.gridData = this._getValue();
        // }
        this._setBusinessData(data);
        this.gridData = data;

        // if (this.isEdit) this._completeLineEdit();
        if( this.isEdit ){
            this.isEdit = false;
            if (this.currentEditLine) {
                this._editorTrGoBack();
                this.currentEditLine.destroy()
            }else{
                var datagridDataDiv = this.node.getElement(".datagridDataDiv");
                this._editorTrGoBack();
                if(datagridDataDiv)datagridDataDiv.destroy();
            }
            this.currentEditLine = null;
        }

        if (this.gridData){

            var divs = this.node.getElements(".dataDiv");
            for (var i=0; i<divs.length; i++){
                var table = divs[i].getElement("table");
                var tds = table.getElements("td");
                for (var j=0; j<tds.length; j++){
                    var td = tds[j];
                    var moduleTd = td.retrieve("module");
                    if (moduleTd){
                        this.form.modules.erase(moduleTd);
                        moduleTd = null;
                    }
                }
                var ths = table.getElements("th");
                for (var k=0; k<ths.length; k++){
                    var th = ths[k];
                    var moduleTh = th.retrieve("module");
                    if (moduleTh){
                        this.form.modules.erase(moduleTh);
                        moduleTh = null;
                    }
                }
            }
            for( var i=0; i<divs.length; i++ ){
                divs[i].destroy();
            }

            // var tables = this.node.getElements("table");
            // for (var i=1; i<tables.length-1; i++){
            //     var table = tables[i];
            //     var tds = table.getElements("td");
            //     for (var j=0; j<tds.length; j++){
            //         var td = tds[j];
            //         var moduleTd = td.retrieve("module");
            //         if (moduleTd){
            //             this.form.modules.erase(moduleTd);
            //             delete moduleTd;
            //         }
            //     }
            //     var ths = table.getElements("th");
            //     for (var k=0; k<ths.length; k++){
            //         var th = ths[k];
            //         var moduleTh = th.retrieve("module");
            //         if (moduleTh){
            //             this.form.modules.erase(moduleTh);
            //             delete moduleTh;
            //         }
            //     }
            // }
            //
            // while (tables.length>2){
            //     tables[1].destroy();
            //     tables = this.node.getElements("table");
            // }
            if (this.editable!=false){
                this._loadEditDatagrid();
                //this._loadReadDatagrid();
            }else{
                this._loadReadDatagrid();
            }
            this._loadDatagridStyle();
        }


    },
    /**
     * @summary 获取总计数据.
     * @example
     * var totalObject = this.form.get('fieldId').getTotal();
     * @return {Object} 总计数据
     */
    getTotal: function(){
        this._loadTotal();
        return this.totalResaults;
    },
    /**
     * @summary 判断数据网格是否为空.
     * @example
     * if( this.form.get('fieldId').isEmpty() ){
     *     this.form.notice('至少需要添加一条数据', 'warn');
     * }
     * @return {Boolean} 是否为空
     */
    isEmpty: function(){
        var data = this.getData();
        if( !data )return true;
        if( typeOf( data ) === "object" ){
            if( typeOf( data.data ) !== "array" )return true;
            if( data.data.length === 0 )return true;
        }
        return false;
    },
    /**
     * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
     * 区别如下：<br/>
     * 1、当使用Promise的时候<br/>
     * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
     * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
     * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
     * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
     * @summary 获取数据网格数据.
     * @example
     * var data = this.form.get('fieldId').getData();
     *@example
     *  //如果无法确定表单上是否有组件，需要判断
     *  var data;
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      data = this.form.get('fieldId').getData();
     *  }else{
     *      data = this.data['fieldId']; //直接从数据中获取字段值
     *  }
     *  @example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var promise = new Promise(function(resolve, reject){ //发起异步请求
     *    var oReq = new XMLHttpRequest();
     *    oReq.addEventListener("load", function(){ //绑定load事件
     *      resolve(oReq.responseText);
     *    });
     *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
     *    oReq.send();
     *  });
     *  promise.then( function(){
     *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
     * })
     *  field.setData( promise );
     * @return {DatagridData}
     */
    getData: function(){
        if (this.editable!=false){
            if (this.isEdit) this._completeLineEdit();
            var data = [];

            var tables = this.node.getElements("table");
            for (var i=1; i<((this.totalTable) ? tables.length-1 : tables.length); i++){
                var table = tables[i];
                var d = table.retrieve("data");
                if (d) data.push(d);
            }
            this.gridData = {};
            this.gridData.data = data;

            this._loadTotal();
            this.gridData.total = this.totalResaults;

            this._setBusinessData(this.gridData);

            return (this.gridData.data.length) ? this.gridData : {data:[]};
        }else{
            return this._getBusinessData();
        }
    },
    getAmount: function(){
        return this._loadTotal();
    },
    createErrorNode: function(text){
        node = new Element("div", {styles:{
            "margin-top": "0.3em"  
        }});
        var iconNode = new Element("div.ooicon-error", {
            "styles": {
                "width": "20px",
                "height": "1.2em",
                "float": "left",
                "display": "flex",
                "color": "red",
                "align-items": "center",
                "justify-content": "center"
                // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "height": "auto",
                "line-height": "1.2em",
                "margin-left": "20px",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            if (p.get("MWFtype") == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },

    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getData();
            if( typeOf(n)==="object" && JSON.stringify(n) === JSON.stringify({data:[]}) )n = "";
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    validation: function(routeName, opinion){
        if (this.isEdit){
            if (!this.editValidation()){
                return false;
            }
        }
        if (!this.validationConfig(routeName, opinion))  return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;

        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";

        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString()!="true"){
            this.notValidationMode(flag);
            return false;
        }
        return true;
    }

});

MWF.xApplication.process.Xform.DatagridMobile$Title =  new Class({
    Extends: MWF.APP$Module,
    _afterLoaded: function(){
        this.dataGrid = this.node.retrieve("dataGrid");
        if ((this.json.total == "number") || (this.json.total == "count")){
            this.dataGrid.totalModules.push({
                "module": this,
                "index": this.node.getParent("tr").rowIndex,
                "type": this.json.total,
                "isShow": this.json.isShow
            })
        }
        //	this.form._loadModules(this.node);
    }
});
MWF.xApplication.process.Xform.DatagridMobile$Data =  new Class({
    Extends: MWF.APP$Module,
    _afterLoaded: function(){
        //this.form._loadModules(this.node);
        this.dataGrid = this.node.retrieve("dataGrid");

        var td = this.node;
        if (this.json.cellType == "sequence"){
            var flag = true;
            for (var i=0; i<this.dataGrid.editModules.length; i++){
                if (this.dataGrid.editModules[i].json.id == this.json.id){
                    flag = false;
                    break;
                }
            }
            if (flag){
                this.dataGrid.editModules.push({
                    "json": {"type": "sequence", "id": this.json.id},
                    "index": this.node.getParent("tr").rowIndex,
                    "node": td  ,
                    "focus": function(){}
                });
            }
            td.empty();
        }else{
            var moduleNodes = this.form._getModuleNodes(this.node);
            moduleNodes.each(function(node){
                var json = this.form._getDomjson(node);
                var isField = false;

                if (json.type=="Attachment" || json.type=="AttachmentDg" ){
                    json.type = "AttachmentDg";
                    //json.site = this.dataGrid.getAttachmentRandomSite();
                    //json.id = json.site;
                }

                var module = this.form._loadModule(json, node, function(){
                    isField = this.field;
                    this.field = false;
                });
                if( isField ){
                    module.node.setStyle("padding-right","0px");
                }
                module.dataModule = this;
                this.dataGrid.editModules.push(module);
            }.bind(this));
        }
    }
});

/**
 * 数据网格数据结构.
 * @typedef {Object} DatagridData
 * @property {Array} data - 数据网格列表数据
 * @property {Object} total - 统计数据
 * @example
 * 	{
	  "data": [ //数据网格条目
		{
		  "datagrid_datagrid$Title": { //数据网格第1列title标识
			"org_20": {  //数据网格第1列字段标识，人员组件单个对象，存的是对象
			  "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
			  "id": "bf007525-99a3-4178-a474-32865bdddec8",
			  "name": "张三",
			  "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
			  "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
			  "unitLevelName": "兰德纵横/市场营销部",
			  "unitName": "市场营销部"
			}
		  },
		  "datagrid_datagrid$Title1": { //数据网格第2列title标识
			"org_21": [{  //数据网格第2列字段标识，人员组件多个对象，存的是数组
			  "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
			  "id": "bf007525-99a3-4178-a474-32865bdddec8",
			  "name": "张三",
			  "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
			  "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
			  "unitLevelName": "兰德纵横/市场营销部",
			  "unitName": "市场营销部"
			},{
			  "distinguishedName": "李四@bf007525-99a3-4178-a474-32865bdddec8@I",
			  "id": "bf007525-99a3-4178-a474-32865bdddec8",
			  "name": "李四",
			  "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
			  "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
			  "unitLevelName": "兰德纵横/市场营销部",
			  "unitName": "市场营销部"
			}]
		  },
		  "datagrid_datagrid$Title_2": { //数据网格第2列title标识
			"number": "111" //数据网格第3列字段标识和值
		  },
		  "datagrid_datagrid$Title_3": { //数据网格第3列title标识
			"textfield_2": "杭州" //数据网格第4列字段标识和值
		  },
		  "datagrid_datagrid$Title_4": { //数据网格第4列title标识
			"attachment_1": [  //数据网格第5列字段标识
			  {
				"activityName": "拟稿",
				"extension": "jpg",
				"id": "9514758e-9e28-4bfe-87d7-824f2811f173",
				"lastUpdateTime": "2020-12-09 21:48:03",
				"length": 452863.0,
				"name": "111.jpg",
				"person": "李四@lisi@P"
			  }
			]
		  }
		},
		...
	  ],
	  "total": {  //统计数据，列title设置了总计
		"datagrid_datagrid$Title_2": "333", //总计列2
		"datagrid_datagrid$Title_3": "2" //总计列3
	  }
	}
 */
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class DatagridPC 数据网格组件（PC端）。从v6.2开始建议用数据表格(Datatable)代替。
 * @o2cn 数据网格PC端（过时）
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datagrid = this.form.get("name"); //获取组件
 * //方法2
 * var datagrid = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.DatagridPC = new Class(
	/** @lends MWF.xApplication.process.Xform.DatagridPC# */
	{
		Implements: [Events],
		Extends: MWF.APP$Module,
		isEdit: false,
		options: {
			/**
			 * 当前条目编辑完成时触发。通过this.event可以获取对应的tr。
			 * @event MWF.xApplication.process.Xform.DatagridPC#completeLineEdit
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 添加条目时触发。通过this.event可以获取对应的tr。
			 * @event MWF.xApplication.process.Xform.DatagridPC#addLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目前触发。通过this.event可以获取对应的tr。
			 * @event MWF.xApplication.process.Xform.DatagridPC#deleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目后触发。
			 * @event MWF.xApplication.process.Xform.DatagridPC#afterDeleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 编辑条目时触发。
			 * @event MWF.xApplication.process.Xform.DatagridPC#editLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 导出excel的时候触发，this.event指向导出的数据，您可以通过修改this.event来修改数据。
			 * @event MWF.xApplication.process.Xform.DatagridPC#export
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *   		["姓名","性别","学历","专业","出生日期","毕业日期"], //标题
			 *  		[ "张三","男","大学本科","计算机","2001-1-2","2019-9-2" ], //第一行数据
			 *  		[ "李四","男","大学专科","数学","1998-1-2","2018-9-2" ]  //第二行数据
			 * 	], //导出的数据
			 *     colWidthArray : [100, 50, 100, 200, 150, 150], //每列宽度
			 *     title : "xxxx" //导出的excel文件标题
			 * }
			 */
			/**
			 * 在导入excel，进行数据校验后触发，this.event指向导入的数据。
			 * @event MWF.xApplication.process.Xform.DatagridPC#validImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *  	   {
			 *  	 	"姓名" : "张三",
			 *  	 	"性别" : "男",
			 *  	 	"学历" ： "大学本科",
			 *  	    "专业" : "计算机",
			 *  	    "出生日期" : "aa01-1-2",
			 *  	 	"毕业日期" : "2019-9-2",
			 *  	 	"errorTextList" : [
			 *  	 	    "第5列：aa01-1-2不是正确的日期格式。"
			 *  	 	] //校验出的错误信息，如果该行数据正确，则无该字段
			 *  	 }
			 *  	 ...
			 *     ], //导入的数据
			 *     "validted" : true  //是否校验通过，可以在本事件中修改该参数，确定是否强制导入
			 * }
			 */
			/**
			 * 在导入excel，数据校验成功将要设置回数据网格的时候触发，this.event指向整理过的导入数据，格式见{@link DatagridData}。
			 * @event MWF.xApplication.process.Xform.DatagridPC#import
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			"moduleEvents": ["queryLoad","postLoad","load","completeLineEdit", "addLine", "deleteLine", "afterDeleteLine","editLine", "export", "import", "validImport"]
		},

		initialize: function(node, json, form, options){
			/**
			 * @ignore
			 * @member parentLine
			 * @memberOf MWF.xApplication.process.Xform.DatagridPC#
			 */

			this.node = $(node);
			this.node.store("module", this);
			this.json = json;
			this.form = form;
			this.field = true;
			this.fieldModuleLoaded = false;
		},
		load: function(){
			this._loadModuleEvents();
			if (this.fireEvent("queryLoad")){
				this._queryLoaded();
				this._loadUserInterface();
				this._loadStyles();
				this._loadDomEvents();
				//this._loadEvents();

				this._afterLoaded();
				this.fireEvent("afterLoad");
				// this.fireEvent("load");
			}
		},
		_loadUserInterface: function(){
			// this.fireEvent("queryLoad");

			this.editModules = [];
			this.node.setStyle("overflow-x", "auto");
			this.node.setStyle("overflow-y", "hidden");
			this.table = this.node.getElement("table");

			this.editable = (this.readonly || this.json.isReadonly === true || this.form.json.isReadonly === true) ? false : true;
			if (this.editable && this.json.editableScript && this.json.editableScript.code){
				this.editable = this.form.Macro.exec(((this.json.editableScript) ? this.json.editableScript.code : ""), this);
			}

			this.deleteable = this.json.deleteable !== "no";
			this.addable = this.json.addable !== "no";

			//允许导入
			this.importenable  = this.editable && (this.json.impexpType === "impexp" || this.json.impexpType === "imp");
			//允许导出
			this.exportenable  = this.json.impexpType === "impexp" || this.json.impexpType === "exp";

			this.gridData = this._getValue();

			if( this.gridData.data && o2.typeOf(this.gridData.data)==="object"){
				this.gridData.data = [];
			}

			this.totalModules = [];
			this._loadDatagridTitleModules();

			if (this.editable!=false){
				this._loadDatagridDataModules();
				this._addTitleActionColumn();

				this._loadEditDatagrid(function(){
					this._loadImportExportAction();
					this.fieldModuleLoaded = true;
					this.fireEvent("postLoad");
					this.fireEvent("load");
				}.bind(this));
				//this._loadReadDatagrid();
			}else{
				this._loadDatagridDataModules();
				this._getDatagridEditorTr();
				this._loadReadDatagrid(function(){
					if(this.editorTr)this.editorTr.setStyle("display", "none");
					this._loadImportExportAction();
					this.fieldModuleLoaded = true;
					this.fireEvent("postLoad");
					this.fireEvent("load");
				}.bind(this));

			}
		},
		_loadStyles: function(){
			this.table.setStyles(this.json.tableStyles);
			this.node.setStyles(this.json.styles);
		},
		_getValue: function(){
			if (this.moduleValueAG) return this.moduleValueAG;
			var value = [];
			value = this._getBusinessData();
			if (!value){
				if (this.json.defaultData && this.json.defaultData.code) value = this.form.Macro.exec(this.json.defaultData.code, this);
				if (value && !value.then) if (o2.typeOf(value)=="array") value = {"data": value || []};
			}
			return value || {};
		},
		getValue: function(){
			if (!this.isReadable) return {};
			return this._getValue();
		},
		_getDatagridTr: function(){
			this._getDatagridTitleTr();
			this._getDatagridEditorTr();
		},
		_getDatagridTitleTr: function(){
			this.titleTr = this.table.getElement("tr");
			return this.titleTr;
		},
		_getDatagridEditorTr: function(){
			var trs = this.table.getElements("tr");
			this.editorTr = trs[trs.length-1];
			this.editorTr.addClass("datagridEditorTr");

			return this.editorTr;
		},
		_addTitleActionColumn: function(){
			if (!this.titleTr) this._getDatagridTitleTr();
			if (!this.editorTr) this._getDatagridEditorTr();

			var actionTh = new Element("th", {"styles": {"width": "46px"}}).inject(this.titleTr, "top");
			new Element("th").inject(this.titleTr, "bottom");
			if( this.addable ){
				this._createAddLineAction(actionTh);
			}
			//this._createDelLineAction(actionTh);

			var actionEditTd = new Element("td").inject(this.editorTr, "top");
			this._createCompleteAction(actionEditTd);
			if( this.deleteable ){
				this._createCancelAction(actionEditTd);
			}

			new Element("td").inject(this.editorTr, "bottom");

			//if (this.totalTr){
			//    new Element("td").inject(this.totalTr, "top");
			//    new Element("td").inject(this.totalTr, "bottom");
			//    this.totalModules.each(function(m){
			//        m.index = m.index+1;
			//    });
			//}
		},

		_loadEditDatagrid: function(callback){
			var p = o2.promiseAll(this.gridData).then(function(v){
				this.gridData = v;
				if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
				this.__loadEditDatagrid(callback);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			// if (this.gridData && this.gridData.isAG){
			// 	this.moduleValueAG = this.gridData;
			// 	this.gridData.addResolve(function(v){
			// 		this.gridData = v;
			// 		this._loadEditDatagrid(callback);
			// 	}.bind(this));
			// }else{
			// 	if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
			// 	this.__loadEditDatagrid(callback);
			// 	this.moduleValueAG = null;
			// }
		},
		__loadEditDatagrid: function(callback){
			var titleThs = this.titleTr.getElements("th");
			var editorTds = this.editorTr.getElements("td");

			if (this.gridData.data){
				this.gridData.data.each(function(data, idx){
					var tr = $(this.table.insertRow(idx+1));
					tr.store("data", data);
					titleThs.each(function(th, index){
						var cellData = data[th.get("id")];
						var text = "";
						if( typeOf( cellData ) !== "array" ) {
							for (key in cellData) {
								var value = cellData[key];
								text = this._getValueText(index - 1, value);
								break;
							}
						}
						this._createNewEditTd(tr, index, editorTds[index].get("id"), text, titleThs.length-1, idx);
					}.bind(this));
				}.bind(this));
			}
			this.editorTr.setStyle("display", "none");
			if (callback) callback();
		},


		_getValueText: function(idx, value){

			var module = this.editModules[idx];
			if (module){
				switch (module.json.type){
					case "Select":
						for (var i=0; i<module.json.itemValues.length; i++){
							var itemv = module.json.itemValues[i];
							var arr = itemv.split(/\|/);
							var text = arr[0];
							var v = (arr.length>1) ? arr[1] : arr[0];
							if (value===v) return text;
						}
						// var ops = module.node.getElements("option");
						// for (var i=0; i<ops.length; i++){
						// 	if (ops[i].value == value){
						// 		return ops[i].get("text");
						// 		break;
						// 	}
						// }
						break;
					case "Radio":
						var ops = module.node.getElements("input");
						for (var i=0; i<ops.length; i++){
							if (ops[i].value == value){
								return ops[i].get("showText");
								break;
							}
						}
						break;
					case "Checkbox":
						var ops = module.node.getElements("input");
						var texts = [];
						for (var i=0; i<ops.length; i++){
							if (value.indexOf(ops[i].value) != -1) texts.push(ops[i].get("showText"));
						}
						if (texts.length) return texts.join(", ");
						break;
					case "Orgfield":
					case "Personfield":
					case "Org":
						//var v = module.getTextData();
						//return v.text[0];

						if (typeOf(value)==="array"){
							var textArray = [];
							value.each( function( item ){
								if (typeOf(item)==="object"){
									textArray.push( item.name+((item.unitName) ? "("+item.unitName+")" : "") );
								}else{
									textArray.push(item);
								}
							}.bind(this));
							return textArray.join(", ");
						}else if (typeOf(value)==="object"){
							return value.name+((value.unitName) ? "("+value.unitName+")" : "");
						}else{
							return value;
						}

						break;
					case "Textarea":
						var reg = new RegExp("\n","g");
						var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
						var reg3 = new RegExp("\u003e","g");
						value = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
						break;
					// case "address":
					// 	if (typeOf(value)==="array"){
					//
					// 	}
					// 	break;
				}
			}
			return value;
		},

		_createNewEditTd: function(tr, idx, id, text, lastIdx, rowIndex){
			var cell = $(tr.insertCell(idx));
			if (idx==0){
				cell.setStyles(this.form.css.gridLineActionCell);
				if( this.addable )this._createAddLineAction(cell);
				if( this.deleteable )this._createDelLineAction(cell);
			}else if (idx == lastIdx){
				cell.setStyles(this.form.css.gridMoveActionCell);
				this._createMoveLineAction(cell);
			}else{
				cell.set("MWFId", id);

				var module = this.editModules[idx-1];
				if( module && module.json.type == "ImageClipper" ){
					this._createImage( cell, module, text )
				}else if( module && module.json.type == "Image" ) {
					this._createImg(cell, module, rowIndex);
				}else if( module && module.json.type == "Button" ) {
					this._createButton(cell, module, rowIndex);
				}else if( module && module.json.type == "Label" ) {
					this._createLabel(cell, module, rowIndex);
				}else if( module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg") ){
					this._createAttachment( cell, module, text );
				}else{
					if( module && module.json.type == "Textarea" ){
						cell.set("html", text);
					}else{
						cell.set("text", text);
					}
					// /cell.set("text", text);
				}
				if( !module ||  !["Button"].contains( module.json.type ) ){
					cell.addEvent("click", function(e){
						this._editLine(e.target);
					}.bind(this));
				}
			}
			var json = this.form._getDomjson(cell);

			if (json){
				cell.store("dataGrid", this);
				var module = this.form._loadModule(json, cell);
				cell.store("module", module);
				this.form.modules.push(module);
				if( json.isShow === false )cell.hide();
			}

		},

		_createAddLineAction: function(td){
			var addLineAction = new Element("div.addLineAction.ooicon-create", {
				"styles": this.form.css.addLineAction,
				"events": {
					"click": function(e){
						this._addLine(e.target);
					}.bind(this)
				}
			});
			addLineAction.inject(td);
		},
		_createDelLineAction: function(td){
			var delLineAction = new Element("div.delLineAction.ooicon-delete", {
				"styles": this.form.css.delLineAction,
				"events": {
					"click": function(e){
						this._deleteLine(e);
					}.bind(this)
				}
			});
			delLineAction.inject(td);
		},
		_createCompleteAction: function(td){
			var completeAction = new Element("div.completeLineAction.ooicon-checkmark", {
				"styles": this.form.css.completeLineAction,
				"events": {
					"click": function(e){
						this._completeLineEdit(e);
					}.bind(this)
				}
			});
			completeAction.inject(td);
		},
		_createCancelAction: function(td){
			var cancelAction = new Element("div.cancelLineEditAction.ooicon-process-cancel", {
				"styles": this.form.css.delLineAction,
				"events": {
					"click": function(e){
						this._cancelLineEdit(e);
					}.bind(this)
				}
			});
			cancelAction.inject(td);
		},

		_editLine:function(td){
			if (this.isEdit){
				if (!this._completeLineEdit()) return false;
			}

			this.currentEditLine = td.getParent("tr");
			if (this.currentEditLine){
				this.editorTr.setStyles({
					//"background-color": "#fffeb5",
					"display": "table-row"
				});
				this.editorTr.inject(this.currentEditLine, "before");
				this.currentEditLine.setStyle("display", "none");

				var data = this.currentEditLine.retrieve("data");
				var titleThs = this.titleTr.getElements("th");
				titleThs.each(function(th, idx){
					var id = th.get("id");
					var module = this.editModules[idx-1];
					if (module){
						if (module.json.type=="sequence"){
							module.node.set("text", module.node.getParent("tr").rowIndex);
						}else if( module.setData ){

							if (data[id]) {
								module.setData(data[id][module.json.id]);
							} else {
								module.setData(null);
							}
						}
					}
				}.bind(this));



				var cellIdx = this.currentEditLine.getElements("td").indexOf(td);
				var module = this.editModules[cellIdx-1];
				if (module) module.focus();


				this.fireEvent("editLine");

				this.isEdit =true;
			}
			this.validationMode();
		},
		editValidation: function(){
			var flag = true;
			this.editModules.each(function(field, key){
				if (field.json.type!="sequence" && field.validationMode ){
					field.validationMode();
					if (!field.validation()) flag = false;
				}
			}.bind(this));
			return flag;
		},

		// _cancelLineEdit: function(e){
		// 	this.isEdit = false;
		//
		// 	var flag = true;
		//
		// 	var griddata = {};
		// 	var newTr = null;
		//
		// 	if (this.currentEditLine){
		// 		newTr = this.currentEditLine;
		// 		griddata = this.currentEditLine.retrieve("data");
		// 	}else{
		// 		newTr = new Element("tr").inject(this.editorTr, "before");
		// 		griddata = {};
		// 	}
		//
		// 	if (flag){
		// 		newTr.destroy();
		// 	}
		// 	this.currentEditLine = null;
		//
		// 	this._editorTrGoBack();
		//
		// 	// if (this.json.contentStyles){
		// 	// 	var tds = newTr.getElements("td");
		// 	// 	tds.setStyles(this.json.contentStyles);
		// 	// }
		// 	// if (this.json.actionStyles){
		// 	// 	newTr.getFirst().setStyles(this.json.actionStyles);
		// 	// }
		//
		// 	// this._loadBorderStyle();
		// 	// this._loadZebraStyle();
		// 	// this._loadSequence();
		//
		// 	this.fireEvent("cancelLineEdit");
		// },
		_cancelLineEdit: function(e){

			var datagrid = this;
			this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle, MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit, 300, 120, function(){
				if (datagrid.currentEditLine) {
					datagrid.currentEditLine.setStyle("display", "table-row");
				}

				datagrid.editModules.each(function(module){
					if (module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
						module.attachmentController.attachments.each(function(att){
							datagrid.form.workAction.deleteAttachment(att.data.id, datagrid.form.businessData.work.id);
						});
						module.attachmentController.clear();
					}
				});

				datagrid.isEdit = false;
				datagrid.currentEditLine = null;

				datagrid._editorTrGoBack();

				// this._loadBorderStyle();
				// this._loadZebraStyle();
				// this._loadSequence();
				// this.getData();

				// datagrid._loadZebraStyle();
				// datagrid._loadSequence();
				// datagrid._loadTotal();
				// datagrid.getData();
				this.close();

				datagrid.fireEvent("cancelLineEdit");
			}, function(){
				// var color = currentTr.retrieve("bgcolor");
				// currentTr.tween("background", color);
				this.close();
			}, null, null, this.form.json.confirmStyle);

		},
		_completeLineEdit: function( ev ){
			//this.currentEditLine.getElemets(td);
			if (!this.editValidation()){
				return false;
			}

			this.isEdit = false;

			var flag = true;
			var saveFlag = false;

			var griddata = {};
			var newTr = null;

			if (this.currentEditLine){
				newTr = this.currentEditLine;
				griddata = this.currentEditLine.retrieve("data");
			}else{
				newTr = new Element("tr").inject(this.editorTr, "before");
				griddata = {};
			}

			var titleThs = this.titleTr.getElements("th");
			var editorTds = this.editorTr.getElements("td");
			var cells = newTr.getElements("td");
			titleThs.each(function(th, idx){
				var cell = cells[idx];
				var id = th.get("id");
				var module = this.editModules[idx-1];
				if (module){
					if (module.json.type=="sequence"){
						flag = false;
						var i = newTr.rowIndex;
						var data = {"value": [i], "text": [i]};
					}else if (module.json.type=="Attachment" || module.json.type == "AttachmentDg"){
						saveFlag = true;
						flag = false;
						var data = module.getTextData();
						//data.site = module.json.site;
						if (!griddata[id]) griddata[id] = {};
						griddata[id][module.json.id] = data;
						// }else if( ["Orgfield","Personfield","Org","Address"].contains(module.json.type) ){
						// 	data = module.getTextData();
						// 	if( data.value && data.value.length )flag = false;
						// 	if (!griddata[id]) griddata[id] = {};
						// 	griddata[id][module.json.id] = data.value;
					}else if( module.getTextData ){
						var data = module.getTextData();
						if (data.value[0]) flag = false;
						if (data.value.length<2){
							if (!griddata[id]) griddata[id] = {};
							griddata[id][module.json.id] = data.value[0];
						}else{
							if (!griddata[id]) griddata[id] = {};
							griddata[id][module.json.id] = data.value;
						}
					}

					if( data ){
						if (cell){
							if( module.json.type == "ImageClipper" ){
								this._createImage( cell, module, data.text[0] );
							}else if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
								this._createAttachment( cell, module, data );
							}else{
								var text = this._getValueText(idx-1, data.text.join(", "));
								if( module.json.type == "Textarea"){
									cell.set("html", text);
								}else{
									cell.set("text", data.text.join(", "));
								}
							}
						}else{
							if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
								this._createNewEditTd(newTr, idx, editorTds[idx].get("id"), data, titleThs.length-1);
							}else{
								var text = this._getValueText(idx-1, data.text.join(", "));
								this._createNewEditTd(newTr, idx, editorTds[idx].get("id"), text, titleThs.length-1);
							}
						}
					}else{
						if (!cell) this._createNewEditTd(newTr, idx, id, "", titleThs.length-1);
					}
				}else{
					if (!cell) this._createNewEditTd(newTr, idx, id, "", titleThs.length-1);
				}
				module = null;
			}.bind(this));

			newTr.store("data", griddata);
			newTr.setStyle("display", "table-row");

			if (flag){
				newTr.destroy();
			}
			this.currentEditLine = null;

			this._editorTrGoBack();

			if (this.json.contentStyles){
				var tds = newTr.getElements("td");
				tds.setStyles(this.json.contentStyles);
			}
			if (this.json.actionStyles){
				newTr.getFirst().setStyles(this.json.actionStyles);
			}

			this._loadBorderStyle();
			this._loadZebraStyle();
			this._loadSequence();
			this.getData();
			this.validationMode();
			this.fireEvent("completeLineEdit", [newTr]);

			if( saveFlag ){
				this.form.saveFormData();
			}

			return true;
		},
		// _createImg : function(cell, module, idx){
		// 	cell.empty();
		// 	if( module.node ){
		// 		var node = module.node.clone();
		// 		node.set("id", module.json ? (module.json.id +"_"+idx) : "" );
		// 		node.inject(cell);
		// 	}
		// },
		_createImg : function(cell, module, idx){
			this._cloneModule(cell, module, idx);
		},
		_createLabel : function(cell, module, idx){
			this._cloneModule(cell, module, idx);
		},
		_createButton : function(cell, module, idx){
			this._cloneModule(cell, module, idx);
		},
		_cloneModule : function(cell, module, idx){
			cell.empty();
			if( module.node && module.json ){
				var json = Object.clone( module.json );
				json.id = json.id +"_"+idx;

				var node = module.node.clone();
				node.set("id", json.id);
				node.inject(cell);

				this.form._loadModule(json, node)
			}
		},
		_createImage : function( cell, module, data ){
			cell.empty();
			if( !data )return;
			var img = new Element("img",{
				src : MWF.xDesktop.getImageSrc( data )
			}).inject( cell, "top" );
			if( module.json.clipperType == "size" ){
				var width = module.json.imageWidth;
				var height = module.json.imageHeight;
				if (width && height) {
					img.setStyles({
						width: width + "px",
						height: height + "px"
					})
				}
			}
		},
		_createAttachment: function ( cell, module, data ){
			cell.empty();
			var options = {
				"style": module.json.style || "default",
				"title": MWF.xApplication.process.Xform.LP.attachmentArea,
				"listStyle": module.json.dg_listStyle || "icon",
				"size": module.json.dg_size || "min",
				"resize": (module.json.dg_resize === "y" || this.json.dg_resize === "true"),
				"attachmentCount": 0,
				"isUpload": false,
				"isDelete": false,
				"isReplace": false,
				"isDownload": true,
				"isSizeChange": (module.json.dg_isSizeChange === "y" || module.json.dg_isSizeChange === "true"),
				"readonly": true,
				"availableListStyles": module.json.dg_availableListStyles ? module.json.dg_availableListStyles : ["list", "seq", "icon", "preview"],
				"isDeleteOption": "n",
				"isReplaceOption": "n",
				"toolbarGroupHidden": module.json.dg_toolbarGroupHidden || []
			};
			if (this.readonly) options.readonly = true;
			if(!this.editable && !this.addable)options.readonly = true;

			var atts = [];
			( data || [] ).each(function(d){
				var att = module.attachmentController.attachments.find(function(a){
					return d.id == a.data.id;
				});
				if (att) module.attachmentController.removeAttachment(att);
			});
			module.setAttachmentBusinessData();


			var attachmentController = new MWF.xApplication.process.Xform.AttachmentController(cell, module, options);
			attachmentController.load();

			( data || [] ).each(function (att) {
				var attachment = this.form.businessData.attachmentList.find(function(a){
					return a.id==att.id;
				});
				var attData = attachment || att;
				//if (att.site===this.json.id || (this.json.isOpenInOffice && this.json.officeControlName===att.site)) this.attachmentController.addAttachment(att);
				attachmentController.addAttachment(attData);
			}.bind(this));
		},
		_editorTrGoBack: function(){
			this.editorTr.setStyle("display", "none");
//		this.editTr.removeEvents("blur");
			if (this.totalTr){
				this.editorTr.inject(this.totalTr, "before");
			}else{
				var lastTrs = this.table.getElements("tr");
				var lastTr = lastTrs[lastTrs.length-1];
				this.editorTr.inject(lastTr, "after");
			}
		},
		_addLine: function(node){
			if (this.isEdit){
				if (!this._completeLineEdit()) return false;
			}
			this.editorTr.setStyles({
				//"background-color": "#fffeb5",
				"display": "table-row"
			});
			this.currentEditLine = null;
			var currentTr = node.getParent("tr");
			if (currentTr){
				this.editorTr.inject(currentTr, "after");
			}
			this.isEdit =true;

			this._loadSequence();
			this.validationMode();
			this.fireEvent("addLine",[this.editorTr]);
//		newTr.addEvent("blur", function(e){
//			this._completeLineEdit();
//		}.bind(this));
		},
		_deleteLine: function(e){
			var saveFlag = false;
			var currentTr = e.target.getParent("tr");
			if (currentTr){
				var color = currentTr.getStyle("background");
				currentTr.store("bgcolor", color);
				currentTr.tween("background-color", "#ffd4d4");
				var datagrid = this;
				var _self = this;
				this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteDatagridLine, 300, 120, function(){
					_self.fireEvent("deleteLine", [currentTr]);

					var data = currentTr.retrieve("data");

					//var attKeys = [];
					var titleThs = _self.titleTr.getElements("th");
					titleThs.each(function(th, i){
						var key = th.get("id");
						var module = (i>0) ? _self.editModules[i-1] : null;
						if (key && module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
							data[key][module.json.id].each(function(d){
								_self.form.workAction.deleteAttachment(d.id, _self.form.businessData.work.id);
							});
							saveFlag = true;
						}
					});

					currentTr.destroy();
					datagrid._loadZebraStyle();
					datagrid._loadSequence();
					datagrid._loadTotal();
					datagrid.getData();
					this.close();

					_self.fireEvent("afterDeleteLine");

					if(saveFlag){
						_self.form.saveFormData();
					}
				}, function(){
					var color = currentTr.retrieve("bgcolor");
					currentTr.tween("background", color);
					this.close();
				}, null, null, this.form.json.confirmStyle);
			}
			this.validationMode();
		},
		_createMoveLineAction: function(td){
			var moveLineAction = new Element("div", {
				"styles": this.form.css.moveLineAction,
				"events": {
					"mousedown": function(e){
						this._moveLine(e);
					}.bind(this)
				}
			});
			moveLineAction.inject(td);
		},
		_getMoveDragNode: function(tr){
			var table = tr.getParent("table");
			var div = table.getParent("div");
			var size = div.getSize();
			var dragNode = div.clone().setStyle("width", size.x).inject(document.body);
			var dragtable = dragNode.getElement("table");
			dragtable.empty();

			var clone = tr.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(dragtable);
			var tds = tr.getElements("td");
			var clonetds = clone.getElements("td");
			tds.each(function(td, idx){
				var size = td.getComputedSize();
				clonetds[idx].setStyle("width", size.width+1);
			});

			var coordinates = tr.getCoordinates();
			dragNode.setStyles(this.form.css.gridMoveLineDragNode);
			dragNode.setStyles(coordinates);

			return dragNode;
		},
		_moveLine: function(e){
			var trs = this.table.getElements("tr");
			var div = e.target;
			var tr = div.getParent("tr");

			var dragNode = this._getMoveDragNode(tr);
			coordinates = dragNode.getCoordinates();
			var dragTr = dragNode.getElement("tr");
			var dragTable = dragNode.getElement("table");

			var color = tr.getStyle("background");
			tr.store("bgcolor", color);
			//tr.tween('background-color', '#f3f1ad');
			tr.tween('background-color', '#e4f6e9');


			var drag = new Drag.Move(dragNode, {
				"droppables": trs.erase(tr),
				"limit": {"x": [coordinates.left, coordinates.left]},
				onDrop: function(dragging, droppable){
					dragging.destroy();

					var color = tr.retrieve("bgcolor");
					if (color){
						tr.tween("background", color);
					}else{
						tr.tween("background", "transparent");
					}
					//if (droppable){
					//    color = droppable.retrieve("bgcolor");
					//    if (color){
					//        droppable.tween("background", color);
					//    }else{
					//        droppable.tween("background", "transparent");
					//    }
					//}

					tr.setStyle("display", "table-row");
					if (droppable != null){
						tr.inject(dragTr, "after");
						dragTr.destroy();
						//this._loadZebraStyle();
						//this._loadSequence();
						//this._loadTotal();
						this._loadDatagridStyle();
						this.getData();
					}

				}.bind(this),
				"onEnter": function(dragging, drop){
					//var color = drop.getStyle("background");
					//if (color.toUpperCase()!='#d1eaf3') drop.store("bgcolor", color);
					//drop.tween("background-color", "#d1eaf3");
					dragNode.setStyle("display", "none");
					dragTr.inject(drop, "after");
				},
				"onLeave": function(dragging, drop){
					//var color = drop.retrieve("bgcolor");
					//if (color){
					//	drop.tween("background", color);
					//}else{
					//	drop.tween("background", "transparent");
					//}
					dragTr.inject(dragTable);
					dragNode.setStyle("display", "block");
//				tr.setStyle("display", "table-row");
				},
				"ondrag": function(){
					this.table.setStyle("cursor", "move");
					dragNode.setStyle("cursor", "move");
				},
				"onCancel": function(dragging){
					dragging.destroy();
					var color = tr.retrieve("bgcolor");
					if (color){
						tr.tween("background", color);
					}else{
						tr.tween("background", "transparent");
					}
					tr.setStyle("display", "table-row");
				}
			});
			drag.start(e);
			tr.setStyle("display", "none");
		},
		_loadReadDatagrid: function(callback){
			var p = o2.promiseAll(this.gridData).then(function(v){
				this.gridData = v;
				if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
				this.__loadReadDatagrid(callback);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));

			// if (this.gridData && this.gridData.isAG){
			// 	this.moduleValueAG = this.gridData;
			// 	this.gridData.addResolve(function(v){
			// 		this.gridData = v;
			// 		this._loadReadDatagrid(callback);
			// 	}.bind(this));
			// }else{
			// 	if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
			// 	this.__loadReadDatagrid(callback);
			// 	this.moduleValueAG = null;
			// }
		},

		__loadReadDatagrid: function(callback){
			//this.gridData = this._getValue();
			if (!this.titleTr) this._getDatagridTitleTr();
			//var titleTr = this.table.getElement("tr");
			var titleHeaders = this.titleTr.getElements("th");

			var lastTrs = this.table.getElements("tr");
			var lastTr = lastTrs[lastTrs.length-1];
			//var tds = lastTr.getElements("td");

			if (this.gridData.data){
				this.gridData.data.each(function(data, idx){
					var tr = this.table.insertRow(idx+1);
					tr.store("data", data);

					titleHeaders.each(function(th, index){
						var cell = tr.insertCell(index);
						// cell.set("MWFId", tds[index].get("id"));
						var cellData = data[th.get("id")];

						var module = this.editModules[index];
						if( typeOf( cellData ) !== "array" ){
							if (cellData) {
								for (key in cellData) {
									var v = cellData[key];
									if (module && module.json.type == "ImageClipper") {
										this._createImage(cell, module, v);
									} else if (module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg")) {
										this._createAttachment(cell, module, v);
									} else {
										var text = this._getValueText(index, v);
										if (module && module.json.type == "Textarea") {
											cell.set("html", text);
										} else {
											cell.set("text", text);
										}
									}
									break;
								}
							}else if( module && module.json.type == "Image" ) {
								this._createImg(cell, module, idx);
							}else if( module && module.json.type == "Button" ) {
								this._createButton(cell, module, idx);
							}else if( module && module.json.type == "Label" ) {
								this._createLabel(cell, module, idx);
							}else if( module && module.json.type == "sequence" ){ //Sequence
								cell.setStyle("text-align", "center");
								cell.set("text", tr.rowIndex);
							}
						}


						var json = this.form._getDomjson(th);
						if( json && json.isShow === false )cell.hide();
					}.bind(this));
				}.bind(this));
			}
			this._loadTotal();

			if (callback) callback();
		},

		_loadImportExportAction: function(){
			this.impexpNode = this.node.getElement("div.impexpNode");
			if( this.impexpNode )this.impexpNode.destroy();
			this.impexpNode = null;

			if( !this.exportenable && !this.importenable )return;

			var position = ["leftTop","centerTop","rightTop"].contains( this.json.impexpPosition || "" ) ? "top" : "bottom";
			var container = new Element("div").inject(this.node, position);

			this.importExportAreaNode = new Element("div").inject( container );
			if( ["leftTop","leftBottom"].contains( this.json.impexpPosition || "" ) ){
				this.importExportAreaNode.setStyles({ "float" : "left" })
			}else if( ["rightTop","rightBottom"].contains( this.json.impexpPosition || "" ) ){
				this.importExportAreaNode.setStyles({ "float" : "right" })
			}else{
				this.importExportAreaNode.setStyles({ "margin" : "0px auto" })
			}

			if( this.exportenable ){
				this.exportActionNode = new Element("div", {
					text : this.json.exportActionText || MWF.xApplication.process.Xform.LP.datagridExport
				}).inject(this.importExportAreaNode);
				var styles;
				if( this.json.exportActionStyles ){
					styles = this.json.exportActionStyles
				}else{
					styles = this.form.css.gridExportActionStyles;
				}
				this.exportActionNode.setStyles(styles);

				this.exportActionNode.addEvent("click", function () {
					this.exportToExcel();
				}.bind(this))
			}

			if( this.importenable ){
				this.importActionNode = new Element("div", {
					text : this.json.importActionText || MWF.xApplication.process.Xform.LP.datagridImport
				}).inject(this.importExportAreaNode);
				var styles;
				if( this.json.importActionStyles ){
					styles = this.json.importActionStyles;
				}else{
					styles = this.form.css.gridImportActionStyles;
				}
				this.importActionNode.setStyles(styles);

				this.importActionNode.addEvent("click", function () {
					this.importFromExcel();
				}.bind(this))
			}

			if( ["centerTop","centerBottom"].contains( this.json.impexpPosition ) ){
				var width = 2;

				if( this.exportActionNode ){
					width = width + this.exportActionNode.getSize().x +
						this.exportActionNode.getStyle("padding-left").toFloat() +
						+ this.exportActionNode.getStyle("padding-right").toFloat() +
						+ this.exportActionNode.getStyle("margin-left").toFloat() +
						+ this.exportActionNode.getStyle("margin-right").toFloat()
				}

				if( this.importActionNode ){
					width = width + this.importActionNode.getSize().x +
						this.importActionNode.getStyle("padding-left").toFloat() +
						+ this.importActionNode.getStyle("padding-right").toFloat() +
						+ this.importActionNode.getStyle("margin-left").toFloat() +
						+ this.importActionNode.getStyle("margin-right").toFloat()
				}

				this.importExportAreaNode.setStyle( "width", width+"px" );
			}
		},

		_loadDatagridStyle: function(){
			//var ths = this.titleTr.getElements("th");
			//ths.setStyles(this.form.css.datagridTitle);
			this.loadGridTitleStyle();
			this.loadGridContentStyle();
			this.loadGridActionStyle();
			this.loadGridEditStyle();

			this._loadTotal();
			this._loadBorderStyle();
			this._loadZebraStyle();
			this._loadSequence();
		},
		loadGridEditStyle: function(){
			if (this.editorTr){
				if (this.json.editStyles){
					var tds = this.editorTr.getElements("td");
					tds.setStyles(this.json.editStyles);
				}
			}
		},
		loadGridActionStyle: function(){
			if (this.editable!=false){
				if (this.json.actionStyles){
					var trs = this.table.getElements("tr");
					trs.each(function(tr, idx){
						if (idx != 0) tr.getFirst().setStyles(this.json.actionStyles);
					}.bind(this));
				}
			}
		},
		loadGridTitleStyle: function(){
			if (this.json.titleStyles){
				var ths = this.titleTr.getElements("th");
				ths.setStyles(this.json.titleStyles);
			}
		},
		loadGridContentStyle: function(){
			if (this.json.contentStyles){
				var tds = this.table.getElements("td");
				tds.setStyles(this.json.contentStyles);
			}
		},

		_loadZebraStyle: function(){
			var trs = this.table.getElements("tr");
			for (var i=1; i<trs.length; i++){
				if (!trs[i].hasClass("datagridTotalTr")){
					if (this.json.backgroundColor) trs[i].setStyle("background-color", this.json.backgroundColor);
					if ((i%2)==0){
						if (this.json.zebraColor) trs[i].setStyle("background-color", this.json.zebraColor);
					}
				}
			}
		},
		createTotalTr: function(){
			var trs = this.node.getElements("tr");
			var lastTr = trs[trs.length-1];
			this.totalTr = new Element("tr.datagridTotalTr", {"styles": this.form.css.datagridTotalTr}).inject(lastTr, "after");
			var ths = this.node.getElements("th");
			ths.each(function(th, idx){
				var td = new Element("td", {"text": "", "styles": this.form.css.datagridTotalTd}).inject(this.totalTr);
				if (this.json.amountStyles) td.setStyles(this.json.amountStyles);

				var json = this.form._getDomjson(th);
				if( json && json.isShow === false )td.hide();
			}.bind(this));
		},
		_loadTotal: function(){
			var data = {};
			this.totalResaults = {};
			if (this.totalModules.length){
				if (!this.totalTr){
					this.createTotalTr();
				}

				var totalResaults = [];
				//this.totalModules.each(function(m. i){
				//    totalResaults.push(0);
				//}.bind(this));

				var trs = this.table.getElements("tr");
				var totalTds = this.totalTr.getElements("td");

				for (var i=1; i<trs.length; i++){
					if (!trs[i].hasClass("datagridTotalTr") && (!trs[i].hasClass("datagridEditorTr"))){
						var cells = trs[i].getElements("td");

						this.totalModules.each(function(m, i){
							if (!totalResaults[i]) totalResaults.push(0);
							var tmpV = new Decimal(totalResaults[i]);
							if (m.type=="number"){
								var cell = cells[m.index];
								var addv = ( cell.get("text") || "0" ).toFloat();
								tmpV = tmpV.plus(addv||0);
								//tmpV = tmpV + addv;
							}
							if (m.type=="count"){
								tmpV = tmpV.plus(1);
								//tmpV = tmpV+1;
							}
							totalResaults[i] = tmpV.toString();
							data[m.module.json.id] = totalResaults[i];

						}.bind(this));
					}
				}

				this.totalModules.each(function(m, i){
					this.totalResaults[m.module.json.id] = totalResaults[i];
					var td = totalTds[m.index];
					td.set("text", isNaN( totalResaults[i] ) ? "" : totalResaults[i] );
				}.bind(this));
			}
			return data;
		},
		_loadSequence: function(){
			var trs = this.table.getElements("tr");
			for (var i=1; i<trs.length; i++){
				var cells = trs[i].getElements("td");
				cells.each(function(cell){
					var module = cell.retrieve("module");
					if (module){
						if (module.json.cellType=="sequence"){
							cell.set("text", i)
						}
					}
				}.bind(this));
			}
		},

		_loadBorderStyle: function(){
			if (this.json.border){
				this.table.setStyles({
					"border-top": this.json.border,
					"border-left": this.json.border
				});
				var ths = this.table.getElements("th");
				ths.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border
				});
				var tds = this.table.getElements("td");
				tds.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border,
					"background": "transparent"
				});
			}
		},
		_loadDatagridTitleModules: function(){
			var ths = this.node.getElements("th");
			ths.each(function(th){
				var json = this.form._getDomjson(th);
				th.store("dataGrid", this);
				if (json){
					var module = this.form._loadModule(json, th);
					this.form.modules.push(module);
					if( json.isShow === false )th.hide();
				}
			}.bind(this));
		},
		_loadDatagridDataModules: function(){
			var tds = this.node.getElements("td");
			tds.each(function(td){
				var json = this.form._getDomjson(td);
				td.store("dataGrid", this);
				if (json){
					var isField = false;
					var module = this.form._loadModule(json, td, function(){
						isField = this.field;
						this.field = false;
					});
					if( isField ){
						module.node.setStyle("padding-right","0px");
					}
					td.store("module", module);
					this.form.modules.push(module);
					if( json.isShow === false )td.hide();
				}
			}.bind(this));
		},
		_afterLoaded: function(){
			if (this.moduleValueAG){
				this.moduleValueAG.then(function(){
					this._loadDatagridStyle();
				}.bind(this));
			}else{
				this._loadDatagridStyle();
			}
		},
		// /**
		//  * @summary 重置数据网格的值为默认值或置空。
		//  *  @example
		//  * this.form.get('fieldId').resetData();
		//  */
		resetData: function(){
			this.setData(this._getValue());
		},
		/**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
		 * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
		 * @summary 为数据网格赋值。
		 * @param data{DatagridData|Promise|Array} 必选，数组或Promise.
		 * @example
		 *  this.form.get("fieldId").setData([]); //赋空值
		 * @example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      this.form.get('fieldId').setData( data );
		 *  }else{
		 *      this.data['fieldId'] = data;
		 *  }
		 *@example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 */
		setData: function(data){
			if (!data){
				data = this._getValue();
			}
			this._setData(data);
		},
		_setData: function(data){
			var p = o2.promiseAll(this.data).then(function(v){
				this.gridData = v;
				if (o2.typeOf(data)=="array") data = {"data": data};
				this.__setData(data);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));

			// if (data && data.isAG){
			// 	this.moduleValueAG = data;
			// 	data.addResolve(function(v){
			// 		this._setData(v);
			// 	}.bind(this));
			// }else{
			// 	if (o2.typeOf(data)=="array") data = {"data": data};
			// 	this.__setData(data);
			// 	this.moduleValueAG = null;
			// }
		},
		__setData: function(data){
			// if( typeOf( data ) === "object" && typeOf(data.data) === "array"  ){
			this._setBusinessData(data);
			this.gridData = data;

			// if (this.isEdit) this._completeLineEdit();
			if( this.isEdit ){ //如果有在编辑的，取消编辑行
				if (this.currentEditLine) {
					this.currentEditLine.setStyle("display", "table-row");
				}
				this.isEdit = false;
				this.currentEditLine = null;
				this._editorTrGoBack();
			}

			if (this.gridData){
				var trs = this.table.getElements("tr");
				for (var i=1; i<trs.length-1; i++){
					var tr = trs[i];
					if( tr.hasClass("datagridEditorTr") )continue;
					var tds = tr.getElements("td");
					for (var j=0; j<tds.length; j++){
						var td = tds[j];
						var module = td.retrieve("module");
						if (module){
							this.form.modules.erase(module);
							module = null;
						}
					}
				}
				for (var i=1; i<trs.length-1; i++){
					if( trs[i].hasClass("datagridTotalTr") )continue;
					if( trs[i].hasClass("datagridEditorTr") )continue;
					trs[i].destroy();
				}
				//while (this.table.rows.length>2){
				//this.table.rows[1].destroy();
				//}
				if (this.editable!=false){
					this._loadEditDatagrid();
					//this._loadReadDatagrid();
				}else{
					this._loadReadDatagrid();
				}
				this._loadDatagridStyle();
			}
		},
		/**
		 * @summary 获取总计数据.
		 * @example
		 * var totalObject = this.form.get('fieldId').getTotal();
		 * @return {Object} 总计数据
		 */
		getTotal: function(){
			this._loadTotal();
			return this.totalResaults;
		},
		/**
		 * @summary 判断数据网格是否为空.
		 * @example
		 * if( this.form.get('fieldId').isEmpty() ){
		 *     this.form.notice('至少需要添加一条数据', 'warn');
		 * }
		 * @return {Boolean} 是否为空
		 */
		isEmpty: function(){
			var data = this.getData();
			if( !data )return true;
			if( typeOf( data ) === "object" ){
				if( typeOf( data.data ) !== "array" )return true;
				if( data.data.length === 0 )return true;
			}
			return false;
		},

		/**
		 * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
		 * 区别如下：<br/>
		 * 1、当使用Promise的时候<br/>
		 * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
		 * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
		 * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
		 * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
		 * @summary 获取数据网格数据.
		 * @example
		 * var data = this.form.get('fieldId').getData();
		 *@example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  var data;
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      data = this.form.get('fieldId').getData();
		 *  }else{
		 *      data = this.data['fieldId']; //直接从数据中获取字段值
		 *  }
		 *  @example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 * @return {DatagridData}
		 */
		getData: function(){
			if (this.editable!=false){
				if (this.isEdit) this._completeLineEdit();
				var data = [];
				var trs = this.table.getElements("tr");
				for (var i=1; i<trs.length-1; i++){
					var tr = trs[i];
					var d = tr.retrieve("data");
					if (d) data.push(d);
				}

				this.gridData = {};
				this.gridData.data = data;

				this._loadTotal();
				this.gridData.total = this.totalResaults;

				this._setBusinessData(this.gridData);

				return (this.gridData.data.length) ? this.gridData : {data:[]};
			}else{
				return this._getBusinessData();
			}
		},
		getAmount: function(){
			return this._loadTotal();
		},
		createErrorNode: function(text){
			node = new Element("div", {styles:{
                "margin-top": "0.3em"  
            }});
            var iconNode = new Element("div.ooicon-error", {
                "styles": {
                    "width": "20px",
                    "height": "1.2em",
                    "float": "left",
                    "display": "flex",
					"color": "red",
                    "align-items": "center",
                    "justify-content": "center"
                    // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                }
            }).inject(node);
            var textNode = new Element("div", {
                "styles": {
                    "height": "auto",
                    "line-height": "1.2em",
                    "margin-left": "20px",
                    "color": "red",
                    "word-break": "keep-all"
                },
                "text": text
            }).inject(node);
			return node;
		},
		notValidationMode: function(text){
			if (!this.isNotValidationMode){
				this.isNotValidationMode = true;
				this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
				this.node.setStyle("border", "1px solid red");

				this.errNode = this.createErrorNode(text).inject(this.node, "after");
				this.showNotValidationMode(this.node);
			}
		},
		showNotValidationMode: function(node){
			var p = node.getParent("div");
			if (p){
				if (p.get("MWFtype") == "tab$Content"){
					if (p.getParent("div").getStyle("display")=="none"){
						var contentAreaNode = p.getParent("div").getParent("div");
						var tabAreaNode = contentAreaNode.getPrevious("div");
						var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
						var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
						tabNode.click();
						p = tabAreaNode.getParent("div");
					}
				}
				this.showNotValidationMode(p);
			}
		},
		validationMode: function(){
			if (this.isNotValidationMode){
				this.isNotValidationMode = false;
				this.node.setStyles(this.node.retrieve("borderStyle"));
				if (this.errNode){
					this.errNode.destroy();
					this.errNode = null;
				}
			}
		},

		validationConfigItem: function(routeName, data){
			var flag = (data.status=="all") ? true: (routeName == data.decision);
			if (flag){
				var n = this.getData();
				if( typeOf(n)==="object" && JSON.stringify(n) === JSON.stringify({data:[]}) )n = "";
				var v = (data.valueType=="value") ? n : n.length;
				switch (data.operateor){
					case "isnull":
						if (!v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notnull":
						if (v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "gt":
						if (v>data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "lt":
						if (v<data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "equal":
						if (v==data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "neq":
						if (v!=data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "contain":
						if (v.indexOf(data.value)!=-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notcontain":
						if (v.indexOf(data.value)==-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
				}
			}
			return true;
		},
		validationConfig: function(routeName, opinion){
			if (this.json.validationConfig){
				if (this.json.validationConfig.length){
					for (var i=0; i<this.json.validationConfig.length; i++) {
						var data = this.json.validationConfig[i];
						if (!this.validationConfigItem(routeName, data)) return false;
					}
				}
				return true;
			}
			return true;
		},
		validation: function(routeName, opinion){
			if (this.isEdit){
				if (!this.editValidation()){
					return false;
				}
			}
			if (!this.validationConfig(routeName, opinion))  return false;

			if (!this.json.validation) return true;
			if (!this.json.validation.code) return true;

			this.currentRouteName = routeName;
			var flag = this.form.Macro.exec(this.json.validation.code, this);
			this.currentRouteName = "";

			if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
			if (flag.toString()!="true"){
				this.notValidationMode(flag);
				return false;
			}
			return true;
		},
		getAttachmentRandomSite: function(){
			var i = (new Date()).getTime();
			return this.json.id+i;
		},


		isAvaliableImpExpColumn : function(thJson, module, type){
			if (thJson && ( thJson.isShow === false || thJson.isImpExp === false ))return false; //隐藏列，不允许导入导出
			if (module && (module.json.type == "sequence" || module.json.cellType == "sequence") )return false; //序号列
			if (module && ["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(module.json.type) )return false; //图片，附件,Label列不导入导出
			// if (type==="import" && module && ["Label"].contains(module.json.type))return false; //Label 不导入
			return true;
		},
		getExportColWidthArray : function(){
			var titleThs = this.titleTr.getElements("th");
			var colWidthArr = [];
			titleThs.each(function(th, index){
				if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列

				var thJson = this.form._getDomjson( th );
				var module = this.editModules[this.editable ? (index-1) : index];
				if ( this.isAvaliableImpExpColumn( thJson, module ) ) {
					if (module && ["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type)) {
						colWidthArr.push(340);
					} else if (module && module.json.type === "Address") {
						colWidthArr.push(170);
					} else if (module && module.json.type === "Textarea") {
						colWidthArr.push(260);
					} else if (module && module.json.type === "Htmleditor") {
						colWidthArr.push(500);
					} else if (module && module.json.type === "TinyMCEEditor") {
						colWidthArr.push(500);
					} else if (module && module.json.type === "Calendar") {
						colWidthArr.push(150);
					} else {
						colWidthArr.push(150);
					}
				}
			}.bind(this));
			return colWidthArr;
		},
		getExportDateIndexArray : function(){
			var titleThs = this.titleTr.getElements("th");
			var dateIndexArr = []; //日期格式列下标
			var idx=0;
			titleThs.each(function(th, index){
				if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列
				var thJson = this.form._getDomjson( th );
				var module = this.editModules[this.editable ? (index-1) : index];
				if ( this.isAvaliableImpExpColumn( thJson, module ) ) {
					if (module && module.json.type === "Calendar") {
						dateIndexArr.push(idx);
					}
					idx++;
				}
			}.bind(this));
			return dateIndexArr;
		},
		getExportTitleArray : function( type ){
			var titleThs = this.titleTr.getElements("th");
			var titleArr = [];
			titleThs.each(function(th, index){
				if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列
				var thJson = this.form._getDomjson( th );
				var module = this.editModules[this.editable ? (index-1) : index];
				if ( this.isAvaliableImpExpColumn( thJson, module, type ) ) {
					titleArr.push(th.get("text"));
				}
			}.bind(this));
			return titleArr;
		},

		exportToExcel : function () {
			var titleThs = this.titleTr.getElements("th");
			// var editorTds = this.editorTr.getElements("td");

			var resultArr = [];

			var titleArr = this.getExportTitleArray();
			var colWidthArr = this.getExportColWidthArray();
			var dateIndexArr = this.getExportDateIndexArray(); //日期格式列下标

			// var idx=0;
			// titleThs.each(function(th, index){
			// 	if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列
			//
			// 	var thJson = this.form._getDomjson( th );
			// 	var module = this.editModules[this.editable ? (index-1) : index];
			// 	if ( this.isAvaliableImpExpColumn( thJson, module ) ) {
			// 		if (module && ["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type)) {
			// 			colWidthArr.push(340);
			// 		} else if (module && module.json.type === "Address") {
			// 			colWidthArr.push(170);
			// 		} else if (module && module.json.type === "Textarea") {
			// 			colWidthArr.push(260);
			// 		} else if (module && module.json.type === "Htmleditor") {
			// 			colWidthArr.push(500);
			// 		} else if (module && module.json.type === "Calendar") {
			// 			colWidthArr.push(150);
			// 			dateIndexArr.push(idx);
			// 		} else {
			// 			colWidthArr.push(150);
			// 		}
			// 		idx++;
			// 		titleArr.push(th.get("text"));
			// 	}
			// }.bind(this));

			resultArr.push( titleArr );

			if (this.gridData.data){
				this.gridData.data.each(function(data, idx){
					var array = [];

					titleThs.each(function(th, index){
						if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列

						var module = this.editModules[ this.editable ? (index-1) : index];
						var thJson = this.form._getDomjson( th );

						if ( this.isAvaliableImpExpColumn( thJson, module ) ) {

							var cellData = data[th.get("id")];
							var text = "";

							if( cellData ) {
								if (typeOf(cellData) !== "array") { //序号
									for (key in cellData) {
										var value = cellData[key];
										if (module && ["Org", "Reader", "Author", "Personfield", "Orgfield"].contains(module.json.type)) {
											if (typeOf(value) === "array") {
												var textArray = [];
												value.each(function (item) {
													if (typeOf(item) === "object") {
														textArray.push(item.distinguishedName);
													} else {
														textArray.push(item);
													}
												}.bind(this));
												text = textArray.join(", \n");
											} else if (typeOf(value) === "object") {
												text = value.distinguishedName;
											} else {
												text = value;
											}
										} else if (module && module.json.type === "Textarea") {
											text = value;
										} else {
											text = this._getValueText(this.editable ? (index - 1) : index, value);
										}
										break;
									}
								}
							} else if (module && module.json.type === "Label" && module.node) {
								text = module.node.get("text");
							}

							if( !text && typeOf(text) !== "number" ){
								text = "";
							}

							array.push( text );
						}


					}.bind(this));

					resultArr.push( array );

				}.bind(this));
			}

			var title;
			if( this.json.excelName && this.json.excelName.code ){
				title = this.form.Macro.exec(this.json.excelName.code, this);
			}else{
				title = MWF.xApplication.process.Xform.LP.exportDefaultName;
			}
			var titleA = title.split(".");
			if( ["xls","xlst"].contains( titleA[titleA.length-1].toLowerCase() ) ){
				titleA.splice( titleA.length-1 );
			}
			title = titleA.join(".");

			var arg = { data : resultArr, colWidthArray : colWidthArr, title : title };
			this.fireEvent("export", [arg]);

			new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel( resultArr, arg.title || title, colWidthArr, dateIndexArr );
		},
		importFromExcel : function () {
			var columnList = [];

			var dateColArray = []; //日期列
			var titleThs = this.titleTr.getElements("th");

			var idx = 1;
			var orgTitleList = [];
			titleThs.each(function(th, index){
				if (this.editable && (index===0 || index === titleThs.length-1 ))return; //第一列操作列和最后一列排序列
				var module = this.editModules[this.editable ? (index-1) : index];
				var thJson = this.form._getDomjson( th );
				if ( this.isAvaliableImpExpColumn( thJson, module, "import" )){
					columnList.push({
						text : th.get("text").trim(),
						index: idx,
						thJson: thJson,
						module: module
					});
					idx++;
					if (module && module.json.type === "Calendar"){
						dateColArray.push(idx);
					}else if( module && ["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type) ){
						orgTitleList.push(th.get("text"));
					}
				}
			}.bind(this));


			new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).upload( dateColArray, function (importedData) {

				var checkAndImport = function () {
					if( !this.checkImportedData( columnList, importedData ) ){
						this.openImportedErrorDlg( columnList, importedData );
					}else{
						this.setImportData( columnList, importedData )
					}
				}.bind(this);

				if( orgTitleList.length > 0 ){
					this.listImportAllOrgData( orgTitleList, importedData, function () {
						checkAndImport();
					}.bind(this));
				}else{
					checkAndImport();
				}


			}.bind(this));
		},
		parseImportedData: function(columnList, importedData){
			var data = {
				"data" : []
			};

			importedData.each( function( importedLineData, lineIndex ){

				var lineData = {};

				columnList.each( function (obj, i) {
					var index = obj.index;
					var module = obj.module;
					var thJson = obj.thJson;
					var text = obj.text;

					var d = importedLineData[text] || "";

					var value;
					switch (module.json.type) {
						case "Org":
						case "Reader":
						case "Author":
						case "Personfield":
						case "Orgfield":
							if( !d ){
								value = [];
							}else{
								var arr = d.split(/\s*,\s*/g ); //空格,空格
								// if( arr.length === 0 ){
								// 	value = this.getImportOrgData( d );
								// }else{
								value = [];
								arr.each( function(d, idx){
									var obj = this.getImportOrgData( d );
									value.push( obj );
								}.bind(this));
								// }
							}
							break;
						case "Combox":
						case "Address":
							arr = d.split(/\s*,\s*/g ); //空格,空格
							value = arr; //arr.length === 1  ? arr[0] : arr;
							break;
						case "Checkbox":
							arr = d.split(/\s*,\s*/g ); //空格,空格
							var options = module.getOptionsObj();
							arr.each( function( a, i ){
								var idx = options.textList.indexOf( a );
								arr[ i ] = idx > -1 ? options.valueList[ idx ] : "";
							});
							value = arr.length === 1  ? arr[0] : arr;
							break;
						case "Radio":
						case "Select":
							value = d.replace(/&#10;/g,""); //换行符&#10;
							var options = module.getOptionsObj();
							var idx = options.textList.indexOf( value );
							value = idx > -1 ? options.valueList[ idx ] : "";
							break;
						case "Textarea":
							value = d.replace(/&#10;/g,"\n"); //换行符&#10;
							break;
						case "Calendar":
							value = d.replace(/&#10;/g,""); //换行符&#10;
							if( value ){
								var format;
								if (!module.json.format){
									if (module.json.selectType==="datetime" || module.json.selectType==="time"){
										format = (module.json.selectType === "time") ? "%H:%M" : (Locale.get("Date").shortDate + " " + "%H:%M")
									}else{
										format = Locale.get("Date").shortDate;
									}
								}else{
									format = module.json.format;
								}
								value = Date.parse( value ).format( format );
							}
							break;
						default:
							value = d.replace(/&#10;/g,""); //换行符&#10;
							break;
					}

					lineData[ thJson.id ] = {};
					lineData[ thJson.id ][ module.json.id ] = value;

				}.bind(this));

				data.data.push( lineData );
			}.bind(this));
			return data;
		},
		setImportData: function(columnList, importedData){

			var data = this.parseImportedData( columnList, importedData );

			this.fireEvent("import", [data] );

			this.setData( data );
			this.form.notice( MWF.xApplication.process.Xform.LP.importSuccess );

		},
		openImportedErrorDlg : function( columnList, tableData ){
			var _self = this;

			var objectToString = function (obj, type) {
				if(!obj)return "";
				var arr = [];
				Object.each(obj,  function (value, key) {
					if( type === "style" ){
						arr.push( key + ":"+ value +";" )
					}else{
						arr.push( key + "='"+ value +"'" )
					}
				})
				return arr.join( " " )
			}

			var htmlArray = ["<table "+ objectToString( this.json.properties ) +" style='"+objectToString( this.json.tableStyles, "style" )+"'>"];

			var titleStyle = objectToString( this.json.titleStyles, "style" );
			htmlArray.push( "<tr>" );
			columnList.each( function (obj, i) {
				htmlArray.push( "<th style='"+titleStyle+"'>"+obj.text+"</th>" );
			});
			htmlArray.push( "<th style='"+titleStyle+"'> "+MWF.xApplication.process.Xform.LP.validationInfor +"</th>" );
			htmlArray.push( "</tr>" );

			var contentStyles = Object.clone( this.json.contentStyles );
			if( !contentStyles[ "border-bottom" ] && !contentStyles[ "border" ] )contentStyles[ "border-bottom" ] = "1px solid #eee";
			var contentStyle = objectToString( Object.merge( contentStyles, {"text-align":"left"}) , "style" );

			tableData.each( function( lineData, lineIndex ){

				htmlArray.push( "<tr>" );
				columnList.each( function (obj, i) {
					htmlArray.push( "<td style='"+contentStyle+"'>"+ ( lineData[ obj.text ] || '' ).replace(/&#10;/g,"<br/>") +"</td>" ); //换行符&#10;
				});
				htmlArray.push( "<td style='"+contentStyle+"'>"+( lineData.errorTextList ? lineData.errorTextList.join("<br/>") : "" )+"</td>" );
				htmlArray.push( "</tr>" );

			}.bind(this));
			htmlArray.push( "</table>" );

			var div = new Element("div", { style : "padding:10px;", html : htmlArray.join("") });
			var dlg = o2.DL.open({
				"style" : this.form.json.dialogStyle || "user",
				"title": MWF.xApplication.process.Xform.LP.importFail,
				"content": div,
				"offset": {"y": 0},
				"isMax": true,
				"width": 1000,
				"height": 700,
				"buttonList": [
					{
						"type": "exportWithError",
						"text": MWF.xApplication.process.Xform.LP.datagridExport,
						"action": function () { _self.exportWithImportDataToExcel(columnList, tableData); }
					},
					{
						"type": "cancel",
						"text": MWF.LP.process.button.cancel,
						"action": function () { dlg.close(); }
					}
				],
				"onPostClose": function(){
					dlg = null;
				}.bind(this)
			});

		},
		exportWithImportDataToExcel : function ( columnList, importedData ) {
			var titleThs = this.titleTr.getElements("th");
			// var editorTds = this.editorTr.getElements("td");

			var resultArr = [];

			var colWidthArr = this.getExportColWidthArray();
			colWidthArr.push( 220 );

			var dateIndexArr = this.getExportDateIndexArray(); //日期格式列下标

			var titleArr = this.getExportTitleArray("import");
			titleArr.push( MWF.xApplication.process.Xform.LP.validationInfor );
			resultArr.push( titleArr );

			importedData.each( function( lineData, lineIndex ){
				var array = [];
				columnList.each( function (obj, i) {
					array.push( ( lineData[ obj.text ] || '' ).replace(/&#10;/g, "\n") );
				});
				array.push( lineData.errorTextListExcel ? lineData.errorTextListExcel.join("\n") : ""  );

				resultArr.push( array );
			}.bind(this));

			var title;
			if( this.json.excelName && this.json.excelName.code ){
				title = this.form.Macro.exec(this.json.excelName.code, this);
			}else{
				title = MWF.xApplication.process.Xform.LP.exportDefaultName;
			}
			var titleA = title.split(".");
			if( ["xls","xlst"].contains( titleA[titleA.length-1].toLowerCase() ) ){
				titleA.splice( titleA.length-1 );
			}
			title = titleA.join(".");

			var arg = { data : resultArr, colWidthArray : colWidthArr, title : title, withError : true };
			this.fireEvent("export", [arg]);

			new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel( resultArr, arg.title || title, colWidthArr, dateIndexArr );
		},
		checkImportedData : function( columnList, tableData ){
			var flag = true;

			var parsedData = this.parseImportedData(columnList, tableData);

			var lp = MWF.xApplication.process.Xform.LP;
			var columnText =  lp.importValidationColumnText;
			var columnTextExcel = lp.importValidationColumnTextExcel;
			var excelUtil = new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this);

			tableData.each( function(lineData, lineIndex){

				var parsedLineData = (parsedData && parsedData.data) ? parsedData.data[lineIndex] : {};

				var errorTextList = [];
				var errorTextListExcel = [];

				columnList.each( function (obj, i) {
					var index = obj.index;
					var module = obj.module;
					var thJson = obj.thJson;
					var text = obj.text;

					var colInfor = columnText.replace( "{n}", index );
					var colInforExcel = columnTextExcel.replace( "{n}", excelUtil.index2ColName( index-1 ) );

					var d = lineData[text] || "";

					var parsedD = "";
					var ptd = parsedLineData[thJson.id];
					if( typeOf(ptd) === "object")parsedD = ptd[module.json.id];

					if( d ){
						switch (module.json.type) {
							case "Org":
							case "Reader":
							case "Author":
							case "Personfield":
							case "Orgfield":
								var arr = d.split(/\s*,\s*/g ); //空格,空格
								arr.each( function(d, idx){
									var obj = this.getImportOrgData( d );
									if( obj.errorText ){
										errorTextList.push( colInfor + obj.errorText + lp.fullstop );
										errorTextListExcel.push( colInforExcel + obj.errorText + lp.fullstop );
									}
								}.bind(this));
								break;
							case "Number":
								if (isNaN(d)){
									errorTextList.push( colInfor + d + lp.notValidNumber + lp.fullstop );
									errorTextListExcel.push( colInforExcel + d + lp.notValidNumber + lp.fullstop );
								}
								break;
							case "Calendar":
								if( !( isNaN(d) && !isNaN(Date.parse(d) ))){
									errorTextList.push(colInfor + d + lp.notValidDate + lp.fullstop );
									errorTextListExcel.push( colInforExcel + d + lp.notValidDate + lp.fullstop );
								}
								break;
							default:
								break;
						}
					}
					if (module.json.type!="sequence" && module.setData && module.json.type!=="Address"){
						var hasError = false;
						if(["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type)){
							if(o2.typeOf(parsedD)==="array" && parsedD.length){
								hasError = parsedD.some(function (item) { return item.errorText; })
							}
						}
						if( !hasError ){
							module.setData(parsedD);
							module.validationMode();
							if (!module.validation() && module.errNode){
								errorTextList.push(colInfor + module.errNode.get("text"));
								errorTextListExcel.push( colInforExcel + module.errNode.get("text"));
								module.errNode.destroy();
							}
						}
					}
				}.bind(this));

				if(errorTextList.length>0){
					lineData.errorTextList = errorTextList;
					lineData.errorTextListExcel = errorTextListExcel;
					flag = false;
				}
			}.bind(this));

			var arg = {
				validted : flag,
				data : tableData
			};
			this.fireEvent( "validImport", [arg] );

			return arg.validted;
		},
		getImportOrgData : function( str ){
			str = str.trim();
			var flag = str.substr(str.length-2, 2);
			switch (flag.toLowerCase()){
				case "@i":
					return this.identityMapImported[str] || {"errorText": str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				case "@p":
					return this.personMapImported[str] || {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				case "@u":
					return this.unitMapImported[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				case "@g":
					return this.groupMapImported[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				default:
					return this.identityMapImported[str] ||
						this.personMapImported[str] ||
						this.unitMapImported[str] ||
						this.groupMapImported[str] ||
						{"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };

			}
		},
		listImportAllOrgData : function (orgTitleList, tableData, callback) {
			var identityList = [], personList = [], unitList = [], groupList = [];
			if( orgTitleList.length > 0 ){
				tableData.each( function( lineData, lineIndex ){
					// if( lineIndex === 0 )return;

					orgTitleList.each( function (title, index) {

						if( !lineData[title] )return;

						var arr = lineData[title].split(/\s*,\s*/g );
						arr.each( function( a ){
							a = a.trim();
							var flag = a.substr(a.length-2, 2);
							switch (flag.toLowerCase()){
								case "@i":
									identityList.push( a ); break;
								case "@p":
									personList.push( a ); break;
								case "@u":
									unitList.push( a ); break;
								case "@g":
									groupList.push( a ); break;
								default:
									identityList.push( a );
									personList.push( a );
									unitList.push( a );
									groupList.push( a );
									break;
							}
						})
					})
				});
				var identityLoaded, personLoaded, unitLoaded, groupLoaded;
				var check = function () {
					if( identityLoaded && personLoaded && unitLoaded && groupLoaded ){
						if(callback)callback();
					}
				};

				this.identityMapImported = {};
				if( identityList.length ){
					o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({ identityList : identityList }, function (json) {
						json.data.each( function (d) { this.identityMapImported[ d.matchKey ] = d; }.bind(this));
						identityLoaded = true;
						check();
					}.bind(this))
				}else{
					identityLoaded = true;
					check();
				}

				this.personMapImported = {};
				if( personList.length ){
					o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({ personList : personList }, function (json) {
						json.data.each( function (d) { this.personMapImported[ d.matchKey ] = d; }.bind(this));
						personLoaded = true;
						check();
					}.bind(this))
				}else{
					personLoaded = true;
					check();
				}

				this.unitMapImported = {};
				if( unitList.length ){
					o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({ unitList : unitList }, function (json) {
						json.data.each( function (d) { this.unitMapImported[ d.matchKey ] = d; }.bind(this));
						unitLoaded = true;
						check();
					}.bind(this))
				}else{
					unitLoaded = true;
					check();
				}

				this.groupMapImported = {};
				if( groupList.length ){
					o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({ groupList : groupList }, function (json) {
						json.data.each( function (d) { this.groupMapImported[ d.matchKey ] = d; }.bind(this));
						groupLoaded = true;
						check();
					}.bind(this))
				}else{
					groupLoaded = true;
					check();
				}
			}
		}

	});

MWF.xApplication.process.Xform.DatagridPC$Title =  new Class({
	Extends: MWF.APP$Module,
	_afterLoaded: function(){
		this.dataGrid = this.node.retrieve("dataGrid");
		if ((this.json.total == "number") || (this.json.total == "count")){
			this.dataGrid.totalModules.push({
				"module": this,
				"index": (this.dataGrid.editable!=false) ? this.node.cellIndex+1 : this.node.cellIndex,
				"type": this.json.total
			})
		}
		//	this.form._loadModules(this.node);
	}
});
MWF.xApplication.process.Xform.DatagridPC$Data =  new Class({
	Extends: MWF.APP$Module,
	_afterLoaded: function(){
		//this.form._loadModules(this.node);
		this.dataGrid = this.node.retrieve("dataGrid");

		var td = this.node;

		if (this.json.cellType == "sequence"){
			var flag = true;
			for (var i=0; i<this.dataGrid.editModules.length; i++){
				if (this.dataGrid.editModules[i].json.id == this.json.id){
					flag = false;
					break;
				}
			}
			if (flag){
				this.dataGrid.editModules.push({
					"json": {"type": "sequence", "id": this.json.id},
					"node": td  ,
					"focus": function(){}
				});
			}
		}else{
			var moduleNodes = this.form._getModuleNodes(this.node);
			moduleNodes.each(function(node){
				var json = this.form._getDomjson(node);
				if( json ){
					var isField = false;
					if (json.type=="Attachment" || json.type=="AttachmentDg" ){
						json.type = "AttachmentDg";
						//json.site = this.dataGrid.getAttachmentRandomSite();
						//json.id = json.site;
					}
					var module = this.form._loadModule(json, node, function(){
						isField = this.field;
						this.field = false;
					});
					if( isField ){
						module.node.setStyle("padding-right","0px");
					}
					module.dataModule = this;
					this.dataGrid.editModules.push(module);
				}
			}.bind(this));
		}
	}
});

MWF.xDesktop.requireApp("Template", "utils.ExcelUtils", null, false);
MWF.xApplication.process.Xform.DatagridPC.ExcelUtils = new Class({
	Extends: MWF.xApplication.Template.utils.ExcelUtils,
	initialize: function(){
		this.sheet2JsonOptions = {};
		this.pollyfill();
	}
});

/**
 * 数据表格数据结构.
 * @typedef {Array} DatatableData
 * @example
 { //数据表格数据条目
  "data": [
    {
      "org": [{
        "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
        "id": "bf007525-99a3-4178-a474-32865bdddec8",
        "name": "张三",
        "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
        "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
        "unitLevelName": "兰德纵横/市场营销部",
        "unitName": "市场营销部"
      }],
      "org_1": [{
        "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
        "id": "bf007525-99a3-4178-a474-32865bdddec8",
        "name": "张三",
        "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
        "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
        "unitLevelName": "兰德纵横/市场营销部",
        "unitName": "市场营销部"
      }, {
        "distinguishedName": "李四@bf007525-99a3-4178-a474-32865bdddec8@I",
        "id": "bf007525-99a3-4178-a474-32865bdddec8",
        "name": "李四",
        "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
        "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
        "unitLevelName": "兰德纵横/市场营销部",
        "unitName": "市场营销部"
      }],
      "number": "111",
      "textfield": "杭州",
      "attachment": [
        {
          "activityName": "拟稿",
          "extension": "jpg",
          "id": "9514758e-9e28-4bfe-87d7-824f2811f173",
 		  "businessId": "1234758e-9e28-4bfe-87d7-824f2811f173",
          "lastUpdateTime": "2020-12-09 21:48:03",
          "length": 452863.0,
          "name": "111.jpg",
          "person": "李四@lisi@P"
        }
      ]
    }
    ...
  ],
  "total": {
    "number": 222, //总计采用字段id
    "textfield": 2
  }
}
 */
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class DatatablePC 数据表格组件。表格形式的多行数据编辑组件。
 * @o2cn 数据表格PC端
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datatable = this.form.get("name"); //获取组件
 * //方法2
 * var datatable = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @since v6.2
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.DatatablePC = new Class(
	/** @lends MWF.xApplication.process.Xform.DatatablePC# */
	{
		Implements: [Events],
		Extends: MWF.APP$Module,
		isEdit: false,
		options: {
			/**
			 * 所有内容加载后执行（包括异步加载）。
			 * @event MWF.xApplication.process.Xform.DatatablePC#afterLoad
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 每初始化一个条目，但未加载的时候触发，通过this.event可以获取条目对象。
			 * @event MWF.xApplication.process.Xform.DatatablePC#beforeLoadLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 每一个条目加载后时候触发，通过this.event可以获取条目对象。
			 * @event MWF.xApplication.process.Xform.DatatablePC#afterLoadLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 数据表格改变时触发。通过this.event.lines可以获取修改的条目数组，this.event.type可以获得修改的类型。<br/>
			 * <table>
			 *     <tr><th><b>this.event.type</b></th><th><b>触发类型</b></th><th><b>this.event.lines</b></th></tr>
			 *     <tr><td>addline</td><td>添加一行</td><td>添加的行数组</td></tr>
			 *     <tr><td>deleteline</td><td>删除一行</td><td>删除的行数组</td></tr>
			 *     <tr><td>editcomplete</td><td>某行完成编辑（点击当前编辑行前面的√执行。同时编辑多行忽略）</td><td>编辑的行数组</td></tr>
			 *     <tr><td>editmodule</td><td>字段值改变时（同时编辑多行触发此事件，每次编辑单行忽略）</td><td>this.event.lines为编辑的行数组<br/>this.event.module为修改的字段</td></tr>
			 *     <tr><td>move</td><td>通过向上箭头调整行顺序</td><td>数据表格所有行</td></tr>
			 *     <tr><td>import</td><td>导入数据后</td><td>数据表格所有行</td></tr>
			 * </table>
			 * @event MWF.xApplication.process.Xform.DatatablePC#change
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 添加条目时触发。通过this.event.line可以获取对应的条目对象，this.event.ev可以获得事件触发的Event。
			 * @event MWF.xApplication.process.Xform.DatatablePC#addLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 编辑条目时触发（同时编辑多行不触发此事件）。通过this.event可以获取对应的条目对象。
			 * @event MWF.xApplication.process.Xform.DatatablePC#editLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 完成编辑条目时触发（点击当前编辑行前面的√执行。同时编辑多行不触发此事件）。通过this.event可以获取对应的条目对象。
			 * @event MWF.xApplication.process.Xform.DatatablePC#completeLineEdit
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 取消编辑条目时触发（点击当前编辑行前面的 — 执行。同时编辑多行不触发此事件）。通过this.event可以获取对应的条目对象。
			 * @event MWF.xApplication.process.Xform.DatatablePC#cancelLineEdit
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目前触发。通过this.event可以获取对应的条目对象。
			 * @event MWF.xApplication.process.Xform.DatatablePC#deleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目后触发。
			 * @event MWF.xApplication.process.Xform.DatatablePC#afterDeleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 导出前触发。
			 * @event MWF.xApplication.process.Xform.DatatablePC#beforeExport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 导出excel的时候触发，this.event指向导出的数据，您可以通过修改this.event来修改数据。
			 * @event MWF.xApplication.process.Xform.DatatablePC#export
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *   		["姓名","性别","学历","专业","出生日期","毕业日期"], //标题
			 *  		[ "张三","男","大学本科","计算机","2001-1-2","2019-9-2" ], //第一行数据
			 *  		[ "李四","男","大学专科","数学","1998-1-2","2018-9-2" ]  //第二行数据
			 * 	], //导出的数据
			 *     colWidthArray : [100, 50, 100, 200, 150, 150], //每列宽度
			 *     title : "xxxx" //导出的excel文件标题
			 * }
			 */
			/**
			 * 在导入excel，进行数据校验后触发，this.event指向导入的数据。
			 * @event MWF.xApplication.process.Xform.DatatablePC#validImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *  	   {
			 *  	 	"姓名" : "张三",
			 *  	 	"性别" : "男",
			 *  	 	"学历" ： "大学本科",
			 *  	    "专业" : "计算机",
			 *  	    "出生日期" : "aa01-1-2",
			 *  	 	"毕业日期" : "2019-9-2",
			 *  	 	"errorTextList" : [
			 *  	 	    "第5列：aa01-1-2不是正确的日期格式。"
			 *  	 	] //校验出的错误信息，如果该行数据正确，则无该字段
			 *  	 }
			 *  	 ...
			 *     ], //导入的数据
			 *     "validted" : true  //是否校验通过，可以在本事件中修改该参数，确定是否强制导入
			 * }
			 */
			/**
			 * 导入前触发。
			 * @event MWF.xApplication.process.Xform.DatatablePC#beforeImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 在导入excel，数据校验成功将要设置回数据表格的时候触发，this.event指向整理过的导入数据，格式见{@link DatatableData}。
			 * @event MWF.xApplication.process.Xform.DatatablePC#import
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 在导入excel，数据设置回数据表格以后触发，this.event指向整理过的导入数据，格式见{@link DatatableData}。
			 * @event MWF.xApplication.process.Xform.DatatablePC#afterImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			"moduleEvents": ["queryLoad","postLoad","load", "afterLoad",
				"beforeLoadLine", "afterLoadLine", "change", "addLine", "deleteLine", "afterDeleteLine", "editLine",
				"completeLineEdit", "cancelLineEdit", "beforeExport", "export", "beforeImport", "import", "validImport", "afterImport", "validation", "validationLine"]
		},

		initialize: function(node, json, form, options){
			this.node = $(node);
			this.node.store("module", this);
			this.json = json;
			this.form = form;
			this.field = true;
			this.fieldModuleLoaded = false;
		},
		load: function(){
			this._loadModuleEvents();
            if (this.fireEvent("queryLoad")){
				this._queryLoaded();
                // if( this.isSectionMergeEdit() ){ //区段合并，删除区段值合并数据后编辑
                //     if( this.json.mergeTypeEdit === "script" ){
                //         this._loadMergeEditNodeByScript();
                //     }else{
                //         this._loadMergeEditNodeByDefault();
                //     }
                // }else{
				//     this._loadUserInterface();
			    // }
				this._loadUserInterface();
                this._loadStyles();
                this._loadDomEvents();
                //this._loadEvents();

                this._afterLoaded();
                this.fireEvent("afterLoad");
                // this.fireEvent("load");
			}
		},
		_loadMergeEditNodeByScript: function(){
			if (this.json.sectionMergeEditScript && this.json.sectionMergeEditScript.code) {
				var data = this.form.Macro.exec(this.json.sectionMergeEditScript.code, this);
				this._setBusinessData( data );
				//this._loadUserInterface();
			}
		},
		_loadMergeEditNodeByDefault: function(){
			var data = this.getSortedSectionData();
			var businessData = [];
			data.each(function(d){
				d.data = d.data || {};
				businessData = businessData.concat( d.data.data || [] );
			});
			this._setBusinessData({
				data: businessData
			});
			//this._loadUserInterface();
		},
		_loadUserInterface: function(){
			//区段合并后编辑
			if( this.isSectionMergeEdit() ){ //区段合并，删除区段值合并数据后编辑
				if( this.json.mergeTypeEdit === "script" ){
					this._loadMergeEditNodeByScript();
				}else{
					this._loadMergeEditNodeByDefault();
				}
			}

			//区段合并展现
			this.isMergeRead = this.isSectionMergeRead();

			//启用区段且显示所有区段
			this.sectionBy = this._getSectionBy();
			this.isShowAllSection = this.isAllSectionShow();

			// this.editModules = [];

			// if( !layout.mobile ){
			// 	this.node.setStyle("overflow-x", "auto");
			// 	this.node.setStyle("overflow-y", "hidden");
			// }
			this.table = this.node.getElement("table");
			this.tBody = this.table.getElement("tbody");

			this.editable = !(this.readonly || (this.json.isReadonly === true) || (this.form.json.isReadonly === true));
			if( this.isMergeRead )this.editable = false;
			if (this.editable && this.json.editableScript && this.json.editableScript.code){
				this.editable = this.form.Macro.exec(((this.json.editableScript) ? this.json.editableScript.code : ""), this);
			}

			this.deleteable = this.json.deleteable !== "no";
			this.addable = this.json.addable !== "no";
			this.sortable = this.json.sortable !== "no";

			//允许导入
			this.importenable  = this.editable && (this.json.impexpType === "impexp" || this.json.impexpType === "imp");
			//允许导出
			this.exportenable  = this.json.impexpType === "impexp" || this.json.impexpType === "exp";

			//是否多行同时编辑
			this.multiEditMode = this.json.editMode === "multi";

			//是否显示操作列
			this.isOperationRowHidden = !this.deleteable && !this.addable && this.multiEditMode;

			//是否有总计列
			this.totalFlag = false;
			this.totalColumns = [];
			this.totalNumberModuleIds = [];

			// this.hiddenColIndexList = [];

			if( this.isShowAllSection ){
				this.data = this._getAllSectionData()
			}else if( this.isMergeRead ){
				this.data = this.getSectionMergeReadData()
			}else{
				this.data = this.getValue();
				if( !this._getBusinessData() ){
					this.isNew = true;
					this._setValue(this.data);
				}
			}


			this.lineList = [];
			this.sectionlineList = [];

			this.loadDatatable();
		},
		/*
		 * @summary 重新加载数据表格。
		 * @example
		 *  this.form.get("fieldId").reload(); //重新加载
		 */
		reload: function(){
			this.reloading = true;
			this._removeEl();

			// this.editModules = [];

			//是否有总计列
			this.totalFlag = false;
			this.totalColumns = [];
			this.totalNumberModuleIds = [];

			this.checkMerge( this.getValue() );

			this.clearSubModules();

			this.lineList = [];
			this.sectionlineList = [];

			this.loadDatatable();
			this.reloading = false;
		},
		loadDatatable: function(){
			this.loading = true;
			this._loadStyles();

			this._loadTitleTr();
			this._loadTemplate();
			this._loadTotalTr();

			this.fireEvent("load");
			this._loadDatatable(function(){
				this._loadImportExportAction();
				this.fieldModuleLoaded = true;
				this.loading = false;
				this.fireEvent("postLoad");
			}.bind(this));
		},
		_removeEl: function(){
			var node;
			if( this.titleTr ){
				node = this.titleTr.getElement("th.mwf_addlineaction");
				if( node )node.destroy();
				node = this.titleTr.getElement("th.mwf_moveaction");
				if( node )node.destroy();
			}
			if( this.templateTr ){
				node = this.templateTr.getElement("td.mwf_editaction");
				if( node )node.destroy();
				node = this.templateTr.getElement("td.mwf_moveaction");
				if( node )node.destroy();
			}
			if( this.totalTr ){
				this.totalTr.destroy();
				this.totalTr = null;
			}
			if( this.exportActionNode ){
				this.exportActionNode.destroy();
				this.totalTr = null;
			}
			if( this.importActionNode ){
				this.importActionNode.destroy();
				this.totalTr = null;
			}
		},
		_loadTitleTr: function(){
			this.titleTr = this.table.getElement("tr");

			var ths = this.titleTr.getElements("th");
			if (this.json.border){
				ths.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border
				});
			}
			if (this.json.titleStyles)ths.setStyles(this.json.titleStyles);

			//datatable$Title Module
			ths.each(function(th, index){
				var json = this.form._getDomjson(th);
				th.store("dataTable", this);
				th.addClass("mwf_origional");
				if (json){
					var module = this.form._loadModule(json, th);
					this.form.modules.push(module);
					if( json.isShow === false ){
						th.hide(); //隐藏列
					}else if( this.reloading && json.isShow === true){
						th.setStyle("display", "");
					}
					if((json.total === "number") || (json.total === "count"))this.totalFlag = true;
				}
			}.bind(this));


			if(this.editable){
				var actionTh = new Element("th.mwf_addlineaction", {"styles": {"width": "46px"}}).inject(this.titleTr, "top"); //操作列
				if(this.isOperationRowHidden){
					actionTh.setStyle('display', 'none');
				}
				if(this.addable){
					var addLineAction = new Element("div.addLineAction.ooicon-create", {
						"styles": this.form.css.addLineAction,
						"events": {
							"click": function(e){
								if( this.json.addTo === "first" ){
									this._insertLineByIndex(e.target, 0);
								}else{
									this._addLine(e.target, true);
								}
							}.bind(this)
						}
					}).inject(actionTh);
				}
				var moveTh;
				if( this.sortable ){
					moveTh = new Element("th.mwf_moveaction", {"styles": this.form.css.gridMoveActionCell || {}}).inject(this.titleTr, "bottom"); //总计列
				}
				if (this.json.border){
					Array.each([actionTh,moveTh], function(th){
						if(th)th.setStyles({
							"border-bottom": this.json.border,
							"border-right": this.json.border
						})
					}.bind(this));
				}
				if (this.json.titleStyles){
					Object.each(this.json.titleStyles, function( value, key ){
						if( key && key.toLowerCase() !== "width" ){
							actionTh.setStyle(key, value);
							if(moveTh)moveTh.setStyle(key, value);
						}
					});
				}
			}
		},
		_loadTemplate: function(){
			// this.templateJson = {};

			var trs = this.table.getElements("tr");
			this.templateTr = trs[trs.length-1];

			this.templateNode = this.templateTr;

			var tds = this.templateNode.getElements("td");

			this.columnCount = tds.length;

			if (this.json.border) {
				tds.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border,
					"background": "transparent"
				});
			}
			if (this.json.contentStyles)tds.setStyles(this.json.contentStyles);

			//datatable$Data Module
			tds.each(function(td, index){
				var json = this.form._getDomjson(td);
				td.store("dataTable", this);
				td.addClass("mwf_origional");
				if (json){
					// var module = this.form._loadModule(json, td);
					// this.form.modules.push(module);
					if( json.cellType === "sequence" )td.addClass("mwf_sequence"); //序号列
					if( json.isShow === false ){
						td.hide(); //隐藏列
					}else if( this.reloading && json.isShow === true){
						td.setStyle("display", "");
					}
				}
			}.bind(this));

			if(this.editable){
				var eTd = new Element("td.mwf_editaction",{"styles": this.json.actionStyles || {}}).inject(this.templateNode, "top"); //操作列
				if(this.isOperationRowHidden){
					eTd.setStyle('display', 'none');
				}
				this.columnCount = this.columnCount+1;
				var mTd;
				if( this.sortable ){
					mTd= new Element("td.mwf_moveaction", {"styles": this.form.css.gridMoveActionCell || {}}).inject(this.templateNode, "bottom");
					this.columnCount = this.columnCount+1;
				} //排序列
				if (this.json.border){
					Array.each([eTd,mTd], function(td){
						if(td)td.setStyles({
							"border-bottom": this.json.border,
							"border-right": this.json.border,
							"background": "transparent"
						})
					}.bind(this));
				}
				if (this.json.contentStyles){

					Object.each(this.json.contentStyles, function( value, key ){
						if( key && key.toLowerCase() !== "width" ){
							eTd.setStyle(key, value);
							if(mTd)mTd.setStyle(key, value);
						}
					});

					// eTd.setStyles(this.json.contentStyles);
					// if(mTd)mTd.setStyles(this.json.contentStyles);
				}
			}

			this.templateHtml = this.templateNode.get("html");
			// var moduleNodes = this.form._getModuleNodes(this.templateNode);
			// moduleNodes.each(function (node) {
			// 	if (node.get("MWFtype") !== "form") {
			// 		var json = this.form._getDomjson(node);
			// 		this.templateJson[json.id] = json ;
			// 	}
			// }.bind(this));
			this.templateNode.hide();
		},
		_loadTotalTr: function(){
			if( !this.totalFlag )return;
			this.totalTr = new Element("tr.mwf_totaltr", {"styles": this.form.css.datagridTotalTr}).inject(this.tBody||this.table);

			if( this.isShowSectionKey() && !(this.json.totalRowBySection || [] ).contains("module")){
				this.totalTr.hide()
			}
			if( this.isShowSectionBy() && !(this.json.totalRowBy || [] ).contains("module") ){
				this.totalTr.hide()
			}

			var ths = this.titleTr.getElements("th");
			//datatable$Title Module
			ths.each(function(th, index){
				var td = new Element("td", {"html": "<span>&nbsp;</span>", "styles": this.form.css.datagridTotalTd}).inject(this.totalTr);
				if (this.json.amountStyles) td.setStyles(this.json.amountStyles);

				var json = this.form._getDomjson(th);
				if (json){
					if( json.isShow === false ){
						td.hide(); //隐藏列
					}else if( this.reloading && json.isShow === true){
						td.setStyle("display", "");
					}
					if ((json.total === "number") || (json.total === "count")){
						this.totalColumns.push({
							"th" : th,
							"td" : td,
							"index": index,
							"type": json.total
						})
					}
				}
			}.bind(this));

			var tds = this.templateTr.getElements("td");
			//datatable$Data Module
			tds.each(function(td, index){
				var json = this.form._getDomjson(td);
				if (json){
					//总计列
					var tColumn = this.totalColumns.find(function(a){ return  a.index === index });
					if(tColumn){
						var moduleNodes = this.form._getModuleNodes(td); //获取总计列内的填写组件
						if( moduleNodes.length > 0 ){
							tColumn.moduleJson = this.form._getDomjson(moduleNodes[0]);
							if(tColumn.type === "number")this.totalNumberModuleIds.push( tColumn.moduleJson.id );
						}
					}
				}
			}.bind(this));
		},
		_getTotalTr: function(){
			return this.totalTr;
		},
		_loadTotal: function(){
			var totalData = {};
			if (!this.totalFlag)return totalData;
			if (!this._getTotalTr())this._loadTotalTr();
			var data;
			if( this.isShowAllSection ){
				data = { data : [] };
				Object.each( this.getBusinessDataById(), function (d, key) {
					if( !["data","total"].contains(key) ){
						data.data = data.data.concat( d.data )
					}
				})
			}else if( this.isMergeRead ){
				data = this.data;
			}else{
				data = this.getValue();
			}
			this.totalColumns.each(function(column, index){
				var json = column.moduleJson;
				if(!json)return;

				var total = this._loadColumnTotal( column, data );
				if( typeOf(total) !== "null" )totalData[json.id] = total;
			}.bind(this));
			data.total = totalData;
			return totalData;
		},
		_loadColumnTotal: function(column, data){
			var json = column.moduleJson;
			if(!json)return;

			var pointLength = 0; //小数点后的最大数位
			var tmpV;
			if (column.type === "count"){
				tmpV = data.data.length;
			}else if(column.type === "number"){
				tmpV = new Decimal(0);
				for (var i=0; i<data.data.length; i++){
					var d = data.data[i];
					if(d[json.id]){
						var v = this.formatDecimals( json, d[json.id].toFloat() );
						tmpV = tmpV.plus(v ? v.toFloat() : 0);
						if( v.indexOf(".") > -1 ){
							pointLength = Math.max(pointLength, v.split(".")[1].length);
						}
					}
				}
			}

			if( isNaN( tmpV ) ) {
				column.td.set("text", "");
				return;
			}

			var s = tmpV.toString(), total;
			if(json.type==='OOCurrency'){
				var obj = this.formatCurrency(json, s);
				column.td.set("text", obj.text );
				total = obj.value.toString();
			}else{
				if( json.decimals && (json.decimals!=="*")){
					total = this.formatDecimals( json, s.toFloat());
				}else if( pointLength <= 0 || s === "0" ){
					total = s;
				}else if( s.indexOf(".") > -1 ){
					var length = s.split(".")[1].length;
					total = length < pointLength ? (s + "0".repeat(pointLength-length)) : s
				}else{
					total = s +"."+ "0".repeat(pointLength);
				}

				column.td.set("text", this.formatSeparate( json, total ) );
				if( json.currencySymbol ){
					new Element("span", {"text": json.currencySymbol, "style":"padding-right:5px"}).inject( column.td, "top" );
				}
			}
			return total;
		},
		formatCurrency: function( json, total ){
			var opt = {};
			if( json.preset === 'currency' ){
				opt.currency = json.currency;
				opt.prefixuse = json.prefixuse;
			}else{
				opt.prefix = json.prefix || '';
				opt.suffix = json.suffix|| '';
				opt.thousands = json.thousands || '';
				opt.decimal = json.decimal || '';
			}
			opt.precision = json.hasOwnProperty('precision') ? json.precision : 2;
			['allowblank','disablenegative', 'round'].forEach(function(key){
				if( json.hasOwnProperty(key) ){
					opt[key] = json[key];
				}
			});
			['maximum', 'minimum'].forEach(function(key){
				if( json.hasOwnProperty(key) && json[key] !== '' ){
					opt[key] = json[key];
				}
			});
			var OOCurrency = window.customElements.get('oo-currency');
			var text = OOCurrency.formatCurrency(total, opt, opt.currency || '');
			var value = OOCurrency.unformatCurrency(text, opt, opt.currency || '');
			return {text: text, value: value};
		},
		formatDecimals: function( json, v ){
			var str;
			if (json.decimals && (json.decimals!=="*")) { //小数点数位

				var decimals = json.decimals.toInt();

				var p = Math.pow(10, decimals);
				var f_x = Math.round(v * p) / p;
				str = f_x.toString();

				if (decimals > 0) {
					var pos_decimal = str.indexOf('.');
					if (pos_decimal < 0) {
						pos_decimal = str.length;
						str += '.';
					}
					var decimalStr = (str).substr(pos_decimal + 1, (str).length);
					while (decimalStr.length < decimals) {
						str += '0';
						decimalStr += 0;
					}
				}
			}
			return str || v.toString();
		},
		formatSeparate: function(json, str){
			if( typeOf( str ) === "number" )str = str.toString();
			if( json.digitsToSeparate && parseInt(json.digitsToSeparate) > 1 ){
				var digits = parseInt(json.digitsToSeparate);
				var reg = new RegExp( "(\\d{"+digits+"}\\B)" ,"g");
				var arr = str.split(".");
				var i = arr[0].split("").reverse().join("")
					.replace(reg, "$1,")
					.split("").reverse().join("");
				str = arr.length > 1 ? ( i + "." + arr[1] ) : i ;
			}
			return str;
		},
		isTotalNumberModule: function( id ){
			return this.totalNumberModuleIds.contains(id)
		},

		isShowSectionKey: function(){
			return this.json.showSectionKey && this.isMergeRead ;
		},
		isShowSectionBy: function(){
			return this.json.showSectionBy && this.isShowAllSection ;
		},
		isSectionData: function(){ //数据是否经过区段处理
			var data = this.getBusinessDataById();
			if( o2.typeOf( data ) === "object" ){
				var keys = Object.keys(data);
				for( var i=0; i<keys.length; i++ ){
					var key = keys[i];
					if( key !== "data" && key !== "total" ){
						if( o2.typeOf(data[key]) === "object" && o2.typeOf(data[key].data) === "array" ){
							return true;
						}
					}
				}
			}
			return false;
		},
		/**
		 * @summary 当数据表格设置为区段合并展现、区段合并编辑时，可以使用本方法获取所有区段数据。
		 * @return {Object} 对象.
		 * @example
		 * var data = this.form.get("fieldId").getAllSectionData();
		 * //data格式如下：
		 * {
		 *  	"3455b82a-399c-4ee4-b9b9-e70ae40fbaf1": { //区段1的key和data
		 *			"data": [
		 *				{
		 *					"good": "yf",
		 *					"number_2": 11,
		 *					"prize": 1
		 *				}
		 *			]
		 *		},
		 *  	"83de86fc-60bc-4b4c-955c-1085915865a4": { //区段2的key和data
		 *  		"data": [
		 *  			{
		 *  				"good": "yf",
		 *  				"number_2": 11,
		 *  				"prize": 10
		 *  			}
		 *  		]
		 *  	}
		 *  }
		 */
		getAllSectionData: function(){
			return this.getBusinessDataById();
		},
		_getAllSectionData: function(){
			var bData = this.getBusinessDataById();
			var flag = false;
			if( !bData ){
				flag = true;
				bData = {};
			}
			if( !bData[this.sectionBy] ){
				flag = true;
				this.isNew = true;
				bData[this.sectionBy] = this.getValue();
			}

			if( flag )this.setBusinessDataById( bData );
			this.dataWithSectionBy = this.getAllSortedSectionData();
			return flag ? this.getBusinessDataById() : bData;
		},
		getAllSortedSectionData: function(){ //获取合并排序后的数据
			var data = this.getBusinessDataById();
			var array = [];
			for( var key in data ){
				if( !["data","total"].contains(key) )array.push({
					sectionKey: key,
					key: key,
					data: data[key]
				})
			}
			if( this.json.sectionDisplaySortScript && this.json.sectionDisplaySortScript.code){
				array.sort( function(a, b){
					this.form.Macro.environment.event = {
						"a": a,
						"b": b
					};
					var flag = this.form.Macro.exec(this.json.sectionDisplaySortScript.code, this);
					this.form.Macro.environment.event = null;
					return flag;
				}.bind(this))
			}
			return array;
		},
		getSortedSectionData: function(){ //获取合并排序后的数据
			var data = this.getBusinessDataById();
			var array = [];
			for( var key in data ){
				if( !["data","total"].contains(key) )array.push({
					sectionKey: key,
					key: key,
					data: data[key]
				});
			}
			if( this.json.sectionMergeSortScript && this.json.sectionMergeSortScript.code){
				array.sort( function(a, b){
					this.form.Macro.environment.event = {
						"a": a,
						"b": b
					};
					var flag = this.form.Macro.exec(this.json.sectionMergeSortScript.code, this);
					this.form.Macro.environment.event = null;
					return flag;
				}.bind(this))
			}
			return array;
		},
		getSectionMergeReadData: function(){
			switch (this.json.mergeTypeRead) {
				case "dataScript":
					if (this.json.sectionMergeReadDataScript && this.json.sectionMergeReadDataScript.code) {
						return this.form.Macro.exec(this.json.sectionMergeReadDataScript.code, this);
					}else{
						return {"data":[]};
					}
				default:
					var sortedData = this.getSortedSectionData();
					if( this.json.showSectionKey ){
						this.dataWithSectionKey = sortedData;
					}
					var data = [];
					//把区段值放在每行的数据里
					sortedData.each(function(d){
						( d.data.data || [] ).each(function( obj ){
							if( o2.typeOf(obj) === "object" ){
								// obj.sectionKey = d.sectionKey;
								data.push( obj )
							}
						});
						// data = data.concat( d.data.data );
					});
					return { "data": data };
			}
		},

		_createLineNode: function( beforeNode ){
            var tr;
            if( beforeNode ) {
				tr = new Element("tr").inject(beforeNode, "after");
            }else if( this.totalTr ){
                tr = new Element("tr").inject(this.totalTr, "before");
            }else{
                tr = new Element("tr").inject(this.tBody || this.table);
            }
            return tr;
        },
		_checkAddAction: function(){
		},
		_loadStyles: function(){
			if (this.json.border) {
				this.table.setStyles({
					"border-top": this.json.border,
					"border-left": this.json.border
				});
			}
			if( this.json.recoveryStyles ){
				this.node.setStyles(this.json.recoveryStyles);
			}
			this.node.setStyles(this.json.styles);
			this.table.setStyles(this.json.tableStyles);
			this.table.set(this.json.properties);
		},
		getDefaultValue: function(){
			var value;
			if (this.json.defaultData && this.json.defaultData.code) value = this.form.Macro.exec(this.json.defaultData.code, this);
			if (value && !value.then) if (o2.typeOf(value)==="array") value = {"data": value || [], "total":{}};
			if(!value && this.multiEditMode){
				value = {"data": [], "total":{}};
				var count = this.json.defaultCount ? this.json.defaultCount.toInt() : 0;
				for( var i=0; i<count; i++ ){
					value.data.push({})
				}
			}
			return value;
		},
		_getValue: function(){
			if (this.moduleValueAG) return this.moduleValueAG;
			var value = this._getBusinessData();
			if (!value){
				value = this.getDefaultValue();
			}
			return value || {"data": [], "total":{}};
		},
		getValue: function(){
			if (!this.isReadable) return {"data": [], "total":{}};
			return this._getValue();
		},

		_setValue: function(value){
			if (!!value && o2.typeOf(value.then)=="function"){
				var p = o2.promiseAll(value).then(function(v){
					this.__setValue(v);
				}.bind(this), function(){});
				this.moduleValueAG = p;
				p.then(function(){
					this.moduleValueAG = null;
				}.bind(this), function(){
					this.moduleValueAG = null;
				}.bind(this));
			}else{
				this.moduleValueAG = null;
				this.__setValue(value);
			}
		},
		__setValue: function(value){
			this._setBusinessData(value);
			this.moduleValueAG = null;
			return value;
		},

		_loadDatatable: function(callback, operation){
			//operation 可能为setLineData, addLine, insertLine, deleteLines, deleteLine, moveUpList
			var p = o2.promiseAll(this.data).then(function(v){
				this.data = v;
				if( this.isShowAllSection ){
					this._loadSectionLineList_EditSection(function(){
						this._checkAddAction();
						this._loadTotal();
						if(callback)callback();
					}.bind(this), operation)
				}else if( this.isShowSectionKey() ){
					this._loadSectionLineList(function(){
						this._checkAddAction();
						this._loadTotal();
						if(callback)callback();
					}.bind(this), operation)
				}else{
					this._loadLineList(function(){
						this._checkAddAction();
						this._loadTotal();
						if(callback)callback();
                    }.bind(this), operation);
				}

				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
		},
		_loadSectionLineList_EditSection: function(callback, operation){
			var map = this.unchangedSectionLineMap || {};
			// Object.each(map, function (sline, idx) {
            //     sline.setIndex( idx.toInt(), (idx.toInt()+1).toString() );
            // });
			this.dataWithSectionBy.each(function(data, idx){
				var isEdited = false;
				if( this.isSectionLineEditable( data ) && this.editable ){
					isEdited = true;
				}
				var isNew = false;
				var sectionLine, beforeNode = idx > 0 ? this.sectionlineList[idx-1].getLastTr() : this.templateNode;
				if( map[data.sectionKey] ) {
					sectionLine =  map[data.sectionKey];
					sectionLine.setIndex( beforeNode, data, idx, isEdited, isNew, operation );
				}else{
					var node = this._createLineNode( beforeNode );
					sectionLine = this._loadSectionLine_EditSection(node, data, idx, isEdited, isNew);
				}
				if( this.sectionBy && this.sectionBy === data.sectionKey ){
					this.sectionLineEdited = sectionLine;
				}
				this.sectionlineList.push(sectionLine);
			}.bind(this))
			if (callback) callback();
		},
		_loadSectionLine_EditSection: function(container, data, index, isEdited, isNew){
			var sectionLine = new MWF.xApplication.process.Xform.DatatablePC.SectionLine(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isEditable: this.editable && this.isSectionLineEditable(data),
				isDeleteable: this.deleteable && this.isSectionLineEditable(data),
				isAddable: this.addable && this.isSectionLineEditable(data)
			});
			// this.fireEvent("beforeLoadLine", [line]);
			sectionLine.load();
			// this.fireEvent("afterLoadLine", [line]);
			return sectionLine;
		},
		isSectionLineEditable: function(data){
			return this.isShowAllSection && this.sectionBy && this.sectionBy === data.sectionKey;
		},

		_loadSectionLineList: function(callback, operation){
			var map = this.unchangedSectionLineMap || {};
			this.dataWithSectionKey.each(function(data, idx){
				var sectionLine;
				var isEdited = false;
				var isNew = false;
				var beforeNode = idx > 0 ? this.sectionlineList[idx-1].getLastTr() : this.templateNode;
				if( map[data.sectionKey] ) {
					sectionLine =  map[data.sectionKey];
					sectionLine.setIndex( beforeNode, data, idx, isEdited, isNew, operation );
				}else {
					var node = this._createLineNode( beforeNode );
					sectionLine = this._loadSectionLine(node, data, idx, isEdited, isNew);
				}
				this.sectionlineList.push(sectionLine);
			}.bind(this))
			if (callback) callback();
		},
		_loadSectionLine: function(container, data, index, isEdited, isNew){
			var sectionLine = new MWF.xApplication.process.Xform.DatatablePC.SectionLine(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isEditable: this.editable,
				isDeleteable: this.deleteable,
				isAddable: this.addable,
				isMergeRead: this.isMergeRead
			});
			// this.fireEvent("beforeLoadLine", [line]);
			sectionLine.load();
			// this.fireEvent("afterLoadLine", [line]);
			return sectionLine;
		},

		_loadLineList: function(callback, operation){
			var map = this.unchangedLineMap || {};
            Object.each(map, function (line, idx) {
                line.setIndex( idx.toInt() );
            });
            this.data.data.each(function(data, idx){
                if( !data )return;
                var idxStr = idx.toString();
                var beforeNode = idx > 0 ? this.lineList[idx - 1].node : this.templateNode;
                if( map[idxStr] ){
                	if( !operation || operation === "moveUpList" ){
						map[idxStr].node.inject( beforeNode, "after" );
					}
					this.lineList.push( map[idxStr] );
                }else{
                    var isNew = this.isNew || (o2.typeOf(this.newLineIndex) === "number" ? idx === this.newLineIndex : false);
                    var isEdited = (!this.multiEditMode && o2.typeOf(this.newLineIndex) === "number") ? idx === this.newLineIndex : this.multiEditMode;
                    var node = this._createLineNode( beforeNode );
                    var line = this._loadLine(node, data, idx, isEdited, isNew );
					if( !this.multiEditMode && isEdited ){
						this.currentEditedLine = line;
					}
                    this.lineList.push(line);
                }
            }.bind(this));
            this.isNew = false;
            this.newLineIndex = null;
            if (callback) callback();
        },
		_loadLine: function(container, data, index, isEdited, isNew){
			var line = new MWF.xApplication.process.Xform.DatatablePC.Line(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isEditable: this.editable,
				isDeleteable: this.deleteable,
				isAddable: this.addable,
				isMergeRead: this.isMergeRead
			});
			this.fireEvent("beforeLoadLine", [line]);
			line.load();
			this.fireEvent("afterLoadLine", [line]);
			return line;
		},
		isMax : function(){
			var maxCount = this.json.maxCount ? this.json.maxCount.toInt() : 0;
			if( this.editable && maxCount > 0 ) {
				if( this.isShowAllSection ){
					if( this.sectionLineEdited && this.sectionLineEdited.lineList.length >= maxCount )return true;
				}else{
					if( this.lineList.length >= maxCount )return true;
				}
			}
			return false;
		},
		isMin : function(){
			var minCount = this.json.minCount ? this.json.minCount.toInt() : 0;
			if( this.editable && minCount > 0 ) {
				if( this.isShowAllSection ){
					if( this.sectionLineEdited && this.sectionLineEdited.lineList.length <= minCount )return true;
				}else {
					if (this.lineList.length <= minCount) return true;
				}
			}
			return false;
		},
		_setLineData: function(line, d){
			if( line.sectionLine ){
				var data = this.getBusinessDataById();
				var sdata = data[ line.sectionLine.sectionKey ];
				if( sdata && sdata.data ){
					sdata.data[line.options.indexInSectionLine] = d;
					this.setAllSectionData( data, false, "setLineData" );
				}
			}else{
				var index = line.options.index;
				var data = this.getInputData();
				data.data[index] = d;
				this.setData( data, false, "setLineData" );
			}
		},
		_addLine: function(ev, edited, d){
			if( !this._completeLineEdit(ev, true) )return;
			if( this.isMax() ){
				var text = MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);
				this.form.notice(text,"info");
				return false;
			}

			var data, index, line;
			if( this.isShowAllSection ){
				data = this.getBusinessDataById();
				var sdata = data[ this.sectionBy ];
				if( !sdata ){
					sdata = data[ this.sectionBy ] = { data: [] };
				}
				index = sdata.data.length;

				// if( d && !d.sectionKey )d.sectionKey = this.sectionBy;
				// sectionKey: this.sectionBy
				sdata.data.push(d||{});
				this.newLineIndex = index;

				this.setAllSectionData( data, false, "addLine");
				line = this.sectionLineEdited.lineList[index];
				line.isNewAdd = true;
			}else{
				index = this.lineList.length;
				data = this.getInputData();

				data.data.push(d||{});
				this.newLineIndex = index;

				this.setData( data , false, "addLine");
				line = this.getLine(index);
				line.isNewAdd = true;
			}


			this.validationMode();
			this.fireEvent("addLine", [{"line":line, "ev":ev}]);

			this.fireEvent("change", [{"lines":[line], "type":"addline"}]);

			return line;
		},
		_insertLine: function(ev, beforeLine){
			if( !this._completeLineEdit(ev, true) )return;
			if( this.isMax() ){
				var text = MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);
				this.form.notice(text,"info");
				return false;
			}

			//使用数据驱动
			var data, index, line;
			if( this.isShowAllSection ){
				index = beforeLine.options.indexInSectionLine + 1;

				data = this.getBusinessDataById();
				var sdata = data[ this.sectionBy ];
				if( !sdata ){
					sdata = data[ this.sectionBy ] = { data: [] };
				}
				sdata.data.splice(index, 0, {});
				this.newLineIndex = index;

				this.setAllSectionData( data, false, "insertLine");
				line = this.sectionLineEdited.lineList[index];
				line.isNewAdd = true;
			}else {
				index = beforeLine.options.index + 1;

				data = this.getInputData();
				data.data.splice(index, 0, {});
				this.newLineIndex = index;
				this.setData(data, false, "insertLine");
				line = this.getLine(index);
				line.isNewAdd = true;
			}

			this.validationMode();
			this.fireEvent("addLine",[{"line":line, "ev":ev}]);
			this.fireEvent("change", [{"lines":[line], "type":"addline"}]);
			return line;
		},
		_insertLineByIndex: function(ev, index, d){
			if( !this._completeLineEdit(ev, true) )return;
			if( this.isMax() ){
				var text = MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);
				this.form.notice(text,"info");
				return false;
			}

			var data, line;
			if( this.isShowAllSection ){
				data = this.getBusinessDataById();
				var sdata = data[ this.sectionBy ];
				if( !sdata ){
					sdata = data[ this.sectionBy ] = { data: [] };
				}
				if (sdata.data.length < index) return null;
				sdata.data.splice(index, 0, d || {});
				this.newLineIndex = index;

				this.setAllSectionData( data , false, "insertLine" );
				line = this.sectionLineEdited.lineList[index];
				line.isNewAdd = true;
			}else {
				//使用数据驱动
				data = this.getInputData();
				if (data.data.length < index) return null;
				data.data.splice(index, 0, d || {});
				this.newLineIndex = index;
				this.setData(data, false, "insertLine");
				line = this.getLine(index);
				line.isNewAdd = true;
			}

			this.validationMode();
			this.fireEvent("addLine",[{"line":line, "ev":ev}]);
			this.fireEvent("change", [{"lines":[line], "type":"addline"}]);
			return line;
		},
		_deleteSelectedLine: function(ev){
			var selectedLine = this.lineList.filter(function (line) { return line.selected; });
			if( selectedLine.length === 0 ){
				this.form.notice( MWF.xApplication.process.Xform.LP.selectItemNotice,"info");
				return false;
			}
			var minCount = this.json.minCount ? this.json.minCount.toInt() : 0;
			if( minCount > 0 ){
				if( this.lineList.length - selectedLine.length < minCount ){
					var text = MWF.xApplication.process.Xform.LP.minItemNotice.replace("{n}", minCount );
					this.form.notice(text,"info");
					return false;
				}
			}
			var _self = this;
			this.form.confirm("warn", ev, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteSelectedItemNotice, 300, 120, function(){

				_self._delLines( selectedLine );

				this.close();

			}, function(){
				this.close();
			}, null, null, this.form.json.confirmStyle);

		},
		_delLines: function(lines){
			var _self = this;
			var saveFlag = false;

			var data;
			if( this.isShowAllSection ){
				data = this.getBusinessDataById();
			}else{
				data = _self.getInputData();
			}

			lines.reverse().each(function(line){
				_self.fireEvent("deleteLine", [line]);

				if(line.deleteAttachment())saveFlag = true;

				if( line.sectionLine ){
					var d = data[ line.sectionLine.sectionKey ];
					if( d && d.data ){
						d.data.splice(line.options.indexInSectionLine, 1);
						if(this.currentEditedLine === line)this.currentEditedLine = null;
					}
				}else {
					data.data.splice(line.options.index, 1);
					if (this.currentEditedLine === line) this.currentEditedLine = null;
				}

				_self.fireEvent("afterDeleteLine");
			});

			if( this.isShowAllSection ){
				_self.setAllSectionData(data, false, "deleteLines");
			}else{
				_self.setData( data , false, "deleteLines");
			}
			this.validationMode();

			_self.fireEvent("change", [{"lines":lines, "type":"deletelines"}]);

			if(saveFlag)this.saveFormData();
		},
		_deleteLine: function(ev, line){
			if( !this._completeLineEdit(ev, true) )return;
			if( this.isMin() ){
				var text = MWF.xApplication.process.Xform.LP.minItemCountNotice.replace("{n}", this.json.minCount );
				this.form.notice(text,"info");
				return false;
			}
			var _self = this;
			this.form.confirm("warn", ev, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteDatagridLine, 300, 120, function(){
				_self._delLine(line);
				this.close();
			}, function(){
				this.close();
			}, null, null, this.form.json.confirmStyle);
		},
		_delLine: function(line){
			this.fireEvent("deleteLine", [line]);

			var saveFlag = line.deleteAttachment();
			//使用数据驱动
			var data;
			if( line.sectionLine ){
				var data = this.getBusinessDataById();
				var d = data[ line.sectionLine.sectionKey ];
				if( d && d.data ){
					d.data.splice(line.options.indexInSectionLine, 1);
				}
				if(this.currentEditedLine === line)this.currentEditedLine = null;
				this.setAllSectionData( data, false, "deleteLine" );
			}else{
				data = this.getInputData();
				data.data.splice(line.options.index, 1);

				if(this.currentEditedLine === line)this.currentEditedLine = null;
				this.setData( data , false, "deleteLine");
			}

			this.validationMode();
			this.fireEvent("afterDeleteLine");

			this.fireEvent("change", [{"lines":[line], "type":"deleteline"}]);

			if(saveFlag)this.saveFormData();
		},
		_cancelLineEdit: function(){
			var line = this.currentEditedLine;
			if( !line )return true;
			line.validationMode();
			if( line.isNewAdd ){
				// var saveFlag = line.deleteAttachment();
				this._delLine( line );
				this.currentEditedLine = null;
				// if(saveFlag)this.form.saveFormData();
			}else{
				// line.data = Object.clone(line.getOriginalDataWithCheckAttachment());
				line.resetDataWithOriginalData();
				line.changeEditMode(false);
				this._loadTotal();
				if( line.sectionLine )line.sectionLine._loadTotal();
				if(line.attachmentChangeFlag){
					this.saveFormData();
					line.attachmentChangeFlag = false;
				}
				this.currentEditedLine = null;
				this.fireEvent("cancelLineEdit", [line]);
			}
			return true;
		},
		_completeLineEdit: function( ev, fireChange, ignoerSave ){
			var line = this.currentEditedLine;
			if( !line )return true;
			if( !line.validation() )return false;

			var originalDataStr, dataStr;
			if( fireChange ){
				if( line.originalData && o2.typeOf(line.originalData) === "object"){
					originalDataStr = JSON.stringify(line.originalData)
				}
				dataStr = JSON.stringify(line.data);
			}

			line.isNewAdd = false;
			// line.data = line.getData();
			line.computeModuleData("save");
			line.originalData = Object.clone(line.data);
			line.changeEditMode(false);
			this._loadTotal();
			if( line.sectionLine )line.sectionLine._loadTotal();
			if(line.attachmentChangeFlag && !ignoerSave){
				this.saveFormData();
				line.attachmentChangeFlag = false;
			}
			this.currentEditedLine = null;
			this.validationMode();
			this.fireEvent("completeLineEdit", [line]);
			if( fireChange && originalDataStr !== dataStr ){
				this.fireEvent("change", [{"lines":[line], "type":"editcomplete"}]);
			}
			return true;
		},
		_moveUpLine: function(ev, line){
			if( this.currentEditedLine && !this._completeLineEdit(null, true) )return false;

			var data, upData, curData;
			if( this.isShowAllSection ){
				if (line.options.indexInSectionLine === 0) return;

				data = this.getBusinessDataById();
				var sdata = data[ this.sectionBy ];
				if( !sdata )return;

				upData = sdata.data[line.options.indexInSectionLine - 1];
				curData = sdata.data[line.options.indexInSectionLine];
				sdata.data[line.options.indexInSectionLine] = upData;
				sdata.data[line.options.indexInSectionLine - 1] = curData;

				this.setAllSectionData( data, false, "moveUpList" );
			}else {
				if (line.options.index === 0) return;

				data = this.getInputData();
				upData = data.data[line.options.index - 1];
				curData = data.data[line.options.index];
				data.data[line.options.index] = upData;
				data.data[line.options.index - 1] = curData;
				this.setData(data, false, "moveUpList");
			}
			this.fireEvent("change", [{lines: this.lineList, "type":"move", line: line}]);
		},
		_changeEditedLine: function(line){
			if( this.currentEditedLine ){
				if( line ===  this.currentEditedLine )return;
				if( !this._completeLineEdit( null,true ) )return;
			}
			line.changeEditMode(true);

			/**
			 * 数据表格当前正在编辑的条目，当数据表格为“同时编辑多行”时无此属性。
			 * @member {MWF.xApplication.process.Xform.DatatablePC.Line | MWF.xApplication.process.Xform.DatatableMobile.Line | Null}
			 * @example
			 * //获取数据表格“dt1”的正在编辑的条目。
			 * var line = this.form.get("dt1").currentEditedLine;
			 * //获取数据
			 * var data = line.getData();
			 * //设置数据
			 * line.setData({"subject":"111"});
			 * //获取subject字段的值
			 * var data = line.get("subject").getData();
			 * //设置subject字段的值
			 * line.get("subject").setData("test1");
			 */
			this.currentEditedLine = line;
		},

		// editValidation: function(){
		// 	var flag = true;
		// 	this.editModules.each(function(field, key){
		// 		if (field.json.type!=="sequence" && field.validationMode ){
		// 			field.validationMode();
		// 			if (!field.validation()) flag = false;
		// 		}
		// 	}.bind(this));
		// 	return flag;
		// },


		_afterLoaded: function(){
		},
		// /**
		//  * @summary 重置数据表格的值为默认值或置空。
		//  *  @example
		//  * this.form.get('fieldId').resetData();
		//  */
		resetData: function(){
			//var value = this.getDefaultValue() || {"data": [], "total":{}};
			var value = this.getValue();
			this.setData( value , false );
		},
		/**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
		 * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
		 * @summary 为数据表格赋值，如果需要设置所有区段数据请使用setAllSectionData方法。
		 * @param data{DatatableData|Promise} 必选，数组或Promise.
		 * @param fireChange{boolean} 可选，是否触发change事件，默认false.
		 * @example
		 *  this.form.get("fieldId").setData({data:[]}); //赋空值
		 * @example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      this.form.get('fieldId').setData( data );
		 *  }else{
		 *      this.data['fieldId'] = data;
		 *  }
		 *@example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 */
		setData: function(data, fireChange, operation){
			if (!data){
				data = this._getValue();
			}else{
				//todo 计算total
			}
			this._setData(data, fireChange, operation);
		},
		_setData: function(data, fireChange, operation){
			var p = o2.promiseAll(this.data).then(function(v){
				this.data = v;
				// if (o2.typeOf(data)==="object") data = [data];
				this.__setData(data, fireChange, operation);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
		},
		__setData: function(data, fireChange, operation){
            // if( typeOf( data ) === "object" && typeOf(data.data) === "array"  ){
			if( this.isShowAllSection ){
				//兼容外部对编辑当前区段的setData，内部的setData不走这里，直接走setAllSectionData
				this._setEditedSectionData(data, fireChange, operation);
				return;
			}else if( this.isMergeRead ){
				//合并且只读，不允许setData
				throw new Error("The data table is merged and read-only, you can use the 'setAllSectionData' method to set all section data");
			}

            var old;
            if(fireChange)old = Object.clone(this._getBusinessData() || {});

			this._setUnchangedLineMap(data, operation);

            this._setBusinessData(data);

			this.data = data;

            if (this.data){
                this.clearSubModules();
            }

            this.lineList = [];
            this.sectionlineList = [];

			if( this.currentEditedLine )this.currentEditedLine = null;

            this._loadDatatable( function () {
				if (fireChange && JSON.stringify(old) !== JSON.stringify(data)) this.fireEvent("change");
				this.unchangedLineMap = null;
			}.bind(this), operation);
        },
		_setEditedSectionData: function(data, fireChange, operation){
			if( this.isShowAllSection ){
				var d = this.getBusinessDataById();
				d[ this.sectionBy ] = data || { data: [] };
				this.setAllSectionData( d, fireChange , operation);
			}
		},
		deleteAttachment: function( attId ){
			this.form.workAction.deleteAttachment(attId, this.form.businessData.work.id);
		},
		saveFormData: function(){
			this.form.saveFormData();
		},
		/**
		 * @summary 当数据表格设置为区段合并展现、区段合并编辑时，可以使用本方法设置所有区段数据。
		 * @param data{Object} 必选，对象.
		 * @param fireChange{boolean} 可选，是否触发change事件，默认false.
		 * @example
		 *  this.form.get("fieldId").setAllSectionData({}); //赋空值
		 * @example
		 *  this.data['fieldId'].setAllSectionData({
		 *  	"3455b82a-399c-4ee4-b9b9-e70ae40fbaf1": { //区段1的key和data
		 *			"data": [
		 *				{
		 *					"good": "yf",
		 *					"number_2": 11,
		 *					"prize": 1
		 *				}
		 *			]
		 *		},
		 *  	"83de86fc-60bc-4b4c-955c-1085915865a4": { //区段2的key和data
		 *  		"data": [
		 *  			{
		 *  				"good": "yf",
		 *  				"number_2": 11,
		 *  				"prize": 10
		 *  			}
		 *  		]
		 *  	}
		 *  });
		 */
		setAllSectionData: function(data, fireChange, operation){
			// if( this.isSectionMergeEdit() ){
			// 	//合并且编辑，不允许setAllSectionData
			// 	throw new Error("The data table is in merge editing state, you can use the 'setData' method to set the data");
			// }

			var old;
			if(fireChange)old = Object.clone(this.getBusinessDataById() || {});

			//删除并没有用，因为会对比数据提交，如果要清空可以给data.data = []; data.total = {}
			// if( data && data.data )delete data.data;
			// if( data && data.total )delete data.total;

			this._setUnchangedSectionLineMap(data);

			this.setBusinessDataById(data);

			if( operation ){
				this.data = this.isShowAllSection ? this._getAllSectionData() : data;
			}else{
				this.checkMerge(data);
			}

			if (this.data){
				this.clearSubModules();
			}

			if (fireChange && JSON.stringify(old) !== JSON.stringify(data)) this.fireEvent("change");

			this.lineList = [];
			this.sectionlineList = [];

			if( this.currentEditedLine )this.currentEditedLine = null;

			this._loadDatatable(function () {
				Object.each(this.unchangedSectionLineMap, function(sline, key){
					sline.isUnchangedAll = null;
					sline.unchangedLineMap = null;
				});
				this.unchangedSectionLineMap = null;
			}.bind(this), operation);
		},
		checkMerge: function(data){
			//区段合并后编辑
			var isMergeEidt = this.isSectionMergeEdit();
			if( isMergeEidt ){ //区段合并，删除区段值合并数据后编辑
				if( this.json.mergeTypeEdit === "script" ){
					this._loadMergeEditNodeByScript();
				}else{
					this._loadMergeEditNodeByDefault();
				}
			}
			//区段合并展现
			this.isMergeRead = this.isSectionMergeRead();
			//启用区段且显示所有区段
			this.sectionBy = this._getSectionBy();
			this.isShowAllSection = this.isAllSectionShow();

			if( this.isShowAllSection ){
				this.data = this._getAllSectionData();
			}else if( this.isMergeRead ) {
				this.data = this.getSectionMergeReadData();
			}else if( isMergeEidt ){
				this.data = this._getBusinessData()
			}else{
				this.data = data;
			}
		},
        _setUnchangedSectionLineMap: function( data, operation ){
			if( !data ){
				return;
			}
			var map = {};
			if( this.sectionlineList && this.sectionlineList.length ){
				this.sectionlineList.each(function (sline, i) {
					for( var key in data ){
						if( key === sline.sectionKey ){
							var m = sline._setUnchangedLineMap(data[key], operation);
							if( m )map[key] = m;
							break;
						}
					}
				}.bind(this));
			}
			this.unchangedSectionLineMap = map;
        },
		_setUnchangedLineMap: function(data, operation){
			if( !data ){
				this.unchangedLineMap = {};
				return;
			}
			var fromOutside = !operation;
			var lineDataList = this.lineList.map(function (line) {
				if( line.options.isEditable !== this.editable )return "";
				if( line.options.isDeleteable !== this.deleteable )return "";
				if( line.options.isAddable !== this.addable )return "";
				return fromOutside ?  JSON.stringify(line.data) : line.data;
			}.bind(this));

			var dStr, map = {};
			data.data.each(function (d, idx) {
				if(fromOutside)dStr = JSON.stringify(d);
				for (var i = 0; i < this.lineList.length; i++) {
					var isEqual= fromOutside ? (dStr === lineDataList[i]) : (d === lineDataList[i] );
					if ( isEqual ) {
						map[idx] = this.lineList[i];
						lineDataList[i] = "";
						break;
					}
				}
			}.bind(this));
			this.unchangedLineMap = map;
		},
        clearSubModules: function(){
            if( this.sectionlineList && this.sectionlineList.length ){
				this.sectionlineList.each(function (sline, i) {
					sline.clearSubModules();
				}.bind(this));
            }else{
				var map = this.unchangedLineMap || {};
				var lines = [];
				Object.values(map).each(function (d) {
					lines = lines.concat(d);
				});
				for (var i=0; i<this.lineList.length; i++){
					var l = this.lineList[i];
					if(!lines.contains(l))l.clearSubModules();
				}
            }
        },
		resetId: function(){
			if( this.sectionlineList && this.sectionlineList.length ){
				this.sectionlineList.each(function (sline, i) {
					sline.resetId();
				}.bind(this));
			}else{
				for (var i=0; i<this.lineList.length; i++){
					this.lineList[i].resetId();
				}
			}
		},
		/**
		 * @summary 判断数据表格是否为空.
		 * @example
		 * if( this.form.get('fieldId').isEmpty() ){
		 *     this.form.notice('至少需要添加一条数据', 'warn');
		 * }
		 * @return {Boolean} 是否为空
		 */
		isEmpty: function(){
			var data = this.getInputData();
			if( !data || !data.data )return true;
			if( o2.typeOf( data.data ) === "array" ){
				return data.data.length === 0;
			}
			//????
			// if( o2.typeOf( data ) === "object" ){
			// 	return Object.keys(data).length === 0;
			// }
			return false;
		},
		//api 相关开始
		/**
		 * 获取对应的条目。
		 * @param {Number} index 条目序号，从零开始
		 * @return {MWF.xApplication.process.Xform.DatatablePC.Line | Null} 对应的数据表格条目
		 * @example
		 * //获取数据表格“dt1”的第一个条目。
		 * var line = this.form.get("dt1").getLine(0);
		 * //获取第一行的数据
		 * var data = line.getData();
		 * //设置第一行的数据
		 * line.setData({"subject":"111"});
		 * //获取第一个条目subject字段的值
		 * var data = line.get("subject").getData();
		 * //设置subject字段的值
		 * line.get("subject").setData("test1");
		 */
		getLine: function(index){
			var line = this.lineList[index];
			return line || null;
		},
		/**
		 * 在数据表格末尾添加条目。
		 * @param {Object} [data] 添加条目的数据。
		 * @return {MWF.xApplication.process.Xform.DatatablePC.Line} 添加的数据表格条目
		 * @example
		 * var line = this.form.get("dt1").addLine();
		 */
		addLine: function( data ){
			return this._addLine( null, null,  data );
		},
		/**
		 * 在数据表格指定位置添加条目。
		 * @param {Number} index 条目序号，从零开始，如果下标超过当前数据表格条目数，插入失败并返回null。
		 * @param {Object} [data] 添加条目的数据。
		 * @return {MWF.xApplication.process.Xform.DatatablePC.Line | Null} 插入的数据表格条目
		 * @example
		 * var line = this.form.get("dt1").insertLine(0);
		 */
		insertLine: function(index, data){
			return this._insertLineByIndex(null,  index, data);
		},
		/**
		 * 删除指定位置的条目。
		 * @param {Number} index 条目序号，从零开始，如果下标超过当前数据表格条目数，删除失败。
		 * @example
		 * //直接删除第一个条目
		 * this.form.get("dt1").deleteLine(0);
		 */
		deleteLine: function(index, ev){
			var line = this.lineList[index];
			if( !line )return null;
			// if( ev ){
			// 	this._deleteLine(ev, line);
			// }else{
			this._delLine(line);
			// }
		},
		/**
		 * 获取对应表单组件，作用等同于get。
		 * @param {Number} index 条目序号，从零开始
		 * @param {String} id 组件标识
		 * @return {FormComponent} 对应表单组件
		 * @example
		 * //获取数据表格“dt1”的第一个条目的subject字段。
		 * var module = this.form.get("dt1").getModule(0, "subject");
		 * //获取subject字段的值
		 * var data = module.getData();
		 * //设置subject字段的值
		 * module.setData("test1");
		 */
		getModule: function(index, id){
			var line = this.lineList[index];
			if( !line )return null;
			return line.getModule(id);
		},
		/**
		 * 获取对应表单组件，作用等同于getModule。
		 * @param {Number} index 条目序号，从零开始
		 * @param {String} id 组件标识
		 * @return {FormComponent} 对应表单组件
		 * @example
		 * //获取数据表格“dt1”的第一个条目的subject字段。
		 * var module = this.form.get("dt1").get(0, "subject");
		 * //获取subject字段的值
		 * var data = module.getData();
		 * //设置subject字段的值
		 * module.setData("test1");
		 */
		get: function(index, id){
			return this.getModule(index, id);
		},
		//api 相关

		/**
		 * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
		 * 区别如下：<br/>
		 * 1、当使用Promise的时候<br/>
		 * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
		 * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
		 * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
		 * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
		 * @summary 获取数据表格数据.
		 * @example
		 * var data = this.form.get('fieldId').getData();
		 *@example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  var data;
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      data = this.form.get('fieldId').getData();
		 *  }else{
		 *      data = this.data['fieldId']; //直接从数据中获取字段值
		 *  }
		 *  @example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 * @return {DatatableData}
		 */
		getData: function(){
			if( this.importer ){
				this.importer.destroySimulateModule();
			}
			var data;
			if (this.editable!==false){

				if( this.currentEditedLine ){
					this._completeLineEdit(null, true, !!this.form.saving);
				}

				// this.lineList.each(function(line, index){
				// 	if( !this.multiEditMode && line.options.isEdited ){
				// 		line.data = line.getData();
				// 	}else{
				// 		line.data = line.getData();
				// 	}
				// });
				if( this.multiEditMode){
					this.lineList.each(function (line) {
						line.computeModuleData("save");
					})
				}
				data = this._getBusinessData();
				return o2.typeOf(data) === 'object' ? Object.clone(data) : data;
			}else{
				data = this._getBusinessData();
				return o2.typeOf(data) === 'object' ? Object.clone(data) : data;
			}
		},
		getInputData: function(){
			if( this.importer ){
				this.importer.destroySimulateModule();
			}
			if (this.editable!==false){
				return this._getBusinessData();
			}else{
				return this._getBusinessData();
			}
		},
		//区段依据
		_getSectionBy: function(){
			if (this.json.section!=="yes"){
				return "";
			}else {
				switch (this.json.sectionBy){
					case "person":
						return layout.desktop.session.user.id;
					case "unit":
						return (this.form.businessData.task) ? (this.form.businessData.task.unitDn || this.form.businessData.task.unit) : "";
					case "activity":
						return (this.form.businessData.work) ? this.form.businessData.work.activity : "";
					case "splitValue":
						return (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
					case "script":
						if( this.json.sectionByScript && this.json.sectionByScript.code){
							return this.form.Macro.exec(this.json.sectionByScript.code, this) || "";
						}else{
							return "";
						}
					default:
						return "";
				}
			}
		},
		createErrorNode: function(text){
			node = new Element("div", {styles:{
                "margin-top": "0.3em"
            }});
            var iconNode = new Element("div.ooicon-error", {
                "styles": {
                    "width": "20px",
                    "height": "1.2em",
                    "float": "left",
                    "display": "flex",
					"color": "red",
                    "align-items": "center",
                    "justify-content": "center"
                    // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                }
            }).inject(node);
            var textNode = new Element("div", {
                "styles": {
                    "height": "auto",
                    "line-height": "1.2em",
                    "margin-left": "20px",
                    "color": "red",
                    "word-break": "keep-all"
                },
                "text": text
            }).inject(node);
			return node;
		},
		notValidationMode: function(text){
			if (!this.isNotValidationMode){
				this.isNotValidationMode = true;
				this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
				this.node.setStyle("border", "1px solid red");

				this.errNode = this.createErrorNode(text).inject(this.node, "after");
				this.showNotValidationMode(this.node);

				var parentNode = this.errNode;
				while( parentNode && parentNode.offsetParent === null ){
					parentNode = parentNode.getParent();
				}

				if (parentNode && !parentNode.isIntoView()) parentNode.scrollIntoView(false);
			}
		},
		showNotValidationMode: function(node){
			var p = node.getParent("div");
			if (p){
				if (p.get("MWFtype") == "tab$Content"){
					if (p.getParent("div").getStyle("display")=="none"){
						var contentAreaNode = p.getParent("div").getParent("div");
						var tabAreaNode = contentAreaNode.getPrevious("div");
						var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
						var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
						tabNode.click();
						p = tabAreaNode.getParent("div");
					}
				}
				this.showNotValidationMode(p);
			}
		},
		validationMode: function(){
			if (this.isNotValidationMode){
				this.isNotValidationMode = false;
				this.node.setStyles(this.node.retrieve("borderStyle"));
				if (this.errNode){
					this.errNode.destroy();
					this.errNode = null;
				}
			}
			this.lineList.each(function(line){
				line.validationMode();
			})
		},

		validationConfigItem: function(routeName, data){
			var flag = (data.status=="all") ? true: (routeName == data.decision);
			if (flag){
				//???
				var n = this.getInputData();
				if( o2.typeOf(n)==="object"){
					var arr = [];
					Object.each( n, function (d, key) {
						if(o2.typeOf(d) === "array")arr = arr.concat(d);
					});
					n = arr;
				}
				var v = (data.valueType=="value") ? n : n.length;
				switch (data.operateor){
					case "isnull":
						if (!v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notnull":
						if (v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "gt":
						if (v>data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "lt":
						if (v<data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "equal":
						if (v==data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "neq":
						if (v!=data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "contain":
						if (v.indexOf(data.value)!=-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notcontain":
						if (v.indexOf(data.value)==-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
				}
			}
			return true;
		},
		validationConfig: function(routeName, opinion){
			if (this.json.validationConfig){
				if (this.json.validationConfig.length){
					for (var i=0; i<this.json.validationConfig.length; i++) {
						var data = this.json.validationConfig[i];
						if (!this.validationConfigItem(routeName, data)) return false;
					}
				}
				return true;
			}
			return true;
		},
		saveValidation: function () {
			return this.validationCurrentEditedLine();
		},
		validationCurrentEditedLine: function () {
			var line = this.currentEditedLine;
			if( !line )return true;
			if( !line.validation() )return false;
			return true;
		},
		_validation: function(routeName, opinion){
			// if (this.isEdit){
			// 	if (!this.editValidation()){
			// 		return false;
			// 	}
			// }
			let validationFlag = '';
			if (!this.validationConfig(routeName, opinion))  return false;

			if( !this.validationCurrentEditedLine() )return false;

			if (!this.json.validation) return true;
			if (!this.json.validation.code) return true;

			this.currentRouteName = routeName;
			var flag = this.form.Macro.exec(this.json.validation.code, this);
			this.currentRouteName = "";

			if (!flag) flag = MWF.xApplication.process.Xform.LP.lineNotValidation;
			if (flag.toString()!=="true"){
				this.notValidationMode(flag);
				return false;
			}
			return true;



		},
		validation: function(routeName, opinion){
			const flag = this._validation(routeName, opinion);
			this.fireEvent("validation", [flag]);
			return flag;
		},
		getAttachmentRandomSite: function(){
			var i = (new Date()).getTime();
			return this.json.id+i;
		},
		_loadImportExportAction: function(){
			this.impexpNode = this.node.getElement("div.impexpNode");
			if( this.impexpNode )this.impexpNode.destroy();
			this.impexpNode = null;

			if( !this.exportenable && !this.importenable )return;

			var position = ["leftTop","centerTop","rightTop"].contains( this.json.impexpPosition || "" ) ? "top" : "bottom";
			var container = new Element("div", {style: "overflow:hidden;"}).inject(this.node, position);

			this.importExportAreaNode = new Element("div").inject( container );
			if( ["leftTop","leftBottom"].contains( this.json.impexpPosition || "" ) ){
				this.importExportAreaNode.setStyles({ "float" : "left" })
			}else if( ["rightTop","rightBottom"].contains( this.json.impexpPosition || "" ) ){
				this.importExportAreaNode.setStyles({ "float" : "right" })
			}else{
				this.importExportAreaNode.setStyles({ "margin" : "0px auto" })
			}

            var styles;
			if( this.exportenable ){
				this.exportActionNode = new Element("div", {
					text : this.json.exportActionText || MWF.xApplication.process.Xform.LP.datagridExport
				}).inject(this.importExportAreaNode);
				if( this.json.exportActionStyles ){
					styles = this.json.exportActionStyles
				}else{
					styles = this.form.css.gridExportActionStyles;
				}
				this.exportActionNode.setStyles(styles);

				this.exportActionNode.addEvent("click", function () {
					this.exportToExcel();
				}.bind(this))

				if( this.form.json.formStyleType === 'v10' ){
					this.exportActionNode.addClass('form-content-button');
				}
			}

			if( this.importenable ){
				this.importActionNode = new Element("div", {
					text : this.json.importActionText || MWF.xApplication.process.Xform.LP.datagridImport
				}).inject(this.importExportAreaNode);
				if( this.json.importActionStyles ){
					styles = this.json.importActionStyles;
				}else{
					styles = this.form.css.gridImportActionStyles;
				}
				this.importActionNode.setStyles(styles);

				this.importActionNode.addEvent("click", function () {
					this.importFromExcel();
				}.bind(this))

				if( this.form.json.formStyleType === 'v10' ){
					this.importActionNode.addClass('form-content-button');
				}
			}

			if( ["centerTop","centerBottom"].contains( this.json.impexpPosition ) ){
				var width = 2;

				if( this.exportActionNode ){
					width = width + this.exportActionNode.getSize().x +
						this.exportActionNode.getStyle("padding-left").toFloat() +
						+ this.exportActionNode.getStyle("padding-right").toFloat() +
						+ this.exportActionNode.getStyle("margin-left").toFloat() +
						+ this.exportActionNode.getStyle("margin-right").toFloat()
				}

				if( this.importActionNode ){
					width = width + this.importActionNode.getSize().x +
						this.importActionNode.getStyle("padding-left").toFloat() +
						+ this.importActionNode.getStyle("padding-right").toFloat() +
						+ this.importActionNode.getStyle("margin-left").toFloat() +
						+ this.importActionNode.getStyle("margin-right").toFloat()
				}

				this.importExportAreaNode.setStyle( "width", width+"px" );
			}
		},
		exportToExcel: function(){
			this.exporter = new MWF.xApplication.process.Xform.DatatablePC.Exporter(this);
			this.exporter.exportToExcel();
		},
		importFromExcel: function(){
			this.importer = new MWF.xApplication.process.Xform.DatatablePC.Importer(this);
			this.importer.importFromExcel();
		}
	});

MWF.xApplication.process.Xform.DatatablePC$Title = new Class({
	Extends: MWF.APP$Module,
	_loadUserInterface: function(){
		if(this.json.recoveryStyles){
			this.node.setStyles(this.json.recoveryStyles);
		}
		if (this.json.prefixIcon || this.json.suffixIcon){
			var text = this.node.get("text");
			this.node.empty();

			var lineheight = this.node.getStyle("line-height") || "28px";
            this.wrapNode = new Element("div", {
                "styles": {
					"display": "flex",
					"align-items": "center",
					"justify-content": "center"
                }
            }).inject(this.node);

			if (this.json.prefixIcon){
				this.prefixNode = new Element("div", {"styles": {
					"width": "20px",
					"min-width": "20px",
					"height": lineheight,
					"background": "url("+this.json.prefixIcon+") center center no-repeat"
				}}).inject(this.wrapNode);
			}

			this.textNode = new Element("div", {"styles": {
					"line-height": lineheight,
					"vertical-align": "top",
					"padding": "1px"
				}, "text": text}).inject(this.wrapNode);

			if (this.json.suffixIcon){
				this.suffixNode = new Element("div", {"styles": {
					"width": "20px",
					"min-width": "20px",
					"height": lineheight,
					"background": "url("+this.json.suffixIcon+") center center no-repeat"
				}}).inject(this.wrapNode);
			}
		}
	},
	getOffsetY: function(){
		return (this.node.getStyle("padding-top") || 0).toInt()
			+ (this.node.getStyle("padding-bottom") || 0).toInt()
			+ (this.node.getStyle("border-top") || 0).toInt()
			+ (this.node.getStyle("border-bottom") || 0).toInt()
	}
});

MWF.xApplication.process.Xform.DatatablePC$Data =  new Class({
	Extends: MWF.APP$Module,
	_loadUserInterface: function(){
		if(this.json.recoveryStyles){
			this.node.setStyles(this.json.recoveryStyles);
		}
	}
});

MWF.xApplication.process.Xform.DatatablePC.SectionLine =  new Class({
	Implements: [Options, Events],
	options: {
		isNew: false,
		isEdited: true, //是否正在编辑
		isEditable: true, //能否被编辑
		isDeleteable: true, //能否被删除
		isAddable: true, //能否添加
		isMergeRead: false, //合并阅读
		index: 0,
		indexText: "0"
	},
	initialize: function (node, datatable, data, options) {
		this.setOptions(options);
		this.sectionKeyNode = node;
		this.datatable = datatable;
		this.data = data;
		this.form = this.datatable.form;
		this.lineList = [];
		this.totalColumns = [];
		this.totalNumberModuleIds = [];
		this.sectionKey = this.data.sectionKey;
	},
	load: function () {
		if( this.datatable.isShowSectionKey() || this.datatable.isShowSectionBy() ){
			this.loadSectionKeyNode();
		}else{
			this.sectionKeyNode.hide();
		}
		this._loadTotalTr();

		if( this.data.data &&  this.data.data.data ){
			( this.data.data.data || [] ).each(function(d, idx){
				if( !d )return;
				var node = this._createLineNode();
				var isEdited = false, isNew = false;
				var dt = this.datatable;
				if( this.options.isEdited ){
					isNew = dt.isNew || (o2.typeOf(dt.newLineIndex) === "number" ? idx === dt.newLineIndex : false);
					isEdited = (!dt.multiEditMode && o2.typeOf(dt.newLineIndex) === "number") ? idx === dt.newLineIndex : dt.multiEditMode;
					dt.isNew = false;
					dt.newLineIndex = null;
				}
				var line = this._loadLine( node, d, idx, isEdited, isNew );
				if( !dt.multiEditMode && isEdited ){
					dt.currentEditedLine = line;
				}
				this.lineList.push(line);
				this.datatable.lineList.push(line);
			}.bind(this));
			this._loadTotal();
		}
	},
	resetId: function(){
		this.lineList.each(function (line) {
			line.resetId();
		}.bind(this))
	},
	setIndex: function( preNode, data, index, isEdited, isNew, operation ){
		if( this.isUnchangedAll && index === this.options.index )return;

		this.data = data;

		this.options.index = index;
		this.options.indexText = (index+1).toString();

		this.sectionKeyNode.inject(preNode, "after");

		this.lineList = [];
		var map = this.unchangedLineMap || {};
		Object.each(map, function (line, idx) {
            line.setIndex( this.datatable.lineList.length + idx.toInt(), idx.toInt() );
        }.bind(this));
		if( this.data.data &&  this.data.data.data ){
			this.data.data.data.each(function (d, idx) {
				if( !d )return;
				var idxStr = idx.toString();
				var beforeNode = idx > 0 ? this.lineList[idx - 1].node : this.sectionKeyNode;
				if( map[idxStr] ){
					if( !operation || operation === "moveUpList" ){
						map[idxStr].node.inject( beforeNode, "after" );
					}
					this.lineList.push( map[idxStr] );
					this.datatable.lineList.push(map[idxStr]);
				}else{
					var node = this._createLineNode(  beforeNode );
					var isEdited = false, isNew = false;
					if( this.options.isEdited ){
						var dt = this.datatable;
						isNew = dt.isNew || (o2.typeOf(dt.newLineIndex) === "number" ? idx === dt.newLineIndex : false);
						isEdited = (!dt.multiEditMode && o2.typeOf(dt.newLineIndex) === "number") ? idx === dt.newLineIndex : dt.multiEditMode;
						dt.isNew = false;
						dt.newLineIndex = null;
					}
					var line = this._loadLine( node, d, idx, isEdited, isNew );
					this.lineList.push(line);
					this.datatable.lineList.push(line);
				}
			}.bind(this))
		}

		if( this.totalTr )this.totalTr.inject( this.lineList.getLast().node, "after" );

		this._loadTotal();

	},
	_loadLine: function(container, data, index, isEdited, isNew){
		var line = new MWF.xApplication.process.Xform.DatatablePC.Line(container, this.datatable, data, {
			indexInSectionLine : index,
			indexInSectionLineText : (index+1).toString(),
			index: this.datatable.lineList.length,
			indexText : (this.datatable.lineList.length + 1).toString(),
			isNew: isNew,
			isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.options.isEdited,
			isEditable: this.options.isEditable,
			isDeleteable: this.options.isDeleteable,
			isAddable: this.options.isAddable,
			isMergeRead: this.options.isMergeRead,
			sectionKey: this.sectionKey
		}, this);
		this.datatable.fireEvent("beforeLoadLine", [line]);
		line.load();
		this.datatable.fireEvent("afterLoadLine", [line]);
		return line;
	},
	_createLineNode: function( beforeNode ){
		var tr;
		if( beforeNode ){
			tr = new Element("tr").inject(beforeNode, "after");
		}else if( this.totalTr ){
			tr = new Element("tr").inject(this.totalTr, "before");
		}else{
			tr = this.datatable._createLineNode();
			// tr = new Element("tr").inject(this.tBody || this.table);
		}
		return tr;
	},
	loadSectionKeyNode: function () {
		var styleName = this.datatable.isShowSectionKey() ? "sectionKeyStyles" : "sectionByStyles";
		var sectionKeyStyles = this.datatable._parseStyles( this.datatable.json[styleName] || {} );
		var keyNode = new Element("td.mwf_sectionkey", {
			colspan: this.datatable.columnCount,
			styles : sectionKeyStyles
		}).inject( this.sectionKeyNode );
		this.keyNode = keyNode;
		var separator;
		if( this.datatable.isShowSectionKey() ){
			separator = this.datatable.json.keyContentSeparator;
		}else{
			separator = this.datatable.json.keyContentSeparatorSectionBy;
		}
		this.datatable.getSectionKeyWithMerge( this.data, function (key) {
			if( o2.typeOf(key) === "string" ){
				keyNode.set("text", key + (separator || ""));
			}else{
				Promise.resolve(key).then(function (k) {
					keyNode.set("text", k + (separator || ""));
				}.bind(this))
			}
		}.bind(this));
	},
	_setUnchangedLineMap: function(data, operation){
		var fromOutside = !operation;
		var dt = this.datatable;
		var editalbe;
		if( dt.isShowAllSection ){
			editalbe = dt.isShowAllSection && dt.sectionBy && dt.sectionBy === this.sectionKey;
		}
		var lineDataList = this.lineList.map(function (line) {
			if( dt.isShowAllSection ){
				if( line.options.isEditable !== (dt.editable && editalbe) )return "";
				if( line.options.isDeleteable !== (dt.deleteable && editalbe) )return "";
				if( line.options.isAddable !== (dt.addable && editalbe) )return "";
			}else{
				if( line.options.isEditable !== dt.editable )return "";
				if( line.options.isDeleteable !== dt.deleteable )return "";
				if( line.options.isAddable !== dt.addable )return "";
			}
			return fromOutside ?  JSON.stringify(line.data) : line.data;
		}.bind(this));

		var dStr, map = {};
		data.data.each(function (d, idx) {
			if(fromOutside)dStr = JSON.stringify(d);
			for (var i = 0; i < this.lineList.length; i++) {
				var isEqual = fromOutside ? (dStr === lineDataList[i]) : (d === lineDataList[i] );
				if ( isEqual ) {
					map[idx] = this.lineList[i];
					lineDataList[i] = "";
					break;
				}
			}
		}.bind(this));


		this.isUnchangedAll = data.data.length === this.lineList.length;
		if( this.isUnchangedAll ){
			for( var i=0; i<data.data.length; i++ ){
				var line = map[i.toString()];
				if( !line || line.options.indexInSectionLine !== i ){
					this.isUnchangedAll = false;
					break;
				}
			}
		}

		this.unchangedLineMap = map;

		return Object.keys(map).length ? this : null;
	},
	clearSubModules: function(){
		if( this.isUnchangedAll )return;

		var map = this.unchangedLineMap || {};
		var hasUnchangedLine = Object.keys(map).length > 0;

		if( !hasUnchangedLine ){
			if( this.sectionKeyNode ){
				this.sectionKeyNode.destroy();
				this.sectionKeyNode = null;
			}
		}

		var lines = [];
		Object.values(map).each(function (d) {
			lines = lines.concat(d);
		});
		for (var i=0; i<this.lineList.length; i++){
			var l = this.lineList[i];
			if(!lines.contains(l)){
				l.clearSubModules();
			}
		}
		// for (var i=0; i<this.lineList.length; i++){
		// 	this.lineList[i].clearSubModules();
		// }

		if( !hasUnchangedLine ) {
			if (this.totalTr) {
				this.totalTr.destroy();
				this.totalTr = null;
			}
		}
	},
	isTotalTrShow: function(){
		var dt = this.datatable;
		if( dt.isShowSectionKey() && ( dt.json.totalRowBySection || [] ).contains("section") )return true;
		if( dt.isShowSectionBy() && ( dt.json.totalRowBy || [] ).contains("section") )return true;
		return false;
	},
	_loadTotalTr: function(){
		if( !this.datatable.totalFlag )return false;
		this.totalTr = new Element("tr.mwf_totaltr", {"styles": this.form.css.datagridTotalTr_section}).inject(this.sectionKeyNode, "after");
		if( !this.isTotalTrShow() )this.totalTr.hide();
		var ths = this.datatable.titleTr.getElements("th");
		//datatable$Title Module
		ths.each(function(th, index){
			var td = new Element("td", {"text": "", "styles": this.form.css.datagridTotalTd}).inject(this.totalTr);
			if (this.datatable.json.sectionAmountStyles) td.setStyles(this.datatable.json.sectionAmountStyles);

			var json = this.form._getDomjson(th);
			if (json){
				if( json.isShow === false ){
					td.hide(); //隐藏列
				}else if( this.reloading && json.isShow === true){
					td.setStyle("display", "");
				}
				if ((json.total === "number") || (json.total === "count")){
					this.totalColumns.push({
						"th" : th,
						"td" : td,
						"index": index,
						"type": json.total
					})
				}
			}
		}.bind(this));

		var tds = this.datatable.templateTr.getElements("td");
		//datatable$Data Module
		tds.each(function(td, index){
			var json = this.form._getDomjson(td);
			if (json){
				//总计列
				var tColumn = this.totalColumns.find(function(a){ return  a.index === index });
				if(tColumn){
					var moduleNodes = this.form._getModuleNodes(td); //获取总计列内的填写组件
					if( moduleNodes.length > 0 ){
						tColumn.moduleJson = this.form._getDomjson(moduleNodes[0]);
						if(tColumn.type === "number")this.totalNumberModuleIds.push( tColumn.moduleJson.id );
					}
				}
			}
		}.bind(this));
	},
	_getTotalTr: function(){
		return this.totalTr;
	},
	_loadTotal: function(){
		var totalData = {};
		if( !this.datatable.totalFlag )return totalData;
		if (!this._getTotalTr())this._loadTotalTr();
		var data;
		if( this.datatable.isShowAllSection ){
			Object.each( this.datatable.getBusinessDataById(), function (d, k) {
				if( this.sectionKey === k )data = d
			}.bind(this))
		}else{
			data = this.data.data;
		}
		this.totalColumns.each(function(column, index){
			var json = column.moduleJson;
			if(!json)return;

			var total = this.datatable._loadColumnTotal( column, data );
            if( typeOf(total) !== "null" )totalData[json.id] = total;
		}.bind(this));
		data.total = totalData;
		return totalData;
	},
	isTotalNumberModule: function( id ){
		return this.totalNumberModuleIds.contains(id)
	},
	getLastTr: function () {
		if( this.totalTr )return this.totalTr;
		if( this.lineList.length )return this.lineList.getLast().node;
		return this.sectionKeyNode;
	}
});

MWF.xApplication.process.Xform.DatatablePC.Line =  new Class({
	Implements: [Options, Events],
	options: {
		isNew: false,
		isEdited : true, //是否正在编辑
		isEditable : true, //能否被编辑
		isDeleteable: true, //能否被删除
		isAddable: true, //能否添加
		isMergeRead: false, //合并阅读
		index : 0,
		indexText : "0",
		indexInSectionLine: 0,
		indexInSectionLineText : "0",
		sectionKey: ""
	},
	initialize: function (node, datatable, data, options, sectionLine) {

		this.setOptions(options);

		this.node = node;
		this.datatable = datatable;
		this.data = data;
		this.form = this.datatable.form;
		this.sectionLine = sectionLine;

		// if( !this.datatable.multiEditMode && !this.options.isNew){
		// 	this.originalData = Object.clone(data);
		// }

		this.init()

	},
	init: function(){
		this.modules = [];
		this.all = {};
		this.all_templateId = {};

		this.fields = [];
		this.allField = {};
		this.allField_templateId = {};

		this.changedAttachmentMap = {};
	},
	load: function(){
		if( !this.datatable.multiEditMode && this.options.isEdited )this.datatable.currentEditedLine = this;

		this.loadModules();
		this.loadSequence();
		this.createActions();
		this.loadZebraStyle();
		this.loadEditedStyle();
		this.addNodeEvent();

		if( !this.datatable.multiEditMode )this.originalData = Object.clone(this.data);

		// if(this.options.isNew && this.options.isEdited){
		// 	this.data = this.getData();
		// 	if( !this.datatable.multiEditMode )this.originalData = Object.clone(this.data);
		// 	this.options.isNew = false;
		// }
	},
	resetId: function(){
		this.setIndex();
	},
	setIndex: function(index, indexInSectionLine){
		var hasIndexArg = typeOf(index) !== "null";
		var hasIndexInSectionLineArg = typeOf(indexInSectionLine) !== "null";

		if( hasIndexArg && hasIndexInSectionLineArg){
			if( this.options.index === index && this.options.indexInSectionLine === indexInSectionLine )return;
		}else if( hasIndexArg && !hasIndexInSectionLineArg){
			if( this.options.index === index )return;
		}else if(!hasIndexArg && hasIndexInSectionLineArg){
			if( this.options.indexInSectionLine === indexInSectionLine )return;
		}

		if( hasIndexArg ){
			this.options.index = index;
			this.options.indexText = (index.toInt()+1).toString();
		}

        if( hasIndexInSectionLineArg ){
			this.options.indexInSectionLine = indexInSectionLine;
			this.options.indexInSectionLineText = (indexInSectionLine.toInt()+1).toString();
		}

        //合并状态或拆分状态
        var sectionKey = this.options.sectionKey || this.datatable.sectionBy;
        this.modules.each(function (module) {
            var json = module.json;
            var id, oldId = json.id, templateJsonId = json.originialId;
            if( this.datatable.isShowAllSection ){
                id = this.datatable.json.id + ".." + sectionKey + "..data.." + this.options.indexInSectionLine + ".." + json.originialId;
            }else if( sectionKey ){
                id = this.datatable.json.id + ".." + sectionKey + "..data.." + this.options.index + ".." + json.originialId;
            }else{
                id = this.datatable.json.id + "..data.." + this.options.index + ".." + json.originialId;
            }
            json.id = id;
            switch (module.json.type) {
				case "Select":
					(module.areaNode || module.node).set("id", id);
					break;
				default:
					module.node.set("id", id);
					break;
			}

            if( json.type==="Attachment" || json.type==="AttachmentDg" ){
				json.originialSite = json.site || json.originialId;
                json.site = this.getAttachmentSite(json, templateJsonId, sectionKey);
            }

            delete this.all[oldId];
            this.all[id] = module;

            delete this.allField[oldId];
            this.allField[id] = module;

			if(this.form.all[oldId] && this.form.all[oldId] === module){
                delete this.form.all[oldId];
            }
            this.form.all[id] = module;

            if(this.form.forms[oldId] && this.form.forms[oldId] === module){
                delete this.form.forms[oldId];
            }
            if( module.field )this.form.forms[id] = module;

            if( hasIndexArg || hasIndexInSectionLineArg ){
				this.loadSequence();
				this.loadZebraStyle();
			}
        }.bind(this));
    },
	loadModules: function(){
		this.node.set("html", this.datatable.templateHtml);
		var moduleNodes = this.form._getModuleNodes(this.node, true);

		//合并状态或拆分状态
		var sectionKey = this.options.sectionKey || this.datatable.sectionBy;
		moduleNodes.each(function (node) {
			var mwfType = node.get("MWFtype");
			if (mwfType === "form")return;

			var _self = this;

			var tJson = this.form._getDomjson(node);
			if( tJson ){
				var json = Object.clone(tJson);

				if( !this.options.isEdited || !this.options.isEditable ){
					if( json.hasOwnProperty('showMode') ){
						json.showMode = 'read';
					}else{
						json.isReadonly = true;
					}

				}

				var templateJsonId = json.id;

				var index = this.options.index;

				var id;
				if( this.datatable.isShowAllSection ){
					id = this.datatable.json.id + ".." + sectionKey + "..data.." + this.options.indexInSectionLine + ".." + json.id;
				}else if( sectionKey ){
					id = this.datatable.json.id + ".." + sectionKey + "..data.." + index + ".." + json.id;
				}else{
				    id = this.datatable.json.id + "..data.." + index + ".." + json.id;
				}

                json.originialId = templateJsonId;
				json.id = id;
				node.set("id", id);

				if( json.type==="Attachment" || json.type==="AttachmentDg" ){
					json.type = "AttachmentDg";
					json.ignoreSite = true;
					json.originialSite = json.site || json.originialId;
					json.site = this.getAttachmentSite(json, templateJsonId, sectionKey);
				}

				if (this.form.all[id]) this.form.all[id] = null;
				if (this.form.forms[id])this.form.forms[id] = null;

				var hasData = this.data.hasOwnProperty(templateJsonId);

				json.inDatatable = true;
				var module = this.form._loadModule(json, node, function () {
					if( _self.options.isMergeRead ){
						this.field = false; //不希望保存数据
						this._getBusinessData = function(){
							return _self.data[templateJsonId];
						};
						this._setBusinessData = function () {};
					}
					if( _self.widget )this.widget = _self.widget;
					this.parentLine = _self;
					this.parentDatatable = _self.datatable;

					//只读方法值在页面加载的时候或者new的时候计算一下
					if( this.json.compute === "show" ){
						var needComputeShow = false;
						if( _self.datatable.loading ) {
							needComputeShow = true;
						}else if( _self.options.isNew && !_self.reloading ){
							needComputeShow = true;
						}
						if( !needComputeShow ){
							this.json.compute = "create"; //
							if( this.options.moduleEvents && this.options.moduleEvents.length ){ //恢复compute
								var eventName = ( this.options.moduleEvents || [] ).contains("afterLoad") ? "afterLoad" : "load";
								var resetCompute = function () {
									this.json.compute = "show";
									this.removeEvent( eventName, resetCompute );
								}.bind(this)
								this.addEvent(eventName, resetCompute);
							}
						}
					}

				});
				if(!module.parentLine)module.parentLine = this;
				if(!module.parentDatatable)module.parentDatatable = this.datatable;

				if((json.type==="Attachment" || json.type==="AttachmentDg")){
					module.addEvent("change", function(){
						if( this.datatable.multiEditMode ){
							_self.datatable.saveFormData();
						}else{
							_self.attachmentChangeFlag = true;
						}
					}.bind(this))
				}

				this.form.modules.push(module);

				this.modules.push(module);
				this.all[id] = module;
				this.all_templateId[templateJsonId] = module;

				if (module.field) {
					// if(hasData){
					// 	module.setData(this.data[templateJsonId]);
					// }else if(this.options.isEdited){
					// 	this.data[templateJsonId] = module.getData();
					// }
					if(this.options.isEdited ) {
						if (json.type !== "Attachment" && json.type !== "AttachmentDg"){
							if( module.json.compute === "save" && module.getInputData ){
								this.data[templateJsonId] = module.getInputData();
							}else{
								this.data[templateJsonId] = module.getData();
							}
						}
					}else if(!hasData && module.getValue ){
						this.data[templateJsonId] = module.getValue();
					}
					this.allField[id] = module;
					this.allField_templateId[templateJsonId] = module;
					this.fields.push( module );

					if( this.options.isEdited && this.datatable.multiEditMode ){
						module.addEvent("change", function(){
							this.datatable.fireEvent("change", [{lines: [this], type: "editmodule", module: module}]);
						}.bind(this))
					}
					//该字段是合集数值字段
					if(this.datatable.multiEditMode && this.isTotalNumberModule(templateJsonId)){
						//module
						module.addEvent("change", function(){
							this.datatable._loadTotal();
							if( this.sectionLine )this.sectionLine._loadTotal();
						}.bind(this))
					}
				}
			}
		}.bind(this));
	},
	isTotalNumberModule: function(id){
		if( this.sectionLine ){
			return this.sectionLine.isTotalNumberModule(id)
		}else{
			return this.datatable.isTotalNumberModule(id)
		}
	},
	getIndex: function(){
		return this.options.index;
	},
	getModule: function(templateJsonId){
		var _subform = this.datatable.json._subform;
		if( _subform ){
			var module = this.all_templateId[_subform+"_"+templateJsonId];
			if( module )return module;
		}
		return this.all_templateId[templateJsonId];
	},
	get: function(templateJsonId){
		return this.getModule( templateJsonId );
	},
	getAttachmentSite: function(json, templateJsonId, sectionKey){
		//确保site最长为64，否则后台会报错

		var index = this.options.index;

		var baseSite;
		baseSite =  "." + index + "."  + (json.site || templateJsonId);

		var maxLength;
		var sectionId = "";
		if( sectionKey ){
			maxLength = Math.floor((63 - baseSite.length)/2 );

			sectionId = (sectionKey.length > maxLength) ? sectionKey.substr(sectionKey.length-maxLength, maxLength) : sectionKey;
			sectionId = "." + sectionId;
		}else{
			maxLength = 64 - baseSite.length;
		}

		var templateId = this.datatable.json.id;
		templateId = (templateId.length > maxLength) ? templateId.substr(templateId.length-maxLength, maxLength) : templateId;

		return templateId + sectionId + baseSite;
	},
	deleteAttachment: function(){
		var saveFlag = false;
		for( var key in this.allField){
			var module = this.allField[key];
			if( module.json.type==="Attachment" || module.json.type==="AttachmentDg" ){
				var array = module._getBusinessData();
				(array || []).each(function(d){
					saveFlag = true;
					this.datatable.deleteAttachment(d.id);

					for( var i=0; i<this.form.businessData.attachmentList.length; i++ ){
						var attData = this.form.businessData.attachmentList[i];
						if( (attData.businessId && attData.businessId === d.businessId) || attData.id === d.id ){
							this.form.businessData.attachmentList.erase(attData);
							break;
						}
					}

				}.bind(this))
			}
		}
		return saveFlag;
	},
	loadSequence: function(){
		var sequenceTd = this.node.getElements(".mwf_sequence");
		if(sequenceTd){
			if( this.datatable.isShowSectionKey() ) {
				if (this.datatable.json.sequenceBySection === "section") {
					sequenceTd.set("text", this.options.indexInSectionLineText);
				} else {
					sequenceTd.set("text", this.options.indexText)
				}
			}else if( this.datatable.isShowSectionBy() ){
				if( this.datatable.json.sequenceBy === "section" ){
					sequenceTd.set("text", this.options.indexInSectionLineText );
				}else {
					sequenceTd.set("text", this.options.indexText)
				}
			}else{
				sequenceTd.set("text", this.options.indexText)
			}
		}
	},
	loadZebraStyle: function(){
		if ((this.options.index%2)===0 && this.datatable.json.zebraColor){
			this.node.setStyle("background-color", this.datatable.json.zebraColor);
		}else if(this.datatable.json.backgroundColor){
			this.node.setStyle("background-color", this.datatable.json.backgroundColor);
		}
	},
	loadEditedStyle: function(){
		if (!this.datatable.multiEditMode && this.options.isEdited && this.datatable.json.editStyles){
			var tds = this.node.getElements("td");
			tds.setStyles(this.datatable.json.editStyles);
		}
	},
	addNodeEvent: function(){
		if(!this.datatable.multiEditMode && this.options.isEditable){
			this.editFun = function(){
				if( !this.options.isEdited ){
					this.datatable._changeEditedLine(this)
				}
			}.bind(this);
			this.node.addEvent("click", this.editFun)
		}
	},
	createActions: function () {
		//不允许编辑，直接返回
		if(!this.options.isEditable)return;

		var editActionTd = this.node.getElement(".mwf_editaction");
		var moveActionTd = this.node.getElement(".mwf_moveaction");

		if(this.datatable.multiEditMode){ //多行编辑模式
			if(this.options.isAddable)this.createAddAction(editActionTd);
			if(this.options.isDeleteable)this.createDelAction(editActionTd);
		}else{ //单行编辑模式
			if(this.options.isAddable)this.createAddAction(editActionTd);
			if(this.options.isDeleteable)this.createDelAction(editActionTd);
			this.createCompleteAction(editActionTd);
			this.createCancelEditAction(editActionTd);
			this.checkActionDisplay();
		}
		if( moveActionTd )this.createMoveAction(moveActionTd);

	},
	checkActionDisplay: function(){
		if( this.options.isEdited ){
			if( this.addLineAction )this.addLineAction.hide();
			if( this.delLineAction )this.delLineAction.hide();
			if( this.completeLineAction )this.completeLineAction.show();
			if( this.cancelLineEditAction )this.cancelLineEditAction.show();
		}else{
			if( this.addLineAction )this.addLineAction.show();
			if( this.delLineAction )this.delLineAction.show();
			if( this.completeLineAction )this.completeLineAction.hide();
			if( this.cancelLineEditAction )this.cancelLineEditAction.hide();
		}
	},
	createAddAction: function(td){
		this.addLineAction = new Element("div.addLineAction.ooicon-create", {
			"styles": this.form.css.addLineAction,
			"events": {
				"click": function(ev){
					this.datatable._insertLine( ev, this );
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createCompleteAction: function(td){
		this.completeLineAction = new Element("div.completeLineAction.ooicon-checkmark", {
			"styles": this.form.css.completeLineAction,
			"events": {
				"click": function(ev){
					this.datatable._completeLineEdit(ev, true);
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createCancelEditAction: function(td){
		this.cancelLineEditAction = new Element("div.cancelLineEditAction.ooicon-process-cancel", {
			"styles": this.form.css.delLineAction,
			"events": {
				"click": function(ev){
					this.datatable._cancelLineEdit(ev, this);
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createDelAction: function(td){
		this.delLineAction = new Element("div.delLineAction.ooicon-delete", {
			"styles": this.form.css.delLineAction,
			"events": {
				"click": function(ev){
					this.datatable._deleteLine( ev, this );
					// if( this.datatable.currentEditedLine === this )this.datatable.currentEditedLine = null;
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createMoveAction: function(td){
		this.moveAction = new Element("div", {
			"styles": this.form.css.datatableMoveLineAction,
			"text": "↑",
			"events": {
				"click": function(ev){
					this.datatable._moveUpLine( ev, this );
					// if( this.datatable.currentEditedLine === this )this.datatable.currentEditedLine = null;
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	changeEditMode: function( isEdited ){
		if( isEdited === this.options.isEdited )return;
		if( !this.options.isEditable )return;
		this.options.isEdited = isEdited;
		this.reload();
		if( this.options.isEdited ){
			this.datatable.fireEvent("editLine",[this]);
		}
	},
	reload: function(){
		this.reloading = true;
		for(var key in this.all){
			var module = this.all[key];
			this.form.modules.erase(module);
			if (this.form.all[key]) delete this.form.all[key];
			if (this.form.forms[key])delete this.form.forms[key];
		}
		this.node.empty();
		if(this.editFun){
			this.node.removeEvent("click", this.editFun);
			this.editFun = null;
		}
		this.init();
		this.load();
		this.reloading = false;
	},
	clearSubModules: function () { //把module清除掉
		for(var key in this.all){
			var module = this.all[key];
			//如果嵌套数据模板或者数据表格，还要清除掉下级
			if(module.clearSubModules)module.clearSubModules();
			this.form.modules.erase(module);
			if (this.form.all[key]) delete this.form.all[key];
			if (this.form.forms[key])delete this.form.forms[key];
		}
		this.node.destroy();
		this.init();
	},
	computeModuleData: function( when ){
		for( var key in this.allField_templateId){
			var module = this.allField_templateId[key];
			if( module.json.compute === when ){
				this.data[key] = module.getData();
			}
		}
	},
	getData: function () {
		var data = this.data;
		for( var key in this.allField_templateId){
			var module = this.allField_templateId[key];
			// var id = key.split("..").getLast();
			if( module.json.type==="Attachment" || module.json.type==="AttachmentDg" ){
				data[key] = module._getBusinessData();
			}else{
				data[key] = module.getData();
			}
		}
		return data;
	},
	setData: function (data) {
		this.datatable._setLineData(this, data);
	},
	_validation: function(){
		if( !this.options.isEdited || !this.options.isEditable )return true;
		if( !this.validationFields())return false;
		if( !this.validationCompleteLine())return false;
		return true;
	},
	validation: function(){
		const flag = this._validation();
		this.datatable.fireEvent("validationLine", [this, flag]);
		return flag
	},
	validationFields: function(){
		if( !this.options.isEdited || !this.options.isEditable )return true;
		var flag = true;
		this.fields.each(function(field, key){
			if (field.json.type!="sequence" && field.validationMode ){
				field.validationMode();
				if (!field.validation()) flag = false;
			}
		}.bind(this));
		return flag;
	},
	validationCompleteLine: function(){
		if( !this.options.isEdited || !this.options.isEditable )return true;
		var flag = true;
		if( !this.datatable.multiEditMode ){
			if (this.datatable.json.validationCompleteLine && this.datatable.json.validationCompleteLine.code){
				flag = this.form.Macro.exec(this.datatable.json.validationCompleteLine.code, this);
				if (!flag) flag = MWF.xApplication.process.Xform.LP.lineNotValidation;
			}
		}
		if (flag.toString()!=="true"){
			var isTr = !layout.mobile;
			this.notValidationMode(flag, isTr);
			return false;
		}
		return true;
	},
	createErrorNode: function(text, isTr){
		var node, tr, td;
		if( this.form.json.errorStyle ){
			if( this.form.json.errorStyle.type === "notice" ){
				if( !this.form.errorNoticing ){ //如果是弹出
					this.form.errorNoticing = true;
					this.form.notice(text, "error", this.node, null, null, {
						onClose : function () {
							this.form.errorNoticing = false;
						}.bind(this)
					});
				}
			}else{
				if( isTr ){
					tr = new Element("tr");
					td = new Element("td", {"colspan": this.datatable.columnCount}).inject(tr);
				}
				node = new Element("div",{
					"styles" : this.form.json.errorStyle.node,
					"text": text
				});
				if( td )node.inject(td);
				if( this.form.json.errorStyle.close ){
					var closeNode = new Element("div",{
						"styles" : this.form.json.errorStyle.close ,
						"events": {
							"click" : function(){
								// (tr || node).destroy();
								this.validationMode()
							}.bind(this)
						}
					}).inject(node);
				}
			}
		}else{
			if( isTr ){
				tr = new Element("tr");
				td = new Element("td", {"colspan": this.datatable.columnCount}).inject(tr);
			}
			node = new Element("div", {styles:{
				"margin-top": "0.3em"
			}});
			if( td )node.inject(td);
			var iconNode = new Element("div", {
				"styles": {
					"width": "20px",
					"height": "1.2em",
					"float": "left",
					"display": "flex",
					"align-items": "center",
					"justify-content": "center"
					// "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
				}
			}).inject(node);
			var textNode = new Element("div", {
				"styles": {
					"height": "auto",
					"line-height": "1.2em",
					"margin-left": "20px",
					"color": "red",
					"word-break": "keep-all"
				},
				"text": text
			}).inject(node);
		}
		return tr || node;
	},
	notValidationMode: function(text, isTr){
		if (!this.isNotValidationMode){
			this.isNotValidationMode = true;
			this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
			this.node.setStyle("border-color", "red");

			this.errNode = this.createErrorNode(text, isTr);
			//if (this.iconNode){
			//    this.errNode.inject(this.iconNode, "after");
			//}else{
			this.errNode.inject(this.node, "after");
			//}
			this.showNotValidationMode(this.node);

			var parentNode = this.errNode;
			while( parentNode && parentNode && parentNode.offsetParent === null ){
				parentNode = parentNode.getParent();
			}

			if (!parentNode.isIntoView()) parentNode.scrollIntoView(false);
		}
	},
	showNotValidationMode: function(node){
		var p = node.getParent("div");
		if (p){
			var mwftype = p.get("MWFtype") || p.get("mwftype");
			if (mwftype == "tab$Content"){
				if (p.getParent("div").getStyle("display")=="none"){
					var contentAreaNode = p.getParent("div").getParent("div");
					var tabAreaNode = contentAreaNode.getPrevious("div");
					var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
					var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
					tabNode.click();
					p = tabAreaNode.getParent("div");
				}
			}
			this.showNotValidationMode(p);
		}
	},
	validationMode: function(){
		if (this.isNotValidationMode){
			this.isNotValidationMode = false;
			this.node.setStyles(this.node.retrieve("borderStyle"));
			if (this.errNode){
				this.errNode.destroy();
				this.errNode = null;
			}
		}
	},

	resetDataWithOriginalData: function () {
		var data = this.originalData;
		var attachmentList = this.form.businessData.attachmentList;
		for( var key in this.allField_templateId){
			var module = this.allField_templateId[key];
			if( module.json.type==="Attachment" || module.json.type==="AttachmentDg" ){
				data[key] = (data[key] || []).filter(function(att, index){
					for( var i=0; i<attachmentList.length; i++){
						if( (attachmentList[i].businessId && attachmentList[i].businessId === att.businessId) || attachmentList[i].id === att.id )return true;
					}
					return false;
				}.bind(this))
			}
			this.data[key] = data[key];
		}
		return data;
	}
});

MWF.xApplication.process.Xform.DatatablePC.ImporterDatabale = new Class({
	Extends: MWF.xApplication.process.Xform.DatatablePC,
	initialize: function(mainDatatable){
		this.mainDatatable = mainDatatable;
		this.json = Object.clone( mainDatatable.json );
		this.json.id = this.json.id + "_o2simula";

		this.node = new Element("div", {
			id: this.json.id
		});
		this.node.store("module", this);

		this.form = mainDatatable.form;
		this.field = false;
		this.fieldModuleLoaded = false;
	},
	load: function(){

		this.deleteFormData = function(data){
			delete data[this.id];
			this._self.form.removeEvent("getData", this._self.deleteFormData);
		}.bind({_self: this, id: this.json.id});
		this.form.addEvent("getData", this.deleteFormData);

		this._loadModuleEvents();
		if (this.fireEvent("queryLoad")){
			this._queryLoaded();
			this._loadUserInterface();
			this._afterLoaded();
			this.fireEvent("afterLoad");
			// this.fireEvent("load");
		}
	},
	_loadUserInterface: function(){
		// this.fireEvent("queryLoad");

		// this.editModules = [];

		this.table = new Element("table").inject(this.node);
		this.tBody = new Element("tbody").inject(this.table);

		this.editable = true;

		//是否多行同时编辑
		this.multiEditMode = true;

		this.data = {"data": [], "total":{}};
		this._setValue(this.data);

		this.lineList = [];

		this.loadDatatable();
	},
	loadDatatable: function(){
		this.loading = true;

		//this._loadTitleTr();
		//this._loadTemplate();
		//this._loadTotalTr();

		// this.templateNode = this.mainDatatable.templateNode;
		// this.templateTr = this.mainDatatable.templateTr;
		this.columnCount = this.mainDatatable.columnCount;
		this.templateHtml = this.mainDatatable.templateHtml;

		this.fireEvent("load");
		this._loadDatatable(function(){
			this.fieldModuleLoaded = true;
			this.loading = false;
			this.fireEvent("postLoad");
		}.bind(this));
	},
	_loadDatatable: function(callback){
		this._loadLineList(function(){
			//this._loadTotal();
			if(callback)callback();
		}.bind(this));
	},
	_loadLine: function(container, data, index, isEdited, isNew){
		var line = new MWF.xApplication.process.Xform.DatatablePC.ImporterLine(container, this, data, {
			index : index,
			indexText : (index+1).toString()
		});
		this.fireEvent("beforeLoadLine", [line]);
		line.load();
		this.fireEvent("afterLoadLine", [line]);
		return line;
	},
	_addLine: function(ev, edited, d){
		var data, index, line;

		index = this.lineList.length;
		data = this.data;

		data.data.push(d||{});
		this.newLineIndex = index;

		this.setData( data );
		line = this.getLine(index);
		line.isNewAdd = true;

		this.fireEvent("addLine", [{"line":line, "ev":ev}]);

		this.fireEvent("change", [{"lines":[line], "type":"addline"}]);

		return line;
	},
	// _delLine: function(line){
	// 	this.fireEvent("deleteLine", [line]);
	//
	// 	//使用数据驱动
	// 	var data = this.data;
	// 	data.data.splice(line.options.index, 1);
	//
	// 	if(this.currentEditedLine === line)this.currentEditedLine = null;
	// 	this.setData( data );
	//
	// 	// this.validationMode();
	// 	this.fireEvent("afterDeleteLine");
	//
	// 	this.fireEvent("change", [{"lines":[line], "type":"deleteline"}]);
	// },
	destroy: function(){
		this.clearSubModules();
		var id = this.json.id;
		if (this.form.all[id]) delete this.form.all[id];
		if (this.form.forms[id])delete this.form.forms[id];
		// if( this.form.businessData.data.hasOwnProperty(id) )delete this.form.businessData.data[id];
		// if( this.form.Macro.environment.data.hasOwnProperty(id) )delete this.form.Macro.environment.data[id];
		this.node.destroy();
	}
});

//Excel导入时候创建的组件
MWF.xApplication.process.Xform.DatatablePC.ImporterLine =  new Class({
	Implements: [Options, Events],
	options: {
		isNew: true,
		isEdited : true, //是否正在编辑
		isEditable : true, //能否被编辑
		isDeleteable: true, //能否被删除
	},
	initialize: function (node, datatable, data, options) {

		this.setOptions(options);

		this.node = node;
		this.datatable = datatable;
		this.data = data;
		this.form = this.datatable.form;

		this.init()
	},
	init: function(){
		this.modules = [];
		this.all = {};
		this.all_templateId = {};

		this.fields = [];
		this.allField = {};
		this.allField_templateId = {};
	},
	load: function(){
		// if( !this.datatable.multiEditMode && this.options.isEdited )this.datatable.currentEditedLine = this;

		this.loadModules();

		// if( !this.datatable.multiEditMode )this.originalData = Object.clone(this.data);
	},
	loadModules: function(){
		this.node.set("html", this.datatable.templateHtml);
		var moduleNodes = this.form._getModuleNodes(this.node, true);

		//合并状态或拆分状态
		// var sectionKey = this.options.sectionKey || this.datatable.sectionBy;
		moduleNodes.each(function (node) {
			var mwfType = node.get("MWFtype");
			if (mwfType === "form")return;

			var _self = this;

			var tJson = this.form._getDomjson(node);
			if( tJson ){
				var json = Object.clone(tJson);

				if( !this.options.isEdited || !this.options.isEditable )json.isReadonly = true;

				var templateJsonId = json.id;

				var index = "0"; //this.options.index;

				var id;
				// if( this.datatable.isShowAllSection ){
				// 	id = this.datatable.json.id + ".." + sectionKey + "..data.." + this.options.indexInSectionLine + ".." + json.id;
				// }else if( sectionKey ){
				// 	id = this.datatable.json.id + ".." + sectionKey + "..data.." + index + ".." + json.id;
				// }else{
					id = this.datatable.json.id + "..data.." + index + ".." + json.id;
				// }

				json.id = id;
				node.set("id", id);

				// if( json.type==="Attachment" || json.type==="AttachmentDg" ){
				// 	json.type = "AttachmentDg";
				// 	json.ignoreSite = true;
				// 	json.site = this.getAttachmentSite(json, templateJsonId, sectionKey);
				// }

				if (this.form.all[id]) this.form.all[id] = null;
				if (this.form.forms[id])this.form.forms[id] = null;

				var hasData = this.data.hasOwnProperty(templateJsonId);

				var module = this.form._loadModule(json, node, function () {

					// this.field = false; //不希望保存数据
					// this._getBusinessData = function(){
					// 	return _self.data[templateJsonId];
					// };
					// this._setBusinessData = function () {};

					if( _self.widget )this.widget = _self.widget;
					this.parentLine = _self;
					this.parentDatatable = _self.datatable;

					//只读方法值在页面加载的时候或者new的时候计算一下
					if( this.json.compute === "show" ){
						var needComputeShow = false;
						if( _self.datatable.loading ) {
							needComputeShow = true;
						}else if( _self.options.isNew && !_self.reloading ){
							needComputeShow = true;
						}
						if( !needComputeShow ){
							this.json.compute = "create"; //
							if( this.options.moduleEvents && this.options.moduleEvents.length ){ //恢复compute
								var eventName = ( this.options.moduleEvents || [] ).contains("afterLoad") ? "afterLoad" : "load";
								var resetCompute = function () {
									this.json.compute = "show";
									this.removeEvent( eventName, resetCompute );
								}.bind(this)
								this.addEvent(eventName, resetCompute);
							}
						}
					}

				}, true);
				if(!module.parentLine)module.parentLine = this;
				if(!module.parentDatatable)module.parentDatatable = this.datatable;

				this.form.modules.push(module);

				this.modules.push(module);
				this.all[id] = module;
				this.all_templateId[templateJsonId] = module;

				if (module.field) {
					if(this.options.isEdited ) {
						if (json.type !== "Attachment" && json.type !== "AttachmentDg"){
							if( module.json.compute === "save" && module.getInputData ){
								this.data[templateJsonId] = module.getInputData();
							}else{
								this.data[templateJsonId] = module.getData();
							}
						}
					}else if(!hasData && module.getValue ){
						this.data[templateJsonId] = module.getValue();
					}
					this.allField[id] = module;
					this.allField_templateId[templateJsonId] = module;
					this.fields.push( module );
				}
			}
		}.bind(this));
	},
	clearSubModules: function () { //把module清除掉
		for(var key in this.all){
			var module = this.all[key];
			//如果嵌套数据模板或者数据表格，还要清除掉下级
			if(module.clearSubModules)module.clearSubModules();
			this.form.modules.erase(module);
			// if( this.form.businessData.data.hasOwnProperty(key) )delete this.form.businessData.data[key];
			// if( this.form.Macro.environment.data.hasOwnProperty(key) )delete this.form.Macro.environment.data[key];
			if (this.form.all[key]) delete this.form.all[key];
			if (this.form.forms[key])delete this.form.forms[key];
		}
		this.node.destroy();
		this.init();
	},
	getModule: function(templateJsonId){
		return this.all_templateId[templateJsonId];
	},
	get: function(templateJsonId){
		return this.all_templateId[templateJsonId];
	},
	// computeModuleData: function( when ){
	// 	for( var key in this.allField_templateId){
	// 		var module = this.allField_templateId[key];
	// 		if( module.json.compute === when ){
	// 			this.data[key] = module.getData();
	// 		}
	// 	}
	// },
	getData: function () {
		var data = this.data;
		for( var key in this.allField_templateId){
			var module = this.allField_templateId[key];
			// var id = key.split("..").getLast();
			if( module.json.type==="Attachment" || module.json.type==="AttachmentDg" ){
				data[key] = module._getBusinessData();
			}else{
				data[key] = module.getData();
			}
		}
		return data;
	},
	// validation: function(){
	// 	if( !this.validationFields())return false;
	// 	if( !this.validationCompleteLine())return false;
	// 	return true;
	// },
	// validationFields: function(){
	// 	var flag = true;
	// 	this.fields.each(function(field, key){
	// 		if (field.json.type!="sequence" && field.validationMode ){
	// 			field.validationMode();
	// 			if (!field.validation()) flag = false;
	// 		}
	// 	}.bind(this));
	// 	return flag;
	// },
	validationCompleteLine: function(){
		var flag = true;
		if( !this.datatable.multiEditMode ){
			if (this.datatable.json.validationCompleteLine && this.datatable.json.validationCompleteLine.code){
				flag = this.form.Macro.exec(this.datatable.json.validationCompleteLine.code, this);
				if (!flag) flag = MWF.xApplication.process.Xform.LP.lineNotValidation;
			}
		}
		return flag;
	}
});

MWF.xApplication.process.Xform.DatatablePC.Exporter = new Class({
	Implements: [Options, Events],
	options: {
	},
	initialize: function (datatable, options) {

		this.setOptions(options);

		this.datatable = datatable;
		this.form = this.datatable.form;

		this.columnJsonList = [];
	},
	exportToExcel : function () {
		MWF.require("MWF.widget.Mask", null, false);
		this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
		// 适配移动端
		if (layout.mobile) {
			this.mask.load();
		} else {
			this.mask.loadNode(this.form.app.content);
		}

		this.datatable.fireEvent("beforeExport");

		this.getColumnList();

		var resultArr = [];
		var titleArr = this.getTitleArray();
		resultArr.push( titleArr );

		var lineList = [];

		if( this.datatable.isShowAllSection ){
			lineList = this.datatable.sectionLineEdited ? this.datatable.sectionLineEdited.lineList : this.datatable.lineList;
		}else if( this.datatable.isMergeRead ) {
			lineList = this.datatable.lineList;
		}else{
			lineList = this.datatable.lineList;
		}

		lineList.each(function (line, index) {
			var lineData = this.getLineExportData(line, index);
			var p = Promise.all(lineData).then(function (arr) {
				return arr;
			});
			resultArr.push( p );
		}.bind(this));

		Promise.all(resultArr).then(function ( rstArr ) {
			var colWidthArr = this.getColWidthArray();
			var excelName = this.getExcelName();

			var arg = {
				data : rstArr,
				colWidthArray : colWidthArr,
				title : excelName
			};
			this.datatable.fireEvent("export", [arg]);

			new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils( this.datatable ).exportToExcel(
				arg.data || rstArr,
				arg.title || excelName,
				arg.colWidthArray || colWidthArr,
				this.getDateIndexArray(),  //日期格式列下标
				null,
				function () {
					if (this.mask) {
						this.mask.hide();
						this.mask = null;
					}
				}.bind(this)
			);
		}.bind(this))

	},
	getColumnList: function(){
		this.columnJsonList = [];

		var ths = this.datatable.titleTr.getElements("th.mwf_origional");
		var tds = this.datatable.templateTr.getElements("td.mwf_origional");

		ths.each(function(th, index){
			var thJson = this.form._getDomjson( th );

			var mJson;
			if(tds[index]){
				var mNodes = this.form._getModuleNodes(tds[index]); //获取总计列内的填写组件
				if( mNodes.length > 0 )mJson = this.form._getDomjson(mNodes[0]);
			}

			if(thJson && mJson && this.isAvaliableColumn(thJson, mJson)){
				this.columnJsonList.push({
					"thJson": thJson,
					"title": th.get("text"),
					"mJson" : mJson,
					"available": true
				})
			}
		}.bind(this));
	},
	getLineExportData: function(line, index ){
		var exportData = [];
		this.columnJsonList.each(function (column) {

			var module;
			if( column.mJson && column.available ){
				module = line.all_templateId[column.mJson.id];
			}
			if ( !module ) {
				exportData.push("");
			}else{
				var text;
				if ( column.mJson.type === "Label" && module.node) {
					text = module.node.get("text");
				}else{
					text = module.getExcelData();
				}

				if( !text && o2.typeOf(text) !== "number" ){
					text = "";
				}

				exportData.push( text );
			}
		}.bind(this));
		return exportData;
	},
	// getLineExportData: function(line, index ){
	// 	var exportData = [];
	// 	this.columnJsonList.each(function (column) {
	//
	// 		var module;
	// 		if( column.mJson && column.available ){
	// 			module = line.all_templateId[column.mJson.id];
	// 		}
	// 		if ( !module ) {
	// 			exportData.push("");
	// 		}else{
	// 			var value = module.getData();
	// 			var text = "";
	//
	// 			if( value ){
	// 				switch (column.mJson.type) {
	// 					case "Org":
	// 					case "Reader":
	// 					case "Author":
	// 					case "Personfield":
	// 					case "Orgfield":
	// 						if (o2.typeOf(value) === "array") {
	// 							var textArray = [];
	// 							value.each(function (item) {
	// 								if (o2.typeOf(item) === "object") {
	// 									textArray.push(item.distinguishedName);
	// 								} else {
	// 									textArray.push(item);
	// 								}
	// 							}.bind(this));
	// 							text = textArray.join(", \n");
	// 						} else if (o2.typeOf(value) === "object") {
	// 							text = value.distinguishedName;
	// 						} else {
	// 							text = value;
	// 						}
	// 						break;
	// 					case "Combox":
	// 					case "Address":
	// 						text = o2.typeOf(value) === "array" ? value.join(", ") : value;
	// 						break;
	// 					case "Checkbox":
	// 						var options = module.getOptionsObj();
	// 						var value = o2.typeOf(value) === "array" ? value : [value];
	// 						var arr = [];
	// 						value.each( function( a, i ){
	// 							var idx = options.valueList.indexOf( a );
	// 							arr.push( idx > -1 ? options.textList[ idx ] : "") ;
	// 						});
	// 						text = arr.join(", ");
	// 						break;
	// 					case "Radio":
	// 					case "Select":
	// 						var options = module.getOptionsObj();
	// 						var idx = options.textList.indexOf( value );
	// 						text = idx > -1 ? options.valueList[ idx ] : "";
	// 						break;
	// 					case "Textarea":
	// 						text = value;
	// 						break;
	// 					case "Calendar":
	// 						text = value;
	// 						break;
	// 					case "Elautocomplete":
	// 						text = value;
	// 						break;
	// 					case "Elcascader":
	// 						if( typeOf(value) === "text" )
	// 						break;
	// 					default:
	// 						text = value;
	// 						break;
	// 				}
	// 			} else if ( column.mJson.type === "Label" && module.node) {
	// 				text = module.node.get("text");
	// 			}
	//
	// 			if( !text && o2.typeOf(text) !== "number" ){
	// 				text = "";
	// 			}
	//
	// 			exportData.push( text );
	// 		}
	// 	}.bind(this));
	// 	return exportData;
	// },
	isAvaliableColumn : function(thJson, mJson){
		if (thJson && ( thJson.isShow === false || thJson.isImpExp === false ))return false; //隐藏列，不允许导入导出
		if (mJson && (mJson.type == "sequence" || mJson.cellType == "sequence") )return false; //序号列
		if (mJson && ["Image","Button","ImageClipper","WritingBoard","Attachment","AttachmentDg","Label",
			"Elbutton","Elcarousel","Eldropdown","Elicon","Eltree"].contains(mJson.type) )return false; //图片，附件,Label列不导入导出
		// if (type==="import" && module && ["Label"].contains(module.json.type))return false; //Label 不导入
		return true;
	},
	getColWidthArray : function(){
		var colWidthArr = [];
		this.columnJsonList.each(function(c, index){
			if ( c.available ) {
				if (c.mJson && ["Org","Reader","Author","Personfield","Orgfield"].contains(c.mJson.type)) {
					colWidthArr.push(340);
				} else if (c.mJson && c.mJson.type === "Address") {
					colWidthArr.push(170);
				} else if (c.mJson && c.mJson.type === "Textarea") {
					colWidthArr.push(260);
				} else if (c.mJson && c.mJson.type === "Htmleditor") {
					colWidthArr.push(500);
				} else if (c.mJson && c.mJson.type === "TinyMCEEditor") {
					colWidthArr.push(500);
				} else if (c.mJson && c.mJson.type === "Calendar") {
					colWidthArr.push(150);
				} else {
					colWidthArr.push(150);
				}
			}
		}.bind(this));
		return colWidthArr;
	},
	getDateIndexArray : function(){
		var dateIndexArr = []; //日期格式列下标
		var idx=0;
		this.columnJsonList.each(function(c){
			if ( c.available && c.mJson ) {
				if(c.mJson.type === "Calendar")dateIndexArr.push(idx);
				idx++;
			}
		}.bind(this));
		return dateIndexArr;
	},
	getTitleArray : function(){
		var arr = [];
		this.columnJsonList.each(function(c, index){
			if ( c.available && c.mJson )arr.push(c.title);
		}.bind(this));
		return arr;
	},
	getExcelName: function(){
		var title;
		if( this.datatable.json.excelName && this.datatable.json.excelName.code ){
			title = this.form.Macro.exec(this.datatable.json.excelName.code, this);
		}else{
			title = MWF.xApplication.process.Xform.LP.datatableExportDefaultName;
		}
		var titleA = title.split(".");
		if( ["xls","xlst"].contains( titleA[titleA.length-1].toLowerCase() ) ){
			titleA.splice( titleA.length-1 );
		}
		title = titleA.join(".");
		return title;
	},

	exportWithImportDataToExcel : function ( importedData ) {
		MWF.require("MWF.widget.Mask", null, false);
		this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
		// 适配移动端
		if (layout.mobile) {
			this.mask.load();
		} else {
			this.mask.loadNode(this.form.app.content);
		}


		this.datatable.fireEvent("beforeExport");

		this.getColumnList();

		var resultArr = [];

		var titleArr = this.getTitleArray("import");
		titleArr.push( MWF.xApplication.process.Xform.LP.validationInfor );
		resultArr.push( titleArr );

		importedData.each( function( lineData, lineIndex ){
			var array = [];
			this.columnJsonList.each( function (obj, i) {
				array.push( ( lineData[ obj.title ] || '' ).replace(/&#10;/g, "\n") );
			});
			array.push( lineData.errorTextListExcel ? lineData.errorTextListExcel.join("\n") : ""  );

			resultArr.push( array );
		}.bind(this));

		var colWidthArr = this.getColWidthArray();
		colWidthArr.push( 300 ); //提示信息

		var excelName = this.getExcelName();

		var arg = {
		    data : resultArr,
		    colWidthArray : colWidthArr,
		    title : excelName,
		    withError : true
		};
		this.datatable.fireEvent("export", [arg]);

		new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils( this.datatable ).exportToExcel(
		    arg.data || resultArr,
		    arg.title || excelName,
		    arg.colWidthArray || colWidthArr,
		    this.getDateIndexArray(), //日期格式列下标
			null,
			function () {
				if (this.mask) {
					this.mask.hide();
					this.mask = null;
				}
			}.bind(this)
		 );
	}
});

MWF.xApplication.process.Xform.DatatablePC.Importer = new Class({
	Implements: [Options, Events],
	options: {
	},
	initialize: function (datatable, options) {

		this.setOptions(options);

		this.datatable = datatable;
		this.form = this.datatable.form;

		this.lp = MWF.xApplication.process.Xform.LP;
		this.columnText =  this.lp.importValidationColumnText;
		this.columnTextExcel = this.lp.importValidationColumnTextExcel;
		this.excelUtil = new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils( this.datatable );

		this.columnJsonList = [];
	},
	isAvaliableColumn : function(thJson, mJson){
		if (thJson && ( thJson.isShow === false || thJson.isImpExp === false ))return false; //隐藏列，不允许导入导出
		if (mJson && (mJson.type == "sequence" || mJson.cellType == "sequence") )return false; //序号列
		if (mJson && ["Image","Button","ImageClipper","WritingBoard","Attachment","AttachmentDg","Label",
			"Elbutton","Elbutton","Elcarousel","Eldropdown","Elicon","Eltree"].contains(mJson.type) )return false; //图片，附件,Label列不导入导出
		// if (type==="import" && module && ["Label"].contains(module.json.type))return false; //Label 不导入
		return true;
	},
	importFromExcel : function () {
		this.datatable.fireEvent("beforeImport");

		this.getColumnList();
		var dateColArray = this.getDateIndexArray(); //日期列
		var orgTitleArray = this.getOrgTitleArray();

		this.excelUtil.upload( dateColArray, function (data) {

			MWF.require("MWF.widget.Mask", null, false);
			this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
			// 适配移动端
			if (layout.mobile) {
				this.mask.load();
			} else {
				this.mask.loadNode(this.form.app.content);
			}

			this.importedData = data;
			if( !this.checkCount() )return;

			this.loadSimulateModule();
			this.columnJsonList.each(function (c) {
				c.module = this.importerLine.getModule(c.mJson.id)
			}.bind(this));

			if( orgTitleArray.length > 0 ){
				this.listAllOrgData( orgTitleArray, function () {
					this.checkAndImport();
				}.bind(this));
			}else{
				this.checkAndImport();
			}


		}.bind(this));
	},
	checkAndImport: function () {
		this.checkData( function (flag) {

			if( !flag ){
				this.openErrorDlg();
			}else{
				this.importData()
			}
			this.destroySimulateModule();

		}.bind(this));
	},
	destroySimulateModule: function(){
		if( !this.importerDatatable ){
			this.form.disallowSaving = false;
			return;
		}

		this.importerDatatable.destroy();
		this.importerDatatable = null;
		this.form.disallowSaving = false;
	},
	loadSimulateModule: function(){
		this.form.disallowSaving = true;
		this.importerDatatable = new MWF.xApplication.process.Xform.DatatablePC.ImporterDatabale( this.datatable );
		this.importerDatatable.load();

		this.importerLine = this.importerDatatable.addLine({});
	},
	getColumnList: function(){
		this.columnJsonList = [];

		var ths = this.datatable.titleTr.getElements("th.mwf_origional");
		var tds = this.datatable.templateTr.getElements("td.mwf_origional");
		var idx = 0;

		ths.each(function(th, index){
			var thJson = this.form._getDomjson( th );

			var mJson;
			if(tds[index]){
				var mNodes = this.form._getModuleNodes(tds[index]); //获取总计列内的填写组件
				if( mNodes.length > 0 )mJson = this.form._getDomjson(mNodes[0]);
			}

			if(thJson && mJson && this.isAvaliableColumn(thJson, mJson)){
				this.columnJsonList.push({
					"thJson": thJson,
					"title": th.get("text"),
					"mJson" : mJson,
					"field": mJson.id,
					"index": idx,
					// "module": this.importerLine.getModule(mJson.id)
					// "module": this.simelateModuleMap[mJson.id]
				});
				idx++;
			}
		}.bind(this));

		return this.columnJsonList;
	},
	getDateIndexArray : function(){
		var dateIndexArr = []; //日期格式列下标
		var idx=0;
		this.columnJsonList.each(function(c){
			if ( c.mJson && c.mJson.type === "Calendar" && (c.mJson.format === "%Y-%m-%d" || c.mJson.format === "%Y-%m-%d %H:%M:%S")) {
				dateIndexArr.push(idx);
			}
			idx++;
		}.bind(this));
		return dateIndexArr;
	},
	getOrgTitleArray : function(){
		var orgTitleArr = [];
		this.columnJsonList.each(function(c){
			if ( c.mJson && ["Org","Reader","Author","Personfield","Orgfield"].contains(c.mJson.type) ) {
				orgTitleArr.push(c.title);
			}
		}.bind(this));
		return orgTitleArr;
	},
	parseImportedData: function(){
		var data = [];
		this.importedData.each( function( ilineData ){
			var lineData = {};

			this.columnJsonList.each( function (obj, i) {
				var index = obj.index;
				var module = obj.module;
				var json = obj.mJson;
				var text = obj.title;

				var d = ilineData[text] || "";

				var value;
				if( d === "" || d === undefined || d === null ){
					value = "";
				}else{
					switch (json.type) {
						case "Org":
						case "Reader":
						case "Author":
						case "Personfield":
						case "Orgfield":
							var arr = this.stringToArray(d);
							if( arr.length === 0 ){
								value = this.getOrgData( d );
							}else{
								value = [];
								arr.each( function(d, idx){
									var obj = this.getOrgData( d );
									value.push( obj );
								}.bind(this));
							}
							break;
						default:
							value = d; //换行符&#10;
							break;
					}
				}

				lineData[ json.id ] = value;

			}.bind(this));

			data.push( lineData );
		}.bind(this));

		return data;
	},
	stringToArray: function(string){
		return string.replace(/&#10;/g,",").split(/\s*,\s*/g ).filter(function(s){
			return !!s;
		});
	},
	importData: function(){
		var data = this.parsedData; //this.parseImportedData(idata);

		this.datatable.fireEvent("import", [data] );

		this.datatable.setData( { "data" : data } );

		this.datatable.fireEvent("afterImport", [data] );

		this.datatable.fireEvent("change", [{lines: this.datatable.lineList, type : "import"}]);

		if (this.mask) {
			this.mask.hide();
			this.mask = null;
		}

		this.form.notice( MWF.xApplication.process.Xform.LP.importSuccess );

	},
	openErrorDlg : function(){
		var eData = this.importedData;
		var _self = this;

		var objectToString = function (obj, type) {
			if(!obj)return "";
			var arr = [];
			Object.each(obj,  function (value, key) {
				if( type === "style" ){
					arr.push( key + ":"+ value +";" )
				}else{
					arr.push( key + "='"+ value +"'" )
				}
			})
			return arr.join(" ")
		}

		var htmlArray = ["<table "+ objectToString( this.datatable.json.impExpTableProperties ) +" style='"+objectToString( this.datatable.json.impExpTableStyles, "style" )+"'>"];

		var titleStyle = objectToString(this.datatable.json.impExpTableTitleStyles, "style");
		htmlArray.push("<tr>");
		this.columnJsonList.each(function (obj, i) {
			htmlArray.push( "<th style='"+titleStyle+"'>"+obj.title+"</th>" );
		});
		htmlArray.push("<th style='"+titleStyle+"'> "+MWF.xApplication.process.Xform.LP.validationInfor +"</th>");
		htmlArray.push("</tr>" );

		var contentStyles = Object.clone( this.datatable.json.impExpTableContentStyles );
		if( !contentStyles[ "border-bottom" ] && !contentStyles[ "border" ] )contentStyles[ "border-bottom" ] = "1px solid #eee";
		var contentStyle = objectToString( Object.merge( contentStyles, {"text-align":"left"}) , "style" );

		eData.each( function( lineData, lineIndex ){

			htmlArray.push( "<tr>" );
			this.columnJsonList.each( function (obj, i) {
				htmlArray.push( "<td style='"+contentStyle+"'>"+ ( lineData[ obj.title ] || '' ).replace(/&#10;/g,"<br/>") +"</td>" ); //换行符&#10;
			});
			htmlArray.push( "<td style='"+contentStyle+"'>"+( lineData.errorTextList ? lineData.errorTextList.join("<br/>") : "" )+"</td>" );
			htmlArray.push( "</tr>" );

		}.bind(this));
		htmlArray.push( "</table>" );

		var width = this.datatable.json.impExpDlgWidth || 1000;
		var height = this.datatable.json.impExpDlgHeight || 700;
		width = width.toInt();
		height = height.toInt();

		var div = new Element("div", { style : "padding:10px;", html : htmlArray.join("") });
		var dlg = o2.DL.open({
			"style" : this.form.json.dialogStyle || "user",
			"title": MWF.xApplication.process.Xform.LP.importFail,
			"content": div,
			"offset": {"y": 0},
			"isMax": true,
			"width": width,
			"height": height,
			"buttonList": [
				{
					"type": "exportWithError",
					"text": MWF.xApplication.process.Xform.LP.datagridExport,
					"action": function () { _self.exportWithImportDataToExcel(eData); }
				},
				{
					"type": "cancel",
					"text": MWF.LP.process.button.cancel,
					"action": function () { dlg.close(); }
				}
			],
			"onPostClose": function(){
				dlg = null;
			}.bind(this)
		});

		if (this.mask) {
			this.mask.hide();
			this.mask = null;
		}

	},
	checkCount: function(){
		var idata = this.importedData;

		var lp = MWF.xApplication.process.Xform.LP;

		var exceeded = false;
		var maxCount = this.datatable.json.maxCount ? this.datatable.json.maxCount.toInt() : 0;
		if( maxCount > 0 && idata.length > maxCount )exceeded = true;

		var less = false;
		var minCount = this.datatable.json.minCount ? this.datatable.json.minCount.toInt() : 0;
		if( minCount > 0 && idata.length < minCount) less = true;

		if( exceeded ) {
			var text = lp.importTooManyNotice.replace("{n1}", idata.length).replace("{n2}", this.datatable.json.maxCount);
			this.form.notice(text, "error");
			return false;
		}

		if( less ){
			var text = lp.importTooFewNotice.replace("{n1}", idata.length).replace("{n2}", this.datatable.json.minCount );
			this.form.notice(text,"error");
			return false;
		}
		return true;
	},
	checkData : function( callback){
		this.parsedData = this.parseImportedData();
		this.isImportSuccess = true;

		this.checkLineData(0, function () {
			var arg = {
				validted : this.isImportSuccess,
				data : this.importedData
			};
			this.datatable.fireEvent( "validImport", [arg] );
			callback( arg.validted )
		}.bind(this));
	},
	checkLineData: function(lineIndex, callback){
		if( lineIndex < this.importedData.length ){
			this._checkLineData(this.importedData[lineIndex], lineIndex, function (flag) {
				lineIndex++;
				if( !flag )this.isImportSuccess = false;
				this.checkLineData(lineIndex, callback);
			}.bind(this));
		}else{
			if(callback)callback();
		}
	},
	_checkLineData: function(lineData, lineIndex, callback){
		lineData.errorTextList = lineData.errorTextList || [];
		lineData.errorTextListExcel = lineData.errorTextListExcel || [];

		var parsedLineData = (this.parsedData && this.parsedData[lineIndex]) ? this.parsedData[lineIndex] : [];

		this.checkModuleData(0, lineData, parsedLineData, function () {
			var flag = !lineData.errorTextList.length;
			callback(flag);
		});
	},
	checkModuleData: function(index, lineData, parsedLineData, callback){
		if( index < this.columnJsonList.length ){
			var result = this._checkModuleData(this.columnJsonList[index], lineData, parsedLineData);
			Promise.resolve(result).then(function (flag) {
				index++;
				this.checkModuleData(index, lineData, parsedLineData, callback);
			}.bind(this))
		}else{
			if(callback)callback();
		}
	},
	_checkModuleData: function (columnJson, lineData, parsedLineData) {
		var index = columnJson.index;
		var json = columnJson.mJson;
		var module = columnJson.module;
		var text = columnJson.title;

		var colInfor = this.columnText.replace( "{n}", index+1 );
		var colInforExcel = this.columnTextExcel.replace( "{n}", this.excelUtil.index2ColName( index ) );

		var d = lineData[text] || "";
		var parsedD = parsedLineData[json.id] || "";
		var lp = this.lp;
		var flag = true;

		if(d){
			switch (json && json.type) {
				case "Org":
				case "Reader":
				case "Author":
				case "Personfield":
				case "Orgfield":
					var arr = this.stringToArray(d);
					arr.each( function(d, idx){
						var obj = this.getOrgData( d );
						if( obj.errorText ){
							lineData.errorTextList.push( colInfor + obj.errorText + lp.fullstop );
							lineData.errorTextListExcel.push( colInforExcel + obj.errorText + lp.fullstop );
							flag = false;
						}
					}.bind(this));
					break;
				case "Number":
				case "Currency":
				case "OOCurrency":
				case "Elnumber":
					if (isNaN(d)){
						lineData.errorTextList.push( colInfor + d + lp.notValidNumber + lp.fullstop );
						lineData.errorTextListExcel.push( colInforExcel + d + lp.notValidNumber + lp.fullstop );
						flag = false;
					}
					break;
				case "Calendar":
				case "Eldate":
				case "Eldatetime":
					if( json.format === "%Y-%m-%d" || json.format === "%Y-%m-%d %H:%M:%S" ){
						if( !( isNaN(d) && !isNaN(Date.parse(d) ))){
							lineData.errorTextList.push(colInfor + d + lp.notValidDate + lp.fullstop );
							lineData.errorTextListExcel.push( colInforExcel + d + lp.notValidDate + lp.fullstop );
							flag = false;
						}
					}
					break;
				default:
					break;
			}
		}
		if (module && module.setData && json.type !== "Address"){
			var hasError = false;
			if(["Org","Reader","Author","Personfield","Orgfield"].contains(json.type)){
				if(o2.typeOf(parsedD)==="array" && parsedD.length){
					hasError = parsedD.some(function (item) { return item.errorText; });
					flag = false;
				}
			}
			if(!hasError){
				module.setExcelData(parsedD);
				var ps = [];
				if( module.moduleExcelAG )ps.push( module.moduleExcelAG );
				if( module.moduleValueAG && !ps.contains(module.moduleValueAG) )ps.push( module.moduleValueAG );
				if( module.moduleSelectAG && !ps.contains(module.moduleSelectAG) )ps.push( module.moduleSelectAG );
				return Promise.all( ps ).then(function () {
					var result = module.validationExcel();
					if ( result && result.length ){
						lineData.errorTextList.push(colInfor + result.join("\n") );
						lineData.errorTextListExcel.push( colInforExcel + result.join("\n"));
						flag = false;
					}
					parsedLineData[json.id] = module.getData();
					return flag;
				})
			}
		}
		return flag
	},
	exportWithImportDataToExcel: function(eData){
		var exporter = new MWF.xApplication.process.Xform.DatatablePC.Exporter(this.datatable);
		exporter.exportWithImportDataToExcel(eData)
	},
	getOrgData : function( str ){
		str = str.trim();
		var flag = str.substr(str.length-2, 2);
		switch (flag.toLowerCase()){
			case "@i":
				return this.identityMap[str] || {"errorText": str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			case "@p":
				return this.personMap[str] || {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			case "@u":
				return this.unitMap[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			case "@g":
				return this.groupMap[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			default:
				return this.identityMap[str] ||
					this.personMap[str] ||
					this.unitMap[str] ||
					this.groupMap[str] ||
					{"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };

		}
	},
	listAllOrgData : function (orgTitleList, callback) {
		var identityList = [], personList = [], unitList = [], groupList = [];
		if( orgTitleList.length > 0 ){
			this.importedData.each( function( lineData, lineIndex ){
				// if( lineIndex === 0 )return;

				orgTitleList.each( function (title, index) {

					if( !lineData[title] )return;

					var arr = this.stringToArray(lineData[title]);
					arr.each( function( a ){
						a = a.trim();
						var flag = a.substr(a.length-2, 2);
						switch (flag.toLowerCase()){
							case "@i":
								identityList.push( a ); break;
							case "@p":
								personList.push( a ); break;
							case "@u":
								unitList.push( a ); break;
							case "@g":
								groupList.push( a ); break;
							default:
								identityList.push( a );
								personList.push( a );
								unitList.push( a );
								groupList.push( a );
								break;
						}
					})
				}.bind(this))
			}.bind(this));
			var identityLoaded, personLoaded, unitLoaded, groupLoaded;
			var check = function () {
				if( identityLoaded && personLoaded && unitLoaded && groupLoaded ){
					if(callback)callback();
				}
			};

			this.identityMap = {};
			if( identityList.length ){
				identityList = identityList.unique();
				o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({ identityList : identityList }, function (json) {
					json.data.each( function (d) { this.identityMap[ d.matchKey ] = d; }.bind(this));
					identityLoaded = true;
					check();
				}.bind(this))
			}else{
				identityLoaded = true;
				check();
			}

			this.personMap = {};
			if( personList.length ){
				personList = personList.unique();
				o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({ personList : personList }, function (json) {
					json.data.each( function (d) { this.personMap[ d.matchKey ] = d; }.bind(this));
					personLoaded = true;
					check();
				}.bind(this))
			}else{
				personLoaded = true;
				check();
			}

			this.unitMap = {};
			if( unitList.length ){
				unitList = unitList.unique();
				o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({ unitList : unitList }, function (json) {
					json.data.each( function (d) { this.unitMap[ d.matchKey ] = d; }.bind(this));
					unitLoaded = true;
					check();
				}.bind(this))
			}else{
				unitLoaded = true;
				check();
			}

			this.groupMap = {};
			if( groupList.length ){
				groupList = groupList.unique();
				o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({ groupList : groupList }, function (json) {
					json.data.each( function (d) { this.groupMap[ d.matchKey ] = d; }.bind(this));
					groupLoaded = true;
					check();
				}.bind(this))
			}else{
				groupLoaded = true;
				check();
			}
		}
	}
});

MWF.xDesktop.requireApp("Template", "utils.ExcelUtils", null, false);
MWF.xApplication.process.Xform.DatatablePC.ExcelUtils = new Class({
	Extends: MWF.xApplication.Template.utils.ExcelUtils,
	initialize: function(){
		this.sheet2JsonOptions = {};
		this.pollyfill();
	}
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class DatatableMobile 数据表格组件（移动端）。表格形式的多行数据编辑组件。
 * @o2cn 数据表格移动端
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datatable = this.form.get("name"); //获取组件
 * //方法2
 * var datatable = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.DatatablePC
 * @o2category FormComponents
 * @since v6.2
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.DatatableMobile = new Class(
	/** @lends MWF.xApplication.process.Xform.DatatablePC# */
	{
		Implements: [Events],
		Extends: MWF.xApplication.process.Xform.DatatablePC,
		loadDatatable: function(){
			this.loading = true;
			this._loadStyles();

			this._loadTitleTr();
			this._loadTemplate();
			this._createTemplateTable();
			this._loadTotalTr();

			this.fireEvent("load");

			this._loadDatatable(function(){
				this._loadImportExportAction();
				this.fieldModuleLoaded = true;
				this.loading = false;
				this.fireEvent("postLoad");
			}.bind(this));
		},
		_removeEl: function(){
			if( this.templateNode )this.templateNode.destroy();

			if( this.totalDiv ){
				this.totalDiv.destroy();
				this.totalDiv = null;
			}
		},
		_loadTitleTr: function(){
			this.titleTr = this.table.getElement("tr");

			var ths = this.titleTr.getElements("th");
			if (this.json.border){
				ths.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border
				});
			}
			if (this.json.titleStyles)ths.setStyles(this.json.titleStyles);

			//datatable$Title Module
			ths.each(function(th, index){
				var json = this.form._getDomjson(th);
				// th.store("dataTable", this);
				th.addClass("mwf_origional");
				if (json){
					// var module = this.form._loadModule(json, th);
					// this.form.modules.push(module);
					// if( json.isShow === false )th.hide(); //隐藏列
					if((json.total === "number") || (json.total === "count"))this.totalFlag = true;
				}
			}.bind(this));
		},
		_loadTemplate: function(){
			this.templateJson = {};

			var trs = this.table.getElements("tr");
			this.templateTr = trs[trs.length-1];

			var tds = this.templateTr.getElements("td");
			if (this.json.border) {
				tds.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border,
					"background": "transparent"
				});
			}
			if (this.json.contentStyles)tds.setStyles(this.json.contentStyles);

			//datatable$Data Module
			var idx = 0;
			tds.each(function(td, index){
				var json = this.form._getDomjson(td);
				// td.store("dataTable", this);
				td.addClass("mwf_origional");
				if (json){
					// var module = this.form._loadModule(json, td);
					// this.form.modules.push(module);
					if( json.cellType === "sequence" )td.addClass("mwf_sequence"); //序号列

					if( json.isShow === false ){
						td.hide(); //隐藏列
					}else{
						if ((idx%2)===0 && this.json.zebraColor){
							td.setStyle("background-color", this.json.zebraColor);
						}else if(this.json.backgroundColor){
							td.setStyle("background-color", this.json.backgroundColor);
						}
						idx++;
					}
				}
			}.bind(this));

			// var moduleNodes = this.form._getModuleNodes(this.templateTr);
			// moduleNodes.each(function (node) {
			// 	if (node.get("MWFtype") !== "form") {
			// 		var json = this.form._getDomjson(node);
			// 		this.templateJson[json.id] = json ;
			// 	}
			// }.bind(this));
			this.templateTr.hide();
		},
		_createTemplateTable: function(){
			this.templateNode = new Element("div").inject(this.node);

			var titleDiv = new Element("div", {"styles": this.json.itemTitleStyles}).inject(this.templateNode);
			titleDiv.setStyle("overflow", "hidden");
			new Element("div.sequenceDiv", {
				"styles": {"float": "left"},
				"text": MWF.xApplication.process.Xform.LP.item
			}).inject(titleDiv);
			new Element("div.mwf_sequence", { "styles": {"float": "left"} }).inject(titleDiv);
			new Element("div.mwf_editaction", { "styles": this.form.css.mobileDatagridActionNode }).inject(titleDiv);

			var table = new Element("table").inject(this.templateNode);
			if (this.json.border) {
				table.setStyles({
					"border-top": this.json.border,
					"border-left": this.json.border
				});
			}
			table.setStyles(this.json.tableStyles);
			table.set(this.json.properties);

			var ths = this.titleTr.getElements("th");
			var tds = this.templateTr.getElements("td");
			ths.each(function(th, index){
				var newTr = new Element("tr").inject(table);

				var thJson = this.form._getDomjson(th);
				var newTh = th.clone().inject(newTr);
				newTh.set("html", th.get("html"));
				newTh.set("MWFId",th.get("id"));
				if( thJson.isShow === false )newTr.hide();

				var moduleJson;
				var td = tds[index];
				var newTd = td.clone().inject(newTr);
				newTd.set("html", td.get("html"));
				newTd.set("MWFId",td.get("id"));
			}.bind(this));

			this.templateHtml = this.templateNode.get("html");

			this.table.hide();
			this.templateNode.hide();
		},
		_loadTotalTr: function(){
			if( !this.totalFlag )return;
			this.totalDiv = new Element("div.mwf_totaltr", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}).inject(this.node);

			if( this.isShowSectionKey() && !(this.json.totalRowBySection || [] ).contains("module")){
				this.totalDiv.hide()
			}
			if( this.isShowSectionBy() && !(this.json.totalRowBy || [] ).contains("module") ){
				this.totalDiv.hide()
			}

			var titleDiv = new Element("div", {"styles": this.json.itemTitleStyles}).inject(this.totalDiv);
			titleDiv.setStyle("overflow", "hidden");
			new Element("div.sequenceDiv", {
				"styles": {"float": "left"},
				"text": MWF.xApplication.process.Xform.LP.amount
			}).inject(titleDiv);

			this.totalTable = new Element("table").inject(this.totalDiv);
			if (this.json.border) {
				this.totalTable.setStyles({
					"border-top": this.json.border,
					"border-left": this.json.border
				});
			}
			this.totalTable.setStyles(this.json.tableStyles);
			this.totalTable.set(this.json.properties);

			var ths = this.titleTr.getElements("th");
			var idx = 0;
			//datatable$Title Module
			ths.each(function(th, index){
				var tr = new Element("tr").inject(this.totalTable);

				var json = this.form._getDomjson(th);
				if (json){
					if ((json.total === "number") || (json.total === "count")){

						var datath = new Element("th").inject(tr);
						datath.set("text", th.get("text"));
						if (this.json.border){
							ths.setStyles({
								"border-bottom": this.json.border,
								"border-right": this.json.border
							});
						}
						datath.setStyles(this.json.titleStyles);

						var datatd = new Element("td").inject(tr);
						if (this.json.border) {
							datatd.setStyles({
								"border-bottom": this.json.border,
								"border-right": this.json.border,
								"background": "transparent"
							});
						}
						datatd.setStyles(this.json.amountStyles);

						if( json.isShow === false ){
							tr.hide(); //隐藏列
						}else{
							if ((idx%2)===0 && this.json.zebraColor){
								datatd.setStyle("background-color", this.json.zebraColor);
							}else if(this.json.backgroundColor){
								datatd.setStyle("background-color", this.json.backgroundColor);
							}
							idx++;
						}

						this.totalColumns.push({
							"th" : datath,
							"td" : datatd,
							"index": index,
							"type": json.total
						})
					}
				}
			}.bind(this));

			var tds = this.templateTr.getElements("td");
			//datatable$Data Module
			tds.each(function(td, index){
				var json = this.form._getDomjson(td);
				if (json){
					//总计列
					var tColumn = this.totalColumns.find(function(a){ return  a.index === index });
					if(tColumn){
						var moduleNodes = this.form._getModuleNodes(td); //获取总计列内的填写组件
						if( moduleNodes.length > 0 ){
							tColumn.moduleJson = this.form._getDomjson(moduleNodes[0]);
							if(tColumn.type === "number")this.totalNumberModuleIds.push( tColumn.moduleJson.id );
						}
					}
				}
			}.bind(this));
		},
		_getTotalTr: function(){
			return this.totalDiv;
		},
		_createLineNode: function(beforeNode){
			var div;
			if( beforeNode ) {
				div = new Element("div").inject(beforeNode, "after");
			}else if( this.totalDiv ){
				div = new Element("div").inject(this.totalDiv, "before");
			}else{
				div = new Element("div").inject(this.node);
			}
			return div;
		},
		_checkAddAction: function(){
			if( this.data.data && this.data.data.length > 0 ){
				if(this.addAction)this.addAction.hide();
				return;
			}
			if( !this.editable || !this.addable ){
				if(this.addAction)this.addAction.hide();
				return;
			}
			if( !this.addAction ){
				this._createAddAction();
			}else{
				this.addAction.show();
			}
		},
		_createAddAction: function(){
			if( !this.addAction ){
				this.addAction = new Element("div", {"styles": this.form.css.gridMobileActionNode}).inject(this.node, "top");
				this.addAction.set("text", MWF.xApplication.process.Xform.LP.addLine);
				this.addAction.addEvent("click", function(e){
					this._addLine();
				}.bind(this));
			}
		},
		_loadStyles: function(){
			if( this.json.recoveryStyles ){
				this.node.setStyles(this.json.recoveryStyles);
			}
			// if (this.json.border) {
			// 	this.table.setStyles({
			// 		"border-top": this.json.border,
			// 		"border-left": this.json.border
			// 	});
			// }
			// this.node.setStyles(this.json.styles);
			// this.table.setStyles(this.json.tableStyles);
			// this.table.set(this.json.properties);
		},

		_loadSectionLine_EditSection: function(container, data, index, isEdited, isNew){
			var sectionLine = new MWF.xApplication.process.Xform.DatatableMobile.SectionLine(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isEditable: this.editable && this.isSectionLineEditable(data),
				isDeleteable: this.deleteable && this.isSectionLineEditable(data),
				isAddable: this.addable && this.isSectionLineEditable(data)
			});
			// this.fireEvent("beforeLoadLine", [line]);
			sectionLine.load();
			// this.fireEvent("afterLoadLine", [line]);
			return sectionLine;
		},

		_loadSectionLine: function(container, data, index, isEdited, isNew){
			var sectionLine = new MWF.xApplication.process.Xform.DatatableMobile.SectionLine(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isEditable: this.editable,
				isDeleteable: this.deleteable,
				isAddable: this.addable,
				isMergeRead: this.isMergeRead
			});
			// this.fireEvent("beforeLoadLine", [line]);
			sectionLine.load();
			// this.fireEvent("afterLoadLine", [line]);
			return sectionLine;
		},

		_loadLine: function(container, data, index, isEdited, isNew){
			var line = new MWF.xApplication.process.Xform.DatatableMobile.Line(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isEditable: this.editable,
				isDeleteable: this.deleteable,
				isAddable: this.addable,
				isMergeRead: this.isMergeRead
			});
			this.fireEvent("beforeLoadLine", [line]);
			line.load();
			this.fireEvent("afterLoadLine", [line]);
			return line;
		},

		_loadImportExportAction: function(){
			this.impexpNode = this.node.getElement("div.impexpNode");
			if( this.impexpNode )this.impexpNode.destroy();
		}
	});

MWF.xApplication.process.Xform.DatatableMobile$Title = new Class({
	Extends: MWF.APP$Module,
	_loadUserInterface: function(){
		if(this.json.recoveryStyles){
			this.node.setStyles(this.json.recoveryStyles);
		}
		if (this.json.prefixIcon || this.json.suffixIcon){
			var text = this.node.get("text");
			this.node.empty();

			var lineheight = this.node.getStyle("line-height") || "28px";
			this.wrapNode = new Element("div", {
				"styles": {
					"display": "flex",
					"align-items": "center"
					// "justify-content": "center"
				}
			}).inject(this.node);

			if (this.json.prefixIcon){
				this.prefixNode = new Element("div", {"styles": {
						"width": "20px",
						"min-width": "20px",
						"height": lineheight,
						"background": "url("+this.json.prefixIcon+") center center no-repeat"
					}}).inject(this.wrapNode);
			}

			this.textNode = new Element("div", {"styles": {
					"line-height": lineheight,
					"vertical-align": "top",
					"padding": "1px"
				}, "text": text}).inject(this.wrapNode);

			if (this.json.suffixIcon){
				this.suffixNode = new Element("div", {"styles": {
						"width": "20px",
						"min-width": "20px",
						"height": lineheight,
						"background": "url("+this.json.suffixIcon+") center center no-repeat"
					}}).inject(this.wrapNode);
			}
		}
	}
});

MWF.xApplication.process.Xform.DatatableMobile$Data =  new Class({
	Extends: MWF.APP$Module
});

MWF.xApplication.process.Xform.DatatableMobile.SectionLine =  new Class({
	Extends: MWF.xApplication.process.Xform.DatatablePC.SectionLine,
	_loadLine: function(container, data, index, isEdited, isNew){
		var line = new MWF.xApplication.process.Xform.DatatableMobile.Line(container, this.datatable, data, {
			indexInSectionLine : index,
			indexInSectionLineText : (index+1).toString(),
			index: this.datatable.lineList.length,
			indexText : (this.datatable.lineList.length + 1).toString(),
			isNew: isNew,
			isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.options.isEdited,
			isEditable: this.options.isEditable,
			isDeleteable: this.options.isDeleteable,
			isAddable: this.options.isAddable,
			isMergeRead: this.options.isMergeRead,
			sectionKey: this.sectionKey
		}, this);
		this.datatable.fireEvent("beforeLoadLine", [line]);
		line.load();
		this.datatable.fireEvent("afterLoadLine", [line]);
		return line;
	},
	_createLineNode: function( beforeNode ){
		var div;
		if( beforeNode ){
			div = new Element("div").inject(beforeNode, "after");
		}else if( this.totalDiv ){
			div = new Element("div").inject(this.totalDiv, "before");
		}else{
			div = this.datatable._createLineNode();
			// tr = new Element("tr").inject(this.tBody || this.table);
		}
		return div;
	},
	loadSectionKeyNode: function () {
		var styleName = this.datatable.isShowSectionKey() ? "sectionKeyStyles" : "sectionByStyles";
		var sectionKeyStyles = this.datatable._parseStyles( this.datatable.json[styleName] || {} );
		var keyNode = new Element("div.mwf_sectionkey", {
			styles : sectionKeyStyles
		}).inject( this.sectionKeyNode );
		this.keyNode = keyNode;
		var separator;
		if( this.datatable.isShowSectionKey() ){
			separator = this.datatable.json.keyContentSeparator;
		}else{
			separator = this.datatable.json.keyContentSeparatorSectionBy;
		}
		this.datatable.getSectionKeyWithMerge( this.data, function (key) {
			if( o2.typeOf(key) === "string" ){
				keyNode.set("text", key + (separator || ""));
			}else{
				Promise.resolve(key).then(function (k) {
					keyNode.set("text", k + (separator || ""));
				}.bind(this))
			}
		}.bind(this));
	},
	clearSubModules: function(){
		if( this.isUnchangedAll )return;

		var map = this.unchangedLineMap || {};
		var hasUnchangedLine = Object.keys(map).length > 0;

		if( !hasUnchangedLine ){
			if( this.sectionKeyNode ){
				this.sectionKeyNode.destroy();
				this.sectionKeyNode = null;
			}
		}

		var lines = [];
		Object.values(map).each(function (d) {
			lines = lines.concat(d);
		});
		for (var i=0; i<this.lineList.length; i++){
			var l = this.lineList[i];
			if(!lines.contains(l)){
				l.clearSubModules();
			}
		}

		if( !hasUnchangedLine ) {
			if( this.totalDiv ){
				this.totalDiv.destroy();
				this.totalDiv = null;
			}
		}
	},
	_loadTotalTr: function(){
		if( !this.datatable.totalFlag )return false;
		this.totalDiv = new Element("div.mwf_totaltr", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}).inject(this.sectionKeyNode, "after");
		if( !this.isTotalTrShow() )this.totalDiv.hide();

		var titleDiv = new Element("div", {"styles": this.datatable.json.itemTitleStyles}).inject(this.totalDiv);
		titleDiv.setStyle("overflow", "hidden");
		new Element("div.sequenceDiv", {
			"styles": {"float": "left"},
			"text": MWF.xApplication.process.Xform.LP.sectionAmount
		}).inject(titleDiv);

		this.totalTable = new Element("table").inject(this.totalDiv);
		if (this.datatable.json.border) {
			this.totalTable.setStyles({
				"border-top": this.json.border,
				"border-left": this.json.border
			});
		}
		this.totalTable.setStyles(this.datatable.json.tableStyles);
		this.totalTable.set(this.datatable.json.properties);

		var ths = this.datatable.titleTr.getElements("th");
		var idx = 0;

		//datatable$Title Module
		ths.each(function(th, index){
			var tr = new Element("tr").inject(this.totalTable);

			var json = this.datatable.form._getDomjson(th);
			if (json){
				if ((json.total === "number") || (json.total === "count")){

					var datath = new Element("th").inject(tr);
					datath.set("text", th.get("text"));
					if (this.datatable.json.border){
						ths.setStyles({
							"border-bottom": this.datatable.json.border,
							"border-right": this.datatable.json.border
						});
					}
					datath.setStyles(this.datatable.json.titleStyles);

					var datatd = new Element("td").inject(tr);
					if (this.datatable.json.border) {
						datatd.setStyles({
							"border-bottom": this.datatable.json.border,
							"border-right": this.datatable.json.border,
							"background": "transparent"
						});
					}
					datatd.setStyles(this.datatable.json.sectionAmountStyles || {});

					if( json.isShow === false ){
						tr.hide(); //隐藏列
					}else{
						if ((idx%2)===0 && this.datatable.json.zebraColor){
							datatd.setStyle("background-color", this.datatable.json.zebraColor);
						}else if(this.datatable.json.backgroundColor){
							datatd.setStyle("background-color", this.datatable.json.backgroundColor);
						}
						idx++;
					}

					this.totalColumns.push({
						"th" : datath,
						"td" : datatd,
						"index": index,
						"type": json.total
					})
				}
			}
		}.bind(this));

		var tds = this.datatable.templateTr.getElements("td");
		//datatable$Data Module
		tds.each(function(td, index){
			var json = this.form._getDomjson(td);
			if (json){
				//总计列
				var tColumn = this.totalColumns.find(function(a){ return  a.index === index });
				if(tColumn){
					var moduleNodes = this.form._getModuleNodes(td); //获取总计列内的填写组件
					if( moduleNodes.length > 0 ){
						tColumn.moduleJson = this.form._getDomjson(moduleNodes[0]);
						if(tColumn.type === "number")this.totalNumberModuleIds.push( tColumn.moduleJson.id );
					}
				}
			}
		}.bind(this));
	},
	_getTotalTr: function(){
		return this.totalDiv;
	},
	getLastTr: function () {
		if( this.totalDiv )return this.totalDiv;
		if( this.lineList.length )return this.lineList.getLast().node;
		return this.sectionKeyNode;
	}
});

MWF.xApplication.process.Xform.DatatableMobile.Line =  new Class({
	Extends: MWF.xApplication.process.Xform.DatatablePC.Line,

	load: function(){
		if( !this.datatable.multiEditMode && this.options.isEdited )this.datatable.currentEditedLine = this;
		this.node.addClass("mwf_datatable");
		this.node.setStyles( Object.merge({"margin-bottom": "10px"}, this.datatable.json.styles||{} )); //"overflow": "hidden",

		this.loadModules();
		this.loadSequence();
		this.createActions();
		// this.loadZebraStyle();
		// this.loadEditedStyle();


		if( !this.datatable.multiEditMode )this.originalData = Object.clone(this.data);

		// if(this.options.isNew && this.options.isEdited){
		// 	this.data = this.getData();
		// 	if( !this.datatable.multiEditMode )this.originalData = Object.clone(this.data);
		// 	this.options.isNew = false;
		// }
	},
	createActions: function () {
		//不允许编辑，直接返回
		if(!this.options.isEditable)return;

		var editActionTd = this.node.getElement(".mwf_editaction");
		//this.moveActionTd = this.node.getElement(".moveAction");

		if(this.datatable.multiEditMode){ //多行编辑模式
			if(this.options.isDeleteable)this.createDelAction(editActionTd);
			if(this.options.isAddable)this.createAddAction(editActionTd);
		}else{ //单行编辑模式
			if(this.options.isDeleteable)this.createDelAction(editActionTd);
			if(this.options.isEditable)this.createEditAction(editActionTd);
			if(this.options.isAddable)this.createAddAction(editActionTd);
			this.createCancelEditAction(editActionTd);
			this.createCompleteAction(editActionTd);
			this.checkActionDisplay();
		}

	},
	checkActionDisplay: function(){
		if( this.options.isEdited ){
			if( this.addLineAction )this.addLineAction.hide();
			if( this.editLineAction )this.editLineAction.hide();
			if( this.delLineAction )this.delLineAction.hide();
			if( this.completeLineAction )this.completeLineAction.show();
			if( this.cancelLineEditAction )this.cancelLineEditAction.show();
		}else{
			if( this.addLineAction )this.addLineAction.show();
			if( this.editLineAction )this.editLineAction.show();
			if( this.delLineAction )this.delLineAction.show();
			if( this.completeLineAction )this.completeLineAction.hide();
			if( this.cancelLineEditAction )this.cancelLineEditAction.hide();
		}
	},
	createEditAction: function(td){
		this.editLineAction = new Element("div", {
			"styles": this.form.css.mobileDatagridEditActionNode,
			"text": MWF.xApplication.process.Xform.LP.edit,
			"events": {
				"click": function(ev){
					if( !this.options.isEdited ){
						this.datatable._changeEditedLine(this)
					}
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createAddAction: function(td){
		this.addLineAction = new Element("div", {
			"styles": this.form.css.mobileDatagridAddActionNode,
			"text": MWF.xApplication.process.Xform.LP.add,
			"events": {
				"click": function(ev){
					this.datatable._insertLine( ev, this );
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createCompleteAction: function(td){
		this.completeLineAction = new Element("div", {
			"styles": this.form.css.mobileDatagridCompleteActionNode,
			"text": MWF.xApplication.process.Xform.LP.completedEdit,
			"events": {
				"click": function(ev){
					this.datatable._completeLineEdit(ev, true);
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createCancelEditAction: function(td){
		this.cancelLineEditAction = new Element("div", {
			"styles": this.form.css.mobileDatagridDelActionNode,
			"text": MWF.xApplication.process.Xform.LP.cancelEdit,
			"events": {
				"click": function(ev){
					this.datatable._cancelLineEdit(ev, this);
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
	},
	createDelAction: function(td){
		this.delLineAction = new Element("div", {
			"styles": this.form.css.mobileDatagridCancelActionNode,
			"text": MWF.xApplication.process.Xform.LP["delete"],
			"events": {
				"click": function(ev){
					this.datatable._deleteLine( ev, this );
					// if( this.datatable.currentEditedLine === this )this.datatable.currentEditedLine = null;
					ev.stopPropagation();
				}.bind(this)
			}
		}).inject(td);
		this.delLineAction.show()
	}
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @class Textfield 文本输入框。
 * @o2cn 文本输入框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Textfield = MWF.APPTextfield =  new Class({
	Implements: [Events],
	Extends: MWF.APP$Input,
	iconStyle: "textFieldIcon",

	// _loadUserInterface: function(){
	// 	this._loadNode();
    //     if (this.json.compute === "show"){
    //         this._setValue(this._computeValue());
    //     }else{
    //         this._loadValue();
    //     }
	// },
    _loadNode: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                this._loadNodeEdit();
            }
        }
    },
    loadDescription: function(){
        if (this.isReadonly())return;
        var v = this._getBusinessData();
        if (!v && v!==0){
            if (this.json.description){
            var size, w;
                if( this.node.offsetParent === null ){ //隐藏
                    size = { y: 26 }
                }else{
                     size = this.node.getFirst().getSize();
                    //  w = size.x-3;
                    // if( this.hasIcon() ){
                    //     if (COMMON.Browser.safari) w = w-20;
                    // }
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.descriptionNode.setStyles({
                    "width": "auto",
                    "overflow": "auto"
                });
                // if( w )this.descriptionNode.setStyles({
                //     "width": ""+w+"px"
                // });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            if (COMMON.Browser.Platform.name==="ios"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                        this.node.getFirst().fireEvent("click");
                    }.bind(this)
                });
            }else if (COMMON.Browser.Platform.name==="android"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                        this.node.getFirst().fireEvent("click");
                    }.bind(this)
                });
            }else{
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                        this.node.getFirst().fireEvent("click");
                    }.bind(this)
                });
            }

            this.node.getFirst().addEvents({
                "focus": function(){
                    this.descriptionNode.setStyle("display", "none");
                }.bind(this),
                "blur": function(){
                    if (!this.node.getFirst().get("value")) this.descriptionNode.setStyle("display", "block");
                }.bind(this)
            });
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        this.clearDefaultMargin();
    },

    _resetNodeEdit: function(){
        var input = new Element("input", {
            "styles": {
                "background": "transparent",
                "width": (this.json.inputStyles && this.json.inputStyles.width) ? this.json.inputStyles.width : "100%",
                "display": "block",
                "border": "0px"
            }
        });

        var node = new Element("div", {"styles": {
                "overflow": (this.json.styles && this.json.styles.overflow) ? this.json.styles.overflow : "hidden",
                "position": "relative",
                "margin-right": this.hasIcon() ? "20px" : "0px",
                "padding-right": "4px"
            }}).inject(this.node, "after");
        input.inject(node);

        this.node.destroy();
        this.node = node;
    },

    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        if( !input && this.nodeHtml){
            this.node.set("html", this.nodeHtml);
            input = this.node.getFirst();
        }
        input.set(this.json.properties);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon){
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle]
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon);
        }

        this.node.getFirst().addEvent("change", function(){
            var v = this.getInputData("change");
            //this._setBusinessData(v);
            this.validationMode();
            if (this.validation()) {
                this._setBusinessData(v);
                this.fireEvent("change");
            }
        }.bind(this));

        var inputNode = this.node.getFirst();
        if (inputNode) inputNode.addEvent("input", function(e){
            var v=e.target.get("value");
            this._setBusinessData(v);
        }.bind(this));

        if (this.json.ANNModel){
            this.node.getFirst().addEvent("focus", function(){
                o2.Actions.get("x_query_assemble_surface").calculateNeural(this.json.ANNModel, this.form.businessData.work.id, function(json){
                    var arr = json.data.filter(function(d){
                        var value = this.node.getFirst().get("value");
                        return d.score>0.1 && (value.indexOf(d.value)===-1)
                    }.bind(this));
                    if (arr.length){
                        if (!this.modelNode) this.createModelNode();
                        this.modelNode.getLast().empty();
                        this.modelNode.show();
                        this.modelNode.position({ "relativeTo": this.node, "position": "bottomLeft", "edge": 'upperLeft' });

                        arr.each(function(v){
                            var node = new Element("div", {"text": v.value, "styles": this.form.css.modelItemNode}).inject(this.modelNode.getLast());
                            node.addEvents({
                                "mouseover": function(){this.setStyle("color", "#0000ff");},
                                "mouseout": function(){this.setStyle("color", "#a31515");},
                                "mousedown": function(e){
                                    var str = this.node.getFirst().get("value")
                                    this.node.getFirst().set("value", ((str) ? str+", "+e.target.get("text") : e.target.get("text")));
                                    this.modelNode.hide();
                                }.bind(this)
                            });
                        }.bind(this));
                    }
                }.bind(this));
            }.bind(this));

            this.node.getFirst().addEvent("blur", function(){
                if (this.modelNode) this.modelNode.hide();
            }.bind(this));
        }

        this.node.getFirst().addEvent("blur", function(){
            this.validation();
        }.bind(this));
        this.node.getFirst().addEvent("keyup", function(){
            this.validationMode();
        }.bind(this));
	},
    createModelNode: function(){
        this.modelNode = new Element("div", {"styles": this.form.css.modelNode}).inject(this.node, "after");
        new Element("div", {"styles": this.form.css.modelNodeTitle, "text": MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode);
        new Element("div", {"styles": this.form.css.modelNodeContent, "text": MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode);
    },


    getInputData: function(){
        if (this.node.getFirst()){
            var v = this.node.getElement("input").get("value");
            if (this.json.dataType=="number"){
                var n = v.toFloat();
                return (isNaN(n)) ? 0 : n;
            }
        }else{
            return this._getBusinessData();
        }
        return v;
    }

});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
MWF.xDesktop.requireApp("Selector", "package", null, false);
MWF.require("MWF.widget.O2Identity", null, false);
MWF.xApplication.process.Xform.Personfield = MWF.APPPersonfield =  new Class({
    Implements: [Events],
    Extends: MWF.APP$Input,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad", "change", "select"],
        "readonly": true
    },

    iconStyle: "personfieldIcon",

    getTextData: function(){
        //var value = this.node.get("value");
        //var text = this.node.get("text");
        var value = this.getValue();
        //var text = (this.node.getFirst()) ? this.node.getFirst().get("text") : this.node.get("text");
        var text = [];
        if( typeOf( value ) === "object" )value = [value];
        if( typeOf( value ) === "array" ){
            value.each(function(v){
                if( typeOf(v) === "string" ){
                    text.push(v);
                }else{
                    text.push(v.name+((v.unitName) ? "("+v.unitName+")" : ""));
                }
            }.bind(this));
            return {"value": value || "", "text": [text.join(",")]};
        }else{
            return {"value": [""], "text": [""]};
        }
    },

    loadDescription: function(){
        if (this.isReadonly())return;
        var v = this._getBusinessData();
        if (!v || !v.length){
            if (this.json.description){
                var size = this.node.getFirst().getSize();
                var w = size.x-3;
                if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ) {
                    if (COMMON.Browser.safari) w = w - 20;
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "width": ""+w+"px",
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function( ev ){
                    this.descriptionNode.setStyle("display", "none");
                    this.clickSelect( ev );
                }.bind(this)
            });
        }
    },
    _loadNode: function(){
        if (this.isReadonly()){
            this._loadNodeRead();
        }else{
            this._getOrgOptions();
            if (this.json.isInput){
                this._loadNodeInputEdit();
            }else{
                this._loadNodeEdit();
            }

        }
    },
    _getOrgOptions: function(){
        this.selectUnits = this.getSelectRange();
        if (this.json.selectType=="identity"){
            this.selectDutys = this.getSelectRangeDuty();
        }
    },
    getScriptSelectUnit: function(){
        var rangeValues = [];
        if (this.json.rangeUnit && this.json.rangeUnit.length){
            this.json.rangeUnit.each(function(unit){
                var unitFlag = unit.distinguishedName || unit.id || unit.unique || unit.levelName;
                if (unitFlag) rangeValues.push(unitFlag);
            }.bind(this));
        }
        if (this.json.rangeField && this.json.rangeField.length){
            this.json.rangeField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d){
                        if (typeOf(d)==="string"){
                            var data;
                            this.getOrgAction().getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                            rangeValues.push(data);
                        }else{
                            rangeValues.push(d);
                        }
                    }
                }.bind(this));
            }.bind(this));
        }
        if (this.json.rangeKey && this.json.rangeKey.code){
            var v = this.form.Macro.exec(this.json.rangeKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d){
                    if (typeOf(d)==="string"){
                        var data;
                        this.getOrgAction().getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                        rangeValues.push(data);
                    }else{
                        rangeValues.push(d);
                    }
                }
            }.bind(this));
        }
        return rangeValues;
    },

    getScriptSelectDuty: function(){
        var rangeValues = [];
        if (this.json.rangeDuty && this.json.rangeDuty.length){
            this.json.rangeDuty.each(function(unit){
                var unitFlag = unit.id || unit.name;
                if (unitFlag) rangeValues.push(unitFlag);
            }.bind(this));
        }
        if (this.json.rangeDutyField && this.json.rangeDutyField.length){
            this.json.rangeDutyField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d) rangeValues.push(d);
                }.bind(this));
            }.bind(this));
        }
        if (this.json.rangeDutyKey && this.json.rangeDutyKey.code){
            var v = this.form.Macro.exec(this.json.rangeDutyKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d) rangeValues.push(d);
            }.bind(this));
        }
        return rangeValues;
    },

    _computeValue: function(){
        var values = [];
        if (this.json.identityValue) {
            this.json.identityValue.each(function(v){ if (v) values.push(v)});
        }
        if (this.json.unitValue) {
            this.json.unitValue.each(function(v){ if (v) values.push(v)});
        }
        var simple = this.json.storeRange === "simple";

        if (this.json.dutyValue) {
            var dutys = JSON.decode(this.json.dutyValue);
            var par;
            if (dutys.length){
                dutys.each(function(duty){
                    if (duty.code) par = this.form.Macro.exec(duty.code, this);
                    var code = "return this.org.getDuty(\""+duty.name+"\", \""+par+"\")";

                    //var code = "return this.org.getDepartmentDuty({\"name\": \""+duty.name+"\", \"departmentName\": \""+par+"\"})";
                    var d = this.form.Macro.exec(code, this);
                    if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                    d.each(function(dd){
                        if (dd) values.push(MWF.org.parseOrgData(dd,true,simple));
                    });

                    // code = "return this.org.getCompanyDuty({\"name\": \""+duty.name+"\", \"compName\": \""+par+"\"})";
                    // d = this.form.Macro.exec(code, this);
                    // if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                    // d.each(function(dd){values.push(dd);});
                }.bind(this));
            }
        }
        if (this.json.defaultValue && this.json.defaultValue.code){
            var fd = this.form.Macro.exec(this.json.defaultValue.code, this);
            if (typeOf(fd)!=="array") fd = (fd) ? [fd] : [];
            fd.each(function(fdd){
                if (fdd){
                    if (typeOf(fdd)==="string"){
                        var data;
                        this.getOrgAction()[this.getValueMethod(fdd)](function(json){ data = MWF.org.parseOrgData(json.data,true, simple); }.bind(this), null, fdd, false);
                        values.push(data);
                    }else{
                        values.push(fdd);
                    }
                }
            }.bind(this));
        }
        if (this.json.count>0){
            return values.slice(0, this.json.count);
        }
        return values;
        //return (this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
    },
    // getDepartments: function(){
    //     if (this.json.range==="depart"){
    //         return this.getRange();
    //     }
    //     if (this.json.range==="currentdepart"){
    //         return [this.form.app.currentTask.department];
    //     }
    //     return [];
    // },
    // getCompanys: function(){
    //     if (this.json.range==="company"){
    //         //var comp = "";
    //         //if (this.json.rangeKey){
    //             return this.getRange();
    //         //}
    //     }
    //     if (this.json.range==="currentcompany"){
    //         return [this.form.app.currentTask.company];
    //     }
    //     return [];
    // },
    getOrgAction: function(){
        if (!this.orgAction) this.orgAction = MWF.Actions.get("x_organization_assemble_control");
        //if (!this.orgAction) this.orgAction = new MWF.xApplication.Selector.Actions.RestActions();
        return this.orgAction;
    },
    getNextSelectUnit: function(id){
        var data;
        if (this.json.rangeNext === "direct"){
            if (typeOf(id)==="array"){
                var units = [];
                id.each(function(i){
                    this.getOrgAction().getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
                    if (data && data.woUnit) units.push(data.woUnit);
                    data = null;
                }.bind(this));
                return units;
            }else{
                this.getOrgAction().getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, id, false);
                return (data.woUnit) ? [data.woUnit] : [];
            }
        }
        if (this.json.rangeNext==="level"){
            this.getOrgAction().getUnitWithIdentityWithLevel(id, this.json.rangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
            //this.json.rangeNextLevel
            return (data) ? [data] : [];
        }
        if (this.json.rangeNext==="type"){
            if (this.json.rangeNextUnitType==="all"){
                this.getOrgAction().getUnitWithIdentityWithLevel(id, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
            }else{
                this.getOrgAction().getUnitWithIdentityWithType(id, this.json.rangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
            }

            return (data) ? [data] : [];
        }

    },
    getSelectRange: function(){
        if (this.json.range==="unit"){
            return this.getScriptSelectUnit();
        }
        if (this.json.range==="draftUnit"){
            var dn = (this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn;
            if (!dn){
                if ( layout.session.user.identityList && layout.session.user.identityList.length){
                    var ids = [];
                    layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                    return this.getNextSelectUnit(ids);
                }else{
                    return [];
                }
            }else{
                return this.getNextSelectUnit((this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn);
            }
        }
        if (this.json.range==="currentUnit"){
            if (this.form.app.currentTask){
                return this.getNextSelectUnit(this.form.app.currentTask.identityDn);
            }else{
                if (this.form.app.taskList && this.form.app.taskList.length){
                    var ids = [];
                    this.form.app.taskList.each(function(task){ ids.push(task.identity); });
                    return this.getNextSelectUnit(ids);
                }else{
                    if ( layout.session.user.identityList && layout.session.user.identityList.length){
                        var ids = [];
                        layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                        return this.getNextSelectUnit(ids);
                    }else{
                        return [];
                    }
                }
            }
        }
        return [];
    },
    getSelectRangeDuty: function(){
        if (this.json.dutyRange==="duty"){
            return this.getScriptSelectDuty();
        }
        return [];
    },
    getOptions: function(){
        var values = this.getInputData();
        var count = (this.json.count) ? this.json.count : 0;

        switch (this.json.range){
            case "":
        }


        var selectUnits = this.getSelectRange();
        if (this.json.selectType=="identity"){
            var selectDutys = this.getSelectRangeDuty();
        }

        if (this.json.range!=="all"){
            if (!selectUnits.length){
                this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
                return false;
            }
        }
        if (this.json.selectType=="identity"){
            if ((this.json.dutyRange) && this.json.dutyRange!=="all"){
                if (!selectDutys || !selectDutys.length){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
                    return false;
                }
            }
        }

        var exclude = [];
        if( this.json.exclude ){
            var v = this.form.Macro.exec(this.json.exclude.code, this);
            exclude = typeOf(v)==="array" ? v : [v];
        }

        var options = {
            "type": this.json.selectType,
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
            "values": (this.json.isInput) ? [] : values,
            "count": count,
            "units": selectUnits,
            "dutys": (this.json.selectType=="identity") ? selectDutys : [],
            "exclude" : exclude,
            "expandSubEnable" : (this.json.expandSubEnable=="no") ? false : true,
            "categoryType": this.json.categoryType || "unit",
            "onComplete": function(items){
                this.selectOnComplete(items);
            }.bind(this),
            "onCancel": this.selectOnCancel.bind(this),
            "onLoad": this.selectOnLoad.bind(this),
            "onClose": this.selectOnClose.bind(this)
        };
        if( this.form.json.selectorStyle )options = Object.merge( options, this.form.json.selectorStyle );

        return options;
    },
    selectOnComplete: function(items){
        var simple = this.json.storeRange === "simple";
        var values = [];
        items.each(function(item){
            values.push(MWF.org.parseOrgData(item.data, true, simple));
        }.bind(this));
        if (this.json.isInput){
            this.addData(values);
        }else{
            this.setData(values);
        }
        //this._setBusinessData(values);
        this.validationMode();
        this.validation();
        this.fireEvent("select");
    },
    selectOnCancel: function(){
        this.validation();
    },
    selectOnLoad: function(){
        if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
    },
    selectOnClose: function(){
        v = this._getBusinessData();
        if (!v || !v.length) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
    },

    clickSelect: function( ev ){

        var options = this.getOptions();
        if( this.selector && this.selector.loading ) {
        }else if( this.selector && this.selector.selector && this.selector.selector.active ){
        }else{
            this.selector = new MWF.O2Selector(this.form.app.content, options);
        }
    },
    resetData: function(){
        var v = this.getValue();
        //this.setData((v) ? v.join(", ") : "");
        this.setData(v);
    },
    isEmpty: function(){
        var data = this.getData();
        if( typeOf(data) !== "array" )return true;
        if( data.length === 0 )return true;
        return false;
    },
    getInputData: function(){
        if (this.json.isInput){
            if (this.combox) return this.combox.getData();
            return this._getBusinessData();
        }else{
            return this._getBusinessData();
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        var node = new Element("div").inject(this.node);
    },
    _searchConfirmPerson: function(item){
        var inforNode = item.inforNode || new Element("div");
        if (item.data){
            var text = "";
            var flag = item.data.distinguishedName.substr(item.data.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = item.data.name+"("+item.data.unitName+")";
                    break;
                case "@p":
                    text = item.data.name+"("+item.data.employee+")";
                    break;
                case "@u":
                    text = item.data.levelName;
                    break;
                case "@g":
                    text = item.data.name;
                    break;
                default:
                    text = item.data.name;
            }
            inforNode.set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });
        }else{
            inforNode.set({
                "styles": {"font-size": "14px", "color": "#bd0000"},
                "text": MWF.xApplication.process.Xform.LP.noOrgObject
            });
        }
        if (!item.inforNode){
            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: item.node,
                transition: 'flyin'
            });
            item.inforNode = inforNode;
        }

    },
    _searchOptions: function(value, callback){
        var options = {
            "type": this.json.selectType,
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
            "units": this.selectUnits,
            "dutys": (this.json.selectType=="identity") ? this.selectDutys : []
        };
        if (!this.comboxFilter) this.comboxFilter = new MWF.O2SelectorFilter(value, options);
        this.comboxFilter.filter(value, function(data){
            data.map(function(d){
                var value = Object.clone(d);
                d.value = value;
                var flag = d.distinguishedName.substr(d.distinguishedName.length-2, 2);
                switch (flag.toLowerCase()){
                    case "@i":
                        d.text = d.name+"("+d.unitName+")";
                        break;
                    case "@p":
                        d.text = d.name+"("+d.employee+")";
                        break;
                    case "@u":
                        d.text = d.name;
                        break;
                    case "@g":
                        d.text = d.name;
                        break;
                    default:
                        d.text = d.name;
                }
            });
            if (callback) callback(data);
        });
    },
    _resetNodeInputEdit: function(){
        var node = new Element("div", {
            "styles": {
                "overflow": "hidden",
                //"position": "relative",
                "margin-right": "20px"
            }
        }).inject(this.node, "after");
        this.node.destroy();
        this.node = node;
    },
    _loadNodeInputEdit: function() {
        var input = null;
        MWF.require("MWF.widget.Combox", function () {
            this.combox = input = new MWF.widget.Combox({
                "count": this.json.count || 0,
                "splitShow": this.json.splitShow || ", ",
                "onCommitInput": function (item) {
                    this._searchConfirmPerson(item);
                    //this.fireEvent("change");
                }.bind(this),
                "onChange": function () {
                    this._setBusinessData(this.getInputData());
                    this.fireEvent("change");
                }.bind(this),
                "optionsMethod": this._searchOptions.bind(this)

            });
        }.bind(this), false);
        input.setStyles({
            "background": "transparent",
            "border": "0px"
        });
        input.set(this.json.properties);

        if (!this.json.preprocessing) this._resetNodeInputEdit();

        this.node.empty();
        input.inject(this.node);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        if (this.json.showIcon != 'no' && !this.form.json.hideModuleIcon){
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": function (ev) {
                        this.clickSelect( ev );
                    }.bind(this)
                    //this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.combox.addEvent("change", function(){
            this.validationMode();
            if (this.validation()) this._setBusinessData(this.getInputData("change"));
        }.bind(this));
    },

    _resetNodeEdit: function(){
        var input = new Element("div", {
            "styles": {
                "background": "transparent",
                "border": "0px",
                "min-height": "24px"
            }
        });
        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "min-height": "24px"
            }}).inject(this.node, "after");
        input.inject(node);
        this.node.destroy();
        this.node = node;
    },
    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        input.set(this.json.properties);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": function (ev) {
                    this.clickSelect( ev );
                }.bind(this)
                //this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) this.iconNode = new Element("div", {
            "styles": this.form.css[this.iconStyle],
            "events": {
                "click": function (ev) {
                    this.clickSelect( ev );
                }.bind(this)
                //this.clickSelect.bind(this)
            }
        }).inject(this.node, "before");

        this.node.getFirst().setStyle("height", "auto");
        this.node.getFirst().addEvent("change", function(){
            this.validationMode();
            if (this.validation()) this._setBusinessData(this.getInputData("change"));
        }.bind(this));
    },
    getDataText: function(data){
        if (typeOf(data)=="string") return data;
        var text = "";
        var flag = data.distinguishedName.substr(data.distinguishedName.length-2, 2);
        switch (flag.toLowerCase()){
            case "@i":
                text = data.name+"("+data.unitName+")";
                break;
            case "@p":
                text = data.name+"("+data.employee+")";
                break;
            case "@u":
                text = data.name;
                break;
            case "@g":
                text = data.name;
                break;
            default:
                text = data.name;
        }
        return text;
    },
    addData: function(value){
        if (!value) return false;
        var simple = this.json.storeRange === "simple";
        value.each(function(v){
            var vtype = typeOf(v);
            if (vtype==="string"){
                var data;
                this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), null, v, false);
                if (data) this.combox.addNewValue(this.getDataText(data), data);
            }
            if (vtype==="object"){
                this.combox.addNewValue(this.getDataText(v), v);
            }
        }.bind(this));
    },
    setData: function(value){
        if (!value) return false;
        var oldValues = this.getData();
        var values = [];
        var comboxValues = [];


        var simple = this.json.storeRange === "simple";

        var type = typeOf(value);
        if (type==="array"){
            value.each(function(v){
                var vtype = typeOf(v);
                var data = null;
                if (vtype==="string"){
                    var error = (this.json.isInput) ? function(){ comboxValues.push(v); } : null;
                    this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, false, simple); }.bind(this), error, v, false);
                }
                if (vtype==="object") {
                    data = MWF.org.parseOrgData(v, false, simple);
                    if(data.woPerson)delete data.woPerson;
                }
                if (data){
                    values.push(data);
                    comboxValues.push({"text": this.getDataText(data),"value": data});
                }
            }.bind(this));
        }
        if (type==="string"){
            var vData;
            var error = (this.json.isInput) ? function(){ comboxValues.push(value); } : null;
            this.getOrgAction()[this.getValueMethod(value)](function(json){ vData = MWF.org.parseOrgData(json.data, false, simple); }.bind(this), error, value, false);
            if (vData){
                values.push(vData);
                comboxValues.push({"text": this.getDataText(vData),"value": vData});
            }
        }
        if (type==="object"){
            var vData = MWF.org.parseOrgData(value, false, simple);
            if(vData.woPerson)delete vData.woPerson;
            values.push( vData );
            comboxValues.push({"text": this.getDataText(value),"value": vData});
        }

        var change = false;
        if (oldValues.length && values.length){
            if (oldValues.length === values.length){
                for (var i=0; i<oldValues.length; i++){
                    if ((oldValues[i].distinguishedName!==values[i].distinguishedName) || (oldValues[i].name!==values[i].name) || (oldValues[i].unique!==values[i].unique)){
                        change = true;
                        break;
                    }
                }
            }else{
                change = true;
            }
        }else if (values.length || oldValues.length) {
            change = true;
        }
        this._setBusinessData(values);
        if (change) this.fireEvent("change");

        if (this.json.isInput){
            if (this.combox){
                this.combox.clear();
                this.combox.addNewValues(comboxValues);
            }else{
                var node = this.node.getFirst();
                if (node){
                    node.empty();
                    comboxValues.each(function(v, i){
                        this.creteShowNode(v, (i===comboxValues.length-1)).inject(node);
                    }.bind(this));
                }
            }
            //
            // this.combox.clear();
            // values.each(function(v){
            //     var vtype = typeOf(v);
            //     if (vtype==="string"){
            //         var data;
            //         this.getOrgAction()[this.getValueMethod(v)](function(json){ data = json.data }.bind(this), null, v, false);
            //         if (data) this.combox.addNewValue(this.getDataText(data), data);
            //     }
            //     if (vtype==="object"){
            //         this.combox.addNewValue(this.getDataText(v), v);
            //     }
            // }.bind(this));
        }else{
            if (this.node.getFirst()){
                var node = this.node.getFirst();
                node.empty();
                this.loadOrgWidget(values, node)
            }else{
                this.node.empty();
                this.loadOrgWidget(values, this.node);
            }
        }
    },
    creteShowNode: function(data, islast){
        var nodeText = (data.text) ?  data.text : data;
        if (!islast) nodeText = nodeText + (this.json.splitShow || ", ");

        var node = new Element("div", {
            "styles": {
                "float": "left",
                "margin-right": "5px"
            },
            "text": nodeText
        });
        var text = "";
        if (data.value){
            var flag = data.value.distinguishedName.substr(data.value.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = data.value.name+"("+data.value.unitName+")";
                    break;
                case "@p":
                    text = data.value.name+"("+data.value.employee+")";
                    break;
                case "@u":
                    text = data.value.levelName;
                    break;
                case "@g":
                    text = data.value.name;
                    break;
                default:
                    text = data.value.name;
            }
            var inforNode = new Element("div").set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });

            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: node,
                transition: 'flyin'
            });
        }


        return node;
    },
    _setValue: function(value){

        if (value.length==1 && !(value[0])) value=[];
        var values = [];
        var comboxValues = [];
        var type = typeOf(value);

        var simple = this.json.storeRange === "simple";

        if (type==="array"){
            value.each(function(v){
                var data=null;
                var vtype = typeOf(v);
                if (vtype==="string"){
                    var error = (this.json.isInput) ? function(){ comboxValues.push(v); } : null;
                    this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple) }.bind(this), error, v, false);
                }
                if (vtype==="object") data = v;
                if (data){
                    values.push(data);
                    comboxValues.push({"text": this.getDataText(data),"value": data});
                }
            }.bind(this));
        }
        if (type==="string"){
            var vData;
            var error = (this.json.isInput) ? function(){ comboxValues.push(value); } : null;
            this.getOrgAction()[this.getValueMethod(value)](function(json){ vData = MWF.org.parseOrgData(json.data, true, simple) }.bind(this), error, value, false);
            if (vData){
                values.push(vData);
                comboxValues.push({"text": this.getDataText(vData),"value": vData});
            }
        }
        if (type==="object"){
            values.push(value);
            comboxValues.push({"text": this.getDataText(value),"value": value});
        }

        this._setBusinessData(values);

        if (this.json.isInput){

            if (this.combox){
                this.combox.clear();
                this.combox.addNewValues(comboxValues);

                // values.each(function(v){
                //     if (typeOf(v)=="string"){
                //         this.combox.addNewValue(v);
                //     }else{
                //         this.combox.addNewValue(this.getDataText(v), v);
                //     }
                // }.bind(this));
            }else{
                var node = this.node.getFirst();
                if (node){
                    node.empty();
                    comboxValues.each(function(v, i){
                        this.creteShowNode(v, (i===comboxValues.length-1)).inject(node);
                    }.bind(this));
                }
            }

        }else{
            if (this.node.getFirst()){
                var node = this.node.getFirst();
                this.loadOrgWidget(values, node)
            }else{
                this.loadOrgWidget(values, this.node);
            }
        }

        //if (this.readonly) this.loadOrgWidget(values, this.node)
        //this.node.set("text", value);
    },
    getValueMethod: function(value){
        if (value){
            var flag = value.substr(value.length-1, 1);
            switch (flag.toLowerCase()){
                case "i":
                    return "getIdentity";
                case "p":
                    return "getPerson";
                case "u":
                    return "getUnit";
                case "g":
                    return "getGroup";
                default:
                    return (this.json.selectType==="unit") ? "getUnit" : "getIdentity";
            }
        }
        return (this.json.selectType==="unit") ? "getUnit" : "getIdentity";
    },
    loadOrgWidget: function(value, node){
        var disableInfor = layout.mobile ? true : false;
        if( this.json.showCard === "no" )disableInfor = true;
        var height = node.getStyle("height").toInt();
        if (node.getStyle("overflow")==="visible" && !height) node.setStyle("overflow", "hidden");
        if (value && value.length){
            value.each(function(data){
                var flag = data.distinguishedName.substr(data.distinguishedName.length-2, 2);
                var copyData = Object.clone(data);
                switch (flag.toLowerCase()){
                    case "@i":
                        new MWF.widget.O2Identity(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    case "@p":
                        new MWF.widget.O2Person(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    case "@u":
                        new MWF.widget.O2Unit(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    case "@g":
                        new MWF.widget.O2Group(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    default:
                        new MWF.widget.O2Other(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                }
            }.bind(this));
        }
    },
    _loadStyles: function(){
        if (this.isReadonly()){
            if (this.json.styles) this.node.setStyles(this.json.styles);
        }else{
            if (this.json.styles) this.node.setStyles(this.json.styles);
            if (this.json.inputStyles) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
            if (this.iconNode && this.iconNode.offsetParent !== null ){
                var size = this.node.getSize();
                this.iconNode.setStyle("height", ""+size.y+"px");
            }
        }
    }

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Button 按钮组件。
 * @o2cn 按钮
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var button = this.form.get("name"); //获取组件
 * //方法2
 * var button = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Button = MWF.APPButton =  new Class({
    Implements: [Events],
    Extends: MWF.APP$Module,
    iconStyle: "personfieldIcon",

    _loadUserInterface: function(){
        // var button = new Element("button");
        // button.inject(this.node, "after");
        // this.node.destroy();
        // this.node = button;

        if (this.isReadable && this.isEditable){
            var button = this.node.getElement("button");
            if (!button) button = new Element("button");
                button.inject(this.node, "after");
            this.node.destroy();
            this.node = button;
    
            this.node.set({
                "id": this.json.id,
                "text": this.json.name || this.json.id,
                "MWFType": this.json.type
            });
            if (!this.json.preprocessing) this.node.setStyles(this.form.css.buttonStyles);
            if( this.json.properties ){
                this.node.set(this.json.properties )
            }
        }else{
            this.node.setStyle('display', 'none');
        }
        
    }

}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xDesktop.requireApp("process.Xform", "Button", null, false);
/** @class ViewSelector 视图选择组件。
 * @o2cn 视图选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var sourceText = this.form.get("fieldId"); //获取组件
 * //方法2
 * var sourceText = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.Button
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.ViewSelector = MWF.APPViewSelector =  new Class({
	Implements: [Events],
	Extends: MWF.xApplication.process.Xform.Button,
    options: {
        /**
         * 视图参数（options）已经准备好，还未加载视图时执行。可以通过this.event得到视图参数，并可修改this.event修改视图的加载。
         * @event MWF.xApplication.process.Xform.ViewSelector#beforeLoadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 视图设计已经获取，容器也已经准备好。
         * @event MWF.xApplication.process.Xform.ViewSelector#loadViewLayout
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 异步加载视图后执行。
         * @event MWF.xApplication.process.Xform.ViewSelector#loadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 选中视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.ViewSelector#select
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 取消选中视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.ViewSelector#unselect
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 打开视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.ViewSelector#openDocument
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 加载对话框的时候执行，this.event可以获取到对话框对象。
         * @event MWF.xApplication.process.Xform.ViewSelector#loadDialog
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 显示对话框的时候执行，this.event可以获取到对话框对象。
         * @event MWF.xApplication.process.Xform.ViewSelector#showDialog
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "loadDialog", 'showDialog',"beforeLoadView", "loadView", "queryLoad", "postLoad", "select", "unselect", "openDocument"]
    },

	_loadUserInterface: function(){
        var button = this.node.getElement("button");
		if (!button) button = new Element("button");
		button.inject(this.node, "after");
		this.node.destroy();
		this.node = button;
		this.node.set({
			"id": this.json.id,
			"text": this.json.name || this.json.id,
			"styles": this.form.json.buttonStyle || this.form.css.buttonStyles,
			"MWFType": this.json.type
		});
        if(this.json.recoveryStyles){
            this.node.setStyles(this.json.recoveryStyles);
        }
        if( this.json.properties ){
            this.node.set(this.json.properties );
        }

        if( this.form.json.formStyleType === 'v10' ){
            this.node.addClass('form-content-button');
        }

        this.node.addEvent("click", function(){
            this.selectedData = null;
            this.selectView(function(data){
                this.doResult(data);
            }.bind(this));
        }.bind(this));
	},
    doResult: function(data){
        if (this.json.result === "script"){
            this.selectedData = data;
            return (this.json.selectedScript.code) ? this.form.Macro.exec(this.json.selectedScript.code, this) : "";
        }else{
            Object.each(this.json.selectedSetValues, function(v, k){
                var value = "";
                data.each(function(d, idx){
                    Object.each(d.data, function(dv, dk){
                        if (dk===v) value = (value) ? (value+", "+dv) : dv;
                    }.bind(this));
                }.bind(this));

                var field = this.form.all[k];
                if (field){
                    field.setData(value);
                    if (value){
                        if (field.descriptionNode) field.descriptionNode.setStyle("display", "none");
                    }else{
                        if (field.descriptionNode) field.descriptionNode.setStyle("display", "block");
                    }
                }
            }.bind(this));
        }
    },

    selectCMSView: function(callback){
        var viewData = this.json.cmsViewName;
        if (viewData){
            var filter = null;
            if (this.json.filterList && this.json.filterList.length){
                filter = [];
                this.json.filterList.each(function(entry){
                    entry.value = this.form.Macro.exec(entry.code.code, this);
                    //delete entry.code;
                    filter.push(entry);
                }.bind(this));
            }
            var viewJson = {
                "application": viewData.appId,
                "viewName": viewData.name,
                "isTitle": this.json.isTitle || "yes",
                "select": this.json.select || "single",
                "titleStyles": this.json.titleStyles,
                "itemStyles": this.json.itemStyles,
                "isExpand": this.json.isExpand || "no",
                "showActionbar" : this.json.actionbar === "show",
                "filter": filter
            };
            var options = {};
            var width = options.width || "800";
            var height = options.height || "450";
            options.style = this.json.viewStyle || "v10_view";

            var size;
            if (layout.mobile){
                size = document.body.getSize();
                width = size.x;
                height = size.y;
                options.style = "viewmobile";
            }
            width = width.toInt();
            height = height.toInt();

            size = this.form.app.content.getSize();
            var x = (size.x-width)/2;
            var y = (size.y-height)/2;
            if (x<0) x = 0;
            if (y<0) y = 0;
            if (layout.mobile){
                x = 20;
                y = 0;
            }

            var _self = this;
            MWF.require("MWF.xDesktop.Dialog", function(){
                var dlg = new MWF.xDesktop.Dialog({
                    "title": this.json.title || "select view",
                    "style": options.style || "v10_view",
                    "top": y,
                    "left": x-20,
                    "fromTop":y,
                    "fromLeft": x-20,
                    "width": width,
                    "height": height,
                    "html": "<div></div>",
                    "maskNode": this.form.app.content,
                    "container": this.form.app.content,
                    "buttonList": [
                        {
                            "text": MWF.LP.process.button.ok,
                            "action": function(){
                                //if (callback) callback(_self.view.selectedItems);
                                if (callback) callback(_self.view.getData());
                                this.close();
                            }
                        },
                        {
                            "text": MWF.LP.process.button.cancel,
                            "action": function(){this.close();}
                        }
                    ]
                });
                dlg.show();

                if (layout.mobile){
                    var backAction = dlg.node.getElement(".MWF_dialod_Action_back");
                    var okAction = dlg.node.getElement(".MWF_dialod_Action_ok");
                    if (backAction) backAction.addEvent("click", function(e){
                        dlg.close();
                    }.bind(this));
                    if (okAction) okAction.addEvent("click", function(e){
                        //if (callback) callback(this.view.selectedItems);
                        if (callback) callback(this.view.getData());
                        dlg.close();
                    }.bind(this));
                }

                // MWF.xDesktop.requireApp("process.Xform", "widget.CMSView", function(){
                //     this.view = new MWF.xApplication.process.Xform.widget.CMSView(dlg.content.getFirst(), viewJson, {"style": "select"});
                // }.bind(this));

                MWF.xDesktop.requireApp("process.Application", "Viewer", function(){
                    this.view = new MWF.xApplication.process.Application.Viewer(dlg.content, viewJson, {
                        "actions": {
                            "lookup": {"uri": "/jaxrs/queryview/flag/{view}/application/flag/{application}/execute", "method":"PUT"},
                            "getView": {"uri": "/jaxrs/queryview/flag/{view}/application/flag/{application}"}
                        },
                        "actionRoot": "x_cms_assemble_control"
                    });
                }.bind(this));
            }.bind(this));
        }
    },
    selectProcessView: function(callback){
        var viewData = this.json.processViewName;
        if (viewData){
            var filter = null;
            if (this.json.filterList && this.json.filterList.length){
                filter = [];
                this.json.filterList.each(function(entry){
                    entry.value = this.form.Macro.exec(entry.code.code, this);
                    //delete entry.code;
                    filter.push(entry);
                }.bind(this));
            }

            var viewJson = {
                "application": viewData.application,
                "viewName": viewData.name,
                "isTitle": this.json.isTitle || "yes",
                "select": this.json.select || "single",
                "titleStyles": this.json.titleStyles,
                "itemStyles": this.json.itemStyles,
                "isExpand": this.json.isExpand || "no",
                "showActionbar" : this.json.actionbar === "show",
                "filter": filter
            };
            var options = {};
            var width = options.width || "800";
            var height = options.height || "600";

            var size;
            if (layout.mobile){
                size = document.body.getSize();
                width = size.x;
                height = size.y;
                options.style = "viewmobile";
            }
            width = width.toInt();
            height = height.toInt();

            size = this.form.app.content.getSize();
            var x = (size.x-width)/2;
            var y = (size.y-height)/2;
            if (x<0) x = 0;
            if (y<0) y = 0;
            if (layout.mobile){
                x = 20;
                y = 0;
            }

            var _self = this;
            MWF.require("MWF.xDesktop.Dialog", function(){
                var dlg = new MWF.xDesktop.Dialog({
                    "title": this.json.title || "select view",
                    "style": options.style || "v10_view",
                    "top": y,
                    "left": x-20,
                    "fromTop":y,
                    "fromLeft": x-20,
                    "width": width,
                    "height": height,
                    "html": "",
                    "maskNode": this.form.app.content,
                    "container": this.form.app.content,
                    "buttonList": [
                        {
                            "text": MWF.LP.process.button.ok,
                            "action": function(){
                                //if (callback) callback(_self.view.selectedItems);
                                if (callback) callback(_self.view.getData());
                                this.close();
                            }
                        },
                        {
                            "text": MWF.LP.process.button.cancel,
                            "action": function(){this.close();}
                        }
                    ]
                });
                dlg.show();

                if (layout.mobile){
                    var backAction = dlg.node.getElement(".MWF_dialod_Action_back");
                    var okAction = dlg.node.getElement(".MWF_dialod_Action_ok");
                    if (backAction) backAction.addEvent("click", function(e){
                        dlg.close();
                    }.bind(this));
                    if (okAction) okAction.addEvent("click", function(e){
                        //if (callback) callback(this.view.selectedItems);
                        if (callback) callback(this.view.getData());
                        dlg.close();
                    }.bind(this));
                }

                // MWF.xDesktop.requireApp("process.Xform", "widget.View", function(){
                //     this.view = new MWF.xApplication.process.Xform.widget.View(dlg.content.getFirst(), viewJson, {"style": "select"});
                // }.bind(this));

                MWF.xDesktop.requireApp("process.Application", "Viewer", function(){
                    this.view = new MWF.xApplication.process.Application.Viewer(dlg.content, viewJson);
                }.bind(this));
            }.bind(this));
        }
    },

    getViewName: function (){
        var appName, viewName, viewId;
        if (this.json.viewType === "script") {
            if (this.json.viewScript && this.json.viewScript.code) {
                var data = this.form.Macro.exec(this.json.viewScript.code, this);
                if (data) {
                    appName = data.application;
                    viewName = data.view;
                }
            }
        }else if(this.json.queryView){
            appName = this.json.queryView.appName;
            viewName = this.json.queryView.name;
            viewId = this.json.queryView.id;
        }
        return {appName: appName, viewName: viewName, viewId:viewId};
    },
    selectQueryView: function(callback){
        // var viewData = this.json.queryView;

        var viewObj = this.getViewName();
        var appName = viewObj.appName, viewName = viewObj.viewName, viewId = viewObj.viewId;
        if( !appName || ( !viewName && !viewId ) ){
            if(callback) callback();
            return ;
        }

        var filter = null;
        if (this.json.filterList && this.json.filterList.length){
            filter = [];
            this.json.filterList.each(function(entry){
                entry.value = this.form.Macro.exec(entry.code.code, this);
                //delete entry.code;
                filter.push(entry);
            }.bind(this));
        }

        var viewJson = {
            "application": appName,
            "viewName": viewName,
            "viewId": viewId,
            "isTitle": this.json.isTitle || "yes",
            "select": this.json.select || "single",
            "titleStyles": this.json.titleStyles,
            "itemStyles": this.json.itemStyles,
            "isExpand": this.json.isExpand || "no",
            "showActionbar": this.json.actionbar === "show",
            "filter": filter,
            "defaultSelectedScript" : this.json.defaultSelectedScript ? this.json.defaultSelectedScript.code : null,
            "selectedAbleScript" : this.json.selectedAbleScript ? this.json.selectedAbleScript.code : null
        };

        this.viewJson = viewJson;

        var viewOptions = {
            "style": "select",
            "onLoadLayout": function () {
                this.fireEvent("loadViewLayout");
            }.bind(this),
            "onLoadView": function(){
                this.fireEvent("loadView");
            }.bind(this),
            "onSelect": function(item){
                this.fireEvent("select", [item]);
            }.bind(this),
            "onUnselect": function(item){
                this.fireEvent("unselect", [item]);
            }.bind(this),
            "onOpenDocument": function(options, item){
                this.openOptions = {
                    "options": options,
                    "item": item
                };
                this.fireEvent("openDocument", [this.openOptions]);
                this.openOptions = null;
            }.bind(this)
        };
        this.viewOptions = viewOptions;

        var _self = this;
        var dlgOptions = {
            title: this.json.title,
            width: this.json.DialogWidth || "850",
            height: this.json.DialogHeight || "700",
            style: this.json.viewStyle || "v10_view",
            "onPostLoad": function (){
                _self.fireEvent("loadDialog", [this]);
            }.bind(this),
            "onPostShow": function(){
                if(layout.mobile){
                    this.node.setStyle("z-index",200);
                }
                _self.fireEvent("showDialog", [this]);
            }
        };
        this.dialogOptions = dlgOptions;

        this.fireEvent("beforeLoadView", [viewJson]);

        this.form.Macro.environment.view.select(viewJson, callback, dlgOptions, viewOptions, (viewer)=>{
            this.view = viewer;
        });
    },
    selectView: function(callback){
        if(!!this.json.viewType){
            this.selectQueryView(callback);
        }else if (this.json.queryView){
            this.selectQueryView(callback);
        }else{
            if (this.json.selectViewType==="cms"){
                this.selectCMSView(callback);
            }else{
                this.selectProcessView(callback);
            }
        }
    }

});

o2.xDesktop.requireApp("process.Xform", "$ElModule", null, false);
o2.xDesktop.requireApp("process.Xform", "$Input", null, false);

o2.xApplication.process.Xform.$Elinput = o2.APP$Elinput = new Class({
    Implements: [Events],
    Extends: MWF.APP$ElModule,
});
Object.assign(o2.APP$Elinput.prototype, o2.APP$Input.prototype);

Object.assign(o2.APP$Elinput.prototype, {
    isReadonly : function(){
        return !!(!this.isEditable || this.readonly || this.json.isReadonly || this.form.json.isReadonly || this.isSectionMergeRead() );
    },
    reload: function(){
        if (this.vm) {
            var node = this.vm.$el;
            this.vm.$destroy();
            node.empty();
        }

        this.vm = null;

        this.vueApp = null;

        this._loadUserInterface();
    },
    __setValue: function(value){
        this.moduleValueAG = null;
        this._setBusinessData(value);
        this.json[this.json.$id] = value;
        this.__setReadonly(value);
        this.fieldModuleLoaded = true;
        return value;
    },
    __setData: function(data){
        var old = this.getInputData();
        this._setBusinessData(data);
        this.json[this.json.$id] = data;
        this.__setReadonly(data);
        if (old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
        this.validationMode();
    },
    __setReadonly: function(data){
        if (this.isReadonly()) {
            this.node.set("text", data);
            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }

            if( !this.eventLoaded ){
                this._loadDomEvents();
                this.eventLoaded = true;
            }


            this.fireEvent("postLoad");
            if( this.moduleSelectAG && typeOf(this.moduleSelectAG.then) === "function" ){
                this.moduleSelectAG.then(function () {
                    this.fireEvent("load");
                    this.isLoaded = true;
                }.bind(this));
            }else{
                this.fireEvent("load");
                this.isLoaded = true;
            }

        }
    },
    getInputData: function(){
        return this.json[this.json.$id];
    },
    // _getVueModelBindId: function(){
    //     if (this.json.id.indexOf("..")!==-1){
    //         this.json["$id"] ="__"+this.json.id.replace(/\.\./g, "_")
    //     }else{
    //         this.json["$id"] = this.json.id;
    //     }
    // },
    _loadNodeEdit: function(){
        var id = (this.json.id.indexOf("..")!==-1) ? this.json.id.replace(/\.\./g, "_") : this.json.id;
        id = (id.indexOf("@")!==-1) ? id.replace(/@/g, "_") : id;
        this.json["$id"] = (id.indexOf("-")!==-1) ? id.replace(/-/g, "_") : id;
        this.node.appendHTML(this._createElementHtml(), "before");
        var input = this.node.getPrevious();

        this.node.destroy();
        this.node = input;
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this.node.addClass("o2_vue");
        this._createVueApp();
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1 && this.options.elEvents.indexOf(key)===-1){
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1 || this.options.elEvents.indexOf(key)!==-1 ){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            this.node.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }
    },
    getValue: function(){
        if (!this.isReadable) return '';
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if (value || value===false || value===0){
            return value;
        }else{
            value = this._computeValue();
            return (o2.typeOf(value)!=="null") ? value : "";
        }
        // if (!value) value = this._computeValue();
        // return (o2.typeOf(value)!=="null") ? value : "";
        //return value || "";
    },
    _afterLoaded: function(){}
})

o2.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @classdesc $ElModule ElementUI组件类，此类为所有ElementUI组件的父类。
 * @class
 * @o2category FormComponents
 * @hideconstructor
 * */
o2.xApplication.process.Xform.$ElModule = MWF.APP$ElModule =  new Class(
    /** @lends MWF.xApplication.process.Xform.$ElModule# */
    {
    Implements: [Events],
    Extends: MWF.APP$Module,
    options: {
        /**
         * 组件加载前触发。queryLoad执行的时候，当前组件没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取。
         * @event MWF.xApplication.process.Xform.$ElModule#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载时触发.
         * @event MWF.xApplication.process.Xform.$ElModule#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.$ElModule#postLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        "elEvents": ["focus", "blur", "change", "input", "clear"]
    },
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member MWF.xApplication.process.Xform.Elinput#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elinput").json;       //获取组件的json对象
     * var json = this.form.get("elinput").vm.$data;   //获取Vue组件的data数据，
     *
     * //通过json对象操作Element组件
     * json.size = "mini";      //改变输入框大小
     * json.disabled = true;     //设置输入框为禁用
     */
    load: function(){
        this._loadModuleEvents();

        this.form.app.addEvent('queryClose', function(){
            if (this.vm) this.vm.$destroy();
        }.bind(this));

        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
        }
    },
    reload: function(){
        if (!this.vm) return;

        var node = this.vm.$el;
        this.vm.$destroy();
        node.empty();

        this.vm = null;

        this.vueApp = null;

        this._loadUserInterface();
    },
    _checkVmodel: function(text){
        if (text){
            this.vModels = [];
            var reg = /(?:v-model)(?:.lazy|.number|.trim)?(?:\s*=\s*)(?:["'])?([^"']*)/g;
            var arr;
            while ((arr = reg.exec(text)) !== null) {
                if (arr.length>1 && arr[1]){
                    var modelId = this.json.id.substring(0, this.json.id.lastIndexOf(".."));
                    modelId = (modelId) ? modelId+".."+arr[1] : arr[1];
                    this.json[arr[1]] = this._getBusinessData(modelId) || "";
                    this.vModels.push(arr[1]);
                }
            }
        }
    },

    _loadUserInterface: function(){
        this.node.appendHTML(this._createElementHtml(), "before");
        var input = this.node.getPrevious();

        this.node.destroy();
        this.node = input;
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this.node.addClass("o2_vue");
        this._createVueApp();
    },
    _createVueApp: function(){
        if (this.json.vueSlot) this._checkVmodel(this.json.vueSlot);
        if (!this.vm) this._loadVue(this._mountVueApp.bind(this));
    },

    _loadVue: function(callback){
        var flag = (o2.session.isDebugger && this.form.app.inBrowser);
        var vue = flag ? "vue_develop" : "vue";
        //var vueName = flag ? "Vue" : "Cn";
        // if (!window.Vue || window.Vue.name!==vueName){
        //     o2.loadAll({"css": "../o2_lib/vue/element/index.css", "js": [vue, "elementui"]}, { "sequence": true }, callback);
        // }else{
        //     if (callback) callback();
        // }
        var elcssUrl = this.form.json.elementCssUrl || "../o2_lib/vue/element/index.css";
        o2.loadAll({"css": elcssUrl, "js": [vue, "elementui"]}, { "sequence": true }, callback);
    },
    _mountVueApp: function(){
        if (!this.vueApp) this.vueApp = this._createVueExtend();

        /**
         * @summary Vue对象实例
         * @see https://vuejs.org/
         * @member {VueInstance}
         */
        this.vm = new Vue(this.vueApp);
        this.vm.$mount(this.node);
    },

    _createVueExtend: function(){
        var _self = this;
        var app = {
            data: this._createVueData(),
            mounted: function(){
                _self._afterMounted(this.$el);
            }
        };
        app.methods = this._createVueMethods(app);
        this.appendVueExtend(app);
        this.appendVueWatch(app);
        this._afterCreateVueExtend(app);
        return app;
    },
    appendVueWatch: function(app){
        if (this.vModels && this.vModels.length){
            app.watch = app.watch || {};
            this.vModels.forEach(function(m){
                app.watch[m] = function(val, oldVal){
                    var modelId = this.json.id.substring(0, this.json.id.lastIndexOf(".."));
                    modelId = (modelId) ? modelId+".."+m : m;
                    this._setBusinessData(val, modelId);
                }.bind(this);
            }.bind(this));
        }
    },
    appendVueMethods: function(methods){},
    appendVueExtend: function(app){
        // if (!app.methods) app.methods = {};
        // this.options.elEvents.forEach(function(k){
        //     this._createEventFunction(app, k);
        // }.bind(this));
    },
    appendVueEvents: function(methods){
        this.options.elEvents.forEach(function(k){
            this._createEventFunction(methods, k);
        }.bind(this));
    },
    _createEventFunction: function(methods, k){
        methods["$loadElEvent_"+k.camelCase()] = function(){
            var flag = true;
            if (k==="change"){
                if (this.validationMode){
                    this.validationMode();
                    this._setBusinessData(this.getInputData());
                    if( !this.validation() ) flag = false;
                }
            }
            if (this.json.events && this.json.events[k] && this.json.events[k].code){
                this.form.Macro.fire(this.json.events[k].code, this, arguments);
            }
            if( flag )this.fireEvent(k, arguments);
        }.bind(this);
    },
    _createVueMethods: function(){
        var methods = {};
        if (this.json.vueMethods && this.json.vueMethods.code){
            methods = this.form.Macro.exec(this.json.vueMethods.code, this);
        }
        this.appendVueEvents(methods);
        this.appendVueMethods(methods);
        return methods || {};
    },
    _createVueData: function(){
        if (this.vModels && this.vModels.length){
            this.vModels.forEach(function(m){
                if (!this.json.hasOwnProperty(m)) this.json[m] = "";
            }.bind(this));
        }
        if (this.json.vueData && this.json.vueData.code){
            var d = this.form.Macro.exec(this.json.vueData.code, this);
            this.json = Object.merge(d, this.json);
        }
        if (this.json.$id===this.json.id) this.form.Macro.environment.data.check(this.json.$id);
        this.json[this.json.$id] = this._getBusinessData();
        this._appendVueData();
        return this.json;
    },

    _afterMounted: function(el){
        this.node = el;
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this._loadVueCss();
        this._loadDomEvents();
        this._afterLoaded();
        this.fireEvent("postLoad");
        this.fireEvent("load");
    },
    _loadVueCss: function(){
        if (this.styleNode){
            this.node.removeClass(this.styleNode.get("id"));
        }
        if (this.json.vueCss && this.json.vueCss.code){
            this.styleNode = this.node.getParent().loadCssText(this.json.vueCss.code, {"notInject": true});
            this.styleNode.inject(this.node.getParent(), "before");
        }
    },

    _appendVueData: function(){},
    _createElementHtml: function(){
        return "";
    },
    _afterCreateVueExtend: function (app) {}
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
//MWF.require("MWF.widget.Tree", null, false);
//MWF.require("MWF.widget.Toolbar", null, false);

/** @class Actionbar 操作条组件。
 * @o2cn 操作条
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var actionbar = this.form.get("name"); //获取操作条
 * //方法2
 * var actionbar = this.target; //在操作条和操作本身的事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Actionbar = MWF.APPActionbar =  new Class(
    /** @lends MWF.xApplication.process.Xform.Actionbar# */
    {
        Extends: MWF.APP$Module,
        options: {
            /**
             * 组件加载前触发。当前组件的queryLoad事件还没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取当前组件。
             * @event MWF.xApplication.process.Xform.Actionbar#queryLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载时触发。
             * @event MWF.xApplication.process.Xform.Actionbar#load
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载后事件.由于加载过程中有异步处理，这个时候操作条有可能还未生成。
             * @event MWF.xApplication.process.Xform.Actionbar#postLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载后事件。这个时候操作条已生成
             * @event MWF.xApplication.process.Xform.Actionbar#afterLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "moduleEvents": ["load", "queryLoad", "postLoad", "afterLoad"]
        },
        /**
         * @summary 重新加载操作条。会触发afterLoad事件
         * @example
         * this.form.get("name").reload(); //显示操作条
         */
        reload : function(){
            this._loadUserInterface();
        },
        _loadUserInterface: function(){
            // if (this.form.json.mode == "Mobile"){
            //     this.node.empty();
            // }else if (COMMON.Browser.Platform.isMobile){
            //     this.node.empty();
            // }else{
            this.toolbarNode = this.node.getFirst("div");
            if(!this.toolbarNode)return;

            this.toolbarNode.empty();

            MWF.require("MWF.widget.Toolbar", function(){
                /**
                 * @summary Toolbar组件，平台使用该组件生成操作条。
                 * @member {o2.widget.Toolbar}
                 * @example
                 *  //可以在脚本中获取该组件
                 * var toolbarWidget = this.form.get("fieldId").toolbarWidget; //获取组件对象
                 */
                this.toolbarWidget = new MWF.widget.Toolbar(this.toolbarNode, {
                    "style": this.json.style,
                    "onPostLoad" : function(){
                        this.fireEvent("afterLoad");
                    }.bind(this)
                }, this);
                if (this.json.actionStyles) this.toolbarWidget.css = this.json.actionStyles;
                //alert(this.readonly)

                if( this.json.multiTools ){ //自定义操作和系统操作混合的情况，用 system : true 来区分系统和自定义
                    var addReadActionFlag = !this.json.hideSystemTools && !this.json.hideReadedAction; //是否需要增加已阅
                    var jsonStr = JSON.stringify(this.json.multiTools);
                    jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.process.Xform.LP.form});
                    this.json.multiTools = JSON.parse(jsonStr);
                    this.json.multiTools.each( function (tool) {
                        if( tool.system ){
                            if( !this.json.hideSystemTools ){
                                if( tool.id === "action_readed" )addReadActionFlag = false;
                                this.setToolbars([tool], this.toolbarNode, this.readonly);
                            }
                        }else{
                            this.setCustomToolbars([tool], this.toolbarNode);
                        }
                    }.bind(this));
                    if( addReadActionFlag ){
                        var addActions = [
                            {
                                "type": "MWFToolBarButton",
                                "img": "read.png",
                                "title": MWF.xApplication.process.Xform.LP.setReaded,
                                "action": "readedWork",
                                "text": MWF.xApplication.process.Xform.LP.readed,
                                "id": "action_readed",
                                "control": "allowReadProcessing",
                                "condition": "",
                                "read": true
                            }
                        ];
                        this.setToolbars(addActions, this.toolbarNode, this.readonly);
                    }
                    this.toolbarWidget.load();
                }else{
                    if (this.json.hideSystemTools){
                        this.setCustomToolbars(this.json.tools, this.toolbarNode);
                        this.toolbarWidget.load();
                    }else{
                        if (this.json.defaultTools){
                            var addActions = [
                                {
                                    "type": "MWFToolBarButton",
                                    "img": "read.png",
                                    "title": MWF.xApplication.process.Xform.LP.setReaded,
                                    "action": "readedWork",
                                    "text": MWF.xApplication.process.Xform.LP.readed,
                                    "id": "action_readed",
                                    "control": "allowReadProcessing",
                                    "condition": "",
                                    "read": true
                                }
                            ];
                            //this.form.businessData.control.allowReflow =

                            //this.json.defaultTools.push(o);
                            this.setToolbars(this.json.defaultTools, this.toolbarNode, this.readonly);
                            if( !this.json.hideReadedAction ){
                                this.setToolbars(addActions, this.toolbarNode, this.readonly);
                            }

                            this.setCustomToolbars(this.json.tools, this.toolbarNode);
                            this.toolbarWidget.load();
                        }else{
                            MWF.getJSON(this.form.path+"toolbars.json", function(json){
                                this.setToolbars(json, this.toolbarNode, this.readonly, true);
                                this.setCustomToolbars(this.json.tools, this.toolbarNode);
                                this.toolbarWidget.load();
                            }.bind(this), null);
                        }
                    }
                }

                if (this.toolbarWidget.items["action_goBack"]){
                    // 异步判断是否有可退回的活动
                    if (this.form.businessData.task) o2.Actions.load('x_processplatform_assemble_surface').WorkAction.V2ListActivityGoBack(this.form.businessData.task.work, function(json){
                        if (json.data.length){
                            this.toolbarWidget.items["action_goBack"].show();
                        }
                    }.bind(this));
                }

            }.bind(this));
        },

        setCustomToolbars: function(tools, node){
            var path = "../x_component_process_FormDesigner/Module/Actionbar/";
            var iconPath = "";
            if( this.json.customIconStyle ){
                iconPath = this.json.customIconStyle+"/";
            }
            tools.each(function(tool){
                var flag = true;
                if (this.readonly){
                    flag = tool.readShow;
                }else{
                    flag = tool.editShow;
                }
                if (flag){
                    flag = true;
                    if (tool.control){
                        flag = this.form.businessData.control[tool.control]
                    }
                    if (tool.condition){
                        var hideFlag = this.form.Macro.exec(tool.condition, this);
                        flag = !hideFlag;
                    }
                    if (flag){
                        var actionNode = new Element("div", {
                            "id": tool.id,
                            "MWFnodetype": tool.type,
                            "MWFButtonImage": this.json.iconType==="font" ? "" : path+""+this.form.options.style+"/custom/"+iconPath+tool.img,
                            "MWFButtonIcon": tool.icon,
                            "title": tool.title,
                            "MWFButtonAction": "runCustomAction",
                            "MWFButtonText": tool.text
                        }).inject(node);
                        if( this.json.customIconOverStyle ){
                            actionNode.set("MWFButtonImageOver" , path+""+this.form.options.style +"/custom/"+this.json.customIconOverStyle+ "/" +tool.img );
                        }
                        if( tool.properties ){
                            actionNode.set(tool.properties);
                        }
                        if (tool.actionScript){
                            actionNode.store("script", tool.actionScript);
                        }
                        if (tool.sub){
                            var subNode = node.getLast();
                            this.setCustomToolbars(tool.sub, subNode);
                        }
                    }
                }
            }.bind(this));
        },

        getImagePath: function(img, iscustom){
            var path = "../x_component_process_FormDesigner/Module/Actionbar/";
            if( iscustom ){
                var iconPath = this.json.customIconStyle ? (this.json.customIconStyle+ "/") : "";
                return path+""+this.form.options.style+"/custom/"+iconPath+img;
            }else{
                return path+(this.options.style||"default") +"/tools/"+ (this.json.iconStyle || this.json.style || "default") +"/"+img;
            }
        },
        getImageOverPath: function(img, iscustom){
            var path = "../x_component_process_FormDesigner/Module/Actionbar/";
            if( iscustom && this.json.customIconOverStyle ){
                return path+""+this.form.options.style +"/custom/"+this.json.customIconOverStyle+ "/" +img
            }else{
                return path+""+(this.options.style||"default")+"/tools/"+( this.json.iconOverStyle || "default" )+"/"+img;
            }
        },
        setToolbarItem: function(tool, node, readonly, noCondition){
            var path = "../x_component_process_FormDesigner/Module/Actionbar/";
            var flag = true;
            if (tool.control){
                flag = this.form.businessData.control[tool.control]
            }
            if (!noCondition) if (tool.condition){
                var hideFlag = this.form.Macro.exec(tool.condition, this);
                flag = flag && (!hideFlag);
            }

            if (tool.id == "action_downloadAll" || tool.id == "action_print"){
                if (!this.form.businessData.work.startTime){
                    flag = false;
                }
            }
            if (tool.id == "action_delete"){
                if (!this.form.businessData.work || !this.form.businessData.work.id){
                    flag = false;
                }
            }

            if (tool.id == "action_rollback") tool.read = true;
            if (readonly) if (!tool.read) flag = false;
            if (flag){
                var actionNode = new Element("div", {
                    "id": tool.id,
                    "MWFnodetype": tool.type,
                    //"MWFButtonImage": this.form.path+""+this.form.options.style+"/actionbar/"+tool.img,
                    "MWFButtonImage": this.json.iconType==="font" ? "" : this.getImagePath(tool.img, tool.customImg),
                    "MWFButtonIcon": tool.icon,
                    "title": tool.title,
                    "MWFButtonAction": tool.action,
                    "MWFButtonText": tool.text,
                    "MWFHide": (tool.id === "action_goBack") ? 'true' : ''
                }).inject(node);
                if( this.json.iconOverStyle ){
                    actionNode.set("MWFButtonImageOver" , this.getImageOverPath(tool.img, tool.customImg) );
                }
                if( tool.properties ){
                    actionNode.set(tool.properties);
                }
                if (tool.sub){
                    var subNode = node.getLast();
                    this.setToolbars(tool.sub, subNode, readonly, noCondition);
                }
            }
        },
        /**
         * @summary 根据操作id获取操作，该方法在操作条的afterLoad事件中有效，操作的操作脚本有效。
         *  @param {String} id - 必选，操作id.
         *  @return {o2.widget.ToolbarButton} 操作
         *  @example
         *  var actionbar = this.form.get("name"); //获取操作条
         *  var item = actionbar.getItem( "action_delete" ); //获取删除操作
         *  item.node.hide(); //隐藏删除操作的节点
         *  item.node.click(); //触发操作的click事件
         */
        getItem : function( id ){
            if( this.toolbarWidget && id ){
                return this.toolbarWidget.items[id]
            }
        },
        /**
         * @summary 获取所有操作，该方法在操作条的afterLoad事件中有效，操作的操作脚本有效。
         *  @return {Array} 操作数组
         *  @example
         *  var actionbar = this.form.get("name"); //获取操作条
         *  var itemList = actionbar.getAllItem(); //获取操作数组
         *  itemList[1].node.hide(); //隐藏第一个操作
         */
        getAllItem : function(){
            return this.toolbarWidget ? this.toolbarWidget.childrenButton : [];
        },
        setToolbars: function(tools, node, readonly, noCondition){
            tools.each(function(tool){
                this.setToolbarItem(tool, node, readonly, noCondition);
            }.bind(this));
        },
        runCustomAction: function(bt){
            var script = bt.node.retrieve("script");
            this.form.Macro.exec(script, this);
        },
        saveWork: function(){
            this.form.saveWork();
        },
        closeWork: function(){
            this.form.closeWork();
        },
        flowWork: function(){
            this.form.flowWork();
        },
        processWork: function(){
            this.form.processWork();
        },
        resetWork: function(){
            this.form.resetWork();
        },
        addTask: function(){
            this.form.addTask();
        },
        retractWork: function(e, ev){
            this.form.retractWork(e, ev);
        },
        rerouteWork: function(e, ev){
            this.form.rerouteWork(e, ev);
        },
        deleteWork: function(){
            this.form.deleteWork();
        },
        printWork: function(){
            this.form.printWork();
        },
        readedWork: function(b,e){
            this.form.readedWork(e);
        },
        addSplit: function(e){
            this.form.addSplit(e);
        },
        rollback: function(e){
            this.form.rollback(e);
        },
        downloadAll: function(e){
            this.form.downloadAll(e);
        },
        monitor: function(e){
            this.form.monitor(e);
        },
        pressWork: function(e){
            this.form.pressWork(e);
        },
        pauseTask: function(e){
            var p = this.form.pauseTask(e);
            if (p){
                p.then(function(){
                    e.setText(MWF.xApplication.process.Xform.LP.resume);
                    e.options.action = "resumeTask";

                    var img = e.picNode.getElement("img");
                    var src = img.get("src");
                    src = src.substr(0, src.lastIndexOf("/"));
                    src = src+"/resume.png";
                    img.set("src", src);

                }.bind(this), function(){});
            }
        },
        resumeTask: function(e){
            var p = this.form.resumeTask(e);
            if (p){
                p.then(function(){
                    e.setText( MWF.xApplication.process.Xform.LP.pause);
                    e.options.action = "pauseTask";

                    var img = e.picNode.getElement("img");
                    var src = img.get("src");
                    src = src.substr(0, src.lastIndexOf("/"));
                    src = src+"/pause.png";
                    img.set("src", src);

                }.bind(this), function(){});
            }
        },
        goBack: function(e){
            this.form.goBack(e);
        },

        terminate: function(e, ev){
            this.form.terminateWork(e, ev);
        }

    });

//MWF.require("MWF.widget.PinYin", null, false);
MWF.xDesktop.requireApp("process.Xform", "Combox", null, false);
/** @class Address 地址选择组件。
 * @o2cn 地址选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var address = this.form.get("name"); //获取组件
 * //方法2
 * var address = this.target; //组件本身的事件和脚本中获取
 * @extends MWF.xApplication.process.Xform.Combox
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Address = MWF.APPAddress =  new Class(
    /** @lends MWF.xApplication.process.Xform.Address# */
    {
	Implements: [Events],
	Extends: MWF.APPCombox,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad", "commitInput", "change"]
    },

    initialize: function(node, json, form){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
    },
    _loadNode: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                this._loadNodeEdit();
            }
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        this.loadVal();
        //new Element("select").inject(this.node);
    },
    _loadNodeEdit: function(){
        this.node.empty();

        MWF.require(["MWF.widget.Combox","MWF.widget.PinYin"], function(){
            this.combox = new MWF.widget.Combox({
                "style": this.form.json.addressStyle ? this.form.json.addressStyle.style : "blue",
                "positionX": this.form.json.addressStyle ? this.form.json.addressStyle.positionX : "left",
                "onlySelect": true,
                "count": 4,
                "focusList": true,
                "onCommitInput": function(){
                    this.fireEvent("commitInput");
                }.bind(this),
                "onChange": function(e, oldValues){
                    var thisValues = this.combox.values.map(function(v){ return v.data || v.value});
                    if ((oldValues && (oldValues.join() !== thisValues.join()))){
                        while (this.combox.values.length-1>e.index){
                            this.combox.deleteItem(this.combox.values[this.combox.values.length-1])
                        }
                        this.fireEvent("change");
                    }
                }.bind(this),
                "optionsMethod": this._searchOptions.bind(this)
            });
            this.combox.intoEdit = function(e){
                if (this.options.count){
                    if (this.values.length>=this.options.count){
                        // if (this.input) this.input.noBlur = true;
                        if (this.input) this.input.node.hide();
                        // this.getLast().edit();
                        return false;
                    }
                }
                if (!this.input){
                    this.input = new MWF.widget.Combox.Input(this, this, "");
                    this.input.node.inject(this.node);
                    this.input.node.setStyle("width", "1px");
                }
                this.input.node.show();
                this.input.setInputNodeStyles();
                //this.input.node.set("value", "111");
                this.input.node.focus();
                this.input.setInputPosition();
                if (this.options.focusList) this.input.searchItems();
            }
        }.bind(this), false);

        this.combox.inject(this.node);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });

        this.combox.addEvent("change", function(){
            this.validationMode();
            if (this.validation()){
                var v = this.getInputData("change");
                this._setBusinessData(v);
                //this._setEnvironmentData(v);
            }
        }.bind(this));

        this.loadVal();
    },
    _searchOptions: function(value, callback, comboxValueObject){
        value = value.toLowerCase();
        var i;
        if( comboxValueObject ){
            i = comboxValueObject.index;
        }else{
            i = (this.combox.editItem) ? this.combox.editItem.getItemPosition() : this.combox.values.length;
        }
        if(this.json.selectRange==="province"){
            if( i > 0 ){
                if (callback) callback([]);
                return;
            }
        }else if(this.json.selectRange==="city"){
            if( i > 1 ){
                if (callback) callback([]);
                return;
            }
        }
        switch (i) {
            case 0: //省
                o2.Actions.get("x_general_assemble_control").listProvince(function(json){
                    var list = [];
                    json.data.each(function(text){
                        var k = text.name;
                        var keyword = k+MWF.widget.PinYin.toPY(k).toLowerCase()+MWF.widget.PinYin.toPYFirst(k).toLowerCase();
                        if (value){
                            //if (keyword.indexOf(value)!==-1)
                                list.push({"text": k, "value": k});
                        }else{
                            list.push({"text": k, "value": k});
                        }
                    }.bind(this));
                    // if (list.length) if (callback) callback(list);
                    if (callback) callback(list);
                }.bind(this));
                // MWF.UD.getPublicData("addr_province", function(json){
                //     var list = [];
                //     json.each(function(text){
                //         var keyword = text+MWF.widget.PinYin.toPY(text).toLowerCase()+MWF.widget.PinYin.toPYFirst(text).toLowerCase();
                //         if (value){
                //             if (keyword.indexOf(value)!==-1) list.push({"text": text, "value": text});
                //         }else{
                //             list.push({"text": text, "value": text});
                //         }
                //
                //     }.bind(this));
                //     if (list.length) if (callback) callback(list);
                // });
                break;
            case 1: //市
                var item = this.combox.getFirst();

                o2.Actions.get("x_general_assemble_control").listCity(item.data || item.value, function(json){
                    var list = [];
                    json.data.each(function(text){
                        var k = text.name;
                        var keyword = k+MWF.widget.PinYin.toPY(k).toLowerCase()+MWF.widget.PinYin.toPYFirst(k).toLowerCase();
                        if (value){
                            //if (keyword.indexOf(value)!==-1)
                                list.push({"text": k, "value": k});
                        }else{
                            list.push({"text": k, "value": k});
                        }
                    }.bind(this));
                    // if (list.length) if (callback) callback(list);
                    if (callback) callback(list);
                }.bind(this));


                // MWF.UD.getPublicData("addr_city_"+item.data, function(json){
                //     var list = [];
                //     json.each(function(text){
                //         var keyword = text+MWF.widget.PinYin.toPY(text).toLowerCase()+MWF.widget.PinYin.toPYFirst(text).toLowerCase();
                //         if (value){
                //             if (keyword.indexOf(value)!==-1) list.push({"text": text, "value": text});
                //         }else{
                //             list.push({"text": text, "value": text});
                //         }
                //     }.bind(this));
                //     if (list.length) if (callback) callback(list);
                // });
                break;
            case 2: //区
                var f = this.combox.getFirst();
                var p = f.data || f.value;
                var item = this.combox.getFirst().getNextItem();

                o2.Actions.get("x_general_assemble_control").listDistrict(p, item.data||item.value, function(json){
                    var list = [];
                    json.data.each(function(text){
                        var k = text.name;
                        var keyword = k+MWF.widget.PinYin.toPY(k).toLowerCase()+MWF.widget.PinYin.toPYFirst(k).toLowerCase();
                        if (value){
                            //if (keyword.indexOf(value)!==-1)
                                list.push({"text": k, "value": k});
                        }else{
                            list.push({"text": k, "value": k});
                        }
                    }.bind(this));
                    if (list.length) if (callback) callback(list);
                }.bind(this));


                // MWF.UD.getPublicData("addr_district_"+item.data, function(json){
                //     var list = [];
                //     json.each(function(text){
                //         var keyword = text+MWF.widget.PinYin.toPY(text).toLowerCase()+MWF.widget.PinYin.toPYFirst(text).toLowerCase();
                //         if (value){
                //             if (keyword.indexOf(value)!==-1) list.push({"text": text, "value": text});
                //         }else{
                //             list.push({"text": text, "value": text});
                //         }
                //     }.bind(this));
                //     if (list.length) if (callback) callback(list);
                // });
                break;
            default:
                if (callback) callback([]);
        }
    }
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Application 门户中嵌入的系统component对象或网页iframe（模块部署中配置的网页URL）。
 * @o2cn 嵌入的系统应用
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var application = this.form.get("fieldId"); //获取组件
 * //方法2
 * var application = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Application = MWF.APPApplication =  new Class(
    /** @lends MWF.xApplication.process.Xform.Application# */
    {
    Extends: MWF.APP$Module,
    options: {
        /**
         * component对象初始化后，加载之前触发，this.event可获取component对象。
         * @event MWF.xApplication.process.Xform.Application#queryLoadApplication
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "queryLoadApplication"]
    },

    _loadUserInterface: function(){
        /**
         * @ignore
         * @member parentLine
         * @memberOf MWF.xApplication.process.Xform.Application#
         */

        /**
         * @ignore
         * @member getSource
         * @memberOf MWF.xApplication.process.Xform.Application#
         */
        this.node.empty();
        if( this.json.activeType !== "delay" ){
            if( !o2.api ){
                MWF.require("MWF.framework", function () {
                    this.loadApplication();
                }.bind(this));
            }else{
                this.loadApplication();
            }
        }
    },
    /**
     * @summary 当组件被设置为延迟激活，通过active方法激活
     * @param {Function} callback 激活后的回调方法（不保证组件加载完成），另外已经激活过该方法还会被执行。
     * @example
     * var app = this.form.get("fieldId");
     * app.active(function(){
     *     //do someting
     * })
     */
    active: function(callback){
        if (!this.loaded) {
            this.reload(callback);
        } else {
            if (callback) callback();
        }
    },
    /**
     * @summary 重新加载嵌入对象
     * @param {Function} callback 重载后的回调
     * @example
     * this.form.get("fieldId").reload()
     */
    reload: function(callback){
        this.clean();
        this.loadApplication( callback );
    },
    /**
     * @summary 清除当前嵌入的对象
     * @example
     * this.form.get("fieldId").clean()
     */
    clean: function(){
        if(this.component){
            try{
                this.component.close();
                if(this.node)this.node.empty();
            }catch (e) {
                console.log(e);
                if(this.node)this.node.empty();
            }
            this.component = null;
        }
        if( this.iframe ){
            this.iframe.destroy();
            if(this.node)this.node.empty();
            this.iframe = null;
        }
    },
    loadApplication: function ( callback ) {
        this.clean();
        if(this.node){
            this.node.empty();
            this.node.setStyles({
                "position": "relative"
            });
            if( !this.json.styles || (!this.json.styles["background"] && !this.json.styles["background-color"] )){
                this.node.setStyle("background-color", "#eee");
            }
        }
        var status = this.getComponentStatus() || {};
        var options = this.getComponentOptions() || {};
        this.getComponentPath(function (componentPath) {
            if( componentPath && componentPath.indexOf("@url:") === 0 ){
                this.loadIframe( componentPath.substring(5, componentPath.length ), callback );
            }else{
                this.loadComponent( componentPath, status, options, callback );
            }
        }.bind(this))
    },
    /**
     * @summary 加载Iframe
     * @param {String} src iframe的src，如'https://www.baidu.com/'
     * @example
     * this.form.get("fieldId").clean(); //清除当前嵌入的对象
     * this.form.get("fieldId").loadIframe('https://www.baidu.com/'); //加载iframe
     */
    loadIframe: function( src, callback ){
        var attr = {
            "src": src,
            "width": "100%",
            "height": "100%",
            "frameborder": "0px",
            "scrolling": "auto",
            "seamless": "seamless"
        };

        /**
         * @summary 当模块部署中配置的是@url:开头的链接时，嵌入的iframe.
         * @member {Object}
         * @example
         * var iframe = this.form.get("fieldId").iframe; //获取iframe
         * iframe.src; //获取iframe的地址
         */
        this.iframe = new Element("iframe", attr).inject( this.node );
        this.loaded = true;
        if(callback)callback();
    },
    /**
     * @summary 加载系统组件
     * @param {String} path 组件的路径，如'Calendar'
     * @param {Object} [status] 组件的状态
     * @param {Object} [options] 组件的选项
     * @example
     * this.form.get("fieldId").clean(); //清除当前嵌入的对象
     * this.form.get("fieldId").loadComponent('Calendar'); //加载日程安排
     * @example
     * this.form.get("fieldId").clean(); //清除当前嵌入的对象
     * this.form.get("fieldId").loadComponent('cms.Module', {
     *  "columnId":"25434995-45d2-4c9a-a344-55ad0deff071"
     *  }); //加载id为25434995-45d2-4c9a-a344-55ad0deff071的内容管理栏目
     */
    loadComponent: function ( path, status, options, callback ) {
        var clazz = MWF.xApplication;
        if( o2.typeOf(path) !== "string" )return;
        path.split(".").each(function (a) {
            clazz[a] = clazz[a] || {};
            clazz = clazz[a];
        });
        clazz.options = clazz.options || {};

        var _load = function () {
            if( clazz.Main ){
                var opt = options || {};
                var stt = status || {};
                opt.embededParent = this.node;

                /**
                 * @summary 嵌入的component对象.
                 * @member {Object}
                 * @example
                 * var app = this.form.get("fieldId").component; //获取component对象
                 * app.recordStatus(); //获取应用的当前状态
                 * app.refresh();      //刷新应用
                 * app.dialog(option); //弹出一个对话框（详见MWF.widget.Dialog）
                 * app.notice(content, type, target, where, offset); //显示一个通知消息
                 * app.confirm(type, e, title, text, width, height, ok, cancel); //显示一个确认框
                 * app.alert(type, e, title, text, width, height); //弹出一个信息框
                 * app.addEvent(type, fun); //为应用绑定一个事件
                 */
                this.component = new clazz.Main(this.form.app.desktop, opt);
                this.component.status = stt;
                this.fireEvent("queryLoadApplication", this.component);
                this.component.load();
                this.component.setEventTarget(this.form.app);
                var _self = this;
                this.component.refresh = function () {
                    if( layout.inBrowser ){
                        window.location.reload();
                    }else{
                        _self.form.app.refresh();
                    }
                };
            }else{
                if( MWF.xApplication.process && MWF.xApplication.process.Xform && MWF.xApplication.process.Xform.LP ){
                    this.form.app.notice(MWF.xApplication.process.Xform.LP.applicationNotFound+":"+path, "error");
                }else{
                    this.form.app.notice(this.form.app.lp.applicationNotFound+":"+path, "error");
                }
            }
            this.loaded = true;
            if(callback)callback();
        }.bind(this);

        try{
            MWF.xDesktop.requireApp(path, "lp."+o2.language, null, false);
            MWF.xDesktop.requireApp(path, "Main", null, false);
            if (clazz.loading && clazz.loading.then){
                clazz.loading.then(function(){
                    _load();
                });
            }else{
                _load();
            }
        }catch (e) {
            this.form.app.notice( e.message, "error" );
        }
    },
    /**
     * @summary 获取获取表单设计配置的component对象的路径
     * @param {Function} callback 获取路径后的回调方法，参数为路径
     * @example
     * this.form.get("fieldId").getComponentPath(function(path){
     *     //path为路径
     * })
     */
    getComponentPath: function(callback){
        var path;
        if (this.json.componentType==="script"){
            if (this.json.componentScript && this.json.componentScript.code){
                path = this.form.Macro.exec(this.json.componentScript.code, this);
            }
        }else{
            if (this.json.componentSelected && this.json.componentSelected!=="none"){
                path = this.json.componentSelected;
            }else{
                path = "";
            }
        }
        Promise.resolve(path).then(function (p) {
            callback(p || "");
        })
    },
    /**
     * @summary 获取表单设计配置的component对象的参数
     * @return 设置的参数
     * @example
     * var param = this.form.get("fieldId").getComponentOptions()
     */
    getComponentOptions : function(){
        var params = "";
        if( this.json.optionsType === "map" ){
            params = this.json.optionsMapList;
        }else if( this.json.optionsType === "script" ){
            var code = (this.json.optionsScript) ? this.json.optionsScript.code : "";
            if (code){
                params = this.form.Macro.exec(code, this);
            }
        }
        return params;
    },
    /**
     * @summary 获取表单设计配置的component对象的状态
     * @return 设置的状态
     * @example
     * var param = this.form.get("fieldId").getComponentStatus()
     */
    getComponentStatus: function(){
        var params = "";
        if( this.json.statusType === "map" ){
            params = this.json.statusMapList;
        }else if( this.json.statusType === "script" ){
            var code = (this.json.statusScript) ? this.json.statusScript.code : "";
            if (code){
                params = this.form.Macro.exec(code, this);
            }
        }
        return params;
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class AssociatedDocument 视图选择组件。
 * @o2cn 视图选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var sourceText = this.form.get("fieldId"); //获取组件
 * //方法2
 * var sourceText = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.Button
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.AssociatedDocument = MWF.APPAssociatedDocument =  new Class(
    /** @lends MWF.xApplication.process.Xform.AssociatedDocument# */
    {
	Implements: [Events],
	Extends: MWF.APP$Module,
    options: {
        /**
         * 视图参数（options）已经准备好，还未加载视图时执行。可以通过this.event得到视图参数，并可修改this.event修改视图的加载。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#beforeLoadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 异步加载视图后执行。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#loadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 选中视图中的一条记录后执行。可以通过this.event获取该次选择的记录。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#select
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 取消选中视图中的一条记录后执行。可以通过this.event获取该次取消选择的记录。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#unselect
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 点击确定后执行的事件。可以通过this.event获取选择的记录列表。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#selectResult
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 选择完成后，并且整理了关联文档数据后事件。可以通过this.event获取记录列表。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#afterSelectResult
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除关联文档前执行的事件。可以通过this.event获取删除的记录。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#deleteDocument
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除关联文档后执行的事件。可以通过this.event获取删除的记录。
         * @event MWF.xApplication.process.Xform.AssociatedDocument#afterDeleteDocument
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        // /**
        //  * 打开关联文档前执行的事件。
        //  * @event MWF.xApplication.process.Xform.AssociatedDocument#openDocument
        //  * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
        //  */
        "moduleEvents": ["load", "queryLoad", "postLoad", "beforeLoadView", "loadView", "select", "unselect", "selectResult",
            "afterSelectResult", "deleteDocument","afterDeleteDocument","openDocument"]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);

        this.json = json;

        this.form = form;

        this.parentLine = null;
        //只是为了校验
        this.field = true;
        this.fieldModuleLoaded = false;
    },
	_loadUserInterface: function(){

        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });

        /**
         * @summary 当前组件关联的文档。
         * @member documentList {Array<Object>}
         * @memberOf MWF.xApplication.process.Xform.AssociatedDocument
         * @example
         *  //可以在脚本中获取该组件
         * var documentList = this.form.get("fieldId").documentList; //当前组件关联的文档
         */
        this.documentList = [];

        var button = this.node.getElement("button");
        if( this.isReadonly() ){
            if( button )button.hide();
        }else{
            if (!button) button = new Element("button");
            this.button = button;
            this.button.set({
                "text": this.json.buttonText,
                "styles": this.json.buttonStyles
            });

            this.button.addEvent("click", function(){
                this.selectedData = null;
                this.selectView(function(data){
                    // if(data.length === 0){
                    //     this.form.notice(MWF.xApplication.process.Xform.LP.selectDocNote, "info");
                    //     return;
                    // }
                    var d = data.map(function (d) {
                        return {
                            "type": d.type === "process" ? "processPlatform" : "cms",
                            "site": this.json.site || this.json.id,
                            "view": d.view,
                            "bundle": d.bundle
                        }
                    }.bind(this));
                    this.selectDocument(d);
                }.bind(this));
            }.bind(this));

            if( this.json.style === 'v10' ){
                this.button.addClass('form-content-button');
            }
        }


        if(this.json.recoveryStyles){
            this.node.setStyles(this.json.recoveryStyles);
        }

        this.documentListNode = this.node.getElement(".MWFADContent");
        this.documentListNode.setStyles( this.json.documentListNodeStyles || {} );

        this.loadAssociatedDocument();
	},
    _createAssociation: function( data, async ){
        return o2.Actions.load("x_processplatform_assemble_surface").CorrelationAction.createWithJob(
            this.getBundle(),
            { targetList: data },
            null,
            null,
            async !== false
        );
    },
    _cancelAssociated: function(ids, async){
        return o2.Actions.load("x_processplatform_assemble_surface").CorrelationAction.deleteWithJob(
            this.getBundle(),
            { idList: ids },
            null,
            null,
            async !== false
        );
    },
    _listAllAssociated: function(async){
        return o2.Actions.load("x_processplatform_assemble_surface").CorrelationAction.listWithJobWithSite(
            this.getBundle(),
            this.json.site || this.json.id,
            null,
            null,
            async !== false
        );
    },
    _parseData: function(data){
        !data && (data = []);
        typeOf(data) !== 'array' && (data = [data]);
        data.each(function(d){
            !d.type && (d.type = 'processPlatform');
            d.site = this.json.site || this.json.id;
        }.bind(this));
        return data;
    },
    getLp: function(){
        return MWF.xApplication.process.Xform.LP;
    },
    /**
     * @summary 设置关联文档，清空所有的已关联文档后再关联。
     * @param data{Object[]} .
     * @param [callback] {Function}
     * @param [async] {Boolean} 是否异步执行，默认为异步。如果组件未加载完成的时候执行该方法，强制为异步。
     * @return {Promise}
     * @example
     *  this.form.get("fieldId").set([{
     *      type: 'processPlatform', //类型，processPlatform表示流程，cms表示内容管理，如果为空默认为流程
     *      bundle: '', //流程实例的 job, 或者是内容管理文档的id
     *      view: '' //视图的id
     *  }], function(json){
     *      //json.data.failureList 关联失败列表
     *      //json.data.successList 关联成功列表
     *  }, true);
     * @example
     *  var p = this.form.get("fieldId").set([{
     *      type: 'processPlatform',
     *      bundle: '',
     *      view: ''
     *  }]);
     *  p.then(function(json){
     *      //json.data.failureList 关联失败列表
     *      //json.data.successList 关联成功列表
     *  })
     *  @example
     *  this.form.get('fieldId').set([])取消所有关联
     */
    set: function(data, callback, async){
        var after = function (json){
            if( json.data.failureList && json.data.failureList.length ){
                this.form.notice(this.getLp().associatedFailureMessage.replace('{count}', json.data.failureList.length), 'error');
            }
            this.loadAssociatedDocument();
            this.validationMode();
            !!callback && callback(json);
        }.bind(this);
        data = this._parseData(data);
        async = async !== false;
        var execute = function(){
            if( async ){
                return Promise.resolve(
                    this.cancelAllAssociated( null, true, true )
                ).then(function(json){
                    var p = !!data.length ? this._createAssociation(data) : {data: {}};
                    return Promise.resolve(p).then( after );
                }.bind(this));
            }else{
                this.cancelAllAssociated( null, false, true);
                var json = !!data.length ? this._createAssociation(data, false) : {data: {}};
                after(json);
                return json;
            }
        }.bind(this);

        return this.listPromise ? this.listPromise.then( execute ) : execute();
    },
    /**
     * @summary 根据传入的数据添加关联文档。
     * @param data {Object[]}
     * @param [toTop]{Boolean} 是否添加到已有文档前面，默认为否。
     * @param [keepOrder]{Boolean} 如果添加的已经存在，是否保留原有位置, 默认不保留。
     * @param [callback] {Function}
     * @param [async]{Boolean} 是否为异步，默认为异步。如果组件未加载完成的时候执行该方法，强制为异步。
     * @return {Promise|Object}
     * @example
     *  this.form.get("fieldId").add([{
     *      type: 'processPlatform', //类型，processPlatform表示流程，cms表示内容管理，如果为空默认为流程
     *      bundle: '', //流程实例的 job, 或者是内容管理文档的id
     *      view: '' //视图的id
     *  }],
     *  true,
     *  true,
     *  function(json){
     *      //json.data.failureList 关联失败列表
     *      //json.data.successList 关联成功列表
     *  }, true);
     * @example
     *  var p = this.form.get("fieldId").add([{
     *      type: 'processPlatform',
     *      bundle: '',
     *      view: ''
     *  }]);
     *  p.then(function(json){
     *      //json.data.failureList 关联失败列表
     *      //json.data.successList 关联成功列表
     *  })
     */
    add: function(data, toTop, keepOrder, callback, async){
        var execute = function(){
            data = this._parseData(data);
            var remains = this.documentList.map(function(d){
                return {
                    type: d.targetType,
                    bundle: d.targetBundle,
                    view: d.view
                };
            });
            var filter = (arr1, arr2) => {
                var bundles = arr1.map(function(d){ return d.bundle; });
                arr2 = arr2.filter(function(d){
                    return !bundles.contains( d.bundle );
                });
                return arr2;
            };
            if( !!keepOrder ){
                data = filter(remains, data);
            }else{
                remains = filter(data, remains);
            }
            data = !toTop ? remains.concat(data) : data.concat(remains);
            return this.set(data, callback, async);
        }.bind(this);

        return this.listPromise ? this.listPromise.then( execute ) : execute();
    },
    /**
     * @summary 取消指定的关联。
     * @param bundles {String[]}
     * @param [callback] {Function}
     * @param [async]{Boolean} 是否为异步，默认为异步。如果组件未加载完成的时候执行该方法，强制为异步。
     * @return {Promise}
     * @example
     *  this.form.get("fieldId").cancel([id1, id2]);
     */
    cancel: function(bundles, callback, async){
        var execute = function(){
            var remains = this.documentList.filter(function(d){
                return !bundles.contains(d.targetBundle);
            }).map(function(d){
                return {
                    type: d.targetType,
                    bundle: d.targetBundle,
                    view: d.view
                };
            });
            return this.set(remains, callback, async);
        }.bind(this);

        return this.listPromise ? this.listPromise.then( execute ) : execute();
    },
    /**
     * @summary 得到关联的列表。
     * @return {Promise|Object[]} 如果组件未加载完成的时候执行该方法，返回promise，否则返回对象数组。
     * <pre>
     * [
     *     {
     *         "site": "associatedDocument", //组件site，如果没有设置，则为组件id
     *         "type": "cms", //类型，processPlatform表示流程，cms表示内容管理
     *         "bundle": "909b78e1-3ec2-4c63-b756-200ff734c318", //流程实例的 job, 或者是内容管理文档的id
     *         "view": "b5bd7fae-239e-4cab-aa34-8c63350d9e97" //视图的id
     *     }
     * ]
     * </pre>
     * @example
     * var documentList = this.form.get('fieldId').get();
     * @example
     * var documentList = Promise.resolve( this.form.get('fieldId').get() )
     */
    get: function(){
        var execute = function(){
            return this.documentList.map(function(d){
                return {
                    site: d.site || this.json.site || this.json.id,
                    type: d.targetType,
                    bundle: d.targetBundle,
                    view: d.view
                };
            });
        }.bind(this);

        return this.listPromise ? this.listPromise.then( execute ) : execute();
    },
    getData: function(){
        return this.documentList;
    },
    selectDocument: function(data){
        this.cancelAllAssociated( function () {
            if( data && data.length ){
                var p = this._createAssociation(data);
                p.then(function (json){
                    this.status = "showResult";
                    if( this.dlg ){
                        if(this.dlg.titleText)this.dlg.titleText.set("text", MWF.xApplication.process.Xform.LP.associatedResult);
                        if( layout.mobile ){
                            var okAction = this.dlg.node.getElement(".MWF_dialod_Action_ok");
                            if (okAction) okAction.hide();
                        }else{
                            var okNode = this.dlg.button.getFirst();
                            if(okNode){
                                okNode.hide();
                                var cancelButton = okNode.getNext();
                                if(cancelButton)cancelButton.set("value", o2.LP.widget.close);
                            }
                        }
                    }else if(this.dlg_mobile){
                        var toolbar = this.dlg_mobile.contentNode.querySelector('.mwf_selectView_action');
                        if(toolbar){
                            toolbar.querySelectorAll('oo-button').forEach((btn)=> !btn.hasClass('hide') && btn.addClass('hide'));
                            toolbar.querySelector('.mwf_selectView_action_close').removeClass('hide');
                        }
                    }

                    if( (json.data.failureList && json.data.failureList.length) || (json.data.successList && json.data.successList.length)  ){
                        this.showCreateResult(json.data.failureList, json.data.successList);
                    }
                    this.loadAssociatedDocument(function () {
                        this.fireEvent("afterSelectResult", [this.documentList]);
                        this.validationMode();
                    }.bind(this));
                }.bind(this));
            }else{
                this.status = "showResult";
                this.loadAssociatedDocument(function () {
                    this.fireEvent("afterSelectResult", [this.documentList]);
                    this.validationMode();
                }.bind(this));
                if( this.dlg )this.dlg.close();
            }
        }.bind(this));
    },
    cancelAllAssociated: function( callback, async, force ){
	    var _self = this;
	    if( this.documentList.length ){
            var ids = [];
            if( !!force || this.json.reserve === false ){
                ids = this.documentList.map(function (doc) {
                    return doc.id;
                });
            }else{
                var viewIds = (this.json.queryView || []).map(function (view) {
                   return view.id;
                });
                var docs = this.documentList.filter(function (doc) {
                    return viewIds.contains( doc.view );
                });
                ids = docs.map(function (doc) {
                    return doc.id;
                });
            }
            var p = this._cancelAssociated(ids, async);
            return p.then(function (json) {
                !!callback && callback();
            }.bind(this));
        }else{
            !!callback && callback();
            return Promise.resolve();
        }
    },
    loadAssociatedDocument: function( callback ){
        this.documentListNode.empty();
        var p = this._listAllAssociated();
        this.listPromise = p;
	    p.then(function (json) {
            this.documentList = json.data;
            this.showDocumentList();
            this.listPromise = null;
            !!callback && callback();
        }.bind(this));
    },
    showCreateResult: function(failureList, successList){
	    this.viewList.each(function (view) {
            view.showAssociatedDocumentResult(failureList, successList);
        })
    },
    showDocumentList: function(){
        this.documentList.each(function(d){
            if(d.targetCreatorPerson)d.targetCreatorPersonCn = d.targetCreatorPerson.split("@")[0];
        })
        this.documentListNode.empty();
	    switch (this.json.mode) {
            case "text":
                this.loadDocumentListText();  break;
            case "script":
                this.loadDocumentListScript();  break;
            case "default":
            default:
                this.loadDocumentListDefault();  break;
        }
    },
    loadDocumentListDefault: function(){
        if( this.json.style === 'v10' ){
            this.table = new Element('table', {
                "style": "width: 100%;border-collapse:collapse;",
                "border": "0",
                "cellPadding": "2",
                "cellSpacing": "0"
            }).inject(this.documentListNode);

            var lp = MWF.xApplication.process.Xform.LP;

            var hasCMS = this.documentList.some(function (d) { return d.targetType !== "processPlatform"; });
            var hasProcess = this.documentList.some(function (d) { return d.targetType === "processPlatform"; });

            var headerNode = new Element("tr").inject(this.table);
            var titles = [];
            var titlesWidth = ['', '', '', '6rem', '6rem', '20rem', ''];
            if( hasCMS && hasProcess ){
                titles = ['', lp.title, lp.documentType,
                    lp.processName+"/"+lp.categoryName,
                    lp.draftPerson+"/"+lp.publishPerson,
                    lp.draftTime+"/"+lp.publishTime, '' ];
            }else if(hasCMS){
                titles = ['', lp.title, lp.categoryName, lp.documentType, lp.publishPerson, lp.publishTime, '' ];
            }else if( hasProcess ){
                titles = ['', lp.title, lp.processName, lp.documentType, lp.draftPerson, lp.draftTime, ''];
            }
            titles.each(function (title, i){
                var th = new Element("th", {text: title}).inject(headerNode);
                if( titlesWidth[i] ){
                    th.setStyle('width', titlesWidth[i]);
                }
            })

            this.documentList.each(function (d) {
                this.loadDocumentListDefault_V10(d);
            }.bind(this));
        }else{
            this.documentList.each(function (d) {
                var itemNode = new Element("div", {
                    styles:  this.form.css.associatedDocumentItem
                }).inject( this.documentListNode );
                var iconNode = new Element("div", {
                    styles:  this.form.css[ d.targetType === "processPlatform" ? "associatedDocumentWorkIcon" : "associatedDocumentCmsIcon" ]
                }).inject( itemNode );

                var deleteNode;
                if( !this.isReadonly() ){
                    deleteNode = new Element("div", {
                        styles:  this.form.css.associatedDocumentDelete
                    }).inject( itemNode );
                    if(!layout.mobile)deleteNode.hide();
                }

                var textNode = new Element("div", {
                    styles:  this.form.css.associatedDocumentText,
                    text: d.targetTitle
                }).inject( itemNode );
                this._loadDocument(d, itemNode, deleteNode)
            }.bind(this))
        }
    },
    loadDocumentListDefault_V10: function (d){
        var lp = MWF.xApplication.process.Xform.LP;
        var itemNode = new Element("tr").inject( this.table );
        var iconNode, textNode ,typeNode, categoryNode, personNode, timeNode;

        if( d.targetType === "processPlatform" ){
             iconNode = new Element("td.process-icon.ooicon-liucheng").inject(itemNode);
             textNode = new Element("td", {text: d.targetTitle}).inject(itemNode);
             categoryNode = new Element("td", {text: d.targetCategory}).inject(itemNode);
             typeNode = new Element("td", {text: lp.work}).inject(itemNode);
             personNode = new Element("td", {text: d.targetCreatorPersonCn}).inject(itemNode);
             timeNode = new Element("td", {text: d.targetStartTime}).inject(itemNode);
        }else{
            iconNode = new Element("td.doc-icon.ooicon-doc-cooperation").inject(itemNode);
            textNode = new Element("td", {text: d.targetTitle}).inject(itemNode);
            categoryNode = new Element("td", {text: d.targetCategory}).inject(itemNode);
            typeNode = new Element("td", {text: lp.document}).inject(itemNode);
            personNode = new Element("td", {text: d.targetCreatorPersonCn}).inject(itemNode);
            timeNode = new Element("td", {text: d.targetStartTime}).inject(itemNode);
        }
        var deleteNode = new Element("td.ooicon-delete").inject(itemNode);
        if( !this.isReadonly() ){
            deleteNode.addEvents({
                "click": function (ev) {
                    this.cancelAssociated(ev, d, itemNode);
                    ev.stopPropagation();
                }.bind(this)
            });
        }else{
            deleteNode.hide();
        }

        itemNode.addEvent('click', function (e) { this.openDoc(e, d); }.bind(this));
        itemNode.addEvent('mouseover', function (e) { itemNode.addClass(); }.bind(this));
    },
    loadDocumentListText: function(){
        var lp = MWF.xApplication.process.Xform.LP;
        this.documentList.each(function (d) {
            var html = this.json.textStyle;
            if (this.json.textStyleScript && this.json.textStyleScript.code) {
                this.form.Macro.environment.line = d;
                html = this.form.Macro.exec(this.json.textStyleScript.code, this);
            }
            html = html.replace(/\{targetTitle\}/g, o2.txt(d.targetTitle));
            html = html.replace(/\{targetStartTime\}/g, (d.targetType === "processPlatform") ? d.targetStartTime : d.targetStartTime);
            html = html.replace(/\{targetCreatorPersonCn\}/g, o2.txt((d.targetType === "processPlatform") ? d.targetCreatorPersonCn : d.targetCreatorPersonCn));
            html = html.replace(/\{targetType\}/g, o2.txt((d.targetType === "processPlatform") ? lp.work : lp.document));
            html = html.replace(/\{targetCategory\}/g, o2.txt((d.targetType === "processPlatform") ? d.targetCategory : d.targetCategory));
            var itemNode = new Element("div", {
                styles:  this.form.css.associatedDocumentItem,
                html: html
            }).inject(this.documentListNode);
            var deleteNode = itemNode.getElement("[data-o2-action='delete']");
            if(!layout.mobile)deleteNode.hide();
            this._loadDocument(d, itemNode, deleteNode);
        }.bind(this))
    },
    loadDocumentListScript: function(){
        if (this.json.displayScript && this.json.displayScript.code){
            var code = this.json.displayScript.code;
            this.documentList.each(function(d){
                var itemNode = new Element("div", {
                    styles:  this.form.css.associatedDocumentItem,
                }).inject(this.documentListNode);

                this.form.Macro.environment.line = d;
                var r = this.form.Macro.exec(code, this);
                var t = o2.typeOf(r);
                if (t==="string"){
                    itemNode.set("html", r);
                }else if (t==="element"){
                    r.inject(itemNode);
                }
                var deleteNode = itemNode.getElement("[data-o2-action='delete']");
                deleteNode.hide();
                this._loadDocument(d, itemNode, deleteNode);
            }.bind(this));
        }
    },
    _loadDocument: function(d, itemNode, deleteNode){
	    if( layout.mobile ){
            itemNode.addEvents({
                "click": function (e) {
                    this.openDoc(e, d);
                }.bind(this),
            });
        }else{
            itemNode.addEvents({
                "mouseover": function () {
                    if(deleteNode)deleteNode.show();
                    itemNode.setStyles( this.form.css.associatedDocumentItem_over )
                }.bind(this),
                "mouseout": function () {
                    if(deleteNode)deleteNode.hide();
                    itemNode.setStyles( this.form.css.associatedDocumentItem )
                }.bind(this),
                "click": function (e) {
                    this.openDoc(e, d);
                }.bind(this),
            });
        }
        if( deleteNode ){
            if( !this.isReadonly() ){
                deleteNode.addEvents({
                    "click": function (ev) {
                        this.cancelAssociated(ev, d, itemNode);
                        ev.stopPropagation();
                    }.bind(this)
                });
            }else{
                deleteNode.hide();
            }
        }
        if( this.json.showCard !== false ){
            this.createInforNode( itemNode, d );
        }
    },
    cancelAssociated: function(e, d, itemNode){
        var lp = MWF.xApplication.process.Xform.LP;
        var _self = this;
        this.form.confirm("warn", e, lp.cancelAssociatedTitle, lp.cancelAssociated.replace("{title}", o2.txt(d.targetTitle)), 370, 120, function () {
            _self.fireEvent("deleteDocument", [d]);

            var p = _self._cancelAssociated([d.id]);
            p.then(function (json) {
                itemNode.destroy();
                _self.documentList.erase(d);
                _self.fireEvent("afterDeleteDocument", [d]);
                this.close();
            }.bind(this));
        }, function () {
            this.close();
        }, null, null, this.form.json.confirmStyle);
    },
    createInforNode: function(itemNode, d){
        var lp = MWF.xApplication.process.Xform.LP;
        var inforNode = new Element("div");
        var html = "";
        var lineStyle = "clear: both; overflow:hidden";
        var titleStyle = "width:60px; float:left; font-weight: bold";
        var contentStyle = "width:120px; float:left; margin-left:10px";
        if( d.targetType === "processPlatform" ){
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.documentType+": </div><div style='"+contentStyle+"'>"+lp.work+"</div></div>";
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.processName+": </div><div style='"+contentStyle+"'>"+d.targetCategory+"</div></div>";
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.draftPerson +": </div><div style='"+contentStyle+"'>"+d.targetCreatorPersonCn+"</div></div>";
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.draftTime +": </div><div style='"+contentStyle+"'>"+d.targetStartTime+"</div></div>";
        }else{
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.documentType+": </div><div style='"+contentStyle+"'>"+lp.document+"</div></div>";
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.categoryName+": </div><div style='"+contentStyle+"'>"+d.targetCategory+"</div></div>";
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.publishPerson+": </div><div style='"+contentStyle+"'>"+d.targetCreatorPersonCn+"</div></div>";
            html += "<div style='"+lineStyle+"'><div style='"+titleStyle+"'>"+lp.publishTime+": </div><div style='"+contentStyle+"'>"+d.targetStartTime+"</div></div>";
        }

        inforNode.set("html", html);

        if (!layout.mobile){
            this.tooltip = new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: itemNode,
                transition: 'flyin'
            });
        }
    },
    getBundle: function(){
	   return this.form.businessData.work.job;
    },
    selectView: function(callback){
        this.status = "select";
        var viewDataList = this.json.queryView;
        if( !viewDataList )return;
        viewDataList = typeOf(viewDataList) === "array" ? viewDataList : [viewDataList];
        if (viewDataList.length){

            var selectedJobs = this.documentList.map(function (d) {
                return d.targetBundle;
            });

            var disableSelectJobs = [];
            //var disableSelectJobs = Array.clone(selectedJobs);
            disableSelectJobs.push( this.getBundle() );

            var viewJsonList = [];
            this.viewJsonList = viewJsonList;

            this.selectedBundleMap = {};
            this.documentList.each(function (d) {
                var viewid = d.properties.view;
                if( !this.selectedBundleMap[viewid] )this.selectedBundleMap[viewid] = [];
                this.selectedBundleMap[viewid].push( d.targetBundle );
            }.bind(this));

            viewDataList.each(function (viewData) {
                var filter = null;
                var filterList = (this.json.viewFilterScriptList || []).filter(function (f) {
                    return f.id === viewData.id;
                });
                if( filterList.length ){
                    filter = this.form.Macro.exec(filterList[0].script.code, this);
                }

                var viewJson = {
                    "application": viewData.appName,
                    "viewName": viewData.name,
                    "viewId": viewData.id,
                    "isTitle": this.json.isTitle || "yes",
                    "select": this.json.select || "single",
                    "titleStyles": this.json.titleStyles,
                    "itemStyles": this.json.itemStyles,
                    "isExpand": this.json.isExpand || "no",
                    "showActionbar" : this.json.actionbar === "show",
                    "filter": filter,
                    //"defaultSelectedScript" : function (obj) {
                    //    return selectedJobs.contains(obj.data.bundle);
                    //},
                    "selectedAbleScript" : function (obj) {
                        return !disableSelectJobs.contains(obj.data.bundle);
                    }
                };
                viewJsonList.push( viewJson );
            }.bind(this));
            this.fireEvent("beforeLoadView", [viewDataList]);

            if (layout.mobile && o2.version.dev===10){
                this.selectViewMobile(callback);
            }else{
                this.selectViewPc(callback);
            }

        }
    },
    loadViewers: function(viewNode, dlg){


        MWF.require("MWF.widget.Tab", null, false);

        this.viewTabArea = new Element('div.tabTitleArea').inject(viewNode);
        this.viewContentNode = new Element('div.tabContentArea').inject(viewNode);

        this.tab = new MWF.widget.Tab(this.viewTabArea, {
            "style": layout.mobile && o2.version.dev === 10 ? 'v10_mobile' : "script"
        });
        this.tab.load();
        this.tab.contentNodeContainer.inject(this.viewContentNode)

        // if( layout.mobile && o2.version.dev === 10 ){
        //     this.viewTabArea.setStyles({
        //         "border-top": "1px solid #ccc",
        //         "border-bottom": "0.624rem solid rgb(247, 247, 247)"
        //     });
        // }

        MWF.xDesktop.requireApp("query.Query", "Viewer", function(){
            // this.view = new MWF.xApplication.query.Query.Viewer(dlg.content, viewJson, {
            //     "style": "select"
            // }, this.form.app, this.form.Macro );

            this.viewList = [];
            this.viewJsonList.each(function (viewJson, index) {
                var tabViewNode = Element("div", {"styles": {"height": "100%"}});
                var pageViewNode = new Element("div.pageViewNode").inject(tabViewNode);

                var viewPage = this.tab.addTab(tabViewNode, viewJson.viewName);

                var selectedBundles = this.selectedBundleMap[ viewJson.viewId ] || [];
                if( layout.mobile && o2.version.dev === 10 ){
                    pageViewNode.setStyle("height", '100%');
                }else{
                    var viewHeight = dlg.content.getSize().y - this.tab.tabNodeContainer.getSize().y - 1;
                    pageViewNode.setStyle("height", viewHeight);
                }

                var view = new MWF.xApplication.query.Query.Viewer(pageViewNode, viewJson, {
                    "isloadContent": this.status !== "showResult",
                    "isloadActionbar": this.status !== "showResult",
                    "isloadSearchbar": this.status !== "showResult",
                    "style": "select",
                    "defaultBundles": this.selectedBundleMap[viewJson.viewId] || [],
                    "onLoadView": function(){
                        this.fireEvent("loadView");
                    }.bind(this),
                    "onSelect": function(item){
                        this.fireEvent("select", [item]);
                    }.bind(this),
                    "onUnselect": function(item){
                        selectedBundles.erase( item.data.bundle );
                        this.fireEvent("unselect", [item]);
                    }.bind(this),
                    "onOpenDocument": function(options, item){
                        this.openOptions = {
                            "options": options,
                            "item": item
                        };
                        this.fireEvent("openViewDocument", [this.openOptions]);
                        this.openOptions = null;
                    }.bind(this)
                }, this.form.app, this.form.Macro)

                if( layout.mobile && o2.version.dev === 10 ){
                    view.addEvent('selectRow', (row)=>{
                        row.node.addClass('selectedRow');
                    });
                    view.addEvent('unselectRow', (row)=>{
                        row.node.removeClass('selectedRow');
                    });
                }

                viewPage.Viewer = view;
                this.viewList.push(view);

                viewPage.addEvent("postShow", function () {
                    if( viewPage.Viewer && viewPage.Viewer.node ){
                        viewPage.Viewer.setContentHeight();
                    }
                    // var viewHeight = dlg.content.getSize().y - this.tab.tabNodeContainer.getSize().y;
                    // pageViewNode.setStyle("height", viewHeight);
                }.bind(this));

                if( index === 0 )viewPage.showTabIm();

            }.bind(this));


        }.bind(this));
    },
    selectViewPc: function(callback){
        var options = {};
        // var width = options.width || "850";
        // var height = options.height || "700";
        var width = this.json.DialogWidth || "850";
        var height = this.json.DialogHeight || "700";

        if (layout.mobile){
            var size = document.body.getSize();
            width = size.x;
            height = size.y;
            options.style = "viewmobile";
        }
        width = width.toInt();
        height = height.toInt();

        var size = this.form.app.content.getSize();
        var x = (size.x-width)/2;
        var y = (size.y-height)/2;
        if (x<0) x = 0;
        if (y<0) y = 0;
        if (layout.mobile){
            x = 20;
            y = 0;
        }

        var _self = this;
        MWF.require("MWF.xDesktop.Dialog", function(){
            var dlg = new MWF.xDesktop.Dialog({
                "title": this.json.title || MWF.xApplication.process.Xform.LP.associatedDocument,
                "style": options.style || "v10_view",
                "top": y,
                "left": x-20,
                "fromTop":y,
                "fromLeft": x-20,
                "width": width,
                "height": height,
                "html": "",
                "maskNode": layout.mobile?$(document.body) : this.form.app.content,
                "container": layout.mobile?$(document.body) : this.form.app.content,
                "buttonList": [
                    {
                        "text": MWF.LP.process.button.ok,
                        "action": function(){
                            //if (callback) callback(_self.view.selectedItems);

                            _self.afterSelectView( callback, dlg );
                            //this.close();
                        }
                    },
                    {
                        "text": MWF.LP.process.button.cancel,
                        "action": function(){this.close();}
                    }
                ],
                "onQueryClose": function () {
                    this.dlg = null;
                }.bind(this),
                "onPostShow": function(){
                    if(layout.mobile){
                        dlg.node.setStyle("z-index",200);
                    }
                    this.loadViewers(dlg.content, dlg);
                }.bind(this)
            });
            this.dlg = dlg;
            dlg.show();

            if (layout.mobile){
                if(dlg.title)dlg.title.addClass("mainColor_color");
                var backAction = dlg.node.getElement(".MWF_dialod_Action_back");
                var okAction = dlg.node.getElement(".MWF_dialod_Action_ok");
                if (backAction) backAction.addEvent("click", function(e){
                    dlg.close();
                }.bind(this));
                if (okAction) okAction.addEvent("click", function(e){
                    //if (callback) callback(this.view.getData());
                    _self.afterSelectView( callback, dlg );
                    //dlg.close();
                }.bind(this));
            }
        }.bind(this));
    },
    selectViewMobile: function (callback){
        var _renderViewContainerMobile = this.form.Macro.environment._renderViewContainerMobile;
        var viewer = null;
        _renderViewContainerMobile(
            this.json.title || MWF.xApplication.process.Xform.LP.associatedDocument,
            (viewNode, o)=>{
                this.loadViewers(viewNode);
                this.dlg_mobile = o;
                // MWF.xDesktop.requireApp("query.Query", "Viewer", ()=>{
                //     viewer = new MWF.xApplication.query.Query.Viewer(viewNode, viewJson, viewOptions, _form.app, _form.Macro);
                //     viewer.addEvent('selectRow', (row)=>{
                //         row.node.addClass('selectedRow');
                //     });
                //     viewer.addEvent('unselectRow', (row)=>{
                //         row.node.removeClass('selectedRow');
                //     });
                // });
            },
            ()=>{
                this.afterSelectView( callback );
            },
            true
        );
    },
    afterSelectView: function( callback, dlg ){
        var array = [];
        this.viewList.each(function (view) {

            var data = view.getData().map(function (d) {
                d.type = view.json.type;
                d.view = view.json.id;
                return d;
            }.bind(this));
            array = array.concat(data);
        }.bind(this));

        this.doResult(array);

        this.fireEvent("selectResult", [array]);
        if (callback) callback(array, dlg );
    },
    doResult: function(data){
        if (this.json.result === "script"){
            this.selectedData = data;
            var code = this.json.selectedScript.code;
            if (!!code && !!code.trim()) {
                this.form.Macro.exec(this.json.selectedScript.code, this);
                this.form.saveFormData();
            }
        }else{
            var obj = this.json.selectedSetValues;
            if( obj && Object.keys(obj).length > 0 ){
                Object.each(obj, function(v, k){
                    var value = "";
                    data.each(function(d, idx){
                        Object.each(d.data, function(dv, dk){
                            if (dk===v) value = (value) ? (value+", "+dv) : dv;
                        }.bind(this));
                    }.bind(this));

                    var field = this.form.all[k];
                    if (field){
                        field.setData(value);
                        if (value){
                            if (field.descriptionNode) field.descriptionNode.setStyle("display", "none");
                        }else{
                            if (field.descriptionNode) field.descriptionNode.setStyle("display", "block");
                        }
                    }
                }.bind(this));
                this.form.saveFormData();
            }
        }
    },
    openDoc: function(e, d){
	    if( d.targetType === "processPlatform" ){
            o2.Actions.load("x_processplatform_assemble_surface").JobAction.findWorkWorkCompleted(d.targetBundle, function( json ){
                var workCompletedList = json.data.workCompletedList || [], workList = json.data.workList || [];
                if( !workCompletedList.length && !workList.length ){
                    this.form.notice(MWF.xApplication.process.Xform.LP.docDeleted, "info");
                }else{
                    this.form.Macro.environment.form.openJob(d.targetBundle, null, null, function ( app ) {
                        this.fireEvent("openDocument", [app]); //options 传入的事件
                    }.bind(this));
                }
            }.bind(this));
        }else{
            o2.Actions.load("x_cms_assemble_control").DocumentAction.query_get(d.targetBundle, function(){
                this.form.Macro.environment.form.openDocument(d.targetBundle);
            }.bind(this), function(){
                this.form.notice(MWF.xApplication.process.Xform.LP.docDeleted, "info");
                return true;
            }.bind(this))
        }
    },
    getInputData: function (){
        return this.documentList;
    },
    createErrorNode: function(text){
        var node;
        if( this.form.json.errorStyle ){
            if( this.form.json.errorStyle.type === "notice" ){
                if( !this.form.errorNoticing ){ //如果是弹出
                    this.form.errorNoticing = true;
                    this.form.notice(text, "error", this.node, null, null, {
                        onClose : function () {
                            this.form.errorNoticing = false;
                        }.bind(this)
                    });
                }
            }else{
                node = new Element("div",{
                    "styles" : this.form.json.errorStyle.node,
                    "text": text
                });
                if( this.form.json.errorStyle.close ){
                    var closeNode = new Element("div",{
                        "styles" : this.form.json.errorStyle.close ,
                        "events": {
                            "click" : function(){
                                //this.destroy();
                                this.validationMode();
                            }.bind(this)
                        }
                    }).inject(node);
                }
            }
        }else{
            node = new Element("div");
            var iconNode = new Element("div", {
                "styles": {
                    "width": "20px",
                    "height": "20px",
                    "float": "left",
                    "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                }
            }).inject(node);
            var textNode = new Element("div", {
                "styles": {
                    "height": "auto",
                    "line-height": "20px",
                    "margin-left": "20px",
                    "color": "red",
                    "word-break": "keep-all"
                },
                "text": text
            }).inject(node);
        }
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border-color", "red");

            this.errNode = this.createErrorNode(text);
            //if (this.iconNode){
            //    this.errNode.inject(this.iconNode, "after");
            //}else{
            this.errNode.inject(this.node, "after");
            //}
            this.showNotValidationMode(this.node);

            var parentNode = this.errNode;
            while( parentNode && parentNode.offsetParent === null ){
                parentNode = parentNode.getParent();
            }

            if ( parentNode && !parentNode.isIntoView()) parentNode.scrollIntoView(false);
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            var mwftype = p.get("MWFtype") || p.get("mwftype");
            if (mwftype == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function(routeName, data){
        var flag = (data.status==="all") ? true: (routeName === data.decision);
        if (flag){
            var n = this.getInputData();
            var v = (data.valueType==="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v || (o2.typeOf(v)==="array" && !v.length)){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.require("MWF.widget.AttachmentController", null, false);
MWF.xApplication.process.Xform.AttachmentController = new Class({
    Extends: MWF.widget.ATTER,
    "options": {
        "officeFiles": ["doc", "docx", "dotx", "dot", "xls", "xlsx", "xlsm", "xlt", "xltx", "pptx", "ppt", "pot", "potx", "potm", "pdf"],
        "allowPreviewExtension" : ["zip","pdf", "ofd", "png", "jpg", "bmp", "jpeg", "gif", "js", "css", "java", "json", "xml", "php", "html", "htm", "xhtml", "log", "md", "txt"],
        "checkTextEnable": true
    },

    checkAttControl: function(att, currentUser){
        var attUser = att.data.person || att.data.creatorUid;
        switch (this.options.isDeleteOption){
            case "o":
                return attUser===currentUser;
            case "a":
                return att.data.activity===this.module.form.businessData.activity.id;
            case "ao":
                return (attUser===currentUser || att.data.activity===this.module.form.businessData.activity.id);
            default:
                return true;
        }

    },
    checkAttachmentDeleteAction: function () {
        if (this.options.readonly || this.options.isDeleteOption==="n" || this.options.isDeleteOption==="hidden" || !this.attachments.length) {
            this.setAttachmentsAction("delete", false);
            return false;
        }
        var currentUser = layout.session.user.distinguishedName;
        for (var i = 0; i < this.attachments.length; i++) {
            var att = this.attachments[i];
            this.setAttachmentAction(att, "delete", (att.data.control.allowEdit && this.checkAttControl(att, currentUser)));
        }
    },
    checkDeleteAction: function () {

        this.checkAttachmentDeleteAction();

        if (this.options.readonly) {
            if (this.options.isDeleteOption === "hidden") {
                this.setActionHidden(this.deleteAction);
                this.setActionHidden(this.min_deleteAction);
            } else {
                this.setActionDisabled(this.deleteAction);
                this.setActionDisabled(this.min_deleteAction);
            }
            return false;
        }

        if (this.options.isDeleteOption === "hidden") {
            this.setActionHidden(this.deleteAction);
            this.setActionHidden(this.min_deleteAction);
        }else if( this.options.isDeleteOption === "n" ){
            this.setActionDisabled(this.deleteAction);
            this.setActionDisabled(this.min_deleteAction);
        } else {
            if (this.selectedAttachments.length) {
                var user = layout.session.user.distinguishedName;
                var flag = true;
                if (this.options.isDeleteOption === "o") {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                        if (att.data.person !== layout.desktop.session.user.distinguishedName) {
                            flag = false;
                            break;
                        }
                    }
                } else if (this.options.isDeleteOption === "a") {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                        if (att.data.activity !== this.module.form.businessData.activity.id) {
                            flag = false;
                            break;
                        }
                    }
                } else if (this.options.isDeleteOption === "ao") {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                        if ((att.data.activity !== this.module.form.businessData.activity.id) || (att.data.person !== layout.desktop.session.user.distinguishedName)) {
                            flag = false;
                            break;
                        }
                    }
                } else {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                    }
                }

                if (flag) {
                    this.setActionEnabled(this.deleteAction);
                    this.setActionEnabled(this.min_deleteAction);
                } else {
                    this.setActionDisabled(this.deleteAction);
                    this.setActionDisabled(this.min_deleteAction);
                }
            } else {
                this.setActionDisabled(this.deleteAction);
                this.setActionDisabled(this.min_deleteAction);
            }
        }
        // else {
        //     // if (!this.options.isDelete){
        //     this.setActionDisabled(this.deleteAction);
        //     this.setActionDisabled(this.min_deleteAction);
        //     // }else{
        //     //     if (this.selectedAttachments.length){
        //     //         this.setActionEnabled(this.deleteAction);
        //     //         this.setActionEnabled(this.min_deleteAction);
        //     //     }else{
        //     //         this.setActionDisabled(this.deleteAction);
        //     //         this.setActionDisabled(this.min_deleteAction);
        //     //     }
        //     // }
        // }
    },
    checkDownloadBatchAction: function(){

        if( this.options.isDownloadBatch === "hidden" ){
            this.setActionHidden(this.downloadBatchAction);
            this.setActionHidden(this.min_downloadBatchAction);
            this.setAttachmentsAction("downloadBatch", false );
        }else if (!this.options.isDownloadBatch){
            this.setActionDisabled(this.downloadBatchAction);
            this.setActionDisabled(this.min_downloadBatchAction);
            this.setAttachmentsAction("downloadBatch", false );
        }else{
            this.setActionEnabled(this.downloadBatchAction);
            this.setActionEnabled(this.min_downloadBatchAction);
            this.setAttachmentsAction("downloadBatch", true );
        }
    },
    checkEditAttAction: function () {

        if(layout.mobile){
            this.setActionDisabled(this.editAttAction);
            this.setActionDisabled(this.min_editAttAction);
        } else if (this.options.isEditAtt === "hidden" ){
            this.setActionHidden(this.editAttAction);
            this.setActionHidden(this.min_editAttAction);
        } else if (!this.options.isEditAtt || this.options.readonly){
            this.setActionDisabled(this.editAttAction);
            this.setActionDisabled(this.min_editAttAction);
        }else{
            if (this.selectedAttachments.length){
                var flag = false;
                for (var i = 0; i < this.selectedAttachments.length; i++) {
                    var att = this.selectedAttachments[i];

                    if (["doc","docx","xls","xlsx","ppt","pptx"].contains(att.data.extension)) {

                        flag = true;
                        break;
                    }
                }
                if(flag){
                    this.setActionEnabled(this.editAttAction);
                    this.setActionEnabled(this.min_editAttAction);
                }

            }else{
                this.setActionDisabled(this.editAttAction);
                this.setActionDisabled(this.min_editAttAction);
            }
        }
    },

    checkPreviewAttAction: function () {
        // if(layout.mobile){
        //     this.setActionDisabled(this.previewAttAction);
        //     this.setActionDisabled(this.min_previewAttAction);
        // } else
        if (this.options.isPreviewAtt === "hidden" ){
            this.setActionHidden(this.previewAttAction);
            this.setActionHidden(this.min_previewAttAction);
        } else if (!this.options.isPreviewAtt){
            this.setActionDisabled(this.previewAttAction);
            this.setActionDisabled(this.min_previewAttAction);

        }else{
            if (this.selectedAttachments.length){
                var flag = false;
                for (var i = 0; i < this.selectedAttachments.length; i++) {
                    var att = this.selectedAttachments[i];
                    if (this.options.allowPreviewExtension.contains(att.data.extension)) {
                        flag = true;
                        break;
                    }
                    if (["doc","docx","xls","xlsx","ppt","pptx"].contains(att.data.extension)) {
                        flag = true;
                        break;
                    }
                }
                if(flag){
                    this.setActionEnabled(this.previewAttAction);
                    this.setActionEnabled(this.min_previewAttAction);
                    //this.setActionEnabled(this.min_downloadAction);
                }

            }else{
                this.setActionDisabled(this.previewAttAction);
                this.setActionDisabled(this.min_previewAttAction);
            }
        }
    },
    isAttDeleteAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.toolbarGroupHidden.contains("edit")) return false;
        if (this.options.isDeleteOption === "n" || this.options.isDeleteOption === "hidden") return false;

        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if (this.options.isDeleteOption === "o") {

            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
            if (att.data.person !== layout.desktop.session.user.distinguishedName) flag = false;

        } else if (this.options.isDeleteOption === "a") {

            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
            if (att.data.activity !== this.module.form.businessData.activity.id) flag = false;

        } else if (this.options.isDeleteOption === "ao") {

            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
            if ((att.data.activity !== this.module.form.businessData.activity.id) || (att.data.person !== layout.desktop.session.user.distinguishedName)) flag = false;

        } else {
            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
        }

        return flag;
    },
    openInOfficeControl: function (att, office) {
        if (office) {
            if (!office.openedAttachment || office.openedAttachment.id !== att.id) {
                office.save();
                if (this.module.form.businessData.workCompleted) {
                    MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompletedUrl(att.id, this.module.form.businessData.workCompleted.id, function (url) {
                        office.openedAttachment = { "id": att.id, "site": this.module.json.name, "name": att.name };
                        office.officeOCX.BeginOpenFromURL(url, true, this.readonly);
                    }.bind(this));
                } else {
                    MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(att.id, this.module.form.businessData.work.id, function (url) {
                        office.openedAttachment = { "id": att.id, "site": this.module.json.name, "name": att.name };
                        office.officeOCX.BeginOpenFromURL(url, true, this.readonly);
                    }.bind(this));
                }
            }
        }
    },

    checkReplaceAction: function () {
        if (this.options.isReplaceHidden) return;
        if (this.options.readonly) {
            if (this.options.isReplaceOption === "hidden") {
                this.setActionHidden(this.replaceAction);
                this.setActionHidden(this.min_replaceAction);
            }else{
                this.setActionDisabled(this.replaceAction);
                this.setActionDisabled(this.min_replaceAction);
            }
            return false;
        }

        if (this.options.isReplaceOption === "hidden") {
            this.setActionHidden(this.replaceAction);
            this.setActionHidden(this.min_replaceAction);
        }else if(this.options.isReplaceOption === "n"){
            this.setActionDisabled(this.replaceAction);
            this.setActionDisabled(this.min_replaceAction);
        } else {
            if (this.selectedAttachments.length && this.selectedAttachments.length === 1) {

                var att = this.selectedAttachments[0];
                if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

                var user = layout.session.user.distinguishedName;
                var flag = true;

                if (this.options.isReplaceOption === "o") {
                    flag = att.data.person === layout.desktop.session.user.distinguishedName;
                }
                if (this.options.isReplaceOption === "a") {
                    flag = att.data.activity === this.module.form.businessData.activity.id;
                }
                if (this.options.isReplaceOption === "ao") {
                    flag = (att.data.person === layout.desktop.session.user.distinguishedName && att.data.activity === this.module.form.businessData.activity.id);
                }
                if (flag && !att.data.control.allowEdit && att.data.person !== user) {
                    flag = false;
                }

                if (flag) {
                    this.setActionEnabled(this.replaceAction);
                    this.setActionEnabled(this.min_replaceAction);
                } else {
                    this.setActionDisabled(this.replaceAction);
                    this.setActionDisabled(this.min_replaceAction);
                }
            } else {
                this.setActionDisabled(this.replaceAction);
                this.setActionDisabled(this.min_replaceAction);
            }
        }
        // else {
        //     // if (!this.options.isReplace){
        //     this.setActionDisabled(this.replaceAction);
        //     this.setActionDisabled(this.min_replaceAction);
        // }
    },
    replaceAttachment: function (e, node) {
        var att = this.selectedAttachments[0].data;

        if (this.module.json.isOpenInOffice && this.module.json.officeControlName && (this.options.officeFiles.indexOf(att.extension) !== -1)) {
            var office = this.module.form.all[this.module.json.officeControlName];
            if (office) {
                if (this.min_closeOfficeAction) this.setActionEnabled(this.min_closeOfficeAction);
                if (this.closeOfficeAction) this.setActionEnabled(this.closeOfficeAction);
                this.openInOfficeControl(att, office);
            } else {
                if (this.selectedAttachments.length && this.selectedAttachments.length == 1) {
                    if (this.module) this.module.replaceAttachment(e, node, this.selectedAttachments[0]);
                }
            }
        } else {
            if (this.selectedAttachments.length && this.selectedAttachments.length == 1) {
                if (this.module) this.module.replaceAttachment(e, node, this.selectedAttachments[0]);
            }
        }
    },
    isAttReplaceAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.toolbarGroupHidden.contains("edit")) return false;

        if (this.options.isReplaceOption === "n" || this.options.isReplaceOption === "hidden") return false;

        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if (this.options.isReplaceOption === "o") {
            flag = att.data.person === layout.desktop.session.user.distinguishedName;
        }
        if (this.options.isReplaceOption === "a") {
            flag = att.data.activity === this.module.form.businessData.activity.id;
        }
        if (this.options.isReplaceOption === "ao") {
            flag = (att.data.person === layout.desktop.session.user.distinguishedName && att.data.activity === this.module.form.businessData.activity.id);
        }
        if (flag && !att.data.control.allowEdit && att.data.person !== user) {
            flag = false;
        }

        return flag;
    },


    //checkAttachmentOrderAction : function(){
    //    if (this.options.readonly){
    //        this.setAttachmentsAction("order", false );
    //        return false;
    //    }
    //    if (this.attachments.length){
    //        var user = layout.session.user.distinguishedName;
    //        for (var i=0; i<this.attachments.length; i++){
    //            var flag = true;
    //
    //            var att = this.attachments[i];
    //            if( !att.data.person && att.data.creatorUid )att.data.person = att.data.creatorUid;
    //
    //            if ((!att.data.control.allowControl || !att.data.control.allowEdit) && att.data.person!==user){
    //                flag = false;
    //            }
    //            if (flag){
    //                this.setAttachmentAction(att, "order", true );
    //            }else{
    //                this.setAttachmentAction(att, "order", false );
    //            }
    //        }
    //    }
    //},
    checkOrderAction: function () {
        //this.checkAttachmentOrderAction();
        if (this.options.readonly) {
            if( this.options.isOrder === "hidden" ){
                this.setActionHidden(this.orderAction);
                this.setActionHidden(this.min_orderAction);
            }else{
                this.setActionDisabled(this.orderAction);
                this.setActionDisabled(this.min_orderAction);
            }
            return false;
        }
        if( this.options.isOrder === "hidden" ){
            this.setActionHidden(this.orderAction);
            this.setActionHidden(this.min_orderAction);
        }else if( !this.options.isOrder ){
            this.setActionDisabled(this.orderAction);
            this.setActionDisabled(this.min_orderAction);
        }else{
            if (this.attachments.length && this.attachments.length > 1) {
                var flag = true;
                var user = layout.session.user.distinguishedName;
                for (var i = 0; i < this.attachments.length; i++) {
                    var att = this.attachments[i];
                    if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                    if ((!att.data.control.allowControl && !att.data.control.allowEdit) && att.data.person !== user) { //|| !att.data.control.allowEdit
                        flag = false;
                        break;
                    }
                }
                if (flag) {
                    this.setActionEnabled(this.orderAction);
                    this.setActionEnabled(this.min_orderAction);
                } else {
                    this.setActionDisabled(this.orderAction);
                    this.setActionDisabled(this.min_orderAction);
                }
                //this.setActionEnabled(this.min_deleteAction);
            } else {
                this.setActionDisabled(this.orderAction);
                this.setActionDisabled(this.min_orderAction);
                //this.setActionDisabled(this.min_deleteAction);
            }
        }
    },
    isAttOrderAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.toolbarGroupHidden.contains("config")) return false;
        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if ((!att.data.control.allowControl || !att.data.control.allowEdit) && att.data.person !== user) {
            flag = false;
        }
        return flag;
    },

    createTopNode: function () {
        if (this.options.title) {
            if (!this.titleNode) this.titleNode = new Element("div", { "styles": this.css.titleNode, "text": this.options.title }).inject(this.node);
        }
        if (!this.topNode) {
            this.topNode = new Element("div", { "styles": this.css.topNode }).inject(this.node);
        } else {
            this.topNode.empty();
            this.editActionBoxNode = null;
            this.editActionsGroupNode = null;
            // this.topNode.setStyle("display", "");
            this.topNode.show();
            if (this.isHiddenTop) {
                //this.container.setStyle("height", this.container.getSize().y + 45 );
                //this.node.setStyle("height", this.node.getSize().y + 45 );
                if (this.oldContentScrollNodeHeight && this.contentScrollNode) {
                    this.contentScrollNode.setStyle("min-height", this.oldContentScrollNodeHeight);
                    this.oldContentScrollNodeHeight = null;
                }
                this.isHiddenTop = false;
            }
        }
        var hiddenGroup = this.options.toolbarGroupHidden;
        if (hiddenGroup.contains("edit") && hiddenGroup.contains("read") && hiddenGroup.contains("list") &&
            hiddenGroup.contains("view") && hiddenGroup.contains("config") &&
            !(this.module.json.isOpenInOffice && this.module.json.officeControlName)
        ) {
            if (this.contentScrollNode) {
                this.oldContentScrollNodeHeight = this.contentScrollNode.getStyle("min-height");
                this.contentScrollNode.setStyle("min-height", this.node.getStyle("min-height"));
                this.topNode.hide();
            }
            this.isHiddenTop = true;
        }
        if (!hiddenGroup.contains("edit")) this.createEditGroupActions();
        if (!hiddenGroup.contains("read")) this.createReadGroupActions();
        if (!hiddenGroup.contains("list")) this.createListGroupActions();
        if (this.module.json.isOpenInOffice && this.module.json.officeControlName) this.createOfficeGroupActions();

        if (!hiddenGroup.contains("config")) this.createConfigGroupActions();

        if (!hiddenGroup.contains("view")) this.createViewGroupActions();
        this.checkActions();

        if( layout.mobile && this.checkActionsZoom ){
            this.checkActionsZoom();
        }
    },
    createReadGroupActions: function(){
        //this.readActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        //this.readActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.readActionBoxNode);
        if(!this.editActionBoxNode)this.editActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        if(!this.editActionsGroupNode)this.editActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.editActionBoxNode);

        this.downloadAction = this.createAction(this.editActionsGroupNode, "download", o2.LP.widget.download, function(){
            this.downloadAttachment();
        }.bind(this));

        this.downloadBatchAction = this.createAction(this.editActionsGroupNode, "downloadBatch", o2.LP.widget.downloadBatch, function(){
            this.downloadBatchAttachment();
        }.bind(this));

    },
    checkActions: function () {
        //    if (this.options.readonly){
        //        this.setReadonly();
        //    }else{
        this.checkUploadAction();
        this.checkDeleteAction();
        this.checkReplaceAction();
        this.checkPreviewAttAction();

        this.checkEditAttAction();

        //this.checkOfficeAction();
        this.checkDownloadAction();
        this.checkDownloadBatchAction();

        this.checkSizeAction();

        this.checkConfigAction();
        this.checkOrderAction();

        this.checkListStyleAction();

        if( this.options.size === "max" ){
            this.checkEditActionBox();
            this.checkConfigActionBox();
        }else if( this.options.size === "min" ){
            this.checkMinActionBox();
        }

        //    }
    },
    checkEditActionBox: function(){
        var isShowEdit = false;
        ["isUpload", "isDelete", "isReplace", "isPreviewAtt", "isEditAtt"].each(function( key ){
            if( key === "isReplace" && this.options.isReplaceHidden )return;
            if( key === "isPreviewAtt" && layout.mobile )return;
            if( this.options[key] !== "hidden" )isShowEdit = true;
        }.bind(this));

        var isShowRead = false;
        ["isDownload","isDownloadBatch"].each(function( key ){
            if( this.options[key] !== "hidden" )isShowRead = true;
        }.bind(this));

        if(this.editActionSeparateNode)this.editActionSeparateNode.setStyle( "display", isShowEdit && isShowRead ? "" : "none" );
        if(this.editActionBoxNode )this.editActionBoxNode.setStyle( "display", isShowEdit || isShowRead ? "" : "none" );
    },
    checkConfigActionBox: function(){
        var isShowConfig = false;
        ["isConfig"].each(function( key ){
            if( this.options[key] !== "hidden" )isShowConfig = true;
        }.bind(this));

        var isShowOrder = false;
        ["isOrder"].each(function( key ){
            if( this.options[key] !== "hidden" )isShowOrder = true;
        }.bind(this));

        if(this.configActionSeparateNode)this.configActionSeparateNode.setStyle( "display", isShowConfig && isShowOrder ? "" : "none" );
        if(this.configActionBoxNode )this.configActionBoxNode.setStyle( "display", isShowConfig || isShowOrder ? "" : "none" );
    },
    checkMinActionBox: function(){
        var isShowLeft = false;
        var hiddenGroup = this.options.toolbarGroupHidden || [];
        if( this.min_closeOfficeAction ){
            isShowLeft = true;
        }else {
            ["isUpload", "isDelete", "isReplace", "isDownload", "isDownloadBatch", "isOrder"].each(function (key) {
                if (key === "isReplace" && this.options.isReplaceHidden) return;
                if (this.options[key] !== "hidden") isShowLeft = true;
            }.bind(this));
            if( isShowLeft ){
                if( hiddenGroup.contains("edit") && hiddenGroup.contains("read") && hiddenGroup.contains("config") ){
                    isShowLeft = false;
                }
            }
        }

        var isShowRight = this.options.isSizeChange && !hiddenGroup.contains("view");

        if(this.minSeparateNode)this.minSeparateNode.setStyle( "display", isShowLeft && isShowRight ? "" : "none" );
        if(this.minActionAreaNode ){
            if (isShowLeft || isShowRight){
                this.minActionAreaNode.show();
            }else{
                this.minActionAreaNode.hide();
            }
        }
    },

    checkAttachmentConfigAction: function () {
        if (this.options.readonly || !this.attachments.length) {
            this.setAttachmentsAction("config", false);
            return false;
        }
        var currentUser = layout.session.user.distinguishedName;
        for (var i = 0; i < this.attachments.length; i++) {
            var att = this.attachments[i];
            var attUser = att.data.person || att.data.creatorUid;
            this.setAttachmentAction(att, "config", att.data.control.allowControl && attUser===currentUser);
        }
    },
    checkConfigAction: function () {
        if( this.options.isConfig === "hidden" ){
            this.setActionHidden(this.configAction);
            return;
        }
        if( !this.options.isConfig ){
            this.setActionDisabled(this.configAction);
            return;
        }

        this.checkAttachmentConfigAction();
        if (this.options.readonly) {
            this.setActionDisabled(this.configAction);
            if (this.checkTextAction) this.setActionDisabled(this.checkTextAction);
            return false;
        }
        if (this.selectedAttachments.length) {
            var flag = true;
            var user = layout.session.user.distinguishedName;
            for (var i = 0; i < this.selectedAttachments.length; i++) {
                var att = this.selectedAttachments[i];
                if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                if ((!att.data.control.allowControl) && att.data.person !== user) { //|| !att.data.control.allowEdit
                    flag = false;
                    break;
                }
            }
            if (flag) {
                this.setActionEnabled(this.configAction);
            } else {
                this.setActionDisabled(this.configAction);
            }
            //this.setActionEnabled(this.min_deleteAction);
        } else {
            this.setActionDisabled(this.configAction);
            //this.setActionDisabled(this.min_deleteAction);
        }

        if (this.checkTextAction) {
            this.setActionDisabled(this.checkTextAction);
            if (this.selectedAttachments.length && this.selectedAttachments.length === 1) {
                var att = this.selectedAttachments[0];
                if (this.options.images.indexOf(att.data.extension.toLowerCase()) !== -1) {
                    this.setActionEnabled(this.checkTextAction);
                }
            }
        }
    },
    isAttConfigAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.isConfig === "hidden") return false;
        if (this.options.toolbarGroupHidden.contains("config")) return false;
        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if (!att.data.control.allowControl && att.data.person !== user) {
            flag = false;
        }
        return flag;
    },

    createEditGroupActions: function () {
        if (!this.editActionBoxNode) this.editActionBoxNode = new Element("div", { "styles": this.css.actionsBoxNode }).inject(this.topNode);
        if (!this.editActionsGroupNode) this.editActionsGroupNode = new Element("div", { "styles": this.css.actionsGroupNode }).inject(this.editActionBoxNode);
        this.uploadAction = this.createAction(this.editActionsGroupNode, "upload", o2.LP.widget.upload, function (e, node) {
            this.uploadAttachment(e, node);
        }.bind(this));

        this.deleteAction = this.createAction(this.editActionsGroupNode, "delete", o2.LP.widget["delete"], function (e, node) {
            this.deleteAttachment(e, node);
        }.bind(this));
        //if(!layout.mobile){
            this.previewAttAction = this.createAction(this.editActionsGroupNode, "previewAtt", o2.LP.widget["previewAtt"], function (e, node) {
                this.previewAttachment(e, node);
            }.bind(this));
        //}

        if(!layout.mobile){
            this.editAttAction = this.createAction(this.editActionsGroupNode, "editAtt", o2.LP.widget["editAtt"], function (e, node) {
                this.editAttachment(e, node);
            }.bind(this));
        }


        if (!this.options.isReplaceHidden) {
            this.replaceAction = this.createAction(this.editActionsGroupNode, "replace", o2.LP.widget.replace, function (e, node) {
                this.replaceAttachment(e, node);
            }.bind(this));
        }

        // this.officeAction = this.createAction(this.editActionsGroupNode, "office", o2.LP.widget.office, function(e, node){
        //     this.openInOfficeControl(e, node);
        // }.bind(this));

        if (!this.options.toolbarGroupHidden.contains("read")) this.editActionSeparateNode = this.createSeparate(this.editActionsGroupNode);
    },

    createConfigGroupActions: function () {
        this.configActionBoxNode = new Element("div", { "styles": this.css.actionsBoxNode }).inject(this.topNode);
        this.configActionsGroupNode = new Element("div", { "styles": this.css.actionsGroupNode }).inject(this.configActionBoxNode);

        this.configAction = this.createAction(this.configActionsGroupNode, "config", MWF.LP.widget.configAttachment, function (e, node) {
            this.configAttachment(e, node);
        }.bind(this));

        // if (this.options.checkTextEnable) {
        //     this.checkTextAction = this.createAction(this.configActionsGroupNode, "check", MWF.LP.widget.checkOcrText, function (e, node) {
        //         this.checkImageTex(e, node);
        //     }.bind(this));
        // }
        this.configActionSeparateNode = this.createSeparate(this.configActionsGroupNode);

        this.orderAction = this.createAction(this.configActionsGroupNode, "order", MWF.LP.widget.order, function (e, node) {
            this.orderAttachment(e, node);
        }.bind(this));

        if (this.configAction) this.setActionDisabled(this.configAction);
        if (this.checkTextAction) this.setActionDisabled(this.checkTextAction);
    },

    createOfficeGroupActions: function () {
        this.officeActionBoxNode = new Element("div", { "styles": this.css.actionsBoxNode }).inject(this.topNode);
        this.officeActionsGroupNode = new Element("div", { "styles": this.css.actionsGroupNode }).inject(this.officeActionBoxNode);

        this.closeOfficeAction = this.createAction(this.officeActionsGroupNode, "closeOffice", MWF.LP.widget.closeOffice, function (e, node) {
            this.closeAttachmentOffice(e, node);
        }.bind(this));
        if (this.closeOfficeAction) this.setActionDisabled(this.closeOfficeAction);
    },
    loadMinActions: function () {

        var hiddenGroup = this.options.toolbarGroupHidden;
        if (!hiddenGroup.contains("edit")) {
            this.min_uploadAction = this.createAction(this.minActionAreaNode, "upload", MWF.LP.widget.upload, function (e, node) {
                this.uploadAttachment(e, node);
            }.bind(this));

            this.min_deleteAction = this.createAction(this.minActionAreaNode, "delete", MWF.LP.widget["delete"], function (e, node) {
                this.deleteAttachment(e, node);
            }.bind(this));

            if (!this.options.isReplaceHidden) {
                this.min_replaceAction = this.createAction(this.minActionAreaNode, "replace", MWF.LP.widget.replace, function (e, node) {
                    this.replaceAttachment(e, node);
                }.bind(this));
            }

            if(!layout.mobile){

                this.min_editAttAction = this.createAction(this.minActionAreaNode, "editAtt", o2.LP.widget["editAtt"], function (e, node) {
                    this.editAttachment(e, node);
                }.bind(this));
            }


        }
        if (!hiddenGroup.contains("read")) {
            this.min_downloadAction = this.createAction(this.minActionAreaNode, "download", MWF.LP.widget.download
                , function (e, node) {
                    this.downloadAttachment(e, node);
                }.bind(this));

            this.min_downloadBatchAction = this.createAction(this.minActionAreaNode, "downloadBatch", MWF.LP.widget.downloadBatch
                , function (e, node) {
                    this.downloadBatchAttachment(e, node);
                }.bind(this));

            //if(!layout.mobile){
                this.min_previewAttAction = this.createAction(this.minActionAreaNode, "previewAtt", o2.LP.widget["previewAtt"], function (e, node) {
                    this.previewAttachment(e, node);
                }.bind(this));

            //}

        }
        if (!hiddenGroup.contains("config")) {
            this.min_orderAction = this.createAction(this.minActionAreaNode, "order", MWF.LP.widget.order, function (e, node) {
                this.orderAttachment(e, node);
            }.bind(this));
        }

        if (this.module.json.isOpenInOffice && this.module.json.officeControlName) {
            this.min_closeOfficeAction = this.createAction(this.minActionAreaNode, "closeOffice", MWF.LP.widget.closeOffice, function (e, node) {
                this.closeAttachmentOffice(e, node);
            }.bind(this));
            if (this.min_closeOfficeAction) this.setActionDisabled(this.closeOfficeAction);
        }


        if (!hiddenGroup.contains("edit") || !hiddenGroup.contains("read")) {
            this.minSeparateNode = this.createSeparate(this.minActionAreaNode);
        }

        //this.createSeparate(this.configActionsGroupNode);

        if (this.options.isSizeChange) {
            //this.createSeparate(this.minActionAreaNode);
            if (!hiddenGroup.contains("view")) {
                this.sizeAction = this.createAction(this.minActionAreaNode, "max", MWF.LP.widget.min, function () {
                    this.changeControllerSize();
                }.bind(this));
            }
        }
    },
    closeAttachmentOffice: function () {
        var office = this.module.form.all[this.module.json.officeControlName];
        if (office) {
            office.openFile();
            if (this.min_closeOfficeAction) this.setActionDisabled(this.min_closeOfficeAction);
            if (this.closeOfficeAction) this.setActionDisabled(this.closeOfficeAction);
        }
    },
    configAttachment: function(){
        o2.Actions.load("x_general_assemble_control").SecurityClearanceAction["enable"]().then(function(json){
            if (json.data.enable){
                this.configAttachmentSecurity();
            }else{
                this.configAttachmentPower();
            }
        }.bind(this));
    },

    getSecurityDefaultLabelList: function(){
        if (this.securityLabelList) return Promise.resolve(this.securityLabelList);
        var _self = this
        return o2.Actions.load("x_general_assemble_control").SecurityClearanceAction["object"]().then(function(json){
            return _self.securityLabelList = json.data;
        });
    },

    getSecurityLabelList: function(){
        var _self = this;
        return this.getSecurityDefaultLabelList().then(function(list){
            var label = _self.module.form.businessData.data.objectSecurityClearance;
            label = (!label && label!==0) ? Infinity : label;
            var o = {};
            Object.keys(list).forEach(function(k){
                if (list[k]<=label){
                    o[k] = list[k];
                }
            });
            return o;
        })
    },
    configAttachmentSecurity: function(){
        var lp = MWF.xApplication.process.Xform.LP;
        var css = this.module.form.css;

        var node = new Element("div", { "styles": (layout.mobile ? css.attachmentPermissionNode_mobile : css.attachmentPermissionNode) }).inject(this.node);
        var attNames = new Element("div", { "styles": css.attachmentPermissionNamesNode }).inject(node);
        var attNamesTitle = new Element("div", { "styles": css.attachmentPermissionNamesTitleNode, "text": lp.attachmentPermissionInfo }).inject(attNames);
        var attNamesArea = new Element("div", { "styles": css.attachmentPermissionNamesAreaNode }).inject(attNames);

        if (this.selectedAttachments.length) {
            this.selectedAttachments.each(function (att) {
                var attNode = new Element("div", { "styles": css.attachmentPermissionAttNode, "text": att.data.name }).inject(attNamesArea);
            }.bind(this));
        }

        var label = "";
        if (this.selectedAttachments.length){
            for (var i=0; i<this.selectedAttachments.length; i++){
                var attLabel = this.selectedAttachments[i].data.objectSecurityClearance;
                label = (!label || label===attLabel) ? attLabel : "";
            }
        }

        var editArea = new Element("div", { "styles": css.attachmentPermissionEditAreaNode }).inject(node);
        editArea.setStyle("display", "flex");
        var title = new Element("div", { "styles": css.attachmentPermissionTitleNode, "text": lp.attachmentSecurity }).inject(editArea);
        title.setStyle("margin-right", "15px");
        var select = new Element("select", { "styles": css.attachmentPermissionInputNode }).inject(editArea);
        new Element('option', {text: "", value: ""}).inject(select);
        this.getSecurityLabelList().then(function(labels){
            Object.keys(labels).forEach(function(key){
                var op = new Element('option', {text: key, value: labels[key]}).inject(select);
                if (label===labels[key]) op.selected = true;
            });
        });

        var options = Object.merge({
            "title": lp.attachmentPermission,
            "style": this.module.form.json.dialogStyle || "user",
            "isResize": false,
            "content": node,
            "container": this.module.form.app.content,
            "maskNode": this.module.form.app.content,
            "buttonList": [
                {
                    "type": "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function () {
                        this.setAttachmentSecurityConfig(select);
                        dlg.close();
                    }.bind(this)
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function () { dlg.close(); }
                }
            ]
        }, (this.module.form.json.dialogOptions||{}));

        if( layout.mobile ){
            var size = $(document.body).getSize();
            options.width = size.x;
            options.height = size.y;
        }

        var dlg = o2.DL.open( options );
    },
    configAttachmentPower: function () {
        //this.fireEvent("delete", [attachment.data]);

        var lp = MWF.xApplication.process.Xform.LP;
        var css = this.module.form.css;
        var node = new Element("div.MWF_configAttachmentPower", { "styles": (layout.mobile ? css.attachmentPermissionNode_mobile : css.attachmentPermissionNode) }).inject(this.node);
        var attNames = new Element("div", { "styles": css.attachmentPermissionNamesNode }).inject(node);
        var attNamesTitle = new Element("div", { "styles": css.attachmentPermissionNamesTitleNode, "text": lp.attachmentPermissionInfo }).inject(attNames);
        var attNamesArea = new Element("div", { "styles": css.attachmentPermissionNamesAreaNode }).inject(attNames);

        if (this.selectedAttachments.length) {
            this.selectedAttachments.each(function (att) {
                var attNode = new Element("div", { "styles": css.attachmentPermissionAttNode, "text": att.data.name }).inject(attNamesArea);
            }.bind(this));
        }

        var editArea = new Element("div", { "styles": css.attachmentPermissionEditAreaNode }).inject(node);
        var title = new Element("div", { "styles": css.attachmentPermissionTitleNode, "text": lp.attachmentRead }).inject(editArea);
        var readInput = new Element("div", { "styles": css.attachmentPermissionInputNode }).inject(editArea);

        title = new Element("div", { "styles": css.attachmentPermissionTitleNode, "text": lp.attachmentEdit }).inject(editArea);
        var editInput = new Element("div", { "styles": css.attachmentPermissionInputNode }).inject(editArea);

        title = new Element("div", { "styles": css.attachmentPermissionTitleNode, "text": lp.attachmentController }).inject(editArea);
        var controllerInput = new Element("div", { "styles": css.attachmentPermissionInputNode }).inject(editArea);

        var options = Object.merge({
            "title": lp.attachmentPermission,
            "style": this.module.form.json.dialogStyle || "user",
            "isResize": false,
            "content": node,
            "container": this.module.form.app.content,
            "maskNode": this.module.form.app.content,
            "buttonList": [
                {
                    "type": "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function () {
                        this.setAttachmentConfig(readInput, editInput, controllerInput);
                        dlg.close();
                    }.bind(this)
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function () { dlg.close(); }
                }
            ]
        }, (this.module.form.json.dialogOptions||{}));

        if( layout.mobile ){
            var size = $(document.body).getSize();
            options.width = size.x;
            options.height = size.y;
        }

        var dlg = o2.DL.open( options );

        if (this.selectedAttachments.length === 1) {
            var data = this.selectedAttachments[0].data;

            var readUnitList = (data.readUnitList) || [];
            var readIdentityList = (data.readIdentityList) || [];
            var editUnitList = (data.editUnitList) || [];
            var editIdentityList = (data.editIdentityList) || [];
            var controllerUnitList = (data.controllerUnitList) || [];
            var controllerIdentityList = (data.controllerIdentityList) || [];

            readInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"],
                "values": readUnitList.concat(readIdentityList).trim()
            }));
            editInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"],
                "values": editUnitList.concat(editIdentityList).trim()
            }));
            controllerInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"],
                "values": controllerUnitList.concat(controllerIdentityList).trim()
            }));
        } else {
            readInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"]
            }));
            editInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"]
            }));
            controllerInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"]
            }));
        }
    },

    setAttachmentSecurityConfig: function(select){
        if (this.selectedAttachments.length) {
            var security = select.options[select.selectedIndex].value;

            var loadedCount = 0;
            this.selectedAttachments.each(function (att) {
                att.data.objectSecurityClearance = security.toInt();

                o2.Actions.get("x_processplatform_assemble_surface").configAttachment(att.data.id, this.module.form.businessData.work.id, att.data, function () {
                    //刷新附件权限，以后要加一个刷新附件的功能
                    o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.getWithWorkOrWorkCompleted(att.data.id, this.module.form.businessData.work.id, function (json) {
                        var attachment = this.getAttachmentById( att.data.id );
                        if( attachment ){
                            attachment.data = json.data;

                            if( attachment.deleteAction && !this.isAttDeleteAvailable(attachment) ){
                                attachment.deleteAction.setStyle("display","none");
                            }

                            if( attachment.configAction && !this.isAttConfigAvailable(attachment) ){
                                attachment.configAction.setStyle("display","none");
                            }
                        }
                        loadedCount++;
                        if( loadedCount === this.selectedAttachments.length ){
                            this.checkActions();
                        }
                    }.bind(this))
                }.bind(this));
            }.bind(this));
        }
    },

    setAttachmentConfig: function (readInput, editInput, controllerInput) {
        if (this.selectedAttachments.length) {
            var readList = readInput.retrieve("data-value");
            var editList = editInput.retrieve("data-value");
            var controllerList = controllerInput.retrieve("data-value");

            var readUnitList = [];
            var readIdentityList = [];
            var editUnitList = [];
            var editIdentityList = [];
            var controllerUnitList = [];
            var controllerIdentityList = [];

            if (readList) {
                readList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") readUnitList.push(vName);
                    if (flag === "I") readIdentityList.push(vName);
                });
            }
            if (editList) {
                editList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") editUnitList.push(vName);
                    if (flag === "I") editIdentityList.push(vName);
                });
            }
            if (controllerList) {
                controllerList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") controllerUnitList.push(vName);
                    if (flag === "I") controllerIdentityList.push(vName);
                });
            }

            var loadedCount = 0;
            this.selectedAttachments.each(function (att) {
                att.data.readUnitList = readUnitList;
                att.data.readIdentityList = readIdentityList;
                att.data.editUnitList = editUnitList;
                att.data.editIdentityList = editIdentityList;
                att.data.controllerUnitList = controllerUnitList;
                att.data.controllerIdentityList = controllerIdentityList;

                o2.Actions.get("x_processplatform_assemble_surface").configAttachment(att.data.id, this.module.form.businessData.work.id, att.data, function () {
                    //刷新附件权限，以后要加一个刷新附件的功能
                    o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.getWithWorkOrWorkCompleted(att.data.id, this.module.form.businessData.work.id, function (json) {
                        var attachment = this.getAttachmentById( att.data.id );
                        if( attachment ){
                            attachment.data = json.data;

                            if( attachment.deleteAction && !this.isAttDeleteAvailable(attachment) ){
                                attachment.deleteAction.setStyle("display","none");
                            }

                            if( attachment.configAction && !this.isAttConfigAvailable(attachment) ){
                                attachment.configAction.setStyle("display","none");
                            }
                        }
                        loadedCount++;
                        if( loadedCount === this.selectedAttachments.length ){
                            this.checkActions();
                        }
                    }.bind(this))
                }.bind(this));
            }.bind(this));
        }
    },

    checkImageTex: function () {
        if (this.selectedAttachments.length && this.selectedAttachments.length == 1) {
            var att = this.selectedAttachments[0];
            var lp = MWF.xApplication.process.Xform.LP;
            var css = this.module.form.css;

            var node = new Element("div", { "styles": css.attachmentOCRNode }).inject(this.node);
            var previewNode = new Element("div", { "styles": css.attachmentOCRImageAreaNode }).inject(node);
            var imgNode = new Element("img", { "styles": css.attachmentOCRImageNode }).inject(previewNode);

            o2.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(att.data.id, this.module.form.businessData.work.id, function (url) {
                // imgNode.set("src", o2.filterUrl(url));
                imgNode.set("src", url);
            });

            var areaNode = new Element("div", { "styles": css.attachmentOCRInputAreaNode }).inject(node);
            var inputNode = new Element("textarea", { "styles": css.attachmentOCRInputNode }).inject(areaNode);

            var dlg = o2.DL.open({
                "title": lp.attachmentOCRTitle,
                "style": this.module.form.json.dialogStyle || "user",
                "isResize": false,
                "content": node,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function () {
                            this.setAttachmentOCR(inputNode, att);
                            dlg.close();
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ]
            });
            if (att.data.ocr) {
                inputNode.set("text", att.data.ocr.text || "");
            } else {
                o2.Actions.get("x_processplatform_assemble_surface").getAttachmentOCR(att.data.id, this.module.form.businessData.work.id, function (json) {
                    att.data.ocr = json.data;
                    inputNode.set("text", json.data.text || "");
                }.bind(this))
            }

        }
    },
    setAttachmentOCR: function (inputNode, att) {
        var data = inputNode.get("text");
        if (!att.data.ocr) att.data.ocr = {};
        att.data.ocr.text = data;
        o2.Actions.get("x_processplatform_assemble_surface").setAttachmentOCR(att.data.id, this.module.form.businessData.work.id, {
            "text": data
        }, function () {
            this.module.form.app.notice("success", lp.attachmentOCR_saved, this.node);
        }.bind(this));
    },
    checkMoveAction: function (item) {
        if (item) {
            var actionArea = item.getFirst().getNext();
            var actionup = actionArea.getFirst().show();
            var actiondown = actionArea.getLast().show();

            tmp = item.getPrevious();
            if (!tmp) actionup.hide();

            tmp = item.getNext();
            if (!tmp) actiondown.hide();
        }
    },
    sortByNumber: function( attachments ){
        return attachments.sort(function (a1, a2) {
            if (!a2.data.orderNumber) return 1;
            if (!a1.data.orderNumber) return -1;
            return a1.data.orderNumber - a2.data.orderNumber;
        }.bind(this));
    },
    orderAttachment: function () {
        if (this.attachments.length) {
            // this.attachments = this.attachments.sort(function (a1, a2) {
            //     if (!a2.data.orderNumber) return 1;
            //     if (!a1.data.orderNumber) return -1;
            //     return a1.data.orderNumber - a2.data.orderNumber;
            // }.bind(this));
            this.attachments = this.sortByNumber(this.attachments);

            var lp = MWF.xApplication.process.Xform.LP;
            var css = this.module.form.css;
            var node = new Element("div", { "styles": (layout.mobile ? css.attachmentOrderNode_mobile : css.attachmentOrderNode) });
            var infoNode = new Element("div", { "styles": css.attachmentOrderInforNode, "text": lp.attachmentOrderInfo }).inject(node);
            var attrchmentsNode = new Element("div", { "styles":  (layout.mobile ? css.attachmentOrderAreaNode_mobile : css.attachmentOrderAreaNode) }).inject(node);

            var iconUrl = "../x_component_File/$Main/icon.json";
            var icons = null;
            o2.getJSON(iconUrl, function (json) {
                icons = json;
            }.bind(this), false, false);

            this.attachments.each(function (att, idx) {
                var iconName = icons[att.data.extension.toLowerCase()] || icons.unknow;
                var iconFolderUrl = "../x_component_File/$Main/default/file/" + iconName;

                var itemNode = new Element("div", { "styles": css.attachmentOrderItemNode }).inject(attrchmentsNode);
                itemNode.store("att", att);
                var icon = new Element("div", { "styles": css.attachmentOrderItemIconNode }).inject(itemNode);
                icon.setStyle("background-image", "url('" + iconFolderUrl + "')");

                var actionArea = new Element("div", { "styles": (layout.mobile ? css.attachmentOrderItemActionNode_mobile : css.attachmentOrderItemActionNode) }).inject(itemNode);
                var text = new Element("div", { "styles":  (layout.mobile ? css.attachmentOrderItemTextNode_mobile : css.attachmentOrderItemTextNode), "text": att.data.name }).inject(itemNode);

                var actionUp = new Element("div", { "styles": css.attachmentOrderItemActionUpNode, "text": lp.attachmentOrderUp }).inject(actionArea);
                var actionDown = new Element("div", { "styles": css.attachmentOrderItemActionDownNode, "text": lp.attachmentOrderDown }).inject(actionArea);
                if (idx == 0) actionUp.hide();
                if (idx == this.attachments.length - 1) actionDown.hide();

                actionUp.addEvent("click", function (e) {
                    var itemNode = e.target.getParent().getParent();
                    var upNode = itemNode.getPrevious();
                    if (upNode) {
                        itemNode.inject(upNode, "before");
                        this.checkMoveAction(upNode);
                    }
                    this.checkMoveAction(itemNode);
                    itemNode.highlight();
                    //itemNode.setStyle("background-color", "#faf9f1");
                }.bind(this));

                actionDown.addEvent("click", function (e) {
                    var itemNode = e.target.getParent().getParent();
                    var downNode = itemNode.getNext();
                    if (downNode) {
                        itemNode.inject(downNode, "after");
                        this.checkMoveAction(downNode);
                    }
                    this.checkMoveAction(itemNode);
                    itemNode.highlight();
                    // /itemNode.setStyle("background-color", "#faf9f1");
                }.bind(this));

                itemNode.addEvents({
                    "mouseover": function (e) { this.setStyle("background-color", "#f1f6fa"); },
                    "mouseout": function (e) { this.setStyle("background-color", "#ffffff"); }
                });

                //var droppables = attrchmentsNode.getChildren();

                new Drag(itemNode, {
                    "handle": icon,
                    "snap": 5,
                    "stopPropagation": true,
                    "preventDefault": true,
                    onStart: function (el, e) {
                        var itemNode = el;
                        itemNode.setStyle("background-color", "#f1f6fa");
                        var moveNode = itemNode.clone(true).setStyles(css.attachmentOrderItemNode).setStyles({
                            "background-color": "#faf9f1",
                            "opacity": 0.8,
                            "border": "1px dotted #333333"
                        }).inject(node);
                        moveNode.position({
                            "relativeTo": itemNode,
                            "position": 'upperLeft',
                            "edge": 'upperLeft'
                        });
                        moveNode.owner = itemNode;

                        var move = new Drag.Move(moveNode, {
                            "container": node,
                            "droppables": attrchmentsNode.getChildren(),
                            "onEnter": function (el, drop) {
                                moveNode.flagNode = new Element("div", { "styles": css.attachmentOrderFlagNode }).inject(drop, "before");
                            },
                            "onLeave": function (el, drop) {
                                if (moveNode.flagNode) moveNode.flagNode.destroy();
                            },
                            "onDrop": function (el, drop) {
                                if (moveNode.flagNode) {
                                    moveNode.owner.inject(moveNode.flagNode, "after");
                                    moveNode.flagNode.destroy();
                                    moveNode.owner.highlight();
                                    this.checkMoveAction(moveNode.owner);
                                    this.checkMoveAction(drop);
                                    this.checkMoveAction(attrchmentsNode.getLast());
                                    moveNode.destroy()
                                }
                            }.bind(this)
                        });
                        move.start(e);


                    }.bind(this),
                    enter: function (el) {
                        el.removeClass('dragging');
                    }
                });
                //itemNode.dragMove


            }.bind(this));

            var options = Object.merge({
                "title": lp.attachmentOrderTitle,
                "style": this.module.form.json.dialogStyle || "user",
                "isResize": false,
                "content": node,
                "width": "720",
                "height": "740",
                "container": this.module.form.app.content,
                "maskNode": this.module.form.app.content,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function () {
                            this.sortAttachment(attrchmentsNode);
                            dlg.close();
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostLoad": function () {
                    var dlg = this;
                    dlg.node.setStyle("display", "block");

                    var size = {};
                    if (css.attachmentOrderNode) {
                        if (parseFloat(css.attachmentOrderNode.width).toString() !== "NaN") {
                            size.x = parseInt(css.attachmentOrderNode.width)
                        }
                        if (parseFloat(css.attachmentOrderNode.height).toString() !== "NaN") {
                            size.y = parseInt(css.attachmentOrderNode.height)
                        }
                    }

                    node.show();
                    var nodeSize = node.getSize();
                    dlg.content.setStyles({
                        "width": size.x || nodeSize.x,
                        "height": size.y || nodeSize.y
                    });
                    dlg.setContentSize();
                }
            },  (this.module.form.json.dialogOptions||{}));

            if( layout.mobile ){
                var size = $(document.body).getSize();
                options.width = size.x;
                options.height = size.y;
            }

            var dlg = o2.DL.open( options );
        }
    },
    sortAttachment: function (node) {
        var nodes = node.getChildren();
        nodes.each(function (item, idx) {
            var att = item.retrieve("att", null);
            if (att) {
                att.data.orderNumber = idx;
                o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.changeOrderNumber(att.data.id, this.module.form.businessData.work.id, idx);
            }
        }.bind(this));
        this.attachments = this.attachments.sort(function (a1, a2) {
            if (!a2.data.orderNumber) return 1;
            if (!a1.data.orderNumber) return -1;
            return a1.data.orderNumber - a2.data.orderNumber;
        }.bind(this));

        this.reloadAttachments();
        this.fireEvent("order");
    },

    checkPreviewAttachment: function( e, node, attachments ){
        if( !attachments.length )return;
        var flag = false;
        var att = attachments[0];
        if (this.options.allowPreviewExtension.contains(att.data.extension)) {
            flag = true;
        }
        if (["doc","docx","xls","xlsx","ppt","pptx"].contains(att.data.extension)) {
            flag = true;
        }
        if( flag ){
            this.module.previewAttachment([att])
        }else{
            this.module.openAttachment(e, node, [att])
        }
    },

    addAttachment: function(data, messageId, isCheckPosition){

        if (data.objectSecurityClearance){
            data.objectSecurityPromise = this.getSecurityDefaultLabelList().then(function (list){
                return Object.keys(list).find( function(key){
                    return list[key]===data.objectSecurityClearance;
                });
            });
        }

        if (this.options.size=="min"){
            this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(data, this, messageId, isCheckPosition));
        }else{
            this.attachments.push(new o2.widget.AttachmentController.Attachment(data, this, messageId, isCheckPosition));
        }
        this.checkActions();
    },
    downloadBatchAttachment : function () {
        var job = this.module.form.businessData.work.job;
        var site = this.module.json.site || this.module.json.id;
        var url = "/x_processplatform_assemble_surface/jaxrs/attachment/batch/download/job/" + job + "/site/" + site;
        url = o2.filterUrl(o2.Actions.getHost("x_processplatform_assemble_surface") + url);

        if ((o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC())) {
            var urlObj = new URL(url);
            url += (urlObj.search !== '' ? '&' : '?') + o2.tokenName + "=" + layout.session.token;
            window.location = url;
        } else {
            window.open(url);
        }
    }
});


/** @class Attachment 附件组件。
 * @o2cn 附件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var attachment = this.form.get("name"); //获取组件
 * //方法2
 * var attachment = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Attachment = MWF.APPAttachment = new Class(
    /** @lends MWF.xApplication.process.Xform.Attachment# */
{
    Extends: MWF.APP$Module,
    options: {
        /**
         * @event MWF.xApplication.process.Xform.Attachment#postLoad
         * @ignore
         */
        "moduleEvents": [
            /**附件组件（this.target）加载前触发。
             * @event MWF.xApplication.process.Xform.Attachment#queryLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "queryLoad",

            /**附件容器（this.target.attachmentController）初始化之前触发，可以通过this.event获取附件容器的选项。
             * @event MWF.xApplication.process.Xform.Attachment#queryLoadController
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "queryLoadController",

            /**附件容器（this.target.attachmentController）初始化之后，加载之前触发。
             * @event MWF.xApplication.process.Xform.Attachment#loadController
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "loadController",

            /**附件容器（this.target.attachmentController）加载之后触发，但这时还未加载具体的附件。
             * @event MWF.xApplication.process.Xform.Attachment#postLoadController
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "postLoadController",

            /**
             * 附件组件（this.target）加载完成后触发。这时候附件容器和每个附件都已加载完成。
             * @event MWF.xApplication.process.Xform.Attachment#load
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "load",

            /**
             * 附件组件（this.target）加载完成后触发。这时候附件容器和每个附件都已加载完成。
             * @event MWF.xApplication.process.Xform.Attachment#afterLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterLoad",

            /**
             * 加载每个附件前触发。本事件中可以通过this.event获取加载的附件对象
             * @event MWF.xApplication.process.Xform.Attachment#beforeLoadAttachment
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeLoadAttachment",

            /**
             * 加载每个附件后触发。本事件中可以通过this.event获取加载的附件对象
             * @event MWF.xApplication.process.Xform.Attachment#loadAttachment
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "loadAttachment",

            /**
             * 附件上传前触发。本事件中可以通过this.event获取上传的文件数组
             * @event MWF.xApplication.process.Xform.Attachment#beforeUpload
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeUpload",

            /**
             * 每个附件上传后触发。本事件中可以通过this.event获取上传附件的数据
             * @event MWF.xApplication.process.Xform.Attachment#upload
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "upload",

            /**
             * 多选的附件上传完成后触发。this.event为本次上传的所有附件
             * @event MWF.xApplication.process.Xform.Attachment#afterUpload
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterUpload",

            /**
             * 删除附件前触发。本事件中可以通过this.event获取被删附件的数据
             * @event MWF.xApplication.process.Xform.Attachment#delete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "delete",

            /**
             * 删除附件后触发。本事件中可以通过this.event获取被删附件的数据
             * @event MWF.xApplication.process.Xform.Attachment#afterDelete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterDelete",

            /**
             * 附件有变化的时候会被触发，包括上传、替换、删除、排序
             * @event MWF.xApplication.process.Xform.Attachment#change
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "change",

            /**
             * 下载附件后触发。本事件中可以通过this.event获取被下载附件对象
             * @event MWF.xApplication.process.Xform.Attachment#download
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "download",

            /**
             * 打开附件后触发。本事件中可以通过this.event获取被打开附件对象
             * @event MWF.xApplication.process.Xform.Attachment#open
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "open",

            /**
             * 选中附件后触发。本事件中可以通过this.event获取被选中的附件对象
             * @event MWF.xApplication.process.Xform.Attachment#select
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "select",

            /**
             * 取消选中附件后触发。本事件中可以通过this.event获取被取消选中的附件对象
             * @event MWF.xApplication.process.Xform.Attachment#unselect
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "unselect"
        ]
    },

    initialize: function (node, json, form, options) {
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
    },
    _loadUserInterface: function () {
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this.node.empty();
            if (this.form.businessData.work.startTime){
                this.loadAttachmentController();
                this.fireEvent("afterLoad");
            }
            this.fieldModuleLoaded = true;
        }

       
    },
    /** @summary 重新加载附件。会触发queryLoadController、loadController和postLoadController事件。
     * @memberof MWF.xApplication.process.Xform.Attachment
     * @param refresh {Boolean} 是否重新从后台获取附件列表.
     * @param callback {Function} 刷新后的回调.
     * @example
     *  this.form.get("fieldId").reload(); //重新加载
     * @example
     *  this.form.get("fieldId").reload( true ); //重新从后台获取附件并重新加载
     */
    reload: function( refresh, callback ){
        this.node.empty();
        if (this.form.businessData.work.startTime){
            if( refresh ){
                var job = (this.form.businessData.work || this.form.businessData.workCompleted ).job;
                o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.
                    listWithJob(job, function(json){
                        this.form.businessData.attachmentList = json.data;
                        this.loadAttachmentController();
                        if(callback)callback();
                }.bind(this));
            }else{
                this.loadAttachmentController();
                if(callback)callback();
            }
        }
        if(callback)callback();
    },
    getFlagDefaultFalse: function( key ){
        if( this.json[key] === "y" || this.json[key] === "true" )return true;
        if( this.json[key] === "hidden" )return "hidden";
        return false;
    },
    getFlagDefaultTrue: function( key ){
        if( this.json[key] === "n" || this.json[key] === "false" )return false;
        if( this.json[key] === "hidden" )return "hidden";
        return true;
    },
    loadAttachmentController: function () {
        //MWF.require("MWF.widget.AttachmentController", function() {
        var options = {
            "style": this.json.style || "default",
            "title": MWF.xApplication.process.Xform.LP.attachmentArea,
            "listStyle": this.json.listStyle || "icon",
            "size": this.json.size || "max",
            "resize": this.getFlagDefaultFalse("resize"),
            "attachmentCount": this.json.attachmentCount || 0,
            "isUpload": this.getFlagDefaultFalse("isUpload"),
            "isDelete": this.getFlagDefaultFalse("isDelete"),
            "isReplace": this.getFlagDefaultFalse("isReplace"),
            "isDownload": this.getFlagDefaultFalse("isDownload"),
            "isDownloadBatch": this.getFlagDefaultFalse("isDownloadBatch"),
            "isPreviewAtt": this.getFlagDefaultFalse("isPreviewAtt"),
            "isEditAtt": this.getFlagDefaultFalse("isEditAtt"),
            "isSizeChange": this.getFlagDefaultFalse("isSizeChange"),
            "isConfig": this.getFlagDefaultTrue("isConfig"),
            "isOrder": this.getFlagDefaultTrue("isOrder"),
            "dblclick": this.json.dblclick,
            "readonly": (!this.isEditable || this.json.readonly === "y" || this.json.readonly === "true" || this.json.isReadonly || this.form.json.isReadonly),
            "availableListStyles": this.json.availableListStyles ? this.json.availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": this.json.isDelete,
            "isReplaceOption": this.json.isReplace,
            "toolbarGroupHidden": this.json.toolbarGroupHidden || [],
            "singleToolbarHidden" : this.json.singleToolbarHidden || [], //delete edit config open edit
            "onOrder": function () {
                this.fireEvent("change");
                this.save();
            }.bind(this)
        };
        if (this.readonly) options.readonly = true;
        if (this.form.json.attachmentStyle) {
            options = Object.merge(options, this.form.json.attachmentStyle);
        }
        //this.attachmentController = new MWF.widget.ATTER(this.node, this, options);

        this.fireEvent("queryLoadController", [options]);

        /**
         * @summary 附件容器.
         * @member {MWF.xApplication.process.Xform.AttachmentController}
         * @example
         * var attachmentController = this.form.get("fieldId").attachmentController; //获取附件容器
         * var attachmentList = attachmentController.attachments; //获取所有的附件
         * var attachmentData = attachmentList[0].data; //获取第一个附件的数据
         */

        this.attachmentController = new MWF.xApplication.process.Xform.AttachmentController(this.node, this, options);

        this.fireEvent("loadController");

        this.attachmentController.load();

        this.fireEvent("postLoadController");

        if (this.isReadable){
            this.form.businessData.attachmentList.each(function (att) {
                //if (att.site===this.json.id || (this.json.isOpenInOffice && this.json.officeControlName===att.site)) this.attachmentController.addAttachment(att);
                if (att.site === (this.json.site || this.json.id)) this.attachmentController.addAttachment(att);
            }.bind(this));
            this.setAttachmentBusinessData();
    
            this.addEvent("change", function () {
                if(this.validationMode)this.validationMode();
            }.bind(this))
        }
        

        //}.bind(this));
    },

    setAttachmentBusinessData: function () {
        if (this.attachmentController) {
            if (this.attachmentController.attachments.length) {
                var values = this.attachmentController.attachments.map(function (d) {
                    return d.data.name;
                });
                this._setBusinessData(values);
            } else {
                this._setBusinessData([]);
            }
        }
    },
    save: function(){
        if( this.json.id.indexOf("..") > 0 )return;
        if (this.attachmentController) {
            var values = [];
            if (this.attachmentController.attachments.length) {
                values = this.attachmentController.attachments.map(function (d) {
                    return d.data.name;
                });
            }
            var modifedData = {};
            modifedData[ this.json.id ] = values;
            this.form.workAction.saveData(function () {
                if(this.form.businessData.originalData)this.form.businessData.originalData[this.json.id] = values;
            }.bind(this), function(){
                return true;
            }, this.form.businessData.work.id, modifedData, false);
        }
    },

    _loadEvents: function (editorConfig) {
        Object.each(this.json.events, function (e, key) {
            if (e.code) {
                if (this.options.moduleEvents.indexOf(key) !== -1) {
                    this.addEvent(key, function (event) {
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                } else {
                    this.node.addEvent(key, function (event) {
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));

    },

    isEmpty : function(){
        var data = this.getData();
        if( typeOf(data) === "array" ){
            return data.length == 0
        }else{
            return !data;
        }
    },
    /**
     * @summary 获取当前组件所有附件的标题.如果没有附件返回null
     * @example
     * var getAttachmentNames = this.form.get("name").getData();
     * @return {StringArray|Null} 附件标题.
     */
    getData: function () {
        return (this.attachmentController) ? this.attachmentController.getAttachmentNames() : null;
    },
    createUploadFileNode: function (files) {
        var accept = "*";
        if (!this.json.attachmentExtType || (this.json.attachmentExtType.indexOf("other") != -1 && !this.json.attachmentExtOtherType)) {
        } else {
            var accepts = [];
            var otherType = this.json.attachmentExtOtherType;
            this.json.attachmentExtType.each(function (v) {
                switch (v) {
                    case "word":
                        accepts.push(".doc, .docx, .dot, .dotx");
                        break;
                    case "excel":
                        accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");
                        break;
                    case "ppt":
                        accepts.push(".pptx, .ppt, .pot, .potx, .potm");
                        break;
                    case "txt":
                        accepts.push(".txt");
                        break;
                    case "pic":
                        accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");
                        break;
                    case "pdf":
                        accepts.push(".pdf");
                        break;
                    case "zip":
                        accepts.push(".zip, .rar");
                        break;
                    case "audio":
                        accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");
                        break;
                    case "video":
                        accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");
                        break;
                    case "other":
                        if (this.json.attachmentExtOtherType) accepts.push(this.json.attachmentExtOtherType);
                        break;
                }
            }.bind(this));
            accept = accepts.join(", ");
        }
        var size = 0;
        if (this.json.attachmentSize) size = this.json.attachmentSize.toFloat();
        var promises = [];
        this.attachmentController.doUploadAttachment(
            { "site": (this.json.site || this.json.id) },
            this.form.workAction.action,
            "uploadAttachment",
            { "id": this.form.businessData.work.id },
            function(){
                Promise.all( promises ).then( function( arg ){
                    var attDatas = arg.map( function (a){ return a.json ? a.json.data : {}; } );
                    this.form.workAction.listAttachments(this.form.businessData.work.id, function (json) {
                        this.attachmentController.orderAttachments(json.data);
                        this.fireEvent("afterUpload", [attDatas]);
                    }.bind(this));
                }.bind(this));
            }.bind(this),
            function (o) {
                if (o.id) {
                    var p = this.form.workAction.getAttachment(o.id, this.form.businessData.work.id, function (json) {
                        if (json.data) {
                            if (!json.data.control) json.data.control = {};

                            this.form.businessData.attachmentList.push(json.data);

                            this.attachmentController.addAttachment(json.data, o.messageId);
                        }
                        this.attachmentController.checkActions();

                        this.setAttachmentBusinessData();
                        this.fireEvent("upload", [json.data]);
                        this.fireEvent("change");

                        this.save();
                    }.bind(this));
                    promises.push(p.res);
                }
                this.attachmentController.checkActions();
            }.bind(this),
            function (files) {
                if (files.length) {
                    if ((files.length + this.attachmentController.attachments.length > this.attachmentController.options.attachmentCount) && this.attachmentController.options.attachmentCount > 0) {
                        var content = MWF.xApplication.process.Xform.LP.uploadMore;
                        content = content.replace("{n}", this.attachmentController.options.attachmentCount);
                        this.form.notice(content, "error");
                        return false;
                    }
                }

                this.uploadingFiles = files;
                if (this.json.uploadValidation && this.json.uploadValidation.code) {
                    var flag = this.form.Macro.exec(this.json.uploadValidation.code, this);
                    if (!flag) flag = MWF.xApplication.process.Xform.LP.notAttachmentValidation;
                    if (flag.toString()!="true"){
                        this.form.notice(flag, "error");
                        return false;
                    }
                }

                this.fireEvent("beforeUpload", [files]);
                return true;
            }.bind(this),
            true,
            accept,
            size,
            function (o) { //错误的回调
                if (o.messageId && this.attachmentController.messageItemList) {
                    var message = this.attachmentController.messageItemList[o.messageId];
                    if( message && message.node )message.node.destroy();
                }
            }.bind(this),
            files
        );
    },
    uploadAttachment: function (e, node, files) {
        if (window.o2android && window.o2android.postMessage) {
            var body = {
                type: "uploadAttachment",
                data: {
                    site: this.json.site || this.json.id
                }
            };
            window.o2android.postMessage(JSON.stringify(body));
        } else if (window.o2android && window.o2android.uploadAttachment) {
            window.o2android.uploadAttachment((this.json.site || this.json.id));
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.uploadAttachment) {
            window.webkit.messageHandlers.uploadAttachment.postMessage({ "site": (this.json.site || this.json.id) });
        } else {
            // if (!this.uploadFileAreaNode){
            this.createUploadFileNode(files);
            // }
            // this.fileUploadNode.click();
        }
    },
    deleteAttachments: function (e, node, attachments) {
        var names = [];
        attachments.each(function (attachment) {
            names.push(attachment.data.name);
        }.bind(this));

        // if ((window.o2 && window.o2.replaceAttachment) || (window.webkit && window.webkit.messageHandlers)){
        //     if (window.confirm(MWF.xApplication.process.Xform.LP.deleteAttachment+"( "+names.join(", ")+" )")){
        //         while (attachments.length){
        //             attachment = attachments.shift();
        //             this.deleteAttachment(attachment);
        //         }
        //     }
        // }else {
        // var tmpNode = new Element("div", {
        //     "styles": {
        //         "background-color": "#0000ff",
        //         "border-style": "solid",
        //         "border-color": "#fff",
        //         "border-width": "1",
        //         "box-shadow": "0px 0px 20px #999",
        //         "z-index": "20000",
        //         "overflow": "hidden",
        //         "font-size": "14px",
        //         "height": "160px",
        //         "padding": "0px",
        //         "width": "300px",
        //         "position": "absolute",
        //         "top": "50px",
        //         "left": "20px",
        //         "opacity": 1,
        //         "border-radius": "5px"
        //     }
        // }).inject(this.form.app.content);

        var _self = this;
        this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.deleteAttachmentTitle, MWF.xApplication.process.Xform.LP.deleteAttachment + "( " + o2.txt(names.join(", ")) + " )", 300, 120, function () {
            while (attachments.length) {
                var attachment = attachments.shift();
                _self.deleteAttachment(attachment);
            }
            this.close();
        }, function () {
            this.close();
        }, null, null, this.form.json.confirmStyle);
    },
    editAttachment: function (attachments) {
        var att = attachments[0];

        switch (this.json.officeTool) {
            case "LibreOffice":
                this.editLibreOffice(att);
                break;
            case "OfficeOnline":
                this.editOfficeOnline(att);
                break;
            case "OnlyOffice":
                this.editOnlyOffice(att);
                break;
            case "YozoOffice":
                this.editYozoOffice(att);
                break;
            case "WpsOffice":
                this.editWpsOffice(att);
                break;
            default :
                this.editLibreOffice(att);

        }

    },
    editYozoOffice : function (att){

        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"write",
            "jars" : jars,
            "appId":  "YozoOfficeEditor" + att.data.id
        };
        layout.openApplication(null, "YozoOfficeEditor", options);
    },
    editOfficeOnline : function (att){

        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"write",
            "jars" : jars,
            "appId":  "OfficeOnlineEditor" + att.data.id
        };
        layout.openApplication(null, "OfficeOnlineEditor", options);
    },
    editOnlyOffice : function (att){

        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"edit",
            "jars" : jars,
            "appId":  "OnlyOfficeEditor" + att.data.id
        };
        layout.openApplication(null, "OnlyOfficeEditor", options);
    },
    editWpsOffice : function (att){

        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"write",
            "jars" : jars,
            "appId":  "WpsOfficeEditor" + att.data.id
        };
        layout.openApplication(null, "WpsOfficeEditor", options);
    },
    editLibreOffice : function (att){

        this.form.notice("not support");
    },


    previewAttachment: function (attachments) {
        var att = attachments[0];
        new MWF.xApplication.process.Xform.AttachmenPreview(att,this);
    },
    deleteAttachment: function (attachment) {
        this.fireEvent("delete", [attachment.data]);
        var id = attachment.data.id;
        this.form.workAction.deleteAttachment(attachment.data.id, this.form.businessData.work.id, function (josn) {
            this.attachmentController.removeAttachment(attachment);
            this.attachmentController.checkActions();

            for( var i=0; i<this.form.businessData.attachmentList.length; i++ ){
                var attData = this.form.businessData.attachmentList[i];
                if( attData.id === id ){
                    this.form.businessData.attachmentList.erase(attData);
                    break;
                }
            }

            if (this.form.officeList) {
                this.form.officeList.each(function (office) {
                    if (office.openedAttachment) {
                        if (office.openedAttachment.id == id) {
                            office.loadOfficeEdit();
                        }
                    }
                }.bind(this));
            }
            this.setAttachmentBusinessData();
            this.fireEvent("afterDelete", [attachment.data]);
            this.fireEvent("change");

            this.save();
        }.bind(this));
    },

    replaceAttachment: function (e, node, attachment) {
        if (window.o2android && window.o2android.postMessage) {
            var body = {
                type: "replaceAttachment",
                data: {
                    attachmentId: attachment.data.id,
                    site: this.json.site || this.json.id
                }
            };
            window.o2android.postMessage(JSON.stringify(body));
        } else if (window.o2android && window.o2android.replaceAttachment) {
            window.o2android.replaceAttachment(attachment.data.id, (this.json.site || this.json.id));
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.replaceAttachment) {
            window.webkit.messageHandlers.replaceAttachment.postMessage({ "id": attachment.data.id, "site": (this.json.site || this.json.id) });
        } else {
            var _self = this;
            this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.replaceAttachmentTitle, MWF.xApplication.process.Xform.LP.replaceAttachment + "( " + attachment.data.name + " )", 350, 120, function () {
                _self.replaceAttachmentFile(attachment);
                this.close();
            }, function () {
                this.close();
            }, null, null, this.form.json.confirmStyle);
        }
    },

    createReplaceFileNode: function (attachment) {
        var accept = "*";
        if (!this.json.attachmentExtType || this.json.attachmentExtType.indexOf("other") != -1 && !this.json.attachmentExtOtherType) {
        } else {
            accepts = [];
            var otherType = this.json.attachmentExtOtherType;
            this.json.attachmentExtType.each(function (v) {
                switch (v) {
                    case "word":
                        accepts.push(".doc, .docx, .dot, .dotx");
                        break;
                    case "excel":
                        accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");
                        break;
                    case "ppt":
                        accepts.push(".pptx, .ppt, .pot, .potx, .potm");
                        break;
                    case "txt":
                        accepts.push(".txt");
                        break;
                    case "pic":
                        accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");
                        break;
                    case "pdf":
                        accepts.push(".pdf");
                        break;
                    case "zip":
                        accepts.push(".zip, .rar");
                        break;
                    case "audio":
                        accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");
                        break;
                    case "video":
                        accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");
                        break;
                    case "other":
                        if (this.json.attachmentExtOtherType) accepts.push(this.json.attachmentExtOtherType);
                        break;
                }
            });
            accept = accepts.join(", ");
        }
        var size = 0;
        if (this.json.attachmentSize) size = this.json.attachmentSize.toFloat();
        this.attachmentController.doUploadAttachment(
            { "site": (this.json.site || this.json.id) },
            this.form.workAction.action,
            "replaceAttachment",
            { "id": attachment.data.id, "workid": this.form.businessData.work.id },
            function(){ //finish
                this.form.workAction.listAttachments(this.form.businessData.work.id, function (json) {
                    this.attachmentController.orderAttachments(json.data);
                }.bind(this));
            }.bind(this),
            function (o) { //every
                this.form.workAction.getAttachment(attachment.data.id, this.form.businessData.work.id, function (json) {
                    attachment.data = json.data;
                    attachment.reload();

                    this.fireEvent("change");

                    if (o.messageId && this.attachmentController.messageItemList) {
                        var message = this.attachmentController.messageItemList[o.messageId];
                        if( message && message.node )message.node.destroy();
                    }

                    this.attachmentController.checkActions();

                    this.save();
                }.bind(this))
            }.bind(this),
            null,
            true,
            accept,
            size,
            function (o) { //错误的回调
                if (o.messageId && this.attachmentController.messageItemList) {
                    var message = this.attachmentController.messageItemList[o.messageId];
                    if( message && message.node )message.node.destroy();
                }
            }.bind(this)
        );

        // this.replaceFileAreaNode = new Element("div");
        // var html = "<input name=\"file\" type=\"file\" multiple/>";
        // this.replaceFileAreaNode.set("html", html);
        //
        // this.fileReplaceNode = this.replaceFileAreaNode.getFirst();
        // this.fileReplaceNode.addEvent("change", function(){
        //
        //     var files = this.fileReplaceNode.files;
        //     if (files.length){
        //         for (var i = 0; i < files.length; i++) {
        //             var file = files.item(i);
        //
        //             var formData = new FormData();
        //             formData.append('file', file);
        //         //    formData.append('site', this.json.id);
        //
        //             this.form.workAction.replaceAttachment(attachment.data.id, this.form.businessData.work.id ,function(o, text){
        //                 this.form.workAction.getAttachment(attachment.data.id, this.form.businessData.work.id, function(json){
        //                     attachment.data = json.data;
        //                     attachment.reload();
        //                     this.attachmentController.checkActions();
        //                 }.bind(this))
        //             }.bind(this), null, formData, file);
        //         }
        //     }
        // }.bind(this));
    },

    replaceAttachmentFile: function (attachment) {
        //if (!this.replaceFileAreaNode){
        this.createReplaceFileNode(attachment);
        // }
        // this.fileReplaceNode.click();
    },
    queryDownload : function( att ){
        if( this.json.events && this.json.events.queryDownload && this.json.events.queryDownload.code ){
            var flag = this.form.Macro.exec(this.json.events.queryDownload.code, att );
            if( flag === false ){
                return false
            }else{
                return true;
            }
        }else{
            return true;
        }
    },
    queryOpen : function( att ){
        if( this.json.events && this.json.events.queryOpen && this.json.events.queryOpen.code ){
            var flag = this.form.Macro.exec(this.json.events.queryOpen.code, att );
            if( flag === false ){
                return false
            }else{
                return true;
            }
        }else{
            return true;
        }
    },
    //小程序文件是否支持打开
    checkMiniProgramFile: function(ext) {
        var exts = ["doc", "docx", "xls", "xlsx", "ppt", "pptx", "pdf"];
        for(var i = 0; i < exts.length; i++){
            if(ext === exts[i]){
                return true;
            }
        }
        return false;
    },
    addMessage: function(data) {
        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.taskProcessed,
                "content": data
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(data);
            }
        }
    },
    downloadAttachment: function (e, node, attachments) {

        var data = this.form.businessData;
        var isWorkCompleted = data.work && data.work.completedTime;

        var workId = data.work.id;
        var actionUrl = "getAttachmentUrl";
        var actionData = "getAttachmentStream";
        var urlWorkKey = "work";

        if (isWorkCompleted){
            workId = (data.workCompleted) ? data.workCompleted.id : workId;
            actionUrl = "getAttachmentWorkcompletedUrl";
            actionData = "getWorkcompletedAttachmentStream";
            urlWorkKey = "workCompleted";
        }

        var client = this.getDownloadAttachmentClientType();
        console.log(client+" 客户端");
        attachments.each(function (att) {
            if( !this.queryDownload( att ) )return;

            switch (client){
                case "flutter":
                    var body = {
                        type: "downloadAttachment",
                        data: {
                            attachmentId: att.data.id
                        }
                    };
                    window.o2android.postMessage(JSON.stringify(body));
                    break
                case "android":
                    window.o2android.downloadAttachment(att.data.id);
                    break;
                case "ios":
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": (this.json.site || this.json.id) });
                    break;
                case "wx":
                    if(this.checkMiniProgramFile(att.data.extension)) {
                        wx.miniProgram.navigateTo({
                            url: '../file/download?attId=' + att.data.id + '&type=work&'+urlWorkKey+'=' + workId
                        });
                    }
                    break;
                case "mobile":
                    this.form.workAction[actionUrl](att.data.id, workId, function (url) {
                        var xtoken = layout.session.token;
                        // window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        window.location = url + "?"+o2.tokenName+"=" + xtoken;
                    });
                    break;
                case "pcClient":
                    this.form.workAction[actionUrl](att.data.id, workId, function (url) {
                        var xtoken = layout.session.token;
                        // window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        window.location = url + "?"+o2.tokenName+"=" + xtoken;
                    });
                    break;
                default:
                    this.form.workAction[actionData](att.data.id, workId);
            }
            this.fireEvent("download",[att]);
        }.bind(this));

    },
    getDownloadAttachmentClientType: function(){
        if (window.o2android && window.o2android.postMessage) {
            return "flutter";
        }
        if (window.o2android && window.o2android.downloadAttachment){
            return "android";
        }
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.downloadAttachment){
            return "ios";
        }
        if (window.wx && window.__wxjs_environment === 'miniprogram'){
            return "wx";
        }
        if (layout.mobile){
            return "mobile";
        }
        if (o2.thirdparty.isDingdingPC() || o2.thirdparty.isQywxPC()){
            return "pcClient";
        }
        return "pc";
    },
    openAttachment: function (e, node, attachments) {
        var data = this.form.businessData;
        var isWorkCompleted = data.work && data.work.completedTime;

        var workId = data.work.id;
        var actionUrl = "getAttachmentUrl";
        var actionData = "getAttachmentData";
        var urlWorkKey = "work";

        if (isWorkCompleted){
            workId = (data.workCompleted) ? data.workCompleted.id : workId;
            actionUrl = "getAttachmentWorkcompletedUrl";
            actionData = "getWorkcompletedAttachmentData";
            urlWorkKey = "workCompleted";
        }

        var client = this.getDownloadAttachmentClientType();
        console.log(client+" 客户端");

        attachments.each(function (att) {
            if( !this.queryOpen( att ) )return;

            switch (client){
                case "flutter":
                    var body = {
                        type: "downloadAttachment",
                        data: {
                            attachmentId: att.data.id
                        }
                    };
                    window.o2android.postMessage(JSON.stringify(body));
                    break
                case "android":
                    window.o2android.downloadAttachment(att.data.id);
                    break;
                case "ios":
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": (this.json.site || this.json.id) });
                    break;
                case "wx":
                    if(this.checkMiniProgramFile(att.data.extension)) {
                        wx.miniProgram.navigateTo({
                            url: '../file/download?attId=' + att.data.id + '&type=work&'+urlWorkKey+'=' + workId
                        });
                    }
                    break;
                case "mobile":
                    this.form.workAction[actionUrl](att.data.id, workId, function (url) {
                        var xtoken = layout.session.token;
                        // window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        window.location = url + "?"+o2.tokenName+"=" + xtoken;
                    });
                    break;
                case "pcClient":
                    this.form.workAction[actionUrl](att.data.id, workId, function (url) {
                        var xtoken = layout.session.token;
                        // window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        window.location = url + "?"+o2.tokenName+"=" + xtoken;
                    });
                    break;
                default:
                    this.form.workAction[actionData](att.data.id, workId);
            }
            this.fireEvent("open",[att]);
        }.bind(this));

    },
    getAttachmentUrl: function (attachment, callback) {
        if (this.form.businessData.work && !this.form.businessData.work.completedTime) {
            this.form.workAction.getAttachmentUrl(attachment.data.id, this.form.businessData.work.id, callback);
        } else {
            this.form.workAction.getAttachmentWorkcompletedUrl(attachment.data.id, this.form.businessData.workCompleted.id, callback);
        }
    },
    getTextData: function(){
        var data = [];
        this.attachmentController.attachments.each(function(att){
            var o = {
                "id": att.data.id,
                "person": att.data.person,
                "creatorUid": att.data.creatorUid,
                "name": att.data.name,
                "orderNumber": att.data.orderNumber,
                "length": att.data.length,
                "extension": att.data.extension,
                "lastUpdateTime": att.data.lastUpdateTime,
                "activityName": att.data.activityName,
                "control" : att.data.control
            }
            data.push(o);
        });
        return data;
    },
    /**
     * @summary 为组件重新设置附件，该附件必须已经上传。
     *  @param data {Array}.
     *  <pre><code class='language-js'>[{
     *     "id": "56c4e86f-a4c8-4cc2-a150-1a0d2c5febcb",   //附件ID
     *     "name": "133203a2-92e6-4653-9954-161b72ddb7f9.png", //附件名称
     *     "extension": "png",                             //附件扩展名
     *     "length": 43864,                                //附件大小
     *     "person": "xx@huqi@P",                          //附件上传人
     *     "lastUpdateTime": "2018-09-27 15:50:34",        //最后的修改时间
     *     "lastUpdatePerson": "xx@huqi@P",                //最后的修改人
     *     "activity": "e31ad938-c495-45a6-8d77-b8a9b61a165b", //附件上传的活动ID
     *     "activityName": "申请人",                           //附件上传的活动名称
     *     "activityType": "manual",                           //附件上传的活动类型
     *     "site": "$mediaOpinion",                        //附件存储位置（一般用于区分附件在哪个表单元素中显示）
     *     "type": "image/png",                             //附件类型（contentType）
     *     "control": {}
     * }]</code></pre>
     */
    setData: function(data){
        this.attachmentController.clear();
        ( data || [] ).each(function (att) {
            var attachment = this.form.businessData.attachmentList.find(function(a){
                return a.id==att.id;
            });
            var attData = attachment || att;

            this.attachmentController.addAttachment(attData);
        }.bind(this));
        this.setAttachmentBusinessData();
    },
    createErrorNode: function (text) {
        node = new Element("div", {styles:{
            "margin-top": "0.3em"  
        }});
        var iconNode = new Element("div.ooicon-error", {
            "styles": {
                "width": "20px",
                "height": "1.2em",
                "float": "left",
                "display": "flex",
                "color": "red",
                "align-items": "center",
                "justify-content": "center"
                // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "height": "auto",
                "line-height": "1.2em",
                "margin-left": "20px",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function (text) {
        if (!this.isNotValidationMode) {
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);

            var parentNode = this.errNode;
            while( parentNode && parentNode.offsetParent === null ){
                parentNode = parentNode.getParent();
            }

            if ( parentNode && !parentNode.isIntoView()) parentNode.scrollIntoView(false);
        }
    },
    showNotValidationMode: function (node) {
        var p = node.getParent("div");
        if (p) {
            if (p.get("MWFtype") == "tab$Content") {
                if (p.getParent("div").getStyle("display") == "none") {
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function () {
        if (this.isNotValidationMode) {
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode) {
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function (routeName, data) {
        var flag = (data.status == "all") ? true : (routeName == data.decision);
        if (flag) {
            var n = this.getData() || [];
            var v = (data.valueType == "value") ? n : n.length;
            switch (data.operateor) {
                case "isnull":
                    if (!v) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v > data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v < data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v == data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v != data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value) != -1) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value) == -1) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function (routeName, opinion) {
        if (this.json.validationConfig) {
            if (this.json.validationConfig.length) {
                for (var i = 0; i < this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },

    getExcelData: function(){
        return "";
    },
    setExcelData: function(data){
    },

});
MWF.xApplication.process.Xform.AttachmenPreview = new Class({
    Implements: [Options, Events],

    initialize : function(att,app ){
        this.att = att;
        this.app = app;
        this.load();
    },
    load:function(){

        var extension = this.att.data.extension;
        if(extension === "ofd"){
            //ofd预览暂时屏蔽ie，等兼容性改好了开启
            if(Browser.name!=="ie"){
                this.previewOfd();
            }
        }
        if(extension === "zip"){
            this.previewZip();
        }
        if(extension === "pdf"){
            this.previewPdf();
        }
        if(["doc","docx","xls","xlsx","ppt","pptx"].contains(extension)){
            this.previewOffice();
        }
        if(["png","jpg","bmp","jpeg","gif"].contains(extension)){
            this.previewImage();
        }
        if(extension === "js"){
            this.previewAce("javascript");
        }
        if(extension === "css"){
            this.previewAce("css");
        }
        if(extension === "java"){
            this.previewAce("java");
        }
        if(extension === "json"){
            this.previewAce("json");
        }
        if(extension === "xml"){
            this.previewAce("xml");
        }
        if(extension === "php"){
            this.previewAce("php");
        }
        if(["html","htm","xhtml"].contains(extension)){
            this.previewAce("html");
        }
        if(["log","md","txt"].contains(extension)){
            this.previewAce("text");
        }
    },
    previewZip: function () {
        //zip压缩包预览
        var _self = this;
        var zipViewNode = new Element("div",{"text":"loadding..."});
        o2.load(["../o2_lib/jszip/jszip.min.js", "../o2_lib/jszip/jszip-utils.min.js"], function () {
            this.app.getAttachmentUrl(this.att, function (url) {
                var width, height;
                if( layout.mobile ){
                    var size = $(document.body).getSize();
                    width = size.x+"px";
                    height = size.y+"px";
                }else{
                    width = "660px";
                    height = "510px";
                }
                o2.require("MWF.widget.Tree", function(){
                    var dlg = o2.DL.open({
                        "title": _self.att.data.name,
                        "width": width,
                        "height": height,
                        "mask": true,
                        "content": zipViewNode,
                        "container": null,
                        "positionNode": document.body,
                        "onQueryClose": function () {
                            zipViewNode.destroy();
                        },
                        "buttonList": [
                            {
                                "text": "关闭",
                                "action": function () {
                                    dlg.close();
                                }
                            }
                        ],
                        "onPostShow": function () {
                            dlg.reCenter();
                        },
                        "onPostLoad" : function(){

                        }
                    });
                }.bind(this));
                zipViewNode.empty();
                JSZipUtils.getBinaryContent(url, function (err, data) {
                    JSZip.loadAsync(data).then(function (zip) {
                        var nodeList = [];
                        zip.forEach(function (relativePath, zipEntry) {
                            nodeList.push(zipEntry.name);
                        });
                        var tree = new MWF.widget.Tree(zipViewNode, {"style":"form"});
                        var treeData = _pathToTree(nodeList);
                        tree.load(treeData);


                    });
                });

            }.bind(this));
        }.bind(this));
        function _pathToTree(pathList) {
            var pathJsonList = [];
            for (var i = 0; i < pathList.length; i++) {
                var chain = pathList[i].split("/");
                var currentNode = pathJsonList;
                for (var j = 0; j < chain.length; j++) {
                    if (chain[j] === "") {
                        break;
                    }
                    var wantedNode = chain[j];
                    var lastNode = currentNode;
                    for (var k = 0; k < currentNode.length; k++) {
                        if (currentNode[k].name == wantedNode) {
                            currentNode = currentNode[k].sub;
                            break;
                        }
                    }
                    if (lastNode == currentNode) {
                        var obj = {
                            key: pathList[i],
                            name: wantedNode,
                            title:wantedNode,
                            text:wantedNode,
                            sub: []
                        };
                        var newNode = (currentNode[k] = obj);
                        if (wantedNode.indexOf(".") > -1) {
                            obj.dir = false;
                            obj.icon = "file.png";
                            delete obj.sub;
                        } else {
                            obj.dir = true;
                            obj.expand = false;
                            currentNode = newNode.sub;
                            //delete obj.sub;
                        }
                    } else {
                        delete currentNode.sub;
                    }
                }
            }
            var nodes = [];

            var folder = {
                "title" : _self.att.name,
                "text" : _self.att.name,
                "sub" : []
            };
            pathJsonList.each(function(path){
                folder.sub.push(path);
            })
            _sortPath(folder, nodes);
            return nodes;
        }
        function _sortPath(pathJsonList, nodes) {
            var folderList = [];
            pathJsonList.sub.each(function (file) {
                if (file.dir) {
                    folderList.push(file);
                }
            });
            pathJsonList.sub.each(function (file) {
                if (!file.dir) {
                    folderList.push(file);
                }
            });
            folderList.each(function (file) {
                var node = {
                    text: file.name,
                    title: file.name,
                    expand : false
                };
                if (!file.dir) {
                    node.icon = "file.png";
                }
                nodes.push(node);
                if(file.sub && file.sub.length>0){
                    node.sub = [];
                    _sortPath(file,node.sub);
                }

            })
        }
    },
    previewPdf : function(){
        this.app.getAttachmentUrl(this.att, function (url) {
            if(layout.mobile){
                location.href = "../o2_lib/pdfjs/web/viewer.html?file=" + url;
            }else{
                window.open("../o2_lib/pdfjs/web/viewer.html?file=" + url);
            }        });
    },
    previewOffice : function(){


        switch (this.app.json.officeTool) {
            case "LibreOffice":
                this.previewLibreOffice();
                break;
            case "OfficeOnline":
                this.previewOfficeOnline();
                break;
            case "OnlyOffice":
                this.previewOnlyOffice();
                break;
            case "YozoOffice":
                this.previewYozoOffice();
                break;
            case "WpsOffice":
                this.previewWpsOffice();
                break;
            default :
                this.previewLibreOffice();

        }


    },
    previewOfficeOnline : function (){
        var att = this.att;
        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"view",
            "jars" : jars,
            "appId":  "OfficeOnlineEditor" + att.data.id
        };
        layout.openApplication(null, "OfficeOnlineEditor", options);
    },
    previewOnlyOffice : function (){
        var att = this.att;
        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"view",
            "jars" : jars,
            "appId":  "OnlyOfficeEditor" + att.data.id
        };
        layout.openApplication(null, "OnlyOfficeEditor", options);
    },
    previewYozoOffice : function (){
        var att = this.att;
        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"view",
            "jars" : jars,
            "appId":  "YozoOfficeEditor" + att.data.id
        };
        layout.openApplication(null, "YozoOfficeEditor", options);
    },
    previewWpsOffice : function (){
        var att = this.att;
        var jars ;
        if(att.data.activity){
            jars = "x_processplatform_assemble_surface";
        }
        if(att.data.categoryId){
            jars = "x_cms_assemble_control";
        }

        var options = {
            "documentId": att.data.id,
            "mode":"view",
            "jars" : jars,
            "appId":  "WpsOfficeEditor" + att.data.id
        };
        layout.openApplication(null, "WpsOfficeEditor", options);
    },
    previewLibreOffice : function (){

        if(!layout.serviceAddressList["x_libreoffice_assemble_control"]){
            this.app.form.notice("Please Install LibreOffice");
            return;
        }
        var srv = layout.serviceAddressList["x_libreoffice_assemble_control"];
        var module;
        if(this.att.data.activity){
            module = "processPlatform";
        }
        if(this.att.data.categoryId){
            module = "cms";
        }

        var defaultPort = layout.config.app_protocol === 'https' ? "443" : "80";
        var appPort = srv.port || window.location.port;
        var protocol = layout.config.app_protocol || window.location.protocol;
        var hostname = srv.host || window.location.hostname;
        var context = srv.context || '';

        var url = protocol + "//" + hostname + (appPort && appPort.toString() !== defaultPort ? ":" + appPort : "") + context + "/jaxrs/office/doc/to/pdf/" + module + "/" + this.att.data.id;
        url = o2.filterUrl(url);
        window.open("../o2_lib/pdfjs/web/viewer.html?file=" + encodeURIComponent(url));
    },
    previewOfd : function(){
        this.app.getAttachmentUrl(this.att,  function (url) {
            window.open("../o2_lib/ofdjs/index.html?file=" + url)
        });
    },
    previewImage : function(){
        this.app.getAttachmentUrl(this.att, function (url) {
            var imgNode = new Element("img",{"src":url,"alt":this.att.name}).inject(document.body).hide();
            o2.loadCss("../o2_lib/viewer/viewer.css", document.body,function(){
                o2.load("../o2_lib/viewer/viewer.js", function(){
                    this.viewer = new Viewer(imgNode,{
                        navbar : false,
                        toolbar : true,
                        hidden : function(){
                            imgNode.destroy();
                            this.viewer.destroy();
                        }.bind(this)
                    });
                    this.viewer.show();
                }.bind(this));
            }.bind(this));
        }.bind(this));
    },
    previewAce:function(type){
        this.app.getAttachmentUrl(this.att,  function (url) {
            o2.require("o2.widget.ace", null, false);
            var fileRequest = new Request({
                url: url,
                method: 'get',
                withCredentials: true,
                onSuccess: function(responseText){
                    var editorNode = new Element("div",{"style":"padding:10px"});
                    editorNode.set("text",responseText);

                    o2.widget.ace.load(function(){
                        o2.load("../o2_lib/ace/src-min-noconflict/ext-static_highlight.js", function(){
                            var highlight = ace.require("ace/ext/static_highlight");
                            highlight(editorNode, {mode: "ace/mode/"+ type , theme: "ace/theme/tomorrow", "fontSize": 30,"showLineNumbers":true});
                        }.bind(this));

                    }.bind(this));
                    var width, height;
                    if( layout.mobile ){
                        var size = $(document.body).getSize();
                        width = size.x+"px";
                        height = size.y+"px";
                    }else{
                        width = "960px";
                        height = "610px";
                    }
                    var dlg = o2.DL.open({
                        "title": this.att.data.name,
                        "width": width,
                        "height": height,
                        "mask": true,
                        "content": editorNode,
                        "container": null,
                        "positionNode": document.body,
                        "onQueryClose": function () {
                            editorNode.destroy();
                        }.bind(this),
                        "buttonList": [
                            {
                                "text": "关闭",
                                "action": function () {
                                    dlg.close();
                                }.bind(this)
                            }
                        ],
                        "onPostShow": function () {
                            dlg.reCenter();
                        }.bind(this)
                    });
                }.bind(this),
                onFailure: function(){
                    console.log('text', 'Sorry, your request failed :(');
                }
            });
            fileRequest.send();
        }.bind(this));

    },
});
MWF.xApplication.process.Xform.AttachmentDg = MWF.APPAttachmentDg = new Class({
    Extends: MWF.APPAttachment,
    loadAttachmentController: function () {
        //MWF.require("MWF.widget.AttachmentController", function() {
        var options = {
            "style": this.json.style || "default",
            "title": MWF.xApplication.process.Xform.LP.attachmentArea,
            "listStyle": this.json.listStyle || "icon",
            "size": this.json.size || "max",
            "resize": this.getFlagDefaultFalse("resize"),
            "attachmentCount": this.json.attachmentCount || 0,
            "isUpload": this.getFlagDefaultFalse("isUpload"),
            "isDelete": this.getFlagDefaultFalse("isDelete"),
            "isReplace": this.getFlagDefaultFalse("isReplace"),
            "isDownload": this.getFlagDefaultFalse("isDownload"),
            "isDownloadBatch": "hidden", //this.getFlagDefaultFalse("isDownloadBatch"),
            "isPreviewAtt": this.getFlagDefaultFalse("isPreviewAtt"),
            "isEditAtt": this.getFlagDefaultFalse("isEditAtt"),
            "isSizeChange": this.getFlagDefaultFalse("isSizeChange"),
            "isConfig": this.getFlagDefaultTrue("isConfig"),
            "isOrder": this.getFlagDefaultTrue("isOrder"),
            "dblclick": this.json.dblclick,
            "readonly": (this.json.readonly === "y" || this.json.readonly === "true" || this.json.isReadonly || this.form.json.isReadonly),
            "availableListStyles": this.json.availableListStyles ? this.json.availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": this.json.isDelete,
            "isReplaceOption": this.json.isReplace,
            "toolbarGroupHidden": this.json.toolbarGroupHidden || [],
            "singleToolbarHidden" : this.json.singleToolbarHidden || [], //delete edit config open edit
            "ignoreSite": this.json.ignoreSite,
            "onOrder": function () {
                this.fireEvent("change");
            }.bind(this)
        };
        if (this.readonly) options.readonly = true;
        if (this.form.json.attachmentStyle) {
            options = Object.merge(options, this.form.json.attachmentStyle);
        }

        this.fireEvent("queryLoadController", [options]);

        this.attachmentController = new MWF.xApplication.process.Xform.AttachmentController(this.node, this, options);

        this.fireEvent("loadController");

        this.attachmentController.load();

        this.fireEvent("postLoadController");

        // var d = this._getBusinessData();
        // if (d) d.each(function (att) {
        //     this.attachmentController.addAttachment(att);
        // }.bind(this));
        if(this.json.ignoreSite) {
            ( this._getBusinessData() || [] ).each(function (att) {
                var flag = this.form.businessData.attachmentList.some(function (attData) {
                    return (att.businessId && att.businessId === attData.businessId) || att.id === attData.id;
                }.bind(this));
                if(flag)this.attachmentController.addAttachment(att);
            }.bind(this));
        }else{
            this.form.businessData.attachmentList.each(function (att) {
                if (att.site === (this.json.site || this.json.id)) this.attachmentController.addAttachment(att);
            }.bind(this));
        }
        this.setAttachmentBusinessData();
    },
    setAttachmentBusinessData: function(){
        if (this.attachmentController) {
            if (this.attachmentController.attachments.length) {
                var values = this.attachmentController.attachments.map(function (d) {
                    return {
                        "control": d.data.control,
                        "name": d.data.name,
                        "id": d.data.id,
                        "businessId": d.data.businessId,
                        "originialSite": d.data.originialSite || this.json.originialSite || this.json.originialId || this.json.site,
                        "person": d.data.person,
                        "creatorUid": d.data.creatorUid,
                        "orderNumber": d.data.orderNumber,
                        "length": d.data.length,
                        "extension": d.data.extension,
                        "lastUpdateTime": d.data.lastUpdateTime,
                        "activityName": d.data.activityName
                    };
                }.bind(this));
                this._setBusinessData(values);
            } else {
                this._setBusinessData([]);
            }
        }
    },
    uploadAttachment: function (e, node, files) {
        if (window.o2android && window.o2android.postMessage) {
            var body = {
                type: "uploadAttachmentForDatagrid",
                data: {
                    param: this.json.id,
                    site: this.json.site || this.json.id
                }
            };
            window.o2android.postMessage(JSON.stringify(body));
        } else if (window.o2android && window.o2android.uploadAttachmentForDatagrid) {
            window.o2android.uploadAttachmentForDatagrid((this.json.site || this.json.id), this.json.id);
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.uploadAttachmentForDatagrid) {
            window.webkit.messageHandlers.uploadAttachmentForDatagrid.postMessage({ "site": (this.json.site || this.json.id) , "param":this.json.id});
        } else {
            // if (!this.uploadFileAreaNode){
            this.createUploadFileNode(files);
            // }
            // this.fileUploadNode.click();
        }
    },
    replaceAttachment: function (e, node, attachment) {
        if (window.o2android && window.o2android.postMessage) {
            var body = {
                type: "replaceAttachmentForDatagrid",
                data: {
                    attachmentId: attachment.data.id,
                    param: this.json.id,
                    site: this.json.site || this.json.id,
                    businessId: attachment.data.businessId
                }
            };
            window.o2android.postMessage(JSON.stringify(body));
        } else if (window.o2android && window.o2android.replaceAttachmentForDatagrid) {
            window.o2android.replaceAttachmentForDatagrid(attachment.data.id, (this.json.site || this.json.id), this.json.id);
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.replaceAttachmentForDatagrid) {
            window.webkit.messageHandlers.replaceAttachmentForDatagrid.postMessage({ "id": attachment.data.id, "site": (this.json.site || this.json.id) , "param":this.json.id});
        } else {
            var _self = this;
            this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.replaceAttachmentTitle, MWF.xApplication.process.Xform.LP.replaceAttachment + "( " + attachment.data.name + " )", 350, 120, function () {
                _self.replaceAttachmentFile(attachment);
                this.close();
            }, function () {
                this.close();
            }, null, null, this.form.json.confirmStyle);
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @class Calendar 日期组件。
 * @o2cn 日期选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Calendar = MWF.APPCalendar =  new Class(
    /** @lends MWF.xApplication.process.Xform.Calendar# */
{
	Implements: [Events],
	Extends: MWF.APP$Input,
	iconStyle: "calendarIcon",
    options: {
        /**
         * 日期选择完成时触发.
         * @event MWF.xApplication.process.Xform.Calendar#complete
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 日期选择器上点清空时触发.
         * @event MWF.xApplication.process.Xform.Calendar#clear
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 值改变时触发.
         * @event MWF.xApplication.process.Xform.Calendar#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 显示日期选择器时触发.
         * @event MWF.xApplication.process.Xform.Calendar#show
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 隐藏日期选择器时触发.
         * @event MWF.xApplication.process.Xform.Calendar#hide
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["queryLoad","postLoad","load","complete", "clear", "change","show","hide"]
    },
    _loadNode: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                this._loadNodeEdit();
                var input = this.node.getFirst();
                input.set("readonly", true);
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function(){
                    this.descriptionNode.setStyle("display", "none");
                    //this.clickSelect();
                }.bind(this)
            });
        }
    },
    // getData: function(when){
    //     if (this.json.compute == "save") this._setValue(this._computeValue());
    //     return this.getInputData();
    // },
    getInputData: function(){
        if (typeOf(this.tmpDateString) === 'string'){
             return this.tmpDateString;
        }else{
            return this._getBusinessData();
        }
    },
    _getValueAg: function(value,isDate){
        if (value && value.isAG){
            return value.then(function(v){
                this._getValueAg(v, isDate);
            }.bind(this), function(){});
        }else{
            var d = (!!value) ? Date.parse(value) : "";
            if (isDate){
                return d || null;
            }else{
                return (d) ? d.format(this.json.format) : "";
            }
        }
    },
    resetData: function(){
        this.setData(this.getValue());
    },
    /**
     * @summary 获取显示的值，或格式化后的文本。
     * @return {String} 获取显示的值，或格式化后的文本
     * @example
     * var text = this.form.get('fieldId').getText(); //获取选中项的文本
     */
    getText: function (){
        if( this.node.getFirst() ){
            return this.node.getFirst().get("value");
        }else{
            var value = this._getBusinessData();
            var date = this.toDate(value);
            return date ? date.format(this.json.format) : value;
        }
    },
    getValue: function(isDate){
        if (!this.isReadable) return '';
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if( value && !isDate)return value;
        if (!value) value = this._computeValue();
        if (value && value.then) return value;

        var d = (!!value) ? Date.parse(value) : "";
        if (isDate){
            return d || null;
        }else{
            //if (d) value = Date.parse(value).format(this.json.format);
            return (d) ? d.format( this.json.valueFormat || this.json.format) : "";
        }

        return value || "";
    },
    getValueStr: function(){
        var value = this._getBusinessData();
        if (!value) value = this._computeValue();
        return value;
    },
    __setData: function(data, fireChange){
        var old = this._getBusinessData();
        var date = this.toDate(data);
        var val = (date && this.json.valueFormat) ? date.format(this.json.valueFormat) : data;
        var text = date ? date.format(this.json.format) : data;
        this._setBusinessData(val);
        if (this.node.getFirst()){
            this.node.getFirst().set("value", text);
            this.checkDescription();
            this.validationMode();
        }else{
            this.node.set("text", text);
        }
        if (fireChange && old!==val) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function(value){
        var date = this.toDate(value);
        var val = date ? date.format(this.json.valueFormat || this.json.format) : value;
        var text = date ? date.format(this.json.format) : value;
        this._setBusinessData(val);
        if (this.node.getFirst()) this.node.getFirst().set("value", text || "");
        if (this.isReadonly()) this.node.set("text", text);
        this.moduleValueAG = null;
        this.fieldModuleLoaded = true;
        return value;
    },
    _beforeReloaded: function(){
        this.calendar = null;
    },
	clickSelect: function(){

        var _self = this;
        if (!this.calendar){
            MWF.require("MWF.widget.Calendar", function(){
                var defaultView = "day";
                if( this.json.selectType === "month" )defaultView = "month";
                if( this.json.selectType === "year" )defaultView = "year";
                var options = {
                    "style": o2.session.isMobile ? "xform_mobile" : "xform",
                    "secondEnable" : this.json.isSelectSecond,
                    "timeSelectType" : this.json.timeSelectType,
                    "isTime": (this.json.selectType==="datetime" || this.json.selectType==="time"),
                    "timeOnly": (this.json.selectType === "time"),
                    "monthOnly" : (this.json.selectType === "month"),
                    "yearOnly" : (this.json.selectType === "year"),
                    "defaultView" : defaultView,
                    //"target": this.form.node,
                    "target": o2.session.isMobile ? $(document.body) : this.form.app.content,
                    "format": this.json.format,
                    "onComplate": function(formatedDate, date){
                        this.tmpDateString = date.format( this.json.valueFormat || this.json.format );
                        this.validationMode();
                        if(this.validation()){
                            var v = this.getInputData("change");
                            this._setBusinessData(v);
                            this.tmpDateString = null;
                            //this._setEnvironmentData(v);
                        }
                        this.fireEvent("complete");
                    }.bind(this),
                    "onChange": function(formatedDate, date){
                        this.tmpDateString = date ? date.format( this.json.valueFormat || this.json.format ) : "";
                        this._setBusinessData(this.getInputData("change"));
                        this.tmpDateString = null;
                        this.fireEvent("change");
                    }.bind(this),
                    "onClear": function(){
                        this.validationMode();
                        if(this.validation()){
                            this.tmpDateString = "";
                            var v = this.getInputData("change");
                            this._setBusinessData(v);
                            this.tmpDateString = null;
                            //this._setEnvironmentData(v);
                        }
                        this.fireEvent("clear");
                        if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
                    }.bind(this),
                    "onShow": function(){
                        if (_self.descriptionNode) _self.descriptionNode.setStyle("display", "none");

                        if( o2.session.isMobile ){
                            this.container.position({
                                relativeTo: $(document.body),
                                position: 'leftCenter',
                                edge: 'leftCenter'
                                //offset : { y : -25 }
                            });
                        }else{
                            var parent = _self.node.getParent();
                            while( parent ){
                                var overflow = parent.getStyle("overflow");
                                var overflowY = parent.getStyle("overflow-y");
                                if(  overflow === "auto" || overflow === "scroll" || overflowY === "auto" || overflowY === "scroll" ){
                                    _self.scrollFun = function( e ){
                                        // if (this.container.position && (!layout || !layout.userLayout || !layout.userLayout.scale || layout.userLayout.scale===1) ){
                                            if( this.postX === "right" ){
                                                if( this.postY === "bottom" ){
                                                    this.container.position({
                                                        relativeTo: this.node,
                                                        position: 'bottomRight',
                                                        edge: 'upperRight',
                                                        allowNegative : true
                                                    });
                                                }else{
                                                    this.container.position({
                                                        relativeTo: this.node,
                                                        position: 'upperRight',
                                                        edge: 'bottomRight',
                                                        allowNegative : true
                                                    });
                                                }
                                            }else{
                                                if( this.postY === "bottom" ) {
                                                    this.container.position({
                                                        relativeTo: this.node,
                                                        position: 'bottomLeft',
                                                        edge: 'upperLeft',
                                                        allowNegative: true
                                                    });
                                                }else{
                                                    this.container.position({
                                                        relativeTo: this.node,
                                                        position: 'upperLeft',
                                                        edge: 'bottomLeft',
                                                        allowNegative: true
                                                    });
                                                }
                                            }
                                        // }else{
                                        //     var p = this.node.getPosition(this.options.target || null);
                                        //     var size = this.node.getSize();
                                        //     var containerSize = this.container.getSize();
                                        //     var bodySize = (this.options.target) ? this.options.target.getSize() : $(document.body).getSize(); //$(document.body).getSize();
                                        //
                                        //     bodySize.x = bodySize.x * layout.userLayout.scale;
                                        //     bodySize.y = bodySize.y * layout.userLayout.scale;
                                        //
                                        //     var left = p.x;
                                        //     left = left * layout.userLayout.scale;
                                        //     if ((left + containerSize.x + 40) > bodySize.x){
                                        //         left = bodySize.x - containerSize.x - 40;
                                        //     }
                                        //
                                        //     var top = p.y+size.y+2;
                                        //     top = top * layout.userLayout.scale;
                                        //     if( top + containerSize.y > bodySize.y ){
                                        //         top = bodySize.y - containerSize.y ;
                                        //     }
                                        //
                                        //     this.container.setStyle("top", top);
                                        //     this.container.setStyle("left", left);
                                        // }
                                    }.bind(this);
                                    _self.scrollParentNode = parent;
                                    parent.addEvent( "scroll", _self.scrollFun );
                                    parent = null;
                                }else{
                                    parent = parent.getParent();
                                }
                            }
                        }
                        _self.fireEvent("show");
                    },
                    "onHide": function(){
                        if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
                        if( _self.scrollParentNode && _self.scrollFun ){
                            _self.scrollParentNode.removeEvent("scroll", _self.scrollFun);
                        }
                        _self.fireEvent("hide");
                    }.bind(this)
                };
                options.baseDate = this.getBaseDate();

                this.setRange( options );
                /**
                 * @summary 日期弹出选择界面，只读情况下无此成员.
                 * @member {MWF.widget.Calendar}
                 * @example
                 * var calendar = this.form.get("fieldId").calendar; //获取组件
                 * if(calendar)calendar.show(); //弹出选择组件
                 */
                this.calendar = new MWF.widget.Calendar(this.node.getFirst(), options);
                if( this.form.json && this.form.json.canlendarStyle && typeOf( this.form.json.canlendarStyle.zIndex ) !== "null" && typeOf( this.form.json.canlendarStyle.zIndex ) !== "undefined" ){
                    this.calendar.container.setStyle("z-index", this.form.json.canlendarStyle.zIndex );
                }
                this.calendar.show();
            }.bind(this));
        }else{
            var options = {};
            options.baseDate = this.getBaseDate();
            this.calendar.setOptions(options);
            //this.calendar.show();
            this.node.getFirst().focus();
        }
	},
    getBaseDate : function(){
        var d;
        var value = this.getValue(true);
        if( value && value.getTime() > 10000 ){
            d = value;
        }else{
            var ud = Date.parse( this.unformatDate( this.getValueStr() ) );
            if( ud && ud.getTime() > 10000 ){
                d = ud;
            }else{
                d = new Date();
            }
        }
        return d;
    },
    setRange: function( options ){
        var r;
        switch ( this.json.rangeType ) {
            case "dateTime":
                if (this.json.dateTimeRangeScript && this.json.dateTimeRangeScript.code) {
                    r = this.form.Macro.fire(this.json.dateTimeRangeScript.code, this);
                    if (typeOf(r) === "array") options.datetimeRange = r;
                }
                break;
            case "dateAndTime":
                if (this.json.dateRangeScript && this.json.dateRangeScript.code) {
                    r = this.form.Macro.fire(this.json.dateRangeScript.code, this);
                    if (typeOf(r) === "array") options.dateRange = r;
                }
                if (this.json.timeRangeScript && this.json.timeRangeScript.code) {
                    r = this.form.Macro.fire(this.json.timeRangeScript.code, this);
                    if (typeOf(r) === "array") options.timeRange = r;
                }
                break;
            case "other":
                if (this.json.enableDate && this.json.enableDate.code) {
                    options.enableDate = function (date) {
                        var d = this.getPureDate( date );
                        return this.form.Macro.fire(this.json.enableDate.code, this, {date: d});
                    }.bind(this);
                }
                if (this.json.enableHours && this.json.enableHours.code) {
                    options.enableHours = function (date) {
                        var d = this.getPureDate( date );
                        return this.form.Macro.fire(this.json.enableHours.code, this, {date: d});
                    }.bind(this);
                }
                if (this.json.enableMinutes && this.json.enableMinutes.code) {
                    options.enableMinutes = function (date, hour) {
                        var d = this.getPureDate( date );
                        return this.form.Macro.fire(this.json.enableMinutes.code, this, {date: d, hour: hour.toInt()});
                    }.bind(this);
                }
                if (this.json.enableSeconds && this.json.enableSeconds.code) {
                    options.enableSeconds = function (date, hour, minute) {
                        var d = this.getPureDate( date );
                        return this.form.Macro.fire(this.json.enableSeconds.code, this, {date: d, hour: hour.toInt(), minute: minute.toInt()});
                    }.bind(this);
                }
                break;
        }
    },
    toDate: function( value ){
        if( !value )return null;
        switch (typeOf(value)) {
            case "string": return this.isValidDate(value) ? Date.parse(value) : null;
            case "date": return value;
            default: return null;
        }
    },
    isValidDate: function(dateString) {
        if( !dateString ){
            return false;
        }
        var date = new Date(dateString);
        return !isNaN(date.getTime());
    },
    getPureDate: function (date) {
        var d;
        switch (typeOf(date)) {
            case "string": d = Date.parse(date); break;
            case "date": d = date.clone(); break;
            default: return null;
        }
        return d.clearTime();
    },
    unformatDate : function( dateStr ){
        var formatStr = this.json.valueFormat || this.json.format;
        var matchArr = [ "%Y", "%m", "%d", "%H", "%M", "%S", "%z", "%Z" ];
        var lengthArr = [ 4, 2, 2, 2, 2, 2, 5, 3];
        var indexArr = [ formatStr.indexOf("%Y"), formatStr.indexOf("%m"), formatStr.indexOf("%d"), formatStr.indexOf("%H"), formatStr.indexOf("%M"), formatStr.indexOf("%S"), formatStr.indexOf("%z"), formatStr.indexOf("%Z") ];
        var resultArr = [ null, null, null, null, null, null, null, null ];
        for( var i=0; i<matchArr.length; i++ ){
            if( indexArr[i] === -1 )continue;
            var leftLength = 0;
            var leftUnitLength = 0;
            Array.each( indexArr, function( n, k ){
                if( n === -1 )return;
                if( indexArr[i] > n ){
                    leftLength += lengthArr[k];
                    leftUnitLength += matchArr[k].length;
                }
            });
            resultArr[i] = dateStr.substr( indexArr[i] - leftUnitLength + leftLength, lengthArr[i] );
        }
        var now = new Date();
        for( var i=0; i < resultArr.length; i++ ){
            if( !resultArr[i] ){
                switch ( matchArr[i] ){
                    case "%Y":
                    case "%m":
                    case "%d":
                        resultArr[i] = now.format( matchArr[i] );
                        break;
                    case "%H":
                    case "%M":
                    case "%S":
                        resultArr[i] = "00";
                        break;
                    case "%z":
                    case "%Z":
                    default:
                        break;
                }
            }
        }
        return resultArr[0] + "-" + resultArr[1] + "-" + resultArr[2] + " " + resultArr[3]+":"+resultArr[4]+":"+resultArr[5];
    },

    getExcelData: function(){
        return this.getData();
    },
    setExcelData: function(d){
        var value = d.replace(/&#10;/g,""); //换行符&#10;
        this.excelData = value;
        var json = this.json;
        if( value && (new Date(value).isValid()) ){
            var format;
            if (!json.format){
                if (json.selectType==="datetime" || json.selectType==="time"){
                    format = (json.selectType === "time") ? "%H:%M" : (Locale.get("Date").shortDate + " " + "%H:%M")
                }else{
                    format = Locale.get("Date").shortDate;
                }
            }else{
                format = json.format;
            }
            value = Date.parse( value ).format( format );
            this.setData(value, true);
        }else{
            this.setData(value, true);
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Selector", null, false);
MWF.require("MWF.widget.UUID", null, false);
/** @class Calendar 多选按钮组件。
 * @o2cn 多选按钮
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 * @extends MWF.xApplication.process.Xform.$Selector
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Checkbox = MWF.APPCheckbox =  new Class(
    /** @lends MWF.xApplication.process.Xform.Checkbox# */
    {
        Implements: [Events],
        Extends: MWF.APP$Selector,
        /**
         * 组件加载后触发。如果选项加载为异步，则异步处理完成后触发此事件
         * @event MWF.xApplication.process.Xform.Checkbox#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 值改变时触发。可以通过this.event获取修改后的选择项（Dom对象）。
         * @event MWF.xApplication.process.Xform.Checkbox#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        loadDescription: function(){},
        _loadNode: function(){
            if (!this.isReadable && !!this.isHideUnreadable){
                this.node.setStyle('display', 'none');
            }else{
                if (this.isReadonly()){
                    this._loadNodeRead();
                }else{
                    this._loadNodeEdit();
                }
            }
        },
        _loadMergeReadContentNode: function( contentNode, data ){
            this._showValue(contentNode, data.data)
        },
        _loadMergeEditNodeByDefault: function(){
            var data = this.getSortedSectionData();
            var businessData = [];
            data.each(function(d){
                businessData = businessData.concat( d.data || [] );
            });
            this._setBusinessData( businessData );
            this._loadNode();
        },
        _loadNodeRead: function(){
            this.node.empty();
            this.node.set({
                "nodeId": this.json.id,
                "MWFType": this.json.type
            });
            var value = this.getValue();
            this._showValue(this.node, value)
        },
        __showValue: function(node, value, optionItems){
            if( !value )return;
            var texts = [];
            optionItems.each(function(item){
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                if (value.indexOf(v)!=-1){
                    texts.push(t);
                }
            });
            if( !this.isNumber(this.json.countPerline) ) {
                if( this.json.newline ){
                    texts.each(function(t){
                        new Element("div", { "text": t }).inject(node)
                    }.bind(this))
                }else{
                    node.set("text", texts.join(", "));
                }
            }else{
                var div;
                var countPerLine = this.json.countPerline.toInt();
                if( countPerLine === 0 ){
                    div = new Element("div", {"style":"display:inline-block;"}).inject( node );
                    div.set("text", texts.join(", "));
                }else{
                    var textsPerLine = [];
                    texts.each(function(t, i){
                        if( i % countPerLine === 0){ //如果需要换行了
                            if( div && textsPerLine.length )div.set("text", textsPerLine.join(",") +",");
                            textsPerLine = [];
                            div = new Element("div").inject( node );
                        }
                        textsPerLine.push( t );
                    }.bind(this));
                    if( div && textsPerLine.length )div.set("text", textsPerLine.join(","));
                }
            }
        },
        _resetNodeEdit: function(){
            var div = new Element("div");
            div.set(this.json.properties);
            div.inject(this.node, "after");

            this.node.destroy();
            this.node = div;
        },
        _loadNodeEdit: function(){
            //this.container = new Element("select");
            if (!this.json.preprocessing) this._resetNodeEdit();
            this.node.set({
                "id": this.json.id,
                "MWFType": this.json.type,
                "styles": {
                    "display": "inline"
                }
            });
            if( this.json.newline )this.node.setStyle("display", "block");
            this.setOptions();
        },
        _loadDomEvents: function(){
        },
        _loadEvents: function(){
            Object.each(this.json.events, function(e, key){
                if (e.code){
                    if (this.options.moduleEvents.indexOf(key)!=-1){
                        this.addEvent(key, function(event){
                            return this.form.Macro.fire(e.code, this, event);
                        }.bind(this));
                    }else{
                        //this.node.addEvent(key, function(event){
                        //    return this.form.Macro.fire(e.code, this, event);
                        //}.bind(this));
                    }
                }
            }.bind(this));
        },
        addModuleEvent: function(key, fun){
            if (this.options.moduleEvents.indexOf(key)!==-1){
                this.addEvent(key, function(event){
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            }else{
                var inputs = this.node.getElements("input");
                inputs.each(function(input){
                    input.addEvent(key, function(event){
                        return (fun) ? fun(this, event) : null;
                    }.bind(this));
                }.bind(this));
            }
        },

        isNumber : function( d ){
            return parseInt(d).toString() !== "NaN";
        },
        _setOptions: function(optionItems){
            var p = o2.promiseAll(optionItems).then(function(radioValues){
                this.moduleSelectAG = null;
                if (!radioValues) radioValues = [];
                var node;
                if (o2.typeOf(radioValues)==="array"){
                    var flag = (new MWF.widget.UUID).toString();
                    radioValues.each(function(item, i){
                        var tmps = item.split("|");
                        var text = tmps[0];
                        var value = tmps[1] || text;

                        if( !this.isNumber(this.json.countPerline) ) {
                            if( this.json.newline ){
                                node = new Element("div").inject(this.node);
                            }else{
                                node = this.node;
                            }
                        }else{
                            var countPerLine = this.json.countPerline.toInt();
                            if( countPerLine === 0 ){
                                if(i===0)node = new Element("div", {"style":"display:inline-block;"}).inject(this.node);
                            }else if( i % countPerLine === 0){
                                node = new Element("div").inject(this.node);
                            }
                        }

                        var radio = new Element("input", {
                            "type": "checkbox",
                            "name": ((this.json.properties) ? this.json.properties.name : null) || flag+this.json.id,
                            "value": value,
                            "showText": text,
                            "styles": this.json.buttonStyles
                        }).inject(node);
                        //radio.appendText(text, "after");

                        var textNode = new Element( "span", {
                            "text" : text,
                            "styles" : { "cursor" : "default" }
                        }).inject(node);
                        textNode.addEvent("click", function( ev ){
                            if( this.radio.get("disabled") === true || this.radio.get("disabled") === "true" )return;
                            this.radio.checked = ! this.radio.checked;
                            this.radio.fireEvent("change", [this.radio]);
                            this.radio.fireEvent("click");
                        }.bind( {radio : radio} ) );

                        radio.addEvent("click", function(){
                            this.validationMode();
                            if (this.validation()) {
                                var v = this.getInputData("change");
                                this._setBusinessData(v || []);
                                //this._setEnvironmentData(v || []);
                                //this._setBusinessData(this.getInputData("change") || []);
                                this.fireEvent("change", [radio]);
                            }
                        }.bind(this));

                        Object.each(this.json.events, function(e, key){
                            if (e.code){
                                if (this.options.moduleEvents.indexOf(key)!=-1){
                                }else{
                                    radio.addEvent(key, function(event){
                                        return this.form.Macro.fire(e.code, this, event);
                                    }.bind(this));
                                }
                            }
                        }.bind(this));

                    }.bind(this));
                }
            }.bind(this), function(){});
            this.moduleSelectAG = p;
            if (p) p.then(function(){
                this.moduleSelectAG = null;
            }.bind(this), function(){
                this.moduleSelectAG = null;
            }.bind(this));
        },

        _setValue: function(value, m, fireChange){
            var mothed = m || "__setValue";
            if (!!value){
                var p = o2.promiseAll(value).then(function(v){
                    //if (o2.typeOf(v)=="array") v = v[0];
                    if (this.moduleSelectAG){
                        this.moduleValueAG = this.moduleSelectAG;
                        this.moduleSelectAG.then(function(){
                            this[mothed](v, fireChange);
                            return v;
                        }.bind(this), function(){});
                    }else{
                        this[mothed](v, fireChange)
                    }
                    return v;
                }.bind(this), function(){});
                this.moduleValueAG = p;
                if (this.moduleValueAG) this.moduleValueAG.then(function(){
                    this.moduleValueAG = null;
                }.bind(this), function(){
                    this.moduleValueAG = null;
                }.bind(this));
            }else{
                this[mothed](value, fireChange);
            }


            // this.moduleValueAG = o2.AG.all(value).then(function(v){
            //     if (this.moduleSelectAG){
            //         this.moduleValueAG = this.moduleSelectAG;
            //         this.moduleSelectAG.then(function(){
            //             this.moduleValueAG = null;
            //             this.__setValue(v);
            //         }.bind(this));
            //     }else{
            //         this.moduleValueAG = null;
            //         this.__setValue(v);
            //     }
            //     return v;
            // }.bind(this));
            //
            // if (this.moduleValueAG) this.moduleValueAG.then(function(){
            //     this.moduleValueAG = "";
            // }.bind(this));
        },

        __setValue: function(value){
            this.moduleValueAG = null;
            this._setBusinessData(value);
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                var radios = this.node.getElements("input");
                for (var i=0; i<radios.length; i++){
                    var radio = radios[i];
                    radio.checked = value.indexOf(radio.value) != -1;
                }
            }
            this.fieldModuleLoaded = true;
        },

        _getInputTextData: function(){
            var inputs = this.node.getElements("input");
            var value = [];
            var text = [];
            if (inputs.length){
                inputs.each(function(input){
                    if (input.checked){
                        var v = input.get("value");
                        var t = input.get("showText");
                        value.push(v || "");
                        text.push(t || v || "");
                    }
                });
            }
            if (!value.length) value = [""];
            if (!text.length) text = [""];
            return {"value": value, "text": text};
        },
        /**
         * @summary 获取选中项的text，如果未选中返回空数组。
         * @return {Array} 返回选中项的text数组
         * @example
         * var array = this.form.get('fieldId').getText(); //获取选中项的数组
         */
        getText: function(){
            var texts = this.getTextData().text;
            if( texts && texts.length === 1 ){
                return texts[0] ? texts : [];
            }else{
                return (texts && texts.length) ? texts : [];
            }
        },
        //getData: function(){
        //var inputs = this.node.getElements("input");
        //var value = [];
        //if (inputs.length){
        //	inputs.each(function(input){
        //		if (input.checked){
        //			var v = input.get("value");
        //			if (v) value.push(v || "");
        //		}
        //	});
        //}
        //return (value.length==1) ? value[0] : value;
        //},
        isEmpty: function(){
            var data = this.getData();
            if( typeOf(data) !== "array" )return true;
            if( data.length === 0 )return true;
            return false;
        },
        getInputData: function(){
            if (this.isReadonly()){
                return this._getBusinessData();
            }else{
                var inputs = this.node.getElements("input");
                var value = [];
                if (inputs.length){
                    inputs.each(function(input){
                        if (input.checked){
                            var v = input.get("value");
                            value.push(v || "");
                        }
                    });
                }
                return (value.length) ? value : [];
            }
        },
        resetData: function(){
            this.setData(this.getValue());
        },
        /**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}
         * @summary 为字段赋值，并且使值对应的选项选中。
         *  @param data{String|Promise} .
         *  @param fireChange{boolean} 可选，是否触发change事件，默认false.
         *  @example
         *  this.form.get("fieldId").setData("test"); //赋文本值
         *  @example
         *  //使用Promise
         *  var field = this.form.get("fieldId");
         *  var dict = new this.Dict("test"); //test为数据字典名称
         *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
         *  field.setData( promise );
         */
        setData: function(data, fireChange){
            return this._setValue(data, "__setData", fireChange);
            // if (data && data.isAG){
            //     this.moduleValueAG = data;
            //     data.addResolve(function(v){
            //         this.setData(v);
            //     }.bind(this));
            // }else{
            //     this.__setData(data);
            //     this.moduleValueAG = null;
            // }
        },

        __setData: function(data, fireChange){
            this.moduleValueAG = null;
            var old = this.getInputData();
            this._setBusinessData(data);

            var inputs = this.node.getElements("input");
            if (inputs.length){
                inputs.each(function(input){
                    if (typeOf(data)=="array"){
                        if (data.indexOf(input.get("value"))!=-1){
                            input.set("checked", true);
                        }else{
                            input.set("checked", false);
                        }
                    }else{
                        if (data == input.get("value")){
                            input.set("checked", true);
                        }else{
                            input.set("checked", false);
                        }
                    }
                });
                this.validationMode();
            }
            this.fieldModuleLoaded = true;
            this.fireEvent("setData");
            if (fireChange && old!==data) this.fireEvent("change");
        },

        notValidationMode: function(text){
            if (!this.isNotValidationMode){
                this.isNotValidationMode = true;
                this.node.store("background", this.node.getStyles("background"));
                this.node.setStyle("background", "#ffdcdc");

                this.errNode = this.createErrorNode(text);
                if (this.iconNode){
                    this.errNode.inject(this.iconNode, "after");
                }else{
                    this.errNode.inject(this.node, "after");
                }
                this.showNotValidationMode(this.node);

                if (!this.errNode.isIntoView()) this.errNode.scrollIntoView(false);
            }
        },
        validationMode: function(){
            if (this.isNotValidationMode){
                this.isNotValidationMode = false;
                this.node.setStyles(this.node.retrieve("background"));
                if (this.errNode){
                    this.errNode.destroy();
                    this.errNode = null;
                }
            }
        },
        validationConfigItem: function(routeName, data){
            var flag = (data.status==="all") ? true: (routeName === data.decision);
            if (flag){
                var n = this.getInputData();
                if( typeOf(n)==="array" && n.length === 0 )n = "";
                var v = (data.valueType==="value") ? n : n.length;
                switch (data.operateor){
                    case "isnull":
                        if (!v){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notnull":
                        if (v){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "gt":
                        if (v>data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "lt":
                        if (v<data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "equal":
                        if (v==data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "neq":
                        if (v!=data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "contain":
                        if (v.indexOf(data.value)!=-1){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notcontain":
                        if (v.indexOf(data.value)==-1){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                }
            }
            return true;
        },


        getExcelData: function( type ){
            var value = this.getData();
		    if( type === "value" )return value;

            var options = this.getOptionsObj();
            return Promise.resolve(options).then(function (opts) {
                value = o2.typeOf(value) === "array" ? value : [value];
                var arr = [];
                value.each( function( a, i ){
                    var idx = options.valueList.indexOf( a );
                    arr.push( idx > -1 ? options.textList[ idx ] : "") ;
                });
                return arr.join(", ");
            });
        },
        setExcelData: function(d, type){
            var arr = this.stringToArray(d);
            this.excelData = arr;
            if( type === "value" ){
                this.setData(arr, true);
            }else{
                var options = this.getOptionsObj();
                this.moduleExcelAG = Promise.resolve(options).then(function (opts) {
                    arr.each( function( a, i ){
                        var idx = opts.textList.indexOf( a );
                        arr[ i ] = idx > -1 ? opts.valueList[ idx ] : null;
                    });
                    arr.clean();
                    var value = arr.length === 1  ? arr[0] : arr;
                    this.setData(value, true);
                    this.moduleExcelAG = null;
                }.bind(this));
            }
        },
        validationConfigItemExcel: function(data){
            if (data.status==="all"){
                var n = this.getInputData();
                if( typeOf(n)==="array" && n.length === 0 )n = "";

                var ed = typeOf( this.excelData ) === "null" ? [] : this.excelData;
                if( typeOf(ed)==="array" && ed.length === 0 )ed = "";

                var v, ev;
                if(data.valueType==="value"){
                    v = n;
                    ev = ed;
                }else{
                    v = n.length;
                    ev = ed.length || 0;
                }
                switch (data.operateor){
                    case "isnull":
                        if (!v)return !ev ? data.prompt : "不在选项中";
                        break;
                    case "notnull":
                        if (v)return data.prompt;
                        break;
                    case "gt":
                        if (v>data.value)return data.prompt;
                        break;
                    case "lt":
                        if (v<data.value)return data.prompt;
                        break;
                    case "equal":
                        if (v==data.value)return data.prompt;
                        break;
                    case "neq":
                        if (v!=data.value)return data.prompt;
                        break;
                    case "contain":
                        if (v.indexOf(data.value)!=-1)return data.prompt;
                        break;
                    case "notcontain":
                        if (v.indexOf(data.value)==-1)return data.prompt;
                        break;
                }
            }
            return true;
        }

    });

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xApplication.process.Xform.Codeeditor = MWF.APPCodeeditor =  new Class({
    Extends: MWF.APP$Module,
    options: {
        "moduleEvents": ["save", "change", "blur", "postLoadEditor", "destroy", "queryLoad", "load", "postLoad", "afterLoad", "maxSize", "returnSize"]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
    },
    load: function(){
        this._loadModuleEvents();
        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
            this._loadStyles();
            this._afterLoaded();
            this.fireEvent("postLoad");
            this.fireEvent("load");
        }
    },


    _loadUserInterface: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this.node.empty();
            if (this.isReadonly() || !this.isEditable){
                var value = this._getBusinessData();
                this.highlighting(value);
                this.node.setStyles({
                    "padding": "0.5em 0.6em",
                    "background-color": "#f7f7f7",
                    "overflow": "auto",
                    "font-size": "0.875em",
                    "border-radius": "var(--oo-default-radius)"
                })
            }else{
                this.loadCodeeditor();
            }
        }
    },
    highlighting: function(value){
        var contentType = this.json.mode ? 'text/'+this.json.mode : 'text/javascript';
        this.preNode = new Element('pre').inject(this.node);
        this.preNode.set('data-lang', contentType);
        this.preNode.set('text', value || ' ');

        o2.require("o2.widget.monaco", function(){
            o2.widget.monaco.load(function(){
                monaco.editor.colorizeElement(this.preNode, {});
            }.bind(this));
        }.bind(this));
    },
    loadCodeeditor: function(){
        MWF.require("MWF.widget.ScriptArea", function(){
            this.editor = new MWF.widget.ScriptArea(this.node, {
                "title": this.json.title || "",
                "isbind": false,
                "mode": this.json.mode || "javascript",
                "maxObj": this.form.node,
                "maxPosition": "absolute",
                "onChange": function(){
                    this._setBusinessData(this.getData());
                    this.fireEvent('change');
                }.bind(this),
                "onSave": function(){
                    this._setBusinessData(this.getData());
                    this.fireEvent('save');
                }.bind(this),

                "onQueryLoad": function(){
                    this.fireEvent('queryLoad');
                }.bind(this),
                "onPostLoad": function(){
                    this.fireEvent('postLoad');
                    this.fireEvent('load');
                    this.fireEvent('afterLoad');

                }.bind(this),
                "onMaxSize": function(){
                    this.fireEvent('maxSize');
                }.bind(this),
                "onReturnSize": function(){
                    this.fireEvent('returnSize');
                }.bind(this),
                "onBlur": function(){
                    this.fireEvent('blur');
                }.bind(this),
                "onPostLoadEditor": function(){
                    this.fireEvent('postLoadEditor');
                }.bind(this),
                "onDestroy": function(){
                    this.fireEvent('destroy');
                }.bind(this),
                "style": this.json.style || "v10"
            });
            this.editor.load({code: this._getBusinessData()});
        }.bind(this));
    },


    _loadEvents: function(editorConfig){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                this.editor.on(key, function(event){
                    return this.form.Macro.fire(e.code, this, event);
                }.bind(this), this);
            }
        }.bind(this));

    },

    _loadValue: function(){
        var data = this._getBusinessData();
    },

    resetData: function(){
        this.setData(this._getBusinessData());
    },

    isEmpty : function(){
        return !this.getData().trim();
    },

    getData: function(){
        return this.editor ? this.editor.getData() : this._getBusinessData();
    },

    setData: function(data){
        this._setBusinessData(data);
        if (this.editor) this.editor.setData(data);
    },
    destroy: function(){
        if( this.editor )this.editor.destroy();
    },

    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
            if (!this.errNode.isIntoView()) this.errNode.scrollIntoView(false);
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            if (p.get("MWFtype") == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },

    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    validation: function(routeName, opinion){
        if (!this.validationConfig(routeName, opinion))  return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;

        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";

        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString()!="true"){
            this.notValidationMode(flag);
            return false;
        }
        return true;
    }
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Common 通用组件。
 * @o2cn 通用组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var el = this.form.get("name"); //获取组件
 * //方法2
 * var el = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Common = MWF.APPCommon =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        if (this.json.innerHTML){
            // var nodes = this.node.childNodes;
            // for (var i=0; i<nodes.length; i++){
            //     if (nodes[i].nodeType===Node.ELEMENT_NODE){
            //         if (!nodes[i].get("MWFtype")){
            //             nodes[i].destroy();
            //             i--;
            //         }
            //     }else{
            //         if (nodes[i].removeNode){
            //             nodes[i].removeNode();
            //         }else{
            //             nodes[i].parentNode.removeChild(nodes[i]);
            //         }
            //         i--;
            //         //nodes[i]
            //     }
            // }
            // this.node.appendHTML(this.json.innerHTML);

            this.node.innerHTML = this.json.innerHTML;

            // if (this.node.get("html") !== this.json.innerHTML){
            //this.node.appendHTML(this.json.innerHTML);
            // }
        }
        this.node.setProperties(this.json.properties);
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEventListener(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
});
MWF.xDesktop.requireApp("process.Xform", "Number", null, false);
/** @class Currency 货币输入组件。
 * @o2cn 货币输入组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("name"); //获取组件
 * //方法2
 * var field = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.Number
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Currency = MWF.APPCurrency =  new Class({
    Implements: [Events],
    Extends: MWF.APPNumber,
    iconStyle: "currencyIcon",
    _loadMergeAmountReadNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        this.node.set("text", this.formatNumber(total.toString()));
        this.loadSymboleRead();
    },
    _loadMergeAverageReadNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        var average = total.div(  new Decimal(Object.keys(data).length) );
        this.node.set("text", this.formatNumber(average.toString()));
        this.loadSymboleRead();
    },
    _resetNodeEdit: function(){
        var input = new Element("input", {
            "styles": {
                "background": "transparent",
                "width": "100%",
                "border": "0px"
            }
        });
        input.setStyles( this.json.recoveryInputStyles || {} );

        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "padding-right": "4px"
            }}).inject(this.node, "after");
        node.setStyles( this.json.recoveryStyles || {} );
        input.inject(node);

        if( this.json.currencySymbol ){
            var symbole = new Element("span.MWFCurrencySymbol", {
                text: this.json.currencySymbol
            });

            symbole.inject( node.offsetParent !== null ? node : this.form.node );

            symbole.setStyles( this.json.symbolStyles || {} );

            var paddingLeft = symbole.getSize().x + 5;
            var inputPadding = input.getStyle("padding-right");
            var width = paddingLeft;
            if( this.isNumber( inputPadding ) ){
                width = width + parseFloat(inputPadding);
            }
            input.setStyles({
                "padding-left": paddingLeft + "px",
                "width": "calc( 100% - " + width +"px )"
            });

            if( node.offsetParent === null )symbole.inject( node );

            symbole.setStyles({
                "top": "0px",
                "left": "0px",
                "position": "absolute"
            });
        }

        this.node.destroy();
        this.node = node;
    },

    _loadNodeEdit: function(){
        //if (!this.json.preprocessing) this._resetNodeEdit();
        this._resetNodeEdit();
        var input = this.node.getFirst();
        if( !input && this.nodeHtml ){
            this.node.set("html", this.nodeHtml);
            input = this.node.getFirst();
        }
        input.set(this.json.properties);

        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle]
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        input = this.node.getElement('input');
        input.addEvent("change", function(){
            this.validationMode();
            if (this.validation()) {
                var value = this.getInputData("change");
                this._setBusinessData(value);
                input.set("value", this.formatNumber( value.toString() ));
                this.fireEvent("change");
            }
        }.bind(this));

        input.addEvent("blur", function(){
            this.validation();
        }.bind(this));
        input.addEvent("keyup", function(){
            this.validationMode();
        }.bind(this));
    },
    __setData: function(data, fireChange){
        var old = this.getInputData();
        this._setBusinessData(data);
        var input = this.node.getElement('input');
        if (input){
            input.set("value", this.formatNumber(data));
            this.checkDescription();
            this.validationMode();
        }else{
            this.node.set("text", this.formatNumber(data));
            this.loadSymboleRead();
        }
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function(value){
        var v = typeOf( value ) === "string" ? this.unformatNumber( value ) : value;
        v = this.isNumber( v ) ? parseFloat( v ) : v;
        this._setBusinessData(v);
        var val = value;
        if( this.json.emptyValue === "string" ){
            if( typeOf(v)==="null" )val = "";
            if( v === 0 )val = "0";
        }else{
            if( v === 0 || v === "" || typeOf(v)==="null" )val = "0";
        }
        if (this.node.getFirst()) this.node.getFirst().set("value", value || val);
        if (this.isReadonly()) {
            if (this.isReadable){
                this.node.set("text", value || val);
            }else{
                this.node.set("text", '');
            }
            // this.node.set("text", value || val);
            this.loadSymboleRead()
        }
        this.moduleValueAG = null;
        this.fieldModuleLoaded = true;
        return value;
    },
    loadSymboleRead: function () {
        var symbole = new Element("span.MWFCurrencySymbol", {
            text: this.json.currencySymbol,
            styles: this.json.symbolStyles || {}
        }).inject(this.node, "top");
        var paddingRight = symbole.getStyle("padding-right");
        if( typeOf(paddingRight) === "string" && parseInt(paddingRight) === 0 ){
            symbole.setStyle("padding-right", "5px");
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xDesktop.requireApp("process.Xform", "DatagridPC", null, false);
MWF.xDesktop.requireApp("process.Xform", "DatagridMobile", null, false);
//if (COMMON.Browser.Platform.isMobile){
if (layout.mobile || COMMON.Browser.Platform.isMobile){
    MWF.xApplication.process.Xform.Datagrid = MWF.APPDatagrid = MWF.xApplication.process.Xform.DatagridMobile;
    MWF.xApplication.process.Xform.Datagrid$Title = MWF.APPDatagrid$Title = MWF.xApplication.process.Xform.DatagridMobile$Title;
    MWF.xApplication.process.Xform.Datagrid$Data = MWF.APPDatagrid$Data = MWF.xApplication.process.Xform.DatagridMobile$Data;
}else{
    MWF.xApplication.process.Xform.Datagrid = MWF.APPDatagrid = MWF.xApplication.process.Xform.DatagridPC;
    MWF.xApplication.process.Xform.Datagrid$Title = MWF.APPDatagrid$Title = MWF.xApplication.process.Xform.DatagridPC$Title;
    MWF.xApplication.process.Xform.Datagrid$Data = MWF.APPDatagrid$Data = MWF.xApplication.process.Xform.DatagridPC$Data;
}

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xDesktop.requireApp("process.Xform", "DatatablePC", null, false);
MWF.xDesktop.requireApp("process.Xform", "DatatableMobile", null, false);
MWF.xDesktop.requireApp("process.Xform", "DatatableV10", null, false);
//if (COMMON.Browser.Platform.isMobile){

if ((layout.mobile || COMMON.Browser.Platform.isMobile) && (o2.version["dev"] && o2.version["dev"]>=10)){
    MWF.xApplication.process.Xform.Datatable = MWF.APPDatatable = MWF.xApplication.process.Xform.DatatableV10;
    MWF.xApplication.process.Xform.Datatable$Title = MWF.APPDatatable$Title = MWF.xApplication.process.Xform.DatatablePC$Title;
    MWF.xApplication.process.Xform.Datatable$Data = MWF.APPDatatable$Data = MWF.xApplication.process.Xform.DatatablePC$Data;
}else if ((layout.mobile || COMMON.Browser.Platform.isMobile)){
    MWF.xApplication.process.Xform.Datatable = MWF.APPDatatable = MWF.xApplication.process.Xform.DatatableMobile;
    MWF.xApplication.process.Xform.Datatable$Title = MWF.APPDatatable$Title = MWF.xApplication.process.Xform.DatatableMobile$Title;
    MWF.xApplication.process.Xform.Datatable$Data = MWF.APPDatatable$Data = MWF.xApplication.process.Xform.DatatableMobile$Data;
}else{
    MWF.xApplication.process.Xform.Datatable = MWF.APPDatatable = MWF.xApplication.process.Xform.DatatablePC;
    MWF.xApplication.process.Xform.Datatable$Title = MWF.APPDatatable$Title = MWF.xApplication.process.Xform.DatatablePC$Title;
    MWF.xApplication.process.Xform.Datatable$Data = MWF.APPDatatable$Data = MWF.xApplication.process.Xform.DatatablePC$Data;
}

MWF.xDesktop.requireApp('process.Xform', 'DatatablePC', null, false);
MWF.xApplication.process.Xform.DatatableV10 = new Class({
    Implements: [Events],
    Extends: MWF.xApplication.process.Xform.DatatablePC,
    isEdit: false,
    options: {
        moduleEvents: [
            'queryLoad',
            'postLoad',
            'load',
            'afterLoad',
            'beforeLoadLine',
            'afterLoadLine',
            'change',
            'addLine',
            'deleteLine',
            'afterDeleteLine',
            'editLine',
            'completeLineEdit',
            'cancelLineEdit',
            'beforeExport',
            'export',
            'beforeImport',
            'import',
            'validImport',
            'afterImport',
        ],
    },

    //在load方法最后执行
    _afterLoaded: function () {
        //兼容移动端
        // if (!this.mobileEditable) this.node.addClass('datatable_readonly');
        // if (this.datatableMode === 'mobile_default' && this.mobileEditable) {
        // const buttonNode = new Element('oo-button.datatable_edit_button', {
        //     text: MWF.xApplication.process.Xform.LP.editDatatable,
        //     type: 'light',
        //     'left-icon': 'edit',
        // });
        // this.node.insertAdjacentElement('afterend', buttonNode);

        this.node.addEventListener('click', () => {
            if (this.datatableMode === 'mobile_default') {
                this.datatableMode = 'mobile_edit';

                // const size = document.body.getSize();
                const s = this.node.getSize();
                const p = this.node.getPosition();

                this.placeholderNode = new Element('div', {
                    styles: {
                        width: s.x + 'px',
                        height: s.y + 'px',
                    },
                }).inject(this.node, 'before');

                document.body.appendChild(this.node);

                this.node.setStyles({
                    width: s.x + 'px',
                    height: s.y + 'px',
                    top: p.y + 'px',
                    left: p.x + 'px',
                    position: 'absolute',
                    'overflow-x': 'auto',
                    'overflow-y': 'hidden',
                    'z-index': 201,
                    transition: 'width 0.2s, height 0.2s, top 0.2s, left 0.2s',
                });

                window.setTimeout(() => {
                    this.node.addClass('datatable_edit_mode');
                    this.reload();
                    this.node.setStyles({
                        width: '100%',
                        height: '100%',
                        top: 0,
                        left: 0,
                    });
                    window.setTimeout(() => {
                        this.node.setStyles({
                            'overflow-y': 'auto',
                        });
                    });
                });
            }
        });

        //编辑完成后的处理
        this.addEvent("completeLineEdit", (line)=>{
            const ths = this._getHeadThs();
            this._checkMobileTr(line.node, ths);
        });

        //插入行后处理
        this.addEvent("addLine",(o)=>{
            const ths = this._getHeadThs();
            this._checkMobileTr(o.line.node, ths);
            o.line.node.scrollIntoView({behavior: 'smooth'});
        });
        this.addEvent("editLine",(line)=>{
            const ths = this._getHeadThs();
            this._checkMobileTr(line.node, ths);
        });
        this.addEvent("cancelLineEdit",(line)=>{
            const ths = this._getHeadThs();
            this._checkMobileTr(line.node, ths);
        });
        this.addEvent("change",(o)=>{
            if (o.type==='move'){
                o.line.node.scrollIntoView({behavior: 'smooth'});
                o.line.node.addClass('mwf_move_line');
                window.setTimeout(() => {
                    o.line.node.removeClass('mwf_move_line');
                }, 100);
            }
        })
        
        //验证后处理
        this.addEvent("validationLine",(line, flag)=>{
            if (!flag) {
                if (!line.node.isIntoView()) line.node.scrollIntoView({behavior: 'smooth'});
            }
        });
        
    },


    _loadMobileTitle: function () {
        this.mobileTitleNode = new Element('div.mwf_datatable_mobile_title');
        this.node.insertAdjacentElement('afterbegin', this.mobileTitleNode);
        this.mobileTitleNode.textContent = this.json.name || MWF.xApplication.process.Xform.LP.datatableTitle;
    },
    _getHeadThs: function(){
        const trs = this.tBody.querySelectorAll('tr');
        return trs[0].querySelectorAll('th');
    },
    _checkMobileTr: function(tr, ths){
        const tds = tr.querySelectorAll('td');
        const isTotal = tr.hasClass('mwf_totaltr');

        for (let n = 0; n < tds.length; n++) {
            if (tds[n].hasClass('mwf_sequence') || ths[n].hasClass('mwf_sequence')){
                ths[n].addClass('mwf_sequence');
                tds[n].addClass('mwf_sequence');
                if (isTotal){
                    tds[n].setStyle('display', 'none');
                }
                // tds[n].setStyle('display', 'absolute');
            }else if (ths[n].hasClass('mwf_addlineaction')) {
                tds[n].addClass('mwf_editaction');
                tds[n].setStyle('grid-column', '1 / -1');
            } else if (ths[n].hasClass('mwf_moveaction')) {
                tds[n].addClass('mwf_moveaction');
                const icon = tds[n].querySelector('div');
                if (icon){
                    icon.textContent = '';
                    icon.addClass('ooicon-up');
                }
            } else {
                const tNode = ths[n].cloneNode(true);
                tNode.addClass('mwf_mobile_edit_th');
                tds[n].insertAdjacentElement('beforebegin', tNode);
                tds[n].addClass('mwf_origional');
            }
        }
    }, 
    
    _loadMobileActionNode: function(){
        //添加操作按钮
        const actionNode = new Element('div.mwf_mobile_actions');
        this.node.appendChild(actionNode);
        actionNode.addEventListener('click', (e)=>{
            e.stopPropagation();
        });
        this.mobileActionNode = actionNode;
    },
    _loadMobileAddAction: function(){
        //添加新增条目按钮
        if (this.addable){
            const addAction = new Element('oo-button.mwf_mobile_addAction', {type: 'light'});
            addAction.setAttribute('text', MWF.xApplication.process.Xform.LP.addLine);
            this.mobileActionNode.appendChild(addAction);
            addAction.addEventListener('click', (e) => {
                const line = this.addLine();
                e.stopPropagation();
            });
        }
    },
    _loadMobileOkAction: function(){
        //添加编辑完成按钮
        const okAction = new Element('oo-button.mwf_mobile_okAction');
        okAction.setAttribute('text', MWF.xApplication.process.Xform.LP.editOk);
        this.mobileActionNode.appendChild(okAction);
        okAction.addEventListener('click', (e) => {
            e.stopPropagation();
            const s = this.placeholderNode.getSize();
            const p = this.placeholderNode.getPosition();

            this.node.setStyles({
                width: s.x + 'px',
                height: s.y + 'px',
                top: p.y + 'px',
                left: p.x + 'px',
                'overflow-x': 'auto',
                'overflow-y': 'hidden',
                transition: 'width 0.2s, height 0.2s, top 0.2s, left 0.2s',
            });

            this.mobileTitleNode.destroy();
            this.node.removeClass('datatable_edit_mode');
            this.reload();

            window.setTimeout(() => {
                this.placeholderNode.insertAdjacentElement('beforebegin', this.node);
                this.placeholderNode.destroy();
                this.node.setStyles({
                    height: 'unset',
                    position: 'static',
                    'overflow-y': 'auto',
                });
                this.datatableMode = 'mobile_default';
            }, 200);
        });
    },

    loadDatatable: function () {
        if (o2.isMediaMobile()) {
            //移动端模式，默认表格显示模式，不进行编辑，没有多行编辑等
            if (!this.node.hasClass('datatable_edit_mode')) {
                //移动端默认模式
                this.mobileMultiEditMode = this.multiEditMode;
                this.mobileEditable = this.editable;
                this.multiEditMode = false;
                this.editable = false;
                this.datatableMode = 'mobile_default';
                this._loadDefaultDatatable();
            } else {
                //移动端编辑模式
                this.datatableMode = 'mobile_edit';
                this.multiEditMode = this.mobileMultiEditMode;
                this.editable = this.mobileEditable;

                this._loadDefaultDatatable(() => {
                    //修改dom结构
                    //创建标题栏
                    this._loadMobileTitle();

                    const trs = this.tBody.querySelectorAll('tr');
                    const ths = trs[0].querySelectorAll('th');

                    for (let i = 1; i < trs.length; i++) {
                        this._checkMobileTr(trs[i], ths);
                    }

                    this._loadMobileActionNode();
                    this._loadMobileAddAction();
                    this._loadMobileOkAction();
                });
            }
        } else {
            //PC端模式
            this.datatableMode = 'pc';
            this._loadDefaultDatatable();
        }
    },

    _loadDefaultDatatable: function (cb) {
        this.loading = true;
        this._loadStyles();

        this._loadTitleTr();
        this._loadTemplate();
        this._loadTotalTr();

        this.fireEvent('load');
        this._loadDatatable(
            function () {
                this._loadImportExportAction();
                this.fieldModuleLoaded = true;
                this.loading = false;
                this.fireEvent('postLoad');

                if (cb) cb();
            }.bind(this),
        );
    },
    _removeEl: function () {
        var node;
        if (this.titleTr) {
            node = this.titleTr.getElement('th.mwf_addlineaction');
            if (node) node.destroy();
            node = this.titleTr.getElement('th.mwf_moveaction');
            if (node) node.destroy();
        }
        if (this.templateTr) {
            node = this.templateTr.getElement('td.mwf_editaction');
            if (node) node.destroy();
            node = this.templateTr.getElement('td.mwf_moveaction');
            if (node) node.destroy();
        }
        if (this.totalTr) {
            this.totalTr.destroy();
            this.totalTr = null;
        }
        if (this.exportActionNode) {
            this.exportActionNode.destroy();
            this.totalTr = null;
        }
        if (this.importActionNode) {
            this.importActionNode.destroy();
            this.totalTr = null;
        }
        if (this.mobileActionNode) {
            this.mobileActionNode.destroy();
            this.mobileActionNode = null;
        }
        const ths = this.node.getElements('.mwf_mobile_edit_th');
        ths.destroy();
    },
    // _moveUpLine: function(ev, line){
    //     if( this.currentEditedLine && !this._completeLineEdit(null, true) )return false;

    //     const prevNode = line.node.previousElementSibling;
    //     if (prevNode){
    //         const cloneNode = line.node.cloneNode(true);
    //         cloneNode.style.opacity = 0;
    //         prevNode.insertAdjacentElement('beforebegin', cloneNode);
    //     }

    //     var data, upData, curData;
    //     if( this.isShowAllSection ){
    //         if (line.options.indexInSectionLine === 0) return;

    //         data = this.getBusinessDataById();
    //         var sdata = data[ this.sectionBy ];
    //         if( !sdata )return;

    //         upData = sdata.data[line.options.indexInSectionLine - 1];
    //         curData = sdata.data[line.options.indexInSectionLine];
    //         sdata.data[line.options.indexInSectionLine] = upData;
    //         sdata.data[line.options.indexInSectionLine - 1] = curData;

    //         this.setAllSectionData( data, false, "moveUpList" );
    //     }else {
    //         if (line.options.index === 0) return;

    //         data = this.getInputData();
    //         upData = data.data[line.options.index - 1];
    //         curData = data.data[line.options.index];
    //         data.data[line.options.index] = upData;
    //         data.data[line.options.index - 1] = curData;
    //         this.setData(data, false, "moveUpList");
    //     }
    //     this.fireEvent("change", [{lines: this.lineList, "type":"move", line: line}]);
    // }
});

/**
 * 数据模板数据结构.
 * @typedef {Array} DatatemplateData
 * @example
 [ //数据模板数据条目
 {
           "org": [{
                "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
                "id": "bf007525-99a3-4178-a474-32865bdddec8",
                "name": "张三",
                "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
                "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
                "unitLevelName": "兰德纵横/市场营销部",
                "unitName": "市场营销部"
            }],
            "org_1": [{
                "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
                "id": "bf007525-99a3-4178-a474-32865bdddec8",
                "name": "张三",
                "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
                "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
                "unitLevelName": "兰德纵横/市场营销部",
                "unitName": "市场营销部"
            }, {
                "distinguishedName": "李四@bf007525-99a3-4178-a474-32865bdddec8@I",
                "id": "bf007525-99a3-4178-a474-32865bdddec8",
                "name": "李四",
                "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
                "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
                "unitLevelName": "兰德纵横/市场营销部",
                "unitName": "市场营销部"
            }],
            "number": "111",
            "textfield": "杭州",
            "attachment": [
                {
                    "activityName": "拟稿",
                    "extension": "jpg",
                    "id": "9514758e-9e28-4bfe-87d7-824f2811f173",
	 				"businessId": "1234758e-9e28-4bfe-87d7-824f2811f173",
                    "lastUpdateTime": "2020-12-09 21:48:03",
                    "length": 452863.0,
                    "name": "111.jpg",
                    "person": "李四@lisi@P"
                }
            ]
        },
 ...
 ]
 */
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Datatemplate 数据模板组件。自定义结构和样式的多行数据编辑组件。
 * @o2cn 数据模板
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datatemplate = this.form.get("name"); //获取组件
 * //方法2
 * var datatemplate = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @since v6.2
 * @o2range {Process|CMS|Protal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Datatemplate = MWF.APPDatatemplate = new Class(
	/** @lends MWF.xApplication.process.Xform.Datatemplate# */
	{
		Implements: [Events],
		Extends: MWF.APP$Module,
		isEdit: false,
		options: {
			/**
			 * 所有内容加载后执行（包括异步加载）。
			 * @event MWF.xApplication.process.Xform.Datatemplate#afterLoad
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 每初始化一个条目，但未加载的时候触发，通过this.event可以获取条目对象。
			 * @event MWF.xApplication.process.Xform.Datatemplate#beforeLoadLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 每一个条目加载后时候触发，通过this.event可以获取条目对象。
			 * @event MWF.xApplication.process.Xform.Datatemplate#afterLoadLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 数据模板改变时触发。通过this.event.lines可以获取修改的条目数组，this.event.type可以获得修改的类型。<br/>
			 * <table>
			 *     <tr><th><b>this.event.type</b></th><th><b>触发类型</b></th><th><b>this.event.lines</b></th></tr>
			 *     <tr><td>addline</td><td>添加一行</td><td>添加的行数组</td></tr>
			 *     <tr><td>deleteline</td><td>删除一行</td><td>删除的行数组</td></tr>
			 *     <tr><td>deletelines</td><td>删除多行</td><td>删除的行数组</td></tr>
			 *     <tr><td>editmodule</td><td>字段值改变时</td><td>this.event.lines为编辑的行数组<br/>this.event.module为修改的字段</td></tr>
			 *     <tr><td>import</td><td>导入数据后</td><td>数据模板所有行</td></tr>
			 * </table>
			 * @event MWF.xApplication.process.Xform.Datatemplate#change
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 添加条目时触发。通过this.event.line可以获取对应的条目对象，this.event.ev可以获得事件触发的Event。
			 * @event MWF.xApplication.process.Xform.Datatemplate#addLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目前触发。通过this.event可以获取对应的条目对象。
			 * @event MWF.xApplication.process.Xform.Datatemplate#deleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目后触发。
			 * @event MWF.xApplication.process.Xform.Datatemplate#afterDeleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 导出前触发。
			 * @event MWF.xApplication.process.Xform.DatatablePC#beforeExport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 导出excel的时候触发，this.event指向导出的数据，您可以通过修改this.event来修改数据。
			 * @event MWF.xApplication.process.Xform.Datatemplate#export
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *   		["姓名","性别","学历","专业","出生日期","毕业日期"], //标题
			 *  		[ "张三","男","大学本科","计算机","2001-1-2","2019-9-2" ], //第一行数据
			 *  		[ "李四","男","大学专科","数学","1998-1-2","2018-9-2" ]  //第二行数据
			 * 	], //导出的数据
			 *     colWidthArray : [100, 50, 100, 200, 150, 150], //每列宽度
			 *     title : "xxxx" //导出的excel文件标题
			 * }
			 */
			/**
			 * 导入前触发。
			 * @event MWF.xApplication.process.Xform.DatatablePC#beforeImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 在导入excel，进行数据校验后触发，this.event指向导入的数据。
			 * @event MWF.xApplication.process.Xform.Datatemplate#validImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *  	   {
			 *  	 	"姓名" : "张三",
			 *  	 	"性别" : "男",
			 *  	 	"学历" ： "大学本科",
			 *  	    "专业" : "计算机",
			 *  	    "出生日期" : "aa01-1-2",
			 *  	 	"毕业日期" : "2019-9-2",
			 *  	 	"errorTextList" : [
			 *  	 	    "第5列：aa01-1-2不是正确的日期格式。"
			 *  	 	] //校验出的错误信息，如果该行数据正确，则无该字段
			 *  	 }
			 *  	 ...
			 *     ], //导入的数据
			 *     "validted" : true  //是否校验通过，可以在本事件中修改该参数，确定是否强制导入
			 * }
			 */
			/**
			 * 在导入excel，数据校验成功将要设置回数据模板的时候触发，this.event指向整理过的导入数据，格式见{@link DatatemplateData}。
			 * @event MWF.xApplication.process.Xform.Datatemplate#import
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 在导入excel，数据设置回数据模板以后触发，this.event指向整理过的导入数据，格式见{@link DatatemplateData}。
			 * @event MWF.xApplication.process.Xform.Datatemplate#afterImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			"moduleEvents": ["queryLoad","postLoad","load", "afterLoad",
				"beforeLoadLine", "afterLoadLine", "change", "addLine", "deleteLine", "afterDeleteLine", "beforeExport",
				"beforeImport", "export", "import", "validImport", "afterImport"]
		},

		initialize: function(node, json, form, options){
			this.node = $(node);
			this.node.store("module", this);
			this.json = json;
			this.form = form;
			this.field = true;
			this.fieldModuleLoaded = false;
		},
		load: function(){
			this._loadModuleEvents();
			if (this.fireEvent("queryLoad")){
				this._queryLoaded();
				this._loadUserInterface();
				this._loadStyles();
				this._loadDomEvents();
				//this._loadEvents();

				this._afterLoaded();
				this.fireEvent("afterLoad");
				// this.fireEvent("load");
			}
		},
		_loadMergeEditNodeByScript: function(){
			if (this.json.sectionMergeEditScript && this.json.sectionMergeEditScript.code) {
				var data = this.form.Macro.exec(this.json.sectionMergeEditScript.code, this);
				this._setBusinessData( data );
				//this._loadUserInterface();
			}
		},
		_loadMergeEditNodeByDefault: function(){
			var data = this.getSortedSectionData();
			var businessData = [];
			data.each(function(d){
				d.data = d.data || [];
				businessData = businessData.concat( d.data );
			});
			this._setBusinessData(businessData);
			//this._loadUserInterface();
		},
		_loadUserInterface: function(){
			// this.fireEvent("queryLoad");
			this.loading = true;

			if( this.isSectionMergeEdit() ){ //区段合并，删除区段值合并数据后编辑
				if( this.json.mergeTypeEdit === "script" ){
					this._loadMergeEditNodeByScript();
				}else{
					this._loadMergeEditNodeByDefault();
				}
			}

			//区段合并展现
			this.isMergeRead = this.isSectionMergeRead();

			//启用区段且显示所有区段
			this.sectionBy = this._getSectionBy();
			this.isShowAllSection = this.isAllSectionShow();

			var iconNode = this.node.getElement("div[o2icon='datatemplate']");
			if(iconNode)iconNode.destroy();

			// this.editModules = [];
			this.node.setStyle("overflow-x", "auto");
			this.node.setStyle("overflow-y", "hidden");

			this.editable = !(this.readonly || (this.json.isReadonly === true) || (this.form.json.isReadonly === true));
			if( this.isMergeRead )this.editable = false;
			if (this.editable && this.json.editableScript && this.json.editableScript.code){
				this.editable = this.form.Macro.exec(((this.json.editableScript) ? this.json.editableScript.code : ""), this);
			}

			this.getRelativeId();

			//允许导入
			this.importenable  = this.editable && (this.importActionIdList.length > 0) &&
				(this.json.impexpType === "impexp" || this.json.impexpType === "imp");

			//允许导出
			this.exportenable  = (this.exportActionIdList.length > 0) && (this.json.impexpType === "impexp" || this.json.impexpType === "exp");

			if( this.isShowAllSection ){
				this.data = this._getAllSectionData();
			}else if( this.isMergeRead ){
				this.data = this.getSectionMergeReadData();
			}else{
				this.data = this._getValue();
				if( !this._getBusinessData() ){
					this.isNew = true;
					this._setValue(this.data);
				}
			}

			this.lineList = [];
			this.sectionlineList = [];

			//this.data为object的时候才有值
			// this.lineMap = {};

			// this.totalModules = [];
			this._loadStyles();

			//获取html模板和json模板
			this.getTemplate();


			if( !this.form.isLoaded ){ //如果表单还没加载完成
				//通过表单的afterModulesLoad事件设置节点外的操作：添加、删除、导入、导出
				this.setOuterActionEvents();
			}

			//隐藏节点
			this.node.getChildren().hide();

			this.fireEvent("load");
			this._loadDataTemplate(function(){
				// this._loadImportExportAction();
				this.fieldModuleLoaded = true;
				this.loading = false;
				this.fireEvent("postLoad");
			}.bind(this));
		},
		/*
		 * @summary 重新加载数据表格。会触发load和postLoad事件。
		 * @example
		 *  this.form.get("fieldId").reload(); //重新加载
		 */
		reload: function( isReloadTemplate ){
			this.reloading = true;

			// this.editModules = [];

			this.getRelativeId();

			this.checkMerge( this.getValue() );

			this.clearSubModules();

			this._loadStyles();

			if( isReloadTemplate ){ //重新获取html模板和json模板
				this.node.getChildren().setStyle("display", "");
				this.getTemplate();
				this.node.getChildren().hide();
			}

			this.lineList = [];
			this.sectionlineList = [];

			if( this.form.isLoaded ){ //如果表单还没加载完成
				this._setOuterActionEvents(true);
			}

			this.fireEvent("load");
			this._loadDataTemplate(function(){
				// this._loadImportExportAction();
				this.reloading = false;
				this.fireEvent("postLoad");
			}.bind(this));
		},
		getRelativeId: function(){
			this.outerAddActionIdList = (this.json.outerAddActionId || "").split(",");
			this.outerDeleteActionIdList = (this.json.outerDeleteActionId || "").split(",");
			this.outerSelectAllIdList = (this.json.outerSelectAllId || "").split(",");

			this.addActionIdList = (this.json.addActionId || "").split(",");
			this.deleteActionIdList = (this.json.deleteActionId || "").split(",");
			this.sequenceIdList = (this.json.sequenceId || "").split(",");
			this.selectorId = this.json.selectorId;

			this.importActionIdList = (this.json.importActionId || "").split(",");
			this.exportActionIdList = (this.json.exportActionId || "").split(",");
		},
		getTemplate: function(){
			this.templateJson = {};
			this.templateHtml = this.node.get("html");
			var moduleNodes = this.form._getModuleNodes(this.node);
			moduleNodes.each(function (node) {
				if (node.get("MWFtype") !== "form") {
					var json = this.form._getDomjson(node);
					this.templateJson[json.id] = json ;
				}
			}.bind(this));
		},
		_loadStyles: function(){
			this.node.setStyles(this.json.styles);
			this.node.set(this.json.properties);
		},
		_getOuterActionModules: function( idList ){ //判断不在数据模板中，但是在表单内的Id
			var list = [];
			idList.each( function (id) {
				var module = this._getModuleByPath(id);
				var tId = id.split("..").getLast();
				if( !this.templateJson.hasOwnProperty(tId) && module ){
					list.push( module );
				}
			}.bind(this));
			return list;
		},
		_setOuterActionEvents: function( reload ){
			this.addActionList = this._getOuterActionModules( [].concat(this.addActionIdList, this.outerAddActionIdList) );
			this.addActionList.each( function (module) {
				var addEvent = function (){
					!module._isDtEventAdded && module.node.addEvents({"click": function(e){
						this._addLine(e);
					}.bind(this)});
					module._isDtEventAdded = true;
					!this.editable ? module.node.hide() : module.node.show();
					module.removeEvent("load", addEvent);
				}.bind(this);

				if( module.json.type.substr(0, 2) === "El" ){
					 module.vm ? addEvent() : module.addEvent("load", addEvent);
				}else{
					addEvent();
				}

			}.bind(this));

			this.deleteActionList = this._getOuterActionModules( [].concat( this.outerDeleteActionIdList ) );
			this.deleteActionList.each( function (module) {
				var addEvent = function (){
					!module._isDtEventAdded && module.node.addEvents({"click": function(e){
						this._deleteSelectedLine(e);
					}.bind(this)});
					module._isDtEventAdded = true;
					!this.editable ? module.node.hide() : module.node.show();
					module.removeEvent("load", addEvent);
				}.bind(this);

				if( module.json.type.substr(0, 2) === "El" ){
					module.vm ? addEvent() : module.addEvent("load", addEvent);
				}else{
					addEvent();
				}
			}.bind(this));

			this.selectAllList = this._getOuterActionModules( this.outerSelectAllIdList );
			this.selectAllList.each( function (module) {
				// module.setData(""); //默认不选中
				var addEvent = function (){
					!module._isDtEventAdded && module.node.addEvents({"click": function(e){
						this._checkSelectAll(e);
					}.bind(this)});
					module._isDtEventAdded = true;
					!this.editable ? module.node.hide() : module.node.show();
					module.removeEvent("load", addEvent);
				}.bind(this);

				( !!reload && module.reload ) && module.reload();

				if( module.json.type.substr(0, 2) === "El" ){
					module.vm ? addEvent() : module.addEvent("load", addEvent);
				}else{
					addEvent();
				}
			}.bind(this));
			this.selectAllSelector = this.selectAllList[0];
			if(this.selectAllSelector){
				this.unselectAll();
			}

			this.importActionList = this._getOuterActionModules( this.importActionIdList );
			this.importActionList.each( function (module) {
				var addEvent = function (){
					!module._isDtEventAdded && module.node.addEvents({"click": function(e){
						this.importFromExcel();
					}.bind(this)});
					module._isDtEventAdded = true;
					!this.editable ? module.node.hide() : module.node.show();
					module.removeEvent("load", addEvent);
				}.bind(this);

				if( module.json.type.substr(0, 2) === "El" ){
					module.vm ? addEvent() : module.addEvent("load", addEvent);
				}else{
					addEvent();
				}
			}.bind(this));

			this.exportActionList = this._getOuterActionModules( this.exportActionIdList );
			this.exportActionList.each( function (module) {
				var addEvent = function (){
					!module._isDtEventAdded && module.node.addEvents({"click": function(e){
						this.exportToExcel();
					}.bind(this)});
					module._isDtEventAdded = true;
					module.removeEvent("load", addEvent);
				}.bind(this);

				if( module.json.type.substr(0, 2) === "El" ){
					module.vm ? addEvent() : module.addEvent("load", addEvent);
				}else{
					addEvent();
				}
			}.bind(this));
		},
		setOuterActionEvents: function(){

			this.bindEvent = function () {
				this._setOuterActionEvents();

				this.fireEvent("afterLoad");

				//加载完成以后，删除事件
				this.form.removeEvent("afterModulesLoad", this.bindEvent );
			}.bind(this);

			//去要表单的所有组件加载完成以后再去获取外部组件
			this.form.addEvent("afterModulesLoad", this.bindEvent );
		},
		isShowSectionKey: function(){
			return this.json.showSectionKey && this.isMergeRead ;
		},
		isShowSectionBy: function(){
			return this.json.showSectionBy && this.isShowAllSection ;
		},
		isSectionData: function(){ //数据是否经过区段处理
			var data = this.getBusinessDataById();
			if( o2.typeOf( data ) === "object" ){
				var keys = Object.keys(data);
				// if( o2.typeOf(data[keys[0]]) === "array"  ){
				// 	return true;
				// }
				for( var i=0; i<keys.length; i++ ){
					var key = keys[i];
					if( key !== "data" ){
						if( o2.typeOf(data[key]) === "array"  ){
							return true;
						}
					}
				}
			}
			return false;
		},
		/**
		 * @summary 当数据模板设置为区段合并展现、区段合并编辑时，可以使用本方法获取所有区段数据。
		 * @return {Object} 对象.
		 * @example
		 * var data = this.form.get("fieldId").getAllSectionData();
		 * //data格式如下：
		 * {
		 *  	"3455b82a-399c-4ee4-b9b9-e70ae40fbaf1": [ //区段1的key和data
		 *			{
		 *				"good": "yf",
		 *				"number_2": 11,
		 *				"prize": 1
		 *			}
		 *		],
		 *  	"83de86fc-60bc-4b4c-955c-1085915865a4": [ //区段2的key和data
		 *  		{
		 *  			"good": "yf",
		 *  			"number_2": 11,
		 *  			"prize": 10
		 *  		}
		 *  	]
		 *  }
		 */
		getAllSectionData: function(){
			return this.getBusinessDataById();
		},
		_getAllSectionData: function(){
			var bData = this.getBusinessDataById();
			var flag = false;
			if( !bData ){
				flag = true;
				bData = {};
			}
			if( this.sectionBy && !bData[this.sectionBy] ){
				flag = true;
				this.isNew = true;
				bData[this.sectionBy] = this.getValue();
			}
			if( flag )this.setBusinessDataById( bData );
			this.dataWithSectionBy = this.getAllSortedSectionData();
			return flag ? this.getBusinessDataById() : bData;
		},
		getAllSortedSectionData: function(){ //获取合并排序后的数据
			var data = this.getBusinessDataById();
			var array = [];
			for( var key in data ){
				array.push({
					sectionKey: key,
					key: key,
					data: data[key]
				})
			}
			if( this.json.sectionDisplaySortScript && this.json.sectionDisplaySortScript.code){
				array.sort( function(a, b){
					this.form.Macro.environment.event = {
						"a": a,
						"b": b
					};
					var flag = this.form.Macro.exec(this.json.sectionDisplaySortScript.code, this);
					this.form.Macro.environment.event = null;
					return flag;
				}.bind(this))
			}
			return array;
		},
		getSectionMergeReadData: function(){
			switch (this.json.mergeTypeRead) {
				case "dataScript":
					if (this.json.sectionMergeReadDataScript && this.json.sectionMergeReadDataScript.code) {
						return this.form.Macro.exec(this.json.sectionMergeReadDataScript.code, this);
					}else{
						return [];
					}
				default:
					var sortedData = this.getSortedSectionData();
					if( this.json.showSectionKey ){
						this.dataWithSectionKey = sortedData;
					}
					var data = [];
					//把区段值放在每行的数据里
					sortedData.each(function(d){
						( d.data || [] ).each(function( obj ){
							if( o2.typeOf(obj) === "object" ){
								// obj.sectionKey = d.sectionKey;
								data.push( obj )
							}
						});
						// data = data.concat( d.data.data );
					});
					return data;
			}
		},
		getDefaultValue: function(){
			if( this.json.section==="yes" && !this.sectionBy )return [];
			var value;
			if (this.json.defaultData && this.json.defaultData.code) value = this.form.Macro.exec(this.json.defaultData.code, this);
			if (value && !value.then) if (o2.typeOf(value)==="object") value = [value];
			if(!value){
				value = [];
				var count = this.json.defaultCount ? this.json.defaultCount.toInt() : 0;
				for( var i=0; i<count; i++ )value.push({})
			}
			return value;
		},
		_getValue: function(){
			if (this.moduleValueAG) return this.moduleValueAG;
			var value = this._getBusinessData();
			if( !value ){
				value = this.getDefaultValue();
			}
			// if (!value){
			// 	if (this.json.defaultData && this.json.defaultData.code) value = this.form.Macro.exec(this.json.defaultData.code, this);
			// 	if (value && !value.then) if (o2.typeOf(value)==="object") value = [value];
			// }
			// if(!value){
			// 	value = [];
			// 	var count = this.json.defaultCount ? this.json.defaultCount.toInt() : 0;
			// 	for( var i=0; i<count; i++ )value.push({})
			// }
			return value;
		},
		getValue: function(){
			if (!this.isReadable) return [];
			return this._getValue();
		},

		_setValue: function(value){
			if (!!value && o2.typeOf(value.then)=="function"){
				var p = o2.promiseAll(value).then(function(v){
					this.__setValue(v);
				}.bind(this), function(){});
				this.moduleValueAG = p;
				p.then(function(){
					this.moduleValueAG = null;
				}.bind(this), function(){
					this.moduleValueAG = null;
				}.bind(this));
			}else{
				this.moduleValueAG = null;
				this.__setValue(value);
			}
		},
		__setValue: function(value){
			this._setBusinessData(value);
			this.moduleValueAG = null;
			return value;
		},

		_loadDataTemplate: function(callback, operation){
			var p = o2.promiseAll(this.data).then(function(v){
				this.data = v;
				// if (o2.typeOf(this.data)=="object") this.data = [this.data];


				if( this.isShowAllSection ){
					this._loadSectionLineList_EditSection(callback, operation)
				}else if( this.isShowSectionKey() ){
					this._loadSectionLineList(callback, operation)
				}else{
					this._loadLineList(callback, operation);
				}

				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
		},
		_loadSectionLineList_EditSection: function(callback, operation){
			var map = this.unchangedSectionLineMap || {};
			//this._getAllSectionData();
			this.dataWithSectionBy.each(function(data, idx){
				var isEdited = false;
				if( this.isSectionLineEditable( data ) && this.editable ){
					isEdited = true;
				}
				var isNew = false;
				var sectionLine;
				var beforeNode = idx > 0 ? this.sectionlineList[idx-1].node : null;
				if( map[data.sectionKey] ) {
					sectionLine =  map[data.sectionKey];
					if( !operation || operation === "moveUpList"){
						this._injectLineNode( sectionLine.node, beforeNode );
					}
					sectionLine.setIndex( data, idx, isEdited, isNew, operation );
					//console.log("setIndex", sectionLine);
				}else{
					var div = this._injectLineNode( new Element("div"), beforeNode );
					sectionLine = this._loadSectionLine_EditSection(div, data, idx, isEdited, isNew );
					//console.log("_loadSectionLine_EditSection", sectionLine);
				}
				if( this.sectionBy && this.sectionBy === data.sectionKey ){
					this.sectionLineEdited = sectionLine;
				}
				this.sectionlineList.push(sectionLine);
			}.bind(this))
			if (callback) callback();
		},
		_loadSectionLine_EditSection: function(container, data, index, isEdited, isNew){
			var sectionLine = new MWF.xApplication.process.Xform.Datatemplate.SectionLine(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isDeleteable: this.editable && this.isSectionLineEditable(data),
				isAddable: this.editable && this.isSectionLineEditable(data)
			});
			// this.fireEvent("beforeLoadLine", [line]);
			sectionLine.load();
			// this.fireEvent("afterLoadLine", [line]);
			return sectionLine;
		},
		isSectionLineEditable: function(data){
			return this.isShowAllSection && this.sectionBy && this.sectionBy === data.sectionKey;
		},

		_loadSectionLineList: function(callback, operation){
			var map = this.unchangedSectionLineMap || {};
			this.dataWithSectionKey.each(function(data, idx){
				var sectionLine;
				var isEdited = false;
				var isNew = false;
				var beforeNode = idx > 0 ? this.sectionlineList[idx-1].node : null;
				if( map[data.sectionKey] ) {
					sectionLine =  map[data.sectionKey];
					if( !operation || operation === "moveUpList"){
						this._injectLineNode( sectionLine.node, beforeNode );
					}
					//console.log("setIndex", sectionLine);
					sectionLine.setIndex( data, idx, isEdited, isNew, operation );
				}else {
					//var div = new Element("div").inject(this.node);
					var div = this._injectLineNode( new Element("div"), beforeNode );
					sectionLine = this._loadSectionLine(div, data, idx, isEdited, isNew );
					//console.log("_loadSectionLine", sectionLine);
				}
				this.sectionlineList.push(sectionLine);
			}.bind(this))
			if (callback) callback();
		},
		_loadSectionLine: function(container, data, index, isEdited, isNew){
			var sectionLine = new MWF.xApplication.process.Xform.Datatemplate.SectionLine(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isNew: isNew,
				isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.editable,
				isDeleteable: this.editable,
				isAddable: this.editable,
				isMergeRead: this.isMergeRead
			});
			// this.fireEvent("beforeLoadLine", [line]);
			sectionLine.load();
			// this.fireEvent("afterLoadLine", [line]);
			return sectionLine;
		},
		_loadLineList: function(callback, operation){
			var map = this.unchangedLineMap || {};
			Object.each(map, function (line, idx) {
				line.setIndex( idx.toInt() );
			});
			this.data.each(function(data, idx){
				var idxStr = idx.toString();
				var beforeNode = idx > 0 ? this.lineList[idx - 1].node : null;
				if( map[idxStr] ){
					if( !operation || operation === "moveUpList" ){
						this._injectLineNode( map[idxStr].node, beforeNode );
					}
					//console.log("inject", map[idxStr]);
					this.lineList.push( map[idxStr] );
				}else{
					var isNew = this.isNew || (o2.typeOf(this.newLineIndex) === "number" ? idx === this.newLineIndex : false);
					var div = this._injectLineNode( new Element("div"), beforeNode );
					var line = this._loadLine(div, data, idx, isNew);
					//console.log("_loadLine", line);
					this.lineList.push(line);
				}
			}.bind(this));
			this.newLineIndex = null;
			this.isNew = false;
			if (callback) callback();
		},
		_loadLine: function(container, data, index, isNew){
			var line = new MWF.xApplication.process.Xform.Datatemplate.Line(container, this, data, {
				index : index,
				indexText : (index+1).toString(),
				isEdited : this.editable,
				isNew : isNew,
				isMergeRead: this.isMergeRead
			});
			this.fireEvent("beforeLoadLine", [line]);
			line.load();
			this.fireEvent("afterLoadLine", [line]);
			return line;
		},
		_injectLineNode: function( lineNode, beforeNode ){
			if( beforeNode ){
				lineNode.inject( beforeNode, "after");
			}else{
				lineNode.inject( this.node );
			}
			return lineNode;
		},
		isMax : function(){
			var maxCount = this.json.maxCount ? this.json.maxCount.toInt() : 0;
			if( this.editable && maxCount > 0 ) {
				if( this.isShowAllSection ){
					if( this.sectionLineEdited && this.sectionLineEdited.lineList.length >= maxCount )return true;
				}else{
					if( this.lineList.length >= maxCount )return true;
				}
			}
			return false;
		},
		isMin : function(){
			var minCount = this.json.minCount ? this.json.minCount.toInt() : 0;
			if( this.editable && minCount > 0 ) {
				if( this.isShowAllSection ){
					if( this.sectionLineEdited && this.sectionLineEdited.lineList.length <= minCount )return true;
				}else {
					if( this.lineList.length <= minCount )return true;
				}
			}
			return false;
		},
		_setLineData: function(line, d){
			if( line.sectionLine ){
				var data = this.getBusinessDataById();
				var sdata = data[ line.sectionLine.sectionKey ];
				if( sdata  ){
					sdata[line.options.indexInSectionLine] = d;
					this.setAllSectionData( data, false, "setLineData" );
				}
			}else{
				var index = line.options.index;
				var data = this.getInputData();
				data[index] = d;
				this.setData( data, false, "setLineData" );
			}
		},
		_addLine: function(ev, d){

			if( this.isMax() ){
				var text = MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);
				this.form.notice(text,"info");
				return false;
			}

			var data, index, newLine;
			if( this.isShowAllSection ){
				data = this.getBusinessDataById();
				var sdata = data[ this.sectionBy ];
				if( !sdata ){
					sdata = data[ this.sectionBy ] = [];
				}

				sdata.push(d||{});
				index = sdata.length - 1;
				this.newLineIndex = index;

				this.setAllSectionData( data , false, "addLine");
				newLine = this.sectionLineEdited.lineList[index];
			}else{
				data = this.getInputData();

				data.push(d || {});
				index = data.length-1;
				this.newLineIndex = index;
				this.setData( data, false, "addLine" );
				newLine = this.getLine(index);
			}

			this.validationMode();
			this.fireEvent("addLine",[{"line":newLine, "ev":ev}]);
			this.fireEvent("change", [{"lines":[newLine], "type":"addline"}]);
			return newLine;
		},
		_insertLine: function(ev, beforeLine){
			if( this.isMax() ){
				var text = MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);
				this.form.notice(text,"info");
				return false;
			}

			//使用数据驱动
			var data, index, newLine;
			if( this.isShowAllSection ){
				index = beforeLine.options.indexInSectionLine + 1;

				data = this.getBusinessDataById();
				var sdata = data[ this.sectionBy ];
				if( !sdata ){
					sdata = data[ this.sectionBy ] = [];
				}
				sdata.splice(index, 0, {});
				this.newLineIndex = index;

				this.setAllSectionData( data , false, "insertLine");
				newLine = this.sectionLineEdited.lineList[index];
			}else {
				index = beforeLine.options.index+1;
				data = this.getInputData();
				data.splice(index, 0, {});
				this.newLineIndex = index;
				this.setData( data, false, "insertLine" );
				newLine = this.getLine( index );
			}

			this.validationMode();
			this.fireEvent("addLine",[{"line":newLine, "ev":ev}]);
			this.fireEvent("change", [{"lines":[newLine], "type":"addline"}]);
			return newLine;
		},
		_insertLineByIndex: function(ev, index, d){
			if( this.isMax() ){
				var text = MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);
				this.form.notice(text,"info");
				return false;
			}
			//使用数据驱动
			var data, newLine;
			if( this.isShowAllSection ){
				data = this.getBusinessDataById();
				var sdata = data[ this.sectionBy ];
				if( !sdata ){
					sdata = data[ this.sectionBy ] = [];
				}
				if (sdata.length < index) return null;
				sdata.splice(index, 0, d || {});
				this.newLineIndex = index;

				this.setAllSectionData( data , false, "insertLine");
				line = this.sectionLineEdited.lineList[index];
			}else {
				data = this.getInputData();
				if(data.length < index )return null;
				data.splice(index, 0, d||{});
				this.newLineIndex = index;
				this.setData( data , false, "insertLine");
				newLine = this.getLine( index );
			}

			this.validationMode();
			this.fireEvent("addLine",[{"line":newLine, "ev":ev}]);
			this.fireEvent("change", [{"lines":[newLine], "type":"addline"}]);
			return newLine;
		},
		_deleteSelectedLine: function(ev){
			var selectedLine = this.lineList.filter(function (line) {
				return line.selected && ( line.options.isEdited || line.options.isNew );
			});
			if( selectedLine.length === 0 ){
				this.form.notice( MWF.xApplication.process.Xform.LP.selectItemNotice,"info");
				return false;
			}
			var minCount = this.json.minCount ? this.json.minCount.toInt() : 0;
			if( minCount > 0 ){
				var length;
				if( this.isShowAllSection && this.sectionLineEdited ){
					length = this.sectionLineEdited.lineList.length;
				}else{
					length = this.lineList.length;
				}
				if( length - selectedLine.length < minCount ){
					var text = MWF.xApplication.process.Xform.LP.minItemNotice.replace("{n}", minCount );
					this.form.notice(text,"info");
					return false;
				}
			}
			var _self = this;
			this.form.confirm("warn", ev, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteSelectedItemNotice, 300, 120, function(){

				_self._delLines( selectedLine );

				this.close();

			}, function(){
				this.close();
			}, null, null, this.form.json.confirmStyle);

		},
		_delLines: function(lines){
			var _self = this;
			var saveFlag = false;

			var data;
			if( this.isShowAllSection ){
				data = this.getBusinessDataById();
			}else{
				data = _self.getInputData();
			}

			lines.reverse().each(function(line){
				_self.fireEvent("deleteLine", [line]);

				if(line.deleteAttachment())saveFlag = true;

				if( line.sectionLine ){
					var d = data[ line.sectionLine.sectionKey ];
					if( d ){
						d.splice(line.options.indexInSectionLine, 1);
					}
				}else {
					data.splice(line.options.index, 1);
				}

				_self.fireEvent("afterDeleteLine");
			});

			if( this.isShowAllSection ){
				_self.setAllSectionData(data, false, "deleteLines");
			}else{
				_self.setData( data , false, "deleteLines");
			}
			this.validationMode();

			_self.fireEvent("change", [{"lines":lines, "type":"deletelines"}]);

			if(saveFlag)this.form.saveFormData();
		},
		_deleteLine: function(ev, line){
			if( this.isMin() ){
				var text = MWF.xApplication.process.Xform.LP.minItemCountNotice.replace("{n}", this.json.minCount );
				this.form.notice(text,"info");
				return false;
			}
			var _self = this;
			this.form.confirm("warn", ev, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteDatagridLine, 300, 120, function(){
				_self._delLine(line);
				this.close();
			}, function(){
				this.close();
			}, null, null, this.form.json.confirmStyle);
		},
		_delLine: function(line){
			this.fireEvent("deleteLine", [line]);

			var saveFlag = line.deleteAttachment();
			//使用数据驱动
			var data;
			if( line.sectionLine ){
				var data = this.getBusinessDataById();
				var d = data[ line.sectionLine.sectionKey ];
				if( d ){
					d.splice(line.options.indexInSectionLine, 1);
				}
				this.setAllSectionData( data, false, "deleteLine" );
			}else{
				data = this.getInputData();
				data.splice(line.options.index, 1);
				this.setData( data , false, "deleteLine");
			}

			this.validationMode();
			this.fireEvent("afterDeleteLine");

			this.fireEvent("change", [{"lines":[line], "type":"deleteline"}]);

			if(saveFlag)this.form.saveFormData();
		},
		_checkSelectAll: function () {
			var selectData = this.selectAllSelector.getData();
			var selected;
			if(o2.typeOf(selectData)==="array"){
				selected = selectData.contains(this.json.outerSelectAllSelectedValue);
			}else{
				selected = selectData === this.json.outerSelectAllSelectedValue;
			}
			this.selected = selected;
			if( this.isShowAllSection && this.sectionLineEdited){
				this.sectionLineEdited.lineList.each(function (line) {
					if( line.options.isEdited || line.options.isNew ){
						this.selected ? line.select() : line.unselect();
					}
				}.bind(this))
			}else{
				this.lineList.each(function (line) {
					if( line.options.isEdited || line.options.isNew ) {
						this.selected ? line.select() : line.unselect();
					}
				}.bind(this))
			}
		},
		selectAll: function(){
			this.selected = true;
			if(this.selectAllSelector)this.selectAllSelector.setData(this.json.outerSelectAllSelectedValue);
		},
		unselectAll: function(){
			this.selected = false;
			if( this.selectAllSelector.getOptionsObj ){
				var options = this.selectAllSelector.getOptionsObj();
				var value;
				var arr = options.valueList || [];
				for( var i=0; i<arr.length; i++ ){
					var v = arr[i];
					if( v !== this.json.outerSelectAllSelectedValue ){
						value = v;
						break;
					}
				}
				this.selectAllSelector.setData( typeOf(value) !== 'null' ? [value] : []);
			}else{
				this.selectAllSelector.setData([]);
			}
		},

		// editValidation: function(){
		// 	var flag = true;
		// 	this.editModules.each(function(field, key){
		// 		if (field.json.type!=="sequence" && field.validationMode ){
		// 			field.validationMode();
		// 			if (!field.validation()) flag = false;
		// 		}
		// 	}.bind(this));
		// 	return flag;
		// },
		exportToExcel: function(){
			this.exporter = new MWF.xApplication.process.Xform.Datatemplate.Exporter(this);
			this.exporter.exportToExcel();
		},
		importFromExcel: function(){
			this.importer = new MWF.xApplication.process.Xform.Datatemplate.Importer(this);
			this.importer.importFromExcel();
		},


		_afterLoaded: function(){
		},
		// /**
		//  * @summary 重置数据模板的值为默认值或置空。
		//  *  @example
		//  * this.form.get('fieldId').resetData();
		//  */
		resetData: function(){
			// var value = this.getDefaultValue() || [];
			var value = this.getValue() || [];
			this.setData(value);
		},
		/**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
		 * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
		 * @summary 为数据模板赋值。
		 * @param data{DatatemplateData|Promise|Array} 必选，数组或Promise.
		 * @example
		 *  this.form.get("fieldId").setData([]); //赋空值
		 * @example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      this.form.get('fieldId').setData( data );
		 *  }else{
		 *      this.data['fieldId'] = data;
		 *  }
		 *@example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 */
		setData: function(data, fireChange, operation){
			if (!data){
				data = this._getValue();
			}
			this._setData(data, fireChange, operation);
		},
		_setData: function(data, fireChange, operation){
			var p = o2.promiseAll(this.data).then(function(v){
				this.data = v;
				// if (o2.typeOf(data)==="object") data = [data];
				this.__setData(data, fireChange, operation);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
		},
		__setData: function(data, fireChange, operation){
			if( this.isShowAllSection ){
				//兼容外部对编辑当前区段的setData，内部的setData不走这里，直接走setAllSectionData
				this._setEditedSectionData(data, fireChange, operation);
				return;
			}else if( this.isMergeRead ){
				//合并且只读，不允许setData
				throw new Error("The data template is merged and read-only, you can use the 'setAllSectionData' method to set all section data");
			}

			var old;
			if(fireChange)old = Object.clone(this._getBusinessData() || {});

			this._setUnchangedLineMap(data, operation);

			this._setBusinessData(data);
			this.data = data;

			if (this.data){
				this.clearSubModules();
			}

			this.lineList = [];
			this.sectionlineList = [];
			this._loadDataTemplate(function(){
				this._setSubDatatemplateOuterEvents();
				if (fireChange && JSON.stringify(old) !== JSON.stringify(data)) this.fireEvent("change");
				this.unchangedLineMap = null;
			}.bind(this), operation);
		},
		_setSubDatatemplateOuterEvents: function(){
			//告诉下层的数据模板绑定外部事件
			for (var i=0; i<this.lineList.length; i++){
				this.lineList[i].setSubDatatemplateOuterActionEvents();
			}
		},
		_setEditedSectionData: function(data, fireChange, operation){
			if( this.isShowAllSection ){
				var d = this.getBusinessDataById();
				d[ this.sectionBy ] = data || { data: [] };
				this.setAllSectionData( d, fireChange , operation);
			}
		},
		/**
		 * @summary 当数据模板设置为区段合并展现、区段合并编辑时，可以使用本方法设置所有区段数据。
		 * @param data{Object} 必选，对象.
		 * @param fireChange{boolean} 可选，是否触发change事件，默认false.
		 * @example
		 *  this.form.get("fieldId").setAllSectionData({}); //赋空值
		 * @example
		 *  this.data['fieldId'].setAllSectionData({
		 *  	"3455b82a-399c-4ee4-b9b9-e70ae40fbaf1": [ //区段1的key和data
		 *			{
		 *				"good": "yf",
		 *				"number_2": 11,
		 *				"prize": 1
		 *			}
		 *		],
		 *  	"83de86fc-60bc-4b4c-955c-1085915865a4": [ //区段2的key和data
		 *  		{
		 *  			"good": "yf",
		 *  			"number_2": 11,
		 *  			"prize": 10
		 *  		}
		 *  	]
		 *  });
		 */
		setAllSectionData: function(data, fireChange, operation){
			var old;
			if(fireChange)old = Object.clone(this.getBusinessDataById() || {});

			this._setUnchangedSectionLineMap(data);

			this.setBusinessDataById(data);

			if( operation ){
				this.data = this.isShowAllSection ? this._getAllSectionData() : data;
			}else{
				this.checkMerge(data);
			}

			if (this.data){
				this.clearSubModules();
			}

			if (fireChange && JSON.stringify(old) !== JSON.stringify(data)) this.fireEvent("change");

			this.lineList = [];
			this.sectionlineList = [];
			this._loadDataTemplate(function () {
				Object.each(this.unchangedSectionLineMap, function(sline, key){
					sline.isUnchangedAll = null;
					sline.unchangedLineMap = null;
				});
				this.unchangedSectionLineMap = null;
			}.bind(this), operation);
		},

		checkMerge: function(data){
			//区段合并后编辑
			var isMergeEidt = this.isSectionMergeEdit();
			if( isMergeEidt ){ //区段合并，删除区段值合并数据后编辑
				if( this.json.mergeTypeEdit === "script" ){
					this._loadMergeEditNodeByScript();
				}else{
					this._loadMergeEditNodeByDefault();
				}
			}
			//区段合并展现
			this.isMergeRead = this.isSectionMergeRead();
			//启用区段且显示所有区段
			this.sectionBy = this._getSectionBy();
			this.isShowAllSection = this.isAllSectionShow();

			if( this.isShowAllSection ){
				this.data = this._getAllSectionData();
			}else if( this.isMergeRead ) {
				this.data = this.getSectionMergeReadData();
			}else if( isMergeEidt ){
				this.data = this._getBusinessData()
			}else{
				this.data = data;
			}
		},
		_setUnchangedSectionLineMap: function( data, operation ){
			if( !data ){
				return;
			}
			var map = {};
			if( this.sectionlineList && this.sectionlineList.length ){
				this.sectionlineList.each(function (sline, i) {
					for( var key in data ){
						if( key === sline.sectionKey ){
							var m = sline._setUnchangedLineMap(data[key], operation);
							if( m )map[key] = m;
							break;
						}
					}
				}.bind(this));
			}
			this.unchangedSectionLineMap = map;
		},
		_setUnchangedLineMap: function(data, operation){
			if( !data ){
				this.unchangedLineMap = {};
				return;
			}
			var fromOutside = !operation;
			var lineDataList = this.lineList.map(function (line) {
				if( line.options.isEdited !== this.editable )return "";
				if( line.options.isDeleteable !== this.editable )return "";
				if( line.options.isAddable !== this.editable )return "";
				return fromOutside ?  JSON.stringify(line.data) : line.data;
			}.bind(this));

			var dStr, map = {};
			data.each(function (d, idx) {
				if(fromOutside)dStr = JSON.stringify(d);
				for (var i = 0; i < this.lineList.length; i++) {
					var isEqual= fromOutside ? (dStr === lineDataList[i]) : (d === lineDataList[i] );
					if ( isEqual ) {
						map[idx] = this.lineList[i];
						lineDataList[i] = "";
						break;
					}
				}
			}.bind(this));
			this.unchangedLineMap = map;
		},
		clearSubModules: function(){
			if( this.sectionlineList && this.sectionlineList.length ){
				for( var i=0; i<this.sectionlineList.length; i++ ){
					this.sectionlineList[i].clearSubModules();
				}
			}else{
				var map = this.unchangedLineMap || {};
				var lines = [];
				Object.values(map).each(function (d) {
					lines = lines.concat(d);
				});
				for (var i=0; i<this.lineList.length; i++){
					//this.lineList[i].clearSubModules();
					var l = this.lineList[i];
					if(!lines.contains(l))l.clearSubModules();
				}
			}
		},
		resetId: function(){
			if( this.sectionlineList && this.sectionlineList.length ){
				this.sectionlineList.each(function (sline, i) {
					sline.resetId();
				}.bind(this));
			}else{
				for (var i=0; i<this.lineList.length; i++){
					this.lineList[i].resetId();
				}
			}
		},
		/**
		 * @summary 判断数据模板是否为空.
		 * @example
		 * if( this.form.get('fieldId').isEmpty() ){
		 *     this.form.notice('至少需要添加一条数据', 'warn');
		 * }
		 * @return {Boolean} 是否为空
		 */
		isEmpty: function(){
			var data = this.getInputData();
			if( !data )return true;
			if( o2.typeOf( data ) === "array" ){
				return data.length === 0;
			}
			if( o2.typeOf( data ) === "object" ){
				return Object.keys(data).length === 0;
			}
			return false;
		},
		//api 相关开始
		/**
		 * 获取对应的条目。
		 * @param {Number} index 条目序号，从零开始
		 * @return {MWF.xApplication.process.Xform.Datatemplate.Line | Null} 对应的数据模板条目
		 * @example
		 * //获取数据模板“dt1”的第一个条目。
		 * var line = this.form.get("dt1").getLine(0);
		 * //获取第一个条目subject字段的值
		 * var data = line.get("subject").getData();
		 * //设置subject字段的值
		 * line.get("subject").setData("test1");
		 */
		getLine: function(index){
			var line = this.lineList[index];
			return line || null;
		},
		/**
		 * 在数据模板末尾添加条目。
		 * @param {Object} [data] 添加条目的数据。
		 * @return {MWF.xApplication.process.Xform.Datatemplate.Line} 添加的数据模板条目
		 * @example
		 * var line = this.form.get("dt1").addLine();
		 */
		addLine: function( data ){
			return this._addLine( null, data );
		},
		/**
		 * 在数据模板指定位置添加条目。
		 * @param {Number} index 条目序号，从零开始，如果下标超过当前数据模板条目数，插入失败并返回null。
		 * @param {Object} [data] 添加条目的数据。
		 * @return {MWF.xApplication.process.Xform.Datatemplate.Line | Null} 插入的数据模板条目
		 * @example
		 * var line = this.form.get("dt1").insertLine(0);
		 */
		insertLine: function(index, data){
			return this._insertLineByIndex(null, index, data);
		},
		/**
		 * 删除指定位置的条目。
		 * @param {Number} index 条目序号，从零开始，如果下标超过当前数据模板条目数，删除失败。
		 * @example
		 * //直接删除第一个条目
		 * this.form.get("dt1").deleteLine(0);
		 */
		deleteLine: function(index, ev){
			var line = this.lineList[index];
			if( !line )return null;
			// if( ev ){
			// 	this._deleteLine(ev, line);
			// }else{
			this._delLine(line);
			// }
		},
		/**
		 * 获取对应表单组件，作用等同于get。
		 * @param {Number} index 条目序号，从零开始
		 * @param {String} id 组件标识
		 * @return {FormComponent} 对应表单组件
		 * @example
		 * //获取数据模板“dt1”的第一个条目的subject字段。
		 * var module = this.form.get("dt1").getModule(0, "subject");
		 * //获取subject字段的值
		 * var data = module.getData();
		 * //设置subject字段的值
		 * module.setData("test1");
		 */
		getModule: function(index, id){
			var line = this.lineList[index];
			if( !line )return null;
			return line.getModule(id);
		},
		/**
		 * 获取对应表单组件，作用等同于getModule。
		 * @param {Number} index 条目序号，从零开始
		 * @param {String} id 组件标识
		 * @return {FormComponent} 对应表单组件
		 * @example
		 * //获取数据模板“dt1”的第一个条目的subject字段。
		 * var module = this.form.get("dt1").get(0, "subject");
		 * //获取subject字段的值
		 * var data = module.getData();
		 * //设置subject字段的值
		 * module.setData("test1");
		 */
		get: function(index, id){
			return this.getModule(index, id);
		},
		//api 相关

		/**
		 * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
		 * 区别如下：<br/>
		 * 1、当使用Promise的时候<br/>
		 * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
		 * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
		 * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
		 * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
		 * @summary 获取数据模板数据.
		 * @example
		 * var data = this.form.get('fieldId').getData();
		 *@example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  var data;
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      data = this.form.get('fieldId').getData();
		 *  }else{
		 *      data = this.data['fieldId']; //直接从数据中获取字段值
		 *  }
		 *  @example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 * @return {DatatemplateData}
		 */
		getData: function(){
			if( this.importer ){
				this.importer.destroySimulateModule();
			}
			var data;
			if (this.editable!==false){
				// var data = [];
				// this.lineList.each(function(line, index){
				// 	data.push(line.getData())
				// });
				//
				// this.data = data;
				//
				// this._setBusinessData(this.data);
				//
				// return (this.data.length) ? this.data : [];
				this.lineList.each(function (line) {
					line.computeModuleData("save");
				})
				data = this._getBusinessData();
				return o2.typeOf(data) === 'array' ? Array.clone(data) : data;
			}else{
				data = this._getBusinessData();
				return o2.typeOf(data) === 'array' ? Array.clone(data) : data;
			}
		},
		getInputData: function(){
			if( this.importer ){
				this.importer.destroySimulateModule();
			}
			if (this.editable!==false){
				return this._getBusinessData();
			}else{
				return this._getBusinessData();
			}
		},
		_getSectionBy: function(){
			if (this.json.section!=="yes"){
				return "";
			}else {
				switch (this.json.sectionBy){
					case "person":
						return layout.desktop.session.user.id;
					case "unit":
						return (this.form.businessData.task) ? (this.form.businessData.task.unitDn || this.form.businessData.task.unit) : "";
					case "activity":
						return (this.form.businessData.work) ? this.form.businessData.work.activity : "";
					case "splitValue":
						return (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
					case "script":
						if( this.json.sectionByScript && this.json.sectionByScript.code){
							return this.form.Macro.exec(this.json.sectionByScript.code, this) || "";
						}else{
							return "";
						}
					default:
						return "";
				}
			}
		},
		createErrorNode: function(text){
			node = new Element("div", {styles:{
                "margin-top": "0.3em"
            }});
            var iconNode = new Element("div.ooicon-error", {
                "styles": {
                    "width": "20px",
                    "height": "1.2em",
                    "float": "left",
					"color": "red",
                    "display": "flex",
                    "align-items": "center",
                    "justify-content": "center"
                    // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                }
            }).inject(node);
            var textNode = new Element("div", {
                "styles": {
                    "height": "auto",
                    "line-height": "1.2em",
                    "margin-left": "20px",
                    "color": "red",
                    "word-break": "keep-all"
                },
                "text": text
            }).inject(node);
			return node;
		},
		notValidationMode: function(text){
			if (!this.isNotValidationMode){
				this.isNotValidationMode = true;
				this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
				this.node.setStyle("border", "1px solid red");

				this.errNode = this.createErrorNode(text).inject(this.node, "after");
				this.showNotValidationMode(this.node);

				var parentNode = this.errNode;
				while( parentNode && parentNode.offsetParent === null ){
					parentNode = parentNode.getParent();
				}

				if (parentNode && !parentNode.isIntoView()) parentNode.scrollIntoView(false);
			}
		},
		showNotValidationMode: function(node){
			var p = node.getParent("div");
			if (p){
				if (p.get("MWFtype") == "tab$Content"){
					if (p.getParent("div").getStyle("display")=="none"){
						var contentAreaNode = p.getParent("div").getParent("div");
						var tabAreaNode = contentAreaNode.getPrevious("div");
						var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
						var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
						tabNode.click();
						p = tabAreaNode.getParent("div");
					}
				}
				this.showNotValidationMode(p);
			}
		},
		validationMode: function(){
			if (this.isNotValidationMode){
				this.isNotValidationMode = false;
				this.node.setStyles(this.node.retrieve("borderStyle"));
				if (this.errNode){
					this.errNode.destroy();
					this.errNode = null;
				}
			}
		},

		validationConfigItem: function(routeName, data){
			var flag = (data.status=="all") ? true: (routeName == data.decision);
			if (flag){
				var n = this.getData();
				if( o2.typeOf(n)==="object"){
					var arr = [];
					Object.each( n, function (d, key) {
						if(o2.typeOf(d) === "array")arr = arr.concat(d);
					});
					n = arr;
				}
				var v = (data.valueType=="value") ? n : n.length;
				switch (data.operateor){
					case "isnull":
						if (!v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notnull":
						if (v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "gt":
						if (v>data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "lt":
						if (v<data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "equal":
						if (v==data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "neq":
						if (v!=data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "contain":
						if (v.indexOf(data.value)!=-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notcontain":
						if (v.indexOf(data.value)==-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
				}
			}
			return true;
		},
		validationConfig: function(routeName, opinion){
			if (this.json.validationConfig){
				if (this.json.validationConfig.length){
					for (var i=0; i<this.json.validationConfig.length; i++) {
						var data = this.json.validationConfig[i];
						if (!this.validationConfigItem(routeName, data)) return false;
					}
				}
				return true;
			}
			return true;
		},
		saveValidation: function () {
			var flag = true;
			for (var i=0; i<this.lineList.length; i++){
				if( this.lineList[i] && !this.lineList[i].saveValidation())flag = false;
			}
			return flag;
		},
		validation: function(routeName, opinion){
			// if (this.isEdit){
			// 	if (!this.editValidation()){
			// 		return false;
			// 	}
			// }
			if (!this.validationConfig(routeName, opinion))  return false;

			if (!this.json.validation) return true;
			if (!this.json.validation.code) return true;

			this.currentRouteName = routeName;
			var flag = this.form.Macro.exec(this.json.validation.code, this);
			this.currentRouteName = "";

			if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
			if (flag.toString()!=="true"){
				this.notValidationMode(flag);
				return false;
			}
			return true;
		},
		getAttachmentRandomSite: function(){
			var i = (new Date()).getTime();
			return this.json.id+i;
		}
	});


MWF.xApplication.process.Xform.Datatemplate.SectionLine =  new Class({
	Implements: [Options, Events],
	options: {
		isNew: false,
		isEdited: true, //是否正在编辑
		isDeleteable: true, //能否被删除
		isAddable: true, //能否添加
		isMergeRead: false, //合并阅读
		index: 0,
		indexText: "0"
	},
	initialize: function (node, template, data, options) {
		this.setOptions(options);
		this.node = node;
		this.template = template;
		this.data = data;
		this.form = this.template.form;
		this.lineList = [];
		this.sectionKey = this.data.sectionKey;
	},
	load: function () {
		if( this.template.isShowSectionKey() || this.template.isShowSectionBy() ){
			this.loadSectionKeyNode();
		}

		if( this.data.data ){
			( this.data.data || [] ).each(function(d, idx){
				if( !d )return;
				var div = new Element("div").inject(this.node);
				var isEdited = false, isNew = false;
				if( this.options.isEdited ){
					var dt = this.template;
					isNew = dt.isNew || (o2.typeOf(dt.newLineIndex) === "number" ? idx === dt.newLineIndex : false);
					isEdited = true;
					dt.isNew = false;
					dt.newLineIndex = null;
				}
				var line = this._loadLine( div, d, idx, isEdited, isNew );
				this.lineList.push(line);
				this.template.lineList.push(line);
			}.bind(this));
		}
	},
	resetId: function(){
		this.lineList.each(function (line) {
			line.resetId();
		}.bind(this))
	},
	setIndex: function( data, index, isEdited, isNew, operation ){
		if( this.isUnchangedAll && index === this.options.index )return;

		this.data = data;

		this.options.index = index;
		this.options.indexText = (index+1).toString();

		//this.node.inject(preNode, "after");

		this.lineList = [];
		var map = this.unchangedLineMap || {};
		Object.each(map, function (line, idx) {
			line.setIndex( this.template.lineList.length + idx.toInt(), idx.toInt() );
		}.bind(this));
		if( this.data &&  this.data.data ){
			this.data.data.each(function (d, idx) {
				if( !d )return;
				var idxStr = idx.toString();
				var beforeNode = idx > 0 ? this.lineList[idx - 1].node : null;
				if( map[idxStr] ){
					if( !operation || operation === "moveUpList" ){
						this._injectLineNode( map[idxStr].node, beforeNode )
					}
					//console.log("inject", map[idxStr]);
					this.lineList.push( map[idxStr] );
					this.template.lineList.push(map[idxStr]);
				}else{
					var node = this._injectLineNode( new Element("div"), beforeNode );
					var isEdited = false, isNew = false;
					if( this.options.isEdited ){
						var dt = this.template;
						isNew = dt.isNew || (o2.typeOf(dt.newLineIndex) === "number" ? idx === dt.newLineIndex : false);
						isEdited = true;
						dt.isNew = false;
						dt.newLineIndex = null;
					}
					var line = this._loadLine( node, d, idx, isEdited, isNew );
					//console.log("_loadLine", line);
					this.lineList.push(line);
					this.template.lineList.push(line);
				}
			}.bind(this))
		}
	},
	_loadLine: function(container, data, index, isEdited, isNew){
		var line = new MWF.xApplication.process.Xform.Datatemplate.Line(container, this.template, data, {
			indexInSectionLine : index,
			indexInSectionLineText : (index+1).toString(),
			index: this.template.lineList.length,
			indexText : (this.template.lineList.length + 1).toString(),
			isNew: isNew,
			isEdited: typeOf(isEdited) === "boolean" ? isEdited : this.options.isEdited,
			isDeleteable: this.options.isDeleteable,
			isAddable: this.options.isAddable,
			isMergeRead: this.options.isMergeRead,
			sectionKey: this.sectionKey
		}, this);
		this.template.fireEvent("beforeLoadLine", [line]);
		line.load();
		this.template.fireEvent("afterLoadLine", [line]);
		return line;
	},
	_injectLineNode: function( lineNode, beforeNode ){
		if( beforeNode ){
			lineNode.inject( beforeNode, "after");
		}else{
			lineNode.inject( this.node );
		}
		return lineNode;
	},
	loadSectionKeyNode: function () {
		var sectionKeyStyles = this.template._parseStyles(this.template.json.sectionKeyStyles);
		var keyNode = new Element("div.mwf_sectionkey", {
			styles : sectionKeyStyles
		}).inject( this.node );
		this.keyNode = keyNode;
		var separator;
		if( this.template.isShowSectionKey() ){
			separator = this.template.json.keyContentSeparator;
		}else{
			separator = this.template.json.keyContentSeparatorSectionBy;
		}
		this.template.getSectionKeyWithMerge( this.data, function (key) {
			if( o2.typeOf(key) === "string" ){
				keyNode.set("text", key + (separator || ""));
			}else{
				Promise.resolve(key).then(function (k) {
					keyNode.set("text", k + (separator || ""));
				}.bind(this))
			}
		}.bind(this));
	},
	_setUnchangedLineMap: function(data, operation){
		var fromOutside = !operation;
		var dt = this.template;
		var editalbe;
		if( dt.isShowAllSection ){
			editalbe = dt.isShowAllSection && dt.sectionBy && dt.sectionBy === this.sectionKey;
		}
		var lineDataList = this.lineList.map(function (line) {
			if( dt.isShowAllSection ){
				if( line.options.isEdited !== (dt.editable && editalbe) )return "";
				if( line.options.isDeleteable !== (dt.editable && editalbe) )return "";
				if( line.options.isAddable !== (dt.editable && editalbe) )return "";
			}else{
				if( line.options.isEdited !== dt.editable )return "";
				if( line.options.isDeleteable !== dt.editable )return "";
				if( line.options.isAddable !== dt.editable )return "";
			}
			return fromOutside ?  JSON.stringify(line.data) : line.data;
		}.bind(this));

		var dStr, map = {};
		data.each(function (d, idx) {
			if(fromOutside)dStr = JSON.stringify(d);
			for (var i = 0; i < this.lineList.length; i++) {
				var isEqual = fromOutside ? (dStr === lineDataList[i]) : (d === lineDataList[i] );
				if ( isEqual ) {
					map[idx] = this.lineList[i];
					lineDataList[i] = "";
					break;
				}
			}
		}.bind(this));


		this.isUnchangedAll = data.length === this.lineList.length;
		if( this.isUnchangedAll ){
			for( var i=0; i<data.length; i++ ){
				var line = map[i.toString()];
				if( !line || line.options.indexInSectionLine !== i ){
					this.isUnchangedAll = false;
					break;
				}
			}
		}

		this.unchangedLineMap = map;

		return Object.keys(map).length ? this : null;
	},
	clearSubModules: function(){
		if( this.isUnchangedAll )return;

		var map = this.unchangedLineMap || {};
		var hasUnchangedLine = Object.keys(map).length > 0;

		if( !hasUnchangedLine ){
			if( this.keyNode ){
				this.keyNode.destroy();
				this.keyNode = null;
			}
		}

		var lines = [];
		Object.values(map).each(function (d) {
			lines = lines.concat(d);
		});
		for (var i=0; i<this.lineList.length; i++){
			var l = this.lineList[i];
			if(!lines.contains(l)){
				l.clearSubModules();
			}
		}
	}
});

MWF.xApplication.process.Xform.Datatemplate.Line =  new Class({
	Implements: [Options, Events],
	options: {
		isNew: false,
		isEdited : true,
		isAddable: true,
		isDeleteable: true,
		index : 0,
		indexText : "0",
		indexInSectionLine: 0,
		indexInSectionLineText : "0",
		sectionKey: ""
	},
	initialize: function (node, template, data, options, sectionLine) {

		this.setOptions(options);

		this.node = node;
		this.template = template;
		this.data = data;
		this.form = this.template.form;
		this.sectionLine = sectionLine;

		this.modules = [];
		this.all = {};
		this.all_templateId = {};

		this.fields = [];
		this.allField = {};
		this.allField_templateId = {};

		this.addActionList = [];
		this.deleteActionList = [];
		this.sequenceNodeList = [];
		this.selector = null;
		this.importActionList = [];
		this.exportActionList = [];

		this.subDatatemplateModuleList = [];
	},
	resetId: function(){
		this.setIndex();
	},
	setIndex: function(index, indexInSectionLine){
		var hasIndexArg = typeOf(index) !== "null";
		var hasIndexInSectionLineArg = typeOf(indexInSectionLine) !== "null";

		if( hasIndexArg && hasIndexInSectionLineArg){
			if( this.options.index === index && this.options.indexInSectionLine === indexInSectionLine )return;
		}else if( hasIndexArg && !hasIndexInSectionLineArg){
			if( this.options.index === index )return;
		}else if(!hasIndexArg && hasIndexInSectionLineArg){
			if( this.options.indexInSectionLine === indexInSectionLine )return;
		}

		if( hasIndexArg ){
			this.options.index = index;
			this.options.indexText = (index.toInt()+1).toString();
		}

		if( hasIndexInSectionLineArg ){
			this.options.indexInSectionLine = indexInSectionLine;
			this.options.indexInSectionLineText = (indexInSectionLine.toInt()+1).toString();
		}

		//合并状态或拆分状态
		var sectionKey = this.options.sectionKey || this.template.sectionBy;
		this.modules.each(function (module) {
			var json = module.json;
			var id, oldId = json.id, templateJsonId = json.originialId;
			if( this.template.isShowAllSection ){
				id = this.template.json.id + ".." + sectionKey + ".." + this.options.indexInSectionLine + ".." + json.originialId;
			}else if( sectionKey ){
				id = this.template.json.id + ".." + sectionKey + ".." + this.options.index + ".." + json.originialId;
			}else{
				id = this.template.json.id + ".." + this.options.index + ".." + json.originialId;
			}
			json.id = id;
			switch (json.type) {
				case "Select":
					(module.areaNode || module.node).set("id", id);
					break;
				case "Datatable":
				case "Datatemplate":
					module.resetId();
					break;
				default:
					module.node.set("id", id);
					break;
			}

			if( json.type==="Attachment" || json.type==="AttachmentDg" ){
				json.originialSite = json.site || json.originialId;
				json.site = this.getAttachmentSite(json, templateJsonId, sectionKey);
			}

			delete this.all[oldId];
			this.all[id] = module;

			delete this.allField[oldId];
			this.allField[id] = module;

			if(this.form.all[oldId] && this.form.all[oldId] === module){
				delete this.form.all[oldId];
			}
			this.form.all[id] = module;

			if(this.form.forms[oldId] && this.form.forms[oldId] === module){
				delete this.form.forms[oldId];
			}
			if( module.field )this.form.forms[id] = module;

			this.checkSequence(module, templateJsonId);
		}.bind(this));
	},
	load: function(){
		this.node.set("html", this.template.templateHtml);
		var moduleNodes = this.form._getModuleNodes(this.node);

		//拆分状态
		var sectionKey = this.options.sectionKey || this.template.sectionBy;

		moduleNodes.each(function (node) {
			if (node.get("MWFtype") !== "form") {
				var _self = this;

				var tJson = this.form._getDomjson(node);
				if( tJson ){
					var json = Object.clone(tJson);

					if( !this.options.isEdited )json.isReadonly = true;

					var templateJsonId = json.id;


					var index = this.options.index;
					var id;
					if( this.template.isShowAllSection ){
						id = this.template.json.id + ".." + sectionKey + ".." + this.options.indexInSectionLine + ".." + json.id;
					}else if( sectionKey ){
						id = this.template.json.id + ".." + sectionKey + ".."+ index + ".." + json.id;
					}else{
						id = this.template.json.id + ".." + index + ".." + json.id;
					}

					json.originialId = templateJsonId;
					json.id = id;
					node.set("id", id);

					if( json.type==="Attachment" || json.type==="AttachmentDg" ){
						json.type = "AttachmentDg";
						json.ignoreSite = true;
						json.originialSite = json.site || json.originialId;
						json.site = this.getAttachmentSite(json, templateJsonId, sectionKey);
					}

					if (this.form.all[id]) this.form.all[id] = null;
					if (this.form.forms[id])this.form.forms[id] = null;

					var module = this.form._loadModule(json, node, function () {
						if( _self.options.isMergeRead ){
							this.field = false; //不希望保存数据
							this._getBusinessData = function(){
								return _self.data[templateJsonId];
							};
							this._setBusinessData = function () {};
						}
						if( _self.widget )this.widget = _self.widget;
						this.parentLine = _self;
						this.parentDatatemplate = _self.template;

						//只读方法值在页面加载的时候或者new的时候计算一下
						if( this.json.compute === "show" ){
							var needComputeShow = false;
							if( _self.template.loading ) {
								needComputeShow = true;
							}else if( _self.options.isNew && !_self.reloading ){
								needComputeShow = true;
							}
							if( !needComputeShow ){
								this.json.compute = "create"; //
								if( this.options.moduleEvents && this.options.moduleEvents.length ){ //恢复compute
									var eventName = ( this.options.moduleEvents || [] ).contains("afterLoad") ? "afterLoad" : "load";
									var resetCompute = function () {
										this.json.compute = "show";
										this.removeEvent( eventName, resetCompute );
									}.bind(this)
									this.addEvent(eventName, resetCompute);
								}
							}
						}
					});
					if(!module.parentLine)module.parentLine = this;
					if(!module.parentDatatemplate)module.parentDatatemplate = this.template;

					if( json.type==="Attachment" || json.type==="AttachmentDg" ){
						module.addEvent("change", function(){
							_self.form.saveFormData();
						}.bind(this))
					}else if( json.type==="Datatemplate" ){
						this.subDatatemplateModuleList.push(module);
					}

					this.form.modules.push(module);

					this.modules.push(module);
					this.all[id] = module;
					this.all_templateId[templateJsonId] = module;

					if (module.field) {
						// if(this.data.hasOwnProperty(templateJsonId)){
						// 	module.setData(this.data[templateJsonId]);
						// }
						this.allField[id] = module;
						this.allField_templateId[templateJsonId] = module;
						this.fields.push( module );

						module.addEvent("change", function(){
							this.template.fireEvent("change", [{lines: [this], type: "editmodule", module: module}]);
						}.bind(this))
					}

					this.setEvents(module, templateJsonId);
					this.checkSequence(module, templateJsonId);
				}
			}
		}.bind(this));

		if(this.options.isNew){
			this.data = this.getData();
			this.options.isNew = false;
		}
	},
	setSubDatatemplateOuterActionEvents: function(){
		this.subDatatemplateModuleList.each(function(module){
			//绑定下级模板事件
			module._setOuterActionEvents();
			//让下级数据模板再去绑定下级模板外部事件
			module._setSubDatatemplateOuterEvents();
		})
	},
	getIndex: function(){
		return this.options.index;
	},
	getModule: function(templateJsonId){
		return this.all_templateId[templateJsonId];
	},
	get: function(templateJsonId){
		return this.all_templateId[templateJsonId];
	},
	getAttachmentSite: function(json, templateJsonId, sectionKey){
		//确保site最长为64，否则后台会报错

		var index = this.options.index;

		var baseSite;
		baseSite =  "." + index + "."  + (json.site || templateJsonId);

		var maxLength;
		var sectionId = "";
		if( sectionKey ){
			maxLength = Math.floor((63 - baseSite.length)/2 );

			sectionId = (sectionKey.length > maxLength) ? sectionKey.substr(sectionKey.length-maxLength, maxLength) : sectionKey;
			sectionId = "." + sectionId;
		}else{
			maxLength = 64 - baseSite.length;
		}

		var templateId = this.template.json.id;
		templateId = (templateId.length > maxLength) ? templateId.substr(templateId.length-maxLength, maxLength) : templateId;

		return templateId + sectionId + baseSite;
	},
	setEvents: function (module, id) {
		if( this.template.addActionIdList.contains( id )){
			this.addActionList.push( module );

			var addAddEvent = function (){
				module.node.addEvent("click", function (ev) {
					this.template._insertLine( ev, this )
				}.bind(this));
			}.bind(this);

			if( module.json.type.substr(0, 2) === "El" ){
				module.vm ? addAddEvent() : module.addEvent("load", addAddEvent);
			}else{
				addAddEvent();
			}

			if( !this.template.editable )module.node.hide();
			if( !this.options.isAddable )module.node.hide();
		}

		if( this.template.deleteActionIdList.contains(id)){
			this.deleteActionList.push( module );

			var addDeleteEvent = function (){
				module.node.addEvent("click", function (ev) {
					this.template._deleteLine( ev, this )
				}.bind(this));
			}.bind(this);

			if( module.json.type.substr(0, 2) === "El" ){
				module.vm ? addDeleteEvent() : module.addEvent("load", addDeleteEvent);
			}else{
				addDeleteEvent();
			}

			if( !this.template.editable )module.node.hide();
			if( !this.options.isDeleteable )module.node.hide();
		}

		if( this.template.selectorId === id){
			this.selector = module;
			// module.setData(""); //默认不选择
			var addSelectEvent = function (){
				module.node.addEvent("click", function (ev) {
					this.checkSelect();
				}.bind(this));
			}.bind(this);

			if( module.json.type.substr(0, 2) === "El" ){
				module.vm ? addSelectEvent() : module.addEvent("load", addSelectEvent);
			}else{
				addSelectEvent();
			}

			if( !this.template.editable )module.node.hide();
			if( !this.options.isDeleteable )module.node.hide();

			if( this.options.isEdited || this.options.isNew ){
				this.unselect();
			}else{
				this.selected = false;
			}

		}

		//???
		// if( this.template.importActionIdList.contains(id))this.importActionList.push( module );
		// if( this.template.exportActionIdList.contains(id))this.exportActionList.push( module );

	},
	checkSequence: function(module, id){
		if( this.template.sequenceIdList.contains(id)){
			this.sequenceNodeList.push( module );
			var indexText;
			if(
				( this.template.isShowSectionKey() && this.template.json.sequenceBySection === "section" ) ||
				( this.template.isShowSectionBy() && this.template.json.sequenceBy === "section" )
			){
				indexText = this.options.indexInSectionLineText;
			}else{
				indexText = this.options.indexText;
			}
			if(this.form.getModuleType(module) === "label"){
				if (module.json.valueType === "script" && module.json.script && module.json.script.code){
					var value = module.form.Macro.exec(module.json.script.code, module);
					module._setNodeText(value);
				}else{
					module.node.set("text", indexText );
				}
			}else if(module.setData){
				module.setData( indexText );
			}
		}
	},
	checkSelect: function () {
		var selectData = this.selector.getData();
		var selected;
		if(o2.typeOf(selectData)==="array"){
			selected = selectData.contains(this.template.json.selectorSelectedValue);
		}else{
			selected = selectData === this.template.json.selectorSelectedValue;
		}
		this.selected = selected;
	},
	select: function(){
		this.selected = true;
		if(this.selector)this.selector.setData(this.template.json.selectorSelectedValue);
	},
	unselect: function(){
		this.selected = false;
		if( this.selector.getOptionsObj ){
			var options = this.selector.getOptionsObj();
			var value;
			var arr = options.valueList || [];
			for( var i=0; i<arr.length; i++ ){
				var v = arr[i];
				if( v !== this.template.json.selectorSelectedValue ){
					value = v;
					break;
				}
			}
			this.selector.setData(typeOf(value) !== 'null' ? [value] : []);
		}else{
			this.selector.setData([]);
		}
	},
	reload: function(){
		this.reloading = true;
		for(var key in this.all){
			var module = this.all[key];
			this.form.modules.erase(module);
			if (this.form.all[key]) delete this.form.all[key];
			if (this.form.forms[key])delete this.form.forms[key];
		}
		this.node.empty();
		this.load();
		this.reloading = false;
	},
	clearSubModules: function () { //把module清除掉
		for(var key in this.all){
			var module = this.all[key];
			//如果嵌套数据模板或者数据表格，还要清除掉下级
			if(module.clearSubModules)module.clearSubModules();
			if( module.json && (module.json.type==="TinyMCEEditor" || module.json.type==="Htmleditor"))module.destroy();
			this.form.modules.erase(module);
			if (this.form.all[key]) delete this.form.all[key];
			if (this.form.forms[key])delete this.form.forms[key];
		}
		this.node.destroy();
	},
	computeModuleData: function( when ){
		for( var key in this.allField){
			var module = this.allField[key];
			var id = key.split("..").getLast();
			if( module.json.compute === when ){
				this.data[id] = module.getData();
			}
		}
	},
	getData: function () {
		var data = this.data;
		for( var key in this.allField){
			var module = this.allField[key];
			var id = key.split("..").getLast();
			if( module.json.type==="Attachment" || module.json.type==="AttachmentDg" ) {
				data[id] = module._getBusinessData();
			}else if( module.json.compute === "save" && module.getInputData ){
				data[id] = module.getInputData();
			}else{
				data[id] = module.getData();
			}
		}
		return data;
	},
	setData: function (data) {
		this.template._setLineData(this, data);
	},
	deleteAttachment: function(){
		var saveFlag = false;
		for( var key in this.allField){
			var module = this.allField[key];
			if( module.json.type==="Attachment" || module.json.type==="AttachmentDg" ){
				var array = module._getBusinessData();
				(array || []).each(function(d){
					saveFlag = true;
					var id = ( this.form.businessData.work || this.form.businessData.document ).id;
					( this.form.workAction || this.form.documentAction ).deleteAttachment(d.id, id);
				}.bind(this));
			}
		}
		return saveFlag;
	},
	saveValidation: function(){
		if( !this.options.isEdited )return true;
		var flag = true;
		this.fields.each(function(field, key){
			if (field.json.type!="sequence" && field.validationMode ){
				field.validationMode();
				if (!field.saveValidation()) flag = false;
			}
		}.bind(this));
		return flag;
	}
});

MWF.xApplication.process.Xform.Datatemplate.ImporterDatatemplate = new Class({
	Extends: MWF.xApplication.process.Xform.Datatemplate,
	initialize: function(mainDatatable){
		this.mainDatatable = mainDatatable;
		this.json = Object.clone( mainDatatable.json );
		this.json.id = this.json.id + "_o2simula";

		this.node = new Element("div", {
			id: this.json.id
		});
		this.node.store("module", this);

		this.form = mainDatatable.form;
		this.field = false;
		this.fieldModuleLoaded = false;
	},
	load: function(){

		this.deleteFormData = function(data){
			delete data[this.id];
			this._self.form.removeEvent("getData", this._self.deleteFormData);
		}.bind({_self: this, id: this.json.id});
		this.form.addEvent("getData", this.deleteFormData);

		this._loadModuleEvents();
		if (this.fireEvent("queryLoad")){
			this._queryLoaded();
			this._loadUserInterface();
			this._afterLoaded();
			this.fireEvent("afterLoad");
		}
	},
	_loadUserInterface: function(){

		this.editable = true;

		//是否多行同时编辑
		this.multiEditMode = true;

		this.data = [];
		this._setValue(this.data);

		this.lineList = [];

		this.loadDatatemplate();
	},
	loadDatatemplate: function(){
		this.loading = true;

		this.templateJson = this.mainDatatable.templateJson;
		this.templateHtml = this.mainDatatable.templateHtml;

		this.fireEvent("load");
		this._loadDataTemplate(function(){
			this.fieldModuleLoaded = true;
			this.loading = false;
			this.fireEvent("postLoad");
		}.bind(this));
	},
	_loadDataTemplate: function(callback){
		this._loadLineList(function(){
			if(callback)callback();
		}.bind(this));
	},
	_loadLine: function(container, data, index, isNew){
		var line = new MWF.xApplication.process.Xform.Datatemplate.ImporterLine(container, this, data, {
			index : index,
			indexText : (index+1).toString()
		});
		this.fireEvent("beforeLoadLine", [line]);
		line.load();
		this.fireEvent("afterLoadLine", [line]);
		return line;
	},
	_addLine: function(ev, d){

		var data, index, line;

		index = this.lineList.length;
		data = this.getInputData();

		data.push(d||{});
		this.newLineIndex = index;

		this.setData( data );
		line = this.getLine(index);
		line.isNewAdd = true;

		this.fireEvent("addLine", [{"line":line, "ev":ev}]);

		this.fireEvent("change", [{"lines":[line], "type":"addline"}]);

		return line;
	},
	_setSubDatatemplateOuterEvents: function(){
	},
	destroy: function(){
		this.clearSubModules();
		var id = this.json.id;
		if (this.form.all[id]) delete this.form.all[id];
		if (this.form.forms[id])delete this.form.forms[id];
		// if( this.form.businessData.data.hasOwnProperty(id) )delete this.form.businessData.data[id];
		// if( this.form.Macro.environment.data.hasOwnProperty(id) )delete this.form.Macro.environment.data[id];
		this.node.destroy();
	}
});

//Excel导入时候创建的组件
MWF.xApplication.process.Xform.Datatemplate.ImporterLine =  new Class({
	Implements: [Options, Events],
	options: {
		isNew: true,
		isEdited : true, //是否正在编辑
		isEditable : true, //能否被编辑
		isDeleteable: true, //能否被删除
	},
	initialize: function (node, template, data, options) {

		this.setOptions(options);

		this.node = node;
		this.template = template;
		this.data = data;
		this.form = this.template.form;

		this.init()
	},
	init: function(){
		this.modules = [];
		this.all = {};
		this.all_templateId = {};

		this.fields = [];
		this.allField = {};
		this.allField_templateId = {};
	},
	load: function(){
		this.loadModules();
	},
	loadModules: function(){
		this.node.set("html", this.template.templateHtml);
		var moduleNodes = this.form._getModuleNodes(this.node);

		//合并状态或拆分状态
		// var sectionKey = this.options.sectionKey || this.datatable.sectionBy;
		moduleNodes.each(function (node) {
			var mwfType = node.get("MWFtype");
			if (mwfType === "form")return;

			var _self = this;

			var tJson = this.form._getDomjson(node);
			if( tJson ){
				var json = Object.clone(tJson);

				if( !this.options.isEdited )json.isReadonly = true;

				var templateJsonId = json.id;

				var index = "0"; //this.options.index;

				var id = this.template.json.id + "..data.." + index + ".." + json.id;

				json.id = id;
				node.set("id", id);

				if (this.form.all[id]) this.form.all[id] = null;
				if (this.form.forms[id])this.form.forms[id] = null;

				var module = this.form._loadModule(json, node, function () {
					if( _self.widget )this.widget = _self.widget;
					this.parentLine = _self;
					this.parentDatatemplate = _self.template;

					//只读方法值在页面加载的时候或者new的时候计算一下
					if( this.json.compute === "show" ){
						var needComputeShow = false;
						if( _self.template.loading ) {
							needComputeShow = true;
						}else if( _self.options.isNew && !_self.reloading ){
							needComputeShow = true;
						}
						if( !needComputeShow ){
							this.json.compute = "create"; //
							if( this.options.moduleEvents && this.options.moduleEvents.length ){ //恢复compute
								var eventName = ( this.options.moduleEvents || [] ).contains("afterLoad") ? "afterLoad" : "load";
								var resetCompute = function () {
									this.json.compute = "show";
									this.removeEvent( eventName, resetCompute );
								}.bind(this)
								this.addEvent(eventName, resetCompute);
							}
						}
					}
				}, true);
				if(!module.parentLine)module.parentLine = this;
				if(!module.parentDatatemplate)module.parentDatatemplate = this.template;

				this.form.modules.push(module);

				this.modules.push(module);
				this.all[id] = module;
				this.all_templateId[templateJsonId] = module;

				if( module.field && this.options.isEdited ) {
					this.allField[id] = module;
					this.allField_templateId[templateJsonId] = module;
					this.fields.push( module );
				}
			}
		}.bind(this));

	},
	clearSubModules: function () { //把module清除掉
		for(var key in this.all){
			var module = this.all[key];
			//如果嵌套数据模板或者数据表格，还要清除掉下级
			if(module.clearSubModules)module.clearSubModules();
			if( module.json && (module.json.type==="TinyMCEEditor" || module.json.type==="Htmleditor"))module.destroy();
			this.form.modules.erase(module);
			// if( this.form.businessData.data.hasOwnProperty(key) )delete this.form.businessData.data[key];
			// if( this.form.Macro.environment.data.hasOwnProperty(key) )delete this.form.Macro.environment.data[key];
			if (this.form.all[key]) delete this.form.all[key];
			if (this.form.forms[key])delete this.form.forms[key];
		}
		this.node.destroy();
		this.init();
	},
	getModule: function(templateJsonId){
		return this.all_templateId[templateJsonId];
	},
	get: function(templateJsonId){
		return this.all_templateId[templateJsonId];
	},
	getData: function () {
		var data = this.data;
		for( var key in this.allField_templateId){
			var module = this.allField_templateId[key];
			// var id = key.split("..").getLast();
			if( module.json.type==="Attachment" || module.json.type==="AttachmentDg" ){
				data[key] = module._getBusinessData();
			}else{
				data[key] = module.getData();
			}
		}
		return data;
	}
});

MWF.xApplication.process.Xform.Datatemplate.Exporter = new Class({
	Implements: [Options, Events],
	options: {
	},
	initialize: function (template, options) {

		this.setOptions(options);

		this.template = template;
		this.form = this.template.form;

	},
	exportToExcel : function () {
		MWF.require("MWF.widget.Mask", null, false);
		this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
		// 适配移动端
		if (layout.mobile) {
			this.mask.load();
		} else {
			this.mask.loadNode(this.form.app.content);
		}

		this.template.fireEvent("beforeExport");

		var resultArr = [];
		var titleArr = this.template.json.excelFieldConfig.map(function(config){
			return config.title;
		});
		resultArr.push( titleArr );

		var lineList = [];

		if( this.template.isShowAllSection ){
			lineList = this.template.sectionLineEdited ? this.template.sectionLineEdited.lineList : this.template.lineList;
		}else if( this.template.isMergeRead ) {
			lineList = this.template.lineList;
		}else{
			lineList = this.template.lineList;
		}

		lineList.each(function (line, index) {
			var lineData = this.getLineExportData(line, index);
			var p = Promise.all(lineData).then(function (arr) {
				return arr;
			});
			resultArr.push( p );
		}.bind(this));

		Promise.all(resultArr).then(function ( rstArr ) {
			var colWidthArr = this.getColWidthArray();
			var excelName = this.getExcelName();

			var arg = {
				data : rstArr,
				colWidthArray : colWidthArr,
				title : excelName
			};
			this.template.fireEvent("export", [arg]);

			new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils( this.template ).exportToExcel(
				arg.data || rstArr,
				arg.title || excelName,
				arg.colWidthArray || colWidthArr,
				this.getDateIndexArray(),  //日期格式列下标
				null,
				function () {
					if (this.mask) {
						this.mask.hide();
						this.mask = null;
					}
				}.bind(this)
			);
		}.bind(this))
	},
	getLineExportData: function(line, index ){
		var exportData = [];
		this.template.json.excelFieldConfig.each(function (config) {

			var module = line.all_templateId[config.field];
			var json = module ? module.json : "";

			if ( !module || !json || !this.isAvaliableField( json ) ) {
				exportData.push("");
			}else{
				var text;
				if ( json.type === "Label" && module.node) {
					text = module.node.get("text");
				}else{
					text = module.getExcelData();
				}

				if( !text && o2.typeOf(text) !== "number" ){
					text = "";
				}

				exportData.push( text );
			}
		}.bind(this));
		return exportData;
	},
	// getLineExportData: function(line, index ){
	// 	var exportData = [];
	// 	this.template.json.excelFieldConfig.each(function (config) {
	//
	// 		var module = line.all_templateId[config.field];
	// 		var json = module ? module.json : "";
	//
	// 		if ( !module || !json || !this.isAvaliableField( json ) ) {
	// 			exportData.push("");
	// 		}else{
	// 			var value = module.getData();
	// 			var text = "";
	//
	//
	// 			if( value ){
	// 				switch (module.json.type) {
	// 					case "Org":
	// 					case "Reader":
	// 					case "Author":
	// 					case "Personfield":
	// 					case "Orgfield":
	// 						if (o2.typeOf(value) === "array") {
	// 							var textArray = [];
	// 							value.each(function (item) {
	// 								if (o2.typeOf(item) === "object") {
	// 									textArray.push(item.distinguishedName);
	// 								} else {
	// 									textArray.push(item);
	// 								}
	// 							}.bind(this));
	// 							text = textArray.join(", \n");
	// 						} else if (o2.typeOf(value) === "object") {
	// 							text = value.distinguishedName;
	// 						} else {
	// 							text = value;
	// 						}
	// 						break;
	// 					case "Combox":
	// 					case "Address":
	// 						text = o2.typeOf(value) === "array" ? value.join(", ") : value;
	// 						break;
	// 					case "Checkbox":
	// 						var options = module.getOptionsObj();
	// 						var value = o2.typeOf(value) === "array" ? value : [value];
	// 						var arr = [];
	// 						value.each( function( a, i ){
	// 							var idx = options.valueList.indexOf( a );
	// 							arr.push( idx > -1 ? options.textList[ idx ] : "") ;
	// 						});
	// 						text = arr.join(", ");
	// 						break;
	// 					case "Radio":
	// 					case "Select":
	// 						var options = module.getOptionsObj();
	// 						var idx = options.textList.indexOf( value );
	// 						text = idx > -1 ? options.valueList[ idx ] : "";
	// 						break;
	// 					case "Textarea":
	// 						text = value;
	// 						break;
	// 					case "Calendar":
	// 						text = value;
	// 						break;
	// 					default:
	// 						text = value;
	// 						break;
	// 				}
	// 			} else if ( json.type === "Label" && module.node) {
	// 				text = module.node.get("text");
	// 			}
	//
	// 			if( !text && o2.typeOf(text) !== "number" ){
	// 				text = "";
	// 			}
	//
	// 			exportData.push( text );
	// 		}
	// 	}.bind(this));
	// 	return exportData;
	// },
	isAvaliableField : function(json){
		if (["Image","Button","ImageClipper","WritingBoard","Attachment","AttachmentDg","Label",
			"Elbutton","Elbutton","Elcarousel","Eldropdown","Elicon","Eltree"].contains( json.type) )return false; //图片，附件,Label不导入导出
		return true;
	},
	getExcelName: function(){
		var title;
		if( this.template.json.excelName && this.template.json.excelName.code ){
			title = this.form.Macro.exec(this.template.json.excelName.code, this);
		}else{
			title = MWF.xApplication.process.Xform.LP.datatemplateExportDefaultName;
		}
		var titleA = title.split(".");
		if( ["xls","xlst"].contains( titleA[titleA.length-1].toLowerCase() ) ){
			titleA.splice( titleA.length-1 );
		}
		title = titleA.join(".");
		return title;
	},
	getColWidthArray : function(){
		var colWidthArr = [];
		this.template.json.excelFieldConfig.each(function (config) {
			var json = this.form.json.moduleList[config.field];
			if ( !json ){
				colWidthArr.push(150);
			}else if ( ["Org","Reader","Author","Personfield","Orgfield"].contains(json.type)) {
				colWidthArr.push(340);
			} else if (json.type === "Address") {
				colWidthArr.push(170);
			} else if (json.type === "Textarea") {
				colWidthArr.push(260);
			} else if (json.type === "Htmleditor") {
				colWidthArr.push(500);
			} else if (json.type === "TinyMCEEditor") {
				colWidthArr.push(500);
			} else if (json.type === "Calendar") {
				colWidthArr.push(150);
			} else {
				colWidthArr.push(150);
			}
		}.bind(this));
		return colWidthArr;
	},
	getDateIndexArray : function(){
		var dateIndexArr = []; //日期格式列下标
		this.template.json.excelFieldConfig.each(function (config, i) {
			var json = this.form.json.moduleList[config.field];
			if (json && json.type === "Calendar") {
				dateIndexArr.push(i);
			}
		}.bind(this));
		return dateIndexArr;
	},

	exportWithImportDataToExcel : function ( columnList, importedData ) {
		MWF.require("MWF.widget.Mask", null, false);
		this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
		// 适配移动端
		if (layout.mobile) {
			this.mask.load();
		} else {
			this.mask.loadNode(this.form.app.content);
		}

		this.template.fireEvent("beforeExport");

		var resultArr = [];
		var titleArr = this.template.json.excelFieldConfig.map(function(config){
			return config.title;
		});
		titleArr.push( MWF.xApplication.process.Xform.LP.validationInfor );
		resultArr.push( titleArr );


		// this.template.lineList.each(function (line, index) {
		// 	resultArr.push( this.getLineExportData(line, index) );
		// }.bind(this));

		importedData.each( function( lineData, lineIndex ){
			var array = [];
			columnList.each( function (obj, i) {
				array.push( ( lineData[ obj.text ] || '' ).replace(/&#10;/g, "\n") );
			});
			array.push( lineData.errorTextListExcel ? lineData.errorTextListExcel.join("\n") : ""  );

			resultArr.push( array );
		}.bind(this));

		var colWidthArr = this.getColWidthArray();
		colWidthArr.push(300); //提示信息

		var excelName = this.getExcelName();

		var arg = {
			data : resultArr,
			colWidthArray : colWidthArr,
			title : excelName,
			withError: true
		};
		this.template.fireEvent("export", [arg]);

		new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils( this.template ).exportToExcel(
			arg.data || resultArr,
			arg.title || excelName,
			arg.colWidthArray || colWidthArr,
			this.getDateIndexArray(),  //日期格式列下标
			null,
			function () {
				if (this.mask) {
					this.mask.hide();
					this.mask = null;
				}
			}.bind(this)
		);
	}
});

MWF.xApplication.process.Xform.Datatemplate.Importer = new Class({
	Implements: [Options, Events],
	options: {
	},
	initialize: function (template, options) {

		this.setOptions(options);

		this.template = template;
		this.form = this.template.form;

		this.lp = MWF.xApplication.process.Xform.LP;
		this.columnText =  this.lp.importValidationColumnText;
		this.columnTextExcel = this.lp.importValidationColumnTextExcel;
		this.excelUtil = new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils( this.template );

	},
	isAvaliableField : function(json, module, type){
		if (["Image","Button","ImageClipper","WritingBoard","Attachment","AttachmentDg","Label",
			"Elbutton","Elcarousel","Eldropdown","Elicon","Eltree"].contains( json.type) )return false; //图片，附件,Label不导入导出
		return true;
	},
	importFromExcel : function () {
		this.template.fireEvent("beforeImport");

		this.getFieldArray();
		var dateColArray = this.getDateIndexArray(); //日期列
		var orgTitleArray = this.getOrgTitleArray();

		this.excelUtil.upload( dateColArray, function (data) {

			MWF.require("MWF.widget.Mask", null, false);
			this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
			// 适配移动端
			if (layout.mobile) {
				this.mask.load();
			} else {
				this.mask.loadNode(this.form.app.content);
			}

			this.importedData = data;

			if( !this.checkCount() )return;

			this.loadSimulateModule();

			this.fieldArray.each(function (c) {
				c.module = this.importerLine.getModule(c.field)
			}.bind(this));

			if( orgTitleArray.length > 0 ){
				this.listAllOrgData( orgTitleArray, function () {
					this.checkAndImport();
				}.bind(this));
			}else{
				this.checkAndImport();
			}


		}.bind(this));
	},
	checkAndImport: function(){
		this.checkData( function (flag) {

			if( !flag ){
				this.openErrorDlg();
			}else{
				this.importData()
			}
			this.destroySimulateModule();

		}.bind(this));
	},
	destroySimulateModule: function(){
		if( !this.importerDatatemplate ){
			this.form.disallowSaving = false;
			return;
		}

		this.importerDatatemplate.destroy();
		this.importerDatatemplate = null;
		this.form.disallowSaving = false;
	},
	loadSimulateModule: function(){
		this.form.disallowSaving = true;
		this.importerDatatemplate = new MWF.xApplication.process.Xform.Datatemplate.ImporterDatatemplate( this.template );
		this.importerDatatemplate.load();

		this.importerLine = this.importerDatatemplate.addLine({});
	},
	getFieldArray: function(){
		//this.loadSimulateModule();
		this.fieldArray = []; //日期格式列下标
		this.template.json.excelFieldConfig.each(function (config, i) {
			this.fieldArray.push({
				"text": config.title,
				"field": config.field,
				"index": i,
				// "module": this.simelateModuleMap[config.field],
				"json": this.form.json.moduleList[config.field]
			})
		}.bind(this));
	},
	getDateIndexArray : function(){
		var dateIndexArr = []; //日期格式列下标
		this.template.json.excelFieldConfig.each(function (config, i) {
			var json = this.form.json.moduleList[config.field];
			if (json && json.type === "Calendar" && (c.mJson.format === "%Y-%m-%d" || c.mJson.format === "%Y-%m-%d %H:%M:%S")) {
				dateIndexArr.push(i);
			}
		}.bind(this));
		return dateIndexArr;
	},
	getOrgTitleArray : function(){
		var orgTitleArr = []; //日期格式列下标
		this.template.json.excelFieldConfig.each(function (config, i) {
			var json = this.form.json.moduleList[config.field];
			if (json && ["Org","Reader","Author","Personfield","Orgfield"].contains(json.type) ) {
				orgTitleArr.push(config.title);
			}
		}.bind(this));
		return orgTitleArr;
	},
	parseImportedData: function(){
		var data = [];

		this.importedData.each( function( ilineData ){
			var lineData = {};

			this.fieldArray.each( function (obj, i) {
				var index = obj.index;
				var module = obj.module;
				var json = obj.json;
				var text = obj.text;

				var d = ilineData[text] || "";

				var value;
				if( d === "" || d === undefined || d === null ){
					value = "";
				}else{
					switch (json.type) {
						case "Org":
						case "Reader":
						case "Author":
						case "Personfield":
						case "Orgfield":
							var arr = this.stringToArray(d); //空格,空格
							if( arr.length === 0 ){
								value = this.getOrgData( d );
							}else{
								value = [];
								arr.each( function(d, idx){
									var obj = this.getOrgData( d );
									value.push( obj );
								}.bind(this));
							}
							break;
						default:
							value = d; //d.replace(/&#10;/g,""); //换行符&#10;
							break;
					}
				}

				lineData[ json.id ] = value;

			}.bind(this));

			data.push( lineData );

		}.bind(this));

		return data;
	},
	stringToArray: function(string){
		return string.replace(/&#10;/g,",").split(/\s*,\s*/g ).filter(function(s){
			return !!s;
		});
	},
	importData: function(){
		var data = this.parsedData;

		this.template.fireEvent("import", [data] );

		this.template.setData( data );

		this.template.fireEvent("afterImport", [data] );

		this.template.fireEvent("change", [{lines: this.template.lineList, type : "import"}]);

		if (this.mask) {
			this.mask.hide();
			this.mask = null;
		}

		this.form.notice( MWF.xApplication.process.Xform.LP.importSuccess );

	},
	openErrorDlg : function(){
		var eData = this.importedData;
		var _self = this;

		var objectToString = function (obj, type) {
			if(!obj)return "";
			var arr = [];
			Object.each(obj,  function (value, key) {
				if( type === "style" ){
					arr.push( key + ":"+ value +";" )
				}else{
					arr.push( key + "='"+ value +"'" )
				}
			});
			return arr.join(" ")
		}

		var htmlArray = ["<table "+ objectToString( this.template.json.impExpTableProperties ) +" style='"+objectToString( this.template.json.impExpTableStyles, "style" )+"'>"];

		var titleStyle = objectToString(this.template.json.impExpTableTitleStyles, "style");
		htmlArray.push("<tr>");
		this.fieldArray.each(function (obj, i) {
			htmlArray.push( "<th style='"+titleStyle+"'>"+obj.text+"</th>" );
		});
		htmlArray.push("<th style='"+titleStyle+"'> "+MWF.xApplication.process.Xform.LP.validationInfor +"</th>");
		htmlArray.push("</tr>" );

		var contentStyles = Object.clone( this.template.json.impExpTableContentStyles );
		if( !contentStyles[ "border-bottom" ] && !contentStyles[ "border" ] )contentStyles[ "border-bottom" ] = "1px solid #eee";
		var contentStyle = objectToString( Object.merge( contentStyles, {"text-align":"left"}) , "style" );

		eData.each( function( lineData, lineIndex ){

			htmlArray.push( "<tr>" );
			this.fieldArray.each( function (obj, i) {
				htmlArray.push( "<td style='"+contentStyle+"'>"+ ( lineData[ obj.text ] || '' ).replace(/&#10;/g,"<br/>") +"</td>" ); //换行符&#10;
			});
			htmlArray.push( "<td style='"+contentStyle+"'>"+( lineData.errorTextList ? lineData.errorTextList.join("<br/>") : "" )+"</td>" );
			htmlArray.push( "</tr>" );

		}.bind(this));
		htmlArray.push( "</table>" );

		var width = this.template.json.impExpDlgWidth || 1000;
		var height = this.template.json.impExpDlgHeight || 700;
		width = width.toInt();
		height = height.toInt();

		var div = new Element("div", { style : "padding:10px;", html : htmlArray.join("") });
		var dlg = o2.DL.open({
			"style" : this.form.json.dialogStyle || "user",
			"title": MWF.xApplication.process.Xform.LP.importFail,
			"content": div,
			"offset": {"y": 0},
			"isMax": true,
			"width": width,
			"height": height,
			"buttonList": [
				{
					"type": "exportWithError",
					"text": MWF.xApplication.process.Xform.LP.datagridExport,
					"action": function () { _self.exportWithImportDataToExcel(eData); }
				},
				{
					"type": "cancel",
					"text": MWF.LP.process.button.cancel,
					"action": function () { dlg.close(); }
				}
			],
			"onPostClose": function(){
				dlg = null;
			}.bind(this)
		});

		if (this.mask) {
			this.mask.hide();
			this.mask = null;
		}
	},
	checkCount: function(){
		var idata = this.importedData;

		var lp = MWF.xApplication.process.Xform.LP;

		var exceeded = false;
		var maxCount = this.template.json.maxCount ? this.template.json.maxCount.toInt() : 0;
		if( maxCount > 0 && idata.length > maxCount )exceeded = true;

		var less = false;
		var minCount = this.template.json.minCount ? this.template.json.minCount.toInt() : 0;
		if( minCount > 0 && idata.length < minCount) less = true;

		if( exceeded ) {
			var text = lp.importTooManyNotice.replace("{n1}", idata.length).replace("{n2}", this.template.json.maxCount);
			this.form.notice(text, "error");
			return false;
		}

		if( less ){
			var text = lp.importTooFewNotice.replace("{n1}", idata.length).replace("{n2}", this.template.json.minCount );
			this.form.notice(text,"error");
			return false;
		}
		return true;
	},
	checkData : function( callback){
		this.parsedData = this.parseImportedData();
		this.isImportSuccess = true;

		this.checkLineData(0, function () {
			var arg = {
				validted : this.isImportSuccess,
				data : this.importedData
			};
			this.template.fireEvent( "validImport", [arg] );
			callback( arg.validted )
		}.bind(this));
	},
	checkLineData: function(lineIndex, callback){
		if( lineIndex < this.importedData.length ){
			this._checkLineData(this.importedData[lineIndex], lineIndex, function (flag) {
				lineIndex++;
				if( !flag )this.isImportSuccess = false;
				this.checkLineData(lineIndex, callback);
			}.bind(this));
		}else{
			if(callback)callback();
		}
	},
	_checkLineData: function(lineData, lineIndex, callback){
		lineData.errorTextList = lineData.errorTextList || [];
		lineData.errorTextListExcel = lineData.errorTextListExcel || [];

		var parsedLineData = (this.parsedData && this.parsedData[lineIndex]) ? this.parsedData[lineIndex] : [];

		this.checkModuleData(0, lineData, parsedLineData, function () {
			var flag = !lineData.errorTextList.length;
			callback(flag);
		});
	},
	checkModuleData: function(index, lineData, parsedLineData, callback){
		if( index < this.fieldArray.length ){
			var result = this._checkModuleData(this.fieldArray[index], lineData, parsedLineData);
			Promise.resolve(result).then(function (flag) {
				index++;
				this.checkModuleData(index, lineData, parsedLineData, callback);
			}.bind(this))
		}else{
			if(callback)callback();
		}
	},
	_checkModuleData: function (field, lineData, parsedLineData) {
		var index = field.index;
		var json = field.json;
		var module = field.module;
		var text = field.text;

		var colInfor = this.columnText.replace( "{n}", index+1 );
		var colInforExcel = this.columnTextExcel.replace( "{n}", this.excelUtil.index2ColName( index ) );

		var d = lineData[text] || "";
		var parsedD = parsedLineData[json.id] || "";
		var lp = this.lp;
		var flag = true;

		if(d){
			switch (json && json.type) {
				case "Org":
				case "Reader":
				case "Author":
				case "Personfield":
				case "Orgfield":
					var arr = this.stringToArray(d);
					arr.each( function(d, idx){
						var obj = this.getOrgData( d );
						if( obj.errorText ){
							lineData.errorTextList.push( colInfor + obj.errorText + lp.fullstop );
							lineData.errorTextListExcel.push( colInforExcel + obj.errorText + lp.fullstop );
							flag = false;
						}
					}.bind(this));
					break;
				case "Number":
				case "Currency":
				case "Elnumber":
					if (isNaN(d)){
						lineData.errorTextList.push( colInfor + d + lp.notValidNumber + lp.fullstop );
						lineData.errorTextListExcel.push( colInforExcel + d + lp.notValidNumber + lp.fullstop );
						flag = false;
					}
					break;
				case "Calendar":
				case "Eldate":
				case "Eldatetime":
					if( json.format === "%Y-%m-%d" || json.format === "%Y-%m-%d %H:%M:%S" ) {
						if (!(isNaN(d) && !isNaN(Date.parse(d)))) {
							lineData.errorTextList.push(colInfor + d + lp.notValidDate + lp.fullstop);
							lineData.errorTextListExcel.push(colInforExcel + d + lp.notValidDate + lp.fullstop);
							flag = false;
						}
					}
					break;
				default:
					break;
			}
		}
		if (module && module.setData && json.type !== "Address"){
			var hasError = false;
			if(["Org","Reader","Author","Personfield","Orgfield"].contains(json.type)){
				if(o2.typeOf(parsedD)==="array" && parsedD.length){
					hasError = parsedD.some(function (item) { return item.errorText; });
					flag = false;
				}
			}
			if(!hasError){
				module.setExcelData(parsedD);
				var ps = [];
				if( module.moduleExcelAG )ps.push( module.moduleExcelAG );
				if( module.moduleValueAG && !ps.contains(module.moduleValueAG) )ps.push( module.moduleValueAG );
				if( module.moduleSelectAG && !ps.contains(module.moduleSelectAG) )ps.push( module.moduleSelectAG );
				return Promise.all( ps ).then(function () {
					var result = module.validationExcel();
					if ( result && result.length ){
						lineData.errorTextList.push(colInfor + result.join("\n") );
						lineData.errorTextListExcel.push( colInforExcel + result.join("\n"));
						flag = false;
					}
					parsedLineData[json.id] = module.getData();
					return flag;
				})
			}
		}
		return flag
	},
	exportWithImportDataToExcel: function(eData){
		var exporter = new MWF.xApplication.process.Xform.Datatemplate.Exporter(this.template);
		exporter.exportWithImportDataToExcel(this.fieldArray, eData)
	},
	getOrgData : function( str ){
		str = str.trim();
		var flag = str.substr(str.length-2, 2);
		switch (flag.toLowerCase()){
			case "@i":
				return this.identityMap[str] || {"errorText": str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			case "@p":
				return this.personMap[str] || {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			case "@u":
				return this.unitMap[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			case "@g":
				return this.groupMap[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
			default:
				return this.identityMap[str] ||
					this.personMap[str] ||
					this.unitMap[str] ||
					this.groupMap[str] ||
					{"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };

		}
	},
	listAllOrgData : function (orgTitleList, callback) {
		var identityList = [], personList = [], unitList = [], groupList = [];
		if( orgTitleList.length > 0 ){
			this.importedData.each( function( lineData, lineIndex ){
				// if( lineIndex === 0 )return;

				orgTitleList.each( function (title, index) {

					if( !lineData[title] )return;

					var arr = this.stringToArray(lineData[title]);
					arr.each( function( a ){
						a = a.trim();
						var flag = a.substr(a.length-2, 2);
						switch (flag.toLowerCase()){
							case "@i":
								identityList.push( a ); break;
							case "@p":
								personList.push( a ); break;
							case "@u":
								unitList.push( a ); break;
							case "@g":
								groupList.push( a ); break;
							default:
								identityList.push( a );
								personList.push( a );
								unitList.push( a );
								groupList.push( a );
								break;
						}
					})
				}.bind(this))
			}.bind(this));
			var identityLoaded, personLoaded, unitLoaded, groupLoaded;
			var check = function () {
				if( identityLoaded && personLoaded && unitLoaded && groupLoaded ){
					if(callback)callback();
				}
			};

			this.identityMap = {};
			if( identityList.length ){
				identityList = identityList.unique();
				o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({ identityList : identityList }, function (json) {
					json.data.each( function (d) { this.identityMap[ d.matchKey ] = d; }.bind(this));
					identityLoaded = true;
					check();
				}.bind(this))
			}else{
				identityLoaded = true;
				check();
			}

			this.personMap = {};
			if( personList.length ){
				personList = personList.unique();
				o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({ personList : personList }, function (json) {
					json.data.each( function (d) { this.personMap[ d.matchKey ] = d; }.bind(this));
					personLoaded = true;
					check();
				}.bind(this))
			}else{
				personLoaded = true;
				check();
			}

			this.unitMap = {};
			if( unitList.length ){
				unitList = unitList.unique();
				o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({ unitList : unitList }, function (json) {
					json.data.each( function (d) { this.unitMap[ d.matchKey ] = d; }.bind(this));
					unitLoaded = true;
					check();
				}.bind(this))
			}else{
				unitLoaded = true;
				check();
			}

			this.groupMap = {};
			if( groupList.length ){
				groupList = groupList.unique();
				o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({ groupList : groupList }, function (json) {
					json.data.each( function (d) { this.groupMap[ d.matchKey ] = d; }.bind(this));
					groupLoaded = true;
					check();
				}.bind(this))
			}else{
				groupLoaded = true;
				check();
			}
		}
	}
});

MWF.xDesktop.requireApp("Template", "utils.ExcelUtils", null, false);
MWF.xApplication.process.Xform.Datatemplate.ExcelUtils = new Class({
	Extends: MWF.xApplication.Template.utils.ExcelUtils,
	initialize: function(){
		this.sheet2JsonOptions = {};
		this.pollyfill();
	}
});


o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
MWF.xDesktop.requireApp("process.Xform", "$Selector", null, false);

if( !o2.APP$ElSelector ){
    o2.xApplication.process.Xform.$ElSelector = o2.APP$ElSelector = new Class({
        Implements: [Events],
        Extends: MWF.APP$Elinput
    });
    Object.assign(o2.APP$ElSelector.prototype, o2.APP$Selector.prototype);
}

/** @class Elautocomplete 基于Element UI的自动完成输入框组件。
 * @o2cn 自动完成输入框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Elautocomplete = MWF.APPElautocomplete =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elautocomplete# */
    {
    Implements: [Events],
    Extends: MWF.APP$ElSelector,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当 input失去焦点且值有修改是触发，或点击建议面板的选项后且值有修改时触发。this.event[0]为组件值
         * @event MWF.xApplication.process.Xform.Elautocomplete#change
         * @see {@link https://element.eleme.io/#/zh-CN/component/input#dai-shu-ru-jian-yi|input组件的带输入建议章节}
         */
        /**
         * 点击建议面板的选项后时触发。this.event[0]为选中的选项
         * @event MWF.xApplication.process.Xform.Elautocomplete#select
         * @see {@link https://element.eleme.io/#/zh-CN/component/input#input-methods|input组件的Input Method章节}
         */
        "elEvents": ["select", "change"]
    },
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member MWF.xApplication.process.Xform.Elautocomplete#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elinput").json;       //获取组件的json对象
     * var json = this.form.get("elinput").vm.$data;   //获取Vue组件的data数据，
     *
     * //通过json对象操作Element组件
     * json.size = "mini";      //改变输入框大小
     * json.disabled = true;     //设置输入框为禁用
     */
    _appendVueData: function(){
        this.form.Macro.environment.data.check(this.json.id);
        this.json[this.json.id] = this._getBusinessData();

        if (!this.json.placement) this.json.placement = "bottom-start";
        if (!this.json.popperClass) this.json.popperClass = "";
        if (!this.json.triggerOnFocus && this.json.triggerOnFocus!==false) this.json.triggerOnFocus = true;
        if (!this.json.prefixIcon) this.json.prefixIcon = "";
        if (!this.json.suffixIcon) this.json.suffixIcon = "";
        if (!this.json.description) this.json.description = "";
        if (!this.json.disabled) this.json.disabled = false;
    },
    resetOption: function(){
        this.reload();
    },
    _createEventFunction: function(methods, k){
        methods["$loadElEvent_"+k.camelCase()] = function(){
            var flag = true;
            if (k==="change") {
                this.validationMode();
                this._setBusinessData(this.getInputData());
                if( !this.validation() )flag = false;
            }
            if (this.json.events && this.json.events[k] && this.json.events[k].code){
                this.form.Macro.fire(this.json.events[k].code, this, arguments);
            }
            if(k==="select"){
                this.validationMode();
                var arr = [];
                var d = this._getBusinessData();
                if( arguments[0] && arguments[0].value )arr.push(arguments[0].value);
                if( (d||"") !== (arr[0] || "")){
                    if (this.json.events && this.json.events["change"] && this.json.events["change"].code){
                        this.form.Macro.fire(this.json.events["change"].code, this, arr);
                    }
                }
                this._setBusinessData(arr[0]);
                this.validation();
            }
            if( flag )this.fireEvent(k, arguments);
        }.bind(this);
    },
    appendVueExtend: function(app){
        if (!app.methods) app.methods = {};
        // app.methods.$loadElEvent = function(ev){
        //     this.validationMode();
        //     if (this.json.events && this.json.events[ev] && this.json.events[ev].code){
        //         this.form.Macro.fire(this.json.events[ev].code, this, event);
        //     }
        // }.bind(this);
        if (!this.json.itemType || this.json.itemType==='values'){
            app.methods.$fetchSuggestions = function(qs, cb){
                if (this.json.itemValues){
                    var items = this.json.itemValues.filter(function(v){
                        return !qs || v.indexOf(qs)!=-1;
                    }).map(function(v){
                        return {"value": v};
                    });
                    cb(items);
                    //return items;
                }
                return [];
            }.bind(this);
        }else if(this.json.itemType==='script'){
            if (this.json.itemScript && this.json.itemScript.code){
                var fetchSuggestions = this.form.Macro.exec(this.json.itemScript.code, this);
                if (o2.typeOf(fetchSuggestions)==="function"){
                    app.methods.$fetchSuggestions = function(){
                        fetchSuggestions.apply(this, arguments);
                    }.bind(this);
                }
            }
        }else{
            var options;
            Promise.resolve(this.getOptions()).then(function (opt) {
                options = opt;
            });
            app.methods.$fetchSuggestions = function(qs, cb){
                if (options){
                    var items = options.filter(function(v){
                        return !qs || v.indexOf(qs)!=-1;
                    }).map(function(v){
                        return {"value": v};
                    });
                    cb(items);
                    //return items;
                }
                return [];
            }.bind(this);
        }
        // app.methods.$fetchSuggestions = function(qs, cb){
        //     if (this.json.itemType!=='script'){
        //         if (this.json.itemValues){
        //             var items = this.json.itemValues.filter(function(v){
        //                 return !qs || v.indexOf(qs)!=-1;
        //             }).map(function(v){
        //                 return {"value": v};
        //             });
        //             cb(items);
        //             return;
        //         }
        //         cb();
        //     }else{
        //         this.form.Macro.environment.queryString = qs;
        //         var list = this.form.Macro.exec(this.json.itemScript.code, this);
        //         Promise.resolve(list).then(function(items){
        //             cb(items);
        //             delete this.form.Macro.environment.queryString;
        //         }).catch(function(){
        //             cb();
        //             delete this.form.Macro.environment.queryString;
        //         });
        //     }
        // }.bind(this);
    },
    _createElementHtml: function(){
        var html = "<el-autocomplete";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :placement=\"placement\"";
        html += " :popper-class=\"popperClass\"";
        html += " :trigger-on-focus=\"triggerOnFocus\"";
        html += " :prefix-icon=\"prefixIcon\"";
        html += " :suffix-icon=\"suffixIcon\"";
        html += " :placeholder=\"description\"";
        html += " :fetch-suggestions=\"$fetchSuggestions\"";
        html += " :hide-loading=\"false\"";
        html += " :disabled=\"disabled\"";
        html += " :popper-append-to-body=\"false\"";

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });
        // this.options.elEvents.forEach(function(k){
        //     html += " @"+k+"=\"$loadElEvent('"+k+"')\"";
        // });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }
        if (this.json.elStyles) html += " :style=\"elStyles\"";
        // if (this.json.elStyles){
        //     var style = "";
        //     Object.keys(this.json.elStyles).forEach(function(k){
        //         if (this.json.elStyles[k]) style += k+":"+this.json.elStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-autocomplete>";
        return html;
    }
});

MWF.xDesktop.requireApp("process.Xform", "$ElModule", null, false);
/** @class Elbutton 基于Element UI的按钮组件。
 * @o2cn 按钮组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var button = this.form.get("name"); //获取组件
 * //方法2
 * var button = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/button|Element UI Button 按钮}
 */
MWF.xApplication.process.Xform.Elbutton = MWF.APPElbutton =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elbutton# */
    {
    Implements: [Events],
    Extends: MWF.APP$ElModule,
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member MWF.xApplication.process.Xform.Elbutton#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elbutton").json;       //获取组件的json对象
     * var json = this.form.get("elbutton").vm.$data;   //获取Vue组件的data数据，
     *
     * //通过json对象操作Element组件
     * json.bttype = "success"; //将按钮样式改为success
     * json.loading = true;     //将按钮显示为加载中状态
     * json.disabled = true;    //将按钮设置为禁用
     */

    _appendVueData: function(){
        if (!this.json.size) this.json.size = "";
        if (!this.json.bttype) this.json.bttype = "";
        if (!this.json.plain) this.json.plain = false;
        if (!this.json.round) this.json.round = false;
        if (!this.json.circle) this.json.circle = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.loading) this.json.loading = false;
        if (!this.json.icon) this.json.icon = false;
    },
    _createElementHtml: function(){
        var html = "<el-button";
        html += " :size=\"size\"";
        html += " :type=\"bttype\"";
        html += " :plain=\"plain\"";
        html += " :round=\"round\"";
        html += " :circle=\"circle\"";
        html += " :disabled=\"disabled\"";
        html += " :loading=\"loading\"";
        if( this.json.iconPosition !== "right" )html += " :icon=\"icon\"";

        if (this.json.autofocus==="yes") html += " autofocus";

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";
        // if (this.json.elStyles){
        //     var style = "";
        //     Object.keys(this.json.elStyles).forEach(function(k){
        //         if (this.json.elStyles[k]) style += k+":"+this.json.elStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }

        html += ">"+((this.json.circle!=="yes" && (this.json.isText!=="no" && this.json.isText)) ? (this.json.name || this.json.id) : "");
        if( this.json.iconPosition === "right" )html += "<i class=\""+ this.json.icon +" el-icon--right\"></i>";
        html += "</el-button>";
        return html;
    }
}); 

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elcarousel 基于Element UI的输入框组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|Element UI Tree 树形控件}
 */
MWF.xApplication.process.Xform.Elcarousel = MWF.APPElcarousel =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elcarousel# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 幻灯片切换时触发。this.event[0]为目前激活的幻灯片的索引；
         * @event MWF.xApplication.process.Xform.Elcarousel#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/carousel|幻灯片组件的Events章节}
         */
        "elEvents": ["change"]
    },
    _loadNode: function(){
        this._loadNodeEdit();
    },
    _loadNodeEdit: function(){
        this._createElementHtml().then(function(html){
            var id = (this.json.id.indexOf("..")!==-1) ? this.json.id.replace(/\.\./g, "_") : this.json.id;
            id = (id.indexOf("@")!==-1) ? id.replace(/@/g, "_") : id;
            this.json["$id"] = (id.indexOf("-")!==-1) ? id.replace(/-/g, "_") : id;
            this.node.appendHTML(html, "before");
            var input = this.node.getPrevious();

            this.node.destroy();
            this.node = input;
            this.node.set({
                "id": this.json.id,
                "MWFType": this.json.type
            });
            this.node.addClass("o2_vue");
            this._createVueApp();
        }.bind(this));
    },
    _appendVueData: function(){
        if (!this.json.heightText) this.json.heightText = this.json.height+"px";
        if( !this.json.initialIndex )this.json.initialIndex = 0;
        if( !this.json.carouselType )this.json.carouselType = "";
        if( !this.json.trigger )this.json.trigger = "";
        // if (this.json.dataType === "script"){
        //     this.json.data = this.form.Macro.exec(((this.json.dataScript) ? this.json.dataScript.code : ""), this);
        // }else{
        //     this.json.data = this.json.dataJson;
        // }
        // this.parseData();
    },
    _createElementHtml: function() {
        return this.parseItem().then(function ( data ) {
            var itemHtml = data[0];
            var html = "<el-carousel";
            html += " :height=\"heightText\"";
            html += " :initial-index=initialIndex";
            html += " :trigger=\"trigger\"";
            html += " :autoplay=\"autoplay\"";
            html += " :interval=interval";
            html += " :indicator-position=\"indicatorPosition\"";
            html += " :arrow=\"arrow\"";
            html += " :type=\"carouselType\"";
            html += " :loop=\"loop\"";
            html += " :direction=\"direction\"";

            this.options.elEvents.forEach(function(k){
                html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
            });

            if (this.json.elProperties){
                Object.keys(this.json.elProperties).forEach(function(k){
                    if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
                }, this);
            }

            if (this.json.elStyles) html += " :style=\"elStyles\"";

            html += ">";

            if (this.json.vueSlot){
                html += this.json.vueSlot;
            }else{
                html += itemHtml;
            }

            html += "</el-carousel>";
            return html;
        }.bind(this))
    },
    parseItem: function(){
        return Promise.all([
            this.parseItemHtml(),
            this.parseItemData()
        ]);
    },
    parseItemData: function(){
        if( this.json.dataType === "hotpicture" ) {
            var obj;
            if (this.json.filterScript && this.json.filterScript.code) {
                obj = this.form.Macro.exec(((this.json.filterScript) ? this.json.filterScript.code : ""), this);
            }
            if (obj) obj = {};
            var action = o2.Actions.load("x_hotpic_assemble_control").HotPictureInfoAction.listForPage(this.json.page, this.json.count, obj);
            return action.then(function (json) {
                // var lineHeight = this.json.height ? ( "line-height:"+this.json.height + "px;") : "";
                this.json.items = json.data;
                return this.json.items;
            }.bind(this))
        }else if( this.json.dataType === "source" ){
            return this._getO2Source().then(function (json) {
                var paths = ( this.json.dataItemPath || "data" ).split(".");
                var d = json;
                for(var i=0; i<paths.length; i++){
                    if( d && d[paths[i]] )d = d[paths[i]];
                }
                if( !d )d = [];
                if( o2.typeOf(d) !== "array" )d = [ d ];
                this.json.items = d;
                return this.json.items;
            }.bind(this))
        }else if( this.json.dataType === "script" ){
            var data;
            if (this.json.dataScript && this.json.dataScript.code) {
                data = this.form.Macro.exec(((this.json.dataScript) ? this.json.dataScript.code : ""), this);
            }
            if( !data ){
                return;
            }else if (typeof data.then !== 'function') {
                data = Promise.resolve(data);
            }
            return data.then(function ( d ) {
                var paths = ( this.json.scriptDataItemPath || "data" ).split(".");
                for(var i=0; i<paths.length; i++){
                    if( d && d[paths[i]] )d = d[paths[i]];
                }
                if( !d )d = [];
                if( o2.typeOf(d) !== "array" )d = [ d ];
                this.json.items = d;
                return this.json.items;
            }.bind(this))
        }
    },
    parseItemHtml: function(data){
        var html = "";
        if( this.json.dataType === "hotpicture" ){
            // if( !this.json.contentType || this.json.contentType === "config" ){
                if( (!this.json.contentConfig || !this.json.contentConfig.length) ){
                    html += "<el-carousel-item v-for=\"item in items\">";
                    html +=     "<img :src=\"getImageSrc(item.picId)\"  @click=\"clickHotpictureItem(item, $event)\" style=\"height: 100%; width:100%\"/>";
                    html +=     "<div style=\"line-height:30px;height: 30px;width:100%;text-align: center;position: absolute;bottom:0px;left:0px;color:#fff;background: rgba(104, 104, 104, 0.5);\">{{item.title}}</div>";
                    html += "</el-carousel-item>";
                    return html;
                }else{
                    return this.parseContentConfig()
                }
            // }
        }else{ //if( this.json.contentType === "config" ){
            return this.parseContentConfig()
        }
    },
    parseContentConfig: function(){
        var _self = this;
        var html = "";
        html += "<el-carousel-item v-for=\"item in items\">";
        this.configFun = {};
        this.json.contentConfig.each(function (config, i) {
            var srcFunName, textFunName, clickFunName, srcHtml = "", clickHtml = "", textHtml="";
            if( config.type === "img" && config.srcScript && config.srcScript.code) {
                srcFunName = "getImageSrc_" + i;
                srcHtml = " :src=\"" + srcFunName + "(item)\"";
                this.configFun[srcFunName] = function (item) {
                    return _self.form.Macro.fire(this.srcScript.code, _self, item);
                }.bind(config);
            }
            if( config.clickScript && config.clickScript.code ){
                clickFunName = "click_"+i;
                clickHtml = " @click=\""+clickFunName+"(item, $event)\"";
                this.configFun[clickFunName] = function (item, ev) {
                    return _self.form.Macro.fire(this.clickScript.code, _self, [item, ev]);
                }.bind(config);
            }
            if( config.type === "text" && config.textScript && config.textScript.code) {
                textFunName = "getText_" + i;
                textHtml = "{{"+textFunName+"(item)}}";
                this.configFun[textFunName] = function (item) {
                    return _self.form.Macro.fire(this.textScript.code, _self, item);
                }.bind(config);
            }
            if( config.type === "img" ){
                html +=  "<img" + srcHtml + clickHtml +" style=\""+this.jsonToStyle(config.styles)+"\"/>";
            }else{
                html +=  "<div"+ clickHtml +" style=\""+this.jsonToStyle(config.styles)+"\">"+textHtml+"</div>";
            }
        }.bind(this));
        html += "</el-carousel-item>";
        return html;
    },
    _afterCreateVueExtend: function (app) {
        var _self = this;
        var flag = false;
        if( this.json.dataType === "hotpicture" ) {
            // if (this.json.contentType === "config") {
                if( (!this.json.contentConfig || !this.json.contentConfig.length) ) {
                    app.methods.clickHotpictureItem = function (item, ev) {
                        if (item.application === "CMS") {
                            _self.openDocument(item.infoId, item.title)
                        } else if (item.application === "BBS") {
                            _self.openBBSDocument(item.infoId);
                        }
                    };
                    app.methods.getImageSrc = function (picId) {
                        return MWF.xDesktop.getImageSrc(picId);
                    }
                    flag = true;
                }
            // }
        }
        if( !flag && this.configFun ){
            Object.each(this.configFun, function (fun, key) {
                app.methods[key] = function (item, ev) {
                    return fun(item, ev);
                }.bind(this)
            })
        }
    },

    jsonToStyle: function(styles){
        var style = "";
        for( var key in styles ){
            style += key+":"+styles[key]+";";
        }
        return style;
    },
    _getO2Source: function(){
        this._getO2Address();
        this._getO2Uri();
        return MWF.restful(this.json.httpMethod, this.uri, JSON.encode(this.body), function(json){
            return json;
        }.bind(this), true, true);
    },
    _getO2Address: function(){
        try {
            this.json.service = JSON.parse(this.json.contextRoot);
        }catch(e){
            this.json.service = {"root": this.json.contextRoot, "action":"", "method": "", "url": ""};
        }
        var addressObj = layout.serviceAddressList[this.json.service.root];
        var defaultPort = layout.config.app_protocol==='https' ? "443" : "80";
        if (addressObj){
            var appPort = addressObj.port || window.location.port;
            this.address = layout.config.app_protocol+"//"+(addressObj.host || window.location.hostname)+((!appPort || appPort.toString()===defaultPort) ? "" : ":"+appPort)+addressObj.context;
        }else{
            var host = layout.desktop.centerServer.host || window.location.hostname;
            var port = layout.desktop.centerServer.port || window.location.port;
            this.address = layout.config.app_protocol+"//"+host+((!port || port.toString()===defaultPort) ? "" : ":"+port)+"/"+this.json.service.root;
        }
    },
    _getO2Uri: function(){
        //var uri = this.json.path || this.json.selectPath;
        var uri = this.json.path;
        var pars = {};
        if (this.json.parameters){
            Object.each(this.json.parameters, function(v, key){
                if (uri.indexOf("{"+key+"}")!=-1){
                    var reg = new RegExp("{"+key+"}", "g");
                    uri = uri.replace(reg, encodeURIComponent((v && v.code) ? (this.form.Macro.exec(v.code, this) || "") : v));
                }else{
                    pars[key] = v;
                }
            }.bind(this));
        }

        var data = null;
        if (this.json.requestBody){
            if (this.json.requestBody.code){
                data = this.form.Macro.exec(this.json.requestBody.code, this)
            }
        }

        if (this.json.httpMethod=="GET" || this.json.httpMethod=="OPTIONS" || this.json.httpMethod=="HEAD" || this.json.httpMethod=="DELETE"){
            var tag = "?";
            if (uri.indexOf("?")!=-1) tag = "&";
            Object.each(pars, function(v, k){
                var value = (v && v.code) ? (this.form.Macro.exec(v.code, this) || "") : v;
                uri = uri+tag+k+"="+value;
            }.bind(this));
        }else{
            Object.each(pars, function(v, k){
                if (!data) data = {};
                var value = (v && v.code) ? (this.form.Macro.exec(v.code, this) || "") : v;
                data[k] = value;
            }.bind(this));
        }
        this.body = data;
        this.uri = this.address+uri;
    },

    openDocument: function(id, title, options){
        var op = options || {};
        op.documentId = id;
        op.docTitle = title;
        op.appId = (op.appId) || ("cms.Document"+id);
        return layout.desktop.openApplication(null, "cms.Document", op);
    },
    openBBSDocument: function(id){
        var appId = "ForumDocument"+id;
        if (layout.desktop.apps && layout.desktop.apps[appId]){
            layout.desktop.apps[appId].setCurrent();
        }else {
            return layout.desktop.openApplication(null, "ForumDocument", {
                "id" : id,
                "appId": appId,
                "isEdited" : false,
                "isNew" : false
            });
        }
    }

});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elcascader 基于Element UI的级联选择框组件。
 * @o2cn 级联选择框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|Element UI Cascader 级联选择器}
 */
MWF.xApplication.process.Xform.Elcascader = MWF.APPElcascader =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elcascader# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        /**
         * 组件加载后触发。如果选项加载为异步，则异步处理完成后触发此事件
         * @event MWF.xApplication.process.Xform.Elcascader#load
         */
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当获得焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elcascader#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|级联选择框的Cascader Events章节}
         */
        /**
         * 当失去焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elcascader#blur
         * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|级联选择框的Cascader Events章节}
         */
        /**
         * 当选中节点变化时触发。this.event[0]为选中节点的值
         * @event MWF.xApplication.process.Xform.Elcascader#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|级联选择框的Cascader Events章节}
         */
        /**
         * 下拉框出现/隐藏时触发。this.event[0]的值：出现则为 true，隐藏则为 false
         * @event MWF.xApplication.process.Xform.Elcascader#visible-change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|级联选择框的Cascader Events章节}
         */
        /**
         * 在多选模式下，移除Tag时触发。this.event[0]为移除的Tag对应的节点的值
         * @event MWF.xApplication.process.Xform.Elcascader#remove-tag
         * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|级联选择框的Cascader Events章节}
         */
        /**
         * 当展开节点发生变化时触发。this.event[0]指向各父级选项值组成的数组
         * @event MWF.xApplication.process.Xform.Elcascader#expand-change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|级联选择框的Cascader Events章节}
         */
        /**
         * 过滤函数调用之前的钩子函数。this.event[0]指向value参数：如果该函数的返回值是 false 或者是一个被拒绝的Promise，那么接下来的过滤便不会执行。
         * @event MWF.xApplication.process.Xform.Elcascader#before-filter
         * @see {@link https://element.eleme.cn/#/zh-CN/component/cascader|级联选择框的Cascader Events章节}
         */
        "elEvents": ["focus", "blur", "change", "visible-change", "remove-tag", "expand-change", "before-filter"]
    },
    // _loadNode: function(){
    //     if (this.isReadonly()) this.json.disabled = true;
    //     this._loadNodeEdit();
    // },
    resetOption: function(){
        this.reload();
    },
    _loadMergeReadContentNode: function( contentNode, data ){
        this._loadOptions();
        Promise.resolve(this.json.options).then(function(options){
            if (data.data){
                var text = this.__getOptionsText(options, data.data);
                contentNode.set("text", text);
            }
        }.bind(this));
    },
    _appendVueData: function(){
        this.form.Macro.environment.data.check(this.json.id);
        this.json[this.json.id] = this._getBusinessData();

        if (!this.json.options) this.json.options = [];
        if (!this.json.clearable) this.json.clearable = false;
        if (!this.json.size) this.json.size = "";
        if (!this.json.popperClass) this.json.popperClass = "";
        if (this.json.showAllLevels!==false) this.json.showAllLevels = true;
        if (!this.json.separator) this.json.separator = "/";
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.description) this.json.description = "";
        if (!this.json.filterable) this.json.filterable = false;
        if (!this.json.collapseTags) this.json.collapseTags = false;
        if (!this.json.props) this.json.props = {};

        if (!this.json.props.expandTrigger) this.json.props.expandTrigger = "click";
        if (!this.json.props.multiple) this.json.props.multiple = false;
        if (this.json.props.emitPath!==false) this.json.props.emitPath = true;
        if (!this.json.props.lazy) this.json.props.lazy = false;
        if (!this.json.props.lazyLoad) this.json.props.lazyLoad = null;
        if (!this.json.props.value) this.json.props.value = "value";
        if (!this.json.props.label) this.json.props.label = "label";
        if (!this.json.props.children) this.json.props.children = "children";
        if (!this.json.props.disabled) this.json.props.disabled = "disabled";
        if (!this.json.props.leaf) this.json.props.leaf = "leaf";

        this._loadOptions();

        //if (this.json.props.multiple===true) if (!this.json[this.json.id] || !this.json[this.json.id].length) this.json[this.json.id] = [];
        if (this.json.props.multiple===true) if (!this.json[this.json.$id] || !this.json[this.json.$id].length) this.json[this.json.$id] = [];
    },
    appendVueMethods: function(methods){
        if (this.json.filterMethod && this.json.filterMethod.code){
            var fn = this.form.Macro.exec(this.json.filterMethod.code, this);
            methods.$filterMethod = function(){
                return fn.apply(this, arguments);
            }.bind(this);
        }

        this.loadedOptionsMap = {};
        if (this.json.lazyLoadScript && this.json.lazyLoadScript.code){
            var fn = this.form.Macro.exec(this.json.lazyLoadScript.code, this);
            this.json.props.lazyLoad = function(node, resolve){
                fn.apply(this, [node, function (json){
                    var key = node.path.join(this.json.separator);
                    this.loadedOptionsMap[key] = json;
                    resolve(json);
                }.bind(this)]);
            }.bind(this);
        }

        if (this.json.beforeFilter && this.json.beforeFilter.code){
            var fn = this.form.Macro.exec(this.json.beforeFilter.code, this);
            methods.$beforeFilter = function(){
                fn.apply(this, arguments);
            }.bind(this);
        }
    },

    _setOptionsWithCode: function(code){
        var v = this.form.Macro.exec(code, this);
        if (v.then){
            this.moduleSelectAG = v.then(function(o){
                if (o2.typeOf(o)==="array"){
                    this.json.options = o;
                    this.json.$options = o;
                }
                return this.json.options || [];
            }.bind(this));
        }else if (o2.typeOf(v)==="array"){
            this.json.options = v;
            this.json.$options = v;
        }
    },
    _loadOptions: function(){
        if (this.json.itemsScript && this.json.itemsScript.code)  this._setOptionsWithCode(this.json.itemsScript.code);
    },
    _createElementHtml: function(){

        if (!this.json.options) this.json.options = [];
        if (!this.json.clearable) this.json.clearable = false;
        if (!this.json.size) this.json.size = "";
        if (!this.json.popperClass) this.json.popperClass = "";
        if (this.json.showAllLevels!==false) this.json.showAllLevels = true;
        if (!this.json.separator) this.json.separator = "/";
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.description) this.json.description = "";
        if (!this.json.filterable) this.json.filterable = false;
        if (!this.json.props) this.json.props = {};

        var html = "<el-cascader ";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :clearable=\"clearable\"";
        html += " :size=\"size\"";
        html += " :filterable=\"filterable\"";
        html += " :disabled=\"disabled\"";
        html += " :placeholder=\"description\"";
        html += " :options=\"options\"";
        html += " :collapse-tags=\"collapseTags\"";
        html += " :show-all-levels=\"showAllLevels\"";
        html += " :separator=\"separator\"";
        html += " :popper-class=\"popperClass\"";
        html += " :props=\"props\"";

        if (this.json.filterMethod && this.json.filterMethod.code){
            html += " :filter-method=\"$filterMethod\"";
        }
        if (this.json.beforeFilter && this.json.beforeFilter.code){
            html += " :before-filter=\"$beforeFilter\"";
        }

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";
        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-cascader >";
        return html;
    },
    //__setReadonly: function(data){},
    getCheckedNodes: function(leafOnly){
        return (this.vm) ? this.vm.getCheckedNodes(leafOnly) : null;
    },
    __setReadonly: function(data){
        if (this.isReadonly()){
            this._loadOptions();
            this.fireEvent("postLoad");
            Promise.resolve(this.json.options || this.moduleSelectAG).then(function(options){
                if (data){
                    var text = this.__getOptionsText(options, data);
                    this.node.set("text", text);
                    if( this.json.elProperties ){
                        this.node.set(this.json.elProperties );
                    }
                    if (this.json.elStyles){
                        this.node.setStyles( this._parseStyles(this.json.elStyles) );
                    }

                    if( !this.eventLoaded ){
                        this._loadDomEvents();
                        this.eventLoaded = true;
                    }

                    this.fireEvent("load");
                    this.isLoaded = true;
                }
            }.bind(this));
        }
    },
    __getOptionsText: function(options, values, isGetArray){
        if (!!this.json.props.multiple){
            var text = [];
            values.forEach(function(v){
                if( typeOf( v ) === "array" ){
                    text = text.concat(this.__getOptionsTextValue(options, v));
                }else{
                    text = text.concat(this.__getLastOptionsTextValue(options, v));
                }
            }.bind(this));
            return isGetArray ? text : text.join(",");
        }else{
            if( typeOf( values ) === "array" ){
                var arr = this.__getOptionsTextValue(options, values);
                return isGetArray ? arr : arr.join(",");
            }else{
                return this.__getLastOptionsTextValue(options, values)
            }
        }
    },
    __getOptionsTextValue: function(options, values, prefix, prefixLabel){
        var separator = this.json.separator || "/";
        var text = [];
        var v = typeOf( values ) === "string" ? values : values.join(separator);
        options.forEach(function(op){
            var opValue = (prefix) ? prefix + separator + op[this.json.props.value] : op[this.json.props.value];
            var opLabel = (prefixLabel) ? prefixLabel + separator + op[this.json.props.label] : op[this.json.props.label];
            if (opValue == v) {
                text.push(opLabel);
            }else if (v.startsWith(opValue)){
                var children = op[this.json.props.children] || this.loadedOptionsMap[opValue];
                if( children && children.length ){
                    text = text.concat(this.__getOptionsTextValue(children, values, opValue, opLabel));
                }
            }
        }.bind(this));
        if (!this.json.showAllLevels){
            return text.map(function(t){
                return t.substring(t.indexOf(separator)+1, t.length);
            });
        }else{
            return text;
        }
    },
    __getLastOptionsTextValue: function (options, value, key) {
        var text;
        for( var i=0; i<options.length; i++ ){
            var op = options[i];
            var k = (key ? key + '/' : '') + op[this.json.props.value];
            var children = op[this.json.props.children] || this.loadedOptionsMap[k];
            if( children && children.length ){
                text = this.__getLastOptionsTextValue( children, value, k);
                if( text )return text;
            }else{
                var opValue = op[this.json.props.value];
                var opLabel = op[this.json.props.label];
                if( opValue === value ){
                   return opLabel;
                }
            }
        }
        return text;
    },

        getDataByText: function(text){
            this._loadOptions();
            var opt = this.json.options;
            if( !opt )return "";
            if( o2.typeOf(opt.then)==="function" ){
                return Promise.resolve(opt).then(function(options){
                    return this._getDataByText(options, text);
                }.bind(this));
            }else{
                return this._getDataByText(opt, text);
            }
        },
        _getDataByText: function(options, text){
            var values = [];
            if (!!this.json.props.multiple){
                var texts = typeOf( text ) === "array" ? text : [text];
                texts.forEach(function(t){
                    if( typeOf( t ) === "array" && t.length > 1 ){
                        values = values.concat(this._getEachDataByText(options, t));
                    }else{
                        values = values.concat(this._getLastDataByText(options, typeOf( t ) === "array" ? (t[0] || "") : t));
                    }
                }.bind(this));
                return values;
            }else{
                if( typeOf( text ) === "array" && typeOf( text[0] ) === "array" ){
                    text = text[0];
                }
                if( typeOf( text ) === "array" && text.length > 1 ){
                    values = this._getEachDataByText(options, text);
                    return values.length ? values[0] : [];
                }else{
                    return this._getLastDataByText(options, typeOf( text ) === "array" ? (text[0] || "") : text);
                }
            }
        },
        _getEachDataByText: function(options, texts, prefix, prefixLabel){
            var separator = this.json.separator || "/";
            var value = [];
            var t = typeOf( texts ) === "string" ? texts : texts.join(separator);
            options.forEach(function(op){
                var opValue = (prefix) ? prefix + separator + op[this.json.props.value] : op[this.json.props.value];
                var opLabel = (prefixLabel) ? prefixLabel + separator + op[this.json.props.label] : op[this.json.props.label];
                if (opLabel === t) {
                    value.push(opValue.split(separator));
                }else if (t.startsWith(opLabel) && op[this.json.props.children] && op[this.json.props.children].length){
                    value = value.concat(this._getEachDataByText(op[this.json.props.children], texts, opValue, opLabel));
                }
            }.bind(this));
            if (!this.json.showAllLevels){
                return value.map(function(t){
                    return typeOf( t ) === "array" ? t.getLast() : t;
                });
            }else{
                return value;
            }
        },
        _getLastDataByText: function (options, text) {
            var value;
            for( var i=0; i<options.length; i++ ){
                var op = options[i];
                if( op[this.json.props.children] && op[this.json.props.children].length ){
                    value = this._getLastDataByText( op[this.json.props.children], text );
                    if( value )return value;
                }else{
                    var opValue = op[this.json.props.value];
                    var opLabel = op[this.json.props.label];
                    if( opLabel === text ){
                        value = opValue;
                    }
                }
            }
            return value;
        },

        /**
         * @summary 获取选中项的text。
         * @return {Array} 返回选中项的text数组
         * @example
         * var texts = this.form.get('fieldId').getText(); //获取选中项的文本数组
         */
        getText: function(){
            return this._getText( true );
        },
        _getText: function( isGetArray ){
            var data = this.json[this.json.$id];
            if( !data )return "";

            var opt = this.json.options;
            if( !opt )return "";
            if( o2.typeOf(opt.then)==="function" ){
                return Promise.resolve(opt).then(function(options){
                    return this.__getOptionsText(options, data, isGetArray);
                }.bind(this));
            }else{
                return this.__getOptionsText(opt, data, isGetArray);
            }
        },

        getExcelData: function( type ){
            var data = this.json[this.json.$id];
            if( !data )return "";
		    if( type === "value" )return data;

            var text = this._getText();
            return typeOf(text) === "array" ? text.join(", ") : (text || "");
        },
        setExcelData: function(d, type){
            var separator = this.json.separator || "/";
            var arr = this.stringToArray(d);
            this.excelData = arr;
            arr = arr.map(function (a) {
                return a.contains(separator) ? a.split(separator) : a;
            });
            if( type === "value" ){
                this.setData(arr);
            }else{
                var data = this.getDataByText( arr );
                this.setData(data);
            }
        }
});

MWF.xDesktop.requireApp("process.Xform", "Elradio", null, false);
/** @class Elradio 基于Element UI的多选组件。
 * @o2cn 多选组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var radio = this.form.get("name"); //获取组件
 * //方法2
 * var radio = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.Elradio
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/checkbox|Element UI Checkbox 多选框}
 */
MWF.xApplication.process.Xform.Elcheckbox = MWF.APPElcheckbox =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elcheckbox# */
    {
    Implements: [Events],
    Extends: MWF.APPElradio,
    options: {
        /**
         * 组件加载前触发。当前组件的queryLoad事件还没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取当前组件。
         * @event MWF.xApplication.process.Xform.Elcheckbox#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发。如果选项加载为异步，则异步处理完成后触发此事件
         * @event MWF.xApplication.process.Xform.Elcheckbox#load
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.Elcheckbox#postLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "change"],
        /**
         * 当绑定值变化时触发的事件。this.event[0]为更新后的值
         * @event MWF.xApplication.process.Xform.Elcheckbox#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/checkbox|多选框的Checkbox Events章节}
         */
        "elEvents": ["change"]
    },
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member MWF.xApplication.process.Xform.Elradio#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elcheckbox").json;       //获取组件的json对象
     * var json = this.form.get("elcheckbox").vm.$data;   //获取Vue组件的data数据，
     *
     * //通过json对象操作Element组件
     * json.border = true;      //带边框的多选按钮
     * json.size = "small";     //设置多选按钮大小，仅border为true时有效
     * json.textColor = "#ff0000";  //设置按钮样式时，选中状态的文本颜色
     * json.fillColor = "#ff0000";  //设置按钮样式时，选中状态的背景颜色
     */
    load: function(){
        this._loadModuleEvents();
        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
        }
    },
    _loadNode: function(){
        this.node.empty();
        if (this.isReadonly()){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    _loadMergeReadContentNode: function( contentNode, data ){
        this._showValue(contentNode, data.data)
    },
    _loadMergeEditNodeByDefault: function(){
        var data = this.getSortedSectionData();
        var businessData = [];
        data.each(function(d){
            businessData = businessData.concat( d.data || [] );
        });
        this._setBusinessData( businessData );
        this._loadNode();
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        var value = this.getValue();
        this._showValue(this.node, value);
        if( this.json.elProperties ){
            this.node.set(this.json.elProperties );
        }
        if (this.json.elStyles){
            this.node.setStyles( this._parseStyles(this.json.elStyles) );
        }

        if( !this.eventLoaded ){
            this._loadDomEvents();
            this.eventLoaded = true;
        }

        this.fireEvent("postLoad");
        if( this.moduleSelectAG && typeOf(this.moduleSelectAG.then) === "function" ){
            this.moduleSelectAG.then(function () {
                this.fireEvent("load");
                this.isLoaded = true;
            }.bind(this));
        }else{
            this.fireEvent("load");
            this.isLoaded = true;
        }
    },
    __showValue: function(node, value, optionItems){
        if (value){
            var texts = [];
            optionItems.each(function(item){
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                if (value.indexOf(v)!=-1){
                    texts.push(t || v);
                }
            });
            node.set("text", texts.join(", "));
        }
    },
    _resetNodeEdit: function(){
        var div = new Element("div");
        div.inject(this.node, "after");
        this.node.destroy();
        this.node = div;
    },
    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        this.setOptions();
    },

    setOptions: function(){
        var optionItems = this.getOptions();
        this._setOptions(optionItems);
    },

    _setOptions: function(optionItems){
        var p = o2.promiseAll(optionItems).then(function(radioValues){
            //this.moduleSelectAG = null;
            return this._loadElradio(radioValues);
        }.bind(this), function(){
            this.moduleSelectAG = null;
        }.bind(this));
        this.moduleSelectAG = Promise.resolve(p);
    },

    _loadElradio: function(radioValues){
        return new Promise(function(resolve){
            if (radioValues && o2.typeOf(radioValues)==="array"){
                this.node.appendHTML(this._createElementHtml(radioValues), "before");
                var button = this.node.getPrevious();

                this.node.destroy();
                this.node = button;
                this.node.set({
                    "id": this.json.id,
                    "MWFType": this.json.type
                });
                this._createVueApp(resolve);
            }
        }.bind(this));
    },

    _createElementHtml: function(radioValues){
        if (!this.json.disabled) this.json.disabled = false;

        var id = (this.json.id.indexOf("..")!==-1) ? this.json.id.replace(/\.\./g, "_") : this.json.id;
        id = (id.indexOf("@")!==-1) ? id.replace(/@/g, "_") : id;
        this.json["$id"] = (id.indexOf("-")!==-1) ? id.replace(/-/g, "_") : id;
        var html = "<el-checkbox-group class='o2_vue' style='box-sizing: border-box!important'";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :text-color=\"textColor\"";
        html += " :fill=\"fillColor\"";
        html += " :size=\"size\"";
        html += " :disabled=\"disabled\"";
        html += " @change=\"change\"";


        if (this.json.elGroupProperties){
            Object.keys(this.json.elGroupProperties).forEach(function(k){
                if (this.json.elGroupProperties[k]) html += " "+k+"=\""+this.json.elGroupProperties[k]+"\"";
            }, this);
        }
        // if (this.json.elGroupStyles){
        //     var style = "";
        //     Object.keys(this.json.elGroupStyles).forEach(function(k){
        //         if (this.json.elGroupStyles[k]) style += k+":"+this.json.elGroupStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }
        if (this.json.elGroupStyles) html += " :style=\"elGroupStyles\"";

        html += " >";

        radioValues.each(function(item){
            var tmps = item.split("|");
            var text = tmps[0];
            var value = tmps[1] || text;

            html += (this.json.buttonRadio) ? "<el-checkbox-button" : "<el-checkbox";
            html += " label=\""+value+"\"";
            html += " :border=\"border\"";

            if (this.json.elProperties){
                Object.keys(this.json.elProperties).forEach(function(k){
                    if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
                }, this);
            }

            // var radiostyle = "box-sizing: border-box!important;";
            // if (this.json.elStyles){
            //     Object.keys(this.json.elStyles).forEach(function(k){
            //         if (this.json.elStyles[k]) radiostyle += k+":"+this.json.elStyles[k]+";";
            //     }, this);
            // }
            // html += " style=\""+radiostyle+"\"";
            if (this.json.elStyles) html += " :style=\"elStyles\"";

            html += " >"+text;
            html += (this.json.buttonRadio) ? "</el-checkbox-button>" : "</el-checkbox>";
        }.bind(this));
        html += "</el-checkbox-group>";
        return html;
    },

        _setValue: function(value, m){
            var mothed = m || "__setValue";
            if (!!value){
                var p = o2.promiseAll(value).then(function(v){
                    //if (o2.typeOf(v)=="array") v = v[0];
                    if (this.moduleSelectAG){
                        this.moduleValueAG = this.moduleSelectAG;
                        this.moduleSelectAG.then(function(){
                            this[mothed](v);
                            return v;
                        }.bind(this), function(){});
                    }else{
                        this[mothed](v)
                    }
                    return v;
                }.bind(this), function(){});
                this.moduleValueAG = p;
                if (this.moduleValueAG) this.moduleValueAG.then(function(){
                    this.moduleValueAG = null;
                }.bind(this), function(){
                    this.moduleValueAG = null;
                }.bind(this));
            }else{
                this[mothed](value);
            }
        },
    __setValue: function(value){
        this._setBusinessData(value);
        this.json[this.json.$id] = (value) ? value : [];
    },
    __setData: function(data){
        this._setBusinessData(data);
        this.json[this.json.$id] = data;
        this.validationMode();
        this.fireEvent("setData");
    },


    _createVueApp: function(callback){
        if (!this.vm){
            this._loadVue(function(){
                this._mountVueApp(callback);
            }.bind(this));
        }else{
            if (callback) callback();
        }
    },

    // _loadVue: function(callback){
    //     if (!window.Vue){
    //         var vue = (o2.session.isDebugger) ? "vue_develop" : "vue";
    //         o2.loadAll({"css": "../o2_lib/vue/element/index.css", "js": [vue, "elementui"]}, { "sequence": true }, callback);
    //     }else{
    //         if (callback) callback();
    //     }
    // },
    _mountVueApp: function(callback){
        if (!this.vueApp) this.vueApp = this._createVueExtend(callback);

        /**
         * @summary Vue对象实例
         * @see https://vuejs.org/
         * @member {VueInstance}
         */
        this.vm = new Vue(this.vueApp);
        this.vm.$mount(this.node);
    },

    _createVueExtend: function(callback){
        var _self = this;
        return {
            data: this._createVueData(),
            mounted: function(){
                _self._afterMounted(this.$el);
                if (callback) callback();
            },
            methods: {
                change: function(v){
                    _self.validationMode();
                    if (_self.validation()) {
                        _self._setBusinessData(v || []);
                        _self.fireEvent("change");
                    }
                }
            }
        };
    },
    _createVueData: function(){
        if (this.json.$id===this.json.id) this.form.Macro.environment.data.check(this.json.$id);
        this.json[this.json.$id] = this._getBusinessData();
        if (!this.json[this.json.$id] || !this.json[this.json.$id].length) this.json[this.json.$id] = [];

        if (this.json.vueData && this.json.vueData.code){
            var d = this.form.Macro.exec(this.json.vueData.code, this);
            this.json = Object.merge(d, this.json);
        }

        if (!this.json.textColor) this.json.textColor = "";
        if (!this.json.fillColor) this.json.fillColor = "";
        if (!this.json.size) this.json.size = "";

        return this.json;
    },
    _afterMounted: function(el){
        this.node = el;
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this._loadVueCss();
        this._loadDomEvents();
        this._afterLoaded();
        this.fireEvent("postLoad");
        this.fireEvent("load");
    },

    getInputData: function(){
        return this.json[this.json.$id];
    },

    /**
     * @summary 获取选中项的text。
     * @return {String[]} 返回选中项的text数组
     * @example
     * var texts = this.form.get('fieldId').getText(); //获取选中项的文本数组
     */
    getText: function(){
        var d = this.getTextData();
        if( typeOf(d.then) === "function" ){
            return d.then(function( d1 ){
                var texts = d1.text;
                return (texts && texts.length) ? texts : [];
            })
        }else{
            var texts = d.text;
            return (texts && texts.length) ? texts : [];
        }
    },

    _loadVueCss: function(){
        if (this.styleNode){
            this.node.removeClass(this.styleNode.get("id"));
        }
        if (this.json.vueCss && this.json.vueCss.code){
            this.styleNode = this.node.loadCssText(this.json.vueCss.code, {"notInject": true});
            this.styleNode.inject(this.node, "before");
        }
    },

        getExcelData: function( type ){
            var value = this.getData();
            if( type === "value" )return value;

            var options = this.getOptionsObj();
            return Promise.resolve(options).then(function (opts) {
                value = o2.typeOf(value) === "array" ? value : [value];
                var arr = [];
                value.each( function( a, i ){
                    var idx = opts.valueList.indexOf( a );
                    var text = idx > -1 ? opts.textList[ idx ] : "";
                    if( !text )text = value;
                    arr.push( text );
                });
                return arr.join(", ");
            });
        },
        setExcelData: function(d, type){
            var arr = this.stringToArray(d);
            this.excelData = arr;
            if( type === "value" ){
                this.setData(value, true);
            }else{
                var options = this.getOptionsObj();
                this.moduleExcelAG = Promise.resolve(options).then(function (opts) {
                    arr.each( function( a, i ){
                        var idx = opts.textList.indexOf( a );
                        var v = idx > -1 ? opts.valueList[ idx ] : null;
                        arr[ i ] = v || a;
                    });
                    arr.clean();
                    this.json[this.json.$id] = arr;
                    this._setBusinessData(arr);
                    this.setData(arr, true);
                    this.moduleExcelAG = null;
                }.bind(this));
            }
        }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elinput 基于Element UI的颜色选择组件。
 * @o2cn 颜色选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/color-picker|Element UI ColorPicker 颜色选择器}
 */
MWF.xApplication.process.Xform.Elcolorpicker = MWF.APPElcolorpicker =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elcolorpicker# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],

        /**
         * 	当绑定值变化时触发。this.event[0]为当前值
         * @event MWF.xApplication.process.Xform.Elcolorpicker#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/color-picker|颜色选择组件的Events章节}
         */

        /**
         * 面板中当前显示的颜色发生改变时触发。this.event[0]当前显示的颜色值
         * @event MWF.xApplication.process.Xform.Elcolorpicker#active-change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/color-picker|颜色选择组件的Events章节}
         */
        "elEvents": ["change","active-change"]
    },
    _loadMergeReadContentNode: function( contentNode, data ){
        // var d = o2.typeOf( data.data ) === "array" ? data.data : [data.data];
        // contentNode.set("text", d.join( this.json.rangeSeparator ? " "+this.json.rangeSeparator+" " : " 至 " ) );

        var _self = this;

        var json = Object.clone(this.json);
        json.isReadonly = true;
        var id = this.json.id + "_" + data.key.replace(/-/g, "_");
        json.id = id;

        this._setBusinessData(data.data, id);

        var html = this.node.get("html");
        contentNode.set("html", html);
        var style = this.node.get("style");
        contentNode.set("style", style);
        contentNode.set("id", id);

        if (this.form.all[id]) this.form.all[id] = null;
        if (this.form.forms[id])this.form.forms[id] = null;

        var module = this.form._loadModule(json, contentNode, function () {
            this.field = false;
            if( _self.widget )this.widget = _self.widget;
        });
        this.form.modules.push(module);
        this.form.addEvent("getData", function (data) {
            if( data[id] )delete data[id];
        })
    },
    __setReadonly: function(data){
        if (this.isReadonly()) {
            this.node.set("text", data);
            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }

        }
    },
    _loadNode: function(){
        if (this.isReadonly()) this.json.disabled = true;
        this._loadNodeEdit();
    },
    _appendVueData: function(){
        if (!this.json.isReadonly && !this.form.json.isReadonly) this.json.isReadonly = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.showAlpha) this.json.showAlpha = false;
        if (!this.json.colorFormat) {
            if( this.json.showAlpha ){
                this.json.colorFormat = "hex";
            }else{
                this.json.colorFormat = "rgb";
            }
        }

    },
    // appendVueExtend: function(app){
    //     if (!app.methods) app.methods = {};
    //     app.methods.$loadElEvent = function(ev){
    //         this.validationMode();
    //         if (ev==="change") this._setBusinessData(this.getInputData());
    //         if (this.json.events && this.json.events[ev] && this.json.events[ev].code){
    //             this.form.Macro.fire(this.json.events[ev].code, this, event);
    //         }
    //     }.bind(this);
    // },
    _createElementHtml: function(){
        var html = "<el-color-picker";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :readonly=\"isReadonly\"";
        html += " :disabled=\"disabled\"";
        html += " :show-alpha=\"showAlpha\"";
        html += " :color-format=\"colorFormat\"";

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-color-picker>";
        return html;
    }
});

o2.xDesktop.requireApp("process.Xform", "$Module", null, false);
o2.xDesktop.requireApp("process.Xform", "$ElModule", null, false);
/** @class Elcommon 基于Element UI的通用组件。
 * @o2cn 通用组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var button = this.form.get("name"); //获取组件
 * //方法2
 * var button = this.target; //在组件事件脚本中获取
 * @extends o2.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
o2.xApplication.process.Xform.Elcommon = o2.APPElcommon =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elcommon# */
    {
    Implements: [Events],
    Extends: o2.APP$ElModule,
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member o2.xApplication.process.Xform.Elcommon#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elcommon").json;       //获取组件的json对象
     * var json = this.form.get("elcommon").vm.$data;   //获取Vue组件的data数据，
     *
     */
    // load: function(){
    //     this._loadModuleEvents();
    //     if (this.fireEvent("queryLoad")){
    //         this._queryLoaded();
    //         this._loadUserInterface();
    //     }
    // },
    //
    // initialize: function(node, json, form, options){
    //     this.node = $(node);
    //     this.node.store("module", this);
    //     this.json = json;
    //     this.form = form;
    //     this.field = true;
    //     this.parentLine = null;
    // },
    _checkVueHtml: function(){
        var nodes = this.node.querySelectorAll("*[v-model]");
        this.tmpVueData = {};
        var arrs = ["el-checkbox-group"];
        nodes.forEach(function(node){
            var model = node.get("v-model");
            if (model) this.tmpVueData[model] = (arrs.indexOf(node.tagName.toString().toLowerCase())===-1) ? "" : [];
        }.bind(this));
    },
    _loadUserInterface: function(){
        this.node.set("html", this._createElementHtml());
        //this._checkVueHtml();
        this._checkVmodel();

        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this.node.addClass("o2_vue");
        this._createVueApp();
    },
    // _createVueApp: function(){
    //     if (!this.vm) this._loadVue(this._mountVueApp.bind(this));
    // },
    //
    // _loadVue: function(callback){
    //     if (!window.Vue){
    //         o2.loadAll({"css": "../o2_lib/vue/element/index.css", "js": ["vue", "elementui"]}, { "sequence": true }, callback);
    //     }else{
    //         if (callback) callback();
    //     }
    // },
    // _mountVueApp: function(){
    //     if (!this.vueApp) this.vueApp = this._createVueExtend();
    //
    //     /**
    //      * @summary Vue对象实例
    //      * @see https://vuejs.org/
    //      * @member {VueInstance}
    //      */
    //     this.vm = new Vue(this.vueApp).$mount(this.node);
    // },

    _createVueExtend: function(){
        // if (this.tmpVueData){
        //     Object.keys(this.tmpVueData).each(function(k){
        //         this.form.Macro.environment.data.check(k, this.tmpVueData[k]);
        //     }.bind(this));
        // }
        if (this.vModels && this.vModels.length){
            this.vModels.forEach(function(m){
                if (!this.json.hasOwnProperty(m)) this.json[m] = "";
            }.bind(this));
        }

        var app = {};
        if (this.json.vueApp && this.json.vueApp.code) app = this.form.Macro.exec(this.json.vueApp.code, this);
        if (!app) app = {};
        if (app.data){
            var ty = o2.typeOf(app.data);
            switch (ty){
                case "object":
                    Object.keys(app.data).each(function(k){
                        this.json[k] = app.data[k];
                        //this.form.Macro.environment.data.add(k, app.data[k]);
                    }.bind(this));
                    app.data = this.json;
                    // app.data = this.json;
                    // app.data = Object.merge(this.json, this.form.Macro.environment.data);
                    break;
                case "function":
                    var dataFun = app.data;
                    var _slef = this;
                    app.data = function(){
                        var d = dataFun();

                        //_self.form.Macro.environment.data.add(_self.json.id, d);

                        Object.keys(d).each(function(k){
                            _self.json[k] = d[k];
                            //_self.form.Macro.environment.data.add(k, d[k]);
                        });
                        //var data = Object.merge(_slef.json);
                        //return _self.form.Macro.environment.data;
                        return _self.json;
                    };
                    break;
            }
        }else{
            //app.data = this.form.Macro.environment.data;
            app.data = this.json;
        }

        var _self = this;
        var mountedFun = app.mounted;
        app.mounted = function(){
            _self._afterMounted(this.$el);
            if (mountedFun && o2.typeOf(mountedFun)=="function") return mountedFun.apply(this);
        };

        this.appendVueWatch(app);

        return app;
    },

    // _afterMounted: function(el){
    //     this.node = el;
    //     this.node.set({
    //         "id": this.json.id,
    //         "MWFType": this.json.type
    //     });
    //     this._loadVueCss();
    //     this._loadDomEvents();
    //     this._afterLoaded();
    //     this.fireEvent("postLoad");
    //     this.fireEvent("load");
    // },
    // _loadVueCss: function(){
    //     if (this.json.vueCss && this.json.vueCss.code){
    //         this.styleNode = this.node.loadCssText(this.json.vueCss.code, {"notInject": true});
    //         this.styleNode.inject(this.node, "before");
    //     }
    // },
    // _filterHtml: function(html){
    //     var tmp = new Element("div", {"html": html});
    //     var nodes = tmp.querySelectorAll("*[v-model]");
    //     this.tmpVueData = {};
    //     nodes.forEach(function(node){
    //         this.tmpVueData[node.get("v-model")] = "";
    //     }.bind(this));
    //     return html;
    // },
    _checkVmodel: function(text){
        // if (text){
        //     this.vModels = [];
        //     var reg = /(?:v-model)(?:.lazy|.number|.trim)?(?:\s*=\s*)(?:["'])?([^"']*)/g;
        //     var arr;
        //     while ((arr = reg.exec(text)) !== null) {
        //         if (arr.length>1 && arr[1]){
        //             var modelId = this.json.id.substring(0, this.json.id.lastIndexOf(".."));
        //             modelId = (modelId) ? modelId+".."+arr[1] : arr[1];
        //             this.json[arr[1]] = this._getBusinessData(modelId);
        //             this.vModels.push(arr[1]);
        //         }
        //     }
        // }
        var nodes = this.node.querySelectorAll("*[v-model]");
        this.vModels = [];
        var arrs = ["el-checkbox-group"];
        nodes.forEach(function(node){
            var model = node.get("v-model");
            var tag = node.tagName.toString().toLowerCase();
            if (model){
                var modelId = this.json.id.substring(0, this.json.id.lastIndexOf(".."));
                modelId = (modelId) ? modelId+".."+model : model;
                this.json[model] = this._getBusinessData(modelId);
                if (!this.json[model]){
                    this.json[model] = (arrs.indexOf(tag)===-1) ? "" : []
                }
                this.vModels.push(model);
            }
        }.bind(this));
    },
    _createElementHtml: function(){
        var html = this.json.vueTemplate || "";
        // if (html) this._checkVmodel(html);
        // return this._filterHtml(html);
        return html;
    },
    resetData: function(){
        if (this.vModels && this.vModels.length){
            this.vModels.forEach(function(m){
                var modelId = this.json.id.substring(0, this.json.id.lastIndexOf(".."));
                modelId = (modelId) ? modelId+".."+m : m;
                this.json[m] = this._getBusinessData(modelId);
            }.bind(this));
        }
    },
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Div 容器组件。
 * @o2cn 容器组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var div = this.form.get("name"); //获取组件
 * //方法2
 * var div = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Elcontainer = MWF.APPElcontainer =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        this.node.addClass("o2_vue");
        var asides = this.node.getElements("aside");
        var headers = this.node.getElements("header");
        var mains = this.node.getElements("main");
        var footers = this.node.getElements("footer");

        if (!this.asides || !this.asides.length) this.asides = [];
        if (!this.headers || !this.headers.length) this.headers = [];
        if (!this.mains || !this.mains.length) this.mains = [];
        if (!this.footers || !this.footers.length) this.footers = [];

        asides.each(function(aside){  this.asides.push(this._loadSubModule(aside)); }.bind(this));
        headers.each(function(header){  this.headers.push(this._loadSubModule(header)); }.bind(this));
        mains.each(function(main){  this.mains.push(this._loadSubModule(main)); }.bind(this));
        footers.each(function(footer){  this.footers.push(this._loadSubModule(footer)); }.bind(this));
    },
    _loadSubModule: function(node){
        var json = this.form._getDomjson(node);
        var module = null;
        if (json){
            var container = this;
            module = this.form._loadModule(json, node, function(){
                this.container = container;
            });
            this.form.modules.push(module);
        }
        return module;
    }
});
MWF.xApplication.process.Xform.Elcontainer$Main = MWF.APPElcontainer$Main =  new Class({
    Extends: MWF.APP$Module
});
MWF.xApplication.process.Xform.Elcontainer$Aside = MWF.APPElcontainer$Aside =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        var css = Object.clone(this.form.css["el-container-aside"]);
        if (this.json.recoveryStyles){
            var keys = Object.keys(css);
            keys.forEach(function(key){
                if (this.json.recoveryStyles[key]) delete css[key];
            }.bind(this))
        }
        this.node.setStyles(css);
    }
});
MWF.xApplication.process.Xform.Elcontainer$Header = MWF.APPElcontainer$Header =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        var css = Object.clone(this.form.css["el-container-header"]);
        if (this.json.recoveryStyles){
            var keys = Object.keys(css);
            keys.forEach(function(key){
                if (this.json.recoveryStyles[key]) delete css[key];
            }.bind(this))
        }
        this.node.setStyles(css);
        //this.node.setStyles(this.form.css["el-container-header"]);
    }
});
MWF.xApplication.process.Xform.Elcontainer$Footer = MWF.APPElcontainer$Footer =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        var css = Object.clone(this.form.css["el-container-footer"]);
        if (this.json.recoveryStyles){
            var keys = Object.keys(css);
            keys.forEach(function(key){
                if (this.json.recoveryStyles[key]) delete css[key];
            }.bind(this))
        }
        this.node.setStyles(css);

        //this.node.setStyles(this.form.css["el-container-footer"]);
    }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Eldate 基于Element UI的日期选择组件。
 * @o2cn 日期选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/date-picker|Element UI DatePicker 日期选择器}
 */
MWF.xApplication.process.Xform.Eldate = MWF.APPEldate =  new Class(
    /** @lends MWF.xApplication.process.Xform.Eldate# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当 input 失去焦点时触发。this.event[0]指向组件实例
         * @event MWF.xApplication.process.Xform.Eldate#blur
         * @see {@link https://element.eleme.cn/#/zh-CN/component/date-picker|日期选择组件的Events章节}
         */
        /**
         * 当 input 获得焦点时触发。this.event[0]指向组件实例
         * @event MWF.xApplication.process.Xform.Eldate#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/date-picker|日期选择组件的Events章节}
         */
        /**
         * 用户确认选定的值时触发。this.event[0]为组件绑定值；格式与绑定值一致，可受 value-format 控制
         * @event MWF.xApplication.process.Xform.Eldate#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/date-picker|日期选择组件的Events章节}
         */
        "elEvents": ["focus", "blur", "change"]
    },
    _loadMergeReadContentNode: function( contentNode, data ){
        var d = o2.typeOf( data.data ) === "array" ? data.data : [data.data];
        contentNode.set("text", d.join( this.json.rangeSeparator ? " "+this.json.rangeSeparator+" " : " 至 " ) );
    },
    _queryLoaded: function(){
        this._loadReadEditAbeld();
        var data = this._getBusinessData();
        if (data){
            if( ["monthrange","daterange"].contains(this.json.selectType) ) {
                if (typeOf(data) === "string") this._setBusinessData([data, ""]);
            }else if( ["dates"].contains(this.json.selectType) ){
                if (typeOf(data) === "string") this._setBusinessData([data]);
            }else{
                if( typeOf(data) === "array" )this._setBusinessData(data[0] || "");
            }
        }
    },
    __setReadonly: function(data){
        if (this.isReadonly()){
            var format = this.json.format || this.json.valueFormat;
            if( o2.typeOf(data) === "array" ){
                if( ["monthrange","daterange"].contains(this.json.selectType) ) {
                    var ds = data.map(function (d){
                        return this.isValidDate(d) ? this.formatDate(new Date(d), format) : d;
                    }.bind(this));
                    this.node.set("text", this.json.rangeSeparator ? ds.join(this.json.rangeSeparator) : ds);
                }else{
                    this.node.set("text", this.isValidDate(data) ? this.formatDate(new Date(data), format) : data );
                }
            }else{
                this.node.set("text", this.isValidDate(data) ? this.formatDate(new Date(data), format) : data );
            }
            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }

            if( !this.eventLoaded ){
                this._loadDomEvents();
                this.eventLoaded = true;
            }

            this.fireEvent("postLoad");
            this.fireEvent("load");
            this.isLoaded = true;
        }
    },
    _appendVueData: function(){
        if (!this.json.isReadonly && !this.form.json.isReadonly) this.json.isReadonly = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.clearable) this.json.clearable = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.editable) this.json.editable = false;
        if (!this.json.size) this.json.size = "";
        if (!this.json.valueFormat) this.json.valueFormat = this.json.format || "";
        if (!this.json.prefixIcon) this.json.prefixIcon = "";
        if (!this.json.description) this.json.description = "";
        this.json.pickerOptions = {
            firstDayOfWeek: this.json.firstDayOfWeek.toInt()
        }
        if (this.json.disabledDate && this.json.disabledDate.code){
            this.json.pickerOptions.disabledDate = function(date){
                return this.form.Macro.fire(this.json.disabledDate.code, this, date);
            }.bind(this)
        }
    },
    _createElementHtml: function() {
        var html = "<el-date-picker";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :type=\"selectType\"";
        html += " :readonly=\"isReadonly\"";
        html += " :disabled=\"disabled\"";
        html += " :editable=\"editable\"";
        html += " :clearable=\"clearable\"";
        html += " :size=\"size\"";
        html += " :prefix-icon=\"prefixIcon\"";
        html += " :range-separator=\"rangeSeparator\"";
        html += " :start-placeholder=\"startPlaceholder\"";
        html += " :end-placeholder=\"endPlaceholder\"";
        html += " :value-format=\"valueFormat\"";
        html += " :format=\"format\"";
        html += " :picker-options=\"pickerOptions\"";
        // html += " :picker-options=\"{" +
            // ":firstDayOfWeek=firstDayOfWeek," +
            // ":disabledDate=\"disabledDateFun\""+
            // "}\"";

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-date-picker>";

        return html;
    },
    getInputData: function(){
        var data = this.json[this.json.$id];
        if( data === null ){
            if( ["monthrange","daterange"].contains(this.json.selectType) ) {
                return [];
            }else if( ["dates"].contains(this.json.selectType) ){
                return [];
            }else{
                return "";
            }
        }
        return this.json[this.json.$id];
    },

        getExcelData: function(){
            var value = this.getData();
            return o2.typeOf(value) === "array" ? value.join(", ") : value;
        },
        setExcelData: function(data){
            var arr = this.stringToArray(data);
            this.excelData = arr;
            var value = arr.length === 0  ? arr[0] : arr;
            this.setData(value, true);
        },
        isValidDate: function(dateString) {
            if( !dateString ){
                return false;
            }
            var date = new Date(dateString);
            return !isNaN(date.getTime());
        },
        formatDate: function (date, format) {
            var o = {
                'M+': date.getMonth() + 1, // 月份
                'd+': date.getDate(), // 日
                'h+': date.getHours() % 12 === 0 ? 12 : date.getHours() % 12, // 小时
                'H+': date.getHours(), // 小时
                'm+': date.getMinutes(), // 分
                's+': date.getSeconds(), // 秒
                'q+': Math.floor((date.getMonth() + 3) / 3), // 季度
                d: date.getDay(),
                S: date.getMilliseconds(), // 毫秒
                a: date.getHours() < 12 ? 'am' : 'pm', // 上午/下午
                A: date.getHours() < 12 ? 'AM' : 'PM' // AM/PM
            };
            if (/(y+)/.test(format)) {
                format = format.replace(RegExp.$1, (date.getFullYear() + '').substr(4 - RegExp.$1.length));
            }
            if (/(W+)/.test(format)) {
                o['W+'] = this.weekNumberOfDate(date);
            }
            for (let k in o) {
                if (new RegExp('(' + k + ')').test(format)) {
                    format = format.replace(
                        RegExp.$1,
                        RegExp.$1.length === 1 ? o[k] : ('00' + o[k]).substr(('' + o[k]).length)
                    );
                }
            }
            return format;
        },
        weekNumberOfDate: function ( date ){
            var target  = new Date(date.getTime());
            var dayNumber   =  ( 7 + date.getDay() - parseInt( (this.json.firstDayOfWeek || 0) ) ) % 7;
            target.setDate(target.getDate() - dayNumber + 3);
            var firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 608400000); // 604800000 = 7 * 24 * 3600 * 1000
        }
});

o2.xDesktop.requireApp("process.Xform", "Eldate", null, false);
/** @class Eldatetime 基于Element UI的日期时间选择组件。
 * @o2cn 日期时间选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/datetime-picker|Element UI DateTimePicker 日期时间选择器}
 */
MWF.xApplication.process.Xform.Eldatetime = MWF.APPEldatetime =  new Class(
    /** @lends MWF.xApplication.process.Xform.Eldatetime# */
    {
    Implements: [Events],
    Extends: MWF.APPEldate,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当 input 失去焦点时触发。this.event[0]指向组件实例
         * @event MWF.xApplication.process.Xform.Eldatetime#blur
         * @see {@link https://element.eleme.cn/#/zh-CN/component/datetime-picker|日期时间选择组件的Events章节}
         */
        /**
         * 当 input 获得焦点时触发。this.event[0]指向组件实例
         * @event MWF.xApplication.process.Xform.Eldatetime#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/datetime-picker|日期时间选择组件的Events章节}
         */
        /**
         * 用户确认选定的值时触发。this.event[0]为组件绑定值；格式与绑定值一致，可受 value-format 控制
         * @event MWF.xApplication.process.Xform.Eldatetime#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/datetime-picker|日期时间选择组件的Events章节}
         */
        "elEvents": ["focus", "blur", "change"]
    },
    _queryLoaded: function(){
        this._loadReadEditAbeld();
        var data = this._getBusinessData();
        if( data ){
            if( ["datetimerange"].contains(this.json.selectType) ) {
                if (typeOf(data) === "string") this._setBusinessData([data, ""]);
            }else{
                if( typeOf(data) === "array" )this._setBusinessData(data[0] || "");
            }
        }
    },
    __setReadonly: function(data){
        var format = this.json.format || this.json.valueFormat;
        if (this.isReadonly()){
            if( o2.typeOf(data) === "array" ){
                var ds = data.map(function (d){
                    return this.isValidDate(d) ? this.formatDate(new Date(d), format) : d;
                }.bind(this));
                this.node.set("text", this.json.rangeSeparator ? ds.join(this.json.rangeSeparator) : ds );
            }else{
                this.node.set("text", this.isValidDate(data) ? this.formatDate(new Date(data), format) : data);
            }

            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }

            if( !this.eventLoaded ){
                this._loadDomEvents();
                this.eventLoaded = true;
            }

            this.fireEvent("postLoad");
            this.fireEvent("load");
            this.isLoaded = true;
        }
    },
    isValidDate: function(dateString) {
        if( !dateString ){
            return false;
        }
        var date = new Date(dateString);
        return !isNaN(date.getTime());
    },
    _appendVueData: function(){
        if (!this.json.isReadonly && !this.form.json.isReadonly) this.json.isReadonly = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.clearable) this.json.clearable = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.editable) this.json.editable = false;
        if (!this.json.size) this.json.size = "";
        if (!this.json.valueFormat) this.json.valueFormat = this.json.format || "";
        if (!this.json.prefixIcon) this.json.prefixIcon = "";
        if (!this.json.description) this.json.description = "";
        if (!this.json.arrowControl) this.json.arrowControl = false;
        this.json.pickerOptions = {
            firstDayOfWeek: this.json.firstDayOfWeek.toInt()
        }
        if (this.json.disabledDate && this.json.disabledDate.code){
            this.json.pickerOptions.disabledDate = function(date){
                return this.form.Macro.fire(this.json.disabledDate.code, this, date);
            }.bind(this)
        }
        // if(this.json.selectableRange && this.json.selectableRange.code){
        //     this.json.pickerOptions.selectableRange = this.form.Macro.fire(this.json.selectableRange.code, this);
        // }
    },
    _createElementHtml: function() {
        var html = "<el-date-picker";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :type=\"selectType\"";
        html += " :readonly=\"isReadonly\"";
        html += " :disabled=\"disabled\"";
        html += " :editable=\"editable\"";
        html += " :clearable=\"clearable\"";
        html += " :size=\"size\"";
        html += " :prefix-icon=\"prefixIcon\"";
        html += " :range-separator=\"rangeSeparator\"";
        html += " :start-placeholder=\"startPlaceholder\"";
        html += " :end-placeholder=\"endPlaceholder\"";
        html += " :value-format=\"valueFormat\"";
        html += " :format=\"format\"";
        html += " :picker-options=\"pickerOptions\"";
        html += " :arrow-control=\"arrowControl\"";
        // html += " :picker-options=\"{" +
            // ":firstDayOfWeek=firstDayOfWeek," +
            // ":disabledDate=\"disabledDateFun\""+
            // "}\"";

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-date-picker>";
        return html;
    },
    getInputData: function(){
        var data = this.json[this.json.$id];
        if( data === null ){
            if( ["datetimerange"].contains(this.json.selectType) ) {
                return [];
            }else{
                return "";
            }
        }
        return this.json[this.json.$id];
    },

        getExcelData: function(){
            var value = this.getData();
            return o2.typeOf(value) === "array" ? value.join(", ") : value;
        },
        setExcelData: function(data){
            var arr = this.stringToArray(data);
            this.excelData = arr;
            var value = arr.length === 0  ? arr[0] : arr;
            this.setData(value, true);
        }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Eldropdown 基于Element UI的下拉菜单组件。本组件不往后台存数据。
 * @o2cn 下拉菜单
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/dropdown|Element UI Dropdown 下拉菜单}
 */
MWF.xApplication.process.Xform.Eldropdown = MWF.APPEldropdown =  new Class(
    /** @lends MWF.xApplication.process.Xform.Eldropdown# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * split-button 为 true 时，点击左侧按钮的回调
         * @event MWF.xApplication.process.Xform.Eldropdown#click
         * @see {@link https://element.eleme.cn/#/zh-CN/component/dropdown|下拉菜单组件的Events章节}
         */
        /**
         * 点击菜单项触发的事件回调。this.event[0]指向dropdown-item 的指令（选项的command值）
         * @event MWF.xApplication.process.Xform.Eldropdown#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/dropdown|下拉菜单组件的Events章节}
         */
        /**
         * 下拉框出现/隐藏时触发。出现则this.event[0]为 true，隐藏则this.event[0]为 false
         * @event MWF.xApplication.process.Xform.Eldropdown#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/dropdown|下拉菜单组件的Events章节}
         */
        "elEvents": ["click", "command", "visible-change"]
    },
    __setReadonly: function(data){
        if (this.isReadonly()) {
            this.node.set("text", data);
            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }
        }
    },
    _loadNode: function(){
        if (this.isReadonly()) this.json.disabled = true;
        this._loadNodeEdit();
    },
    _loadNodeEdit: function(){
        var id = (this.json.id.indexOf("..")!==-1) ? this.json.id.replace(/\.\./g, "_") : this.json.id;
        id = (id.indexOf("@")!==-1) ? id.replace(/@/g, "_") : id;
        this.json["$id"] = (id.indexOf("-")!==-1) ? id.replace(/-/g, "_") : id;
         this.node.appendHTML(this._createElementHtml(), "before");
        var input = this.node.getPrevious();

        this.node.destroy();
        this.node = input;
        this.node.setStyle("opacity", 0);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this.node.addClass("o2_vue");
        this._createVueApp();
    },
    _appendVueData: function(){
        if (!this.json.size) this.json.size = "";
        if (!this.json.placement) this.json.placement = "bottom-end";
        if (!this.json.trigger) this.json.trigger = "hover";
        if (o2.typeOf(this.json.hideOnClick)!=="boolean") this.json.hideOnClick = true;
        if (o2.typeOf(this.json.splitButton)!=="boolean") this.json.splitButton = false;
        if (!this.json.buttonType) this.json.buttonType = "";
        if (!this.json.showTimeout) this.json.showTimeout = 250;
        if (!this.json.hideTimeout) this.json.hideTimeout = 150;
        // if(o2.typeOf(this.json.disabled)!=="boolean")this.json.disabled = this.isReadonly();
    },
    _afterMounted: function(el){
        this.node = el;
        this.node.setStyle("opacity", 1);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this._loadVueCss();
        this._loadDomEvents();
        this._afterLoaded();
        this.fireEvent("postLoad");
        this.fireEvent("load");
    },
    _createElementHtml: function() {
        var html = "<el-dropdown";
        // html += " :readonly=\"readonly\"";
        html += " :placement=\"placement\"";
        html += " :trigger=\"trigger\"";
        html += " :hide-on-click=\"hideOnClick\"";
        html += " :size=\"size\"";
        html += " :disabled=\"disabled\"";

        if( this.json.showButton && this.json.splitButton ){
            html += " :split-button=\"splitButton\"";
            html += " :type=\"buttonType\"";
        }

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";

        html += ">";

        if (this.json.vueSlot){
            html += this.json.vueSlot;
        }else{
            html += this.getButtonHtml();
        }

        html += this.getItemHtml();

        html += "</el-dropdown>";
        return html;
    },
    getItemHtml: function(){
        var html = " <el-dropdown-menu slot=\"dropdown\">";

        var datToHtml = function (data) {
            var command = data.command ? (" command=\""+data.command+"\"") : "";
            var disabled = ( data.disabled && (data.disabled==="true" || data.disabled===true) ) ? " disabled" : "";
            var divided = ( data.divided && (data.divided==="true" || data.divided===true) ) ? " divided" : "";
            var icon = data.icon ? (" icon=\""+data.icon+"\"") : "";
            html += "	<el-dropdown-item" + command + disabled + divided + icon + ">"+data.label+"</el-dropdown-item>";
        };

        if(this.json.dataType === "json"){
            this.json.dataJson.each(function(d){
                datToHtml(d)
            })
        }else if(this.json.dataScript && this.json.dataScript.code){
            var data = this.form.Macro.exec(((this.json.dataScript) ? this.json.dataScript.code : ""), this);
            if( data && o2.typeOf(data) !== "array" )data = [data];
            if( data )data.each(function(d){
                datToHtml(d)
            })
        }

        html += "</el-dropdown-menu>";
        return html;
    },
    getButtonHtml: function(){
        if( this.json.showButton ){
            if( this.json.splitButton ) {
                return this.json.text || MWF.xApplication.process.Xform.LP.pleaseSelect;
            }else{
                return "<el-button type=\""+this.json.buttonType+"\" size=\""+this.json.size+"\">"+ ( this.json.text || MWF.xApplication.process.Xform.LP.pleaseSelect ) +
                		"<i class=\"el-icon-arrow-down el-icon--right\"></i>"+
                	"</el-button>";
            }
        }else{
            return " <span class=\"el-dropdown-link\">"+ ( this.json.text || MWF.xApplication.process.Xform.LP.pleaseSelect ) +
                "<i class=\"el-icon-arrow-down el-icon--right\"></i>"+
                "</span>";
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$ElModule", null, false);
/** @class Elicon 基于Element UI的图标组件。
 * @o2cn 图标组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var icon = this.form.get("name"); //获取组件
 * //方法2
 * var icon = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/icon|Element UI Icon 图标}
 */
MWF.xApplication.process.Xform.Elicon = MWF.APPElicon =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elicon# */
    {
    Implements: [Events],
    Extends: MWF.APP$ElModule,
    _appendVueData: function(){
        if (!this.json.icon) this.json.icon = "el-icon-platform-eleme";
        if (!this.json.iconSize) this.json.iconSize = "16";
        if (!this.json.iconColor) this.json.iconColor = "";
        if (!this.json.icon) this.json.icon = "";
        if (!this.json.elStyles) this.json.elStyles = {};
    },
    _createElementHtml: function(){
        var html = "<i";
        html += " :class=\"icon\"";

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        html += " :style=\"[elStyles, {fontSize: iconSize+'px', color: iconColor}]\"";


        html += "></i>";
        return html;
    }
    // _loadVue: function(callback){
    //     if (!window.Vue){
    //         var vue = (o2.session.isDebugger) ? "vue_develop" : "vue";
    //         o2.loadAll({"css": "../o2_lib/vue/element/index.css", "js": [vue, "elementui"]}, { "sequence": true }, callback);
    //     }else{
    //         if (callback) callback();
    //     }
    // },
    // _queryLoaded: function(){
    //     this._loadVue();
    // },

    // load: function(){
    //     this._loadModuleEvents();
    //     if (this.fireEvent("queryLoad")){
    //         this._queryLoaded();
    //         this._loadUserInterface();
    //     }
    // },
    //
    // _loadUserInterface: function(){
    //     this.node.appendHTML(this._createElementHtml(), "before");
    //     var icon = this.node.getPrevious();
    //
    //     this.node.destroy();
    //     this.node = icon;
    //     this.node.set({
    //         "id": this.json.id,
    //         "MWFType": this.json.type
    //     });
    //     this._createVueApp();
    // },
    // _createVueApp: function(){
    //     if (!this.vm) this._loadVue(this._mountVueApp.bind(this));
    // },
    //
    // _loadVue: function(callback){
    //     if (!window.Vue){
    //         o2.loadAll({"css": "../o2_lib/vue/element/index.css", "js": ["vue", "elementui"]}, { "sequence": true }, callback);
    //     }else{
    //         if (callback) callback();
    //     }
    // },
    // _mountVueApp: function(){
    //     if (!this.vueApp) this.vueApp = this._createVueExtend();
    //
    //     /**
    //      * @summary Vue对象实例
    //      * @see https://vuejs.org/
    //      * @member {VueInstance}
    //      */
    //     this.vm = new Vue(this.vueApp).$mount(this.node);
    // },
    //
    // _createVueExtend: function(){
    //     var _self = this;
    //     return {
    //         data: this._createVueData(),
    //         mounted: function(){
    //             _self._afterMounted(this.$el);
    //         }
    //     };
    // },
    // _createVueData: function(){
    //     return this.json;
    // },
    // _afterMounted: function(el){
    //     this.node = el;
    //     this.node.set({
    //         "id": this.json.id,
    //         "MWFType": this.json.type
    //     });
    //     this._loadDomEvents();
    //     this._afterLoaded();
    //     this.fireEvent("postLoad");
    //     this.fireEvent("load");
    // },
    //     _createElementHtml: function(){
    //         var html = "<i";
    //         html += " :class=\"icon\"";
    //
    //         if (this.json.elProperties){
    //             Object.keys(this.json.elProperties).forEach(function(k){
    //                 if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
    //             }, this);
    //         }
    //
    //         // var styles = {};
    //         // if (this.json.iconSize) styles["font-size"] = this.json.iconSize+"px";
    //         // if (this.json.iconColor) styles["color"] = this.json.iconColor;
    //         // styles = Object.merge(styles, this.json.elStyles);
    //         //
    //         // if (styles){
    //         //     var style = "";
    //         //     Object.keys(styles).forEach(function(k){
    //         //         if (styles[k]) style += k+":"+styles[k]+";";
    //         //     }, this);
    //         //     html += " style=\""+style+"\"";
    //         // }
    //
    //         html += " :style=\"[elStyles, {fontSize: iconSize+'px', color: iconColor}]\"";
    //
    //
    //         html += "></i>";
    //         return html;
    //     }

}); 

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elinput 基于Element UI的输入框组件。
 * @o2cn 输入框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/input|Element UI Input 输入框}
 */
MWF.xApplication.process.Xform.Elinput = MWF.APPElinput =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elinput# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当 input 获得焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elinput#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input|输入组件的Input Events章节}
         */
        /**
         * 当 input 失去焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elinput#blur
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input|输入组件的Input Events章节}
         */
        /**
         * 仅在输入框失去焦点或用户按下回车时触发。this.event[0]为组件的value
         * @event MWF.xApplication.process.Xform.Elinput#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input|输入组件的Input Events章节}
         */
        /**
         * 在 Input 值改变时触发。this.event[0]为组件的value
         * @event MWF.xApplication.process.Xform.Elinput#input
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input|输入组件的Input Events章节}
         */
        /**
         * 在点击由 clearable 属性生成的清空按钮时触发
         * @event MWF.xApplication.process.Xform.Elinput#clear
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input|输入组件的Input Events章节}
         */
        "elEvents": ["focus", "blur", "change", "input", "clear"]
    },
    _appendVueData: function(){
        if (!this.json.maxlength) this.json.maxlength = "";
        if (!this.json.minlength) this.json.minlength = "";
        if (!this.json.max) this.json.max = "";
        if (!this.json.min) this.json.min = "";
        if (!this.json.showWordLimit) this.json.showWordLimit = false;
        if (!this.json.showPassword) this.json.showPassword = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.clearable) this.json.clearable = false;
        if (!this.json.size) this.json.size = "";
        if (!this.json.prefixIcon) this.json.prefixIcon = "";
        if (!this.json.suffixIcon) this.json.suffixIcon = "";
        if (!this.json.rows) this.json.rows = 2;
        if (!this.json.autosize) this.json.autosize = false;
        if (!this.json.readonly) this.json.readonly = false;
        if (!this.json.resize) this.json.resize = "none";
        if (!this.json.description) this.json.description = "";
        if (this.json.minRows && this.json.maxRows){
            this.json.autosize = {minRows: this.json.minRows.toInt(), maxRows: this.json.maxRows.toInt()}
        }
    },
    // appendVueExtend: function(app){
    //     if (!app.methods) app.methods = {};
    //     app.methods.$loadElEvent = function(ev){
    //         this.validationMode();
    //         if (ev==="change") this._setBusinessData(this.getInputData());
    //         if (this.json.events && this.json.events[ev] && this.json.events[ev].code){
    //             this.form.Macro.fire(this.json.events[ev].code, this, event);
    //         }
    //     }.bind(this);
    // },
    _createElementHtml: function(){
        //var numberStr = (this.json.inputType === "number" && this.json.resultType === "number" ) ? ".number" : "";
        var html = "<el-input";
        html += " v-model"+"=\""+this.json.$id+"\"";
        if( this.json.inputType === 'number' ){
            html += " :max=\"max\"";
            html += " :min=\"min\"";
        }else{
            html += " :maxlength=\"maxlength\"";
            html += " :minlength=\"minlength\"";
        }
        html += " :show-word-limit=\"showWordLimit\"";
        html += " :show-password=\"showPassword\"";
        html += " :disabled=\"disabled\"";
        html += " :size=\"size\"";
        html += " :prefix-icon=\"prefixIcon\"";
        html += " :suffix-icon=\"suffixIcon\"";
        html += " :rows=\"rows\"";
        html += " :autosize=\"autosize\"";
        html += " :readonly=\"readonly\"";
        html += " :resize=\"resize\"";
        html += " :clearable=\"clearable\"";
        html += " :type=\"inputType\"";
        html += " :placeholder=\"description\"";


        // this.options.elEvents.forEach(function(k){
        //     html += " @"+k+"=\"$loadElEvent('"+k+"')\"";
        // });
        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";
        // if (this.json.elStyles){
        //     var style = "";
        //     Object.keys(this.json.elStyles).forEach(function(k){
        //         if (this.json.elStyles[k]) style += k+":"+this.json.elStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-input>";
        return html;
    },
        _createEventFunction: function(methods, k){
            methods["$loadElEvent_"+k.camelCase()] = function(){
                var flag = true;
                if (k==="change"){
                    if(this.json.inputType === "number"  ){
                        if( this.json.resultType === "number" ){
                            if( parseFloat(arguments[0]).toString() !== "NaN" ){
                                this.json[this.json.$id] = parseFloat(arguments[0]);
                            }
                        }
                        var value = this.getMin( this.getMax( this.json[this.json.$id] ) );
                        if( value !== this.json[this.json.$id] ){
                            this.json[this.json.$id] = value;
                        }
                    }
                    this.validationMode();
                    this._setBusinessData(this.getInputData());
                    if( !this.validation() )flag = false;
                }
                if (this.json.events && this.json.events[k] && this.json.events[k].code){
                    this.form.Macro.fire(this.json.events[k].code, this, arguments);
                }
                if( flag )this.fireEvent(k, arguments);
            }.bind(this);
        },
        getMax: function( value ){
            if( isNaN(value) )return value;
            if( typeOf( value ) === "string" )value = parseFloat(value);
            if( typeOf(this.json.max)!=='null' && !isNaN( this.json.max )){
                var max = this.json.max;
                if( typeOf( max ) === "string" )max = parseFloat(max);
                return isNaN(max) ? value : Math.min( max, value );
            }else{
                return value;
            }
        },
        getMin: function( value ){
            if( isNaN(value) )return value;
            if( typeOf( value ) === "string" )value = parseFloat(value);
            if( typeOf(this.json.min)!=='null' && !isNaN( this.json.min )){
                var min = this.json.min;
                if( typeOf( min ) === "string" )min = parseFloat(min);
                return isNaN(min) ? value : Math.max( min, value );
            }else{
                return value;
            }
        },
    getValue: function(){
        if (!this.isReadable) return '';
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if( this.json.inputType === "number" ){
            if (value || value===0 ){
                return this.json.resultType === "string" ? value.toString() : value;
            }else{
                value = this._computeValue();
                value = (o2.typeOf(value)!=="null") ? value : "";
                return this.json.resultType === "string" ? value.toString() : value;
            }
        }else{
            if (value || value===0 || value === false){
                return value;
            }else{
                value = this._computeValue();
                return (o2.typeOf(value)!=="null") ? value : "";
            }
        }
    }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elinput 基于Element UI的数字输入框组件。
 * @o2cn 数字输入框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/input-number|Element UI InputNumber 计数器}
 */
MWF.xApplication.process.Xform.Elnumber = MWF.APPElnumber =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elnumber# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当 input 获得焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elnumber#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input-number|计数器的Events章节}
         */
        /**
         * 当 input 失去焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elnumber#blur
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input-number|计数器的Events章节}
         */
        /**
         * 绑定值被改变时触发。this.event[0]为组件的currentValue，this.event[1]为组件的oldValue
         * @event MWF.xApplication.process.Xform.Elnumber#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/input-number|计数器的Events章节}
         */
        "elEvents": ["focus", "blur", "change"]
    },
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member MWF.xApplication.process.Xform.Elinput#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elinput").json;       //获取组件的json对象
     * var json = this.form.get("elinput").vm.$data;   //获取Vue组件的data数据，
     *
     * //通过json对象操作Element组件
     * json.size = "mini";      //改变输入框大小
     * json.disabled = true;     //设置输入框为禁用
     */
    _loadUserInterface: function(){
        if ( this.isSectionMergeRead() ) { //区段合并显示
            this.node.empty();
            this.node.set({
                "nodeId": this.json.id,
                "MWFType": this.json.type
            });
            switch (this.json.mergeTypeRead) {
                case "amount":
                    this._loadMergeAmountReadNode();
                    break;
                case "average":
                    this._loadMergeAverageReadNode();
                    break;
                default:
                    this._loadMergeReadNode();
                    break;
            }
        }else{
            if( this.isSectionMergeEdit() ){
                switch (this.json.mergeTypeEdit) {
                    case "amount":
                        this._loadMergeAmountEidtNode();
                        break;
                    case "average":
                        this._loadMergeAverageEditNode();
                        break;
                }
            }else{
                this._loadNode();
            }
            if (this.json.compute === "show"){
                this._setValue(this._computeValue());
            }else{
                this._loadValue();
            }
        }
    },
    _loadMergeAmountReadNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        this.node.set("text", total.toString());
    },
    _loadMergeAverageReadNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        var average = total.div(  new Decimal(Object.keys(data).length) );
        this.node.set("text", average.toString());
    },
    _loadMergeAmountEidtNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        this._setBusinessData( total.toNumber() );
        this._loadNode();
    },
    _loadMergeAverageEditNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        var average = total.div(  new Decimal(Object.keys(data).length) );
        this._setBusinessData( average.toNumber() );
        this._loadNode();
    },
    _appendVueData: function(){
        this.form.Macro.environment.data.check(this.json.id);
        this.json[this.json.id] = this._getBusinessData();

        // if (!this.json.max || o2.typeOf(this.json.max)!=="number") this.json.max = "Infinity";
        // if (!this.json.min || o2.typeOf(this.json.max)!=="number") this.json.min = "-Infinity";
        if (!this.json.step || o2.typeOf(this.json.step)!=="number") this.json.step = 1;
        if (!this.json.stepStrictly) this.json.stepStrictly = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.precision) this.json.precision = 0;
        if (!this.json.size) this.json.size = "";
        if (!this.json.controlsPosition) this.json.controlsPosition = "";
        if (!this.json.readonly) this.json.readonly = false;
        if (!this.json.description) this.json.description = "";
    },
    // appendVueExtend: function(app){
    //     if (!app.methods) app.methods = {};
    //     app.methods.$loadElEvent = function(ev){
    //         this.validationMode();
    //         if (ev==="change") this._setBusinessData(this.getInputData());
    //         if (this.json.events && this.json.events[ev] && this.json.events[ev].code){
    //             this.form.Macro.fire(this.json.events[ev].code, this, event);
    //         }
    //     }.bind(this);
    // },
    _createElementHtml: function(){
        var html = "<el-input-number";
        html += " v-model=\""+this.json.$id+"\"";
        if (o2.typeOf(this.json.max)==="number") html += " :max=\"max\"";
        if (o2.typeOf(this.json.min)==="number") html += " :min=\"min\"";
        html += " :step=\"step\"";
        html += " :step-strictly=\"stepStrictly\"";
        html += " :disabled=\"disabled\"";
        html += " :size=\"size\"";
        html += " :precision=\"precision\"";
        html += " :controls-position=\"controlsPosition\"";
        html += " :readonly=\"readonly\"";
        html += " :placeholder=\"description\"";

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });
        // this.options.elEvents.forEach(function(k){
        //     html += " @"+k+"=\"$loadElEvent('"+k+"')\"";
        // });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }
        if (this.json.elStyles) html += " :style=\"elStyles\"";
        // if (this.json.elStyles){
        //     var style = "";
        //     Object.keys(this.json.elStyles).forEach(function(k){
        //         if (this.json.elStyles[k]) style += k+":"+this.json.elStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }

        html += ">";

        // if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-input-number>";
        return html;
    }
});

MWF.xDesktop.requireApp("process.Xform", "Radio", null, false);
/** @class Elradio 基于Element UI的单选按钮组件。
 * @o2cn 单选按钮
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var radio = this.form.get("name"); //获取组件
 * //方法2
 * var radio = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Selector
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/radio|Element UI Radio 单选框}
 */
MWF.xApplication.process.Xform.Elradio = MWF.APPElradio =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elradio# */
    {
    Implements: [Events],
    Extends: MWF.APPRadio,
    options: {
        /**
         * 组件加载前触发。当前组件的queryLoad事件还没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取当前组件。
         * @event MWF.xApplication.process.Xform.Elradio#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发。如果选项加载为异步，则异步处理完成后触发此事件
         * @event MWF.xApplication.process.Xform.Elradio#load
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.Elradio#postLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "change"],
        /**
         * 绑定值变化时触发的事件。this.event[0]为选中的 Radio label 值
         * @event MWF.xApplication.process.Xform.Elradio#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/radio|单选组件的Radio-group Events章节}
         */
        "elEvents": ["change"]
    },
    load: function(){
        this._loadModuleEvents();
        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
        }
    },
    resetOption: function(){
        this.reload();
    },
    reload: function(){
        if (this.vm) {
            var node = this.vm.$el;
            this.vm.$destroy();
            node.empty();
        }

        this.vm = null;

        this.vueApp = null;

        this._resetNodeEdit();
        this._loadUserInterface();
    },
    _loadNode: function(){
        this.node.empty();
        if (this.isReadonly()){
            this._loadNodeRead();

            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }

            if( !this.eventLoaded ){
                this._loadDomEvents();
                this.eventLoaded = true;
            }

            this.fireEvent("postLoad");
            if( this.moduleSelectAG && typeOf(this.moduleSelectAG.then) === "function" ){
                this.moduleSelectAG.then(function () {
                    this.fireEvent("load");
                    this.isLoaded = true;
                }.bind(this));
            }else{
                this.fireEvent("load");
                this.isLoaded = true;
            }
        }else{
            this._loadNodeEdit();
        }
    },
    _resetNodeEdit: function(){
        var div = new Element("div");
        div.inject(this.node, "after");
        this.node.destroy();
        this.node = div;
    },
    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        this.setOptions();
    },

    __showValue: function(node, value, optionItems){
        if (value){
            var texts = "";
            for (var i=0; i<optionItems.length; i++){
                var item = optionItems[i];
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                if (value == v){
                    texts = t || v;
                    break;
                }
            }
            node.set("text", texts);
        }
    },

    setOptions: function(){
        var optionItems = this.getOptions();
        this._setOptions(optionItems);
    },

    _setOptions: function(optionItems){
        var p = o2.promiseAll(optionItems).then(function(radioValues){
            //this.moduleSelectAG = null;
            return this._loadElradio(radioValues);
        }.bind(this), function(){
            this.moduleSelectAG = null;
        }.bind(this));
        this.moduleSelectAG = Promise.resolve(p);
    },

    _loadElradio: function(radioValues){
        return new Promise(function(resolve){
            if (radioValues && o2.typeOf(radioValues)==="array"){
                this.node.appendHTML(this._createElementHtml(radioValues), "before");
                var button = this.node.getPrevious();

                this.node.destroy();
                this.node = button;
                this.node.set({
                    "id": this.json.id,
                    "MWFType": this.json.type
                });
                this._createVueApp(resolve);
            }
        }.bind(this));
    },

    _createElementHtml: function(radioValues){
        if (!this.json.disabled) this.json.disabled = false;

        var id = (this.json.id.indexOf("..")!==-1) ? this.json.id.replace(/\.\./g, "_") : this.json.id;
        id = (id.indexOf("@")!==-1) ? id.replace(/@/g, "_") : id;
        this.json["$id"] = (id.indexOf("-")!==-1) ? id.replace(/-/g, "_") : id;

        var html = "<el-radio-group class='o2_vue' style='box-sizing: border-box!important'";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :text-color=\"textColor\"";
        html += " :fill=\"fillColor\"";
        html += " :size=\"size\"";
        html += " :disabled=\"disabled\"";
        html += " @change=\"change\"";


        if (this.json.elGroupProperties){
            Object.keys(this.json.elGroupProperties).forEach(function(k){
                if (this.json.elGroupProperties[k]) html += " "+k+"=\""+this.json.elGroupProperties[k]+"\"";
            }, this);
        }
        // if (this.json.elGroupStyles){
        //     var style = "";
        //     Object.keys(this.json.elGroupStyles).forEach(function(k){
        //         if (this.json.elGroupStyles[k]) style += k+":"+this.json.elGroupStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }
        if (this.json.elGroupStyles) html += " :style=\"elGroupStyles\"";

        html += " >";

        radioValues.each(function(item){
            var tmps = item.split("|");
            var text = tmps[0];
            var value = tmps[1] || text;

            html += (this.json.buttonRadio) ? " ><el-radio-button" : " ><el-radio";
            html += " label=\""+value+"\"";
            html += " :border=\"border\"";

            if (this.json.elProperties){
                Object.keys(this.json.elProperties).forEach(function(k){
                    if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
                }, this);
            }

            // var radiostyle = "box-sizing: border-box!important;";
            // if (this.json.elStyles){
            //     Object.keys(this.json.elStyles).forEach(function(k){
            //         if (this.json.elStyles[k]) radiostyle += k+":"+this.json.elStyles[k]+";";
            //     }, this);
            // }
            // html += " style=\""+radiostyle+"\"";
            if (this.json.elStyles) html += " :style=\"elStyles\"";

            html += " >"+text;
            html += (this.json.buttonRadio) ? "</el-radio-button>" : "</el-radio>";
        }.bind(this));
        html += "</el-radio-group>";
        return html;
    },


    __setValue: function(value){
        this.moduleValueAG = null;
        this._setBusinessData(value);
        this.json[this.json.$id] = value;
        if( this.isReadonly() ){
            var text = this.getText();
            this.node.set('text', text||value);
        }
    },
    __setData: function(data){
        this.moduleValueAG = null;
        this._setBusinessData(data);
        this.json[this.json.$id] = data;
        this.validationMode();
        this.fireEvent("setData");
    },


    _createVueApp: function(callback){
        if (!this.vm){
            this._loadVue(function(){
                this._mountVueApp(callback);
            }.bind(this));
        }else{
            if (callback) callback();
        }
    },

    _loadVue: function(callback){
        var flag = (o2.session.isDebugger && this.form.app.inBrowser);
        var vue = flag ? "vue_develop" : "vue";
        //var vueName = flag ? "Vue" : "Cn";
        // if (!window.Vue || window.Vue.name!==vueName  ){
        //     o2.loadAll({"css": "../o2_lib/vue/element/index.css", "js": [vue, "elementui"]}, { "sequence": true }, callback);
        // }else{
        //     if (callback) callback();
        // }
        var elcssUrl = this.form.json.elementCssUrl || "../o2_lib/vue/element/index.css";
        o2.loadAll({"css": elcssUrl, "js": [vue, "elementui"]}, { "sequence": true }, callback);
    },
    // _loadVue: function(callback){
    //     if (!window.Vue){
    //         var vue = (o2.session.isDebugger) ? "vue_develop" : "vue";
    //         o2.loadAll({"css": "../o2_lib/vue/element/index.css", "js": [vue, "elementui"]}, { "sequence": true }, callback);
    //     }else{
    //         if (callback) callback();
    //     }
    // },
    _mountVueApp: function(callback){
        if (!this.vueApp) this.vueApp = this._createVueExtend(callback);

        /**
         * @summary Vue对象实例
         * @see https://vuejs.org/
         * @member {VueInstance}
         */
        this.vm = new Vue(this.vueApp);
        this.vm.$mount(this.node);
    },

    _createVueExtend: function(callback){
        var _self = this;
        return {
            data: this._createVueData(),
            mounted: function(){
                _self._afterMounted(this.$el);
                if (callback) callback();
            },
            methods: {
                change: function(v){
                    _self.validationMode();
                    if (_self.validation()) {
                        _self._setBusinessData(v);
                        _self.fireEvent("change");
                    }
                }
            }
        };
    },
    _createVueData: function(){
        if (this.json.$id===this.json.id) this.form.Macro.environment.data.check(this.json.$id);
        this.json[this.json.$id] = this._getBusinessData();
        // if (!this.json[this.json.id]){
        //     this.json[this.json.id] = this._getBusinessData();
        // }

        if (this.json.vueData && this.json.vueData.code){
            var d = this.form.Macro.exec(this.json.vueData.code, this);
            this.json = Object.merge(d, this.json);
        }

        if (!this.json.textColor) this.json.textColor = "";
        if (!this.json.fillColor) this.json.fillColor = "";
        if (!this.json.size) this.json.size = "";

        return this.json;
    },

    _afterMounted: function(el){
        this.node = el;
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        this._loadVueCss();
        this._loadDomEvents();
        this._afterLoaded();
        this.fireEvent("postLoad");
        this.fireEvent("load");
    },

    getInputData: function(){
        return this.json[this.json.$id];
    },
    _loadVueCss: function(){
        if (this.styleNode){
            this.node.removeClass(this.styleNode.get("id"));
        }
        if (this.json.vueCss && this.json.vueCss.code){
            this.styleNode = this.node.loadCssText(this.json.vueCss.code, {"notInject": true});
            this.styleNode.inject(this.node, "before");
        }
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1 && this.options.elEvents.indexOf(key)===-1){
                    if( key === "click" ){
                        this.clickEvnet = function (event){
                            this.form.Macro.fire(e.code, this, event);
                        }.bind(this);
                        this.node.addEvent(key, function(event){
                            o2.defer(this.clickEvnet, 100, this, [event]);
                        }.bind(this));
                    }else{
                        this.node.addEvent(key, function(event){
                            return this.form.Macro.fire(e.code, this, event);
                        }.bind(this));
                    }
                }
            }
        }.bind(this));
    },
        /**
         * @summary 获取选中项的text。
         * @return {String} 返回选中项的text
         * @example
         * var text = this.form.get('fieldId').getText(); //获取选中项的文本
         */
        getText: function(){
            var d = this.getTextData();
            if( typeOf(d.then) === "function" ){
                return d.then(function( d1 ){
                    var texts = d1.text;
                    return (texts && texts.length) ? texts[0] : "";
                })
            }else{
                var texts = d.text;
                return (texts && texts.length) ? texts[0] : "";
            }
        },

    getExcelData: function( type ){
		var value = this.getData();
		if( type === "value" )return value;

		var options = this.getOptionsObj();
		return Promise.resolve(options).then(function (opts) {
			var idx = opts.valueList.indexOf( value );
			var text = idx > -1 ? opts.textList[ idx ] : "";
			if( !text )text = value;
			return text;
		});
	},
    setExcelData: function(d, type){
        var value = d.replace(/&#10;/g,""); //换行符&#10;
        this.excelData = value;
        if( type === "value" ){
			this.setData(value, true);
		}else{
            var options = this.getOptionsObj();
            this.moduleExcelAG = Promise.resolve(options).then(function (opts) {
                var idx = opts.textList.indexOf( value );
                var v = idx > -1 ? opts.valueList[ idx ] : "";
                value = v || value;
                this.json[this.json.$id] = value;
                this._setBusinessData(value);
                this.setData(value, true);
                this.moduleExcelAG = null;
            }.bind(this));
        }
    }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elinput 基于Element UI的评分组件。
 * @o2cn 评分组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/rate|Element UI Rate 评分}
 */
MWF.xApplication.process.Xform.Elrate = MWF.APPElrate =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elrate# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 分值改变时触发	。this.event[0]为改变后的分值
         * @event MWF.xApplication.process.Xform.Elrate#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/rate|评分组件的Events章节}
         */
        "elEvents": ["change"]
    },
    // _loadNode: function(){
    //     if (this.isReadonly()) this.json.disabled = true;
    //     this._loadNodeEdit();
    // },
    _appendVueData: function(){
        if (!this.json.max) this.json.max = "";
        if (!this.json.isReadonly && !this.form.json.isReadonly) this.json.isReadonly = false;
        if (!this.json.max) this.json.max = 5;
        if (!this.json.allowHalf) this.json.allowHalf = false;
        if (!this.json.lowThreshold) this.json.lowThreshold = 2;
        if (!this.json.highThreshold) this.json.highThreshold = 4;
        this.json.colors = [
            this.json.lowColor, this.json.mediumColor, this.json.highColor
        ];
        if( this.json.showAfter === "text" ){
            this.json.showText = true;
            this.json.showScore = false;
        }else if( this.json.showAfter === "score" ){
            this.json.showText = false;
            this.json.showScore = true;
        }else{
            this.json.showText = false;
            this.json.showScore = false;
        }
        if( o2.typeOf(this.json.texts) === "string"){
            this.json.texts = this.json.texts.split(",");
        }
        if(!this.json.textColor)this.json.textColor = "";

    },
    // appendVueExtend: function(app){
    //     if (!app.methods) app.methods = {};
    //     app.methods.$loadElEvent = function(ev){
    //         this.validationMode();
    //         if (ev==="change") this._setBusinessData(this.getInputData());
    //         if (this.json.events && this.json.events[ev] && this.json.events[ev].code){
    //             this.form.Macro.fire(this.json.events[ev].code, this, event);
    //         }
    //     }.bind(this);
    // },
    _createElementHtml: function(){
        var html = "<el-rate";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :readonly=\"isReadonly\"";
        html += " :disabled=\"disabled\"";
        html += " :max=\"max\"";
        html += " :allow-half=\"allowHalf\"";
        html += " :low-threshold=\"lowThreshold\"";
        html += " :high-threshold=\"highThreshold\"";
        html += " :colors=\"colors\"";
        html += " :void-color=\"voidColor\"";
        html += " :disabled-void-color=\"disabledVoidColor\"";
        html += " :show-text=\"showText\"";
        html += " :text-color=\"textColor\"";
        html += " :texts=\"texts\"";
        html += " :show-score=\"showScore\"";


        // this.options.elEvents.forEach(function(k){
        //     html += " @"+k+"=\"$loadElEvent('"+k+"')\"";
        // });
        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";
        // if (this.json.elStyles){
        //     var style = "";
        //     Object.keys(this.json.elStyles).forEach(function(k){
        //         if (this.json.elStyles[k]) style += k+":"+this.json.elStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-rate>";
        return html;
    }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
MWF.xDesktop.requireApp("process.Xform", "$Selector", null, false);

if( !o2.APP$ElSelector ){
    o2.xApplication.process.Xform.$ElSelector = o2.APP$ElSelector = new Class({
        Implements: [Events],
        Extends: MWF.APP$Elinput
    });
    Object.assign(o2.APP$ElSelector.prototype, o2.APP$Selector.prototype);
}

/** @class Elselect 基于Element UI的选择框组组件。
 * @o2cn 选择框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Selector
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/select|Element UI Select 选择器}
 */
MWF.xApplication.process.Xform.Elselect = MWF.APPElselect =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elselect# */
    {
    Implements: [Events],
    Extends: MWF.APP$ElSelector,
    options: {
        /**
         * 组件加载后触发。如果选项加载为异步，则异步处理完成后触发此事件
         * @event MWF.xApplication.process.Xform.Elselect#load
         */
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当 input 获得焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elselect#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/select|选择器的Select Events章节}
         */
        /**
         * 当 input 失去焦点时触发。this.event[0]指向Event
         * @event MWF.xApplication.process.Xform.Elselect#blur
         * @see {@link https://element.eleme.cn/#/zh-CN/component/select|选择器的Select Events章节}
         */
        /**
         * 选中值发生变化时触发。this.event[0]为组件目前的选中值
         * @event MWF.xApplication.process.Xform.Elselect#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/select|选择器的Select Events章节}
         */
        /**
         * 下拉框出现/隐藏时触发。this.event[0]的值出现则为 true，隐藏则为 false
         * @event MWF.xApplication.process.Xform.Elselect#visible-change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/select|选择器的Select Events章节}
         */
        /**
         * 多选模式下移除tag时触发。this.event[0]为移除的tag值
         * @event MWF.xApplication.process.Xform.Elselect#remove-tag
         * @see {@link https://element.eleme.cn/#/zh-CN/component/select|选择器的Select Events章节}
         */
        /**
         * 可清空的单选模式下用户点击清空按钮时触发。
         * @event MWF.xApplication.process.Xform.Elselect#clear
         * @see {@link https://element.eleme.cn/#/zh-CN/component/select|选择器的Select Events章节}
         */
        "elEvents": ["focus", "blur", "change", "visible-change", "remove-tag", "clear"]
    },
    // _loadNode: function(){
    //     if (this.isReadonly()) this.json.disabled = true;
    //     this._loadNodeEdit();
    // },
    _loadMergeReadContentNode: function( contentNode, data ){
        this._loadOptions();
        Promise.resolve( this.json.options || this.moduleSelectAG ).then(function(options){
            var values = (o2.typeOf(data.data) !== "array") ? [data.data] : data.data;
            var text = this.__getOptionsText(options, values);
            contentNode.set("text", text.join(","));
        }.bind(this));
    },
    resetOption: function(){
        this.reload();
    },
    _appendVueData: function(){
        // this.form.Macro.environment.data.check(this.json.id);
        // this.json[this.json.id] = this._getBusinessData();

        if (!this.json.clearable) this.json.clearable = false;
        if (!this.json.size) this.json.size = "";
        if (!this.json.multiple) this.json.multiple = false;
        if (!this.json.collapseTags) this.json.collapseTags = false;
        if (!this.json.filterable) this.json.filterable = false;
        if (!this.json.allowCreate) this.json.allowCreate = false;
        if (!this.json.remote) this.json.remote = false;
        if (!this.json.popperClass) this.json.popperClass = "";
        if (!this.json.multipleLimit || !this.json.multipleLimit.toInt()) this.json.multipleLimit = 0;
        if (!this.json.noMatchText) this.json.noMatchText = "";
        if (!this.json.noDataText) this.json.noDataText = "";
        if (!this.json.loadingText) this.json.loadingText = "";
        if (!this.json.description) this.json.description = "";
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.loading) this.json.loading = false;
        if (!this.json.options) this.json.options = [];

        this._loadOptions();

        if (this.json.multiple===true) if (!this.json[this.json.$id] || !this.json[this.json.$id].length) this.json[this.json.$id] = [];
    },
    appendVueMethods: function(methods){
        if (this.json.filterMethod && this.json.filterMethod.code){
            var fn = this.form.Macro.exec(this.json.filterMethod.code, this);
            methods.$filterMethod = function(){
                fn.apply(this, arguments);
            }.bind(this)
        }
        if (this.json.remoteMethod && this.json.remoteMethod.code){
            var fn = this.form.Macro.exec(this.json.remoteMethod.code, this);
            methods.$remoteMethod = function(){
                fn.apply(this, arguments);
            }.bind(this)
        }
    },

    _setOptionsWithCode: function(code){
        var v = this.form.Macro.exec(code, this);
        if (v.then){
            this.moduleSelectAG = v.then(function(o){
                if (o2.typeOf(o)==="array"){
                    this.json.options = o.map(function(item){
                        if (o2.typeOf(item)!=="object"){
                            var value = item.toString();
                            return {"value": value, "label": value};
                        }
                        return item;
                    });
                    this.json.$options = Array.clone(this.json.options);
                    return this.json.options;
                }
            }.bind(this));
        }else if (o2.typeOf(v)==="array"){
            this.json.options = v.map(function(item){
                if (o2.typeOf(item)!=="object"){
                    var value = item.toString();
                    return {"value": value, "label": value};
                }
                return item;
            });
            this.json.$options = Array.clone(this.json.options);
        }
    },
    _setOptionsWithArray: function( optionItems ){
        if (o2.typeOf(optionItems)==="array"){
            this.json.options = optionItems.map(function(item){
                if (item && o2.typeOf(item)!=="object"){
                    var value = item.toString();
                    var arr = value.split("|");
                    if (arr.length>1){
                        return {"label": arr[0], "value": arr[1]};
                    }else{
                        return {"label": arr[0], "value": arr[0]};
                    }
                }
                return item;
            });
            this.json.$options = Array.clone(this.json.options);
        }
    },
    _loadOptions: function(){
        if (this.json.itemsGroup===true){
            if (this.json.itemGroupScript && this.json.itemGroupScript.code)  this._setOptionsWithCode(this.json.itemGroupScript.code);
        }else{
            // if (this.json.itemType=="script"){
            //     if (this.json.itemScript && this.json.itemScript.code) this._setOptionsWithCode(this.json.itemScript.code);
            // }else{
            //     if (this.json.itemValues && (o2.typeOf(this.json.itemValues)==="array")){
            //         this.json.options = this.json.itemValues.map(function(item){
            //             if (item){
            //                 var arr = item.split("|");
            //                 if (arr.length>1){
            //                     return {"label": arr[0], "value": arr[1]};
            //                 }else{
            //                     return {"label": arr[0], "value": arr[0]};
            //                 }
            //             }
            //         });
            //     }
            // }
            var optionItems = this.getOptions();
            if( optionItems && typeOf(optionItems.then) === "function" ){
                this.moduleSelectAG = Promise.resolve(optionItems).then(function (optItems) {
                    this._setOptionsWithArray( optItems );
                    this.moduleSelectAG = false;
                    return this.json.options;
                }.bind(this));
            }else{
                this._setOptionsWithArray( optionItems );
            }

        }
    },
    _createElementHtml: function(){
        var html = "<el-select";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :clearable=\"clearable\"";
        html += " :size=\"size\"";
        html += " :filterable=\"filterable\"";
        html += " :disabled=\"disabled\"";
        html += " :placeholder=\"description\"";
        html += " :multiple=\"multiple\"";
        html += " :collapse-tags=\"collapseTags\"";
        html += " :allow-create=\"allowCreate\"";
        html += " :remote=\"remote\"";
        html += " :popper-class=\"popperClass\"";
        html += " :multiple-limit=\"multipleLimit\"";
        html += " :no-match-text=\"noMatchText\"";
        html += " :no-data-text=\"noDataText\"";
        html += " :loading-text=\"loadingText\"";
        html += " :loading=\"loading\"";

        if (this.json.filterMethod && this.json.filterMethod.code){
            html += " :filter-method=\"$filterMethod\"";
        }
        if (this.json.remoteMethod && this.json.remoteMethod.code){
            html += " :remote-method=\"$remoteMethod\"";
        }

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";
        html += ">";

        var itemFor = "item in options";
        if (this.json.itemsGroup===true){
            html += "<el-option-group v-for=\"group in options\" :key=\"group.label\" :label=\"group.label\" :disabled=\"group.disabled\"";
            if (this.json.elGroupProperties){
                Object.keys(this.json.elGroupProperties).forEach(function(k){
                    if (this.json.elGroupProperties[k]) html += " "+k+"=\""+this.json.elGroupProperties[k]+"\"";
                }, this);
            }
            if (this.json.elGroupStyles) html += " :style=\"elGroupStyles\"";
            html += ">";

            itemFor = "item in group.options";
        }
        html += "<el-option v-for=\""+itemFor+"\" :key=\"item.value\" :label=\"item.label\" :value=\"item.value\" :disabled=\"item.disabled\"";
        if (this.json.elOptionProperties){
            Object.keys(this.json.elOptionProperties).forEach(function(k){
                if (this.json.elOptionProperties[k]) html += " "+k+"=\""+this.json.elOptionProperties[k]+"\"";
            }, this);
        }
        if (this.json.elOptionStyles) html += " :style=\"elOptionStyles\"";
        html += ">";
        if (this.json.customTemplete) html += this.json.customTemplete;
        html += "</el-option>";

        if (this.json.itemsGroup===true){
            html += "</el-option-group>"
        }

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-select>";
        return html;
    },
    // _afterLoaded: function(){
    //     if (this.isReadonly()){
    //         this.node.hide();
    //         window.setTimeout(function(){
    //             var text = "";
    //             var nodes = this.node.getElements(".el-select__tags-text");
    //             if (nodes && nodes.length){
    //                 nodes.forEach(function(n){
    //                     text += ((text) ? ", " : "")+n.get("text");
    //                 });
    //             }
    //             var node = new Element("div").inject(this.node, "before");
    //             this.node.destroy();
    //             this.node = node;
    //             this.node.set({
    //                 "nodeId": this.json.id,
    //                 "MWFType": this.json.type
    //             });
    //             this._loadDomEvents();
    //             //this.node.removeEvents("click");
    //             //this.node.empty();
    //             this.node.set("text", text);
    //             //this.node.show();
    //         }.bind(this), 20);
    //
    //     }
    // },
        _createEventFunction: function(methods, k){
            methods["$loadElEvent_"+k.camelCase()] = function(){
                var flag = true;
                if (k==="change"){
                    if (this.validationMode){
                        this.validationMode();
                        this._setBusinessData(this.getInputData());
                        if( !this.validation() ) flag = false;
                    }
                }else if( this.json.filterable && ['visible-change','focus'].contains(k) ){
                    var input = this.node.getElement('.el-input__inner');
                    if( input ){
                        window.setTimeout(function(){
                            input.removeAttribute('readonly');
                        }, 200);
                    }
                }
                if (this.json.events && this.json.events[k] && this.json.events[k].code){
                    this.form.Macro.fire(this.json.events[k].code, this, arguments);
                }
                if( flag )this.fireEvent(k, arguments);
            }.bind(this);
        },
        _afterLoaded: function (){
            if( this.json.filterable ){
                var input = this.node.getElement('.el-input__inner');
                if( input ){
                    window.setTimeout(function (){
                        input.removeAttribute('readonly');
                    }, 200);
                }
            }
        },
    __setReadonly: function(data){
        if (this.isReadonly()){
            this._loadOptions();
            Promise.resolve(this.json.options || this.moduleSelectAG).then(function(options){
                var values = (o2.typeOf(data) !== "array") ? [data] : data;
                var text = this.__getOptionsText(options, values);
                this.node.set("text", text.join(",") || values.join(','));

                if( !this.eventLoaded ){
                    this._loadDomEvents();
                    this.eventLoaded = true;
                }

                this.fireEvent("load");
                this.isLoaded = true;
            }.bind(this));

            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }
            this.fireEvent("postLoad");
        }
    },
    __getOptionsText: function(options, values){
        var text = [];
        options.forEach(function(op){
            if (op.value){
                if (values.indexOf(op.value)!=-1) text.push(op.label || op.value);
            }else if (op.options && op.options.length){
                text = text.concat(this.__getOptionsText(op.options, values));
            }
        }.bind(this));
        return text;
    },
        getDataByText: function(text){
            var opt = this.json.options;
            if( !opt )return "";
            if( o2.typeOf(opt.then)==="function" ){
                return Promise.resolve(opt).then(function(options){
                    return this._getDataByText(options, text);
                }.bind(this));
            }else{
                return this._getDataByText(opt, text);
            }
        },
        _getDataByText: function(options, texts){
            var value = [];
            options.forEach(function(op){
                if (op.value){
                    if (texts.indexOf(op.label || op.value)!=-1) value.push(op.value);
                }else if (op.options && op.options.length){
                    value = value.concat(this._getDataByText(op.options, texts));
                }
            }.bind(this));
            return value;
        },

        /**
         * @summary 获取选中项的text或promise。
         * @return {String|String[]} 返回选中项的text或数组，返回类型依赖是否为多选
         * @example
         * var texts = this.form.get('fieldId').getText(); //获取选中项的文本或数组
         */
        getText: function(){
            var d = this.getTextData();
            if( typeOf(d.then) === "function" ){
                return d.then(function( d1 ){
                    var texts = d1.text;
                    var ts = (texts && texts.length) ? texts : [];
                    return this.json.multiple ? ts : (ts[0] || "");
                }.bind(this));
            }else{
                var texts = d.text;
                var ts = (texts && texts.length) ? texts : [];
                return this.json.multiple ? ts : (ts[0] || "");
            }
        },

        // getText: function(){
        //     var data = this._getBusinessData();
        //     var options = this.json.$options || this.json.options || this.moduleSelectAG;
        //     if( typeOf(options.then) === 'function' ){
        //         return options.then(function(opt){
        //             var values = (o2.typeOf(data) !== "array") ? [data] : data;
        //             return this.__getOptionsText(opt, values);
        //         });
        //     }else{
        //         var values = (o2.typeOf(data) !== "array") ? [data] : data;
        //         return this.__getOptionsText(options, values);
        //     }
        // },

        getExcelData: function(){
            var data = this.json[this.json.$id];
            if( !data )return "";
            if( !this.json.options )this._loadOptions();
            var text, opt = this.json.options;
            if( !opt )return "";
            if( o2.typeOf(opt.then)==="function" ){
                return Promise.resolve(opt).then(function(options){
                    text = this.__getOptionsText(options, data);
                    return typeOf(text) === "array" ? text.join(", ") : (text || "");
                }.bind(this));
            }else{
                text = this.__getOptionsText(opt, data);
                return typeOf(text) === "array" ? text.join(", ") : (text || "");
            }
        },
        setExcelData: function(d){
            this._loadOptions();
            this.moduleExcelAG = Promise.resolve( this.json.options || this.moduleSelectAG ).then(function(options){
                var arr = this.stringToArray(d);
                this.excelData = arr;
                arr = arr.map(function (a) {
                    return a.contains("/") ? a.split("/") : a;
                });
                var data = this.getDataByText( arr );
                this.setData( this.json.multiple ? data : data[0], true);
                this.moduleExcelAG = null;
            }.bind(this))
        }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elinput 基于Element UI的滑块组件。
 * @o2cn 滑块组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/slider|Element UI Slider 滑块}
 */
MWF.xApplication.process.Xform.Elslider = MWF.APPElslider =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elslider# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 值改变时触发（使用鼠标拖曳时，只在松开鼠标后触发）。this.event[0]为改变后的值
         * @event MWF.xApplication.process.Xform.Elslider#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/slider|Slider 滑块的 Events章节}
         */
        /**
         * 数据改变时触发（使用鼠标拖曳时，活动过程实时触发）。this.event[0]为改变后的值
         * @event MWF.xApplication.process.Xform.Elslider#input
         * @see {@link https://element.eleme.cn/#/zh-CN/component/slider|Slider 滑块的 Events章节}
         */
        "elEvents": ["change", "input"]
    },
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member MWF.xApplication.process.Xform.Elinput#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elinput").json;       //获取组件的json对象
     * var json = this.form.get("elinput").vm.$data;   //获取Vue组件的data数据，
     *
     * //通过json对象操作Element组件
     * json.disabled = true;     //设置输入框为禁用
     */
    // _loadNode: function(){
    //     if (this.isReadonly()) this.json.disabled = true;
    //     this._loadNodeEdit();
    // },
    _loadMergeReadContentNode: function( contentNode, data ){
        contentNode.set("text", data.data);
    },
    _appendVueData: function(){
        this.form.Macro.environment.data.check(this.json.id);
        this.json[this.json.id] = this._getBusinessData();

        if (!this.json.max || !this.json.max.toFloat()) this.json.max = 100;
        if (!this.json.min || !this.json.min.toFloat()) this.json.min = 0;
        this.json.min = this.json.min.toFloat();
        this.json.max = this.json.max.toFloat();

        if (!this.json.step || !this.json.step.toFloat()) this.json.step = 1;
        this.json.step = this.json.step.toFloat();

        if (this.json.showTooltip!==false) this.json.showTooltip = true;

        if (this.json.vertical && !this.json.height) this.json.height = "100px";
        if (!this.json.height) this.json.height = "";
        if (!this.json.inputSize) this.json.inputSize = "";
        if (!this.json.tooltipClass) this.json.tooltipClass = "";

        if (!this.json.disabled) this.json.disabled = false;

        if (this.json.marksScript && this.json.marksScript.code){
            this.json.marks = this.form.Macro.exec(this.json.marksScript.code, this);
        }else{
            this.json.marks = {};
        }
    },
    appendVueExtend: function(app){
        if (!app.methods) app.methods = {};
        // app.methods.$loadElEvent = function(ev){
        //     this.validationMode();
        //     if (ev==="change") this._setBusinessData(this.getInputData());
        //     if (this.json.events && this.json.events[ev] && this.json.events[ev].code){
        //         this.form.Macro.fire(this.json.events[ev].code, this, event);
        //     }
        // }.bind(this);

        if (this.json.formatTooltip && this.json.formatTooltip.code){
            var fun = this.form.Macro.exec(this.json.formatTooltip.code, this);
            if (o2.typeOf(fun)==="function"){
                app.methods.$formatTooltip = function(){
                    fun.apply(this, arguments);
                }.bind(this);
            }else{
                app.methods.$formatTooltip = function(){};
            }
        }
    },
    _createElementHtml: function(){
        var html = "<el-slider";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :max=\"max\"";
        html += " :min=\"min\"";
        html += " :step=\"step\"";
        html += " :show-stops=\"showStops\"";
        html += " :range=\"range\"";
        html += " :vertical=\"vertical\"";
        html += " :height=\"height\"";
        html += " :show-input=\"showInput\"";
        html += " :show-input-controls=\"showInputControls\"";
        html += " :input-size=\"inputSize\"";
        html += " :show-tooltip=\"showTooltip\"";
        html += " :tooltip-class=\"tooltipClass\"";
        html += " :disabled=\"disabled\"";
        html += " :marks=\"marks\"";

        if (this.json.formatTooltip && this.json.formatTooltip.code){
            html += " :format-tooltip=\"$formatTooltip\"";
        }

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });
        // this.options.elEvents.forEach(function(k){
        //     html += " @"+k+"=\"$loadElEvent('"+k+"')\"";
        // });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }
        if (this.json.elStyles) html += " :style=\"elStyles\"";
        // if (this.json.elStyles){
        //     var style = "";
        //     Object.keys(this.json.elStyles).forEach(function(k){
        //         if (this.json.elStyles[k]) style += k+":"+this.json.elStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }
        html += ">";
        html += "</el-slider>";
        return html;
    }
    // __setReadonly: function(data){
    //
    // }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Elinput 基于Element UI的开关组件。
 * @o2cn 开关组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/switch|Element UI Switch 开关}
 */
MWF.xApplication.process.Xform.Elswitch = MWF.APPElswitch =  new Class(
    /** @lends MWF.xApplication.process.Xform.Elswitch# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * switch 状态发生变化时的回调函数。this.event[0]为新状态的值
         * @event MWF.xApplication.process.Xform.Elswitch#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/switch|开关组件的的 Events章节}
         */
        "elEvents": ["change"]
    },
    _loadMergeReadContentNode: function( contentNode, data ){
        this._loadActiveJson();
        if (data.data==="" || data.data){
            contentNode.set("text", (this.json.activeText || "true"));
        }else{
            contentNode.set("text", (this.json.inactiveText || "false"));
        }
    },
    /**
     * @summary 组件的配置信息，同时也是Vue组件的data。
     * @member MWF.xApplication.process.Xform.Elinput#json {JsonObject}
     * @example
     *  //可以在脚本中获取此对象，下面两行代码是等价的，它们获取的是同一个对象
     * var json = this.form.get("elinput").json;       //获取组件的json对象
     * var json = this.form.get("elinput").vm.$data;   //获取Vue组件的data数据，
     *
     * //通过json对象操作Element组件
     * json.disabled = true;     //设置输入框为禁用
     */
    // _loadNode: function(){
    //     if (this.isReadonly()) this.json.disabled = true;
    //     this._loadNodeEdit();
    // },
    _appendVueData: function(){
        this.form.Macro.environment.data.check(this.json.id);
        this.json[this.json.id] = this._getBusinessData();

        if (!this.json.width || !this.json.width.toFloat()) this.json.width = 40;
        if (!this.json.activeText) this.json.activeText = "";
        if (!this.json.inactiveText) this.json.inactiveText = "";
        if (!this.json.activeColor) this.json.activeColor = "#409EFF";
        if (!this.json.inactiveColor) this.json.inactiveColor = "#C0CCDA";

        if (!this.json.activeIconClass) this.json.activeIconClass = "";
        if (!this.json.inactiveIconClass) this.json.inactiveIconClass = "";

        if (!this.json.readonly) this.json.readonly = false;
        if (!this.json.description) this.json.description = "";
        if (!this.json.disabled) this.json.disabled = false;

        this._loadActiveJson();
    },
    _loadActiveJson: function(){
        if (!this.json.valueType) this.json.activeValueType = "boolean";
        switch(this.json.valueType){
            case "boolean":
                this.json.activeValue = true;
                this.json.inactiveValue = false;
                break;
            case "string":
                if (!this.json.activeValue) this.json.activeValue = "1";
                if (!this.json.inactiveValue) this.json.inactiveValue = "0";
                break;
            case "number":
                if (!this.json.activeValue) this.json.activeValue = 1;
                if (!this.json.inactiveValue) this.json.inactiveValue = 0;
                this.json.activeValue = this.json.activeValue.toFloat();
                this.json.inactiveValue = this.json.inactiveValue.toFloat();
                break;
            default:
                this.json.activeValue = true;
                this.json.inactiveValue = false;
        }
    },

    // appendVueExtend: function(app){
    //     if (!app.methods) app.methods = {};
    //     app.methods.$loadElEvent = function(ev){
    //         this.validationMode();
    //         if (ev==="change") this._setBusinessData(this.getInputData());
    //         if (this.json.events && this.json.events[ev] && this.json.events[ev].code){
    //             this.form.Macro.fire(this.json.events[ev].code, this, event);
    //         }
    //     }.bind(this);
    // },
    _createElementHtml: function(){
        var html = "<el-switch";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :width=\"width\"";
        html += " :active-text=\"activeText\"";
        html += " :inactive-text=\"inactiveText\"";
        html += " :active-color=\"activeColor\"";
        html += " :inactive-color=\"inactiveColor\"";

        html += " :disabled=\"disabled\"";
        html += " :active-icon-class=\"activeIconClass\"";
        html += " :inactive-icon-class=\"inactiveIconClass\"";

        html += " :active-value=\"activeValue\"";
        html += " :inactive-value=\"inactiveValue\"";

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });
        // this.options.elEvents.forEach(function(k){
        //     html += " @"+k+"=\"$loadElEvent('"+k+"')\"";
        // });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";
        // if (this.json.elStyles){
        //     var style = "";
        //     Object.keys(this.json.elStyles).forEach(function(k){
        //         if (this.json.elStyles[k]) style += k+":"+this.json.elStyles[k]+";";
        //     }, this);
        //     html += " style=\""+style+"\"";
        // }
        html += ">";
        html += "</el-switch>";
        return html;
    },
    __setReadonly: function(data){
        if (this.isReadonly()){
            if (data==="" || data){
                this.node.set("text", (this.json.activeText || "true"));
            }else{
                this.node.set("text", (this.json.inactiveText || "false"));
            }

            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }

            if( !this.eventLoaded ){
                this._loadDomEvents();
                this.eventLoaded = true;
            }

            this.fireEvent("load");
            this.isLoaded = true;
        }
    },

        getExcelData: function(){
            var data = this.json[this.json.$id];
            if (data==="" || data){
                return this.json.activeText || "true";
            }else{
                return this.json.inactiveText || "false";
            }
        },
        setExcelData: function(d){
            var data = true;
            this.excelData = d;
            if ( (d || "").toString === ( this.json.inactiveText || "false" ) ){
                data = false;
            }
            this.setData(data, true);
        }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Eltime 基于Element UI的时间选择器。
 * @o2cn 时间选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/time-picker|Element UI TimePicker 时间选择器}
 */
MWF.xApplication.process.Xform.Eltime = MWF.APPEltime =  new Class(
    /** @lends MWF.xApplication.process.Xform.Eltime# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 当 input 失去焦点时触发。this.event[0]指向组件实例
         * @event MWF.xApplication.process.Xform.Eltime#blur
         * @see {@link https://element.eleme.cn/#/zh-CN/component/time-picker|时间选择组件的Events章节}
         */
        /**
         * 当 input 获得焦点时触发。this.event[0]指向组件实例
         * @event MWF.xApplication.process.Xform.Eltime#focus
         * @see {@link https://element.eleme.cn/#/zh-CN/component/time-picker|时间选择组件的Events章节}
         */
        /**
         * 用户确认选定的值时触发。this.event[0]为组件绑定值
         * @event MWF.xApplication.process.Xform.Eltime#change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/time-picker|时间选择组件的Events章节}
         */
        "elEvents": ["focus", "blur", "change"]
    },
    _queryLoaded: function(){
        this._loadReadEditAbeld();
        var data = this._getBusinessData();
        if( ["picker"].contains(this.json.timeSelectType) && this.json.isRange) {
            if (typeOf(data) === "string") this._setBusinessData([data, ""]);
        }else{
            if( typeOf(data) === "array" )this._setBusinessData(data[0] || "");
        }
    },
    _appendVueData: function(){
        if (!this.json.readonly) this.json.readonly = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.clearable) this.json.clearable = false;
        if (!this.json.disabled) this.json.disabled = false;
        if (!this.json.editable) this.json.editable = false;
        if (!this.json.size) this.json.size = "";
        if (!this.json.prefixIcon) this.json.prefixIcon = "";
        if (!this.json.suffixIcon) this.json.suffixIcon = "";
        if (!this.json.description) this.json.description = "";
        if (!this.json.arrowControl) this.json.arrowControl = false;
        if (this.json.timeSelectType === "select"){
            this.json.pickerOptions = {
                "start": this.json.start,
                "step": this.json.step,
                "end": this.json.end
            };
        }else{
            this.json.pickerOptions = {
                "format": this.json.format
            };
            if (!this.json.isRange && this.json.selectableRange && this.json.selectableRange.code){
                this.json.pickerOptions.selectableRange = this.form.Macro.fire(this.json.selectableRange.code, this);
            }
        }
    },
    _createElementHtml: function() {
        if (this.json.timeSelectType === "select"){
            return this.createSelectElementHtml();
        }else{
            if (this.json.isRange) {
                return this.createPickerRangeElementHtml();
            } else {
                return this.createPickerElementHtml();
            }
        }
    },
    getCommonHtml: function(){
        var html = "";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :readonly=\"isReadonly\"";
        html += " :disabled=\"disabled\"";
		html += " :editable=\"editable\"";
		html += " :clearable=\"clearable\"";
        html += " :size=\"size\"";
        html += " :prefix-icon=\"prefixIcon\"";

        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        return html;
    },
    createSelectElementHtml: function(){
        var html = "<el-time-select";
        html += " :placeholder=\"description\"";
        html += " :picker-options=\"pickerOptions\"";
        html += this.getCommonHtml();
        html += "</el-time-select>";
        return html;
    },
    // createSelectRangeElementHtml: function(){
    //     var html = "<el-time-select";
    //     html += " :placeholder=\"startPlaceholder\"";
    //     html += this.getSelectOpt();
    //     html += this.getCommonHtml();
    //     html += "</el-time-select>";
    //
    //     html += "<span>"+this.json.rangeSeparator+"</span>";
    //
    //     html += "<el-time-select";
    //     html += " :placeholder=\"endPlaceholder\"";
    //     html += this.getSelectOpt();
    //     html += this.getCommonHtml();
    //     html += "</el-time-select>";
    //     return html;
    // },

    createPickerElementHtml: function(){
        var html = "<el-time-picker";
        html += " :placeholder=\"description\"";
        html += " :arrow-control=\"arrowControl\"";
        html += " :value-format=\"format\"";
        html += " :picker-options=\"pickerOptions\"";
        html += this.getCommonHtml();
        html += "</el-time-picker>";
        return html;
    },
    createPickerRangeElementHtml: function(){
        var html = "<el-time-picker";
        html += " is-range";
        html += " :range-separator=\"rangeSeparator\"";
        html += " :start-placeholder=\"startPlaceholder\"";
        html += " :end-placeholder=\"endPlaceholder\"";
        html += " :arrow-control=\"arrowControl\"";
        html += " :value-format=\"format\"";
        html += " :picker-options=\"pickerOptions\"";
        html += this.getCommonHtml();
        html += "</el-time-picker>";
        return html;
    },

        getExcelData: function(){
            var value = this.getData();
            return o2.typeOf(value) === "array" ? value.join(", ") : value;
        },
        setExcelData: function(data){
            var arr = this.stringToArray(data);
            this.excelData = arr;
            var value = arr.length === 0  ? arr[0] : arr;
            this.setData(value, true);
        }
});

o2.xDesktop.requireApp("process.Xform", "$Elinput", null, false);
/** @class Eltree 基于Element UI的树形控件。
 * @o2cn 树形控件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var input = this.form.get("name"); //获取组件
 * //方法2
 * var input = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|Element UI Tree 树形控件}
 */
MWF.xApplication.process.Xform.Eltree = MWF.APPEltree =  new Class(
    /** @lends MWF.xApplication.process.Xform.Eltree# */
    {
    Implements: [Events],
    Extends: MWF.APP$Elinput,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        /**
         * 节点被点击时的回调。this.event[0]指向传递给 data 属性的数组中该节点所对应的对象；
         * this.event[1]为节点对应的 Node；this.event[2]为节点组件本身
         * @event MWF.xApplication.process.Xform.Eltree#node-click
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 当某一节点被鼠标右键点击时会触发该事件。this.event[0]指向Event；
         * this.event[1]为传递给 data 属性的数组中该节点所对应的对象；this.event[2]为节点对应的 Node;
         * this.event[3]为节点组件本身
         * @event MWF.xApplication.process.Xform.Eltree#node-contextmenu
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 节点选中状态发生变化时的回调。this.event[0]为传递给 data 属性的数组中该节点所对应的对象；
         * this.event[1]为节点本身是否被选中；this.event[2]为节点的子树中是否有被选中的节点
         * @event MWF.xApplication.process.Xform.Eltree#check-change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 当复选框被点击的时候触发。this.event[0]为传递给 data 属性的数组中该节点所对应的对象；
         * this.event[1]为树目前的选中状态对象，包含 checkedNodes、checkedKeys、halfCheckedNodes、halfCheckedKeys 四个属性
         * @event MWF.xApplication.process.Xform.Eltree#check
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 当前选中节点变化时触发的事件。this.event[0]为当前节点的数据；
         * this.event[1]为当前节点的 Node 对象
         * * @event MWF.xApplication.process.Xform.Eltree#current-change
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 节点被展开时触发的事件。this.event[0]为传递给 data 属性的数组中该节点所对应的对象；
         * this.event[1]为节点对应的 Node；this.event[2]为节点组件本身
         * * @event MWF.xApplication.process.Xform.Eltree#node-expand
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 节点被关闭时触发的事件。this.event[0]为传递给 data 属性的数组中该节点所对应的对象；
         * this.event[1]为节点对应的 Node；this.event[2]为节点组件本身
         * * @event MWF.xApplication.process.Xform.Eltree#node-collapse
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 节点开始拖拽时触发的事件。this.event[0]为被拖拽节点对应的 Node；
         * this.event[1]为Event
         * * @event MWF.xApplication.process.Xform.Eltree#node-drag-start
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 拖拽进入其他节点时触发的事件。this.event[0]为被拖拽节点对应的 Node；
         * this.event[1]为所进入节点对应的 Node；this.event[2]为event
         * * @event MWF.xApplication.process.Xform.Eltree#node-drag-enter
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 拖拽离开某个节点时触发的事件。this.event[0]为被拖拽节点对应的 Node；
         * this.event[1]为所进入节点对应的 Node；this.event[2]为event
         * * @event MWF.xApplication.process.Xform.Eltree#node-drag-leave
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 在拖拽节点时触发的事件（类似浏览器的 mouseover 事件）	。this.event[0]为被拖拽节点对应的 Node；
         * this.event[1]为所进入节点对应的 Node；this.event[2]为event
         * * @event MWF.xApplication.process.Xform.Eltree#node-drag-over
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 拖拽结束时（可能未成功）触发的事件。this.event[0]为被拖拽节点对应的 Node；
         * this.event[1]为结束拖拽时最后进入的节点（可能为空）；
         * this.event[2]为被拖拽节点的放置位置（before、after、inner）
         * this.event[3]为event
         * @event MWF.xApplication.process.Xform.Eltree#node-drag-end
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        /**
         * 拖拽成功完成时触发的事件。this.event[0]为被拖拽节点对应的 Node；
         * this.event[1]为结束拖拽时最后进入的节点；
         * this.event[2]为被拖拽节点的放置位置（before、after、inner）
         * this.event[3]为event
         * @event MWF.xApplication.process.Xform.Eltree#node-drop
         * @see {@link https://element.eleme.cn/#/zh-CN/component/tree|树组件的Events章节}
         */
        "elEvents": ["node-click", "node-contextmenu", "check-change", "check", "current-change","node-expand",
            "node-collapse","node-drag-start","node-drag-enter","node-drag-leave","node-drag-over","node-drag-end","node-drop"]
    },
    __setReadonly: function(data){
        if (this.isReadonly()) {
            this.node.set("text", data);
            if( this.json.elProperties ){
                this.node.set(this.json.elProperties );
            }
            if (this.json.elStyles){
                this.node.setStyles( this._parseStyles(this.json.elStyles) );
            }

        }
    },
    _loadNode: function(){
        // if (this.isReadonly()) this.json.disabled = true;
        this._loadNodeEdit();
    },
    _appendVueData: function(){
        if (!this.json.emptyText) this.json.emptyText = "";
        // if (!this.json.renderAfterExpand) this.json.renderAfterExpand = true;
        if (!this.json.highlightCurrent) this.json.highlightCurrent = false;
        if (!this.json.defaultExpandAll) this.json.defaultExpandAll = false;
        // if (!this.json.expandOnClickNode) this.json.expandOnClickNode = true;
        if (!this.json.accordion) this.json.accordion = false;
        if (!this.json.indent) this.json.indent = 16;

        if (this.json.currentNodeKey && this.json.currentNodeKey.code){
            this.json.currentNodeKey = this.form.Macro.fire(this.json.currentNodeKey.code, this);
        }
        if( !this.json.defaultExpandAll && this.json.defaultExpandedKeys && this.json.defaultExpandedKeys.code ){
            this.json.defaultExpandedKeys = this.form.Macro.fire(this.json.defaultExpandedKeys.code, this);
        }
        if( this.json.showCheckbox && this.json.defaultCheckedKeys && this.json.defaultCheckedKeys.code ){
            this.json.defaultCheckedKeys = this.form.Macro.fire(this.json.defaultCheckedKeys.code, this);
        }
        // if( this.json.lazy && this.json.loadFun && this.json.loadFun.code  ){
        //     this.json.lazyLoadFun = function(node, resolve){
        //         return this.form.Macro.fire(this.json.loadFun.code, this, {
        //             node: node,
        //             resolve: resolve
        //         });
        //     }.bind(this)
        // }
        if( this.json.draggable ){
            if( this.json.allowDrag && this.json.allowDrag.code ){
                this.json.allowDragFun = function(node){
                    return this.form.Macro.fire(this.json.allowDrag.code, this, node);
                }.bind(this)
            }
            if( this.json.allowDrop && this.json.allowDrop.code ){
                this.json.allowDropFun = function(node){
                    return this.form.Macro.fire(this.json.allowDrop.code, this, node);
                }.bind(this)
            }
        }

        if (this.json.dataType === "script"){
            this.json.data = this.form.Macro.exec(((this.json.dataScript) ? this.json.dataScript.code : ""), this);
        }else{
            this.json.data = this.json.dataJson;
        }
        this.parseData();
    },
    _createElementHtml: function() {
        var html = "<el-tree";
        html += " v-model=\""+this.json.$id+"\"";
        html += " :data=\"data\"";
        html += " :empty-text=\"emptyText\"";
        html += " :props=\"defaultProps\"";
        html += " :render-after-expand=\"renderAfterExpand\"";
        html += " :highlight-current=\"highlightCurrent\"";
        html += " :default-expand-all=\"defaultExpandAll\"";
        html += " :expand-on-click-node=\"expandOnClickNode\"";
        html += " :accordion=\"accordion\"";
        html += " :indent=\"indent\"";


        if( this.json.nodeKey ){
            html += " :node-key=\"nodeKey\"";
        }
        if( this.json.currentNodeKey && this.json.currentNodeKey.code ){
            html += " :current-node-key=\"currentNodeKey\"";
        }
        if( !this.json.defaultExpandAll && this.json.defaultExpandedKeys && this.json.defaultExpandedKeys.code ){
            html += " :default-expanded-keys=\"defaultExpandedKeys\"";
        }
        if( this.json.showCheckbox ){
            html += " :show-checkbox=\"showCheckbox\"";
            html += " :check-on-click-node=\"checkOnClickNode\"";
            html += " :check-strictly=\"checkStrictly\"";
            if( this.json.defaultCheckedKeys && this.json.defaultCheckedKeys.code ){
                html += " :default-checked-keys=\"defaultCheckedKeys\"";
            }
        }
        // if( this.json.lazy ){
        //     html += " :lazy=\"lazy\"";
        //     if( this.json.loadFun && this.json.loadFun.code ){
        //         html += " :load=\"lazyLoadFun\"";
        //     }
        // }
        if( this.json.draggable ){
            html += " :draggable=\"draggable\"";
            if( this.json.allowDrag && this.json.allowDrag.code ){
                html += " :allow-drag=\"allowDragFun\"";
            }
            if( this.json.allowDrop && this.json.allowDrop.code ){
                html += " :allow-drop=\"allowDropFun\"";
            }
        }


        this.options.elEvents.forEach(function(k){
            html += " @"+k+"=\"$loadElEvent_"+k.camelCase()+"\"";
        });

        if (this.json.elProperties){
            Object.keys(this.json.elProperties).forEach(function(k){
                if (this.json.elProperties[k]) html += " "+k+"=\""+this.json.elProperties[k]+"\"";
            }, this);
        }

        if (this.json.elStyles) html += " :style=\"elStyles\"";

        html += ">";

        if (this.json.vueSlot) html += this.json.vueSlot;

        html += "</el-tree>";
        return html;
    },
     parseData: function ( data ) {
        if( !data )data = this.json.data;
        var config = {};
         //label和children转成defaultOptions的数组
         if( this.json.defaultProps ){
             var p = this.json.defaultProps;
             if( p.children !== "children" && o2.typeOf(p.children)==="string") config.children = p.children;
             if( p.label !== "label" && o2.typeOf(p.label)==="string" )config.label = p.label;
             if( p.disabled !== "disabled" && o2.typeOf(p.disabled)==="string")config.disabled = p.disabled;
             if( p.label !== "isLeaf" && o2.typeOf(p.isLeaf)==="string")config.isLeaf = p.isLeaf;
         }
        //把id转成成node-key,
        if( this.json.nodeKey && this.json.nodeKey !== "id" )config.id = this.json.nodeKey;
        if( Object.keys(config).length > 0 ){
            this._parseData(data, config);
        }
     },
     _parseData: function ( data, config ) {
         if( o2.typeOf(data) === "array" ){
             data.each(function(d){ this._parse(d, config) }.bind(this))
         }else{
             this._parse(data, config);
         }
     },
     _parse: function (data, config) {
         Object.each(config, function (value, key) {
             if( data[key] )data[value] = data[key];
         });
         var children = data[ config.children || "children" ];
         if(children && o2.typeOf(children)==="array" )this._parseData( children, config );
     }

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xApplication.process.Xform.Foxit = MWF.APPFoxit =  new Class({
    Extends: MWF.APP$Module,
    options:{
        "moduleEvents": [
            "afterOpen"
        ]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;

        if (this.json.isReadonly || this.form.json.isReadonly){
            this.mode  = "read";
        }else{
            if (this.json.readScript && this.json.readScript.code){
                var flag = this.form.Macro.exec(this.json.readScript.code, this);
                if (flag){
                    this.mode = "read";
                }
            }
        }

    },
    _loadUserInterface: function(){
        this.node.empty();
    },
    _afterLoaded: function(){
        if(this.mode !== "read"){
            this.createUpload();
        }

        this.data = this.getData();
        this.documentId = this.data.documentId;
        if(this.data.documentId === ""){
            this.createEmpty();
        }else {

            this.loadFoxit();
        }
    },
    createEmpty : function (){
        this.emptyNode = new Element("div",{"style" : "margin:20px;"}).inject(this.node);
        this.emptyNode.set("text",MWF.xApplication.process.Xform.LP.pdfview.nofile);
    },
    upload : function (){
        o2.require("o2.widget.Upload", null, false);
        var upload;
        if(this.documentId === ""){
            upload = new o2.widget.Upload(this.form.app.content, {
                "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                "method": "uploadAttachment",
                "parameter": {
                    "id": this.form.businessData.work.id
                },
                "accept" : ".ofd",
                "data":{
                    "site": "foxitAttachement"
                },
                "onCompleted": function(json){
                    this.documentId = json.data.id;
                    this.setData();
                    this.loadFoxit();
                }.bind(this)
            });
        }else {
            upload = new o2.widget.Upload(this.form.app.content, {
                "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                "method": "replaceAttachment",
                "parameter": {
                    "id" : this.documentId,
                    "workid": this.form.businessData.work.id
                },
                "accept" : ".ofd",
                "data":{
                },
                "onCompleted": function(json){
                    this.documentId = json.data.id;
                    this.setData();
                    this.loadFoxit();
                }.bind(this)
            });
        }

        upload.load();
    },
    createUpload : function (){


        this.uploadNode = new Element("div",{"style":"margin:10px;"}).inject(this.node);
        var upload;
        var uploadBtn = new Element("button",{"text":MWF.xApplication.process.Xform.LP.pdfview.upload,"style":"margin-left: 15px; color: rgb(255, 255, 255); cursor: pointer; height: 26px; line-height: 26px; padding: 0px 10px; min-width: 40px; background-color: rgb(74, 144, 226); border: 1px solid rgb(82, 139, 204); border-radius: 15px;"}).inject(this.uploadNode);
        uploadBtn.addEvent("click",function (){
            o2.require("o2.widget.Upload", null, false);

            if(this.documentId === ""){
                upload = new o2.widget.Upload(this.form.app.content, {
                    "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                    "method": "uploadAttachment",
                    "parameter": {
                        "id": this.form.businessData.work.id
                    },
                    "accept" : ".ofd",
                    "data":{
                        "site": "foxitAttachement"
                    },
                    "onCompleted": function(json){
                        this.documentId = json.data.id;
                        this.setData();
                        this.loadFoxit();
                    }.bind(this)
                });
            }else {
                upload = new o2.widget.Upload(this.form.app.content, {
                    "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                    "method": "replaceAttachment",
                    "parameter": {
                        "id" : this.documentId,
                        "workid": this.form.businessData.work.id
                    },
                    "accept" : ".ofd",
                    "data":{
                    },
                    "onCompleted": function(json){
                        this.documentId = json.data.id;
                        this.setData();
                        this.loadFoxit();
                    }.bind(this)
                });
            }

            upload.load();
        }.bind(this));

    },
    getData: function(){
        var data = {
            "documentId" : ""
        };
        if(this.form.businessData.data[this.json.id]){
            data.documentId = this.form.businessData.data[this.json.id].documentId;
        }
        return data;
    },
    setData: function(){

        var data = {
            "documentId" : this.documentId
        };
        this._setBusinessData(data);
    },
    loadFoxitByAttId : function (attId){

        var host = o2.Actions.getHost( "x_processplatform_assemble_surface" );
        var fileUrl = o2.filterUrl(host + "/x_processplatform_assemble_surface/jaxrs/attachment/download/" + attId + "/stream");

        var xtoken = layout.session.token;
        fileUrl = fileUrl + "?"+o2.tokenName+"=" + xtoken;


        //var callbackUrl = o2.filterUrl(host + "/x_processplatform_assemble_surface/jaxrs/attachment/update/"+attId+"/work/" + this.form.businessData.work.id);
        //callbackUrl = callbackUrl + "?"+o2.tokenName+"=" + xtoken + "&fileName=文件正文.ofd";


        if(this.iframe){
            this.iframe.set("src",this.json.api + "?docuri=" + encodeURIComponent(fileUrl) );
        }else {
            this.iframe = new Element("iframe").inject(this.iframeNode);
            this.iframe.set("src",this.json.api + "?docuri=" + encodeURIComponent(fileUrl));
            this.iframe.set("scrolling","no");
            this.iframe.set("frameborder",0);
            this.iframe.setStyles({
                "height" : "100%",
                "width" : "100%"
            });
        }
        if(this.emptyNode) {
            this.emptyNode.hide();
        }
        this.fireEvent("afterOpen");
    },
    loadFoxit: function(){

        this.iframeNode = new Element("div").inject(this.node);
        this.iframeNode.setStyles({
            "height": "100%"
        });

        var host = o2.Actions.getHost( "x_processplatform_assemble_surface" );
        var fileUrl = o2.filterUrl(host + "/x_processplatform_assemble_surface/jaxrs/attachment/download/" + this.documentId + "/stream");

        var xtoken = layout.session.token;
        fileUrl = fileUrl + "?"+o2.tokenName+"=" + xtoken;


        var callbackUrl = o2.filterUrl(host + "/x_processplatform_assemble_surface/jaxrs/attachment/update/"+this.documentId+"/work/" + this.form.businessData.work.id);
        callbackUrl = callbackUrl + "?"+o2.tokenName+"=" + xtoken + "&fileName=文件正文.ofd";


        if(this.iframe){
            this.iframe.set("src",this.json.api + "?docuri=" + encodeURIComponent(fileUrl) + "&saveuri="  + encodeURIComponent(callbackUrl));
        }else {
            this.iframe = new Element("iframe").inject(this.iframeNode);
            this.iframe.set("src",this.json.api + "?docuri=" + encodeURIComponent(fileUrl)+ "&saveuri="  + encodeURIComponent(callbackUrl));
            this.iframe.set("scrolling","no");
            this.iframe.set("frameborder",0);
            this.iframe.setStyles({
                "height" : "100%",
                "width" : "100%"
            });
        }
        if(this.emptyNode) {
            this.emptyNode.hide();
        }
        this.fireEvent("afterOpen");
    },

    hide: function(){
        this.node.hide();
    },
    show: function(){
        this.node.show();
    },
    isEmpty : function(){
    },
    save: function(){

    },
    validation: function(){return true}
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xApplication.process.Xform.Html = MWF.APPHtml =  new Class({
    Extends: MWF.APP$Module,
    load: function(){
        this.node.insertAdjacentHTML("beforebegin", this.json.text);
        this.node.destroy();
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Htmleditor HTML编辑器。
 * @o2cn HTML编辑器
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var htmlEditor = this.form.get("name"); //获取组件
 * //方法2
 * var htmlEditor = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Htmleditor = MWF.APPHtmleditor =  new Class(
    /** @lends MWF.xApplication.process.Xform.Htmleditor# */
    {
	Extends: MWF.APP$Module,
    options: {
        /**
         * 组件异步加载后触发.
         * @event MWF.xApplication.process.Xform.Htmleditor#afterLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["queryLoad", "load", "postLoad", "afterLoad"]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
    },
    load: function(){
        this._loadModuleEvents();
        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
            this._loadStyles();
            //this._loadEvents();

            this._afterLoaded();

            this.fireEvent("postLoad");
            this.fireEvent("load");
        }
    },

	_loadUserInterface: function(){
		this.node.empty();
        if (this.isReadonly()){
            // this.node.set("html", this._getBusinessData());
            this.node.setStyles({
                "-webkit-user-select": "text",
                "-moz-user-select": "text"
            });
            if( layout.mobile ){
                this.loadLazyImage(function () { //图片懒加载
                    var images = this.node.getElements("img");
                    //移动端设置图片宽度为100%
                    images.each( function( img ){
                        if( img.hasClass("lozad") ){
                            img.setStyles({
                                "max-width" : "100%"
                            });
                        }else{
                            img.setStyles({
                                "height": "auto",
                                "max-width" : "100%"
                            });
                        }
                    }.bind(this));
                    this.fireEvent("afterLoad");
                    this.fieldModuleLoaded = true;
                }.bind(this))
            }else{
                this.loadLazyImage(function () { //图片懒加载
                    if(this.json.enablePreview !== "n"){
                        this.loadImageViewer(); //PC端点击显示大图
                        this.fireEvent("afterLoad");
                        this.fieldModuleLoaded = true;
                    }
                }.bind(this));
            }
            this.node.loadCss("../o2_lib/htmleditor/ckeditor4161/contents_o2.css");
        }else{
            var config = Object.clone(this.json.editorProperties);
            if (this.json.config){
                if (this.json.config.code){
                    var obj = this.form.Macro.exec(this.json.config.code, this);
                    Object.each(obj, function(v, k){
                        config[k] = v;
                    });
                }
            }
            this.loadCkeditor(config);
        }
    //    this._loadValue();
	},
    loadLazyImage: function(callback){
        o2.require("o2.widget.ImageLazyLoader", function(){
            var loadder = new o2.widget.ImageLazyLoader(this.node, this._getBusinessData());
            loadder.load(function(){
                if(callback)callback();
            }.bind(this))
        }.bind(this));
    },
    loadImageViewer: function(){
        o2.require("o2.widget.ImageViewer", function(){
            var imageViewer = new o2.widget.ImageViewer(this.node);
            imageViewer.load();
        }.bind(this));
    },
    loadCkeditor: function(config){
        COMMON.AjaxModule.loadDom("ckeditor", function(){
            CKEDITOR.disableAutoInline = true;
            var editorDiv = new Element("div").inject(this.node);
            var htmlData = this._getBusinessData();
            if (htmlData){
                editorDiv.set("html", htmlData);
            }else if (this.json.templateCode){
                editorDiv.set("html", this.json.templateCode);
            }
            var height = this.node.getSize().y;
            var editorConfig = config || {};

            if (this.form.json.mode==="Mobile"){
                if (!editorConfig.toolbar && !editorConfig.toolbarGroups){
                    editorConfig.toolbar = [
                        { name: 'paragraph',   items: [ 'Bold', 'Italic', "-" , 'TextColor', "BGColor", 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock', "-", 'Undo', 'Redo' ] },
                        { name: 'basicstyles', items: [ 'Styles', 'FontSize']},
                        { name: 'insert', items : [ 'Image' ] }
                    ];
                }
            }

            editorConfig.base64Encode = !layout.mobile && (this.json.base64Encode === "y");
            editorConfig.enablePreview = (this.json.enablePreview !== "n");
            editorConfig.localImageMaxWidth = 2000;

            if(this.form.options.macro === "PageContext"){
                editorConfig.reference = this.form.json.id;
                editorConfig.referenceType = "portalPage";
            }else{
                editorConfig.reference = this.form.businessData.work.job;
                editorConfig.referenceType = "processPlatformJob";
            }

            if( editorConfig && editorConfig.extraPlugins ){
                var extraPlugins = editorConfig.extraPlugins;
                extraPlugins = typeOf( extraPlugins ) === "array" ? extraPlugins : extraPlugins.split(",");
                extraPlugins.push( 'lineheight' );
                extraPlugins.push( 'pagebreak' );
                extraPlugins.push( 'o2image' );
                extraPlugins.push( 'o2uploadimage' );
                extraPlugins.push('o2uploadremoteimage');
                editorConfig.extraPlugins = extraPlugins;
            }else{
                editorConfig.extraPlugins = ['lineheight','pagebreak', 'o2image','o2uploadimage', 'o2uploadremoteimage'];
            }

            if( editorConfig && editorConfig.removePlugins ){
                var removePlugins = editorConfig.removePlugins;
                removePlugins = typeOf( removePlugins ) === "array" ? removePlugins : removePlugins.split(",");
                editorConfig.removePlugins = removePlugins.concat(['image','easyimage','exportpdf','cloudservices']);
            }else{
                editorConfig.removePlugins = ['image','easyimage','exportpdf','cloudservices'];
            }



            // CKEDITOR.basePath = COMMON.contentPath+"/res/framework/htmleditor/ckeditor/";
            // CKEDITOR.plugins.basePath = COMMON.contentPath+"/res/framework/htmleditor/ckeditor/plugins/";
            this.editor = CKEDITOR.replace(editorDiv, editorConfig);

            this.editor.addCommand("ecnet", {
                exec:function(editor){
                    this.ecnet();
                }.bind(this)
            });
            this.editor.ui.add('ecnet', CKEDITOR.UI_BUTTON, {
                label:MWF.xApplication.process.Xform.LP.intelligentCorrection,
                icon: '/x_component_process_Xform/$Form/default/icon/ecnet.png',
                command:"ecnet"
            });

            this._loadEvents();
            //this.editor.on("loaded", function(){
            //    this._loadEvents();
            //}.bind(this));

            //this.setData(data)

            this.editor.on("change", function(){
                //this._setBusinessData(this.getData());
                //在数据模板和数据表格中时
                if( this.parentLine )this._setBusinessData(this.getData());
            }.bind(this));

            if (this.json.ecnet==="y"){
                // this.editor.on( "key", function( evt ) {
                //     // var char = evt.data.domEvent.$.char;
                //     // if ([".", ",", "?", ";", "'", " "].indexOf(char)!==-1){
                //     //     this.ecnet(evt.editor.getData());
                //     // }
                // }.bind(this));
                // this.editor.on("blur", function(){
                //     if (!this.notEcnetFlag) this.ecnet(this.getData());
                // }.bind(this));
            }

            this.fireEvent("afterLoad");
            this.fieldModuleLoaded = true;

            //    this._loadEvents();
        }.bind(this));
    },
    getEcnetString: function(node, nodes){
        for (var i=0; i<node.childNodes.length; i++){
            if (node.childNodes[i].nodeType===Node.TEXT_NODE){
                var s = this.ecnetString.length;
                this.ecnetString += node.childNodes[i].nodeValue;
                var e = this.ecnetString.length;

                nodes.push({
                    "pnode": node,
                    "node": node.childNodes[i],
                    "start": s, "end": e
                });
            }else{
                this.getEcnetString(node.childNodes[i], nodes);
            }
        }
    },
    createEcnetNode: function(node){
        var newNode = node.node.ownerDocument.createElement("span");

        var increment = 0;
        var html = node.node.nodeValue;
        node.ecnets.each(function(ecnet){
            var s = ecnet.begin+increment-node.start;
            var e = ecnet.end+increment-node.start;
            if (s<0) s=0;
            if (e>node.end+increment) e = node.end+increment;
            var length = html.length;

            var left = html.substring(0, s);
            var ecnetStr = html.substring(s, e);
            var right = html.substring(e, html.length);

            html = left+"<span class='o2_ecnet_item' style='color: red'><u>"+ecnetStr+"</u></span>"+right;
            increment += (html.length-length);

        }.bind(this));
        newNode.innerHTML = html;
        node.pnode.replaceChild(newNode, node.node);
        node.pnode.textNode = node.node;
        node.pnode.ecnetNode = newNode;

        var _self = this;
        var editorFrame = this.editor.document.$.defaultView.frameElement;
        var spans = newNode.getElementsByTagName("span");
        if (spans.length){
            for (var i = 0; i<spans.length; i++){
                var span = spans[i];
                if (span.className==="o2_ecnet_item"){
                    var ecnetNode = new Element("div", {"styles": {
                        "border": "1px solid #999999",
                        "box-shadow": "0px 0px 5px #999999",
                        "background-color": "#ffffff",
                        "position": "fixed",
                        "display": "none"
                    }}).inject(editorFrame, "after");
                    var correctNode = new Element("div", {
                        "styles": {
                            "padding": "3px 10px",
                            "font-weight": "bold",
                            "font-size": "12px",
                            "cursor": "pointer"
                        },
                        "text": node.ecnets[i].origin+"->"+node.ecnets[i].correct,
                        "events": {
                            "mouseover": function(){this.setStyle("background-color", "#dddddd")},
                            "mouseout": function(){this.setStyle("background-color", "#ffffff")},
                            "mousedown": function(){
                                var ecnetNode = this.getParent();
                                var node = ecnetNode.node;
                                var item = ecnetNode.node.ecnets[ecnetNode.idx];
                                var textNode = node.node.ownerDocument.createTextNode(item.correct);
                                ecnetNode.span.parentNode.replaceChild(textNode, ecnetNode.span);
                                ecnetNode.destroy();
                                node.node.nodeValue = node.pnode.ecnetNode.innerText;

                                node.ecnets.erase(item);
                                if (!node.ecnets.length){
                                    _self.ecnetNodes.erase(node);
                                }
                            }
                        }
                    }).inject(ecnetNode);
                    var ignoreNode = new Element("div", {
                        "styles": {
                            "padding": "3px 10px",
                            "font-size": "12px",
                            "cursor": "pointer"
                        },
                        "text": MWF.xApplication.process.Xform.LP.ignore,
                        "events": {
                            "mouseover": function(){this.setStyle("background-color", "#dddddd")},
                            "mouseout": function(){this.setStyle("background-color", "#ffffff")},
                            "mousedown": function(){
                                var ecnetNode = this.getParent();
                                var node = ecnetNode.node;
                                var item = ecnetNode.node.ecnets[ecnetNode.idx];
                                var textNode = node.node.ownerDocument.createTextNode(ecnetNode.span.innerText);
                                ecnetNode.span.parentNode.replaceChild(textNode, ecnetNode.span);
                                ecnetNode.destroy();
                                node.node.nodeValue = node.pnode.ecnetNode.innerText;

                                node.ecnets.erase(item);
                                if (!node.ecnets.length){
                                    _self.ecnetNodes.erase(node);
                                }
                            }
                        }
                    }).inject(ecnetNode);
                    ecnetNode.node = node;
                    ecnetNode.idx = i;

                    span.ecnetNode = ecnetNode;
                    ecnetNode.span = span;
                    span.addEventListener("click", function(){
                        var ecnetNode = this.ecnetNode;
                        ecnetNode.show();
                        var y = this.offsetTop;
                        var x = this.offsetLeft;
                        var w = this.offsetWidth;
                        var h = this.offsetHeight;
                        var p = editorFrame.getPosition();
                        var s = ecnetNode.getSize();
                        var top = y+p.y+h+5;
                        var left = x+p.x-((s.x-w)/2);

                        ecnetNode.style.left = ""+left+"px";
                        ecnetNode.style.top = ""+top+"px";

                        var _span = this;
                        var hideEcnetNode = function(){
                            ecnetNode.hide();
                            _span.ownerDocument.removeEventListener("mousedown", hideEcnetNode);
                        };
                        this.ownerDocument.addEventListener("mousedown", hideEcnetNode);

                    });

                }
            }
        }

        //node.pnode.ecnetInforNode = ecnetNode;

        // var spans = newNode.getElementsByTagName("span");
        // if (spans.length){
        //     var span = spans[0];
        //     span.addEventListener("click", function(){
        //         ecnetNode.style.display = "block";
        //         var y = span.offsetTop;
        //         var x = span.offsetLeft;
        //         var w = span.offsetWidth;
        //         var h = span.offsetHeight;
        //         var p = editorFrame.getPosition();
        //         var s = ecnetNode.getSize();
        //         var top = y+p.y+h+5;
        //         var left = x+p.x-((s.x-w)/2);
        //
        //         ecnetNode.style.left = ""+left+"px";
        //         ecnetNode.style.top = ""+top+"px";
        //     });
        //     span.addEventListener("mouseout", function(){});
        // }

    },
    clearEcnetNodes: function(){
        if (this.ecnetNodes && this.ecnetNodes.length){
            this.ecnetNodes.each(function(node){
                if (node.pnode.ecnetNode){
                    if (node.pnode.ecnetInforNode) node.pnode.ecnetInforNode.destroy();
                    node.pnode.ecnetInforNode = null;
                    node.pnode.replaceChild(node.pnode.textNode, node.pnode.ecnetNode);
                }
            }.bind(this));
            this.ecnetNodes = [];
        }
    },
    ecnet: function(data){
        //this.editor.document.$.body.innerText
        var editorFrame = this.editor.document.$.defaultView.frameElement;
        //var data = this.editor.getData();
        var body = this.editor.document.$.body;

        if (!this.ecnetNodes) this.ecnetNodes = [];
        if (this.ecnetNodes.length) this.clearEcnetNodes();

        var nodes = [];
        this.ecnetString = "";
        this.getEcnetString(body, nodes);

        MWF.Actions.get("x_general_assemble_control").ecnetCheck({"value": this.ecnetString}, function(json){
            if (json.data.itemList && json.data.itemList.length){

                nodes.each(function(node){
                    var items = [];
                    json.data.itemList.each(function(item){
                        if ((node.end<=item.end && node.end>item.begin) || (node.start>=item.begin && node.start<item.end) || (node.start<=item.begin && node.end>item.end)){
                            items.push(item);
                        }
                    }.bind(this));
                    if (items.length){
                        node.ecnets = items;
                        this.ecnetNodes.push(node);
                    }
                }.bind(this));


                this.ecnetNodes.each(function(node){
                    this.createEcnetNode(node);
                }.bind(this));


                // var item = json.data.itemList[0];
                // var left = data.substring(0, item.begin);
                // var ecnetStr = data.substring(item.begin, item.end);
                // var right = data.substring(item.end, data.length);
                //
                // var newData = left+"<span class='o2_ecnet_item' style='color:red' title='"+item.origin+"->"+item.correc+"'><u>"+ecnetStr+"</u></span>"+right;
                //this.editor.document.$.body.setSelectionRange(item.begin, item.end);
                //this.editor.setData(newData);

                // var iframe = editorFrame.clone();
                // iframe.inject(this.node);
                // iframe.position({
                //     "relativeTo": editorFrame,
                //     "position": 'upperLeft',
                //     "edge": 'upperLeft'
                // });
                // iframe.contentWindow.document.body.set("html", newData);
            }else{
                body = null;
                nodes = null;
            }
        }.bind(this));
    },
    _loadEvents: function(editorConfig){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                this.editor.on(key, function(event){
                    return this.form.Macro.fire(e.code, this, event);
                }.bind(this), this);
            }
        }.bind(this));

    },
    addModuleEvent: function(key, fun){
        this.editor.on(key, function(event){
            return (fun) ? fun(this, event) : null;
        }.bind(this), this);
    },
    _loadValue: function(){
        var data = this._getBusinessData();
    },
    // /**
    //  * @summary 重置组件的值为默认值或置空。
    //  *  @example
    //  * this.form.get('fieldId').resetData();
    //  */
    resetData: function(){
        this.setData(this._getBusinessData());
    },
    /**
     * @summary 判断组件值是否为空.
     * @example
     * if( this.form.get('fieldId').isEmpty() ){
     *     this.form.notice('HTML编辑器不能为空', 'warn');
     * }
     * @return {Boolean} 值是否为空.
     */
    isEmpty : function(){
        return !this.getData().trim();
    },
    /**
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
     * @summary 获取组件值。
     * @example
     * var data = this.form.get('fieldId').getData();
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  var data;
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      data = this.form.get('fieldId').getData();
     *  }else{
     *      data = this.data['fieldId']; //直接从数据中获取字段值
     *  }
     * @return 组件的数据.
     */
    getData: function(){
        this.clearEcnetNodes();
        return this.editor ? this.editor.getData() : this._getBusinessData();
    },
    /**
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
     * @summary 为组件赋值。
     * @param data{String} .
     * @example
     *  this.form.get("fieldId").setData("test"); //赋文本值
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      this.form.get('fieldId').setData( data );
     *  }else{
     *      this.data['fieldId'] = data;
     *  }
     */
    setData: function(data){
        this._setBusinessData(data);
        if (this.editor) this.editor.setData(data);
    },
    destroy: function(){
        if( this.editor )this.editor.destroy();
    },
    createErrorNode: function(text){
        node = new Element("div", {styles:{
            "margin-top": "0.3em"  
        }});
        var iconNode = new Element("div.ooicon-error", {
            "styles": {
                "width": "20px",
                "height": "1.2em",
                "float": "left",
                "display": "flex",
                "color": "red",
                "align-items": "center",
                "justify-content": "center"
                // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "height": "auto",
                "line-height": "1.2em",
                "margin-left": "20px",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
            if (!this.errNode.isIntoView()) this.errNode.scrollIntoView(false);
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            if (p.get("MWFtype") == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },

    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    validation: function(routeName, opinion){
        if (!this.validationConfig(routeName, opinion))  return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;

        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";

        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString()!="true"){
            this.notValidationMode(flag);
            return false;
        }
        return true;
    },


        getExcelData: function(){
            return this.getData();
        },
        setExcelData: function(data){
            if( typeOf(data) === "string" )data = data.replace(/&#10;/g,"<br>"); //excel字段换行是 &#10
            this.excelData = data;
            this.setData(data, true);
        },
        validationExcel: function () {
            if (!this.isReadonly()){
                var errorList = this.validationConfigExcel();
                if (errorList.length) return errorList;

                if (!this.json.validation) return [];
                if (!this.json.validation.code) return [];

                var flag = this.form.Macro.exec(this.json.validation.code, this);

                if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
                if (flag.toString() !== "true") {
                    return [flag];
                }
            }
            return [];
        },
        validationConfigExcel: function () {
            var errorList = [];
            if (this.json.validationConfig){
                if (this.json.validationConfig.length){
                    for (var i=0; i<this.json.validationConfig.length; i++) {
                        var flag = this.validationConfigItemExcel(this.json.validationConfig[i]);
                        if ( flag !== true ){
                            errorList.push( flag );
                        }
                    }
                }
            }
            return errorList;
        },
        validationConfigItemExcel: function(data){
            if ( data.status==="all"){
                var n = this._getBusinessData();
                var v = (data.valueType==="value") ? n : n.length;
                switch (data.operateor){
                    case "isnull":
                        if (!v)return data.prompt;
                        break;
                    case "notnull":
                        if (v)return data.prompt;
                        break;
                    case "gt":
                        if (v>data.value)return data.prompt;
                        break;
                    case "lt":
                        if (v<data.value)return data.prompt;
                        break;
                    case "equal":
                        if (v===data.value)return data.prompt;
                        break;
                    case "neq":
                        if (v!==data.value)return data.prompt;
                        break;
                    case "contain":
                        if (v.indexOf(data.value)!==-1) return data.prompt;
                        break;
                    case "notcontain":
                        if (v.indexOf(data.value)===-1)return data.prompt;
                        break;
                }
            }
            return true;
        }
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Iframe HTML iframe。
 * @o2cn iframe
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var iframe = this.form.get("name"); //获取组件
 * //方法2
 * var iframe = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Iframe = MWF.APPIframe =  new Class({
	Extends: MWF.APP$Module,

	_loadUserInterface: function(){
		this.node.empty();

        var src = this.json.src;
        if (this.json.valueType=="script"){
            src = this.form.Macro.exec(((this.json.script) ? this.json.script.code : ""), this);
        }

		this.iframe = new Element("iframe", {
			"src": src
		}).inject(this.node, "after");
		
		this.node.destroy();
		this.node = this.iframe.setStyles({
			"width": "100%",
			"border": "0"
		});
	}
}); 
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Image 图片。
 * @o2cn 图片
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var img = this.form.get("name"); //获取组件
 * //方法2
 * var img = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Image = MWF.APPImage =  new Class(
    {
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        if (this.json.properties && this.json.properties["src"]){
            var value = this.json.properties["src"];
            if ((value.indexOf("x_processplatform_assemble_surface")!=-1 || value.indexOf("x_portal_assemble_surface")!=-1 || value.indexOf("x_cms_assemble_control")!=-1) && !value.includes("../")){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                var host3 = MWF.Actions.getHost("x_cms_assemble_control");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                if (value.indexOf("/x_cms_assemble_control")!==-1){
                    value = value.replace("/x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }else if (value.indexOf("x_cms_assemble_control")!==-1){
                    value = value.replace("x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }
                value = o2.filterUrl(value);
            }
            try{
                this.node.set("src", value);
            }catch(e){}
        }else if (this.json.srcfile && this.json.srcfile!="none"){
            value = this.json.srcfile;
            if (typeOf(value)==="object"){
                var url;
                if(value.portal) {
                    url = MWF.xDesktop.getPortalFileUr(value.id, value.portal);
                }else if(value.appId){
                    url = MWF.xDesktop.getCMSFileUr(value.id, value.appId);
                }else{
                    url = MWF.xDesktop.getProcessFileUr(value.id, value.application);
                }
                url = o2.filterUrl(url);
                this.node.set("src", url);
            }else{
                var host = MWF.Actions.getHost("x_portal_assemble_surface");
                var action = MWF.Actions.get("x_portal_assemble_surface");
                var uri = action.action.actions.readFile.uri;
                uri = uri.replace("{flag}", value);
                uri = uri.replace("{applicationFlag}", this.form.json.application);
                value = host+"/x_portal_assemble_surface"+uri;
                value = o2.filterUrl(value);
                this.node.set("src", value);
            }
        }else if (typeOf(this.json.src)=="object"){
            var src = MWF.xDesktop.getImageSrc( this.json.src.imageId );
            this.node.set("src", src);
        }
    },
    reset: function(){
        this._loadUserInterface();
    }
});
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class ImageClipper 图片编辑组件。
 * @o2cn 图片编辑组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var imageClipper = this.form.get("name"); //获取组件
 * //方法2
 * var imageClipper = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.ImageClipper = MWF.APPImageClipper =  new Class(
    /** @lends MWF.xApplication.process.Xform.ImageClipper# */
    {
	Implements: [Events],
	Extends: MWF.APP$Module,
    options: {
        "moduleEvents": ["change", "load", "queryLoad", "postLoad"]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
        this.fieldModuleLoaded = false;
    },
    /**
     * @summary 重新加载组件。会执行postLoad事件。
     * @example
     * this.form.get("fieldId").reload(); //重新加载事件
     */
    reload: function(){
        this.node.empty();
        this._loadUserInterface();
        this._loadStyles();
        this.fireEvent("postLoad");
    },
    _loadUserInterface: function(){
        this.field = true;
        this.node.empty();
        var data = this._getBusinessData();
        if( data ){
            var img = new Element("img",{
                src : MWF.xDesktop.getImageSrc( data )
            });
            if (layout.mobile || COMMON.Browser.Platform.isMobile) {
                img.setStyles({
                    "max-width": "90%"
                })
            }else if( this.json.clipperType == "size" ){
                var width = ( this.json.imageWidth ) ? this.json.imageWidth.toInt() : 600;
                var height = ( this.json.imageHeight ) ? this.json.imageHeight.toInt() : 500;
                if( width && height ){
                    img.setStyles({
                        width : width+"px",
                        height : height+"px"
                    })
                }
            }
            if(this.json.imageStyles)img.setStyles(this.json.imageStyles);
            img.inject( this.node );
        }
        if( this.isReadonly())return;

        var divBottom = new Element("div").inject( this.node );
        var button = new Element("button").inject(divBottom);
        button.set({
			//"id": this.json.id,
			"text": this.json.name || this.json.id,
			"styles": this.form.json.buttonStyle || this.form.css.buttonStyles,
			"MWFType": this.json.type
        });
        if(this.json.buttonStyles){
            button.setStyles( this.json.buttonStyles );
        }
        if( this.form.json.formStyleType === 'v10' ){
            button.addClass('form-content-button');
        }
        button.addEvent("click", function(){
            this.validationMode();
            var d = this._getBusinessData();
            if (layout.mobile){
                o2.imageClipperCallback = function( str ){
                    var data = JSON.parse( str );
                    this.setData( data ? data.fileId : "", true );
                    this.validation();
                    o2.imageClipperCallback = null;
                }.bind(this);
                var imageBody = {
                    "mwfId" : this.json.id,
                    "callback" : "o2.imageClipperCallback",
                    "referencetype": this.getReferencetypeForMobile(),
                    "reference": this.getReferenceForMobile()
                };
                if (window.o2android && window.o2android.postMessage) {
                    var body = {
                        type: "uploadImage2FileStorage",
                        data: imageBody
                    };
                    window.o2android.postMessage(JSON.stringify(body));
                } else if( window.o2android && window.o2android.uploadImage2FileStorage ){
                    window.o2android.uploadImage2FileStorage(JSON.stringify(imageBody));
                }else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.uploadImage2FileStorage){
                    window.webkit.messageHandlers.uploadImage2FileStorage.postMessage(JSON.stringify(imageBody));
                }else {
                    this.selectImage( d, function(data){
                        this.setData( data ? data.id : "", true );
                        this.validation();
                    }.bind(this));
                }
            }else{
                this.selectImage( d, function(data){
                    this.setData( data ? data.id : "", true );
                    this.validation();
                }.bind(this));
            }
        }.bind(this));
        this.fieldModuleLoaded = true;
	},
    getReferencetypeForMobile: function() {
        var referencetype = "processPlatformJob";
        if(this.form.businessData.work && this.form.businessData.work.referencetype) {
            referencetype = this.form.businessData.work.referencetype
        }
        return referencetype;
    },
    getReferenceForMobile: function() {
        return this.form.businessData.work.job;
    },
    getTextData : function(){
        var value = this._getBusinessData() || "";
        return {"value": [value], "text": [value]};
    },
    /**
     * @summary 判断组件值是否为空.
     * @example
     * if( this.form.get('fieldId').isEmpty() ){
     *     this.form.notice('请上传图片', 'warn');
     * }
     * @return {Boolean} 值是否为空.
     */
    isEmpty : function(){
        return !this.getData();
    },
    /**
     * 获取上传的图片ID。
     * @summary 获取上传的图片ID。
     * @example
     * var id = this.form.get('fieldId').getData(); //获取上传的图片id
     * var url = MWF.xDesktop.getImageSrc( id ); //获取图片的url
     */
    getData: function( data ){
        return this._getBusinessData() || "";
    },
    setData: function( data, fireChange ){
        var old = this.getData();
        this._setBusinessData(data);
        var img = this.node.getElements("img");
        if( img && img.length )img.destroy();
        if( !data ){
            if (fireChange && old!==data) this.fireEvent("change");
            return;
        }
        var img = new Element("img",{
            src : MWF.xDesktop.getImageSrc( data )
        }).inject( this.node, "top" );
        if (layout.mobile || COMMON.Browser.Platform.isMobile) {
            img.setStyles({
                "max-width": "90%"
            })
        }else if( this.json.clipperType == "size" ){
            var width = (this.json.imageWidth) ? this.json.imageWidth.toInt() : 600;
            var height = (this.json.imageHeight) ? this.json.imageHeight.toInt() : 500;
            if (width && height) {
                img.setStyles({
                    width: width + "px",
                    height: height + "px"
                })
            }
        }
        if(this.json.imageStyles)img.setStyles(this.json.imageStyles);
        if (fireChange && old!==data) this.fireEvent("change");
    },

    selectImage: function(d, callback){
        var clipperType = this.json.clipperType || "unrestricted";
        var ratio = 1;
        var description = "";
        var maxSize = 800;
        if( clipperType == "unrestricted" ){
            ratio = 0;
        }else if( clipperType == "size" ){
            var width = (this.json.imageWidth) ? this.json.imageWidth.toInt() : 600;
            var height = (this.json.imageHeight) ? this.json.imageHeight.toInt() : 500;
            ratio = width / height;
            maxSize = Math.max( width, height );
            if( !isNaN( width ) && !isNaN( height )  ){
                description = MWF.LP.widget.pictureSize.replace(/{width}/g, width).replace(/{height}/g, height);
            }
        }else if( clipperType == "ratio" ){
            ratio = this.json.imageRatio || 1;
            description = MWF.LP.widget.pictureRatio.replace(/{ratio}/g, ratio);
        }
        MWF.xDesktop.requireApp("process.Xform", "widget.ImageClipper", function(){
            this.imageClipper = new MWF.xApplication.process.Xform.widget.ImageClipper(this.form.app, {
                "style": "default",
                "aspectRatio" : ratio,
                "description" : description,
                "imageUrl" : d ? MWF.xDesktop.getImageSrc( d ) : "",
                "reference" : this.form.businessData.work.job,
                "referenceType": "processPlatformJob",
                "resultMaxSize" : maxSize,
                "onChange" : function(){
                    callback( { src : this.imageClipper.imageSrc, id : this.imageClipper.imageId } );
                }.bind(this)
            });
            this.imageClipper.load();
        }.bind(this));
    },
    createErrorNode: function(text){
        node = new Element("div", {styles:{
            "margin-top": "0.3em"  
        }});
        var iconNode = new Element("div.ooicon-error", {
            "styles": {
                "width": "20px",
                "height": "1.2em",
                "float": "left",
                "color": "red",
                "display": "flex",
                "align-items": "center",
                "justify-content": "center"
                // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "height": "auto",
                "line-height": "1.2em",
                "margin-left": "20px",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
            if (!this.errNode.isIntoView()) this.errNode.scrollIntoView(false);
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            if (p.get("MWFtype") == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    validation: function(routeName, opinion){
        if (!this.validationConfig(routeName, opinion))  return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;
        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString()!="true"){
            this.notValidationMode(flag);
            return false;
        }
        return true;
    }
	
}); 
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xDesktop.requireApp("process.Xform", "Button", null, false);
/** @class Importer 导入数据组件，本组件通过导入模型来执行数据的导入，支持内容管理文档，流程管理work，自建表数据的导入。
 * @o2cn 导入数据组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var importer = this.form.get("fieldId"); //获取组件
 * //方法2
 * var importer = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.Button
 * @o2category FormComponents
 * @since v6.2
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Importer = MWF.APPImporter =  new Class(
    /** @lends MWF.xApplication.process.Xform.Importer# */
    {
	Implements: [Events],
    Extends: MWF.xApplication.process.Xform.Button,
    options: {
        /**
         * 加载importer（导入模型对象）的时候执行，可以通过this.target.importer获取导入模型对象。
         * @event MWF.xApplication.process.Xform.Importer#loadImporter
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 导入前触发，this.event指向导入的数据，您可以通过修改this.event来修改数据。
         * @event MWF.xApplication.process.Xform.Importer#beforeImport
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         * @example
         * <caption>this.event数据格式如下：</caption>
         *[
         *  [ "标题一","张三","男","大学本科","计算机","2001-1-2","2019-9-2" ], //第一行数据
         *  [ "标题二","李四","男","大学专科","数学","1998-1-2","2018-9-2" ]  //第二行数据
         *]
         */
        /**
         * 数据已经生成，前台进行数据校验时触发，this.event指向导入的数据。
         * @event MWF.xApplication.process.Xform.Importer#validImport
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         * @example
         * <caption>this.event数据格式如下：</caption>
         * {
         *     "data" : [
         *          [ "标题一","张三","男","大学本科","计算机","2001-1-2","2019-9-2" ], //第一行数据
         *          [ "标题二","李四","男","大学专科","数学","1998-1-2","2018-9-2" ]  //第二行数据
         * 	    ],
         *     "rowList": [], //导入的行对象数组，数据格式常见本章API的afterCreateRowData说明。
         *     "validted" : true  //是否校验通过，可以在本事件中修改该参数，确定是否强制导入
         * }
         */
        /**
         * 前台校验成功，并且后台执行完导入后触发，this.event指向后台返回的导入结果。
         * @event MWF.xApplication.process.Xform.Importer#afterImport
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         * @example
         * <caption>this.event格式如下：</caption>
         * {
         *     "status": "导入成功", //导入结果：状态有 "导入成功","部分成功","导入失败"
         *     "data": {}, //前台组织好的需要导入的数据
         *     "rowList": [], //前台组织的行对象数组
         *     "count" : 10, //导入总数量
         *     "failCount": 0, //失败数量
         *     "distribution": "" //导入时候时的错误信息
         * }
         */
        /**
         * 创建每行需要导入的数据前触发，this.event指向当前行对象，您可以通过修改this.event.importedData来修改数据。
         * @event MWF.xApplication.process.Xform.Importer#beforeCreateRowData
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 创建每行需要导入的数据后触发，this.event指向当前行对象。
         * @event MWF.xApplication.process.Xform.Importer#afterCreateRowData
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         * @example
         * <caption>this.event格式如下：</caption>
         * {
         *     "importData": [ "标题一","张三","男","大学本科","计算机","2001-1-2","2019-9-2" ], //导入的数据
         *     "data" : {//根据导入模型生成的业务数据
         *  	   {
         *  	    "subject", "标题一", //subject为导入模型列配置的路径
         *  	 	"name" : "张三",
         *  	    ...
         *     },
         *     "document": { //如果导入目标是内容管理，则包含document对象
         *          "title": "标题一"
         *          "identity": "xxx@xxx@I"
         *          ...
         *     },
         *     "work": { //如果导入目标是流程管理，则包含work对象
         *          "title": "标题一"
         *          "identity": "xxx@xxx@I"
         *          ...
         *     },
         *     "errorTextList" : [],  //错误信息
         *     "errorTextListExcel": [] //在出错界面导出Excel时的错误信息
         * }
         */
        "moduleEvents": ["queryLoad","postLoad", "afterLoad", "loadImporter",
            "beforeImport", "validImport","afterImport", "beforeCreateRowData", "afterCreateRowData"]
    },
    _loadUserInterface: function(){
        var button = this.node.getElement("button");
        if (!button) button = new Element("button");
        button.inject(this.node, "after");
        this.node.destroy();
        this.node = button;
        this.node.set({
            "id": this.json.id,
            "text": this.json.name || this.json.id,
            "styles": this.form.json.buttonStyle || this.form.css.buttonStyles,
            "MWFType": this.json.type
        });
        if( this.json.properties ){
            this.node.set(this.json.properties )
        }
        this.node.addEvent("click", function(){
            this.upload();
        }.bind(this));
        if( this.json.allowDownloadTempalte && this.json.downloadTempalteFieldId ){
            this.setDownloadEvent();
        }
    },
    getImporter: function(callback){
        var options;
        if( this.json.queryImportModel.id ){
            options = { "id" : this.json.queryImportModel.id };
        }else{
            options = {
                "application": this.json.queryImportModel.application || this.json.queryImportModel.appName,
                "name": this.json.queryImportModel.alias || this.json.queryImportModel.name
            }
        }
        MWF.xDesktop.requireApp("query.Query", "Importer", function () {
            /**
             * @summary 导入模型对象.
             * @member {MWF.xApplication.query.Query.Importer}
             * @example
             * var importer = this.form.get("fieldId").importer; //获取组件
             * if(importer)importer.importFromExcel(); //执行导入
             */
            this.importer = new MWF.xApplication.query.Query.Importer(this.form.app.content, options, {
                "onQueryLoad": function () {
                    this.fireEvent("loadImporter")
                }.bind(this),
                "onBeforeImport": function (importedData) {
                    this.fireEvent("beforeImport", [importedData])
                }.bind(this),
                "onValidImport": function (arg) {
                    this.fireEvent("validImport", [arg])
                }.bind(this),
                "onAfterImport": function ( infor ) {
                    this.fireEvent("afterImport", [infor])
                }.bind(this),
                "onBeforeCreateRowData": function (row) {
                    this.fireEvent("beforeCreateRowData", [row])
                }.bind(this),
                "onAfterCreateRowData": function (row) {
                    this.fireEvent("afterCreateRowData", [row])
                }.bind(this),
            }, this.form.app, this.form.Macro);
            if(callback)callback();
        }.bind(this));
    },
    upload: function () {
        if( this.importer ){
            this.importer.importFromExcel();
        }else{
            this.getImporter(function(){
                this.importer.load();
            }.bind(this))
        }

    },
    setDownloadEvent: function () {
        this.bindEvent = function () {
            var module = this._getModuleByPath(this.json.downloadTempalteFieldId);

            if(module)module.node.addEvent("click", function () {
                this.downloadTemplate();
            }.bind(this))

            this.fireEvent("afterLoad");

            //加载完成以后，删除事件
            this.form.removeEvent("afterModulesLoad", this.bindEvent );
        }.bind(this);

        //去要表单的所有组件加载完成以后再去获取外部组件
        this.form.addEvent("afterModulesLoad", this.bindEvent );
    },
    downloadTemplate: function(){
        if( this.importer ){
            this.importer.downloadTemplate( this.getExcelName() );
        }else{
            this.getImporter(function(){
                this.importer.downloadTemplate( this.getExcelName() );
            }.bind(this))
        }
    },

    getExcelName: function(){
        var title;
        if( this.json.excelName && this.json.excelName.code ){
            title = this.form.Macro.exec(this.json.excelName.code, this);
        }
        return title || ""
    }

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Label 文本组件。
 * @o2cn 文本组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var label = this.form.get("name"); //获取组件
 * //方法2
 * var label = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Label = MWF.APPLabel =  new Class(
    /** @lends MWF.xApplication.process.Xform.Label# */
    {
	Implements: [Events],
	Extends: MWF.APP$Module,

	_loadUserInterface: function(){
		if (this.json.valueType == "text"){
			this.node.set("text", this.json.text || "");
		}
		if (this.json.valueType == "script"){
			var code = (this.json.script) ? this.json.script.code : "";
			if (code){
			    var value = this.form.Macro.exec(code, this);
			    this._setNodeText(value);
				//this.node.set("text", this.form.Macro.exec(code, this) || "");
			}
		}
		if (this.json.prefixIcon || this.json.suffixIcon){
            var text = this.node.get("text");
            this.node.empty();

            var tNode = new Element("div", {"styles": {
            	"margin-left": (this.json.prefixIcon) ? "20px" : "0px",
                "margin-right": (this.json.suffixIcon) ? "20px" : "0px",
                "height": "100%"
			}, "text": text}).inject(this.node);

            var height = (this.node.offsetParent === null) ? "20" : this.node.getSize().y;
            if (this.json.prefixIcon){
                var node = new Element("div", {"styles": {
                    "float": "left",
                    "width": "20px",
                    "height": ""+height+"px",
                    "background": "url("+this.json.prefixIcon+") center center no-repeat"
                }}).inject(tNode, "before");
            }
            if (this.json.suffixIcon){
                var node = new Element("div", {"styles": {
                    "float": "right",
                    "width": "20px",
                    "height": ""+height+"px",
                    "background": "url("+this.json.suffixIcon+") center center no-repeat"
                }}).inject(tNode, "before");
            }
		}
	},
    _setNodeText: function(value){
        if (value && value.isAG){
            value.addResolve(function(v){
                this._setNodeText(v);
            }.bind(this));
        }else{
            o2.promiseAll(value).then(function(v){
                this.node.set("text", v || "");
            }.bind(this), function(){});
            //this.node.set("text", value || "");
        }
    },
    /**当参数为Promise的时候，请参考文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
     * @summary 为组件设置文本，该文本不会被保存到后台。
     * @param text{String|Promise} .
     * @example
     *  this.form.get("fieldId").setText("test"); //赋文本值
     * @example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var dict = new this.Dict("test"); //test为数据字典名称
     *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
     *  field.setText( promise );
     */
    setText: function(text){
	    if (!!text){
            o2.promiseAll(text).then(function(v){
                this.node.set("text", v || "");
            }.bind(this), function(){});
        }else{
            this.node.set("text", text || "");
        }
        //this.node.set("text", text);
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);

/** @class Log 流程记录组件。
 * @o2cn 流程记录组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var log = this.form.get("name"); //获取组件
 * //方法2
 * var log = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Log = MWF.APPLog =  new Class(
    /** @lends MWF.xApplication.process.Xform.Log# */
    {
	Extends: MWF.APP$Module,
    options: {
        /**
         * 加载数据后事件。
         * @event MWF.xApplication.process.Xform.Log#postLoadData
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}   `
         * @example
         * //触发该事件的时候可以获取到流程数据workLog
         * var workLog = this.target.workLog;
         * //可以修改workLog达到定制化流程记录的效果
         * do something
         */
        /**
         * 加载每行流程信息以后触发，可以通过this.event获得下列信息：
         * <pre><code>
         * {
         *    "data" : {}, //当前行流程信息
         *    "node" : logTaskNode, //当前节点
         *    "log" : object, //指向流程记录
         *    "type" : "task"  //"task"表示待办，"taskCompleted"表示已办
         * }
         </code></pre>
         * @event MWF.xApplication.process.Xform.Log#postLoadLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "postLoadData", "postLoadLine"]
    },

	_loadUserInterface: function(){
		this.node.empty();
        this.node.setStyle("-webkit-user-select", "text");
        if (this.form.businessData){
            if (this.json.logType!=="record"){
                if (this.form.businessData.workLogList){
                    if( this.form.businessData.work.completedTime && !this.form.isCheckWorkLogEndActivity ){
                        this.checkWorkLogEndActivity();
                    }
                    this.workLog = Array.clone(this.form.businessData.workLogList);
                    this.fireEvent("postLoadData");
                    this.loadWorkLog();
                }
            }else{
                if (this.form.businessData.recordList){
                    this.workLog = Array.clone(this.form.businessData.recordList);
                    this.fireEvent("postLoadData");
                    this.loadRecordLog();
                }
            }

        }
	},
    loadRecordLog: function(){
        if( !this.json.category || this.json.category === "none" ){
            if (this.json.mode==="table"){
                this.loadRecordLogTable();
            }else if (this.json.mode==="text"){
                this.loadRecordLogText();
            }else if (this.json.mode==="media"){
                this.loadRecordLogMedia();
            }else{
                this.loadRecordLogDefault();
            }
        }else{
            // this.loadCategoryList("_loadRecordCategoryList", "_loadRecordCategoryList");
            this.loadRecordCategoryList();
            if( !this.categoryList.length )return;
            this.expandCount = 0;
            if( this.json.expand && this.json.expand === "enable" ){
                this.expandCount = parseInt( this.json.expandCount );
            }
            this.table = new Element("table", this.json.tableProperties).inject( this.node );
            this.categoryList.each( function( key, idx ){
                var list = this.categoryJson[key];
                if( list && list.length ){

                    var tr = new Element("tr").inject( this.table );
                    if( this.expandCount && (idx + 1) > this.expandCount ){
                        tr.setStyle("display","none");
                    }
                    var text = key;
                    if( this.json.category === "unit" ){
                        text = key.split("@")[0];
                    }
                    new Element("td", {
                        styles : this.json.titleTdStyles,
                        text : text
                    }).inject( tr );

                    var td = new Element("td", {
                        styles : this.json.contentTdStyles
                    }).inject( tr );

                    var div = new Element("div",{
                        styles : this.json.contentDivStyles || {}
                    }).inject( td );


                    if( this.json.sortTypeInCategory === "completedTimeAsc" || this.json.sortTypeInCategory === "completedTimeDesc" ){
                        list.sort(function(a, b){
                            if( this.json.sortTypeInCategory === "completedTimeAsc" ) {
                                return Date.parse(a.recordTime) - Date.parse(b.recordTime);
                            }else if( this.json.sortTypeInCategory === "completedTimeDesc" ) {
                                return Date.parse(b.recordTime) - Date.parse(a.recordTime);
                            }
                        }.bind(this));


                        // sortedList = [];
                        // list.each( function( log ){
                        //     if (log.taskCompletedList.length) {
                        //         log.taskCompletedList.each(function (t) {
                        //             var copyLog = Object.clone( log );
                        //             copyLog.readList = [];
                        //             copyLog.readCompletedList = [];
                        //             copyLog.taskList = [];
                        //             copyLog.taskCompletedList = [t];
                        //             sortedList.push( copyLog );
                        //         }.bind(this));
                        //     }
                        // }.bind(this));
                        // sortedList.sort(function(a, b){
                        //     if( this.json.sortTypeInCategory === "completedTimeAsc" ) {
                        //         return Date.parse(a.taskCompletedList[0].completedTime) - Date.parse(b.taskCompletedList[0].completedTime);
                        //     }else if( this.json.sortTypeInCategory === "completedTimeDesc" ) {
                        //         return Date.parse(b.taskCompletedList[0].completedTime) - Date.parse(a.taskCompletedList[0].completedTime);
                        //     }
                        // }.bind(this));
                        // list.each( function( log ) {
                        //     if (log.taskList.length) {
                        //         log.taskList.each(function (t) {
                        //             var copyLog = Object.clone(log);
                        //             copyLog.readList = [];
                        //             copyLog.readCompletedList = [];
                        //             copyLog.taskCompletedList = [];
                        //             copyLog.taskList = [t];
                        //             sortedList.push(copyLog);
                        //         }.bind(this));
                        //     }
                        // })
                    }

                    if (this.json.mode==="table"){
                        this.loadRecordLogTable( list, div );
                    }else if (this.json.mode==="text"){
                        this.loadRecordLogText( list, div );
                    }else if (this.json.mode==="media"){
                        this.loadRecordLogMedia( list, div );
                    }else{
                        this.loadRecordLogDefault( list, div );
                    }

                    this._loadTableStyles();
                }
            }.bind(this));
            if( this.categoryList.length > this.expandCount ){
                this.loadExpandCollapseNode();
            }
        }
    },

    _loadRecordCategoryList : function( category ){
        this.categoryList = [];
        this.categoryJson = {};
        this.unitIndex = (this.json.unitLevel || "1").toInt() - 1;
        if( category === "fromOpinionGroup" ){
            this.workLog.sort( function( a, b ){
                if( a.properties.fromOpinionGroup && b.properties.fromOpinionGroup ) {
                    var array1 = a.properties.fromOpinionGroup.split("#");
                    var array2 = b.properties.fromOpinionGroup.split("#");
                    for (var i = 0; i < array1.length; i++) {
                        var value1 = array1[i];
                        var value2 = array2[i];
                        if (this.isNumber(value1) && this.isNumber(value2)) {
                            if (parseFloat(value1) !== parseFloat(value2)) {
                                return parseFloat(value1) - parseFloat(value2);
                            }else{
                                if( this.json.sortTypeInCategory === "none" ){
                                    return 0;
                                }else{
                                    return Date.parse(a.recordTime) - Date.parse(b.recordTime);
                                }
                            }
                        } else if (!this.isNumber(value1) && !this.isNumber(value2)) {
                            if( this.json.sortTypeInCategory === "none" ){
                                return 0;
                            }else{
                                return Date.parse(a.recordTime) - Date.parse(b.recordTime);
                            }
                        } else {
                            return this.isNumber(value1) ? -1 : 1;
                        }
                    }
                    return Date.parse(a.recordTime) - Date.parse(b.recordTime);
                }else if( a.properties.fromOpinionGroup || b.properties.fromOpinionGroup ){
                    return a.properties.fromOpinionGroup ? -1 : 1;
                }else{
                    if( this.json.sortTypeInCategory === "none" ){
                        return 0;
                    }else{
                        return Date.parse(a.recordTime) - Date.parse(b.recordTime);
                    }
                }
            }.bind(this))
        }
        this.workLog.each( function(log, idx){
            var key;
            if( this.json.category === "activityGroup" ) {
                if (log.properties.fromOpinionGroup) {
                    var arr = log.properties.fromOpinionGroup.split("#");
                    key = arr[arr.length - 1];
                } else {
                    key = log.fromActivityName;
                }
            }else if( this.json.category === "unitLevelName" ){
                if( log.properties.unitLevelName ){
                    var nameArray = log.properties.unitLevelName.split("/");
                    if( nameArray.length > this.unitIndex ){
                        key = nameArray[this.unitIndex];
                    }else{
                        key = nameArray.getLast();
                    }
                }
            }else{
                key = log[category];
            }

            if( key && this.checkRecordShow(log)){
                if( this.categoryList.indexOf( key ) === -1 ){
                    this.categoryList.push( key );
                }
                if( !this.categoryJson[key] )this.categoryJson[key] = [];
                this.categoryJson[key].push( log );
            }
        }.bind(this))
    },

    loadRecordLogTable: function( list, container ){
        var taskTable = new Element("table", {
            "styles": this.form.css.logTableTask,
            "border": "0",
            "cellSpacing": "0",
            "cellpadding": "3px",
            "width": "100%"
        }).inject(container || this.node);
        var tr = taskTable.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine);

        var td = tr.insertCell(0).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.person);
        td = tr.insertCell(1).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.activity);
        td = tr.insertCell(2).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.department);
        td = tr.insertCell(3).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.startTime);
        td = tr.insertCell(4).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.completedTime);
        td = tr.insertCell(5).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.route);
        td = tr.insertCell(6).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.opinion);

        td = tr.insertCell(7).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.arrivedActivitys);
        td = tr.insertCell(8).setStyles(this.form.css.logTableTaskTitle);
        td.set("text", MWF.xApplication.process.Xform.LP.arrivedUsers);

        if( list ){
            list.each(function(log, idx){
                this.loadRecordLogLine_table(log, idx, taskTable );
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkRecordShow(log)) this.loadRecordLogLine_table(log, idx, taskTable );
            }.bind(this));
        }
    },
    checkRecordShow: function(log){
        var flag = true;
        if (this.json.filterScript && this.json.filterScript.code){
            this.form.Macro.environment.log = log;
            this.form.Macro.environment.list = null;
            flag = this.form.Macro.exec(this.json.filterScript.code, this);
        }else{
            var isExactMatch = function (property) {
                return property && o2.typeOf(property)==="array" && property.length && property[0] === "yes";
            };
            if (this.json.filterActivity && this.json.filterActivity.length){
                filterActivitys = this.json.filterActivity;
                if(isExactMatch(this.json.filterActivityExactMatch)){ //精确匹配
                    flag = filterActivitys.split(/[;|,|\n]/gm).contains(log.fromActivityName); //用;,和空格分隔成数组
                }else{
                    flag = (filterActivitys.indexOf(log.fromActivityName)!==-1);
                }
            }

            if (this.json.filterActivityAlias && this.json.filterActivityAlias.length){
                filterActivityAlias = this.json.filterActivityAlias;
                //flag = ((log.fromActivityAlias) && filterActivityAlias.indexOf(log.fromActivityAlias)!==-1);
                if(log.fromActivityAlias){
                    if(isExactMatch(this.json.filterActivityAliasExactMatch)){ //精确匹配
                        flag = filterActivityAlias.split(/[;|,|\n]/gm).contains(log.fromActivityAlias); //用;,和空格分隔成数组
                    }else{
                        flag = (filterActivityAlias.indexOf(log.fromActivityAlias)!==-1);
                    }
                }else{
                    flag = false;
                }
            }

            if (this.json.filterPerson && this.json.filterPerson.length){
                if(isExactMatch(this.json.filterPersonExactMatch)) { //精确匹配
                    flag = false;
                    var filterPersonsList = this.json.filterPerson.split(/[;|,|\n]/gm);
                    var matchArr = log.person.split("@").concat([log.person]);
                    for(var i=0; i < filterPersonsList.length; i++){
                        if( matchArr.contains(filterPersonsList[i]) ){
                            flag = true;
                            break;
                        }
                    }
                }else{
                    flag = (this.json.filterPerson.indexOf(log.person)!==-1);
                    if (!flag) flag = (this.json.filterPerson.indexOf(o2.name.cn(log.person))!==-1);
                }
            }

            //if (this.json.filterRoute && this.json.filterRoute.length){
            //    filterRoutes = this.json.filterRoute;
            //    flag = (filterRoutes.indexOf(log.properties.routeName)!==-1);
            //}
            if (this.json.filterRoute && this.json.filterRoute.length){
                filterRoutes = this.json.filterRoute;
                if(isExactMatch(this.json.filterRouteExactMatch)){ //精确匹配
                    flag = filterRoutes.split(/[;|,|\n]/gm).contains(log.properties.routeName); //用;,和空格分隔成数组
                }else{
                    flag = (filterRoutes.indexOf(log.properties.routeName)!==-1);
                }
            }
        }
        return flag;
    },

    loadRecordLogLine_table: function(log, idx, taskTable){
        var style = ((idx % 2)===0) ? "logTableTaskLine" : "logTableTaskLine_even";
        if (log.type==="currentTask"){
            if (this.json.isTask) this.loadRecordTaskLine_table(log, taskTable, true, style);
        }else{
            this.loadRecordTaskLine_table(log, taskTable, false, style);
        }
    },
    loadRecordTaskLine_table: function(task, table, isTask, style){
        // var style = "logTableTaskLine";
        // "logTableTaskLine_even"

        css = (isTask) ? Object.merge(this.form.css["logTableTaskLine_task"], this.form.css[style] ): this.form.css[style];


        if (isTask) style = "logTableTaskLine_task";
        var tr = table.insertRow(table.rows.length);
        var td = tr.insertCell(0).setStyles(css);

        var person = (task.person) ? task.person.substring(0, task.person.indexOf("@")) : "";
        if (task.properties.empowerFromIdentity){
            var ep = o2.name.cn(task.properties.empowerFromIdentity);
            person = person + " "+MWF.xApplication.process.Xform.LP.replace+" " + ep;
        }
        if (task.type === "empower") task.properties.startTime = task.recordTime;
        td.set("text", person);
        td = tr.insertCell(1).setStyles(css);
        td.set("text", task.fromActivityName || "");
        td = tr.insertCell(2).setStyles(css);
        td.set("text", (task.unit) ? task.unit.substring(0, task.unit.indexOf("@")) : "");
        td = tr.insertCell(3).setStyles(css);
        td.set("text", task.properties.startTime || "");
        td = tr.insertCell(4).setStyles(css);
        td.set("text", task.recordTime || "");

        var router, opinion, arrivedActivitys, arrivedUsers;
        arrivedActivitys = task.properties.nextManualList.map(function(o){
            return o.activityName;
        }).join(",");
        arrivedUsers = (task.properties.nextManualTaskIdentityList && task.properties.nextManualTaskIdentityList.length) ? o2.name.cns(task.properties.nextManualTaskIdentityList).join(",") : "";

        switch (task.type) {
            case "empower":
                router = MWF.xApplication.process.Xform.LP.empower;
                var empowerTo = (task.properties.nextManualTaskIdentityList && task.properties.nextManualTaskIdentityList.length) ? o2.name.cns(task.properties.nextManualTaskIdentityList).join(",") : "";
                opinion = MWF.xApplication.process.Xform.LP.empowerTo + empowerTo;
                task.properties.startTime = task.recordTime;
                break;
            case "retract":
                router = MWF.xApplication.process.Xform.LP.retract;
                opinion = MWF.xApplication.process.Xform.LP.retract;
                break;
            case "reroute":
                router = task.properties.routeName || MWF.xApplication.process.Xform.LP.reroute;
                opinion = task.properties.opinion || MWF.xApplication.process.Xform.LP.rerouteTo+": "+arrivedActivitys;
                break;
            case "rollback":
                router = task.properties.routeName || MWF.xApplication.process.Xform.LP.rollback;
                opinion = task.properties.opinion || MWF.xApplication.process.Xform.LP.rollbackTo+": "+task.arrivedActivityName;
                break;
            case "reset":
                // var resetUser = task.properties.nextManualTaskIdentityList.erase(task.identity);
                // resetUserText = o2.name.cns(resetUser).join(",");
                router = task.properties.routeName || MWF.xApplication.process.Xform.LP.reset;
                opinion = task.properties.opinion || ""
                break;
            case "appendTask":
            case "back":
            case "addSplit":
            case "urge":
            case "expire":
            case "read":
            default:
                router = task.properties.routeName || "";
                opinion = task.properties.opinion || "";
        }


        td = tr.insertCell(5).setStyles(css);
        td.set("text",router);
        var opinionTd = tr.insertCell(6).setStyles(css);
        opinionTd.set("html", "<div style='display: inline-block; float: left'>"+o2.txt(opinion)+"</div>");
        td = tr.insertCell(7).setStyles(css);
        td.set("text",o2.txt(arrivedActivitys));
        td = tr.insertCell(8).setStyles(css);
        td.set("html", arrivedUsers);

        var atts = [];
        if (task.properties.mediaOpinion){
            var mediaIds = task.properties.mediaOpinion.split(",");
            if (this.form.businessData.attachmentList){
                this.form.businessData.attachmentList.each(function(att){
                    if (att.site==="$mediaOpinion"){
                        if (mediaIds.indexOf(att.id)!==-1) atts.push(att);
                    }
                }.bind(this));
            }
            if (atts.length) this.loadMediaOpinion(atts, opinionTd.getFirst(), "table");
        }

        this.fireEvent("postLoadLine",[{
            "data" : task,
            "node" : tr,
            "atts" : atts,
            "log" : this,
            "type" : isTask ? "task" : "taskCompleted"
        }]);
    },
    loadRecordLogDefault: function(list, container){
        var logActivityNode = new Element("div", {"styles": this.form.css.logActivityNode_record}).inject(container || this.node);
        if( list ){
            list.each(function(log, idx){
                this.loadRecordLogLine_default(log, idx, logActivityNode);
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkRecordShow(log)) this.loadRecordLogLine_default(log, idx, logActivityNode);
            }.bind(this));
        }
    },
    loadRecordLogLine_default: function(log, idx, container){
        //var style = ((idx % 2)===0) ? "logTableTaskLine_even" : "logTableTaskLine";
        var style = ((idx % 2)===0) ? "logActivityChildRecordNode" : "logActivityChildRecordNode_even";

        var childNode = new Element("div", {"styles": this.form.css[style]}).inject((container || this.node));
        if (log.type==="currentTask"){
            if (this.json.isTask) this.loadRecordTaskLine_default(log, childNode, true);
        }else{
            this.loadRecordTaskLine_default(log, childNode, false);
        }
    },

    getRecordTaskLineTextStyle: function(){
        return this.json.textStyle;
    },
    loadRecordTaskLine_default: function(task, node, isTask, margin, isZebra, nodeStyle, noIconNode){

        var style = "logTaskNode";
        var textStyle = "logTaskFloatTextNode";
        if (nodeStyle){
            style = "logTaskTextNode";
            textStyle = "logTaskTextNode";
        }
        var logTaskNode = new Element("div", {"styles": this.form.css[style]}).inject(node);
        var iconNode;
        if( !noIconNode ){
            iconNode = new Element("div", {"styles": this.form.css.logTaskIconNode_record}).inject(logTaskNode);
        }
        var textNode = new Element("div", {"styles": this.form.css[textStyle]}).inject(logTaskNode);

        if (isZebra){
            logTaskNode.setStyles(this.form.css[this.lineClass]);
            if (this.lineClass === "logTaskNode"){
                this.lineClass = "logTaskNode_even";
            }else{
                this.lineClass = "logTaskNode";
            }
        }

        var left = 0;
        if( iconNode ){
            if (margin) iconNode.setStyle("margin-left", margin);
            left = iconNode.getStyle("margin-left").toInt();
            left = left + 28;
        }
        if( !nodeStyle ){
            textNode.setStyle("margin-left",left+"px");
        }
        var html;
        var company = "";
        var atts = [];
        if (!isTask){
            company = (task.unitList) ? task.unitList[task.unitList.length-1] : "";
            html = this.getRecordTaskLineTextStyle();

            var lp = MWF.xApplication.process.Xform.LP;
            if (task.type=="empower") html = "<font style='color:#ff5400;'>{person}</font>（{department}）"+lp.in+"【{activity}】"+lp.activity+"，"+lp.empowerTo +"<font style='color:#ff5400;'>{empowerTo}</font>。（{time}）</font>";

            var nextTaskText = (task.properties.nextManualTaskIdentityList && task.properties.nextManualTaskIdentityList.length) ? o2.name.cns(task.properties.nextManualTaskIdentityList).join(",") : "";

            if (this.json.textStyleScript && this.json.textStyleScript.code){
                this.form.Macro.environment.log = task;
                this.form.Macro.environment.list = null;
                html = this.form.Macro.exec(this.json.textStyleScript.code, this);
            }

            // var person = (task.person) ? task.person.substring(0, task.person.indexOf("@")) : "";
            // if( task.type !== "empowerTask" && task.empowerFromIdentity){
            //     person = person+" "+lp.replace+" "+o2.name.cn(task.empowerFromIdentity||"");
            // }

            var person = (task.person) ? task.person.substring(0, task.person.indexOf("@")) : "";
            if (task.properties.empowerFromIdentity){
                var ep = o2.name.cn(task.properties.empowerFromIdentity);
                person = person + " "+MWF.xApplication.process.Xform.LP.replace+" " + ep;
            }

            var router, opinion, arrivedActivitys, arrivedUsers;
            arrivedActivitys = task.properties.nextManualList.map(function(o){
                return o.activityName;
            }).join(",");
            arrivedUsers = (task.properties.nextManualTaskIdentityList && task.properties.nextManualTaskIdentityList.length) ? o2.name.cns(task.properties.nextManualTaskIdentityList).join(",") : "";

            switch (task.type) {
                case "empower":

                    router = MWF.xApplication.process.Xform.LP.empower;
                    var empowerTo = (task.properties.nextManualTaskIdentityList && task.properties.nextManualTaskIdentityList.length) ? o2.name.cns(task.properties.nextManualTaskIdentityList).join(",") : "";
                    opinion = MWF.xApplication.process.Xform.LP.empowerTo + empowerTo;
                    task.properties.startTime = task.recordTime;
                    break;
                case "retract":
                    router = MWF.xApplication.process.Xform.LP.retract;
                    opinion = MWF.xApplication.process.Xform.LP.retract;
                    break;
                case "reroute":
                    router = task.properties.routeName || MWF.xApplication.process.Xform.LP.reroute;
                    opinion = task.properties.opinion || MWF.xApplication.process.Xform.LP.rerouteTo+": "+arrivedActivitys;
                    break;
                case "rollback":
                    router = task.properties.routeName || MWF.xApplication.process.Xform.LP.rollback;
                    opinion = task.properties.opinion || MWF.xApplication.process.Xform.LP.rollbackTo+": "+task.arrivedActivityName;
                    break;
                case "reset":
                    // var resetUser = task.properties.nextManualTaskIdentityList.erase(task.identity);
                    // resetUserText = o2.name.cns(resetUser).join(",");
                    // router = MWF.xApplication.process.Xform.LP.resetTo+":"+resetUserText;
                    router = task.properties.routeName || MWF.xApplication.process.Xform.LP.reset;
                    opinion = task.properties.opinion || "";
                    break;
                case "workTriggerProcessing":
                    router = task.properties.routeName || MWF.xApplication.process.Xform.LP.systemSubmit;
                    opinion = task.properties.opinion || MWF.xApplication.process.Xform.LP.autoFlowHtml.replace(/{time}/g, task.recordTime);
                    person = person || MWF.xApplication.process.Xform.LP.system;
                    break;
                case "appendTask":
                case "back":
                case "addSplit":
                case "urge":
                case "expire":
                case "read":
                case "task":
                case "empowerTask":
                default:
                    router = task.properties.routeName || "";
                    opinion = task.properties.opinion || "";
            }

            html = html.replace(/\{person\}/g, person ).replace(/{personDn}/g, task.person || '')
            html = html.replace(/\{department\}/g, (task.unit) ? task.unit.substring(0, task.unit.indexOf("@")) : "");
            html = html.replace(/\{route\}/g, o2.txt(router));
            html = html.replace(/\{time\}/g, task.recordTime);
            html = html.replace(/\{date\}/g, new Date().parse(task.recordTime).format("%Y-%m-%d"));
            html = html.replace(/\{opinion\}/g, o2.txt(opinion));
            html = html.replace(/\{company\}/g, company.substring(0, company.indexOf("@")));
            html = html.replace(/\{startTime\}/g, task.properties.startTime);
            html = html.replace(/\{startDate\}/g, new Date().parse(task.properties.startTime).format("%Y-%m-%d"));
            html = html.replace(/\{activity\}/g, o2.txt(task.fromActivityName));
            html = html.replace(/\{arrivedActivity\}/g, o2.txt(arrivedActivitys));
            html = html.replace(/\{img\}/g, "<span class='mwf_log_img'></span>");
            html = html.replace(/\{empowerTo\}/g, arrivedUsers);
            html = html.replace(/\{next\}/g, nextTaskText);

            //var html = MWF.xApplication.process.Xform.LP.nextUser + task.person+"("+task.department+")" +", "+
            //    MWF.xApplication.process.Xform.LP.selectRoute + ": [" + task.routeName + "], " +
            //    MWF.xApplication.process.Xform.LP.submitAt + ": " + task.completedTime+ ", " +
            //    MWF.xApplication.process.Xform.LP.idea + ": <font style=\"color: #00F\">" + (task.opinion || "")+"</font>";

            textNode.set("html", html);
            var imgNode = textNode.getElement(".mwf_log_img");
            if (task.properties.mediaOpinion){
                var mediaIds = task.properties.mediaOpinion.split(",");
                // var atts = [];
                if (this.form.businessData.attachmentList){
                    this.form.businessData.attachmentList.each(function(att){
                        if (att.site==="$mediaOpinion"){
                            if (mediaIds.indexOf(att.id)!==-1) atts.push(att);
                        }
                    }.bind(this));
                }
                if (atts.length){
                    if (imgNode){
                        this.loadMediaOpinion_show(atts, task, imgNode, true);
                        // atts.each(function(att){
                        //     this.loadMediaOpinion_image_show(att, task, imgNode);
                        // }.bind(this));

                    }else{
                        this.loadMediaOpinion(atts, textNode, "default");
                    }
                }
            }
        }else{
            this.loadRecordTaskLine_default_currentTask(task, textNode, iconNode);
            // var person = (task.person) ? task.person.substring(0, task.person.indexOf("@")) : "";
            // if (task.properties.empowerFromIdentity){
            //     var ep = o2.name.cn(task.properties.empowerFromIdentity);
            //     person = person + " "+MWF.xApplication.process.Xform.LP.replace+" " + ep;
            // }
            // html = person+"("+task.unit.substring(0, task.unit.indexOf("@"))+"), 【"+task.fromActivityName+"】" + MWF.xApplication.process.Xform.LP.processing+", "+
            //     MWF.xApplication.process.Xform.LP.comeTime + ": " + task.properties.startTime;
            // textNode.set("html", html);
            // if(iconNode)iconNode.setStyle("background-image", "url("+"../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)");
        }
        this.fireEvent("postLoadLine",[{
            "data" : task,
            "atts" : atts,
            "node" : logTaskNode,
            "log" : this,
            "type" : isTask ? "task" : "taskCompleted"
        }]);
    },

    loadRecordTaskLine_default_currentTask: function(task, textNode, iconNode){
        var person = (task.person) ? task.person.substring(0, task.person.indexOf("@")) : "";
        if (task.properties.empowerFromIdentity){
            var ep = o2.name.cn(task.properties.empowerFromIdentity);
            person = person + " "+MWF.xApplication.process.Xform.LP.replace+" " + ep;
        }

        if (this.json.textTaskStyle){
            var html = this.json.textTaskStyle;
            html = html.replace(/{person}/g, person)
            .replace(/{personDn}/g, task.person || '')
            .replace(/{department}/g, o2.name.cn(task.unit))
            .replace(/{activity}/g, task.fromActivityName)
            .replace(/{route}/g, MWF.xApplication.process.Xform.LP.processing + ' ...')
            .replace(/{img}/g, '')
            .replace(/{opinion}/g, '')
            .replace(/{time}/g, task.properties.startTime)

            textNode.set("html", html);
            if (iconNode) iconNode.setStyle("background-image", "url(" + "../x_component_process_Xform/$Form/" + this.form.options.style + "/icon/rightRed.png)");

        }else{
            html = person+"("+task.unit.substring(0, task.unit.indexOf("@"))+"), 【"+task.fromActivityName+"】" + MWF.xApplication.process.Xform.LP.processing+", "+
                MWF.xApplication.process.Xform.LP.comeTime + ": " + task.properties.startTime;
            textNode.set("html", html);
            if(iconNode)iconNode.setStyle("background-image", "url("+"../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)");

        }
    },

    loadRecordLogText: function(list, container){
        this.lineClass = "logTaskNode";
        if( list ){
            list.each(function(log, idx){
                this.loadRecordLogLine_text(log, idx, container);
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkRecordShow(log)) this.loadRecordLogLine_text(log, idx, container);
            }.bind(this));
        }
    },
    loadRecordLogLine_text: function(log, idx, container){
        if (log.type==="currentTask"){
            if (this.json.isTask) this.loadRecordTaskLine_text(log, container || this.node, true);
        }else{
            this.loadRecordTaskLine_text(log, container || this.node, false);
        }
    },
    loadRecordTaskLine_text: function(task, node, isTask){
        this.loadRecordTaskLine_default(task, node, isTask, "0px", false, true, true);
    },

    loadRecordLogMedia: function(list, container){
        if( list ){
            list.each(function(log, idx){
                this.loadRecordLogLine_media(log, idx, container);
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkRecordShow(log)) this.loadRecordLogLine_media(log, idx, container);
            }.bind(this));
        }

    },
    loadRecordLogLine_media: function(log, idx, container){
        this.loadRecordTaskLine_media(log, container);
    },
    loadRecordTaskLine_media: function(task, container){
        if (task.properties.mediaOpinion){
            var mediaIds = task.properties.mediaOpinion.split(",");
            var atts = [];
            if (this.form.businessData.attachmentList){
                this.form.businessData.attachmentList.each(function(att){
                    if (att.site==="$mediaOpinion"){
                        if (mediaIds.indexOf(att.id)!==-1) atts.push(att);
                    }
                }.bind(this));
            }
            var isCompleted = !!task.recordTime;
            task.completedTime = task.recordTime;
            var node = new Element("div").inject( container || this.node );
            if (atts.length) this.loadMediaOpinion_show(atts, task, node);

            this.fireEvent("postLoadLine",[{
                "data" : task,
                "atts" : atts,
                "node" : node,
                "log" : this,
                "type" : isCompleted ? "taskCompleted" : "task"
            }]);
        }
    },

    //worklog -----------------------------------------------------------------------------
    checkWorkLogEndActivity: function(){
        //判断流程已经结束，但是taskCompletedList为空，则补上系统自动流转
	    var workLogList = this.form.businessData.workLogList;
	    for( var i=workLogList.length-1; i>-1; i-- ){
	        var log = workLogList[i];
            if( log.arrivedActivityType === "end" ){
                if( !log.taskCompletedList )log.taskCompletedList = [];
                if( log.taskCompletedList.length === 0 ){
                    log.taskCompletedList.push({
                        "id": log.id,
                        "startTime": log.fromTime,
                        "completedTime": log.arrivedTime,
                        "person": MWF.xApplication.process.Xform.LP.systemSubmit+"@System@P",
                        "identity": MWF.xApplication.process.Xform.LP.systemSubmit+"@System@I",
                        "unit": "",
                        "activityName": log.arrivedActivityName,
                        "activityToken": "",
                        "routeName": log.routeName,
                        "opinion": "",
                        "processingType": "autoflow",
                        "properties": {
                            "prevTaskIdentityList": [],
                            "nextTaskIdentityList": [],
                            "prevTaskList": [],
                            "prevTask": {},
                            "opinion": ""
                        }
                    })
                }
                this.form.isCheckWorkLogEndActivity = true;
                return;
            }
        }
    },
    loadWorkLog: function(){
        if( !this.json.category || this.json.category === "none" ){
            if (this.json.mode==="table"){
                this.loadWorkLogTable();
            }else if (this.json.mode==="text"){
                   this.loadWorkLogText();
            }else if (this.json.mode==="media"){
                this.loadWorkLogMedia();
            }else{
                this.loadWorkLogDefault();
            }
        }else{
            this.loadCategoryList();
            if( !this.categoryList.length )return;
            this.expandCount = 0;
            if( this.json.expand && this.json.expand === "enable" ){
                this.expandCount = parseInt( this.json.expandCount || 0 );
            }
            this.table = new Element("table", this.json.tableProperties).inject( this.node );
            this.categoryList.each( function( key, idx ){
                var list = this.categoryJson[key];
                if( list && list.length ){

                    var tr = new Element("tr").inject( this.table );
                    if( this.expandCount && (idx + 1) > this.expandCount ){
                        tr.setStyle("display","none");
                    }
                    var text = key;
                    if( this.json.category === "unit" ){
                        text = key.split("@")[0];
                    }
                    new Element("td", {
                        styles : this.json.titleTdStyles,
                        text : text
                    }).inject( tr );

                    var td = new Element("td", {
                        styles : this.json.contentTdStyles
                    }).inject( tr );

                    var div = new Element("div",{
                        styles : this.json.contentDivStyles || {}
                    }).inject( td );

                    var sortedList = list;
                    if( this.json.sortTypeInCategory === "completedTimeAsc" || this.json.sortTypeInCategory === "completedTimeDesc" ){
                        sortedList = [];
                        list.each( function( log ){
                            if (log.taskCompletedList.length) {
                                log.taskCompletedList.each(function (t) {
                                    var copyLog = Object.clone( log );
                                    copyLog.readList = [];
                                    copyLog.readCompletedList = [];
                                    copyLog.taskList = [];
                                    copyLog.taskCompletedList = [t];
                                    sortedList.push( copyLog );
                                }.bind(this));
                            }
                        }.bind(this));
                        sortedList.sort(function(a, b){
                            if( this.json.sortTypeInCategory === "completedTimeAsc" ) {
                                return Date.parse(a.taskCompletedList[0].completedTime) - Date.parse(b.taskCompletedList[0].completedTime);
                            }else if( this.json.sortTypeInCategory === "completedTimeDesc" ) {
                                return Date.parse(b.taskCompletedList[0].completedTime) - Date.parse(a.taskCompletedList[0].completedTime);
                            }
                        }.bind(this));
                        list.each( function( log ) {
                            if (log.taskList.length) {
                                log.taskList.each(function (t) {
                                    var copyLog = Object.clone(log);
                                    copyLog.readList = [];
                                    copyLog.readCompletedList = [];
                                    copyLog.taskCompletedList = [];
                                    copyLog.taskList = [t];
                                    sortedList.push(copyLog);
                                }.bind(this));
                            }
                        })
                    }

                    if (this.json.mode==="table"){
                        this.loadWorkLogTable( sortedList, div );
                    }else if (this.json.mode==="text"){
                        this.loadWorkLogText( sortedList, div );
                    }else if (this.json.mode==="media"){
                        this.loadWorkLogMedia( sortedList, div );
                    }else{
                        this.loadWorkLogDefault( sortedList, div );
                    }

                    this._loadTableStyles();
                }
            }.bind(this));
            if( this.categoryList.length > this.expandCount ){
                this.loadExpandCollapseNode();
            }
        }
    },
    // loadCategoryList : function(m1, m2){
    //     var category;
    //     if( this.json.category === "activity" ){
    //         category = "fromActivityName";
    //         this[m1 || "_loadCategoryList"]( category );
    //     }else if( this.json.category === "unit" ){
    //         category = "unit";
    //         this[m2 || "_loadCategoryLitBySubData"]( category );
    //     }else if( this.json.category === "activityGroup" ){
    //         category = "fromOpinionGroup";
    //         this[m1 || "_loadCategoryList"]( category );
    //     }else{
    //         category = this.json.category;
    //         this[m1 || "_loadCategoryList"]( category );
    //     }
    // },
    loadCategoryList : function(){
        var category;
        switch(this.json.category) {
            case "activity":
                category = "fromActivityName";
                this._loadCategoryList(category);
                break;
            case "unit":
                category = "unit";
                this._loadCategoryLitBySubData(category);
                break;
            case "activityGroup":
                category = "fromOpinionGroup";
                this._loadCategoryList(category);
                break;
            default:
                category = this.json.category;
                this._loadCategoryList(category);
                break;
        }
    },
    loadRecordCategoryList: function(){
	    var category;
        switch(this.json.category) {
            case "activity":
                category = "fromActivityName";
                this._loadRecordCategoryList(category);
                break;
            case "unit":
                category = "unit";
                this._loadRecordCategoryList(category);
                break;
            case "activityGroup":
                category = "fromOpinionGroup";
                this._loadRecordCategoryList(category);
                break;
            case "unitLevelName":
                category = "unitLevelName";
                this._loadRecordCategoryList(category);
                break;
            default:
                category = this.json.category;
                this._loadRecordCategoryList(category);
                break;
        }
    },
        // isNumber : function( d ){
        //     return parseFloat(d).toString() !== "NaN"
        // },
    _loadCategoryList : function( category ){
        this.categoryList = [];
        this.categoryJson = {};
        if( category === "fromOpinionGroup" ){
            this.workLog.sort( function( a, b ){
              if( a.fromOpinionGroup && b.fromOpinionGroup ) {
                  var array1 = a.fromOpinionGroup.split("#");
                  var array2 = b.fromOpinionGroup.split("#");
                  for (var i = 0; i < array1.length; i++) {
                      var value1 = array1[i];
                      var value2 = array2[i];
                      if (this.isNumber(value1) && this.isNumber(value2)) {
                          if (parseFloat(value1) !== parseFloat(value2)) {
                              return parseFloat(value1) - parseFloat(value2);
                          }else{
                                if( this.json.sortTypeInCategory === "none" ){
                                    return 0;
                                }else{
                                    return Date.parse(a.fromTime) - Date.parse(b.fromTime);
                                }
                            }
                      } else if (!this.isNumber(value1) && !this.isNumber(value2)) {
                          if( this.json.sortTypeInCategory === "none" ){
                              return 0;
                          }else{
                              return Date.parse(a.fromTime) - Date.parse(b.fromTime);
                          }
                      } else {
                          return this.isNumber(value1) ? -1 : 1;
                      }
                  }
                  return Date.parse(a.fromTime) - Date.parse(b.fromTime);
              }else if( a.fromOpinionGroup || b.fromOpinionGroup ){
                  return a.fromOpinionGroup ? -1 : 1;
              }else{
                  if( this.json.sortTypeInCategory === "none" ){
                      return 0;
                  }else{
                      return Date.parse(a.fromTime) - Date.parse(b.fromTime);
                  }
              }
            }.bind(this))
        }
        this.workLog.each( function(log, idx){
            var key;
            if( this.json.category === "activityGroup" ){

                if( log.fromOpinionGroup ){
                    var arr = log.fromOpinionGroup.split("#");
                    key = arr[arr.length-1]
                }else{
                    key = log.fromActivityName;
                }
            }else{
                key = log[category];
            }

            if( key && this.checkShow(log)){
                var flag = false;

                for( var i=0; i< log.taskCompletedList.length; i++ ){
                    var taskCompleted = log.taskCompletedList[i];
                    flag = this.checkListShow(log, taskCompleted);
                    if( flag )break;
                }
                if (!flag && this.json.isTask){
                    for( var i=0; i< this.json.isTask.length; i++ ){
                        var task = log.taskList[i];
                        flag = this.checkListShow(log, task);
                        if( flag )break;
                    }
                }
                if(flag){
                    if( this.categoryList.indexOf( key ) === -1 ){
                        this.categoryList.push( key );
                    }
                    if( !this.categoryJson[key] )this.categoryJson[key] = [];
                    this.categoryJson[key].push( log );
                }
            }
        }.bind(this))
    },
    _loadCategoryLitBySubData : function( category ){
        this.categoryList = [];
        this.categoryJson = {};
        this.workLog.each( function(log, idx){
            var key = log[category];

            if( this.checkShow(log) ){
                var flag = false;

                for( var i=0; i< log.taskCompletedList.length; i++ ){
                    var taskCompleted = log.taskCompletedList[i];
                    flag = this.checkListShow(log, taskCompleted);
                    if( flag )break;
                }
                if (!flag && this.json.isTask){
                    for( var i=0; i< this.json.isTask.length; i++ ){
                        var task = log.taskList[i];
                        flag = this.checkListShow(log, task);
                        if( flag )break;
                    }
                }
                if(flag){
                    var log_copy = Object.clone(log);
                    log_copy.taskCompletedList = [];
                    log_copy.taskList = [];
                    log_copy.readCompletedList = [];
                    log_copy.readList = [];

                    var sub_categoryList = [];
                    var sub_categoryJson = {};

                    for( var i=0; i< log.taskCompletedList.length; i++ ){
                        var d = log.taskCompletedList[i];
                        var key = d[category];
                        if( key ){
                            if( sub_categoryList.indexOf( key ) === -1 ){
                                sub_categoryList.push( key );
                            }
                            if( !sub_categoryJson[key] )sub_categoryJson[key] = Object.clone(log_copy);
                            sub_categoryJson[key].taskCompletedList.push( d );
                        }
                    }

                    for( var i=0; i< log.taskList.length; i++ ){
                        var d = log.taskList[i];
                        var key = d[category];
                        if( key ){
                            if( sub_categoryList.indexOf( key ) === -1 ){
                                sub_categoryList.push( key );
                            }
                            if( !sub_categoryJson[key] )sub_categoryJson[key] = Object.clone(log_copy);
                            sub_categoryJson[key].taskList.push( d );
                        }
                    }

                    for( var i=0; i< log.readCompletedList.length; i++ ){
                        var d = log.readCompletedList[i];
                        var key = d[category];
                        if( key ){
                            if( sub_categoryList.indexOf( key ) === -1 ){
                                sub_categoryList.push( key );
                            }
                            if( !sub_categoryJson[key] )sub_categoryJson[key] = Object.clone(log_copy);
                            sub_categoryJson[key].readCompletedList.push( d );
                        }
                    }

                    for( var i=0; i< log.readList.length; i++ ){
                        var d = log.readList[i];
                        var key = d[category];
                        if( key ){
                            if( sub_categoryList.indexOf( key ) === -1 ){
                                sub_categoryList.push( key );
                            }
                            if( !sub_categoryJson[key] )sub_categoryJson[key] = Object.clone(log_copy);
                            sub_categoryJson[key].readList.push( d );
                        }
                    }

                    sub_categoryList.each( function(key){
                        if( this.categoryList.indexOf( key ) === -1 ){
                            this.categoryList.push( key );
                        }
                    }.bind(this));

                    for( var key in sub_categoryJson ){
                        if( !this.categoryJson[key] )this.categoryJson[key] = [];
                        this.categoryJson[key].push( sub_categoryJson[key] );
                    }
                }
            }

        }.bind(this))
    },
    _loadTableBorderStyle: function(){
        if (this.json.tableStyles && this.json.tableStyles.border){
            this.table.set("cellspacing", "0");
            this.table.setStyles({
                "border-top": this.json.tableStyles.border,
                "border-left": this.json.tableStyles.border
            });
            var ths = this.table.getElements("th");
            if( ths && ths.length ){
                ths.setStyles({
                    "border-bottom": this.json.tableStyles.border,
                    "border-right": this.json.tableStyles.border
                });
            }

            var tds = this.table.getElements("td");
            if( tds && tds.length ) {
                tds.setStyles({
                    "border-bottom": this.json.tableStyles.border,
                    "border-right": this.json.tableStyles.border
                });
            }
        }
    },
    _loadTableStyles: function(){
        Object.each(this.json.tableStyles || {}, function(value, key){
            var reg = /^border\w*/ig;
            if (!key.test(reg)){
                this.table.setStyle(key, value);
            }
        }.bind(this));
        this._loadTableBorderStyle();
    },
    loadExpandCollapseNode : function(){
        if( this.json.expand && this.json.expand === "enable" ){
            if( this.json.expandHTML ){
                this.expandNode = new Element("div",{
                    "html" : this.json.expandHTML
                }).inject( this.node, "bottom" );
                this.expandNode.addEvent("click", function(){
                    if( !this.json.category || this.json.category === "none" ){

                    }else{
                        this.table.getElements("tr").setStyle("display","");
                        this.expandNode.setStyle("display","none");
                        this.collapseNode.setStyle("display","");
                    }
                }.bind(this))
            }
            if( this.json.collapseHTML ){
                this.collapseNode = new Element("div",{
                    "html" : this.json.collapseHTML,
                    "styles" : { "display" : "none" }
                }).inject( this.node, "bottom" );
                this.collapseNode.addEvent("click", function(){
                    if( !this.json.category || this.json.category === "none" ){

                    }else{
                        var trs = this.table.getElements("tr");
                        for( var i=0; i<trs.length; i++ ){
                            if( i >= this.expandCount ){
                                trs[i].setStyle("display","none");
                            }
                        }
                        this.expandNode.setStyle("display","");
                        this.collapseNode.setStyle("display","none");
                    }
                }.bind(this))
            }
        }
    },


    loadWorkLogMedia: function(list, container){
        if( list ){
            list.each(function(log, idx){
                this.loadWorkLogLine_media(log, idx, container);
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkShow(log)) this.loadWorkLogLine_media(log, idx, container);
            }.bind(this));
        }

    },
    loadWorkLogLine_media: function(log, idx, container){
        if (log.taskCompletedList.length){
            log.taskCompletedList.each(function(taskCompleted){
                if (this.checkListShow(log, taskCompleted)) this.loadTaskLine_media(taskCompleted, log, container);
            }.bind(this));
        }
    },
    loadTaskLine_media: function(task, log, container){
        if (task.mediaOpinion){
            var mediaIds = task.mediaOpinion.split(",");
            var atts = [];
            if (this.form.businessData.attachmentList){
                this.form.businessData.attachmentList.each(function(att){
                    if (att.site==="$mediaOpinion"){
                        if (mediaIds.indexOf(att.id)!==-1) atts.push(att);
                    }
                }.bind(this));
            }
            var node = new Element("div").inject( container || this.node );
            if (atts.length) this.loadMediaOpinion_show(atts, task, node);

            this.fireEvent("postLoadLine",[{
                "data" : task,
                "atts" : atts,
                "node" : node,
                "log" : this,
                "type" : !!task.completedTime ? "taskCompleted" : "task"
            }]);
        }
    },
    loadMediaOpinion_show: function(atts, task, container, noName){
        atts.each(function(att){
            //if (!att.contentType) att.contentType = "image";
            if (att.type){
                if (att.type.indexOf("image")!==-1){
                    this.loadMediaOpinion_image_show(att, task, container, noName);
                }else if(att.type.indexOf("video")!==-1){
                    this.loadMediaOpinion_video_show(att, task, container);
                }else if(att.type.indexOf("audio")!==-1){
                    this.loadMediaOpinion_voice_show(att, task, container);
                }else{
                    this.loadMediaOpinion_voice_show(att, task, container);
                }
            }
        }.bind(this));
    },
    loadMediaOpinion_image_show: function(att, task, container, noName){
        var url = this.getMediaOpinionUrl(att);
        var node = new Element("div", {"styles": {"overflow": "hidden"}}).inject( container || this.node);
        if (!noName){
            var textNode = new Element("div", {
                "styles": {
                    "line-height": "28px",
                    "height": "28px"
                },
                "text": task.person.substring(0, task.person.indexOf("@"))+"("+task.completedTime+")"
            }).inject(node);
        }

        //var img = new Element("img", {"src": url, "styles": {"background-color": "#ffffff"}}).inject(node);
        //
        //var height = 200;
        //var width = 300;
        //if (layout.mobile){
        //    var size = img.getSize();
        //    width = 200;
        //    height = 200*(size.y/size.x);
        //}
        //img.setStyles({"width": ""+width+"px", "height": ""+height+"px"});


        var imgNode = new Element("div").inject(node);
        var width;
        if (layout.mobile){
            width = 200;
        }else{
            var pNode = node.getParent();
            var offset = imgNode.getPosition( pNode );
            //width = Math.min( pNode.getSize().x - offset.x - 2, 800 );
            width = pNode.getSize().x - offset.x - 42;
        }

        var img = new Element("img", {
            "src": url,
            "styles" : { width : width+"px" },
            "events" : {
                load : function(ev){
                    var nh=ev.target.naturalHeight;
                    var nw = ev.target.naturalWidth;
                    if( !layout.mobile && ( this.isNumber( this.json.handwritingWidth ) || this.isNumber( this.json.handwritingHeight ) ) ){
                        var size = this.getImageSize( nw, nh );
                        img.setStyles(size);
                        imgNode.setStyles(size);
                    }else{
                        var x = Math.min(nw, width);
                        img.setStyles({"width": ""+ x +"px"});
                        imgNode.setStyles({"width": ""+ x +"px"});
                    }
                }.bind(this)
            }
        }).inject(imgNode);

        // var size = img.getSize();
        // var x_y = size.x/size.y;
        // if (size.y>260){
        //     var y = 260;
        //     var x = 260*x_y;
        //     img.setStyles({"width": ""+x+"px", "height": ""+y+"px"})
        // }
    },
    isNumber : function( d ){
        return parseFloat(d).toString() !== "NaN"
    },
    getImageSize : function(naturalWidth, naturalHeight ){
        var ww = this.json.handwritingWidth;
        var wh = this.json.handwritingHeight;
        if( this.isNumber(ww)  && !this.isNumber(wh) ){
            return {
                width : Math.min( naturalWidth, parseInt( ww )  ) + "px",
                height : "auto"
            }
        }else if( !this.isNumber(ww)  && this.isNumber(wh) ){
            return {
                width : "auto",
                height : Math.min( naturalHeight, parseInt( wh )  ) + "px"
            }
        }else if( this.isNumber(ww)  && this.isNumber(wh) ){
            var flag = ( naturalWidth / parseInt(ww) ) > ( naturalHeight / parseInt(wh) );
            if( flag ){
                return {
                    width : Math.min( naturalWidth, parseInt( ww )  ) + "px",
                    height : "auto"
                }
            }else{
                return {
                    width : "auto",
                    height : Math.min( naturalHeight, parseInt( wh )  ) + "px"
                }
            }
        }
    },
    loadMediaOpinion_video_show: function(att, task, container){

    },
    loadMediaOpinion_voice_show: function(att, task, container){
        //var node = new Element("audio").inject(this.node);
        var url = this.getMediaOpinionUrl(att);
        var div = new Element("div", {"styles": {"overflow": "hidden"}}).inject(container || this.node);
        var textNode = new Element("div", {
            "styles": {
                "line-height": "28px",
                "height": "28px"
            },
            "text": task.person.substring(0, task.person.indexOf("@"))+"("+task.completedTime+")"
        }).inject(div);

        var node = new Element("audio", {"loop": false, "controls": true}).inject(div);
        node.set("src", url);
        //this.audioNode.play();
    },

    loadWorkLogTable: function( list, container ){
        if( list ){
            list.each(function(log, idx){
                this.loadWorkLogLine_table(log, idx, container );
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkShow(log)) this.loadWorkLogLine_table(log, idx, container );
            }.bind(this));
        }
    },
    loadWorkLogLine_table: function(log, idx, container){
        if (!log.readList) log.readList = [];
        if (!log.readCompletedList) log.readCompletedList = [];
        if (log.taskCompletedList.length || log.readList.length || log.readCompletedList.length || (this.json.isTask && log.taskList.length)){
            var logActivityNode = new Element("div", {"styles": this.form.css.logActivityNode}).inject( container || this.node);
            var titleNode = new Element("div", {"styles": this.form.css.logActivityTitleNode}).inject(logActivityNode);
            var childNode = new Element("div", {"styles": this.form.css.logActivityChildNode}).inject(logActivityNode);

            var iconNode = new Element("div", {"styles": this.form.css.logActivityIconNode}).inject(titleNode);
            var fromAvtivityNode = new Element("div", {"styles": this.form.css.logActivityFromNode}).inject(titleNode);
            var arrowNode = new Element("div", {"styles": this.form.css.logActivityArrowNode}).inject(titleNode);
            var arrivedAvtivityNode = new Element("div", {"styles": this.form.css.logActivityArrivedNode}).inject(titleNode);

            var timeNode = new Element("div", {"styles": this.form.css.logActivityTimeNode}).inject(titleNode);

            if (log.connected){
                iconNode.setStyle("background-image", "url("+"../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)");
            }else{
                iconNode.setStyle("background-image", "url("+"../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)");
            }
            fromAvtivityNode.set("html", "<b>"+log.fromActivityName+"</b>");
            if (log.arrivedActivityName){
                arrowNode.setStyle("background-image", "url("+"../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)");
                arrivedAvtivityNode.set("html", "<b>"+log.arrivedActivityName+"</b>");
                timeNode.set("html", "<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+log.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+log.arrivedTime)

            }else{
                timeNode.set("html", "<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+log.fromTime)
            }

            if ((idx % 2)===0){
                logActivityNode.setStyles(this.form.css.logActivityNode_even);
                titleNode.setStyles(this.form.css.logActivityTitleNode_even);
            }


            var taskTable = new Element("table", {
                "styles": this.form.css.logTableTask,
                "border": "0",
                "cellSpacing": "0",
                "cellpadding": "3px",
                "width": "100%"
            }).inject(childNode);
            var tr = taskTable.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine);

            var td = tr.insertCell(0).setStyles(this.form.css.logTableTaskTitle);
            td.set("text", MWF.xApplication.process.Xform.LP.person);
            td = tr.insertCell(1).setStyles(this.form.css.logTableTaskTitle);
            td.set("text", MWF.xApplication.process.Xform.LP.department);
            td = tr.insertCell(2).setStyles(this.form.css.logTableTaskTitle);
            td.set("text", MWF.xApplication.process.Xform.LP.startTime);
            td = tr.insertCell(3).setStyles(this.form.css.logTableTaskTitle);
            td.set("text", MWF.xApplication.process.Xform.LP.completedTime);
            td = tr.insertCell(4).setStyles(this.form.css.logTableTaskTitle);
            td.set("text", MWF.xApplication.process.Xform.LP.route);
            td = tr.insertCell(5).setStyles(this.form.css.logTableTaskTitle);
            td.set("text", MWF.xApplication.process.Xform.LP.opinion);

            log.taskCompletedList.each(function(taskCompleted){
                if (this.checkListShow(log, taskCompleted)) this.loadTaskLine_table(taskCompleted, taskTable, log, false);
            }.bind(this));

            if (this.json.isShowRead!==false){
                var readNames = [];
                var readCompletedNames = [];
                if (log.readList && log.readList.length){
                    log.readList.each(function(read){
                        readNames.push(MWF.name.cn(read.person));
                    });
                }
                if (log.readCompletedList && log.readCompletedList.length){
                    log.readCompletedList.each(function(read){
                        readCompletedNames.push(MWF.name.cn(read.person));
                    });
                }
                this.loadReadLine_default(readNames, readCompletedNames, childNode);
            }

            if (this.json.isTask){
                log.taskList.each(function(task){
                    if (this.checkListShow(log, task)) this.loadTaskLine_table(task, taskTable, log, true);
                }.bind(this));
            }
        }

    },
    loadTaskLine_table: function(task, table, log, isTask){
        var style = "logTableTaskLine";
        if (isTask) style = "logTableTaskLine_task";
        var tr = table.insertRow(table.rows.length);
        var td = tr.insertCell(0).setStyles(this.form.css[style]);
        td.set("text", task.person.substring(0, task.person.indexOf("@")) || "");
        td = tr.insertCell(1).setStyles(this.form.css[style]);
        td.set("text", task.unit.substring(0, task.unit.indexOf("@")) || "");
        td = tr.insertCell(2).setStyles(this.form.css[style]);
        td.set("text", task.startTime || "");
        td = tr.insertCell(3).setStyles(this.form.css[style]);
        td.set("text", task.completedTime || "");
        td = tr.insertCell(4).setStyles(this.form.css[style]);
        td.set("text", (task.processingType=="empower") ? MWF.xApplication.process.Xform.LP.empower : task.routeName || "");
        td = tr.insertCell(5).setStyles(this.form.css[style]);
        var op = (task.properties && task.properties.opinion) ?  task.properties.opinion : task.opinion;
        var opinion = (task.processingType=="empower") ? MWF.xApplication.process.Xform.LP.empowerTo + o2.name.cn(task.empowerToIdentity || "") : "<div style='line-height: 28px; float:left'>" + o2.txt(op || "")+"</div>";
        td.set("html", opinion);


        var atts = [];
        if (task.mediaOpinion){
            var mediaIds = task.mediaOpinion.split(",");
            if (this.form.businessData.attachmentList){
                this.form.businessData.attachmentList.each(function(att){
                    if (att.site==="$mediaOpinion"){
                        if (mediaIds.indexOf(att.id)!==-1) atts.push(att);
                    }
                }.bind(this));
            }
            if (atts.length) this.loadMediaOpinion(atts, td.getFirst(), "table");
        }
        this.fireEvent("postLoadLine",[{
            "data" : task,
            "atts" : atts,
            "node" : tr,
            "log" : this,
            "type" : isTask ? "task" : "taskCompleted"
        }]);
    },



    loadWorkLogText: function(list, container){
        this.lineClass = "logTaskNode";
        if( list ){
            list.each(function(log, idx){
                this.loadWorkLogLine_text(log, idx, container);
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkShow(log)) this.loadWorkLogLine_text(log, idx, container);
            }.bind(this));
        }
    },
    loadWorkLogLine_text: function(log, idx, container){
        log.taskCompletedList.each(function(taskCompleted){
            if (this.checkListShow(log, taskCompleted)) this.loadTaskLine_text(taskCompleted, container || this.node, log, false);
        }.bind(this));

        if (this.json.isTask){
            log.taskList.each(function(task){
                if (this.checkListShow(log, task)) this.loadTaskLine_text(task, container || this.node, log, true);
            }.bind(this));
        }
    },
    loadTaskLine_text: function(task, node, log, isTask){
        this.loadTaskLine_default(task, node, log, isTask, "0px", false, true, true);
    },

    checkShow: function(log){
        var flag = true;
        if (this.json.filterScript && this.json.filterScript.code){
            this.form.Macro.environment.log = log;
            this.form.Macro.environment.list = null;
            flag = this.form.Macro.exec(this.json.filterScript.code, this);
        }else{
            var isExactMatch = function (property) {
                return property && o2.typeOf(property)==="array" && property.length && property[0] === "yes";
            };
            if (this.json.filterActivity && this.json.filterActivity.length){
                filterActivitys = this.json.filterActivity;
                if(isExactMatch(this.json.filterActivityExactMatch)){ //精确匹配
                    flag = filterActivitys.split(/[;|,|\n]/gm).contains(log.fromActivityName); //用;,和空格分隔成数组
                }else{
                    flag = (filterActivitys.indexOf(log.fromActivityName)!==-1);
                }
            }
            if (this.json.filterActivityAlias){
                if (this.json.filterActivityAlias.length){
                    filterActivityAlias = this.json.filterActivityAlias;
                    if(log.fromActivityAlias){
                        if(isExactMatch(this.json.filterActivityAliasExactMatch)){ //精确匹配
                            flag = filterActivityAlias.split(/[;|,|\n]/gm).contains(log.fromActivityAlias); //用;,和空格分隔成数组
                        }else{
                            flag = (filterActivityAlias.indexOf(log.fromActivityAlias)!==-1);
                        }
                    }
                }
            }
            if (this.json.filterPerson && this.json.filterPerson.length){
                flag = false;
                filterPersons = this.json.filterPerson;

                var tmpTaskCompletedList = [];
                if(isExactMatch(this.json.filterPersonExactMatch)) { //精确匹配
                    var filterPersonsList = filterPersons.split(/[;|,|\n]/gm);
                    log.taskCompletedList.each(function(taskCompleted){
                        var matchArr = (taskCompleted.person + "@" + taskCompleted.identity).split("@").concat([taskCompleted.person, taskCompleted.identity]);
                        for(var i=0; i < filterPersonsList.length; i++){
                            if( matchArr.contains(filterPersonsList[i]) ){
                                tmpTaskCompletedList.push(taskCompleted);
                                break;
                            }
                        }
                    }.bind(this));
                }else{
                    log.taskCompletedList.each(function(taskCompleted){
                        if ((filterPersons.indexOf(taskCompleted.person)!==-1) || (filterPersons.indexOf(taskCompleted.identity)!==-1)){
                            tmpTaskCompletedList.push(taskCompleted);
                        }
                    }.bind(this));
                }
                if (tmpTaskCompletedList.length){
                    //log.taskCompletedList = [];
                    //log.taskCompletedList = tmpTaskCompletedList;
                    flag = true;
                }
            }
            if (this.json.filterRoute && this.json.filterRoute.length){
                filterRoutes = this.json.filterRoute;
                if(isExactMatch(this.json.filterRouteExactMatch)){ //精确匹配
                    flag = filterRoutes.split(/[;|,|\n]/gm).contains(log.routeName); //用;,和空格分隔成数组
                }else{
                    flag = (filterRoutes.indexOf(log.routeName)!==-1);
                }
            }
        }
        return flag;
    },
    checkListShow: function(log, list){
        var flag = true;
        if (this.json.filterScript && this.json.filterScript.code){
            this.form.Macro.environment.log = log;
            this.form.Macro.environment.list = list;
            flag = this.form.Macro.exec(this.json.filterScript.code, this);
        }else{
            var isExactMatch = function (property) {
                return property && o2.typeOf(property)==="array" && property.length && property[0] === "yes";
            };
            if (this.json.filterPerson && this.json.filterPerson.length){
                var filterPerson = this.json.filterPerson;
                flag = false;
                if(isExactMatch(this.json.filterPersonExactMatch)) { //精确匹配
                    var filterPersonsList = filterPerson.split(/[;|,|\n]/gm);
                    var matchArr = (list.person + "@" + list.identity).split("@").concat([list.person, list.identity]);
                    for(var i=0; i < filterPersonsList.length; i++){
                        if( matchArr.contains(filterPersonsList[i]) ){
                            flag = true;
                            break;
                        }
                    }
                }else{
                    flag = ((filterPersons.indexOf(list.person)!==-1)|| (filterPersons.indexOf(list.identity)!==-1));
                }
            }
            // if (this.json.filterPerson && this.json.filterPerson.length){
            //     flag = ((filterPersons.indexOf(list.person)!==-1)|| (filterPersons.indexOf(list.identity)!==-1));
            // }
        }
        return flag;
    },

    loadWorkLogDefault: function(list, container){
        //var text = this.json.textStyle;
        if( list ){
            list.each(function(log, idx){
                this.loadWorkLogLine_default(log, idx, container);
            }.bind(this));
        }else{
            this.workLog.each(function(log, idx){
                if (this.checkShow(log)) this.loadWorkLogLine_default(log, idx, container);
            }.bind(this));
        }
    },
    loadWorkLogLine_default: function(log, idx, container){
        if (!log.readList) log.readList = [];
        if (!log.readCompletedList) log.readCompletedList = [];
        if (log.taskCompletedList.length || log.readList.length || log.readCompletedList.length || (this.json.isTask && log.taskList.length)) {
            var logActivityNode = new Element("div", {"styles": this.form.css.logActivityNode}).inject(container || this.node);
            var titleNode = new Element("div", {"styles": this.form.css.logActivityTitleNode}).inject(logActivityNode);
            var childNode = new Element("div", {"styles": this.form.css.logActivityChildNode}).inject(logActivityNode);

            var iconNode = new Element("div", {"styles": this.form.css.logActivityIconNode}).inject(titleNode);
            var fromAvtivityNode = new Element("div", {"styles": this.form.css.logActivityFromNode}).inject(titleNode);
            var arrowNode = new Element("div", {"styles": this.form.css.logActivityArrowNode}).inject(titleNode);
            var arrivedAvtivityNode = new Element("div", {"styles": this.form.css.logActivityArrivedNode}).inject(titleNode);

            var readActionNode = new Element("div", {"styles": this.form.css.logActivityReadActionNode}).inject(titleNode);

            var timeNode = new Element("div", {"styles": this.form.css.logActivityTimeNode}).inject(titleNode);

            if (log.connected) {
                iconNode.setStyle("background-image", "url(../x_component_process_Xform/$Form/" + this.form.options.style + "/icon/ok14.png)");
            } else {
                iconNode.setStyle("background-image", "url(../x_component_process_Xform/$Form/" + this.form.options.style + "/icon/rightRed.png)");
            }
            fromAvtivityNode.set("html", "<b>" + log.fromActivityName + "</b>");
            if (log.arrivedActivityName) {
                arrowNode.setStyle("background-image", "url(../x_component_process_Xform/$Form/" + this.form.options.style + "/icon/right.png)");
                arrivedAvtivityNode.set("html", "<b>" + log.arrivedActivityName + "</b>");
                timeNode.set("html", "<b>" + MWF.xApplication.process.Xform.LP.begin + ": </b>" + log.fromTime + "<br/><b>" + MWF.xApplication.process.Xform.LP.end + ": </b>" + log.arrivedTime)

            } else {
                timeNode.set("html", "<b>" + MWF.xApplication.process.Xform.LP.begin + ": </b>" + log.fromTime)
            }

            // if ((log.readList && log.readList.length) || (log.readCompletedList && log.readCompletedList.length)){
            //     readActionNode.set("text", MWF.xApplication.process.Xform.LP.worklogRead);
            // }

            if ((idx % 2) === 0) {
                logActivityNode.setStyles(this.form.css.logActivityNode_even);
                titleNode.setStyles(this.form.css.logActivityTitleNode_even);
            }

            log.taskCompletedList.each(function (taskCompleted) {
                if (this.checkListShow(log, taskCompleted)) this.loadTaskLine_default(taskCompleted, childNode, log, false);
            }.bind(this));

            if (this.json.isShowRead!==false){
                var readNames = [];
                var readCompletedNames = [];
                if (log.readList && log.readList.length){
                    log.readList.each(function(read){
                        readNames.push(MWF.name.cn(read.person));
                    });
                }
                if (log.readCompletedList && log.readCompletedList.length){
                    log.readCompletedList.each(function(read){
                        readCompletedNames.push(MWF.name.cn(read.person));
                    });
                }
                //if (readCompletedNames.length)
                this.loadReadLine_default(readNames, readCompletedNames, childNode);
            }

            if (this.json.isTask) {
                log.taskList.each(function (task) {
                    if (this.checkListShow(log, task)) this.loadTaskLine_default(task, childNode, log, true);
                }.bind(this));
            }
        }
    },
    loadReadLine_default: function(readNames, readCompletedNames, node){
        var html = "";
        var logReadNode = new Element("div", {"styles": this.form.css.logReadTextNode}).inject(node);
        if (readNames.length){
            var readStrTitle = readNames.join(", ");
            var readStr = (readNames.length>20) ? (readNames.slice(0,20).join(", ") + MWF.xApplication.process.Xform.LP.andSoForth ): readStrTitle;
            html = "<span style='color: #0000ff'>"+(this.json.showReadTitle || MWF.xApplication.process.Xform.LP.showReadTitle)+": </span>"+readStr+"<span>&nbsp;&nbsp;&nbsp;&nbsp;</span>";

            //var logReadPersonNode = new Element("div", {"styles": this.form.css.logReadTextNode}).inject(logReadNode);
        }
        if (readCompletedNames.length){
            var readCompletedStrTitle = readCompletedNames.join(", ");
            var readCompletedStr = (readCompletedNames.length>20) ? (readCompletedNames.slice(0,20).join(", ") + MWF.xApplication.process.Xform.LP.andSoForth ): readCompletedStrTitle;
            html += "<span style='color: #0000ff'>"+(this.json.showReadCompletedTitle || MWF.xApplication.process.Xform.LP.showReadCompletedTitle)+": </span>"+readCompletedStr+"<span>&nbsp;&nbsp;&nbsp;&nbsp;</span>";
        }
        if (html) logReadNode.set("html", html);
    },
    loadTaskLine_default: function(task, node, log, isTask, margin, isZebra, nodeStyle, noIconNode){
        var style = "logTaskNode";
        var textStyle = "logTaskFloatTextNode";
        if (nodeStyle){
            style = "logTaskTextNode";
            textStyle = "logTaskTextNode";
        }
        var logTaskNode = new Element("div", {"styles": this.form.css[style]}).inject(node);
        var iconNode;
        if( !noIconNode ){
            iconNode = new Element("div", {"styles": this.form.css.logTaskIconNode}).inject(logTaskNode);
        }
        var textNode = new Element("div", {"styles": this.form.css[textStyle]}).inject(logTaskNode);

        if (isZebra){
            logTaskNode.setStyles(this.form.css[this.lineClass]);
            if (this.lineClass === "logTaskNode"){
                this.lineClass = "logTaskNode_even";
            }else{
                this.lineClass = "logTaskNode";
            }
        }

        var left = 28;
        if( iconNode ){
            if (margin) iconNode.setStyle("margin-left", margin);
            left = iconNode.getStyle("margin-left").toInt();
            left = left + 28;
        }
        if( !nodeStyle ){
            textNode.setStyle("margin-left",left+"px");
        }
        var html;
        var company = "";
        var atts = [];
        if (!isTask || true){
            company = (task.unitList) ? task.unitList[task.unitList.length-1] : "";
            var html = this.json.textStyle;
            if (task.processingType=="empower") html = MWF.xApplication.process.Xform.LP.empowerToHtml;

            var nextTaskText = "";
            if (task.processingType=="empower"){
                var nextTaskParts = [];
                if (task.nextTaskIdentityListText){
                    var nestIds = task.nextTaskIdentityListText.split(",");
                    nextTaskParts = o2.name.cns(nestIds);
                }else{
                    // var nextTasks = o2.name.cns(log.nextTaskIdentityList).join(", ");
                    // var nextTaskCompleteds = o2.name.cns(log.nextTaskCompletedIdentityList).join(", ");
                    var nextTasks = (log.nextTaskIdentityList && log.nextTaskIdentityList.length) ? o2.name.cns(log.nextTaskIdentityList).join(", ") : "";
                    var nextTaskCompleteds = (log.nextTaskCompletedIdentityList && log.nextTaskCompletedIdentityList.length) ? o2.name.cns(log.nextTaskCompletedIdentityList).join(", ") : "";

                    if (nextTasks) nextTaskParts.push(nextTasks);
                    if (nextTaskCompleteds) nextTaskParts.push(nextTaskCompleteds);
                }
                nextTaskText = nextTaskParts.join(", ");
            }else{
                nextTaskText = (task.empowerToIdentity) ? o2.name.cn(task.empowerToIdentity) : "";
            }



            if (this.json.textStyleScript && this.json.textStyleScript.code){
                this.form.Macro.environment.log = log;
                this.form.Macro.environment.list = null;
                html = this.form.Macro.exec(this.json.textStyleScript.code, this);
            }

            //如果是自动流转，强制使用默认格式
            if (task.processingType==="autoflow") html = MWF.xApplication.process.Xform.LP.autoFlowHtml;

            var person = task.person.substring(0, task.person.indexOf("@"));
            if( task.processingType !== "empower" && task.empowerFromIdentity){
                person = person+" 代 "+o2.name.cn(task.empowerFromIdentity||"");
            }
            html = html.replace(/\{person\}/g, person ).replace(/{personDn}/g, task.person || '');
            html = html.replace(/\{department\}/g, task.unit.substring(0, task.unit.indexOf("@")));
            html = html.replace(/\{route\}/g, o2.txt(task.routeName));
            html = html.replace(/\{time\}/g, task.completedTime);
            html = html.replace(/\{date\}/g, new Date().parse(task.completedTime).format("%Y-%m-%d"));
            var op = (task.properties && task.properties.opinion) ?  task.properties.opinion : task.opinion;
            html = html.replace(/\{opinion\}/g, o2.txt(op || ""));
            html = html.replace(/\{company\}/g, company.substring(0, company.indexOf("@")));
            html = html.replace(/\{startTime\}/g, task.startTime);
            html = html.replace(/\{startDate\}/g, new Date().parse(task.startTime).format("%Y-%m-%d"));
            html = html.replace(/\{activity\}/g, o2.txt(log.fromActivityName));
            html = html.replace(/\{arrivedActivity\}/g, o2.txt(log.arrivedActivityName));
            html = html.replace(/\{img\}/g, "<span class='mwf_log_img'></span>");
            html = html.replace(/\{empowerTo\}/g, ((task.empowerToIdentity) ? o2.name.cn(task.empowerToIdentity) : ""));

            html = html.replace(/\{nextTask\}/g, nextTasks);
            html = html.replace(/\{nextTaskCompleted\}/g, nextTaskCompleteds);
            html = html.replace(/\{next\}/g, nextTaskText);

            //var html = MWF.xApplication.process.Xform.LP.nextUser + task.person+"("+task.department+")" +", "+
            //    MWF.xApplication.process.Xform.LP.selectRoute + ": [" + task.routeName + "], " +
            //    MWF.xApplication.process.Xform.LP.submitAt + ": " + task.completedTime+ ", " +
            //    MWF.xApplication.process.Xform.LP.idea + ": <font style=\"color: #00F\">" + (task.opinion || "")+"</font>";

            textNode.set("html", html);
            var imgNode = textNode.getElement(".mwf_log_img");
            if (task.mediaOpinion){
                var mediaIds = task.mediaOpinion.split(",");
                // var atts = [];
                if (this.form.businessData.attachmentList){
                    this.form.businessData.attachmentList.each(function(att){
                        if (att.site==="$mediaOpinion"){
                            if (mediaIds.indexOf(att.id)!==-1) atts.push(att);
                        }
                    }.bind(this));
                }
                if (atts.length){
                    if (imgNode){
                        this.loadMediaOpinion_show(atts, task, imgNode, true);
                        // atts.each(function(att){
                        //     this.loadMediaOpinion_image_show(att, task, imgNode);
                        // }.bind(this));

                    }else{
                        this.loadMediaOpinion(atts, textNode, "default");
                    }
                }
            }
        }else{
            //company = task.unitList[task.unitList.length-1];
            html = task.person.substring(0, task.person.indexOf("@"))+"("+task.unit.substring(0, task.unit.indexOf("@"))+")" + MWF.xApplication.process.Xform.LP.processing+", "+
                MWF.xApplication.process.Xform.LP.comeTime + ": " + task.startTime;
            textNode.set("html", html);
            if(iconNode)iconNode.setStyle("background-image", "url("+"../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)");
        }
        this.fireEvent("postLoadLine",[{
            "data" : task,
            "node" : logTaskNode,
            "atts" : atts,
            "log" : this,
            "type" : isTask ? "task" : "taskCompleted"
        }]);
    },
    loadMediaOpinion: function(atts, node, type){
        atts.each(function(att){
            if (!att.type) att.type = "image";
            if (att.type.indexOf("image")!==-1){
                if( this.json.handwritingExpanded ){
                    this.loadMediaOpinion_image_show(att, null, node, true)
                }else if( type === "table" && !layout.mobile ){
                    this.loadMediaOpinion_image_tooltip(att, node);
                }else{
                    this.loadMediaOpinion_image(att, node);
                }
            }else if(att.type.indexOf("video")!==-1){
                this.loadMediaOpinion_video(att, node);
            }else if(att.type.indexOf("audio")!==-1){
                this.loadMediaOpinion_voice(att, node);
            }else {
                if (this.json.handwritingExpanded){
                    this.loadMediaOpinion_image_show(att, null, node, true)
                }else if( type === "table" && !layout.mobile ){
                    this.loadMediaOpinion_image_tooltip(att, node);
                }else{
                    this.loadMediaOpinion_image(att, node);
                }
            }
        }.bind(this));
    },
    getMediaOpinionUrl: function(att){
        var action = MWF.Actions.get("x_processplatform_assemble_surface");
        var url = action.action.actions["getAttachmentStream"].uri;
        if (this.form.businessData.workCompleted){
            url = action.action.actions["getWorkcompletedAttachmentStream"].uri;
            url = url.replace("{id}", att.id);
            url = url.replace("{workCompletedId}", this.form.businessData.workCompleted.id);
        }else{
            url = url.replace("{id}", att.id);
            url = url.replace("{workid}", this.form.businessData.work.id);
        }
        url = action.action.address+url;
        return o2.filterUrl(url);
    },
    loadMediaOpinion_image_tooltip : function(att, node){
        var iconNode = new Element("div", {"styles": this.form.css.logMediaIcon}).inject(node.getParent());
        iconNode.setStyle("background-image", "url('"+this.form.path+this.form.options.style+"/icon/image.png')");
        iconNode.set("title", MWF.xApplication.process.Xform.LP.mediaOpinion_image);
        if( !this.MTooltipsLoaded )o2.xDesktop.requireApp("Template", "MTooltips", null, false);
        this.MTooltipsLoaded = true;
        var tooltip = new MTooltips(this.form.app.content, iconNode, this.form.app, null, {
            axis : "y", "delay" : 350,
            nodeStyles : {
                "max-width" : "800px"
            }
        });
        tooltip.contentNode = new Element("div",{
            styles : { width : "100%" , height : "100%" }
        });
        var img = new Element("img", {
            "src": this.getMediaOpinionUrl(att),
            "events" : {
                load : function(ev){
                    var nh = ev.target.naturalHeight;
                    var nw = ev.target.naturalWidth;
                    if( this.isNumber( this.json.handwritingWidth ) || this.isNumber( this.json.handwritingHeight ) ){
                        var size = this.getImageSize( nw, nh );
                        ev.target.setStyles(size);
                    }else{
                        var x = Math.min(nw, 800);
                        ev.target.setStyles({"width": ""+ x +"px"});
                    }
                }.bind(this)
            }
        }).inject(tooltip.contentNode);
    },
    loadMediaOpinion_image: function(att, node){
        var iconNode = new Element("div", {"styles": this.form.css.logMediaIcon}).inject(node.getParent());
        iconNode.setStyle("background-image", "url('"+this.form.path+this.form.options.style+"/icon/image.png')");
        iconNode.set("title", MWF.xApplication.process.Xform.LP.mediaOpinion_image);
        iconNode.addEvents({
            "click": function(e){
                if (e.target.mediaOpinionContentNode) return "";
                var url = this.getMediaOpinionUrl(att);
                // if (this.mediaOpinionContentNode){
                //     this.mediaOpinionContentNode.destroy();
                //     this.mediaOpinionContentNode = null;
                // }

                var imgNode = new Element("div", {"styles": this.form.css.logMediaOpinionContent}).inject(node.getParent(),"after");
                if (!layout.mobile) imgNode.setStyle("margin-left", "40px");
                //this.mediaOpinionContentNode = imgNode;
                e.target.mediaOpinionContentNode = imgNode;

                var imgCloseNode = new Element("div", {"styles": this.form.css.logMediaOpinionContentClose}).inject(imgNode);
                imgCloseNode.addEvent("click", function(){ imgNode.destroy(); e.target.mediaOpinionContentNode = "";});

                var imgAreaNode = new Element("div", {"styles": this.form.css.logMediaOpinionContentArea}).inject(imgNode);

                // var height = 260;
                // var width = 390;
                var width;
                //var height;
                if (layout.mobile){
                    width = node.getParent().getParent().getSize().x-2;
                    //height = width*2/3;
                }else{
                    var pNode = node.getParent().getParent();
                    var offset = imgNode.getPosition( pNode );
                    width = Math.min( pNode.getSize().x - offset.x - 42, 800 );
                }

                var img = new Element("img", {
                    "src": url,
                    "styles" : { width : width+"px" },
                    "events" : {
                        load : function(ev){
                            var nh = ev.target.naturalHeight;
                            var nw = ev.target.naturalWidth;
                            if( !layout.mobile && ( this.isNumber( this.json.handwritingWidth ) || this.isNumber( this.json.handwritingHeight ) ) ){
                                var size = this.getImageSize( nw, nh );
                                img.setStyles(size);
                                imgNode.setStyles(size);
                            }else{
                                var x = Math.min(nw, width);
                                img.setStyles({"width": ""+ x +"px"});
                                imgNode.setStyles({"width": ""+ x +"px"});
                            }
                        }.bind(this)
                    }
                }).inject(imgAreaNode);

                //img.setStyles({"width": ""+width+"px"});
                //imgNode.setStyles({"width": ""+width+"px"});

                //img.setStyles({"width": ""+width+"px", "height": ""+height+"px"});
                //imgNode.setStyles({"width": ""+width+"px", "height": ""+height+"px"});


                // var size = img.getSize();
                // var x_y = size.x/size.y;
                //if (size.y>260){

                //}

                // var p = iconNode.getPosition(this.form.app.content);
                // var s = iconNode.getSize();
                // var size = (layout.mobile) ? {"x": width, "y": height}: imgNode.getSize();
                // var contentSize = this.form.app.content.getSize();
                // var contentScroll = (layout.mobile) ? document.body.getFirst().getScroll() : {"x": 0, "y": 0};
                // var y = p.y-size.y;
                // var x = p.x+s.x/2-size.x/2;
                //
                // if (x<10) x = 10;
                // if (x+size.x>contentSize.x-10) x = contentSize.x-size.x-20;
                // if (y+size.y>contentSize.y-10) y = contentSize.y-size.y-20;
                // if (y<10) y = 10;
                // y=y+contentScroll.y;
                //
                // if (layout.mobile){
                //     x = 0;
                // }
                // imgNode.setStyles({
                //     "top": ""+y+"px",
                //     "left": ""+x+"px"
                // });



                // this.hideMediaOpinionNodeFun = this.hideMediaOpinionNode.bind(this);
                // this.form.node.addEvent("mousedown", this.hideMediaOpinionNodeFun);

                e.stopPropagation();
            }.bind(this)
        });
    },
    hideMediaOpinionNode: function(){
        if (this.mediaOpinionContentNode){
            this.mediaOpinionContentNode.destroy();
            this.mediaOpinionContentNode = null;
        }
        // if (this.hideMediaOpinionNodeFun) this.form.node.removeEvent("click", this.hideMediaOpinionNodeFun);
    },
    loadMediaOpinion_video: function(att, node){
        var iconNode = new Element("div", {"styles": this.form.css.logMediaIcon}).inject(node.getParent());
        iconNode.setStyle("background-image", "url('"+this.form.path+this.form.options.style+"/icon/video.png')");
        iconNode.set("title", MWF.xApplication.process.Xform.LP.mediaOpinion_video);
    },
    loadMediaOpinion_voice: function(att, node){
        // this.form.css.logMediaIcon.width = "60px";
        // var iconNode = new Element("audio", {
        //     "styles": this.form.css.logMediaIcon,
        //     "controls": true,
        //     "html": "<source src='"+url+"' type='audio/wav'></source>"
        // }).inject(node.getParent());

        var iconNode = new Element("div", {"styles": this.form.css.logMediaIcon}).inject(node.getParent());
        iconNode.setStyle("background-image", "url('"+this.form.path+this.form.options.style+"/icon/voice.png')");
        iconNode.set("title", MWF.xApplication.process.Xform.LP.mediaOpinion_voice);

        iconNode.addEvents({
            "click": function(e){
                var url = this.getMediaOpinionUrl(att);

                this.audioNode = new Element("audio", {"loop": false});
                this.audioNode.set("src", url);
                this.audioNode.play();

                e.stopPropagation();
            }.bind(this)
        });
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
//MWF.xDesktop.requireApp("process.Xform", "widget.Monitor", null, false);
/** @class Monitor 流程图组件。
 * @o2cn 流程图
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var attachment = this.form.get("name"); //获取组件
 * //方法2
 * var attachment = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Monitor = MWF.APPMonitor =  new Class(
    /** @lends MWF.xApplication.process.Xform.Monitor# */
    {
    Extends: MWF.APP$Module,

    _loadUserInterface: function(){
        this.node.empty();

        MWF.xDesktop.requireApp("process.Xform", "widget.Monitor", function(){
            var process = (this.form.businessData.work) ? this.form.businessData.work.process : this.form.businessData.workCompleted.process;
            /**
             * @summary 流程图对象，是一个 MWF.xApplication.process.Xform.widget.Monitor 类实例
             */
            this.monitor = new MWF.xApplication.process.Xform.widget.Monitor(this.node, this.form.businessData.workLogList, this.form.businessData.recordList, process,{
                "onPostLoad" : function(){
                    this.fireEvent("postLoad");
                }.bind(this)
            }, this);
        }.bind(this), false);
    }
});

MWF.xDesktop.requireApp("process.Xform", "Textfield", null, false);
/** @class Number 数字输入组件。
 * @o2cn 数字输入组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("name"); //获取组件
 * //方法2
 * var field = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.Textfield
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Number = MWF.APPNumber =  new Class(
    /** @lends MWF.xApplication.process.Xform.Number# */
{
    Implements: [Events],
    Extends: MWF.APPTextfield,
    iconStyle: "numberIcon",
    _loadUserInterface: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if ( this.isSectionMergeRead() ) { //区段合并显示
                this.node.empty();
                this.node.set({
                    "nodeId": this.json.id,
                    "MWFType": this.json.type
                });
                switch (this.json.mergeTypeRead) {
                    case "amount":
                        this._loadMergeAmountReadNode();
                        break;
                    case "average":
                        this._loadMergeAverageReadNode();
                        break;
                    default:
                        this._loadMergeReadNode();
                        break;
                }
            }else{
                if( this.isSectionMergeEdit() ){
                    switch (this.json.mergeTypeEdit) {
                        case "amount":
                            this._loadMergeAmountEidtNode();
                            break;
                        case "average":
                            this._loadMergeAverageEditNode();
                    }
                }else{
                    this._loadNode();
                }
                if (this.json.compute === "show"){
                    this._setValue(this._computeValue());
                }else{
                    this._loadValue();
                }
            }
        }
    },
    _loadMergeAmountReadNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        this.node.set("text", this.formatNumber(total.toString()));
    },
    _loadMergeAverageReadNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        var average = total.div(  new Decimal(Object.keys(data).length) );
        this.node.set("text", this.formatNumber(average.toString()));
    },
    _loadMergeAmountEidtNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        this._setBusinessData( total.toNumber() );
        this._loadNode();
    },
    _loadMergeAverageEditNode: function(){
        var data = this.getBusinessDataById();
        var total = new Decimal(0);
        for( var key in data ){
            total = total.plus(new Decimal(data[key] || 0));
        }
        var average = total.div(  new Decimal(Object.keys(data).length) );
        this._setBusinessData( average.toNumber() );
        this._loadNode();
    },
    isEmpty : function(){
        return !this.getData();
    },
    /**
     * @summary 传入值获取适配最大值和最小值的数值.
     * @example
     * //如果最大值设置为500，最小值为100
     *
     * var value = this.form.get('field').getRangeValue( 300 );
     * //value为300
     *
     * var value = this.form.get('field').getRangeValue( 10000 );
     * //value为500
     *
     * var value = this.form.get('field').getRangeValue( 1 );
     * //value为100
     * @param value {String|Nummber}
     * @return {Number} 获取适配最大值和最小值的数值.
     */
    getRangeValue: function( value ){
        var v = this.getMax( value );
        return this.getMin( v );
    },
    getMax: function( value ){
        if( isNaN(value) )return value;
        if( typeOf( value ) === "string" )value = parseFloat(value);
        if( !isNaN( this.json.max )){
            var max = this.json.max;
            if( typeOf( max ) === "string" )max = parseFloat(max);
            return Math.min( max, value );
        }else{
            return value;
        }
    },
    getMin: function( value ){
        if( isNaN(value) )return value;
        if( typeOf( value ) === "string" )value = parseFloat(value);
        if( !isNaN( this.json.min )){
            var min = this.json.min;
            if( typeOf( min ) === "string" )min = parseFloat(min);
            return Math.max( min, value );
        }else{
            return value;
        }
    },
    getInputData: function( flag ){
        var input = this.node.getElement("input");
        if (input){
            var v = input.get("value");
            v = this.unformatNumber( v );
            var n = v.toFloat();
            n = this.getMax( n );
            n = this.getMin( n );
            return (isNaN(n)) ? (this.json.emptyValue === "string" ? "" : 0) : n;
        }else{
            return this._getBusinessData();
        }
    },


    /**
     * @summary 传入文本获取清除逗号的数值
     * @example
     * var value = this.form.get('field').unformatNumber( "30,000" );
     * //value为30000
     * @param str{String} 文本
     * @return {Number} 获取清除逗号的数值.
     */
    unformatNumber: function(str){
        return str.replace(/,/g, "");
    },
    /**
     * @summary 传入文本或数值根据配置的小数位数和分隔符返回字符串
     * @example
     * //假设组件的设置为千分位分隔，保留小数两位
     *
     * var value = this.form.get('field').formatNumber( "30000.123" );
     * //value为字符串"30,000.12"
     *
     * var value = this.form.get('field').formatNumber( 30000.123 );
     * //value为字符串"30,000.12"
     *
     * @param str{String|Number}
     * @return {Number} 根据配置的小数位数和分隔符返回字符串
     */
    formatNumber: function(str){
        var v = (str || "0").toFloat();
        if (v){
            if (this.json.decimals && (this.json.decimals!="*")){

                var decimals = this.json.decimals.toInt();

                var p = Math.pow(10,decimals);
                var f_x = Math.round(v*p)/p;
                str = f_x.toString();

                if (decimals>0){
                    var pos_decimal = str.indexOf('.');
                    if (pos_decimal < 0){
                        pos_decimal = str.length;
                        str += '.';
                    }
                    var decimalStr = (str).substr(pos_decimal+1, (str).length);
                    while (decimalStr.length < decimals){
                        str += '0';
                        decimalStr += 0;
                    }
                }
            }
            if( this.json.digitsToSeparate && parseInt(this.json.digitsToSeparate) > 1 ){
                if( typeOf( str ) === "number" )str = str.toString();
                var digits = parseInt(this.json.digitsToSeparate);
                var reg = new RegExp( "(\\d{"+digits+"}\\B)" ,"g");
                var arr = str.split(".");
                var i = arr[0].split("").reverse().join("")
                    .replace(reg, "$1,")
                    .split("").reverse().join("");
                str = arr.length > 1 ? ( i + "." + arr[1] ) : i ;
            }
        }
        return str;
    },

    validationFormat: function(){
        if( !this.node.getElement("input") )return true;
        var n = this.getInputData();
        if (isNaN(n)) {
            if( n === "" && this.json.emptyValue === "string" ){
                return true;
            }else{
                this.notValidationMode(MWF.xApplication.process.Xform.LP.notValidation_number);
                return false;
            }
        }
        return true;
    },

    // validationFormat: function(){
    //     if( !this.node.getElement("input") )return true;
    //     var n = this.node.getElement("input").get("value");
    //     n = this.unformatNumber(n);
    //     if (isNaN(n)) {
    //         if( n === "" && this.json.emptyValue === "string" ){
    //             return true;
    //         }else{
    //             this.notValidationMode(MWF.xApplication.process.Xform.LP.notValidation_number);
    //             return false;
    //         }
    //     }else{
    //         this.node.getFirst().set("value", this.formatNumber(n));
    //     }
    //     return true;
    // },
    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getInputData();
            var strN = n.toString();

            if( n === "" && this.json.emptyValue === "string" )n = 0;

            var v = (data.valueType=="value") ? n : strN.length;
            var strV = (data.valueType=="value") ? strN : strN.length;

            switch (data.operateor){
                case "isnull":
                    if (!strV && strV.toString()!=='0'){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (strV){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>parseFloat(data.value)){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<parseFloat(data.value)){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==parseFloat(data.value)){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=parseFloat(data.value)){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (strV.toString().indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (strV.toString().indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },

    _resetNodeEdit: function(){
        var input = new Element("input", {
            "styles": {
                "background": "transparent",
                "width": "100%",
                "border": "0px"
            }
        });

        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "padding-right": "4px"
            }}).inject(this.node, "after");
        input.inject(node);

        this.node.destroy();
        this.node = node;
    },

    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        if( !input && this.nodeHtml ){
            this.node.set("html", this.nodeHtml);
            input = this.node.getFirst();
        }
        input.set(this.json.properties);

        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle]
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.node.getFirst().addEvent("change", function(){
            this.validationMode();
            if (this.validation()) {
                var value = this.getInputData("change");
                this._setBusinessData(value);
                this.node.getFirst().set("value", this.formatNumber( value.toString() ));
                this.fireEvent("change");
            }
        }.bind(this));

        this.node.getFirst().addEvent("blur", function(){
            this.validation();
        }.bind(this));
        this.node.getFirst().addEvent("keyup", function(){
            this.validationMode();
        }.bind(this));
    },
    _computeValue: function(value){
        if( this.json.defaultValue && this.json.defaultValue.code){
            return this.form.Macro.exec(this.json.defaultValue.code, this)
        }else{
            if(value){
                return value;
            }else{
                return this.json.emptyValue === "string" ? "" : "0";
            }
        }
    },

    __setData: function(data, fireChange){
        var old = this.getInputData();
        this._setBusinessData(data);
        if (this.node.getFirst()){
            this.node.getFirst().set("value", this.formatNumber(data));
            this.checkDescription();
            this.validationMode();
        }else{
            this.node.set("text", this.formatNumber(data));
        }
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },

    resetData: function(){
        var value = this.moduleValueAG || this._getBusinessData();
        if (!value) value = this._computeValue();
        this.setData(value || "");
    },

    getValue: function(){
        if (!this.isReadable) return '';
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if( this.json.emptyValue === "string" ){
            if( value === "" || typeOf(value)==="null" )value = this._computeValue();
        }else{
            if( value === "" || value === 0 || typeOf(value)==="null" )value = this._computeValue();
        }
        if( ( value === "" || typeOf(value)==="null" ) && this.json.emptyValue === "string"){
            return "";
        }else{
            value = this.formatNumber(value);
            return value || "0";
        }
    },
    __setValue: function(value){
        var v = typeOf( value ) === "string" ? this.unformatNumber( value ) : value;
        v = this.isNumber( v ) ? parseFloat( v ) : v;
        this._setBusinessData(v);
        var val = value;
        if( this.json.emptyValue === "string" ){
            if( typeOf(v)==="null" )val = "";
            if( v === 0 )val = "0";
        }else{
            if( v === 0 || v === "" || typeOf(v)==="null" )val = "0";
        }
        if (this.node.getFirst()) this.node.getFirst().set("value", value || val);
        if (this.isReadonly()){
            if (this.isReadable){
                this.node.set("text", value || val);
            }else{
                this.node.set("text", '');
            }
        } 
        this.moduleValueAG = null;
        this.fieldModuleLoaded = true;
        return value;
    },
    isNumber : function( d ){
        return parseFloat(d).toString() !== "NaN";
    },


    validationConfigItemExcel: function(data){
        if (data.status=="all"){
            var n = this.getInputData();
            var strN = n.toString();

            if( n === "" && this.json.emptyValue === "string" )n = 0;

            var v = (data.valueType=="value") ? n : strN.length;
            var strV = (data.valueType=="value") ? strN : strN.length;

            switch (data.operateor){
                case "isnull":
                    if (!strV && strV.toString()!=='0')return data.prompt;
                    break;
                case "notnull":
                    if (strV)return data.prompt;
                    break;
                case "gt":
                    if (v>data.value)return data.prompt;
                    break;
                case "lt":
                    if (v<data.value)return data.prompt;
                    break;
                case "equal":
                    if (v==data.value)return data.prompt;
                    break;
                case "neq":
                    if (v!=data.value)return data.prompt;
                    break;
                case "contain":
                    if (strV.toString().indexOf(data.value)!=-1)return data.prompt;
                    break;
                case "notcontain":
                    if (strV.toString().indexOf(data.value)==-1)return data.prompt;
                    break;
            }
        }
        return true;
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xApplication.process.Xform.OfdView = MWF.APPOfdView =  new Class({
    Extends: MWF.APP$Module,
    options:{
        "moduleEvents": [
            "afterOpen"
        ]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.fileTemplate = false;

        if (this.json.isReadonly || this.form.json.isReadonly){
            this.mode  = "read";
        }else{
            if (this.json.readScript && this.json.readScript.code){
                var flag = this.form.Macro.exec(this.json.readScript.code, this);
                if (flag){
                    this.mode = "read";
                }
            }
        }

    },
    _loadUserInterface: function(){
        this.node.empty();
    },
    _afterLoaded: function(){
        if(this.mode !== "read"){
            this.createUpload();
        }
        if(this.json.template && (this.json.templateType === "value" && this.json.template !=="")){
            this.fileTemplate = true;
        }
        if(this.json.templeteScript && (this.json.templateType === "script" && this.json.templeteScript !=="")){
            this.fileTemplate = true;
        }
        this.data = this.getData();
        this.documentId = this.data.documentId;
        if(this.data.documentId === "" && !this.fileTemplate){
            this.createEmpty();
        }else {
            this.loadOfdView();
        }
    },
    createEmpty : function (){
        this.emptyNode = new Element("div").inject(this.node);
        this.emptyNode.set("text",MWF.xApplication.process.Xform.LP.ofdview.nofile);
    },
    createUpload : function (){


        this.uploadNode = new Element("div",{"style":"margin:10px;"}).inject(this.node);

        var uploadBtn = new Element("button",{"text":MWF.xApplication.process.Xform.LP.ofdview.upload,"style":"margin-left: 15px; color: rgb(255, 255, 255); cursor: pointer; height: 26px; line-height: 26px; padding: 0px 10px; min-width: 40px; background-color: rgb(74, 144, 226); border: 1px solid rgb(82, 139, 204); border-radius: 15px;"}).inject(this.uploadNode);
        uploadBtn.addEvent("click",function (){
            o2.require("o2.widget.Upload", null, false);

            if(this.documentId === ""){
                var upload = new o2.widget.Upload(this.form.app.content, {
                    "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                    "method": "uploadAttachment",
                    "parameter": {
                        "id": this.form.businessData.work.id
                    },
                    "accept" : ".ofd",
                    "data":{
                        "site": "ofdAttachement"
                    },
                    "onCompleted": function(json){
                        this.documentId = json.data.id;
                        this.setData();
                        this.loadOfdView();
                    }.bind(this)
                });
            }else {
                var upload = new o2.widget.Upload(this.form.app.content, {
                    "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                    "method": "replaceAttachment",
                    "parameter": {
                        "id" : this.documentId,
                        "workid": this.form.businessData.work.id
                    },
                    "accept" : ".ofd",
                    "data":{
                    },
                    "onCompleted": function(json){
                        this.documentId = json.data.id;
                        this.setData();
                        this.loadOfdView();
                    }.bind(this)
                });
            }

            upload.load();
        }.bind(this));

    },
    getData: function(){
        var data = {
            "documentId" : ""
        };
        if(this.form.businessData.data[this.json.id]){
            data.documentId = this.form.businessData.data[this.json.id].documentId;
        }
        return data;
    },
    setData: function(){

        var data = {
            "documentId" : this.documentId
        };
        this._setBusinessData(data);
    },
    loadOfdView: function(){
        this.iframeNode = new Element("div").inject(this.node);
        this.iframeNode.setStyles({
            "height": "100%"
        });
        var fileUrl;
        if(this.json.template && (this.json.templateType === "value" && this.json.template !=="")){
            fileUrl = this.json.template;
        }else if(this.json.templeteScript && (this.json.templateType === "script" && this.json.templeteScript !=="")){
            fileUrl = this.form.Macro.exec(this.json.templeteScript.code, this);
        }else {
            var host = o2.Actions.getHost( "x_processplatform_assemble_surface" );
            fileUrl = o2.filterUrl(host + "/x_processplatform_assemble_surface/jaxrs/attachment/download/" + this.documentId);
        }

        if(this.iframe){
            this.iframe.set("src","../o2_lib/ofdjs/index.html?file=" + fileUrl);
        }else {
            this.iframe = new Element("iframe").inject(this.iframeNode);
            this.iframe.set("src","../o2_lib/ofdjs/index.html?file=" + fileUrl);
            this.iframe.set("scrolling","no");
            this.iframe.set("frameborder",0);
            this.iframe.setStyles({
                "height" : "100%",
                "width" : "100%"
            });
        }
        if(this.emptyNode) this.emptyNode.hide();

        this.fireEvent("afterOpen");
    },
    loadOfdViewByUrl : function (fileUrl){
        if(this.iframe){
            this.iframe.set("src","../o2_lib/ofdjs/index.html?file=" + fileUrl);
        }else {
            this.iframe = new Element("iframe").inject(this.iframeNode);
            this.iframe.set("src","../o2_lib/ofdjs/index.html?file=" + fileUrl);
            this.iframe.set("scrolling","no");
            this.iframe.set("frameborder",0);
            this.iframe.setStyles({
                "height" : "100%",
                "width" : "100%"
            });
        }
        if(this.emptyNode) this.emptyNode.hide();

        this.fireEvent("afterOpen");
    },
    hide: function(){
        this.node.hide();
    },
    show: function(){
        this.node.show();
    },
    isEmpty : function(){
    },
    save: function(){
    },
    validation: function(){return true}
});

MWF.xDesktop.requireApp('process.Xform', 'OOSelect', null, false);
MWF.xApplication.process.Xform.OOAddress = MWF.APPOOAddress = new Class({
    Implements: [Events],
    Extends: MWF.APPOOSelect,
    iconStyle: 'selectIcon',
    options: {
        moduleEvents: ['load', 'queryLoad', 'postLoad'],
    },

    _loadNode: function () {
        if (!this.isReadable && !!this.isHideUnreadable) {
            this.node.setStyle('display', 'none');
        } else {
            this._loadNodeEdit();
        }
    },
    _loadNodeEdit: function () {
        this._resetNodeEdit();
        this.node.setAttribute('value', undefined);
        this.node.removeAttribute('placeholder');

        this.node.setAttribute('option-width', 'auto');

        if (o2.isMediaMobile() && !this.json.inDatatable) {
            this.node.setAttribute('skin-mode', 'mobile');
        } else {
            this.node.removeAttribute('skin-mode');
        }

        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }
        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        }

        if (this.json.inDatatable) {
            this.node.setAttribute('view-style', '');
        }

        this.node.setAttribute('readonly', false);
        this.node.setAttribute('readmode', false);
        this.node.setAttribute('disabled', false);
        if (!this.isReadonly() && this.isEditable) {
            if (this.json.showMode === 'readonlyMode') {
                this.node.setAttribute('readonly', true);
            } else if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                if (this.json.readModeEvents !== 'yes') {
                    this.node.setStyle('pointer-events', 'none');
                }
            } else {
            }
        } else {
            this.node.setAttribute('readmode', true);
            if (this.json.readModeEvents !== 'yes') {
                this.node.setStyle('pointer-events', 'none');
            }
        }

        if (this.json.required) {
            this.node.setAttribute('required', true);
            // if (!this.json.validationConfig) this.json.validationConfig = [];
            // var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
            // this.json.validationConfig.push({
            // 	status : "all",
            // 	decision : "",
            // 	valueType : "length",
            // 	operateor : "isnull",
            // 	value : "",
            // 	prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            // });
        } else {
            this.node.removeAttribute('required');
        }

        // if (this.json.allowInput) {
        //     this.node.setAttribute('allow-input', 'true');
        // }else{
        this.node.removeAttribute('allow-input');
        // }

        this.node.addEvent(
            'change',
            function (ev) {
                var v = this.getInputData('change');
                this._setBusinessData(v);
                this.validationMode();
                this.validation();
                this.fireEvent('change', [this._getSelectedOption()]);
            }.bind(this),
        );

        var inputNode = this.node;
        // if (inputNode) inputNode.addEvent('input', function (e) {
        // 	var v = e.target.get('value');
        // 	this._setBusinessData(v);
        // }.bind(this));

        // this.node.addEvent('blur', function () {
        // 	this.validation();
        // }.bind(this));
        // this.node.addEvent('keyup', function () {
        // 	this.validationMode();
        // }.bind(this));

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });
        this.node.addEventListener('invalid', (e) => {
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });

        this.setOptions();
    },

    _createOptionItem: function (o, node) {
        var option = new Element('oo-option');
		option.setAttribute('value', o.name);
        option.setAttribute('text', o.name);
		option.setAttribute('data-address-level', o.level);
        option.inject(node);
        return option;
    },
    _createSubLoadingOption: function (node) {
        const option = new Element('oo-option');
        option.setAttribute('icon', 'loading');
        node.appendChild(option);

        const loadSubOptionFun = async () => {
            const items = await this._getAddressData(node);
            node.empty();
            this._setOptionItems(items, node);
            node.removeEventListener('show', loadSubOptionFun);
        };
        node.addEventListener('show', loadSubOptionFun);
    },
	_getAddressData: function(node){
		return new Promise((r)=>{
			const v = node.value;
			switch (node.dataset.addressLevel){
				case 'province':
					o2.Actions.get("x_general_assemble_control").listCity(v, function(json){
						r(json.data);
					});
					break;
				case 'city':
					o2.Actions.get("x_general_assemble_control").listDistrict(v[0], v[1], function(json){
						r(json.data);
					});
					break;
				case 'district':
					r([]);
					break;
				default:
					o2.Actions.get("x_general_assemble_control").listProvince(function(json){
						r(json.data);
					});
			}
		
		});
	},
    _setOptionItems: function (items, node) {
        items.each(
            function (o) {
                var option = this._createOptionItem(o, node);
				
                if (o.level !== this.json.selectRange && o.level!=='district') {
					this._createSubLoadingOption(option);
                }
            }.bind(this),
        );
    },

    setOptions: function () {
        o2.Actions.get('x_general_assemble_control').listProvince(
            function (json) {
                this._setOptionItems(json.data, this.node);
            }.bind(this),
        );
    },

    addOption: function (text, value) {},

    __setValue: function (value) {
        this._setBusinessData(value);
        this.node.value = value;
        this.fieldModuleLoaded = true;
        this.moduleValueAG = null;
    },

    _getSelectedOption: function () {
        var ops = this.node.getElements('oo-option');
        for (var i = 0; i < ops.length; i++) {
            if (ops[i].selected) return ops[i];
        }
        return null;
    },
    _getInputTextData: function () {
        return {value: this.node.value, text: this.node.text};
    },
    getText: function () {
        return this.node.text;
    },
    getInputData: function () {
        return this.node.value;
    },
    resetData: function () {
        this.setData(this.getValue());
    },

    setData: function (data, fireChange) {
        return this._setValue(data, '__setData', fireChange);
    },

    __setData: function (data, fireChange) {
        var old = this.getInputData();
        this.moduleValueAG = null;
        this._setBusinessData(data);
        this.node.set('value', data || '');
        this.fieldModuleLoaded = true;
        if (fireChange && old !== data) this.fireEvent('change');
        return value;
    },

    notValidationMode: function (text) {
        this.validationText = text;
        this.node.checkValidity();
    },
    validationMode: function () {
        this.validationText = '';
        this.node.unInvalidStyle();
    },
});

MWF.xDesktop.requireApp('process.Xform', 'Button', null, false);
MWF.xApplication.process.Xform.OOButton = MWF.APPOOButton = new Class({
    Implements: [Events],
    Extends: MWF.APPButton,
    iconStyle: 'textFieldIcon',

    _loadUserInterface: function () {
        // var button = new Element('oo-button');
        // button.inject(this.node, "after");
        // this.node.destroy();
        // this.node = button;

        if (!this.isReadable || !this.isEditable) {
            this.node.setStyle('display', 'none');
        } else {
            this.node.set({
                id: this.json.id,
                MWFType: this.json.type,
            });
            this.node.setAttribute('text', this.json.name || this.json.id);
            if (this.json.properties) {
                this.node.set(this.json.properties);
            }
            if (this.json.styles) {
                this.node.setStyles(this.json.styles);
            }
            this.node.setAttribute('type', this.json.appearance || 'default');
            if (this.json.leftIcon) this.node.setAttribute('left-icon', this.json.leftIcon);
            if (this.json.rightIcon) this.node.setAttribute('right-icon', this.json.rightIcon);
            if (this.json.disabled) this.node.setAttribute('disabled', this.json.disabled);
        }
    },
});

MWF.xDesktop.requireApp('process.Xform', 'OORadioGroup', null, false);
MWF.xApplication.process.Xform.OOCheckGroup = MWF.APPOOCheckGroup = new Class({
    Implements: [Events],
    Extends: MWF.APPOORadioGroup,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        "tag": "oo-checkbox-group",
        "itemTag": "oo-checkbox"
    },

    // _loadNode: function () {
    //     // if (this.isReadonly() || this.json.showMode==="read"){
    //     //     this._loadNodeRead();
    //     // }else{
    //     this._loadNodeEdit();
    //     // }
    // },
    //
    //
    _loadNodeEdit: function () {
        var node = new Element(this.options.tag, {
            'id': this.json.id,
            'MWFType': this.json.type,
            // "label-style": "width:6.2vw; min-width:4.3em; max-width:9em"
        }).inject(this.node, 'before');
        this.node.destroy();
        this.node = node;

        if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }

        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }

        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        }
        if (!this.json.countPerline || this.json.countPerline==="0") {
            this.node.removeAttribute('col');
        }else{
            this.node.setAttribute('col', this.json.countPerline);
        }
        if (this.json.canSelectCount){
            this.node.setAttribute('count', this.json.canSelectCount);
        }

        if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

        if (!this.isReadonly() && this.isEditable){
            if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                if (this.json.readModeEvents!=='yes'){
                    this.node.setStyle('pointer-events', 'none');
                }
            } else {
            }
        }else{
            this.node.setAttribute('readmode', true);
            if (this.json.readModeEvents!=='yes'){
                this.node.setStyle('pointer-events', 'none');
            }
        }

        if (this.json.required){
            this.node.setAttribute("required", true);
            if (!this.json.validationConfig) this.json.validationConfig = [];
            var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
            this.json.validationConfig.push({
                status : "all",
                decision : "",
                valueType : "value",
                operateor : "isnull",
                value : "",
                prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            });
        }else{
            this.node.removeAttribute("required");
        }

        this.node.addEvent('change', function () {
            var v = this.getInputData('change');
            this.validationMode();
            // if (this.node.value.length) this.validation();
            this._setBusinessData(v);
            this.fireEvent('change');

        }.bind(this));

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });
        this.node.addEventListener('invalid', (e)=>{
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });

        this.setOptions();
    },
    _setValue: function(value, m, fireChange){
        var mothed = m || "__setValue";
        if (!!value){
            var p = o2.promiseAll(value).then(function(v){
                //if (o2.typeOf(v)=="array") v = v[0];
                if (this.moduleSelectAG){
                    this.moduleValueAG = this.moduleSelectAG;
                    this.moduleSelectAG.then(function(){
                        this[mothed](v, fireChange);
                        return v;
                    }.bind(this), function(){});
                }else{
                    this[mothed](v, fireChange)
                }
                return v;
            }.bind(this), function(){});
            this.moduleValueAG = p;
            if (this.moduleValueAG) this.moduleValueAG.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
        }else{
            this[mothed](value, fireChange);
        }
    },
    __setData: function(data, fireChange){
        var old = this.getInputData();
        this._setBusinessData(data);
        this.node.value = data;
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function(value){
        this.moduleValueAG = null;
        this._setBusinessData(value);
        this.node.value = value;

        this.fieldModuleLoaded = true;
    },

    getSelectedInput: function(){
        var inputs = this.node.getElements(this.options.itemTag);
        var items = [];
        for (var i of inputs){
            if (i.checked) items.push(i);
        }
        return items;
    }
    // __setData: function(data, fireChange){
    //     this.moduleValueAG = null;
    //     this._setBusinessData(data);
    //     this.node.value = data;
    //     this.validationMode();
    //     this.fieldModuleLoaded = true;
    //     this.fireEvent("setData");
    // },
    //
    // notValidationMode: function (text) {
    //     this.validationText = text;
    //     this.node.checkValidity();
    // },
    // validationMode: function () {
    //     this.validationText = '';
    // }
});

MWF.xDesktop.requireApp('process.Xform', '$Input', null, false);
MWF.xApplication.process.Xform.OOCurrency = MWF.APPOOCurrency = new Class({
    Implements: [Events],
    Extends: MWF.APP$Input,
    iconStyle: 'textFieldIcon',
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"]
    },
    _loadNode: function () {
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this._loadNodeEdit();
        }
    },

    loadDescription: function () {
        this.node.setAttribute('placeholder', this.json.description || '');
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadNodeEdit: function () {
        this.node.set({
            'id': this.json.id,
            'MWFType': this.json.type,
            'validity-blur': 'true',
            // "label-style": "width:6.2vw; min-width:5em; max-width:9em"
        });

        if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }

        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }

        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        }

        if (this.json.showIcon != 'no' && !this.form.json.hideModuleIcon) {
            this.node.setAttribute('right-icon', (this.json.properties && this.json.properties["right-icon"]) || 'currency');
        } else if (this.form.json.nodeStyleWithhideModuleIcon) {
            this.node.setAttribute('right-icon', '');
        }

        if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

        this.node.setAttribute('readonly', false);
        this.node.setAttribute('readmode', false);
        this.node.setAttribute('disabled', false);

        if (!this.isReadonly() && this.isEditable){
            if (this.json.showMode === 'readonlyMode') {
                this.node.setAttribute('readonly', true);
            } else if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                if (this.json.readModeEvents!=='yes'){
                    this.node.setStyle('pointer-events', 'none');
                }
            } else {
            }
        }else{
            this.node.setAttribute('readmode', true);
            if (this.json.readModeEvents!=='yes'){
                this.node.setStyle('pointer-events', 'none');
            }
        }
        if (this.json.required){
            this.node.setAttribute("required", true);
            if (!this.json.validationConfig) this.json.validationConfig = [];
            var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
            this.json.validationConfig.push({
                status : "all",
                decision : "",
                valueType : "value",
                operateor : "isnull",
                value : "",
                prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            });
        }else{
            this.node.removeAttribute("required");
        }


        if (this.json.innerHTML){
			this.node.set("html", this.json.innerHTML);
		}

        this.checkCurrencyAttribute();

        this.node.addEvent('change', function () {
            var v = this.getInputData('change');
            this.validationMode();
            this.validation()
            this._setBusinessData(v);
            this.fireEvent('change');
        }.bind(this));

        // var inputNode = this.node;
        // if (inputNode) inputNode.addEvent('input', function (e) {
        //     var v = e.target.get('value');
        //     this._setBusinessData(v);
        // }.bind(this));

        this.node.addEvent('blur', function () {
            this.validationMode();
            this.validation();
        }.bind(this));
        this.node.addEvent('keyup', function () {
            this.validationMode();
        }.bind(this));

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });
    },
    checkCurrencyAttribute: function (){
        var checkAttribute = function (name) {
            if( typeof this.json[name] === 'undefined' ){
                removeAttribute(name);
            }else{
                if( this.node.getAttribute(name) !== this.json[name].toString() ){
                    this.node.setAttribute(name, this.json[name]);
                }
            }
        }.bind(this);
        var removeAttribute = function (name) {
            this.node.hasAttribute(name) && this.node.removeAttribute(name);
        }.bind(this);

        if( this.json.preset === 'currency' ){
            removeAttribute("prefix");
            removeAttribute("suffix");
            removeAttribute('thousands');
            removeAttribute('decimal');
            checkAttribute('currency');
            checkAttribute('prefixuse');
        }else{
            if( !this.json.decimal ){
                this.json.decimal = '.';
            }
            removeAttribute('currency');
            removeAttribute('prefixuse');
            checkAttribute("prefix");
            checkAttribute("suffix");
            checkAttribute('thousands');
            checkAttribute('decimal');
        }

        ['precision','allowblank','disablenegative', 'round'].forEach(function (name){
            checkAttribute(name);
        }.bind(this));

        ['maximum','minimum'].forEach(function (name){
            this.json[name] === '' ? removeAttribute(name) : checkAttribute(name);
        }.bind(this));
    },
    createModelNode: function () {
    },
    __setData: function(data, fireChange){
        var old = this.getInputData();
        this.validationMode();
        this._setBusinessData(data);
        this.node.value = data;
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function (value) {
        this.moduleValueAG = null;
        this.validationMode();
        this._setBusinessData(value);
        // this.node.set('value', value || '');
        this.node.value = value;
        this.fieldModuleLoaded = true;
        return value;
    },

    getInputData: function () {
        return this.node.value;
    },

    notValidationMode: function (text) {
        this.validationText = text;
        this.node.checkValidity();

        if ( this.node && !this.node.isIntoView()) this.node.scrollIntoView({ behavior: "smooth", block: "center" });
    },
    validationMode: function () {
        this.validationText = '';
        this.node.unInvalidStyle();
    }
});

MWF.xDesktop.requireApp('process.Xform', '$Input', null, false);
MWF.xApplication.process.Xform.OODatetime = MWF.APPOODatetime = new Class({
    Implements: [Events],
    Extends: MWF.APP$Input,
    iconStyle: 'textFieldIcon',
    options: {
        moduleEvents: ['load', 'queryLoad', 'postLoad'],
    },
    _loadNode: function () {
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this._loadNodeEdit();
        }
    },
    loadDescription: function () {
        this.node.setAttribute('placeholder', this.json.description || '');
    },
    _loadDomEvents: function () {
        Object.each(
            this.json.events,
            function (e, key) {
                if (e.code) {
                    if (this.options.moduleEvents.indexOf(key) === -1) {
                        this.node.addEvent(
                            key,
                            function (event) {
                                return this.form.Macro.fire(e.code, this, event);
                            }.bind(this),
                        );
                    }
                }
            }.bind(this),
        );
    },
    _loadNodeEdit: function () {
        this.node.set({
            id: this.json.id,
            MWFType: this.json.type,
            'validity-blur': 'true',
            // "label-style": "width:6.2vw; min-width:5em; max-width:9em"
        });
        if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }
        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }

        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        }

        if (this.json.showIcon !== 'no' && !this.form.json.hideModuleIcon) {
            this.node.setAttribute('right-icon', 'calendar');
        } else if (this.form.json.nodeStyleWithhideModuleIcon) {
            this.node.setAttribute('right-icon', '');
        }

        if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

        this.node.setAttribute('readonly', true);
        this.node.setAttribute('readmode', false);
        this.node.setAttribute('disabled', false);
        this.node.setAttribute('read', false);

        if (!this.isReadonly() && this.isEditable) {
            if (this.json.showMode === 'readonlyMode') {
                this.node.setAttribute('readonly', true);
                this.node.setAttribute('read', true);
            } else if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
                this.node.setAttribute('read', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                this.node.setAttribute('read', true);
                if (this.json.readModeEvents !== 'yes') {
                    this.node.setStyle('pointer-events', 'none');
                }
            } else {
                this.node.setAttribute('readonly', true);
            }
        } else {
            this.node.setAttribute('readmode', true);
            if (this.json.readModeEvents !== 'yes') {
                this.node.setStyle('pointer-events', 'none');
            }
        }
        if (this.json.required) {
            this.node.setAttribute('required', true);
            if (!this.json.validationConfig) this.json.validationConfig = [];
            var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` : MWF.xApplication.process.Xform.LP.requiredHintField;
            this.json.validationConfig.push({
                status: 'all',
                decision: '',
                valueType: 'value',
                operateor: 'isnull',
                value: '',
                prompt: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            });
        } else {
            this.node.removeAttribute('required');
        }

        // this.node.setAttribute('year-only', false);
        // this.node.setAttribute('month-only', false);
        // this.node.setAttribute('date-only', false);
        // this.node.setAttribute('week-only', false);
        // this.node.setAttribute('time-only', false);

        if (this.json.defaultView){
            this.node.setAttribute('view', this.json.defaultView);
        }

        if (this.json.dataType) {
            switch (this.json.dataType) {
                case 'date-only':
                    this.node.setAttribute('mode', 'date');
                    break;
                case 'month-only':
                    this.node.setAttribute('mode', 'month');
                    break;
                case 'year-only':
                    this.node.setAttribute('mode', 'year');
                    break;
                case 'time-only':
                    this.node.setAttribute('mode', 'time');
                    break;
                case 'week-only':
                    this.node.setAttribute('mode', 'week');
                    break;
                default:
            }
            // if (this.json.dataType !== 'dateTime') {
            //     this.node.setAttribute(this.json.dataType, true);
            // }
        }
        if (this.json.secondEnable === 'yes') {
            this.node.setAttribute('second-enable', true);
        } else {
            this.node.setAttribute('second-enable', false);
        }

        this.node.setAttribute('week-begin', this.json.weekBegin || 1);

        if (this.json.format) this.node.setAttribute('format', this.json.format);

        this.node.addEvent(
            'change',
            function () {
                var v = this.getInputData('change');
                this.validationMode();
                this.validation();
                this._setBusinessData(v);
                this.fireEvent('change');
            }.bind(this),
        );

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });

        this.node.addEventListener('invalid', (e)=>{
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });

        this.setRange();

    },
    createModelNode: function () {
        this.modelNode = new Element('div', {styles: this.form.css.modelNode}).inject(this.node, 'after');
        new Element('div', {
            styles: this.form.css.modelNodeTitle,
            text: MWF.xApplication.process.Xform.LP.ANNInput,
        }).inject(this.modelNode);
        new Element('div', {
            styles: this.form.css.modelNodeContent,
            text: MWF.xApplication.process.Xform.LP.ANNInput,
        }).inject(this.modelNode);
    },
    __setData: function (data, fireChange) {
        var old = this.getInputData();
        this._setBusinessData(data);
        this.node.value = data;
        if (fireChange && old !== data) this.fireEvent('change');
        this.moduleValueAG = null;
    },
    __setValue: function (value) {
        this.moduleValueAG = null;
        this._setBusinessData(value);
        this.node.set('value', value || '');
        this.fieldModuleLoaded = true;
        return value;
    },

    getInputData: function () {
        return this.node.value;
    },

    notValidationMode: function (text) {
        this.validationText = text;
        this.node.checkValidity();
    },
    validationMode: function () {
        this.validationText = '';
        this.node.unInvalidStyle();
    },
    setRange: function(){
        var range, j = this.json;
        switch ( j.rangeType ) {
            case "dateTime":
                var datetimeRangeScript = j.dateTimeRangeScript && j.dateTimeRangeScript.code;
                if (datetimeRangeScript) {
                    range = this.form.Macro.fire(datetimeRangeScript, this);
                    o2.typeOf(range) === "array" && this.node.setDatetimeRange(range);
                }
                break;
            case "dateAndTime":
                var dateRangeScript = j.dateRangeScript && j.dateRangeScript.code;
                if (dateRangeScript) {
                    range = this.form.Macro.fire(dateRangeScript, this);
                    o2.typeOf(range) === "array" && this.node.setDateRange(range);
                }
                var timeRangeScript = j.timeRangeScript && j.timeRangeScript.code;
                if (timeRangeScript) {
                    range = this.form.Macro.fire(timeRangeScript, this);
                    o2.typeOf(range) === "array" && this.node.setTimeRange(range);
                }
                break;
            case "other":
                var enableYear = j.enableYear && j.enableYear.code;
                if (!!enableYear) {
                    this.node.setCustomRangeMethod('year', function (year) {
                        return this.form.Macro.fire(enableYear, this, {year: year});
                    }.bind(this));
                }
                var enableMonth = j.enableMonth && j.enableMonth.code;
                if (!!enableMonth) {
                    this.node.setCustomRangeMethod('month', function (month) {
                        return this.form.Macro.fire(enableMonth, this, {month: month});
                    }.bind(this));
                }
                var enableDate = j.enableDate && j.enableDate.code;
                if (!!enableDate) {
                    this.node.setCustomRangeMethod('date', function (date) {
                        return this.form.Macro.fire(enableDate, this, {date: date});
                    }.bind(this));
                }
                var enableHour = j.enableHour && j.enableHour.code;
                if (enableHour) {
                    this.node.setCustomRangeMethod('hour', function (date, hour) {
                        return this.form.Macro.fire(enableHour, this, {date: date, hour: hour});
                    }.bind(this));
                }
                var enableMinute = j.enableMinute && j.enableMinute.code;
                if (enableMinute) {
                    this.node.setCustomRangeMethod('minute', function (date, hour, minute) {
                        return this.form.Macro.fire(enableMinute, this, {date: date, hour: hour, minute: minute});
                    }.bind(this));
                }
                var enableSecond = j.enableSecond && j.enableSecond.code;
                if (enableSecond) {
                    this.node.setCustomRangeMethod('second', function (date, hour, minute, second) {
                        return this.form.Macro.fire(enableSecond, this, {date: date, hour: hour, minute: minute, second:second});
                    }.bind(this));
                }
                break;
        }
    }
});

MWF.xDesktop.requireApp('process.Xform', '$Input', null, false);
MWF.xApplication.process.Xform.OOInput = MWF.APPOOInput = new Class({
    Implements: [Events],
    Extends: MWF.APP$Input,
    iconStyle: 'textFieldIcon',
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"]
    },
    _loadNode: function () {
        // if (this.isReadonly() || this.json.showMode==="read"){
        //     this._loadNodeRead();
        // }else{
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this._loadNodeEdit();
        }
        
        // }
    },

    loadDescription: function () {
        this.node.setAttribute('placeholder', this.json.description || '');
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadNodeEdit: function () {
        this.node.set({
            'id': this.json.id,
            'MWFType': this.json.type,
            'validity-blur': 'true',
            // "label-style": "width:6.2vw; min-width:5em; max-width:9em"
        });

        if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }

        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }

        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        } 

        if (this.json.showIcon != 'no' && !this.form.json.hideModuleIcon) {
            this.node.setAttribute('right-icon', (this.json.properties && this.json.properties["right-icon"]) || 'edit');
        } else if (this.form.json.nodeStyleWithhideModuleIcon) {
            this.node.setAttribute('right-icon', '');
        }

        if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

        this.node.setAttribute('readonly', false);
        this.node.setAttribute('readmode', false);
        this.node.setAttribute('disabled', false);

        if (!this.isReadonly() && this.isEditable){
            if (this.json.showMode === 'readonlyMode') {
                this.node.setAttribute('readonly', true);
            } else if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                if (this.json.readModeEvents!=='yes'){
                    this.node.setStyle('pointer-events', 'none');
                }
            } else {
            }
        }else{
            this.node.setAttribute('readmode', true);
            if (this.json.readModeEvents!=='yes'){
                this.node.setStyle('pointer-events', 'none');
            }
        }
        if (this.json.required){
            this.node.setAttribute("required", true);
            if (!this.json.validationConfig) this.json.validationConfig = [];
            var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
            this.json.validationConfig.push({
                status : "all",
                decision : "",
                valueType : "value",
                operateor : "isnull",
                value : "",
                prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            });
        }else{
            this.node.removeAttribute("required");
        }

        if (this.json.dataType){
            this.node.setAttribute("type", this.json.dataType);
        }
        if (this.json.innerHTML){
			this.node.set("html", this.json.innerHTML);
		}

        this.node.addEvent('change', function () {
            var v = this.getInputData('change');
            this.validationMode();
            this.validation()
            this._setBusinessData(v);
            this.fireEvent('change');
        }.bind(this));

        var inputNode = this.node;
        if (inputNode) inputNode.addEvent('input', function (e) {
            var v = e.target.get('value');
            this._setBusinessData(v);
        }.bind(this));

        this.node.addEvent('blur', function () {
            this.validationMode();
            this.validation();
        }.bind(this));
        this.node.addEvent('keyup', function () {
            this.validationMode();
        }.bind(this));

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });
        this.node.addEventListener('invalid', (e)=>{
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });
    },
    createModelNode: function () {
        // this.modelNode = new Element('div', {'styles': this.form.css.modelNode}).inject(this.node, 'after');
        // new Element('div', {
        //     'styles': this.form.css.modelNodeTitle,
        //     'text': MWF.xApplication.process.Xform.LP.ANNInput
        // }).inject(this.modelNode);
        // new Element('div', {
        //     'styles': this.form.css.modelNodeContent,
        //     'text': MWF.xApplication.process.Xform.LP.ANNInput
        // }).inject(this.modelNode);
    },
    __setData: function(data, fireChange){
        var old = this.getInputData();
        this.validationMode();
        this._setBusinessData(data);
        this.node.value = data;
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function (value) {
        this.moduleValueAG = null;
        this.validationMode();
        this._setBusinessData(value);
        // this.node.set('value', value || '');
        this.node.value = value;
        this.fieldModuleLoaded = true;
        return value;
    },

    getInputData: function () {
        return this.node.value;
    },

    notValidationMode: function (text) {
        this.validationText = text;
        this.node.checkValidity();

        if ( this.node && !this.node.isIntoView()) this.node.scrollIntoView({ behavior: "smooth", block: "center" });
    },
    validationMode: function () {
        this.validationText = '';
        this.node.unInvalidStyle();
    }
});

MWF.xDesktop.requireApp("process.Xform", "Log", null, false);

MWF.xApplication.process.Xform.OOLog = MWF.APPOOLog =  new Class({
    Extends: MWF.APPLog,

    textStyles:{
        "default": `<div class="logItem">
                        <div style="flex: 0 0 4em">
                            <div class="logItemIcon" style="background-image: url('/x_organization_assemble_control/jaxrs/person/{person}/icon');"></div>
                        </div>
                        <div style="flex: 1;     display: flex; justify-content: space-between; align-items: center;">
                            <div>
                            <div><font style='color:#ff5400;'>{person}</font>（{department}）选择<font style='color: var(--oo-color-main)'>【{route}】</font></div>
                            <div>处理意见：<font>{opinion}</font></div>
                            </div>
                            <div><b>{activity}</b></div>
                        </div>
                        
                        <div style="flex: 0 0 11.85em; display: block">{img}</div>
                        <div>{time}</div>
                    </div>`

    },

    getRecordTaskLineTextStyle: function(){
        return this.textStyles.default;
    },
    loadRecordTaskLine_default_currentTask: function (task, textNode, iconNode) {

        var person = (task.person) ? task.person.substring(0, task.person.indexOf("@")) : "";
        if (task.properties.empowerFromIdentity) {
            var ep = o2.name.cn(task.properties.empowerFromIdentity);
            person = person + " " + MWF.xApplication.process.Xform.LP.replace + " " + ep;
        }
        var html = this.getRecordTaskLineTextStyle();
        html = html.replace(/{person}/g, person)
        .replace(/{department}/g, o2.name.cn(task.unit))
        .replace(/{activity}/g, task.fromActivityName)
        .replace(/{route}/g, MWF.xApplication.process.Xform.LP.processing+' ...')
        .replace(/{img}/g, '')
        .replace(/{time}/g, task.properties.startTime)

        textNode.set("html", html);
        if (iconNode) iconNode.setStyle("background-image", "url(" + "../x_component_process_Xform/$Form/" + this.form.options.style + "/icon/rightRed.png)");
    }

});

MWF.xDesktop.requireApp('process.Xform', 'Org', null, false);
MWF.xApplication.process.Xform.OOOrg = MWF.APPOOOrg = new Class({
    Implements: [Events],
    Extends: MWF.APPOrg,
    iconStyle: 'textFieldIcon',
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad", "change", "select", "removeItem"]
    },
    _loadNode: function () {
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this._getOrgOptions();
            this._loadNodeEdit();
        }
    },
    loadDescription: function () {
        this.node.setAttribute('placeholder', this.json.description || '');
    },
    _loadDomEvents: function(){
        if (!((this.json.showMode === 'read' || this.isReadonly()) && this.json.readModeEvents!=='yes')) {
            Object.each(this.json.events, function(e, key){
                if (e.code){
                    if (this.options.moduleEvents.indexOf(key)===-1){
                        this.node.addEvent(key, function(event){
                            return this.form.Macro.fire(e.code, this, event);
                        }.bind(this));
                    }
                }
            }.bind(this));
        }
    },
    _loadNodeEdit: function () {
        this.node.set({
            'id': this.json.id,
            'MWFType': this.json.type,
            'validity-blur': 'true',
            // "label-style": "width:6.2vw; min-width:5em; max-width:9em"
        });
        if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }
        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        }

        if (this.json.showIcon !== 'no' && !this.form.json.hideModuleIcon) {
            this.node.setAttribute('right-icon', 'person');
        } else if (this.form.json.nodeStyleWithhideModuleIcon) {
            this.node.setAttribute('right-icon', '');
        }

        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }

        if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

        this.node.setAttribute('readonly', false);
        this.node.setAttribute('readmode', false);
        this.node.setAttribute('disabled', false);

        if (!this.isReadonly() && this.isEditable){
            if (this.json.showMode === 'readonlyMode') {
                this.node.setAttribute('readonly', true);
            } else if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                // if (this.json.readModeEvents!=='yes'){
                //     this.node.setStyle('pointer-events', 'none');
                // }
            } else {
            }
        }else{
            this.node.setAttribute('readmode', true);
            // if (this.json.readModeEvents!=='yes'){
            //     this.node.setStyle('pointer-events', 'none');
            // }
        }

        if (this.json.required){
            this.node.setAttribute("required", true);
            if (!this.json.validationConfig) this.json.validationConfig = [];
            var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
            this.json.validationConfig.push({
                status : "all",
                decision : "",
                valueType : "value",
                operateor : "isnull",
                value : "",
                prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            });
        }else{
            this.node.removeAttribute("required");
        }

        this.node.addEvent('change', function () {

            var v = this.getInputData('change');
            this.validationMode();
            this.validation();
            this._setBusinessData(v);
            this.fireEvent('change');
        }.bind(this));

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });
        this.node.addEventListener('invalid', (e)=>{
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });

        this.node.setAttribute('sel-config', 'o29');
        this.node.select = ()=>{
            this.node.unInvalidStyle();
            this.clickSelect();
        }
    },
    createModelNode: function () {
    },


    clickSelect: function( ev ){
        if (this.isReadonly() || !this.isEditable)return;
        if( layout.mobile ){
            setTimeout( function(){ //如果有输入法界面，这个时候页面的计算不对，所以等100毫秒
                var options = this.getOptions();
                if(options){
                    if( !options.title && this.json.label ){
                        var select = MWF.xApplication.process.Xform.LP.select;
                        options.title = this.json.label.contains(select) ? this.json.label : (select+this.json.label);
                    }
                    if( this.selector && this.selector.loading ) {
                    }else if( this.selector && this.selector.selector && this.selector.selector.active ){
                    }else{
                        /**
                         * @summary 人员选择框package的对象
                         * @member {o2.O2Selector}
                         * @example
                         *  //可以在脚本中获取该组件
                         * var selector = this.form.get("fieldId").selector.selector; //获取人员选择框对象
                         * var options = selector.options; //获取人员选择框的选项
                         */
                        //options.style = 'v10';
                        // Object.assign(options, {
                        //     style: "v10_mobile",
                        //     tabStyle: "v10_mobile",
                        //     useBreadcrumbs: true,
                        //     contentUrl: "../x_component_Selector/$Selector/v10_mobile/selector.html",
                        //     categoryUrl: "../x_component_Selector/$Selector/v10_mobile/category.html",
                        //     categoryItemUrl: "../x_component_Selector/$Selector/v10_mobile/category_item.html",
                        //     itemUrl: "../x_component_Selector/$Selector/v10_mobile/item.html",
                        //     useO2Load: true,
                        //     injectToBody: true
                        // });
                        this.selector = new MWF.O2Selector(this.form.app.content, options);
                    }
                }
            }.bind(this), 100 );
        }else{
            var options = this.getOptions();
            if(options){
                if( !options.title && this.json.label ){
                    var select = MWF.xApplication.process.Xform.LP.select;
                    options.title = this.json.label.contains(select) ? this.json.label : (select+this.json.label);
                }
                if( this.selector && this.selector.loading ) {
                }else if( this.selector && this.selector.selector && this.selector.selector.active ){
                }else {
                    options.style = 'v10';
                    options.tabStyle = 'v10';
                    this.selector = new MWF.O2Selector(this.form.app.content, options);
                }
            }
        }
    },

    selectOnComplete: function(items){
        var array = [];
        items.each(function(item){
            array.push(item.data);
        }.bind(this));

        var simple = this.json.storeRange === "simple";

        this.checkEmpower( array, function( data ){
            var values = [];

            data.each(function(d){
                values.push(MWF.org.parseOrgData(d, true, simple));
            }.bind(this));

            if (this.json.isInput){
                this.addData(values);
            }else{
                this.setData(values, true);
            }

            //this._setBusinessData(values);
            this.validationMode();
            this.validation();

            var p = this.getValue();
            if (p.then){
                p.then(function(){
                    if (this.node._props.validityBlur){
                        this.node.checkValidity();
                    }
                    this.node.dispatchEvent(new MouseEvent('change'));
                    this.fireEvent("select");
                }.bind(this), function(){});
            }else{
                if (this.node._props.validityBlur){
                    this.node.checkValidity();
                }
                this.node.dispatchEvent(new MouseEvent('change'));
                this.fireEvent("select");
            }

        }.bind(this))
    },

    __setData: function(data, fireChange){
        var old = this.getInputData();
        this._setBusinessData(data);
        this.node.value = data;
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function (value) {
        this.moduleValueAG = null;
        this._setBusinessData(value);
        // this.node.set('value', value || '');
        this.node.value = value.map(v => (v.distinguishedName || v)).join(', ');
        this.fieldModuleLoaded = true;
        return value;
    },

    getInputData: function () {
        return this.node.value;
    },

    notValidationMode: function (text) {
        this.validationText = text;
        this.node.checkValidity();
    },
    validationMode: function () {
        this.validationText = '';
        this.node.unInvalidStyle();
    },

    _setValue: function(value){
        var flag = false;
        if (typeOf(value)!=="array") value = (!!value) ? [value] : [];

        this.__setValue(value);
        return value;
    },
    isReadonly : function(){
        var readonly = !!(!this.isEditable || this.readonly || this.form.json.isReadonly || this.json.showMode==="read");
        if( readonly )return readonly;
        if( this.json.isReadonly === "script" ){
            if( this.json.readonlyScript && this.json.readonlyScript.code ){
                readonly = this.form.Macro.exec(this.json.readonlyScript.code, this);
            }
        }else{
            readonly = !!this.json.isReadonly
        }
        return readonly || !!this.isSectionMergeRead();
    },
    // addModuleEvent: function(key, fun){
    //     if (this.options.moduleEvents.indexOf(key)!==-1){
    //         this.addEvent(key, function(event){
    //             return (fun) ? fun(this, event) : null;
    //         }.bind(this));
    //     }else{
    //         this.node.addEvent(key, function(event){
    //             return (fun) ? fun(this, event) : null;
    //         }.bind(this));
    //     }
    // },
});

MWF.xDesktop.requireApp('process.Xform', '$Module', null, false);
MWF.xApplication.process.Xform.OOPagination = MWF.APPOOPagination = new Class({
    Implements: [Events],
    Extends: MWF.APP$Module,
    iconStyle: 'textFieldIcon',

    _loadUserInterface: function () {
        this.node.set({
            id: this.json.id,
            MWFType: this.json.type,
        });
        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }
        this.node.setAttribute('current', "1");
        this.node.setAttribute('first', this.json.first);
        this.node.setAttribute('last', this.json.last);
        this.node.setAttribute('pages', this.json.pages);
        this.node.setAttribute('jumper', this.json.jumper);
        this.node.setAttribute('jumper-text', this.json.jumperText);
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEventListener(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this))
                    // this.node.addEvent(key, function(event){
                    //     return this.form.Macro.fire(e.code, this, event);
                    // }.bind(this));
                }
            }
        }.bind(this));
    },
});

MWF.xDesktop.requireApp('process.Xform', 'Radio', null, false);
MWF.xApplication.process.Xform.OORadioGroup = MWF.APPOORadioGroup = new Class({
    Implements: [Events],
    Extends: MWF.APPRadio,
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"],
        "tag": "oo-radio-group",
        "itemTag": "oo-radio"
    },

    _loadNode: function () {
        // if (this.isReadonly() || this.json.showMode==="read"){
        //     this._loadNodeRead();
        // }else{
            if (!this.isReadable && !!this.isHideUnreadable){
                this.node.setStyle('display', 'none');
            }else{
                this._loadNodeEdit();
            }
        // }
    },
    getValue: function(){
        if (!this.isReadable) return '';
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if (!value) value = this._computeValue();
        return value || "";
    },
    _loadNodeEdit: function () {
        var node = new Element(this.options.tag, {
            'id': this.json.id,
            'MWFType': this.json.type,
            // "label-style": "width:6.2vw; min-width:5em; max-width:9em"
        }).inject(this.node, 'before');
        this.node.destroy();
        this.node = node;
        if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }
        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }

        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        }
        if (!this.json.countPerline || this.json.countPerline==="0") {
            this.node.removeAttribute('col');
        }else{
            this.node.setAttribute('col', this.json.countPerline);
        }

        if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

        if (!this.isReadonly() && this.isEditable){
            if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                if (this.json.readModeEvents!=='yes'){
                    this.node.setStyle('pointer-events', 'none');
                }
            } else {
            }
        }else{
            this.node.setAttribute('readmode', true);
            if (this.json.readModeEvents!=='yes'){
                this.node.setStyle('pointer-events', 'none');
            }
        }

        if (this.json.required){
            this.node.setAttribute("required", true);
            if (!this.json.validationConfig) this.json.validationConfig = [];
            var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
            this.json.validationConfig.push({
                status : "all",
                decision : "",
                valueType : "value",
                operateor : "isnull",
                value : "",
                prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            });
        }else{
            this.node.removeAttribute("required");
        }

        this.node.addEvent('change', function () {
            var v = this.getInputData('change');
            this.validationMode();
            if (this.node.value) this.validation();
            this._setBusinessData(v);
            this.fireEvent('change');
        }.bind(this));

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });

        this.node.addEventListener('invalid', (e)=>{
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });

        this.setOptions();
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            this.node.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _setOptions: function(optionItems) {
        var p = o2.promiseAll(optionItems).then(function (radioValues) {
            this.moduleSelectAG = null;

            if (!radioValues) radioValues = [];
            if (o2.typeOf(radioValues) === "array") {
                var flag = (new MWF.widget.UUID).toString();
                radioValues.each(function (item, i) {
                    var tmps = item.split("|");
                    var text = tmps[0];
                    var value = tmps[1] || text;
                    var value = tmps[1] || text;

                    var radio = new Element(this.options.itemTag, {
                        "type": "radio",
                        "name": (this.json.properties && this.json.properties.name) ? this.json.properties.name : flag + this.json.id,
                        "value": value,
                        // "text": text,
                        "styles": this.json.buttonStyles
                    }).inject(this.node);
                    radio.setAttribute('text', text);



                }.bind(this));
            }
        }.bind(this), function () {
            this.moduleSelectAG = null;
        }.bind(this));
        this.moduleSelectAG = p;
        if (p) p.then(function () {
            this.moduleSelectAG = null;
        }.bind(this), function () {
            this.moduleSelectAG = null;
        }.bind(this));
    },
    __setData: function(data, fireChange){
        var old = this.getInputData();
        this._setBusinessData(data);
        this.node.value = data;
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function(value){
        this.moduleValueAG = null;
        this._setBusinessData(value);
        this.node.value = value;

        this.fieldModuleLoaded = true;
    },
    getTextData: function () {
        return {"value": this.node.value , "text": this.node.text};
    },
    _getInputTextData: function(){
        return {"value": this.node.value , "text": this.node.text};
    },

    getText: function(){
        return this.node.text;
    },
    getInputData: function(){
        return this.node.value;
    },
    getSelectedInput: function(){
        var inputs = this.node.getElements(this.options.itemTag);
        for (var i of inputs){
            if (i.checked) return i;
        }
        return null;
    },
    __setData: function(data, fireChange){
        this.moduleValueAG = null;
        this._setBusinessData(data);
        this.node.value = data;
        this.validationMode();
        this.fieldModuleLoaded = true;
        this.fireEvent("setData");
    },


    //
    // createModelNode: function () {
    //     this.modelNode = new Element('div', {'styles': this.form.css.modelNode}).inject(this.node, 'after');
    //     new Element('div', {
    //         'styles': this.form.css.modelNodeTitle,
    //         'text': MWF.xApplication.process.Xform.LP.ANNInput
    //     }).inject(this.modelNode);
    //     new Element('div', {
    //         'styles': this.form.css.modelNodeContent,
    //         'text': MWF.xApplication.process.Xform.LP.ANNInput
    //     }).inject(this.modelNode);
    // },
    // __setValue: function (value) {
    //     this.moduleValueAG = null;
    //     this._setBusinessData(value);
    //     this.node.set('value', value || '');
    //     this.fieldModuleLoaded = true;
    //     return value;
    // },

    notValidationMode: function (text) {
        this.validationText = text;
        this.node.checkValidity();
    },
    validationMode: function () {
        this.validationText = '';
        this.node.unInvalidStyle();
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Selector", null, false);
MWF.xApplication.process.Xform.OOSelect = MWF.APPOOSelect =  new Class({
	Implements: [Events],
	Extends: MWF.APP$Selector,
	iconStyle: "selectIcon",
	options: {
		"moduleEvents": ["load", "queryLoad", "postLoad"]
	},

    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
		this.fieldModuleLoaded = false;
		this.nodeHtml = this.node.get("html");
    },

	reload: function(){
		if (this.areaNode){
			this.node = this.areaNode;
			this.areaNode.empty();
			this.areaNode = null;
		}
		this._beforeReloaded();
		this._loadUserInterface();
		this._loadStyles();
		this._afterLoaded();
		this._afterReloaded();
		this.fireEvent("postLoad");
	},

	loadDescription: function () {
		this.node.setAttribute('placeholder', this.json.description || '');
	},

    _loadNode: function(){
		if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this._loadNodeEdit();
        }

		// this._loadNodeEdit();
    },
	_loadMergeReadContentNode: function( contentNode, data ){
		// this._showValue(contentNode, data.data);
	},

	_loadDomEvents: function(){
		Object.each(this.json.events, function(e, key){
			if (e.code){
				if (this.options.moduleEvents.indexOf(key)===-1){
					this.node.addEvent(key, function(event){
						return this.form.Macro.fire(e.code, this, event);
					}.bind(this));
				}
			}
		}.bind(this));
	},

	__showValue: function(node, value, optionItems){
        // if (value){
        //     if (typeOf(value)!=="array") value = [value];
        //     var texts = [];
        //     optionItems.each(function(item){
        //         var tmps = item.split("|");
        //         var t = tmps[0];
        //         var v = tmps[1] || t;
		//
        //         if (v){
		//
        //             if (value.indexOf(v)!=-1){
        //                 texts.push(t);
        //             }
        //         }
		//
        //     });
        //     node.set("text", texts.join(", "));
        // }
	},

    _loadStyles: function(){
		if (this.json.styles) this.node.setStyles(this.json.styles);
    },
	_resetNodeEdit: function(){
		// var node = new Element('oo-select', {
		// 	'id': this.json.id,
		// 	'MWFType': this.json.type
		// }).inject(this.node, 'before');
		// this.node.destroy();
		// this.node = node;

		this.node.set({
			'id': this.json.id,
			'MWFType': this.json.type,
			// "label-style": "width:6.2vw; min-width:5em; max-width:9em"
		});

	},
	addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
			this.node.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }
    },
    _loadNodeEdit: function(){
		debugger;
		this._resetNodeEdit();
		this.node.setAttribute('value', undefined);
		this.node.removeAttribute("placeholder");

		if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }

		if (this.json.properties) {
			this.node.set(this.json.properties);
		}
		if (this.json.styles) {
			this.node.setStyles(this.json.styles);
		}
		if (this.json.label) {
			this.node.setAttribute('label', this.json.label);
		}

		if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

		this.node.setAttribute('readonly', false);
		this.node.setAttribute('readmode', false);
		this.node.setAttribute('disabled', false);
		if (!this.isReadonly() && this.isEditable){
			if (this.json.showMode === 'readonlyMode') {
				this.node.setAttribute('readonly', true);
			} else if (this.json.showMode === 'disabled') {
				this.node.setAttribute('disabled', true);
			} else if (this.json.showMode === 'read') {
				this.node.setAttribute('readmode', true);
				if (this.json.readModeEvents!=='yes'){
					this.node.setStyle('pointer-events', 'none');
				}
			} else {
			}
		}else{
			this.node.setAttribute('readmode', true);
			if (this.json.readModeEvents!=='yes'){
				this.node.setStyle('pointer-events', 'none');
			}
		}

		if (this.json.required){
			this.node.setAttribute("required", true);
			if (!this.json.validationConfig) this.json.validationConfig = [];
			var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
			this.json.validationConfig.push({
				status : "all",
				decision : "",
				valueType : "value",
				operateor : "isnull",
				value : "",
				prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
			});
		}else{
			this.node.removeAttribute("required");
		}

		if (this.json.allowInput) {
            this.node.setAttribute('allow-input', 'true');
        }else{
			this.node.removeAttribute('allow-input');
		}

        this.node.addEvent("change", function( ev ){
			var v = this.getInputData("change");
			this._setBusinessData(v);
            this.validationMode();
			this.validation();
			this.fireEvent("change", [this._getSelectedOption()]);
        }.bind(this));

		var inputNode = this.node;
		if (inputNode) inputNode.addEvent('input', function (e) {
			var v = e.target.get('value');
			this._setBusinessData(v);
		}.bind(this));

		this.node.addEvent('blur', function () {
			this.validation();
		}.bind(this));
		this.node.addEvent('keyup', function () {
			this.validationMode();
		}.bind(this));

		this.node.addEventListener('validity', (e) => {
			if (this.validationText) {
				e.target.setCustomValidity(this.validationText);
			}
		});
		this.node.addEventListener('invalid', (e)=>{
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });

		this.setOptions();
	},

	_setOptions: function(optionItems){
		var p = o2.promiseAll(optionItems).then(function(options){
			this.moduleSelectAG = null;
			if (!options) options = [];
			if (o2.typeOf(options)==="array"){
				options.each(function(item){
					var tmps = item.split("|");
					var text = tmps[0];
					var value = tmps[1] || text;

					var option = new Element("oo-option", {
						"value": value
					});
					option.setAttribute('value', value);
					option.setAttribute('text', text);
					option.inject(this.node);


				}.bind(this));
				this.fireEvent("setOptions", [options])
			}
		}.bind(this), function(){
			this.moduleSelectAG = null;
		}.bind(this));
		this.moduleSelectAG = p;
		if (p) p.then(function(){
			this.moduleSelectAG = null;
		}.bind(this), function(){
			this.moduleSelectAG = null;
		}.bind(this));
	},
	addOption: function(text, value){
        var option = new Element("oo-option", {
            "value": value || text,
            "text": text
        }).inject(this.node);
		option.setAttribute('value', value || text);
		this.fireEvent("addOption", [text, value])
	},

	// _setValue: function(value, m, fireChange){
	// 	var mothed = m || "__setValue";
	// 	if (!!value){
	// 		var p = o2.promiseAll(value).then(function(v){
	// 			if (o2.typeOf(v)=="array") v = v[0];
	// 			if (this.moduleSelectAG){
	// 				this.moduleValueAG = this.moduleSelectAG;
	// 				this.moduleSelectAG.then(function(){
	// 					this[mothed](v, fireChange);
	// 					return v;
	// 				}.bind(this), function(){});
	// 			}else{
	// 				this[mothed](v, fireChange)
	// 			}
	// 			return v;
	// 		}.bind(this), function(){});
	//
	// 		this.moduleValueAG = p;
	// 		if (this.moduleValueAG) this.moduleValueAG.then(function(){
	// 			this.moduleValueAG = null;
	// 		}.bind(this), function(){
	// 			this.moduleValueAG = null;
	// 		}.bind(this));
	// 	}else{
	// 		this[mothed](value, fireChange);
	// 	}
	// },

	__setValue: function(value){
		this._setBusinessData(value);
		this.node.value = value;
		this.fieldModuleLoaded = true;
		this.moduleValueAG = null;
	},

	_getSelectedOption: function(){
		var ops = this.node.getElements("oo-option");
		for( var i=0; i<ops.length; i++ ){
			if( ops[i].selected )return ops[i];
		}
		return null;
	},
	_getInputTextData: function(){
		return {"value": this.node.value , "text": this.node.text};
	},
	getText: function(){
		return this.node.text;
	},
    getInputData: function(){
		return this.node.value;
	},
    resetData: function(){
        this.setData(this.getValue());
    },

	setData: function(data, fireChange){
		return this._setValue(data, "__setData", fireChange);
	},

	__setData: function(data, fireChange){
		var old = this.getInputData();
		this.moduleValueAG = null;
		this._setBusinessData(data);
		this.node.set('value', data || '');
		this.fieldModuleLoaded = true;
		if (fireChange && old!==data) this.fireEvent("change");
		return value;
	},

	notValidationMode: function (text) {
		this.validationText = text;
		this.node.checkValidity();
	},
	validationMode: function () {
		this.validationText = '';
		this.node.unInvalidStyle();
	}
});

MWF.xDesktop.requireApp('process.Xform', '$Input', null, false);
MWF.xApplication.process.Xform.OOTextarea = MWF.APPOOTextarea = new Class({
    Implements: [Events],
    Extends: MWF.APP$Input,
    iconStyle: 'textFieldIcon',
    options: {
        "moduleEvents": ["load", "queryLoad", "postLoad"]
    },
    _loadNode: function () {
        // if (this.isReadonly() || this.json.showMode==="read"){
        //     this._loadNodeRead();
        // }else{
            if (!this.isReadable && !!this.isHideUnreadable){
                this.node.setStyle('display', 'none');
            }else{
                this._loadNodeEdit();
            }
        // }
    },
    loadDescription: function () {
        this.node.setAttribute('placeholder', this.json.description || '');
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadNodeEdit: function () {
        this.node.set({
            'id': this.json.id,
            'MWFType': this.json.type,
            'validity-blur': 'true',
            // "label-style": "width:6.2vw; min-width:5em; max-width:9em"
        });
        if (o2.isMediaMobile() && !this.json.inDatatable){
			this.node.setAttribute("skin-mode", 'mobile');
		}else{
            this.node.removeAttribute("skin-mode");
        }

        if (this.json.properties) {
            this.node.set(this.json.properties);
        }
        if (this.json.styles) {
            this.node.setStyles(this.json.styles);
        }

        if (this.json.label) {
            this.node.setAttribute('label', this.json.label);
        }

        if (this.json.showIcon != 'no' && !this.form.json.hideModuleIcon) {
            this.node.setAttribute('right-icon', 'edit');
        } else if (this.form.json.nodeStyleWithhideModuleIcon) {
            this.node.setAttribute('right-icon', '');
        }
        if (this.json.inDatatable){
            this.node.setAttribute('view-style', '');
        }

        this.node.setAttribute('readonly', false);
        this.node.setAttribute('readmode', false);
        this.node.setAttribute('disabled', false);

        if (!this.isReadonly() && this.isEditable){
            if (this.json.showMode === 'readonlyMode') {
                this.node.setAttribute('readonly', true);
            } else if (this.json.showMode === 'disabled') {
                this.node.setAttribute('disabled', true);
            } else if (this.json.showMode === 'read') {
                this.node.setAttribute('readmode', true);
                if (this.json.readModeEvents!=='yes'){
                    this.node.setStyle('pointer-events', 'none');
                }
            } else {
            }
        }else{
            this.node.setAttribute('readmode', true);
            if (this.json.readModeEvents!=='yes'){
                this.node.setStyle('pointer-events', 'none');
            }
        }

        if (this.json.required){
            this.node.setAttribute("required", true);
            if (!this.json.validationConfig) this.json.validationConfig = [];
            var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
            this.json.validationConfig.push({
                status : "all",
                decision : "",
                valueType : "value",
                operateor : "isnull",
                value : "",
                prompt : MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
            });
        }else{
            this.node.removeAttribute("required");
        }

        if (this.json.showMode){
            this.node.setAttribute("type", this.json.dataType);
        }

        if (this.json.autoSize==="no"){
            this.node.setAttribute("auto-size", false);
        }else{
            this.node.setAttribute("auto-size", true);
        }

        this.node.addEvent('change', function () {
            var v = this.getInputData('change');
            this.validationMode();
            this.validation()
            this._setBusinessData(v);
            this.fireEvent('change');
        }.bind(this));

        var inputNode = this.node;
        if (inputNode) inputNode.addEvent('input', function (e) {
            var v = e.target.get('value');
            this._setBusinessData(v);
        }.bind(this));

        this.node.addEvent('blur', function () {
            this.validation();
        }.bind(this));
        this.node.addEvent('keyup', function () {
            this.validationMode();
        }.bind(this));

        this.node.addEventListener('validity', (e) => {
            if (this.validationText) {
                e.target.setCustomValidity(this.validationText);
            }
        });

        this.node.addEventListener('invalid', (e)=>{
            if (this.node._props.validity){
                e.target.setCustomValidity(this.node._props.validity);
            }else{
                var label = this.json.label ? `“${this.json.label.replace(/　/g, '')}”` :  MWF.xApplication.process.Xform.LP.requiredHintField;
                const o = {
                    valueMissing: MWF.xApplication.process.Xform.LP.requiredHint.replace('{label}', label),
                }
                //通过 e.detail 获取 验证有效性状态对象：ValidityState
                for (const k in o){
                    if (e.detail[k]){
                        if (o[k]){
                            
                            break;
                        }
                    }
                }
            }
        });
    },
    createModelNode: function () {
        this.modelNode = new Element('div', {'styles': this.form.css.modelNode}).inject(this.node, 'after');
        new Element('div', {
            'styles': this.form.css.modelNodeTitle,
            'text': MWF.xApplication.process.Xform.LP.ANNInput
        }).inject(this.modelNode);
        new Element('div', {
            'styles': this.form.css.modelNodeContent,
            'text': MWF.xApplication.process.Xform.LP.ANNInput
        }).inject(this.modelNode);
    },
    __setData: function(data, fireChange){
        var old = this.getInputData();
        this._setBusinessData(data);
        this.node.value = data;
        this.fieldModuleLoaded = true;
        if (fireChange && old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },
    __setValue: function (value) {
        this.moduleValueAG = null;
        this._setBusinessData(value);
        this.node.set('value', value || '');
        this.fieldModuleLoaded = true;
        return value;
    },

    getInputData: function () {
        return this.node.value;
    },

    notValidationMode: function (text) {
        this.validationText = text;
        this.node.checkValidity();
    },
    validationMode: function () {
        this.validationText = '';
        this.node.unInvalidStyle();
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
MWF.xDesktop.requireApp("process.Work", "lp." + o2.language, null, false);
/** @class Opinion 意见输入框。
 * @o2cn 意见输入框
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Opinion = MWF.APPOpinion = new Class(
    /** @lends MWF.xApplication.process.Xform.Opinion# */
    {
        Implements: [Events],
        Extends: MWF.APP$Input,

        _loadUserInterface: function () {

            this._loadNode();
            if (this.json.compute == "show") {
                this._setValue(this._computeValue());
            } else {
                this._loadValue();
            }
        },
        _loadNode: function () {
            if (!this.isReadable && !!this.isHideUnreadable){
                this.node.setStyle('display', 'none');
            }else{
                if (this.readonly) {
                    this._loadNodeRead();
                } else {
                    this._loadNodeEdit();
                }
            }
        },
        _loadNodeRead: function () {
            this.node.empty();
            this.node.set({
                "nodeId": this.json.id,
                "MWFType": this.json.type
            });
            this.node.setStyle("display", "none");
        },
        validationConfigItem: function (routeName, data) {
            var flag = (data.status === "all") ? true : (routeName === data.decision);
            if (flag) {
                var n = this.getInputData();
                var v = (data.valueType === "value") ? n : n.length;
                switch (data.operateor) {
                    case "isnull":
                        if (!v && !(this.handwritingFile && this.handwritingFile[layout.session.user.distinguishedName])) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notnull":
                        if (v) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "gt":
                        if (v > data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "lt":
                        if (v < data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "equal":
                        if (v == data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "neq":
                        if (v != data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "contain":
                        if (v.indexOf(data.value) != -1) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notcontain":
                        if (v.indexOf(data.value) == -1) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                }
            }
            return true;
        },
        _resetNodeEdit: function () {
            var input = new Element("textarea", {
                "styles": {
                    "background": "transparent",
                    "width": "100%",
                    "border": "0px"
                }
            });
            input.set(this.json.properties);
            this.textarea = input;

            var node = new Element("div", {
                "styles": {
                    "ovwrflow": "hidden",
                    "position": "relative",
                    "padding-right": "2px"
                }
            }).inject(this.node, "after");
            input.inject(node);
            this.node.destroy();
            this.node = node;
        },
        _loadNodeEdit: function () {
            if (!this.json.preprocessing) {
                this._resetNodeEdit();
            }else{
                this.textarea = this.node.getElement("textarea");
            }
            var input = this.node.getFirst();
            if( !input && this.nodeHtml ){
                this.node.set("html", this.nodeHtml);
                input = this.node.getFirst();
            }
            input.set(this.json.properties);

            //this.node = input;
            this.node.set({
                "id": this.json.id,
                "MWFType": this.json.type
            });
            this.input = input;

            if( this.json.isSelectIdea === "yes" ){
                this.selectIdeaNode = new Element("div", {"styles": this.form.css.selectIdeaNode}).inject(this.node);
                this.underLineNode = new Element("div", {"styles": {
                        "border-top": "1px solid #ccc",
                        "clear": "both"
                 }}).inject(this.node);
                this.loadSelectIdea()
            }

            this.mediaActionArea = new Element("div", {"styles": this.form.css.inputOpinionMediaActionArea}).inject(this.node);

            if (this.json.isHandwriting !== "no") {
                /**
                 * @summary 手写意见按钮按钮。
                 * @member {Element}
                 */
                this.handwritingAction = new Element("div", {
                    "styles": this.form.css.inputOpinionHandwritingAction,
                    "text": MWF.xApplication.process.Work.LP.handwriting
                }).inject(this.mediaActionArea);
                this.handwritingAction.addEvent("click", function () {
                    this.handwriting();
                }.bind(this));
            }

            if (this.json.isAudio === "yes") {
                if (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia) {
                    /**
                     * @summary 音频按钮.在浏览器支持HTML5的getUserMedia才可用。
                     * @member {Element}
                     */
                    this.audioRecordAction = new Element("div", {
                        "styles": this.form.css.inputOpinionAudioRecordAction,
                        "text": MWF.xApplication.process.Work.LP.audioRecord
                    }).inject(this.mediaActionArea);
                    this.audioRecordAction.addEvent("click", function () {
                        this.audioRecord();
                    }.bind(this));
                }
            }

            this.node.addEvent("change", function () {
                this._setBusinessData(this.getInputData());
                this.fireEvent("change");
            }.bind(this));

            this.node.getFirst().addEvent("blur", function () {
                this.validation();
                this.hideSelectOpinionNode();
            }.bind(this));
            this.node.getFirst().addEvent("keyup", function () {
                this.validationMode();
            }.bind(this));

            this.node.getFirst().addEvent("keydown", function (e) {
                if (this.selectOpinionNode && (this.selectOpinionNode.getStyle("display") != "none") && this.selectOpinionNode.getFirst()) {
                    if (e.code == 38) { //up
                        if (this.selectedOpinionNode) {
                            var node = this.selectedOpinionNode.getPrevious();
                            if (!node) node = this.selectOpinionNode.getLast();
                            this.unselectedOpinion(this.selectedOpinionNode);
                            this.selectedOpinion(node)
                        } else {
                            node = this.selectOpinionNode.getLast();
                            this.selectedOpinion(node)
                        }
                    }
                    if (e.code == 40) { //down
                        if (this.selectedOpinionNode) {
                            var node = this.selectedOpinionNode.getNext();
                            if (!node) node = this.selectOpinionNode.getFirst();
                            this.unselectedOpinion(this.selectedOpinionNode);
                            this.selectedOpinion(node)
                        } else {
                            node = this.selectOpinionNode.getFirst();
                            this.selectedOpinion(node)
                        }
                    }
                    if (e.code == 27) {  //esc
                        this.hideSelectOpinionNode();
                        e.preventDefault();
                    }
                    if (e.code == 32 || e.code == 13) {  //space
                        if (this.selectedOpinionNode) {
                            this.setOpinion(this.selectedOpinionNode.get("text"));
                            e.preventDefault();
                        }
                    }
                }
            }.bind(this));

            if (!this.form.json.notLoadUserOpinion) {
                MWF.UD.getDataJson("userOpinion", function (json) {
                    this.userOpinions = json;
                }.bind(this), false);
            }
            this.node.getFirst().addEvent("input", function (e) {
                this.startSearchOpinion();
            }.bind(this));
            this.node.getFirst().addEvent("focus", function () {
                this.startSearchOpinion();
            }.bind(this));
        },
        _afterLoaded: function(){
            if (!this.isReadonly()){
                this.setNodeSize();
                this.loadDescription();
            }
        },
        setNodeSize: function(){
            if( this.textarea ){
                var x = 0;
                if( this.selectIdeaNode ){
                    var size = this.selectIdeaNode.getSize();
                    x = size.x + 5;
                    this.textarea.setStyles({
                        "height": ( size.y - 6 ) + "px",
                        "resize":"none",
                        "border-bottom": "0px",
                        "padding-right": "0px",
                        "width": "calc( 100% - "+ x +"px )"
                    });
                    this.node.setStyles({
                        "min-height": size.y + "px",
                        "height": "auto",
                        "overflow":"hidden",
                        "width": "100%"
                    });
                    this.mediaActionArea.setStyle("right", x+"px");
                }
            }
        },
        loadSelectIdea: function(){
            this.selectIdeaScrollNode = new Element("div", {"styles": this.form.css.selectIdeaScrollNode}).inject(this.selectIdeaNode);
            this.selectIdeaAreaNode = new Element("div", {
                "styles": {
                    "overflow": "hidden"
                }
            }).inject(this.selectIdeaScrollNode);
            MWF.require("MWF.widget.ScrollBar", function () {
                new MWF.widget.ScrollBar(this.selectIdeaScrollNode, {
                    "style": "small",
                    "where": "before",
                    "distance": 30,
                    "friction": 4,
                    "indent": false,
                    "axis": {"x": false, "y": true}
                });
            }.bind(this));
            MWF.UD.getDataJson("idea", function (json) {
                if (json) {
                    if (json.ideas) {
                        this.setIdeaList(json.ideas);
                    }
                } else {
                    MWF.UD.getPublicData("idea", function (pjson) {
                        if (pjson) {
                            if (pjson.ideas) {
                                this.setIdeaList(pjson.ideas);
                            }
                        }
                    }.bind(this));
                }
            }.bind(this));
        },
        setIdeaList: function (ideas) {
            var _self = this;
            ideas.each(function (idea) {
                if (!idea) return;
                new Element("div", {
                    "styles": this.form.css.selectIdeaItemNode,
                    "text": idea,
                    "events": {
                        "click": function () {
                            if(_self.descriptionNode)_self.descriptionNode.setStyle("display", "none");
                            if ( !_self.textarea.get("value") ) {
                                _self.textarea.set("value", this.get("text"));
                            } else {
                                _self.textarea.set("value", _self.textarea.get("value") + ", " + this.get("text"));
                            }
                        },
                        "mouseover": function () {
                            this.setStyles(_self.form.css.selectIdeaItemNode_over);
                        },
                        "mouseout": function () {
                            this.setStyles(_self.form.css.selectIdeaItemNode);
                        }
                    }
                }).inject(this.selectIdeaAreaNode);
            }.bind(this));
        },

        audioRecord: function () {
            if (!this.audioRecordNode) this.createAudioRecordNode();
            this.audioRecordNode.show();
            this.audioRecordNode.position({
                "relativeTo": this.node,
                "position": "center",
                "edge": "center"
            });
            var p = this.audioRecordNode.getPosition(this.form.app.content);
            var top = p.y;
            var left = p.x;
            if (p.y < 0) top = 10;
            if (p.x < 0) left = 10;
            this.audioRecordNode.setStyles({
                "top": "" + top + "px",
                "left": "" + left + "px"
            });

            this.soundFile = {};
            MWF.require("MWF.widget.AudioRecorder", function () {
                /**
                 * @summary 音频意见组件.
                 * @member {o2.widget.AudioRecorder}
                 */
                this.audioRecorder = new MWF.widget.AudioRecorder(this.audioRecordNode, {
                    "onSave": function (audioFile) {
                        this.soundFile[layout.session.user.distinguishedName] = audioFile;
                        if (this.previewNode) {
                            this.previewNode.destroy();
                            this.previewNode = null;
                        }
                        this.previewNode = new Element("audio", {
                            "controls": true,
                            "src": window.URL.createObjectURL(audioFile)
                        }).inject(this.node);
                        this.audioRecordNode.hide();
                        // this.page.get("div_image").node.set("src",base64Image);
                    }.bind(this),
                    "onCancel": function () {
                        this.soundFile[layout.session.user.distinguishedName] = null;
                        delete this.soundFile[layout.session.user.distinguishedName];
                        if (this.previewNode) {
                            this.previewNode.destroy();
                            this.previewNode = null;
                        }
                        this.audioRecordNode.hide();
                    }.bind(this)
                }, null);
            }.bind(this));
        },
        createAudioRecordNode: function () {
            this.audioRecordNode = new Element("div", {"styles": this.form.css.handwritingNode}).inject(this.node, "after");
            var size = this.node.getSize();
            var y = Math.max(size.y, 320);
            var x = Math.max(size.x, 400);
            x = Math.min(x, 600);
            y = 320;
            x = 500;
            var zidx = this.node.getStyle("z-index").toInt() || 0;
            zidx = (zidx < 1000) ? 1000 : zidx;
            this.audioRecordNode.setStyles({
                "height": "" + y + "px",
                "width": "" + x + "px",
                "z-index": zidx + 1
            });
            // this.audioRecordNode.position({
            //     "relativeTo": this.node,
            //     "position": "center",
            //     "edge": "center"
            // });
        },
        /**
         * @summary 弹出手写板.
         * @example
         * this.form.get("fieldId").handwriting();
         */
        handwriting: function () {
            if (!this.handwritingNode) this.createHandwriting();
            this.handwritingNode.show();
            if (layout.mobile) {
                this.handwritingNode.setStyles({
                    "top": "0px",
                    "left": "0px"
                });

            } else {
                this.handwritingNode.position({
                    "relativeTo": this.form.app.content || this.form.container,
                    "position": "center",
                    "edge": "center"
                });
                //var p = this.handwritingNode.getPosition(this.form.app.content);
                var p = this.handwritingNode.getPosition(this.handwritingNode.getOffsetParent());
                var top = p.y;
                var left = p.x;
                if (p.y < 0) top = 10;
                if (p.x < 0) left = 10;
                this.handwritingNode.setStyles({
                    "top": "" + top + "px",
                    "left": "" + left + "px"
                });
            }
        },
        createHandwriting: function () {
            /**
             * @summary 手写板容器.
             * @member {Element}
             */
            this.handwritingNode = new Element("div", {"styles": this.form.css.handwritingNode}).inject(this.node, "after");
            var x, y;
            if (layout.mobile) {
                var bodySize = $(document.body).getSize();
                x = bodySize.x;
                y = bodySize.y;
                this.json.tabletWidth = 0;
                this.json.tabletHeight = 0;
            } else {
                var size = this.node.getSize();
                x = Math.max(this.json.tabletWidth || size.x, 600);
                this.json.tabletWidth = x;
                y = Math.max(this.json.tabletHeight ? (parseInt(this.json.tabletHeight) + 110) : size.y, 320);
            }

            var zidx = this.node.getStyle("z-index").toInt() || 0;
            zidx = (zidx < 1000) ? 1000 : zidx;
            this.handwritingNode.setStyles({
                "height": "" + y + "px",
                "width": "" + x + "px",
                "z-index": zidx + 1
            });
            if (layout.mobile) {
                this.handwritingNode.addEvent('touchmove', function (e) {
                    e.preventDefault();
                });
                this.handwritingNode.setStyles({
                    "top": "0px",
                    "left": "0px"
                }).inject($(document.body));
            } else {
                this.handwritingNode.position({
                    "relativeTo": this.node,
                    "position": "center",
                    "edge": "center"
                });
            }
            this.handwritingAreaNode = new Element("div", {"styles": this.form.css.handwritingAreaNode}).inject(this.handwritingNode);
            if (!layout.mobile) {
                this.handwritingActionNode = new Element("div", {
                    "styles": this.form.css.handwritingActionNode,
                    "text": MWF.xApplication.process.Work.LP.saveWrite
                }).inject(this.handwritingNode);
                var h = this.handwritingActionNode.getSize().y + this.handwritingActionNode.getStyle("margin-top").toInt() + this.handwritingActionNode.getStyle("margin-bottom").toInt();
                h = y - h;
                this.handwritingAreaNode.setStyle("height", "" + h + "px");
            } else {
                this.handwritingAreaNode.setStyle("height", "" + y + "px");
            }
            this.handwritingFile = {};
            MWF.require("MWF.widget.Tablet", function () {
                /**
                 * @summary 手写板组件.
                 * @member {o2.widget.Tablet}
                 */
                this.tablet = new MWF.widget.Tablet(this.handwritingAreaNode, {
                    "style": "default",
                    "toolHidden": this.json.toolHidden || [],
                    "contentWidth": this.json.tabletWidth || 0,
                    "contentHeight": this.json.tabletHeight || 0,
                    "onSave": function (base64code, base64Image, imageFile) {
                        this.handwritingFile[layout.session.user.distinguishedName] = imageFile;
                        if (this.previewNode) {
                            this.previewNode.destroy();
                            this.previewNode = null;
                        }
                        if (this.json.isHandwritingPreview !== "no") {
                            this.previewNode = new Element("img", {"src": base64Image}).inject(this.node);
                            this.previewNode.setStyles({
                                "max-width": "90%"
                            })
                        }
                        this.handwritingNode.hide();

                        this.validation();
                        this.fireEvent("change");
                        // this.page.get("div_image").node.set("src",base64Image);
                    }.bind(this),
                    "onCancel": function () {
                        this.handwritingFile[layout.session.user.distinguishedName] = null;
                        delete this.handwritingFile[layout.session.user.distinguishedName];
                        if (this.previewNode) {
                            this.previewNode.destroy();
                            this.previewNode = null;
                        }
                        this.handwritingNode.hide();
                    }.bind(this)
                }, null);
                this.tablet.load();
            }.bind(this));
            if (layout.mobile) {
                opt.tools = [
                    "save", "|",
                    "undo",
                    "redo", "|",
                    "reset", "|",
                    "cancel"
                ]
            }
            if (this.handwritingActionNode) {
                this.handwritingActionNode.addEvent("click", function () {
                    //this.handwritingNode.hide();
                    if (this.tablet) this.tablet.save();
                }.bind(this));
            }
        },

        unselectedOpinion: function (node) {
            node.setStyle("background-color", "#ffffff");
            this.selectedOpinionNode = null;
        },
        selectedOpinion: function (node) {
            node.setStyle("background-color", "#d2ddf5");
            this.selectedOpinionNode = node;
        },
        startSearchOpinion: function () {
            var t = this.input.get("value");
            var arr = t.split(/(,\s*){1}|(;\s*){1}|\s+/g);
            t = arr[arr.length - 1];
            if (t.length) {
                this.clearSearcheOpinionId();
                this.searcheOpinionId = window.setTimeout(function () {
                    this.searchOpinions(t);
                }.bind(this), 500);
            } else {
                this.clearSearcheOpinionId();
            }
        },
        clearSearcheOpinionId: function () {
            if (this.searcheOpinionId) {
                window.clearTimeout(this.searcheOpinionId);
                this.searcheOpinionId = "";
            }
        },
        searchOpinions: function (t) {
            var value = this.input.get("value");
            var arr = value.split(/[\n\r]/g);
            lines = arr.length;
            value = arr[arr.length - 1];
            var offsetValue = value;
            //var offsetValue = value.substr(0, value.length-t.length);

            if (this.userOpinions) {
                var ops = this.userOpinions.filter(function (v, i) {
                    return v.contains(t) && (v != t);
                }.bind(this));
                if (ops.length) {
                    this.showSelectOpinionNode(ops, offsetValue, lines);
                } else {
                    this.hideSelectOpinionNode(ops);
                }
            }
        },
        hideSelectOpinionNode: function () {
            if (this.selectOpinionNode) this.selectOpinionNode.setStyle("display", "none");
        },
        showSelectOpinionNode: function (ops, offsetValue, lines) {
            if (!this.selectOpinionNode) this.createSelectOpinionNode();
            this.selectOpinionNode.empty();
            ops.each(function (op) {
                this.createSelectOpinionOption(op);
            }.bind(this));

            var inputSize = this.input.getSize();
            var size = MWF.getTextSize(offsetValue, this.json.inputStyles);
            var offY = ((size.y - 3) * lines) + 3;
            if (offY > inputSize.y) offY = inputSize.y;

            this.selectOpinionNode.setStyle("display", "block");
            this.selectOpinionNode.position({
                "relativeTo": this.node,
                "position": "leftTop",
                "edge": "leftTop",
                "offset": {"x": size.x, "y": offY}
            });
        },
        createSelectOpinionNode: function () {
            this.selectOpinionNode = new Element("div", {"styles": this.form.css.opinionSelectNode}).inject(this.node);
        },
        createSelectOpinionOption: function (op) {
            var option = new Element("div", {
                "styles": this.form.css.opinionSelectOption,
                "text": op
            }).inject(this.selectOpinionNode);
            if (this.json.selectItemStyles) option.setStyles(this.json.selectItemStyles);
            option.addEvents({
                "mouseover": function () {
                    this.setStyle("background-color", "#d2ddf5")
                },
                "mouseout": function () {
                    this.setStyle("background-color", "#ffffff")
                },
                "mousedown": function () {
                    this.setOpinion(op)
                }.bind(this)
            });
        },
        setOpinion: function (op) {
            var v = this.input.get("value");
            var arr = v.split(/(,\s*){1}|(;\s*){1}|\s+/g);
            t = arr[arr.length - 1];
            var leftStr = v.substr(0, v.length - t.length);
            this.input.set("value", leftStr + op);
            this.hideSelectOpinionNode();
            this._setBusinessData(this.getInputData());
        },

        loadDescription: function () {
            if (this.isReadonly()) return;
            var v = this._getBusinessData();
            if (!v) {
                if (this.json.description) {
                    var size = this.node.getFirst().getSize();
                    var w = size.x - 3
                    if (this.json.showIcon != 'no' && !this.form.json.hideModuleIcon) {
                        w = size.x - 23;
                    }
                    if( this.handwritingAction ){
                        w = w - this.handwritingAction.getSize().x
                    }
                    if( this.audioRecordAction ){
                        w = w - this.audioRecordAction.getSize().x
                    }
                    this.descriptionNode = new Element("div", {
                        "styles": this.form.css.descriptionNode,
                        "text": this.json.description
                    }).inject(this.node);
                    this.descriptionNode.setStyles({
                        "width": "" + w + "px",
                        "height": "" + size.y + "px",
                        "line-height": "" + size.y + "px"
                    });
                    this.setDescriptionEvent();
                }
            }
        },
        setDescriptionEvent: function () {
            if (this.descriptionNode) {
                if (COMMON.Browser.Platform.name === "ios") {
                    this.descriptionNode.addEvents({
                        "click": function () {
                            this.descriptionNode.setStyle("display", "none");
                            this.node.getFirst().focus();
                        }.bind(this)
                    });
                } else if (COMMON.Browser.Platform.name === "android") {
                    this.descriptionNode.addEvents({
                        "click": function () {
                            this.descriptionNode.setStyle("display", "none");
                            this.node.getFirst().focus();
                        }.bind(this)
                    });
                } else {
                    this.descriptionNode.addEvents({
                        "click": function () {
                            this.descriptionNode.setStyle("display", "none");
                            this.node.getFirst().focus();
                        }.bind(this)
                    });
                }
                this.node.getFirst().addEvents({
                    "focus": function () {
                        this.descriptionNode.setStyle("display", "none");
                    }.bind(this),
                    "blur": function () {
                        if (!this.node.getFirst().get("value")) this.descriptionNode.setStyle("display", "block");
                    }.bind(this)
                });
            }
        }

    });

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
MWF.xDesktop.requireApp("Selector", "package", null, false);
MWF.require("MWF.widget.O2Identity", null, false);
/** @class Org 人员组织组件。
 * @o2cn 人员组织组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData(value); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Org = MWF.APPOrg =  new Class(
    /** @lends MWF.xApplication.process.Xform.Org# */
    {
    Implements: [Events],
    Extends: MWF.APP$Input,
    options: {
        /**
         * 组件加载前触发。当前组件的queryLoad事件还没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取当前组件。
         * @event MWF.xApplication.process.Xform.Org#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载时触发.
         * @event MWF.xApplication.process.Xform.Org#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.Org#postLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 当组件值改变时触发。
         * @event MWF.xApplication.process.Xform.Org#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 当组件不允许输入（使用人员选择框）时，完成选择人员，并且给组件赋值后执行。
         * @event MWF.xApplication.process.Xform.Org#select
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "change", "select", "removeItem"],
        /**
         * 人员选择框事件：加载前执行。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadSelector
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载后执行，由于选择项为异步加载，此时选择项并未加载完成。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadSelector
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载选择框容器节点前执行。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载选择框容器节点后执行。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadContent
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */

        /**
         * 人员选择框事件：加载分类前执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：选择分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#selectCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：取消选择分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#unselectCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：展开分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#expand
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：折叠分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#collapse
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */

        /**
         * 人员选择框事件：加载选择项前执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载选择项后执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：选择选择项后执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#selectItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：取消选择选择项后执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#unselectItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：在人员选择框点取消时执行。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#close
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "selectorEvents" : ["queryLoadSelector","postLoadSelector","queryLoadContent","postLoadContent","queryLoadCategory","postLoadCategory",
            "selectCategory", "unselectCategory","queryLoadItem","postLoadItem","selectItem", "unselectItem","change","expand","collapse","cancel"],
        "readonly": true
    },

    iconStyle: "orgIcon",
    isReadonly : function(){
        var readonly = !!(!this.isEditable || this.readonly || this.form.json.isReadonly);
        if( readonly )return readonly;
        if( this.json.isReadonly === "script" ){
            if( this.json.readonlyScript && this.json.readonlyScript.code ){
                readonly = this.form.Macro.exec(this.json.readonlyScript.code, this);
            }
        }else{
            readonly = !!this.json.isReadonly
        }
        return readonly || !!this.isSectionMergeRead();
    },
    getTextData: function(){
        //var value = this.node.get("value");
        //var text = this.node.get("text");
        var value = this.getValue();
        //var text = (this.node.getFirst()) ? this.node.getFirst().get("text") : this.node.get("text");
        var text = [];
        if( typeOf( value ) === "object" )value = [value];
        if( typeOf( value ) === "array" ){
            value.each(function(v){
                if( typeOf(v) === "string" ){
                    text.push(v);
                }else{
                    text.push(v.name+((v.unitName) ? "("+v.unitName+")" : ""));
                }
            }.bind(this));
            return {"value": value || "", "text": [text.join(",")]};
        }else{
            return {"value": [""], "text": [""]};
        }
    },

    loadDescription: function(){
        if (this.isReadonly())return;
        if(this.descriptionNode)return;
        var v = this._getBusinessData();
        if (!v || !v.length){
            if (this.json.description){
                var size, w;
                if( this.node.offsetParent === null ){ //隐藏
                    size = { y: 26 }
                }else{
                    size = this.node.getFirst().getSize();
                    // w = size.x-3;
                    // if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ) {
                    //     if (COMMON.Browser.safari) w = w - 20;
                    // }
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.descriptionNode.setStyles({
                    "width": "auto",
                    "overflow": "auto"
                });
                // if( w )this.descriptionNode.setStyles({
                //     "width": ""+w+"px"
                // });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function( ev ){
                    this.descriptionNode.setStyle("display", "none");
                    if( this.json.isInput ){
                        if( this.combox ){
                            if (!this.combox.editItem) this.combox.intoEdit(ev);
                            window.setTimeout( function () {
                                this.combox.input.node.focus();
                            }.bind(this), 300)
                        }
                    }else{
                        this.clickSelect( ev );
                    }
                }.bind(this)
            });
        }
    },
    _loadNode: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            this.field = true;
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                this._getOrgOptions();
                if (this.json.isInput){
                    this._loadNodeInputEdit();
                }else{
                    this._loadNodeEdit();
                }

            }
        }
    },
    _loadMergeReadContentNode: function(contentNode, data){
        this.loadOrgWidget(data.data, contentNode);
    },
    _loadMergeEditNodeByDefault: function(){
        var data = this.getSortedSectionData();
        var businessData = [];
        data.each(function(d){
            businessData = businessData.concat( d.data || [] );
        });
        this._setBusinessData( businessData );
        this._loadNode();
    },
    _getOrgOptions: function(){
        this.selectTypeList = typeOf( this.json.selectType ) == "array" ? this.json.selectType : [this.json.selectType];
        if( this.selectTypeList.contains( "identity" ) ) {
            this.identityOptions = new MWF.APPOrg.IdentityOptions(this.form, this.json);
        }
        if( this.selectTypeList.contains( "unit" ) ) {
            this.unitOptions = new MWF.APPOrg.UnitOptions(this.form, this.json);
        }
        if( this.selectTypeList.contains( "group" ) ){
            this.groupOptions = new MWF.APPOrg.GroupOptions( this.form, this.json );
        }

        //this.selectUnits = this.getSelectRange();
        //if (this.json.selectType=="identity"){
        //    this.selectDutys = this.getSelectRangeDuty();
        //}
    },

    _valueMerge: function(values, v){
        if (o2.typeOf(v)=="function"){
            return v.then(function(re){
                this._valueMerge(values, re)
            }.bind(this), function(){});
        }else{
            return values.concat(v);
        }
    },
    _computeValue: function(){

        var simple = this.json.storeRange === "simple";
        var values = [];
        if (this.json.identityValue) {
            this.json.identityValue.each(function(v){
                if (v) values.push(MWF.org.parseOrgData(v, true, simple))
            });
        }
        if (this.json.unitValue) {
            this.json.unitValue.each(function(v){ if (v) values.push(MWF.org.parseOrgData(v, true, simple))});
        }
        if (this.json.dutyValue) {
            var dutys = JSON.decode(this.json.dutyValue);
            var par;
            if (dutys.length){
                dutys.each(function(duty){
                    if (duty.code) par = this.form.Macro.exec(duty.code, this);
                    if (par){
                        var pars = (o2.typeOf(par)=="array") ? par : [par];
                        var promise = Promise.all(pars).then(function(p){
                            var uName = p.distinguishedName || p;
                            if (o2.typeOf(p)=="array") uName = p[0].distinguishedName || p[0];
                            var code = "return this.org.getDuty(\""+duty.name+"\", \""+uName+"\", true)";
                            var r = (!!uName) ? this.form.Macro.exec(code, this) : "";

                            var m = (o2.typeOf(r)=="array") ? "all" : "resolve";
                            return Promise[m](r).then(function(d){
                                if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                                var arr = [];
                                d.each(function(dd){
                                    if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
                                });
                                return arr;
                            }.bind(this)).catch(function(){
                                console.log("catch error : can not get duty : " + duty.name, + "-" + uName);
                            });
                        }.bind(this), function(){});
                        values.push(promise);
                    }
                }.bind(this));
            }
        }
        if (this.json.defaultValue && this.json.defaultValue.code){
            var fd = this.form.Macro.exec(this.json.defaultValue.code, this);
            if (o2.typeOf(fd)=="array"){
                fd.each(function(v){values.push(v);});
            }else{
                if (fd) values.push(fd);
            }

            // if (fd && fd.isAG){
            //     values.push(fd);
            // }else{
            //     if (typeOf(fd)!=="array") fd = (fd) ? [fd] : [];
            //     fd.each(function(fdd){
            //         if (fdd){
            //             if (typeOf(fdd)==="string"){
            //                 var data;
            //                 this.getOrgAction()[this.getValueMethod(fdd)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), null, fdd, false);
            //                 values.push(data);
            //             }else{
            //                 values.push(fdd);
            //             }
            //         }
            //     }.bind(this));
            // }
        }
        // if (this.json.count>0){
        //     return values.slice(0, this.json.count);
        // }
        return values;
        //return (this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
    },
    __computeValue: function(){
        var simple = this.json.storeRange === "simple";
        var values = [];
        if (this.json.identityValue) {
            this.json.identityValue.each(function(v){
                if (v) values.push(MWF.org.parseOrgData(v, true, simple))
            });
        }
        if (this.json.unitValue) {
            this.json.unitValue.each(function(v){ if (v) values.push(MWF.org.parseOrgData(v, true, simple))});
        }
        if (this.json.dutyValue) {
            var dutys = JSON.decode(this.json.dutyValue);
            var par;
            if (dutys.length){
                dutys.each(function(duty){
                    if (duty.code) par = this.form.Macro.exec(duty.code, this);
                    if (par && par.isAG){
                        var ag = o2.AG.all(par).then(function(p){
                            var uName = "";
                            if (p && p.length) uName = p[0].distinguishedName || p[0];
                            var code = "return this.org.getDuty(\""+duty.name+"\", \""+uName+"\", true)";
                            var r = this.form.Macro.exec(code, this);

                            o2.AG.all(r).then(function(d) {
                                //var d = rd[0];
                                if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                                var arr = [];
                                d.each(function(dd){
                                    if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
                                });
                                return arr;
                            }.bind(this));
                        }.bind(this));
                        values.push(ag);
                    }else{
                        var code = "return this.org.getDuty(\""+duty.name+"\", \""+par+"\", true)";
                        var r = this.form.Macro.exec(code, this);
                        var ag = o2.AG.all(r).then(function(d) {
                            //var d = rd[0];
                            if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                            var arr = [];
                            d.each(function(dd){
                                if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
                            });
                            return arr;
                        }.bind(this));
                        values.push(ag);

                        // if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                        // d.each(function(dd){if (dd) values.push(MWF.org.parseOrgData(dd, true, simple));});
                    }

                }.bind(this));
            }
        }
        if (this.json.defaultValue && this.json.defaultValue.code){
            var fd = this.form.Macro.exec(this.json.defaultValue.code, this);

            if (fd && fd.isAG){
                // value.addResolve(function(v){
                //     this._setBusinessData(v);
                //     if (this.node.getFirst()) this.node.getFirst().set("value", v || "");
                //     if (this.readonly || this.json.isReadonly) this.node.set("text", v);
                // }.bind(this));
                values.push(fd);
                // fd.then(function(v){
                //     return this._valueMerge(values, v);
                // }.bind(this));
                // return fd;
            }else{
                if (typeOf(fd)!=="array") fd = (fd) ? [fd] : [];
                fd.each(function(fdd){
                    if (fdd){
                        if (typeOf(fdd)==="string"){
                            var data;
                            this.getOrgAction()[this.getValueMethod(fdd)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), null, fdd, false);
                            values.push(data);
                        }else{
                            values.push(fdd);
                        }
                    }
                }.bind(this));
            }
        }
        if (this.json.count>0){
            return values.slice(0, this.json.count);
        }
        return values;
        //return (this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
    },

    getOrgAction: function(){
        if (!this.orgAction) this.orgAction = MWF.Actions.get("x_organization_assemble_control");
        //if (!this.orgAction) this.orgAction = new MWF.xApplication.Selector.Actions.RestActions();
        return this.orgAction;
    },

    getOptions: function(){

        var _self = this;

        if( this.selectTypeList.length === 0 )return false;

        var values = this.getInputData() || [];

        var exclude = [];
        if( this.json.exclude ){
            var v = this.form.Macro.exec(this.json.exclude.code, this);
            exclude = typeOf(v)==="array" ? v : [v];
        }

        //var count = (this.json.count) ? this.json.count : 0;

        var identityOpt;
        if( this.identityOptions ){
            identityOpt = this.identityOptions.getOptions();
            if (this.json.identityRange!=="all"){
                if ( !identityOpt.noUnit && (!identityOpt.units || !identityOpt.units.length) ){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange, "error", this.node);
                    identityOpt.disabled = true;
                    // return false;
                }
            }
            if ( !identityOpt.noUnit && this.json.dutyRange && this.json.dutyRange!=="all"){
                if (!identityOpt.dutys || !identityOpt.dutys.length){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange, "error", this.node);
                    identityOpt.disabled = true;
                    // return false;
                }
            }
            identityOpt.values = (this.json.isInput) ? [] : values;
            identityOpt.exclude = exclude;
            if( this.form.json.selectorStyle )identityOpt = Object.merge( identityOpt, this.form.json.selectorStyle );
        }

        var unitOpt;
        if( this.unitOptions ){
            unitOpt = this.unitOptions.getOptions();
            if (this.json.unitRange!=="all"){
                if ( !unitOpt.units || !unitOpt.units.length){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange, "error", this.node);
                    unitOpt.disabled = true;
                    // return false;
                }
            }
            unitOpt.values = (this.json.isInput) ? [] : values;
            unitOpt.exclude = exclude;
            if( this.form.json.selectorStyle )unitOpt = Object.merge( unitOpt, this.form.json.selectorStyle );
        }

        var groupOpt;
        if( this.groupOptions ){
            groupOpt = this.groupOptions.getOptions();
            groupOpt.values = (this.json.isInput) ? [] : values;
            groupOpt.exclude = exclude;
            if( this.form.json.selectorStyle )groupOpt = Object.merge( groupOpt, this.form.json.selectorStyle );
        }

        //var selectUnits = this.getSelectRange();
        //if (this.json.selectType=="identity"){
        //    var selectDutys = this.getSelectRangeDuty();
        //}

        //if (this.json.range!=="all"){
        //    if (!selectUnits.length){
        //        this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
        //        return false;
        //    }
        //}
        //if (this.json.selectType=="identity"){
        //    if ((this.json.dutyRange) && this.json.dutyRange!=="all"){
        //        if (!selectDutys || !selectDutys.length){
        //            this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
        //            return false;
        //        }
        //    }
        //}

        var defaultOpt = {};

        if( this.json.events && typeOf(this.json.events) === "object" ){
            Object.each(this.json.events, function(e, key){
                if (e.code){
                    if (this.options.selectorEvents.indexOf(key)!==-1){
                        if( key === "postLoadSelector" ) {
                            this.addEvent("loadSelector", function (selector) {
                                return this.form.Macro.fire(e.code, selector);
                            }.bind(this))
                        }else if( key === "queryLoadSelector"){
                            defaultOpt["onQueryLoad"] = function(target){
                                return this.form.Macro.fire(e.code, target);
                            }.bind(this)
                        }else{
                            defaultOpt["on"+key.capitalize()] = function(target){
                                return this.form.Macro.fire(e.code, target);
                            }.bind(this)
                        }
                    }
                }
            }.bind(this));
        }

        if( this.selectTypeList.length === 1 ){
            return Object.merge( {
                "type": this.selectTypeList[0],
                "onComplete": function(items){
                    this.selectOnComplete(items);
                }.bind(this),
                "onCancel": this.selectOnCancel.bind(this),
                // "onLoad": this.selectOnLoad.bind(this),
                "onLoad": function(){
                    //this 为 selector
                    _self.selectOnLoad(this, this.selector );
                },
                "onClose": this.selectOnClose.bind(this)
            }, defaultOpt, identityOpt || unitOpt || groupOpt )
        }else if( this.selectTypeList.length > 1 ){
            var options = {
                "type" : "",
                "types" : this.selectTypeList,
                "onComplete": function(items){
                    this.selectOnComplete(items);
                }.bind(this),
                "onCancel": this.selectOnCancel.bind(this),
                // "onLoad": this.selectOnLoad.bind(this),
                "onLoad": function(){
                    //this 为 selector
                    _self.selectOnLoad(this)
                },
                "onClose": this.selectOnClose.bind(this)
            };
            if( this.form.json.selectorStyle ){
                options = Object.merge( options, this.form.json.selectorStyle );
            }
            if( identityOpt )options.identityOptions = Object.merge( {}, defaultOpt, identityOpt );
            if( unitOpt )options.unitOptions =  Object.merge( {}, defaultOpt, unitOpt );
            if( groupOpt )options.groupOptions = Object.merge( {}, defaultOpt, groupOpt );
            return options;
        }

        //return {
        //    "type": this.json.selectType,
        //    "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
        //    "values": (this.json.isInput) ? [] : values,
        //    "count": count,
        //    "units": selectUnits,
        //    "dutys": (this.json.selectType=="identity") ? selectDutys : [],
        //    "exclude" : exclude,
        //    "expandSubEnable" : (this.json.expandSubEnable=="no") ? false : true,
        //    "categoryType": this.json.categoryType || "unit",
        //    "onComplete": function(items){
        //        this.selectOnComplete(items);
        //    }.bind(this),
        //    "onCancel": this.selectOnCancel.bind(this),
        //    "onLoad": this.selectOnLoad.bind(this),
        //    "onClose": this.selectOnClose.bind(this)
        //};
    },
    selectOnComplete: function(items){
        var array = [];
        items.each(function(item){
            array.push(item.data);
        }.bind(this));

        var simple = this.json.storeRange === "simple";

        this.checkEmpower( array, function( data ){
            var values = [];

            data.each(function(d){
                values.push(MWF.org.parseOrgData(d, true, simple));
            }.bind(this));

            if (this.json.isInput){
                this.addData(values);
            }else{
                this.setData(values, true);
            }

            //this._setBusinessData(values);
            this.validationMode();
            this.validation();
            var p = this.getValue();
            if (p.then){
                p.then(function(){
                    this.fireEvent("select");
                }.bind(this), function(){});
            }else{
                this.fireEvent("select");
            }

        }.bind(this))
    },
    selectOnCancel: function(){
        this.validation();
    },
    selectOnLoad: function( selector ){
        if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
        this.fireEvent("loadSelector", [selector])
    },
    selectOnClose: function(){
        var v = this._getBusinessData();
        if (!v || !v.length) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
    },
    checkDescription: function(){
        if (!this.json.description)return;
        var v = this._getBusinessData();
        if (!v || !v.length){
            if( this.descriptionNode ){
                if( this.node.getFirst() ){
                    var size = this.node.getFirst().getSize();
                    var w = size.x-3;
                    if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ) {
                        if (COMMON.Browser.safari) w = w - 20;
                    }
                    this.descriptionNode.setStyles({
                        "display": "block",
                        "width": ""+w+"px",
                        "height": ""+( size.y || 26)+"px",
                        "line-height": ""+( size.y || 26)+"px"
                    });
                }else{
                    this.descriptionNode.setStyle("display", "block");
                }
            }else{
                this.loadDescription();
            }
        }else{
            if(this.descriptionNode)this.descriptionNode.setStyle("display", "none");
        }
    },

    /**
     * @summary 弹出选择界面.
     * @example
     * this.form.get('org').clickSelect();
     */
    clickSelect: function( ev ){
        if (this.isReadonly())return;
        if( layout.mobile ){
            setTimeout( function(){ //如果有输入法界面，这个时候页面的计算不对，所以等100毫秒
                var options = this.getOptions();
                if(options){
                    if( this.selector && this.selector.loading ) {
                    }else if( this.selector && this.selector.selector && this.selector.selector.active ){
                    }else{
                        /**
                         * @summary 人员选择框package的对象
                         * @member {o2.O2Selector}
                         * @example
                         *  //可以在脚本中获取该组件
                         * var selector = this.form.get("fieldId").selector.selector; //获取人员选择框对象
                         * var options = selector.options; //获取人员选择框的选项
                         */
                        this.selector = new MWF.O2Selector(this.form.app.content, options);
                    }
                }
            }.bind(this), 100 )
        }else{
            var options = this.getOptions();
            if(options){
                if( this.selector && this.selector.loading ) {
                }else if( this.selector && this.selector.selector && this.selector.selector.active ){
                }else {
                    this.selector = new MWF.O2Selector(this.form.app.content, options);
                }
            }
        }
    },
    resetData: function(){

        var v = this.getValue();
        //this.setData((v) ? v.join(", ") : "");
        this.setData(v);
    },
    isEmpty: function(){
        var data = this.getData();
        if( typeOf(data) !== "array" )return true;
        if( data.length === 0 )return true;
        return false;
    },

    getInputData: function(){
        if (this.json.isInput){
            if (this.combox)return this.combox.getData();
            //return this._getBusinessData();
            return this.node.retrieve("data");
        }else{
            //return this._getBusinessData();
            return this.node.retrieve("data");
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        var node = new Element("div").inject(this.node);
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        this.clearDefaultMargin();
    },
    _searchConfirmPerson: function(item){
        var inforNode = item.inforNode || new Element("div");

        var simple = this.json.storeRange === "simple";

        if (item.data){

            var data = item.data;
            if( this.selectTypeList.contains("identity") && this.json.identityResultType === "person"){
                var dn = data.distinguishedName || data;
                if( dn.substr( dn.length-1, 1).toLowerCase() === "i" ){
                    MWF.Actions.get("x_organization_assemble_express").listPersonWithIdentity({
                        identityList : [dn]
                    }, function(json){
                        if( json.data.length > 0 ){
                            if( data["person"] )json.data[0].id = data["person"];
                            item.data = MWF.org.parseOrgData( json.data[0], true, simple );
                            item.value = this.getDataText( item.data );
                            if(item.node)item.node.set("text", item.value);
                        }
                    }.bind(this), null, false)
                }
            }
            if( item.data && ( item.data.createTime || item.data.updateTime ) ){
                item.data = MWF.org.parseOrgData( item.data, true, simple );
            }

            var text = "";
            var flag = item.data.distinguishedName.substr(item.data.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = item.data.name+"("+item.data.unitName+")";
                    break;
                case "@p":
                    text = item.data.name+(item.data.employee ? "("+item.data.employee+")" : "");
                    break;
                case "@u":
                    text = item.data.levelName;
                    break;
                case "@g":
                    text = item.data.name;
                    break;
                default:
                    text = item.data.name;
            }
            inforNode.set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });
        }else{
            inforNode.set({
                "styles": {"font-size": "14px", "color": "#bd0000"},
                "text": MWF.xApplication.process.Xform.LP.noOrgObject
            });
        }
        if (!item.inforNode){
            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: item.node,
                transition: 'flyin'
            });
            item.inforNode = inforNode;
        }

    },
    getSearchOptions: function(){

        if( this.selectTypeList.length === 0 )return false;

        var identityOpt;
        if( this.identityOptions ){
            identityOpt = this.identityOptions.getSearchOptions();
            //if (this.json.identityRange!=="all"){
            //    if ( !identityOpt.units || !identityOpt.units.length){
            //        this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange, "error", this.node);
            //        return false;
            //    }
            //}
            //if ((this.json.dutyRange) && this.json.dutyRange!=="all"){
            //    if (!identityOpt.dutys || !identityOpt.dutys.length){
            //        this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange, "error", this.node);
            //        return false;
            //    }
            //}
        }

        var unitOpt;
        if( this.unitOptions ){
            unitOpt = this.unitOptions.getSearchOptions();
            //if (this.json.unitRange!=="all"){
            //    if ( !unitOpt.units || !unitOpt.units.length){
            //        this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange, "error", this.node);
            //        return false;
            //    }
            //}
        }

        var groupOpt;
        if( this.groupOptions ){
            groupOpt = this.groupOptions.getOptions();
        }

        if( this.selectTypeList.length === 1 ){
            return Object.merge( {
                "type": this.selectTypeList[0]
            }, identityOpt || unitOpt || groupOpt )
        }else if( this.selectTypeList.length > 1 ){
            var options = {
                "type" : "",
                "types" : this.selectTypeList
            };
            if( identityOpt )options.identityOptions = identityOpt;
            if( unitOpt )options.unitOptions = unitOpt;
            if( groupOpt )options.groupOptions = groupOpt;
            return options;
        }

        //return {
        //    "type": this.json.selectType,
        //    "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
        //    "values": (this.json.isInput) ? [] : values,
        //    "count": count,
        //    "units": selectUnits,
        //    "dutys": (this.json.selectType=="identity") ? selectDutys : [],
        //    "exclude" : exclude,
        //    "expandSubEnable" : (this.json.expandSubEnable=="no") ? false : true,
        //    "categoryType": this.json.categoryType || "unit",
        //    "onComplete": function(items){
        //        this.selectOnComplete(items);
        //    }.bind(this),
        //    "onCancel": this.selectOnCancel.bind(this),
        //    "onLoad": this.selectOnLoad.bind(this),
        //    "onClose": this.selectOnClose.bind(this)
        //};
    },
    _searchOptions: function(value, callback){
        //var options = {
        //    "type": this.json.selectType,
        //    "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
        //    "units": this.selectUnits,
        //    "dutys": (this.json.selectType=="identity") ? this.selectDutys : []
        //};
        var options = this.getSearchOptions();
        if (!this.comboxFilter) this.comboxFilter = new MWF.O2SelectorFilter(value, options);
        this.comboxFilter.filter(value, function(data){
            data.map(function(d){
                var value = Object.clone(d);
                d.value = value;
                var flag = d.distinguishedName.substr(d.distinguishedName.length-2, 2);
                switch (flag.toLowerCase()){
                    case "@i":
                        d.text = d.name+"("+d.unitName+")";
                        break;
                    case "@p":
                        d.text = d.name+(d.employee ? "("+d.employee+")" : "");
                        break;
                    case "@u":
                        d.text = d.name;
                        break;
                    case "@g":
                        d.text = d.name;
                        break;
                    default:
                        d.text = d.name;
                }
            });
            if (callback) callback(data);
        });
    },

    _resetNodeInputEdit: function(){
        var node = new Element("div", {
            "styles": {
                "overflow": (this.json.styles && this.json.styles.overflow) ? this.json.styles.overflow : "hidden",
                //"position": "relative",
                "margin-right": this.hasIcon() ? "20px" : "0px"
            }
        }).inject(this.node, "after");
        this.node.destroy();
        this.node = node;
    },
    _loadNodeInputEdit: function(){

        this.node.setStyle("overflow","visible");
        var input=null;
        MWF.require("MWF.widget.Combox", function(){
            this.combox = input = new MWF.widget.Combox({
                "count": this.json.count || 0,
                "splitShow": this.json.splitShow || ", ",
                "onCommitInput": function(item){
                    this._searchConfirmPerson(item);
                    //this.fireEvent("change");
                }.bind(this),
                "onChange": function(){
                    this.node.store("data", this.getInputData());
                    this._setBusinessData(this.getInputData());
                    this.fireEvent("change");
                }.bind(this),
                "optionsMethod": this._searchOptions.bind(this)

            });
        }.bind(this), false);
        input.setStyles({
            "background": "transparent",
            "border": "0px"
        });
        input.set(this.json.properties);

        if (!this.json.preprocessing) this._resetNodeInputEdit();

        this.node.empty();
        input.inject(this.node);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": function (ev) {
                        this.clickSelect(ev);
                    }.bind(this)
                    //this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.combox.addEvent("change", function(){
            this.validationMode();
            if (this.validation()){
                this.node.store("data", this.getInputData());
                this._setBusinessData(this.getInputData("change"));
            }
        }.bind(this));
    },

    _resetNodeEdit: function(){
        var input = new Element("div", {
            "styles": {
                "background": "transparent",
                "border": "0px",
                "min-height": "24px"
            }
        });

        var node = new Element("div", {"styles": {
                "overflow": (this.json.styles && this.json.styles.overflow) ? this.json.styles.overflow : "hidden",
                "position": "relative",
                "margin-right": this.hasIcon() ? "20px" : "0px",
                "min-height": "24px"
            }}).inject(this.node, "after");
        input.inject(node);
        this.node.destroy();
        this.node = node;
    },
    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        if( !input && this.nodeHtml ){
            this.node.set("html", this.nodeHtml);
            input = this.node.getFirst();
        }
        input.set(this.json.properties);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": function (ev) {
                    this.clickSelect(ev);
                }.bind(this)
                //this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": function (ev) {
                        this.clickSelect(ev);
                    }.bind(this)
                    //this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.node.getFirst().setStyle("height", "auto");
        this.node.getFirst().addEvent("change", function(){
            this.validationMode();
            if (this.validation()){
                this.node.store("data", this.getInputData());
                this._setBusinessData(this.getInputData("change"));
            }
        }.bind(this));
    },
    getDataText: function(data){
        if (typeOf(data)=="string") return data;
        if( !data || !data.distinguishedName )return "";
        var text = "";
        var flag = data.distinguishedName.substr(data.distinguishedName.length-2, 2);
        switch (flag.toLowerCase()){
            case "@i":
                text = data.name+"("+data.unitName+")";
                break;
            case "@p":
                text = data.name+ (data.employee ? ("("+data.employee+")") : "");
                break;
            case "@u":
                text = data.name;
                break;
            case "@g":
                text = data.name;
                break;
            default:
                text = data.name;
        }
        return text;
    },
    addData: function(value){
        if (!value) return false;
        var simple = this.json.storeRange === "simple";
        value.each(function(v){
            var vtype = typeOf(v);
            if (vtype==="string"){
                var data;
                this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), null, v, false);
                if (data) this.combox.addNewValue(this.getDataText(data), data);
            }
            if (vtype==="object"){
                var d = MWF.org.parseOrgData(v, true, simple);
                this.combox.addNewValue(this.getDataText(d), d);
            }
        }.bind(this));
    },
    checkChange: function(oldValues, values){
        var change = false;
        if (!values) values = [];
        if (oldValues.length && (values && values.length)){
            if (oldValues.length === values.length){
                for (var i=0; i<oldValues.length; i++){
                    if ((oldValues[i].distinguishedName!==values[i].distinguishedName) || (oldValues[i].name!==values[i].name) || (oldValues[i].unique!==values[i].unique)){
                        change = true;
                        break;
                    }
                }
            }else{
                change = true;
            }
        }else if (values.length || oldValues.length) {
            change = true;
        }
        if (change) this.fireEvent("change");
    },
    setData: function(value, fireChange){
        // if (!value) return false;
        var oldValues = this.getData();
        if (value.length==1 && !(value[0])) value=[];

        var promise = this._setValue(value);

        if (fireChange) Promise.resolve(promise).then(function(values){
            o2.promiseAll(values).then(function(v){
                this.checkChange(oldValues, v)
            }.bind(this), function(){});
        }.bind(this), function(){});
    },
    // __setData: function(value){
    //     if (!value) return false;
    //     var oldValues = this.getData();
    //     var values = [];
    //     var comboxValues = [];
    //
    //     var simple = this.json.storeRange === "simple";
    //
    //     var type = typeOf(value);
    //     if (type==="array"){
    //         value.each(function(v){
    //             var vtype = typeOf(v);
    //             var data = null;
    //             if (vtype==="string"){
    //                 var error = (this.json.isInput) ? function(){ comboxValues.push(v); } : null;
    //                 this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), error, v, false);
    //             }
    //             if (vtype==="object") {
    //                 data = MWF.org.parseOrgData(v, true, simple);
    //                 if(data.woPerson)delete data.woPerson;
    //             }
    //             if (data){
    //                 values.push(data);
    //                 comboxValues.push({"text": this.getDataText(data),"value": data});
    //             }
    //         }.bind(this));
    //     }
    //     if (type==="string"){
    //         var vData;
    //         var error = (this.json.isInput) ? function(){ comboxValues.push(value); } : null;
    //         this.getOrgAction()[this.getValueMethod(value)](function(json){ vData = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), error, value, false);
    //         if (vData){
    //             values.push(vData);
    //             comboxValues.push({"text": this.getDataText(vData),"value": vData});
    //         }
    //     }
    //     if (type==="object"){
    //         var vData = MWF.org.parseOrgData(value, true, simple);
    //         if(vData.woPerson)delete vData.woPerson;
    //         values.push( vData );
    //         comboxValues.push({"text": this.getDataText(value),"value": vData});
    //     }
    //
    //     var change = false;
    //     if (oldValues.length && values.length){
    //         if (oldValues.length === values.length){
    //             for (var i=0; i<oldValues.length; i++){
    //                 if ((oldValues[i].distinguishedName!==values[i].distinguishedName) || (oldValues[i].name!==values[i].name) || (oldValues[i].unique!==values[i].unique)){
    //                     change = true;
    //                     break;
    //                 }
    //             }
    //         }else{
    //             change = true;
    //         }
    //     }else if (values.length || oldValues.length) {
    //         change = true;
    //     }
    //     this._setBusinessData(values);
    //     if (change) this.fireEvent("change");
    //
    //     if (this.json.isInput){
    //         if (this.combox){
    //             this.combox.clear();
    //             this.combox.addNewValues(comboxValues);
    //         }else{
    //             var node = this.node.getFirst();
    //             if (node){
    //                 node.empty();
    //                 comboxValues.each(function(v, i){
    //                     this.creteShowNode(v, (i===comboxValues.length-1)).inject(node);
    //                 }.bind(this));
    //             }
    //         }
    //     }else{
    //         if (this.node.getFirst()){
    //             var node = this.node.getFirst();
    //             node.empty();
    //             this.loadOrgWidget(values, node)
    //         }else{
    //             this.node.empty();
    //             this.loadOrgWidget(values, this.node);
    //         }
    //     }
    // },
    creteShowNode: function(data, islast){
        var nodeText = (data.text) ?  data.text : data;
        if (!islast) nodeText = nodeText + (this.json.splitShow || ", ");

        var node = new Element("div", {
            "styles": {
                "float": "left",
                "margin-right": "5px"
            },
            "text": nodeText
        });
        var text = "";
        if (data.value && data.value.distinguishedName){
            var flag = data.value.distinguishedName.substr(data.value.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = data.value.name+"("+data.value.unitName+")";
                    break;
                case "@p":
                    text = data.value.name+ (data.value.employee ? "("+data.value.employee+")" : "");
                    break;
                case "@u":
                    text = data.value.levelName;
                    break;
                case "@g":
                    text = data.value.name;
                    break;
                default:
                    text = data.value.name;
            }
            var inforNode = new Element("div").set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });

            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: node,
                transition: 'flyin'
            });
        }
        return node;
    },
    _setValue: function(value){
        var values = [];
        var ags = [];
        var simple = this.json.storeRange === "simple";
        var flag = false;
        if (typeOf(value)!=="array") value = (!!value) ? [value] : [];
        //value = (value.flat) ? value.flat() : value.flatten();
        if (value.some(function(e){ return (e && o2.typeOf(e.then)=="function") }) || this.json.asyncMode==="yes"){
            var p = Promise.all(value).then(function(d){
                if (typeOf(d)!=="array") d = (!!d) ? [d] : [];
                d.each(function(da){
                    if (typeOf(da)!=="array") da = (!!da) ? [da] : [];
                    da.each(function(dd){
                        if (dd){
                            if (typeOf(dd)==="string"){
                                var pp = this.getOrgAction()[this.getValueMethod(dd)](function(json){
                                    return MWF.org.parseOrgData(json.data, true, simple);
                                }.bind(this), null, dd, true).catch(function(e){
                                    console.log("error:" + e);
                                    console.log(e);
                                });
                                ags.push(pp);
                            }else{
                                values.push(dd);
                            }
                        }
                    }.bind(this));
                }.bind(this));
                if (ags.length){
                    return Promise.all(ags).then(function(data){
                        values = values.concat(data);
                        flag = true;
                        this.__setValue(values);
                        return values;
                    }.bind(this), function(){});
                }else{
                    flag = true;
                    this.__setValue(values);
                    return values
                }
            }.bind(this), function(){});

            this.moduleValueAG = p;
            if (p && p.then) p.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
            return p;
        }else{
            value.each(function(dd){
                if (dd){
                    if (typeOf(dd)==="string"){
                        this.getOrgAction()[this.getValueMethod(dd)](function(json){
                            values.push(MWF.org.parseOrgData(json.data, true, simple));
                        }.bind(this), null, dd, false);
                    }else{
                        values.push(dd);
                    }
                }
            }.bind(this));
            this.__setValue(values);
            return values
        }



        // var ag = o2.AG.all(value).then(function(d) {
        //     if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
        //
        //     d.each(function(dd){
        //         //if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
        //         if (dd){
        //             if (typeOf(dd)==="string"){
        //                 ags.push(this.getOrgAction()[this.getValueMethod(dd)](function(json){
        //                     return MWF.org.parseOrgData(json.data, true, simple);
        //                 }.bind(this).ag(), null, dd, true));
        //             }else{
        //                 values.push(dd);
        //             }
        //         }
        //     }.bind(this));
        //     if (ags.length){
        //         return o2.AG.all(ags).then(function(data){
        //             values = values.concat(data);
        //             flag = true;
        //             this.__setValue(values);
        //             return values;
        //         }.bind(this));
        //     }else{
        //         flag = true;
        //         this.__setValue(values);
        //         return values
        //     }
        // }.bind(this));
        //
        // this.moduleValueAG = ag;
        // if (ag) ag.then(function(){
        //     this.moduleValueAG = null;
        // }.bind(this));
        // return ag;
    },
    __setValue: function(value){
        this.moduleValueAG = null;
        if (value.length==1 && !(value[0])) value=[];

        if (this.json.count>0){
            value = value.slice(0, this.json.count);
        }

        var values = [];
        var comboxValues = [];
        var type = typeOf(value);
        var simple = this.json.storeRange === "simple";
        if (type==="array"){
            value.each(function(v){
                var data=null;
                var vtype = typeOf(v);
                if (vtype==="string"){
                    var error = (this.json.isInput) ? function(){ comboxValues.push(v); } : null;
                    this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), error, v, false);
                }
                if (vtype==="object") data = v;
                if (data){
                    var d = MWF.org.parseOrgData(data, true, simple)
                    values.push(d);
                    comboxValues.push({"text": this.getDataText(d),"value": d});
                }
            }.bind(this));
        }
        if (type==="string"){
            var vData;
            var error = (this.json.isInput) ? function(){ comboxValues.push(value); } : null;
            this.getOrgAction()[this.getValueMethod(value)](function(json){ vData = MWF.org.parseOrgData(json.data, true,simple); }.bind(this), error, value, false);
            if (vData){
                values.push(vData);
                comboxValues.push({"text": this.getDataText(vData),"value": vData});
            }
        }
        if (type==="object"){
            var v = MWF.org.parseOrgData(value, true, simple)
            values.push(v);
            comboxValues.push({"text": this.getDataText(v),"value": v});
        }

        this.node.store("data", values);
        this._setBusinessData(values);

        if (this.json.isInput){

            if (this.combox){
                this.combox.clear();
                this.combox.addNewValues(comboxValues);

                // values.each(function(v){
                //     if (typeOf(v)=="string"){
                //         this.combox.addNewValue(v);
                //     }else{
                //         this.combox.addNewValue(this.getDataText(v), v);
                //     }
                // }.bind(this));
            }else{
                var node = this.node.getFirst();
                if (node){
                    node.empty();
                    comboxValues.each(function(v, i){
                        this.creteShowNode(v, (i===comboxValues.length-1)).inject(node);
                    }.bind(this));
                }
            }

        }else{
            if (this.node.getFirst()){
                var node = this.node.getFirst();
                node.empty();
                this.loadOrgWidget(values, node)
            }else{
                this.node.empty();
                this.loadOrgWidget(values, this.node);
            }
        }

        this.checkDescription();

        this.fieldModuleLoaded = true;

        //if (this.readonly) this.loadOrgWidget(values, this.node)
        //this.node.set("text", value);
    },
    getValueMethod: function(value){
        if (value){
            var flag = value.substr(value.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    return "getIdentity";
                case "@p":
                    return "getPerson";
                case "@u":
                    return "getUnit";
                case "@g":
                    return "getGroup";
                default:
                    return (this.json.selectType==="unit") ? "getUnit" : "getIdentity";
            }
        }
        return (this.json.selectType==="unit") ? "getUnit" : "getIdentity";
    },
    loadOrgWidget: function(value, node){
        var _self = this;
        var disableInfor = layout.mobile ? true : false;
        if( this.json.showCard === "no" )disableInfor = true;
        var canRemove = this.json.canRemove  ? true : false;
        var height = node.getStyle("height").toInt();
        if (node.getStyle("overflow")==="visible" && !height) node.setStyle("overflow", "hidden");
        if (value && value.length){
            value.each(function(data){
                if( !data || !data.distinguishedName )return;
                var flag = data.distinguishedName.substr(data.distinguishedName.length-2, 2);
                var copyData = Object.clone(data);
                if( this.json.displayTextScript && this.json.displayTextScript.code ){
                    this.currentData = copyData;
                    var displayName = this.form.Macro.exec(this.json.displayTextScript.code, this);
                    if( displayName ){
                        copyData.displayName = displayName;
                    }
                    this.currentData = null;
                }

                var opt = {"style": "xform","lazy":true,"disableInfor" : disableInfor, "canRemove":canRemove, "onRemove": function () {
                        _self.fireEvent("removeItem", [{
                            data: data,
                            item: this
                        }])
                    }, "styles": this.json.itemStyles || "" };

                var widget;
                switch (flag.toLowerCase()){
                    case "@i":
                        widget = new MWF.widget.O2Identity(copyData, node, opt);
                        break;
                    case "@p":
                        widget = new MWF.widget.O2Person(copyData, node, opt);
                        break;
                    case "@u":
                        widget = new MWF.widget.O2Unit(copyData, node, opt);
                        break;
                    case "@g":
                        widget = new MWF.widget.O2Group(copyData, node, opt);
                        break;
                    default:
                        widget = new MWF.widget.O2Other(copyData, node, opt);
                }
                widget.field = this;
                if( layout.mobile ){
                    widget.node.setStyles({
                        "float" : "none"
                    })
                }
            }.bind(this));
        }
    },
    _loadStyles: function(){
        if (this.isReadonly()){
            if (this.json.styles) this.node.setStyles(this.json.styles);
        }else{
            if (this.json.styles) this.node.setStyles(this.json.styles);
            if (this.json.inputStyles) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
            if (this.iconNode && this.iconNode.offsetParent !== null ){
                var size = this.node.getSize();
                this.iconNode.setStyle("height", ""+size.y+"px");
            }
        }
    },

    checkEmpower : function( data, callback ){
        if( typeOf(data)==="array" && this.identityOptions && this.json.isCheckEmpower && this.json.identityResultType === "identity" ) {
            var empowerChecker = new MWF.APPOrg.EmpowerChecker(this.form, this.json);
            empowerChecker.load(data, callback);
        }else{
            if( callback )callback( data );
        }
    },
    _beforeReloaded: function(){
        this.selector = null;
        if (this.combox) {
            this.combox.clear();
            this.combox = null;
        }
    },


        getExcelData: function(){
            var text, value = this.getData();
            if (o2.typeOf(value) === "array") {
                var textArray = [];
                value.each(function (item) {
                    if (o2.typeOf(item) === "object") {
                        textArray.push(item.distinguishedName);
                    } else {
                        textArray.push(item);
                    }
                }.bind(this));
                text = textArray.join(", \n");
            } else if (o2.typeOf(value) === "object") {
                text = value.distinguishedName;
            } else {
                text = value;
            }
            return text;
        },
        setExcelData: function(data){
            this.excelData = data;
            this.setData(data, true);
        }

});

MWF.APPOrg.EmpowerChecker = new Class({
    Implements: [Events],
    initialize: function (form, json) {
        this.form = form;
        this.json = json;
        this.css = this.form.css;
        this.checkedAllItems = true;
    },
    load : function( data, callback, container ){
        if( typeOf(data)==="array" && this.json.isCheckEmpower && this.json.identityResultType === "identity" ){
            var array = [];
            data.each( function( d ){
                if( d.distinguishedName ){
                    var flag = d.distinguishedName.substr(d.distinguishedName.length-1, 1).toLowerCase();
                    if( flag === "i" ){
                        array.push( d.distinguishedName )
                    }
                }
            }.bind(this));
            if( array.length > 0 ){
                o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({
                    "application" : (this.form.businessData.work || this.form.businessData.workCompleted).application,
                    "process" : (this.form.businessData.work || this.form.businessData.workCompleted).process,
                    "work" : (this.form.businessData.work || this.form.businessData.workCompleted).id,
                    "identityList" : array
                }, function( json ){
                    var arr = [];
                    json.data.each( function(d){
                        if(d.fromIdentity !== d.toIdentity )arr.push(d);
                    });
                    if( arr.length > 0 ){
                        this.openSelectEmpowerDlg( arr, data, callback, container );
                    }else{
                        if( callback )callback( data );
                    }
                }.bind(this), function(){
                    if( callback )callback( data );
                }.bind(this))
            }else{
                if( callback )callback( data );
            }
        }else{
            if( callback )callback( data );
        }
    },
    getIgnoreEmpowerArray : function( callback ){
        var array = [];
        if( this.empowerSelectNodes && this.empowerSelectNodes.length ){
            this.empowerSelectNodes.each(function(node){
                if( !node.retrieve("isSelected") ){
                    var d = node.retrieve("data");
                    array.push( d.fromIdentity );
                }
            }.bind(this));
        }
        if( callback )callback( array );
        return array;
    },
    setIgnoreEmpowerFlag : function(data, callback){

        var ignoreList = this.getIgnoreEmpowerArray();
        for( var i=0; i<data.length; i++ ){
            var d = data[i];
            if( ignoreList.indexOf( d.distinguishedName ) > -1 ){
                d.ignoreEmpower = true;
            }else if( d.ignoreEmpower ){
                delete  d.ignoreEmpower;
            }
        }
        if( callback )callback( data );
    },
    replaceEmpowerIdentity : function(data, callback){

        var empowerData = {};
        this.empowerSelectNodes.each(function(node){
            if( node.retrieve("isSelected") ){
                var d = node.retrieve("data");
                empowerData[ d.fromIdentity ] = d;
            }
        }.bind(this));

        if( Object.keys(empowerData).length === 0 ){
            callback( data );
        }else{
            var identityList = [];
            for( var key in empowerData ){
                identityList.push( empowerData[key].toIdentity );
            }
            o2.Actions.get("x_organization_assemble_express").listIdentity({ "identityList" : identityList }, function(json){
                var newData = data.clone();
                var d = {};
                json.data.each( function(j){
                    d[j.distinguishedName] = j;
                });
                for( var i=0; i<newData.length; i++ ){
                    var nd = newData[i];
                    if( nd.distinguishedName && empowerData[nd.distinguishedName]){
                        if( d[empowerData[nd.distinguishedName].toIdentity] ){
                            newData[i] = d[empowerData[nd.distinguishedName].toIdentity]
                        }
                    }
                }
                callback( newData );
            },function(){
                callback( data );
            });
        }
    },
    openSelectEmpowerDlg : function( data, orginData, callback, container ){
        if( layout.mobile ){
            this.openSelectEmpowerDlg_mobile(data, orginData, callback, container);
        }else{
            this.openSelectEmpowerDlg_pc(data, orginData, callback, container);
        }
    },
    openSelectEmpowerDlg_mobile : function( data, orginData, callback, container ){



        var that = this;

        //处理json
        var subItemList = [];
        // var empowerMap = {};

        // var selectableItems = [];
        var valueList = [];

        data.each( function( d ){
            subItemList.push({
                "name" : d.fromIdentity.split("@")[0] + " "+MWF.xApplication.process.Xform.LP.empowerTo+" " + d.toIdentity.split("@")[0],
                "id" : d.fromIdentity + "#" + d.toIdentity
            })
            valueList.push({
                "name" : d.fromIdentity.split("@")[0] + " "+MWF.xApplication.process.Xform.LP.empowerTo+" " + d.toIdentity.split("@")[0],
                "id" : d.fromIdentity + "#" + d.toIdentity
            })
            // empowerMap[ d.fromIdentity ] = d.toIdentity;
        }.bind(this));

        if( subItemList.length === 0 ){
            callback();
            return;
        }
        var empowerList = Array.clone(subItemList);

        // selectableItems.push({
        //     "empowerMap" : empowerMap,
        //     "subItemList" : subItemList
        // });

        // if( selectableItems.length === 0 ){
        //     callback();
        //     return;
        // }
        // var empowerList = Array.clone(selectableItems);
        o2.xDesktop.requireApp("Template", "Selector.Custom", function () {
            var options = {
                "count": 0,
                "title": MWF.xApplication.process.Xform.LP.selectEmpower,
                "selectAllEnable" : true,
                "selectableItems": subItemList,
                "expand": false,
                "category": false,
                "values": valueList,
                "zIndex" : 3001,
                "closeOnclickOk" : true,
                "onComplete": function (items) {

                    var arr = [];
                    items.each(function (item) {
                        arr.push( item.data.id )
                    }.bind(this));

                    var ignoreList = [];
                    empowerList.each( function (obj) {
                        if( arr.indexOf( obj.id ) === -1 )ignoreList.push( obj.id.split("#")[0] )
                    });

                    for( var i=0; i<orginData.length; i++ ){
                        var d = orginData[i];
                        if( ignoreList.indexOf( d.distinguishedName ) > -1 ){
                            d.ignoreEmpower = true;
                        }else if( d.ignoreEmpower ){
                            delete  d.ignoreEmpower;
                        }
                    }
                    if( callback )callback( orginData );

                    // empowerList.each( function(obj){
                    // var list = obj.subItemList.filter(function(item, index){
                    //     return !arr.contains( item.id );
                    // }.bind(this));
                    // ignoreList = ignoreList.map(function(item,index){
                    //     return item.id.split("#")[1];
                    // })
                    // });

                    // empowerList.each( function(obj){
                    //     var org = that.orgItemsObject[obj.orgId];
                    //     // if( obj.ignoreList.length > 0 ){
                    //     var data = org.getData();
                    //     for( var i=0; i<data.length; i++ ){
                    //         var d = data[i];
                    //         if( obj.ignoreList.indexOf( d.distinguishedName ) > -1 ){
                    //             d.ignoreEmpower = true;
                    //         }else if( d.ignoreEmpower ){
                    //             delete d.ignoreEmpower;
                    //         }
                    //     }
                    //     org.setData( data );
                        // }

                        // if( obj.empowerMap ){
                        //     var data = org.getValue();
                        //     for( var i=0; i<data.length; i++ ){
                        //         var d = data[i];
                        //         if( obj.empowerMap[ d.distinguishedName ] ){
                        //             d.empowerToIdentity = obj.empowerMap[ d.distinguishedName ];
                        //         }
                        //     }
                        //     org.empowerData = Array.clone(data);
                        // }

                        // if(callback)callback();
                    // })
                }.bind(this)
            };
            if( this.form.json.selectorStyle ){
                Object.merge(options, this.form.json.selectorStyle );
            }
            options.flatCategory = false;
            var selector = new o2.xApplication.Template.Selector.Custom($(document.body), options);
            selector.load();
        }.bind(this))
    },
    openSelectEmpowerDlg_pc : function( data, orginData, callback, container ){
        var node = new Element("div", {"styles": this.css.empowerAreaNode});
        var html = "<div style=\"line-height: 20px; color: #333333; overflow: hidden\">"+MWF.xApplication.process.Xform.LP.empowerDlgText+"</div>";
        html += "<div style=\"margin-bottom:10px; margin-top:10px; overflow-y:auto;\"></div>";
        node.set("html", html);
        var itemNode = node.getLast();
        this.getEmpowerItems(itemNode, data);
        node.inject( container || this.form.app.content);

        var dlg = o2.DL.open({
            "title": MWF.xApplication.process.Xform.LP.selectEmpower,
            "style": this.form.json.dialogStyle || "user",
            "isResize": true,
            "content": node,
            "width": 630,
            //"height" : 500,
            "buttonList": [
                {
                    "type" : "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function(d, e){
                        //this.replaceEmpowerIdentity( orginData, callback ); //直接替换已授权的人，已废弃
                        this.setIgnoreEmpowerFlag( orginData, callback ); //然后设置忽略的人的标志
                        dlg.close();
                    }.bind(this)
                },
                {
                    "type" : "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function(){dlg.close();}
                }
            ],
            "onPostShow": function(){
                var selectNode = this.createSelectAllEmpowerNode();
                selectNode.inject( dlg.button );
                if( layout.mobile ){
                    dlg.node.inject( $(document.body) );
                    dlg.node.setStyles({
                        "width":"100%",
                        "height": "100%",
                        "top" : "0px",
                        "left" : "0px"
                    });
                    var y = dlg.node.getSize().y - 190;
                    itemNode.setStyle("height",y+"px");

                    dlg.options.contentHeight = dlg.node.getSize().y - 100 ; //+100;
                    dlg.setContentSize();
                }else{
                    dlg.content.setStyle("overflow","hidden");

                    var y = Math.min(300, itemNode.getSize().y);
                    var marginTop = itemNode.getStyle("margin-top");
                    var marginBottom = itemNode.getStyle("margin-bottom");
                    itemNode.setStyle("height",y+"px");

                    dlg.options.contentHeight = y + 30 + 20 ; //+100;
                    dlg.setContentSize();
                    dlg.node.setStyles({
                        "height": ""+(dlg.options.height) +"px"
                    });
                    dlg.reCenter();
                }

            }.bind(this)
        });
    },
    getEmpowerItems: function(itemNode, data){
        var _self = this;
        this.empowerSelectNodes = [];
        var count = 1;
        var node;
        data.each(function( d ){
            if(d.fromIdentity == d.toIdentity )return;
            if( count % 2 === 1 ){
                node = new Element("div", {"styles": this.css.empowerItemOddNode}).inject(itemNode);
                node.store("nodeType","Odd");
                //node.setStyle("margin-right","10px");
            }else{
                node = new Element("div", {"styles": this.css.empowerItemEvenNode}).inject(itemNode);
                node.store("nodeType","Even");
            }
            count++;
            this.empowerSelectNodes.push( node );
            node.store("data", d);
            var iconNode = new Element("div.empowerItemIconNode", {"styles": this.css.empowerItemIconNode}).inject(node);
            node.store("iconNode",iconNode);
            var contentNode = new Element("div.empowerItemContentNode", {"styles": this.css.empowerItemContentNode}).inject(node);

            var formIdentityNode = new Element("div.empowerItemPersonNode", {"styles": this.css.empowerItemPersonNode, text : d.fromIdentity.split("@")[0] }).inject(contentNode);
            var titleNode = new Element("div.empowerItemTitleNode", {"styles": this.css.empowerItemTitleNode, text : MWF.xApplication.process.Xform.LP.empowerTo }).inject(contentNode);
            var toIdentityNode = new Element("div.empowerItemPersonNode", {"styles": this.css.empowerItemPersonNode, text : d.toIdentity.split("@")[0] }).inject(contentNode);

            node.addEvents({
                "mouseover": function(){
                    var isSelected = this.retrieve("isSelected");
                    if (!isSelected){
                        this.setStyles(_self.css[ "empowerItem"+this.retrieve("nodeType")+"Node_over" ]);
                        if( _self.css.empowerItemIconNode_over ){
                            var iconNode = this.retrieve("iconNode");
                            if(iconNode)iconNode.setStyles(_self.css.empowerItemIconNode_over);
                        }
                    }
                },
                "mouseout": function(){
                    var isSelected = this.retrieve("isSelected");
                    if (!isSelected){
                        this.setStyles(_self.css[ "empowerItem"+this.retrieve("nodeType")+"Node" ])
                        if( _self.css.empowerItemIconNode_over ){
                            var iconNode = this.retrieve("iconNode");
                            if(iconNode)iconNode.setStyles(_self.css.empowerItemIconNode);
                        }
                    }
                },
                "click": function(){
                    var isSelected = this.retrieve("isSelected");
                    if (isSelected){
                        _self.unselectEmpowerItem( this)
                    }else{
                        _self.selectEmpowerItem(this)
                    }
                }
            });
            if( this.checkedAllItems )node.click();
        }.bind(this));
    },
    unselectEmpowerItem : function( itemNode ){
        itemNode.store("isSelected", false);
        itemNode.setStyles( this.css[ "empowerItem"+itemNode.retrieve("nodeType")+"Node" ] );
        itemNode.getElements("div").each( function( div ){
            var className = div.get("class");
            if( className && this.css[className] )div.setStyles( this.css[className] )
        }.bind(this))
    },
    selectEmpowerItem : function( itemNode ){
        itemNode.store("isSelected", true);
        itemNode.setStyles( this.css[ "empowerItem"+itemNode.retrieve("nodeType")+"Node_selected" ] );
        itemNode.getElements("div").each( function( div ){
            var className = div.get("class");
            if( className && this.css[className+"_selected"] )div.setStyles( this.css[className+"_selected"] )
        }.bind(this))
    },
    createSelectAllEmpowerNode : function(){
        var _self = this;
        var node = new Element("div", {
            styles : this.css.empowerSelectAllItemNode,
            text : MWF.xApplication.process.Xform.LP.selectAll
        });
        node.addEvents({
            "mouseover": function(){
                var isSelected = this.retrieve("isSelected");
                if (!isSelected) this.setStyles(_self.css.empowerSelectAllItemNode_over);
            },
            "mouseout": function(){
                var isSelected = this.retrieve("isSelected");
                if (!isSelected) this.setStyles(_self.css.empowerSelectAllItemNode)
            },
            "click": function(){
                var isSelected = this.retrieve("isSelected");
                if (isSelected){
                    this.store("isSelected", false);
                    this.setStyles( _self.css.empowerSelectAllItemNode );
                    _self.empowerSelectNodes.each( function(itemNode){
                        _self.unselectEmpowerItem(itemNode)
                    }.bind(this))
                }else{
                    this.store("isSelected", true);
                    this.setStyles( _self.css.empowerSelectAllItemNode_selected );
                    _self.empowerSelectNodes.each( function(itemNode){
                        _self.selectEmpowerItem(itemNode)
                    }.bind(this))
                }
            }
        });
        if( this.checkedAllItems ){
            node.store("isSelected", true);
            node.setStyles( _self.css.empowerSelectAllItemNode_selected );
        }
        return node;
    }
});

MWF.APPOrg.GroupOptions = new Class({
    Implements: [Events],
    initialize: function (form, json) {
        this.form = form;
        this.json = json;
        this.orgAction = MWF.Actions.get("x_organization_assemble_control");
    },
    getOptions: function(){
        var count = (this.json.groupCount) ? this.json.groupCount : 0;
        if( this.json.groupRange==="group" ){
            return {
                "count": count,
                "storeRange" : this.json.storeRange,
                "include": this.getSelectRange( true )
            }
        }else{
            return {
                "count": count,
                "storeRange" : this.json.storeRange
            }
        }
    },
    getSearchOptions : function(){
        return {};
    },
    getSelectRange : function( refresh ){
        if( !this.selectRange || refresh){
            this.selectRange = this._getSelectRange();
        }
        return this.selectRange;
    },
    _getSelectRange : function(){
        var rangeValues = [];
        if (this.json.groupRangeKey && this.json.groupRangeKey.code){
            var v = this.form.Macro.exec(this.json.groupRangeKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            rangeValues = v;
            //v.each(function(d){
            //    if (d){
            //        if (typeOf(d)==="string"){
            //            var data;
            //            this.orgAction.getGroup(function(json){ data = json.data }.bind(this), null, d, false);
            //            rangeValues.push(data);
            //        }else{
            //            rangeValues.push(d);
            //        }
            //    }
            //}.bind(this));
        }
        return rangeValues;
    }
});

MWF.APPOrg.UnitOptions = new Class({
    Implements: [Events],
    initialize : function( form, json  ){
        this.form = form;
        this.json = json;
        this.orgAction = MWF.Actions.get("x_organization_assemble_control");
    },
    getOptions: function(){

        var count = (this.json.unitCount) ? this.json.unitCount : 0;
        var selectUnits = this.getSelectRange( true );

        return {
            "count": count,
            "units": selectUnits,
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
            "storeRange" : this.json.storeRange,
            "expandSubEnable" : (this.json.unitExpandSubEnable==="no") ? false : true,
            "firstLevelSelectable":this.json.firstLevelSelectable==="yes"
        };
    },
    getSearchOptions : function(){
        var selectUnits = this.getSelectRange( true );
        return {
            "units": selectUnits,
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType
        };
    },
    getSelectRange : function( refresh ){
        if( !this.selectRange || refresh){
            this.selectRange = this._getSelectRange();
        }
        return this.selectRange;
    },
    _getSelectRange : function(){
        if (this.json.unitRange==="unit"){
            return this.getScriptSelectUnit();
        }
        if (this.json.unitRange==="draftUnit"){
            var dn = (this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn;
            if (!dn){
                if ( layout.session.user.identityList && layout.session.user.identityList.length){
                    var ids = [];
                    layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                    return this.getNextSelectUnit(ids);
                }else{
                    return [];
                }
            }else{
                return this.getNextSelectUnit((this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn);
            }
        }
        if (this.json.unitRange==="currentUnit"){
            if (this.form.app.currentTask){
                return this.getNextSelectUnit(this.form.app.currentTask.identityDn);
            }else{
                if (this.form.app.taskList && this.form.app.taskList.length){
                    var ids = [];
                    this.form.app.taskList.each(function(task){ ids.push(task.identity); });
                    return this.getNextSelectUnit(ids);
                }else{
                    if ( layout.session.user.identityList && layout.session.user.identityList.length){
                        var ids = [];
                        layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                        return this.getNextSelectUnit(ids);
                    }else{
                        return [];
                    }
                }
            }
        }
        return [];
    },
    getScriptSelectUnit: function(){
        var rangeValues = [];
        if (this.json.unitRangeUnit && this.json.unitRangeUnit.length){
            this.json.unitRangeUnit.each(function(unit){
                //var unitFlag = unit.distinguishedName || unit.id || unit.unique || unit.levelName;
                //if (unitFlag) rangeValues.push(unitFlag);
                rangeValues.push(unit);
            }.bind(this));
        }
        if (this.json.unitRangeField && this.json.unitRangeField.length){
            this.json.unitRangeField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d){
                        // if (typeOf(d)==="string"){
                        //     var data;
                        //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                        //     rangeValues.push(data);
                        // }else{
                            rangeValues.push(d);
                        // }
                    }
                }.bind(this));
            }.bind(this));
        }
        if (this.json.unitRangeKey && this.json.unitRangeKey.code){
            var v = this.form.Macro.exec(this.json.unitRangeKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d){
                    // if (typeOf(d)==="string"){
                    //     var data;
                    //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                    //     rangeValues.push(data);
                    // }else{
                        rangeValues.push(d);
                    // }
                }
            }.bind(this));
        }
        return rangeValues;
    },
    getNextSelectUnit: function(id){
        var ids = typeOf(id)==="array" ? id : [id];
        var data;
        var units = [];
        ids.each( function(i){
            if (this.json.unitRangeNext === "direct"){
                this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
                if (data && data.woUnit) units.push(data.woUnit);
            }else if(this.json.unitRangeNext==="level"){
                this.orgAction.getUnitWithIdentityWithLevel(i, this.json.unitRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                if (data) units.push(data);
            }else if (this.json.unitRangeNext==="type"){
                if (this.json.unitRangeNextUnitType==="all"){
                    this.orgAction.getUnitWithIdentityWithLevel(i, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }else{
                    this.orgAction.getUnitWithIdentityWithType(i, this.json.unitRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }
                if (data) units.push(data);
            }
            data = null;
        }.bind(this));
        return units;
        //if (this.json.unitRangeNext === "direct"){
        //    if (typeOf(id)==="array"){
        //        var units = [];
        //        id.each(function(i){
        //            this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
        //            if (data && data.woUnit) units.push(data.woUnit);
        //            data = null;
        //        }.bind(this));
        //        return units;
        //    }else{
        //        this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, id, false);
        //        return (data.woUnit) ? [data.woUnit] : [];
        //    }
        //}
        //if (this.json.unitRangeNext==="level"){
        //    this.orgAction.getUnitWithIdentityWithLevel(id, this.json.unitRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    //this.json.rangeNextLevel
        //    return (data) ? [data] : [];
        //}
        //if (this.json.unitRangeNext==="type"){
        //    if (this.json.unitRangeNextUnitType==="all"){
        //        this.orgAction.getUnitWithIdentityWithLevel(id, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }else{
        //        this.orgAction.getUnitWithIdentityWithType(id, this.json.unitRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }
        //
        //    return (data) ? [data] : [];
        //}

    }
});

MWF.APPOrg.IdentityOptions = new Class({
    Implements: [Events],
    initialize : function( form, json  ){
        this.form = form;
        this.json = json;
        this.orgAction = MWF.Actions.get("x_organization_assemble_control");
    },
    getOptions: function(){
        var count = (this.json.identityCount) ? this.json.identityCount : 0;
        if( this.json.identityOnlyUseInclude ){
            return {
                "noUnit" : true,
                "count": count,
                "resultType" : this.json.identityResultType,
                "storeRange" : this.json.storeRange,
                "include" : this._getInclude()
            };
        }else{
            var selectUnits = this.getSelectRange( true );
            var selectDutys = this.getSelectRangeDuty( true );
            return {
                "count": count,
                "units": selectUnits,
                "unitType": this.json.unitType || "",
                "dutys": selectDutys,
                "expandSubEnable" : (this.json.identityExpandSubEnable=="no") ? false : true,
                "resultType" : this.json.identityResultType,
                "categoryType": this.json.categoryType || "unit",
                "dutyUnitLevelBy" : this.json.dutyUnitLevelBy || "duty",
                "storeRange" : this.json.storeRange,
                "include" : this._getInclude()
            };
        }
    },
    getSearchOptions : function(){
        var selectUnits = this.getSelectRange( true );
        var selectDutys = this.getSelectRangeDuty( true );
        return {
            "units": selectUnits,
            "dutys": selectDutys,
            "resultType" : this.json.identityResultType
        };
    },
    getSelectRange : function( refresh ){
        if( !this.selectRange || refresh ){
            this.selectRange = this._getSelectRange();
        }
        return this.selectRange;
    },
    _getInclude : function(){
        var include = [];
        if( this.json.identityIncludeKey ){
            var v = this.form.Macro.exec(this.json.identityIncludeKey.code, this);
            if( v )include = typeOf(v)==="array" ? v : [v];
        }
        return include;
    },
    _getSelectRange : function(){
        if (this.json.identityRange==="unit"){
            return this.getScriptSelectUnit();
        }
        if (this.json.identityRange==="draftUnit"){
            var dn = (this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn;
            if (!dn){
                if ( layout.session.user.identityList && layout.session.user.identityList.length){
                    var ids = [];
                    layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                    return this.getNextSelectUnit(ids);
                }else{
                    return [];
                }
            }else{
                return this.getNextSelectUnit((this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn);
            }
        }
        if (this.json.identityRange==="currentUnit"){
            if (this.form.app.currentTask){
                return this.getNextSelectUnit(this.form.app.currentTask.identityDn);
            }else{
                if (this.form.app.taskList && this.form.app.taskList.length){
                    var ids = [];
                    this.form.app.taskList.each(function(task){ ids.push(task.identity); });
                    return this.getNextSelectUnit(ids);
                }else{
                    if ( layout.session.user.identityList && layout.session.user.identityList.length){
                        var ids = [];
                        layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                        return this.getNextSelectUnit(ids);
                    }else{
                        return [];
                    }
                }
            }
        }
        return [];
    },
    getScriptSelectUnit: function(){
        var rangeValues = [];
        if (this.json.identityRangeUnit && this.json.identityRangeUnit.length){
            this.json.identityRangeUnit.each(function(unit){
                //var unitFlag = unit.distinguishedName || unit.id || unit.unique || unit.levelName ;
                //if (unitFlag) rangeValues.push(unitFlag);
                rangeValues.push(unit);
            }.bind(this));
        }
        if (this.json.identityRangeField && this.json.identityRangeField.length){
            this.json.identityRangeField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d){
                        // if (typeOf(d)==="string"){
                        //     var data;
                        //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                        //     rangeValues.push(data);
                        // }else{
                            rangeValues.push(d);
                        // }
                    }
                }.bind(this));
            }.bind(this));
        }
        if (this.json.identityRangeKey && this.json.identityRangeKey.code){
            var v = this.form.Macro.exec(this.json.identityRangeKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d){
                    // if (typeOf(d)==="string"){
                    //     var data;
                    //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                    //     rangeValues.push(data);
                    // }else{
                        rangeValues.push(d);
                    // }
                }
            }.bind(this));
        }
        return rangeValues;
    },
    getNextSelectUnit: function(id){
        var ids = typeOf(id)==="array" ? id : [id];
        var data;
        var units = [];
        ids.each(function(i){
            if (this.json.identityRangeNext === "direct"){
                this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
                if (data && data.woUnit) units.push(data.woUnit);
            }else if (this.json.identityRangeNext==="level"){
                this.orgAction.getUnitWithIdentityWithLevel(i, this.json.identityRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                if (data) units.push(data);
            }else if (this.json.identityRangeNext==="type"){
                if (this.json.identityRangeNextUnitType==="all"){
                    this.orgAction.getUnitWithIdentityWithLevel(i, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }else{
                    this.orgAction.getUnitWithIdentityWithType(i, this.json.identityRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }
                if (data) units.push(data);
            }
            data = null;
        }.bind(this));
        return units;

        //if (this.json.identityRangeNext === "direct"){
        //if (typeOf(id)==="array"){
        //    var units = [];
        //    id.each(function(i){
        //        this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
        //        if (data && data.woUnit) units.push(data.woUnit);
        //        data = null;
        //    }.bind(this));
        //    return units;
        //}else{
        //    this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, id, false);
        //    return (data.woUnit) ? [data.woUnit] : [];
        //}
        //}
        //if (this.json.identityRangeNext==="level"){
        //    this.orgAction.getUnitWithIdentityWithLevel(id, this.json.identityRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    return (data) ? [data] : [];
        //    //this.json.rangeNextLevel
        //}
        //if (this.json.identityRangeNext==="type"){
        //    if (this.json.identityRangeNextUnitType==="all"){
        //        this.orgAction.getUnitWithIdentityWithLevel(id, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }else{
        //        this.orgAction.getUnitWithIdentityWithType(id, this.json.identityRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }
        //    return (data) ? [data] : [];
        //}

    },

    getSelectRangeDuty: function( refresh ){
        if( !this.selectRangeDuty || refresh ){
            this.selectRangeDuty = this._getSelectRangeDuty();
        }
        return this.selectRangeDuty;
    },
    _getSelectRangeDuty: function(){
        if (this.json.dutyRange==="duty"){
            return this.getScriptSelectDuty();
        }
        return [];
    },
    getScriptSelectDuty: function(){
        var rangeValues = [];
        if( this.json.rangeDuty && this.json.rangeDuty.length ){
            var rangeDuty = this.json.rangeDuty;
            if( typeOf(rangeDuty) === "string" ){
                rangeDuty = JSON.parse( rangeDuty );
            }
            if( typeOf(rangeDuty) === "array" ){
                rangeDuty.each(function(unit){
                    var unitFlag = typeOf(unit) === "string" ? unit : (unit.id || unit.name);
                    if (unitFlag) rangeValues.push(unitFlag);
                }.bind(this));
            }
        }
        //if (this.json.rangeDuty && this.json.rangeDuty.length){
        //    this.json.rangeDuty.each(function(unit){
        //        var unitFlag = unit.id || unit.name;
        //        if (unitFlag) rangeValues.push(unitFlag);
        //    }.bind(this));
        //}
        if (this.json.rangeDutyField && this.json.rangeDutyField.length){
            this.json.rangeDutyField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d) rangeValues.push(d);
                }.bind(this));
            }.bind(this));
        }
        if (this.json.rangeDutyKey && this.json.rangeDutyKey.code){
            var v = this.form.Macro.exec(this.json.rangeDutyKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d) rangeValues.push(d);
            }.bind(this));
        }
        return rangeValues;
    }
});

MWF.xDesktop.requireApp("process.Xform", "Personfield", null, false);
MWF.require("MWF.widget.O2Identity", null,false);
MWF.xDesktop.requireApp("Selector", "package", null, false);
MWF.xApplication.process.Xform.Orgfield = MWF.APPOrgfield =  new Class({
	Extends: MWF.APPPersonfield,
	iconStyle: "orgfieldIcon",
    loadDescription: function(){
        if (this.isReadonly())return;
        var v = this._getBusinessData();
        if (!v || !v.length){
            if (this.json.description){
                var size = this.node.getFirst().getSize();
                var w = size.x-3;
                if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ) {
                    if (COMMON.Browser.safari) w = w - 20;
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "width": ""+w+"px",
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function( ev ){
                    this.descriptionNode.setStyle("display", "none");
                    this.clickSelect( ev );
                }.bind(this)
            });
        }
    },

	_loadUserInterface: function(){
		this.field = true;

		this._loadNode();

		if (this.json.compute == "show"){
			this._setValue(this._computeValue());
		}else{
			this._loadValue();
		}

	},
    _loadNode: function(){
        if (this.isReadonly()){
            this._loadNodeRead();
        }else{
            this._getOrgOptions();
            if (this.json.isInput){
                this._loadNodeInputEdit();
            }else{
                this._loadNodeEdit();
            }

        }
    },
    _getOrgOptions: function(){
        var selectType = typeOf( this.json.selectType ) == "array" ? this.json.selectType : [this.json.selectType];
        if( selectType.contains("unit") || selectType.contains("identity")){
            this.selectUnits = this.getSelectRange();
            if (this.json.range!=="all"){
                if (!this.selectUnits.length){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
                    return false;
                }
            }
        }else{
            this.selectUnits = [];
        }
    },
	_loadNodeRead: function(){
		this.node.empty();
		this.node.setStyle("overflow" , "hidden");
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        var node = new Element("div").inject(this.node);
	},
    _searchConfirmPerson: function(item){
        var inforNode = item.inforNode || new Element("div");
        if (item.data){
            var text = "";
            var flag = item.data.distinguishedName.substr(item.data.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = item.data.name+"("+item.data.unitName+")";
                    break;
                case "@p":
                    text = item.data.name+ (item.data.employee ? "("+item.data.employee+")" : "");
                    break;
                case "@u":
                    text = item.data.levelName;
                    break;
                case "@g":
                    text = item.data.name;
                    break;
                default:
                    text = item.data.name;
            }
            inforNode.set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });
        }else{
            inforNode.set({
                "styles": {"font-size": "14px", "color": "#bd0000"},
                "text": MWF.xApplication.process.Xform.LP.noOrgObject
            });
        }
        if (!item.inforNode){
            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: item.node,
                transition: 'flyin'
            });
            item.inforNode = inforNode;
        }

    },
    _searchOptions: function(value, callback){
        var selectType = typeOf( this.json.selectType ) == "array" ? this.json.selectType : [this.json.selectType];
        var options = {
            "type" : "",
            "types": selectType,
            "units": this.selectUnits, //范围
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
        };
        if (!this.comboxFilter) this.comboxFilter = new MWF.O2SelectorFilter(value, options);
        this.comboxFilter.filter(value, function(data){
            data.map(function(d){
                var value = Object.clone(d);
                d.value = value;
                var flag = d.distinguishedName.substr(d.distinguishedName.length-2, 2);
                switch (flag.toLowerCase()){
                    case "@i":
                        d.text = d.name+"("+d.unitName+")";
                        break;
                    case "@p":
                        d.text = d.name+(d.employee ? "("+d.employee+")" : "");
                        break;
                    case "@u":
                        d.text = d.name;
                        break;
                    case "@g":
                        d.text = d.name;
                        break;
                    default:
                        d.text = d.name;
                }
            });
            if (callback) callback(data);
        });
    },

    _resetNodeInputEdit: function(){
        var node = new Element("div", {
            "styles": {
                "overflow": "hidden",
                //"position": "relative",
                "margin-right": "20px"
            }
        }).inject(this.node, "after");
        this.node.destroy();
        this.node = node;
    },
    _loadNodeInputEdit: function(){
        var input=null;
        MWF.require("MWF.widget.Combox", function(){
            this.combox = input = new MWF.widget.Combox({
                "count": this.json.count || 0,
                "splitShow": this.json.splitShow || ", ",
                "onCommitInput": function(item){
                    this._searchConfirmPerson(item);
                    //this.fireEvent("change");
                }.bind(this),
                "onChange": function(){
                    this._setBusinessData(this.getInputData());
                    this.fireEvent("change");
                }.bind(this),
                "optionsMethod": this._searchOptions.bind(this)

            });
        }.bind(this), false);
        input.setStyles({
            "background": "transparent",
            "border": "0px"
        });
        input.set(this.json.properties);

        if (!this.json.preprocessing) this._resetNodeInputEdit();

        this.node.empty();
        input.inject(this.node);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": function (ev) {
                        this.clickSelect( ev );
                    }.bind(this)
                    //this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.combox.addEvent("change", function(){
            this.validationMode();
            if (this.validation()) this._setBusinessData(this.getInputData("change"));
        }.bind(this));
    },

    _resetNodeEdit: function(){
        var input = new Element("div", {
            "styles": {
                "background": "transparent",
                "border": "0px",
                "min-height": "24px"
            }
        });
        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "min-height": "24px"
            }}).inject(this.node, "after");
        input.inject(node);
        this.node.destroy();
        this.node = node;
    },
	_loadNodeEdit : function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        input.set(this.json.properties);
		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type,
			"readonly": true
		});
		if( !this.readonly ) {
			this.node.setStyle("cursor" , "pointer");
			this.node.addEvents({
				"click": function (ev) {
                    this.clickSelect( ev );
                }.bind(this)
                //this.clickSelect.bind(this)
			});
            if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
                this.iconNode = new Element("div", {  //this.form.css[this.iconStyle],
                    "styles": {
                        "background": "url(" + "../x_component_process_Xform/$Form/default/icon/selectorg.png) center center no-repeat",
                        "width": "18px",
                        "height": "18px",
                        "float": "right"
                    }
                }).inject(this.node, "before");
            }else if( this.form.json.nodeStyleWithhideModuleIcon ){
                this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
            }
            if (this.iconNode){
                this.iconNode.setStyle("cursor" , "pointer");
                this.iconNode.addEvents({
                    "click": function (ev) {
                        this.clickSelect( ev );
                    }.bind(this)
                    //this.clickSelect.bind(this)
                });
			}

		}
	},
    getValue: function(){
        if (!this.isReadable) return '';
        var value = this._getBusinessData();
        if( typeOf( value ) === "array" ){
            if( value.length === 0 )value = this._computeValue();
        }else if (!value){
            value = this._computeValue();
        }
        return value || "";
    },
    isEmpty: function(){
        var data = this.getData();
        if( typeOf(data) !== "array" )return true;
        if( data.length === 0 )return true;
        return false;
    },
	getData: function(when){
		if (this.json.compute == "save") this._setValue(this._computeValue());
		return this._getBusinessData();
	},
	getInputData: function(){
        if (this.json.isInput){
            if (this.combox) return this.combox.getData();
            return this._getBusinessData();
        }else{
            return this._getBusinessData();
        }
	},
    addData: function(value){
        if (!value) return false;
        value.each(function(v){
            var vtype = typeOf(v);
            if (vtype==="string"){
                var data;
                this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true); }.bind(this), null, v, false);
                if (data) this.combox.addNewValue(this.getDataText(data), data);
            }
            if (vtype==="object"){
                this.combox.addNewValue(this.getDataText(v), v);
            }
        }.bind(this));
    },
	setData: function(data) {
		this._setValue(data);
	},
	_computeValue: function(){
		var values = [];
		if (this.json.identityValue) {
			this.json.identityValue.each(function(v){ if (v) values.push(v)});
		}
		if (this.json.unitValue) {
			this.json.unitValue.each(function(v){ if (v) values.push(v)});
		}
		if (this.json.defaultValue && this.json.defaultValue.code){
            var fd = this.form.Macro.exec(this.json.defaultValue.code, this);
            if (typeOf(fd)!=="array") fd = (fd) ? [fd] : [];
            fd.each(function(fdd){
                if (fdd){
                    if (typeOf(fdd)==="string"){
                        var data;
                        this.getOrgAction()[this.getValueMethod(fdd)](function(json){ data = MWF.org.parseOrgData(json.data, true); }.bind(this), null, fdd, false);
                        values.push(data);
                    }else{
                        values.push(fdd);
                    }
                }
            }.bind(this));
		}
		if (this.json.count>0){
			return values.slice(0, this.json.count);
		}
		return values;
	},

	_getBusinessData: function(){
		if (this.json.section=="yes"){
			var data = this._getBusinessSectionData();
		}else {
			var data = this.form.businessData.data[this.json.id] || "";
		}
		if (typeOf( data ) != "array"){
            if (data) return [data];
            return [];
        }else{
		    return data;
        }
	},
    creteShowNode: function(data, islast){
        var nodeText = (data.text) ?  data.text : data;
        if (!islast) nodeText = nodeText + (this.json.splitStr || ", ");
        var node = new Element("div", {
            "styles": {
                "float": "left",
                "margin-right": "5px"
            },
            "text": nodeText
        });
        var text = "";
        if (data.value){
            var flag = data.value.distinguishedName.substr(data.value.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = data.value.name+"("+data.value.unitName+")";
                    break;
                case "@p":
                    text = data.value.name+ (data.value.employee ? "("+data.value.employee+")" : "");
                    break;
                case "@u":
                    text = data.value.levelName;
                    break;
                case "@g":
                    text = data.value.name;
                    break;
                default:
                    text = data.value.name;
            }
            var inforNode = new Element("div").set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });

            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: node,
                transition: 'flyin'
            });
        }
        return node;
    },
	_setValue: function(value){
        if (value.length==1 && !(value[0])) value=[];
        var values = [];
        var comboxValues = [];
        var type = typeOf(value);
        if (type==="array"){
            value.each(function(v){
                var data=null;
                var vtype = typeOf(v);
                if (vtype==="string"){
                    var error = (this.json.isInput) ? function(){ comboxValues.push(v); } : null;
                    this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true); }.bind(this), error, v, false);
                }
                if (vtype==="object") data = v;
                if (data){
                    values.push(data);
                    comboxValues.push({"text": this.getDataText(data),"value": data});
                }
            }.bind(this));
        }
        if (type==="string"){
            var vData;
            var error = (this.json.isInput) ? function(){ comboxValues.push(value); } : null;
            this.getOrgAction()[this.getValueMethod(value)](function(json){ vData = MWF.org.parseOrgData(json.data, true); }.bind(this), error, value, false);
            if (vData){
                values.push(vData);
                comboxValues.push({"text": this.getDataText(vData),"value": vData});
            }
        }
        if (type==="object"){
            values.push(value);
            comboxValues.push({"text": this.getDataText(value),"value": value});
        }

		this._setBusinessData(value);

        if (this.json.isInput){
            if (this.combox){
                this.combox.clear();
                this.combox.addNewValues(comboxValues);
            }else{
                var node = this.node.getFirst();
                if (node){
                    node.empty();
                    comboxValues.each(function(v, i){
                        this.creteShowNode(v, (i===comboxValues.length-1)).inject(node);
                    }.bind(this));
                }
            }

        }else {
            var input = this.node.getFirst();
            if (!input) {
                input = this.node;
            }
            input.empty();

            this.loadOrgWidget(values, input);
        }

	},
	loadOrgWidget: function(value, node){
        var disableInfor = layout.mobile ? true : false;
        if( this.json.showCard === "no" )disableInfor = true;
		var options = {"style": "xform", "canRemove":false , "onRemove" : this.removeItem,"disableInfor" : disableInfor};
		value.each(function(data){
			if( data.distinguishedName ){
				var flag = data.distinguishedName.substr(data.distinguishedName.length-2, 2);
				switch (flag.toLowerCase()){
					case "@i":
						var widget = new MWF.widget.O2Identity(data, node, options );
						break;
					case "@p":
						var widget = new MWF.widget.O2Person(data, node, options);
						break;
					case "@u":
						var widget = new MWF.widget.O2Unit(data, node, options);
						break;
					case "@g":
						var widget = new MWF.widget.O2Group(data, node, options);
						break;
					default:
						var widget = new MWF.widget.O2Other(data, node, options);
				}
				widget.field = this;
				if( layout.mobile ){
					widget.node.setStyles({
						"float" : "none"
					})
				}
			}
		}.bind(this));
	},
	removeItem : function( widget, ev ){
		//this 是 MWF.widget.O2Identity 之类的对象
		var _self = this.field; //这个才是Readerfield
		var dn = this.data.distinguishedName;
		var data = _self._getBusinessData();
		var index;
		data.each( function ( d , i){
			if( d.distinguishedName == dn ){
				index = i
			}
		});
		data.splice( index, 1 );
		_self._setBusinessData( data );
		this.node.destroy();
		ev.stopPropagation();
	},
	_loadValue: function(){
		this._setValue(this.getValue());
	},
	clickSelect: function( ev ){

        this.validationMode();
		var count = (this.json.count) ? this.json.count : 0;

		var selectType = typeOf( this.json.selectType ) == "array" ? this.json.selectType : [this.json.selectType];
		// if( selectType.contains("unit") || selectType.contains("identity")){
		// 	var selectUnits = this.getSelectRange();
		// 	if (this.json.range!=="all"){
		// 		if (!selectUnits.length){
		// 			this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
		// 			return false;
		// 		}
		// 	}
		// }else{
		// 	var selectUnits = [];
		// }
        var selectUnits = this.selectUnits;
		if( !selectType[0] ){
			this.form.notice(MWF.xApplication.process.Xform.LP.noSelectType, "error", this.node);
			return false;
		}

        var exclude = [];
        if( this.json.exclude ){
            var v = this.form.Macro.exec(this.json.exclude.code, this);
            exclude = typeOf(v)==="array" ? v : [v];
        }

        var options = {
			"type" : "",
			"types": selectType,
			"values" : (this.json.isInput) ? [] : this._getBusinessData(),
			"count": count,
			"units": selectUnits, //范围
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
            "exclude" : exclude,
            "expandSubEnable" : (this.json.expandSubEnable=="no") ? false : true,
			//"expand" : false,
			"onComplete": function(items, itemsObject){
				var values = [];
				items.each( function(it){
					values.push(MWF.org.parseOrgData(it.data));
				});
                if (this.json.isInput){
                    this.addData(values);
                }else{
                    this.setData(values);
                }

				//this.setData( values );
				this.validation();
                this.fireEvent("select");
			}.bind(this),
			"onCancel": function(){
				this.validation();
			}.bind(this),
			"onLoad": function(){
				if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
			}.bind(this),
			"onClose": function(){
				//var v = this.node.getFirst().get("value");
				var v = this.getInputData();
				if (!v || !v.length) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");

			}.bind(this)
		};
        if( this.form.json.selectorStyle )options = Object.merge( options, this.form.json.selectorStyle );

        if( this.selector && this.selector.loading ) {
        }else if( this.selector && this.selector.selector && this.selector.selector.active ){
        }else{
            this.selector = new MWF.O2Selector(this.form.app.content, options);
        }
	},
    _loadStyles: function(){
        if (this.isReadonly()){
            if (this.json.styles) this.node.setStyles(this.json.styles);
        }else{
            if (this.json.styles) this.node.setStyles(this.json.styles);
            if (this.json.inputStyles) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
            if (this.iconNode && this.iconNode.offsetParent !== null ){
                var size = this.node.getSize();
                this.iconNode.setStyle("height", ""+size.y+"px");
            }
        }
    }
}); 

MWF.xApplication.process.Xform = MWF.xApplication.process.Xform || {};
MWF.xApplication.process.Xform.Package = true;
MWF.require('MWF.xScript.Macro', null, false);
MWF.xDesktop.requireApp('process.Xform', '$Module', null, false);

MWF.xApplication.process.Xform.require = function (callback) {
    var modules = [
        // ["process.Xform", "Form"],
        ['process.Xform', 'Label'],
        ['process.Xform', 'Textfield'],
        ['process.Xform', 'Number'],
        ['process.Xform', 'Currency'],
        ['process.Xform', 'Personfield'],
        ['process.Xform', 'Orgfield'],
        ['process.Xform', 'Org'],
        ['process.Xform', 'Calendar'],
        ['process.Xform', 'Textarea'],
        ['process.Xform', 'Opinion'],
        ['process.Xform', 'Select'],
        ['process.Xform', 'Radio'],
        ['process.Xform', 'Checkbox'],
        ['process.Xform', 'Button'],
        ['process.Xform', 'Combox'],
        ['process.Xform', 'Address'],
        ['process.Xform', 'Table'],
        ['process.Xform', 'Datagrid'],
        ['process.Xform', 'Datatable'],
        ['process.Xform', 'Datatemplate'],
        ['process.Xform', 'Tab'],
        ['process.Xform', 'Tree'],
        ['process.Xform', 'Iframe'],
        ['process.Xform', 'Htmleditor'],
        ['process.Xform', 'TinyMCEEditor'],
        ['process.Xform', 'Office'],
        ['process.Xform', 'YozoOffice'],
        ['process.Xform', 'OnlyOffice'],
        ['process.Xform', 'WpsOffice'],
        ['process.Xform', 'WpsOffice2'],
        ['process.Xform', 'Attachment'],
        ['process.Xform', 'Actionbar'],
        ['process.Xform', 'Sidebar'],
        ['process.Xform', 'Log'],
        ['process.Xform', 'Monitor'],
        ['process.Xform', 'View'],
        ['process.Xform', 'ViewSelector'],
        ['process.Xform', 'Stat'],
        ['process.Xform', 'ImageClipper'],
        ['process.Xform', 'WritingBoard'],
        ['process.Xform', 'Subform'],
        ['process.Xform', 'Widget'],
        ['process.Xform', 'Source'],
        ['process.Xform', 'SourceText'],
        ['process.Xform', 'SubSource'],
        ['process.Xform', 'Div'],
        ['process.Xform', 'Common'],
        ['process.Xform', 'Image'],
        ['process.Xform', 'Html'],
        ['process.Xform', 'Statement'],
        ['process.Xform', 'StatementSelector'],
        ['process.Xform', 'Importer'],
        ['process.Xform', 'ReadLog'],
        ['process.Xform', 'Relatedlink'],
        ['process.Xform', 'AssociatedDocument'],
        ['process.Xform', 'Security'],
        ['process.Xform', 'OOInput'],
        ['process.Xform', 'OOButton'],
        ['process.Xform', 'OORadioGroup'],
        ['process.Xform', 'OOCheckGroup'],
        ['process.Xform', 'OOSelect'],
        ['process.Xform', 'OOAddress'],
        ['process.Xform', 'OOTextarea'],
        ['process.Xform', 'OODatetime'],
        ['process.Xform', 'OOOrg'],
        ['process.Xform', 'OOCurrency'],
        ['process.Xform', 'OOLog'],
        ['process.Xform', 'OOPagination'],
    ];
    MWF.xDesktop.requireApp(modules, null, function () {
        if (callback) callback();
    });
};

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xApplication.process.Xform.PdfView = MWF.APPPdfView =  new Class({
    Extends: MWF.APP$Module,
    options:{
        "moduleEvents": [
            "afterOpen"
        ]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;

        if (this.json.isReadonly || this.form.json.isReadonly){
            this.mode  = "read";
        }else{
            if (this.json.readScript && this.json.readScript.code){
                var flag = this.form.Macro.exec(this.json.readScript.code, this);
                if (flag){
                    this.mode = "read";
                }
            }
        }

    },
    _loadUserInterface: function(){
        this.node.empty();
    },
    _afterLoaded: function(){
        if(this.mode !== "read"){
            this.createUpload();
        }

        this.data = this.getData();
        this.documentId = this.data.documentId;
        if(this.data.documentId === ""){
            this.createEmpty();
        }else {

            this.loadPdfView();
        }
    },
    createEmpty : function (){
        this.emptyNode = new Element("div").inject(this.node);
        this.emptyNode.set("text",MWF.xApplication.process.Xform.LP.pdfview.nofile);
    },
    createUpload : function (){


        this.uploadNode = new Element("div",{"style":"margin:10px;"}).inject(this.node);

        var uploadBtn = new Element("button",{"text":MWF.xApplication.process.Xform.LP.pdfview.upload,"style":"margin-left: 15px; color: rgb(255, 255, 255); cursor: pointer; height: 26px; line-height: 26px; padding: 0px 10px; min-width: 40px; background-color: rgb(74, 144, 226); border: 1px solid rgb(82, 139, 204); border-radius: 15px;"}).inject(this.uploadNode);
        uploadBtn.addEvent("click",function (){
            o2.require("o2.widget.Upload", null, false);

            if(this.documentId === ""){
                var upload = new o2.widget.Upload(this.form.app.content, {
                    "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                    "method": "uploadAttachment",
                    "parameter": {
                        "id": this.form.businessData.work.id
                    },
                    "accept" : "application/pdf",
                    "data":{
                        "site": "pdfAttachement"
                    },
                    "onCompleted": function(json){
                        this.documentId = json.data.id;
                        this.setData();
                        this.loadPdfView();
                    }.bind(this)
                });
            }else {
                var upload = new o2.widget.Upload(this.form.app.content, {
                    "action": o2.Actions.get("x_processplatform_assemble_surface").action,
                    "method": "replaceAttachment",
                    "parameter": {
                        "id" : this.documentId,
                        "workid": this.form.businessData.work.id
                    },
                    "accept" : "application/pdf",
                    "data":{
                    },
                    "onCompleted": function(json){
                        this.documentId = json.data.id;
                        this.setData();
                        this.loadPdfView();
                    }.bind(this)
                });
            }

            upload.load();
        }.bind(this));

    },
    getData: function(){
        var data = {
            "documentId" : ""
        };
        if(this.form.businessData.data[this.json.id]){
            data.documentId = this.form.businessData.data[this.json.id].documentId;
        }
        return data;
    },
    setData: function(){

        var data = {
            "documentId" : this.documentId
        };
        this._setBusinessData(data);
    },
    loadPdfView: function(){

        this.iframeNode = new Element("div").inject(this.node);
        this.iframeNode.setStyles({
            "height": "100%"
        });

        var host = o2.Actions.getHost( "x_processplatform_assemble_surface" );
        var fileUrl = o2.filterUrl(host + "/x_processplatform_assemble_surface/jaxrs/attachment/download/" + this.documentId);

        if(this.iframe){
            this.iframe.set("src","../o2_lib/pdfjs/web/viewer.html?file=" + fileUrl);
        }else {
            this.iframe = new Element("iframe").inject(this.iframeNode);
            this.iframe.set("src","../o2_lib/pdfjs/web/viewer.html?file=" + fileUrl);
            this.iframe.set("scrolling","no");
            this.iframe.set("frameborder",0);
            this.iframe.setStyles({
                "height" : "100%",
                "width" : "100%"
            });
        }
        if(this.emptyNode) this.emptyNode.hide();
        this.fireEvent("afterOpen");
    },

    hide: function(){
        this.node.hide();
    },
    show: function(){
        this.node.show();
    },
    isEmpty : function(){
    },
    save: function(){

    },
    validation: function(){return true}
});

MWF.xDesktop.requireApp("process.Xform", "$Selector", null, false);
MWF.require("MWF.widget.UUID", null, false);
/** @class Radio 单选按钮。
 * @o2cn 单选按钮
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * @extends MWF.xApplication.process.Xform.$Selector
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Radio = MWF.APPRadio =  new Class(
    /** @lends MWF.xApplication.process.Xform.Radio# */
    {
	Implements: [Events],
	Extends: MWF.APP$Selector,
        /**
         * 组件加载后触发。如果选项加载为异步，则异步处理完成后触发此事件
         * @event MWF.xApplication.process.Xform.Radio#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */


        /**
         * 值改变时触发。可以通过this.event获取修改后的选择项（Dom对象）。
         * @event MWF.xApplication.process.Xform.Radio#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */

    /**
     * @ignore
     * @member {Element} descriptionNode
     * @memberOf MWF.xApplication.process.Xform.Radio#
     */
    loadDescription: function(){},
    _loadNode: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                this._loadNodeEdit();
            }
        }
    },
    _loadMergeReadContentNode: function( contentNode, data ){
        this._showValue(contentNode, data.data)
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        var value = this.getValue();
        this._showValue(this.node, value);
    },
    __showValue: function(node, value, optionItems){
        if (value){
            var texts = "";
            for (var i=0; i<optionItems.length; i++){
                var item = optionItems[i];
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                if (value == v){
                    texts = t;
                    break;
                }
            }
            node.set("text", texts);
        }
    },
    _resetNodeEdit: function(){
        var div = new Element("div");
        div.set(this.json.properties);
        div.inject(this.node, "after");

        this.node.destroy();
        this.node = div;
    },
    _loadNodeEdit: function(){
		//this.container = new Element("select");
        if (!this.json.preprocessing) this._resetNodeEdit();

		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type
		});
		if( this.json.recoveryStyles && this.json.recoveryStyles.display ){
            this.node.setStyle("display", this.json.recoveryStyles.display);
		}else if( this.json.styles && this.json.styles.display ){
            this.node.setStyle("display", this.json.styles.display);
        }else{
            this.node.setStyle("display", "inline");
        }
		this.setOptions();
	},
    _loadDomEvents: function(){
    },
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!=-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    //this.node.addEvent(key, function(event){
                    //    return this.form.Macro.fire(e.code, this, event);
                    //}.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            var inputs = this.node.getElements("input");
            inputs.each(function(input){
                input.addEvent(key, function(event){
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            }.bind(this));
        }
    },

    isNumber : function( d ){
        return parseInt(d).toString() !== "NaN"
    },
	_setOptions: function(optionItems){
        var p = o2.promiseAll(optionItems).then(function(radioValues){
            this.moduleSelectAG = null;

            if (!radioValues) radioValues = [];
            var node;
            if (o2.typeOf(radioValues)==="array"){
                var flag = (new MWF.widget.UUID).toString();
                radioValues.each(function(item, i){
                    var tmps = item.split("|");
                    var text = tmps[0];
                    var value = tmps[1] || text;

                    if( !this.isNumber(this.json.countPerline) ) {
                        if( this.json.newline ){
                            node = new Element("div").inject(this.node);
                        }else{
                            node = this.node;
                        }
                    }else{
                        var countPerLine = this.json.countPerline.toInt();
                        if( countPerLine === 0 && i===0 ){
                            node = new Element("div").inject(this.node);
                        }else if( i % countPerLine === 0){
                            node = new Element("div").inject(this.node);
                        }
                    }

                    var radio = new Element("input", {
                        "type": "radio",
                        "name": (this.json.properties && this.json.properties.name) ? this.json.properties.name : flag+this.json.id,
                        "value": value,
                        "showText": text,
                        "styles": this.json.buttonStyles
                    }).inject(node);
                    //radio.appendText(text, "after");



                    var textNode = new Element( "span", {
                        "text" : text,
                        "styles" : { "cursor" : "default" }
                    }).inject(node);
                    textNode.addEvent("click", function( ev ){
                        if( this.radio.get("disabled") === true || this.radio.get("disabled") === "true" )return;
                        this.radio.checked = true;
                        this.radio.fireEvent("change", [this.radio]);
                        this.radio.fireEvent("click");
                    }.bind( {radio : radio} ) );

                    radio.addEvent("click", function(){
                        this.validationMode();
                        if (this.validation()) {
                            this._setBusinessData(this.getInputData("change"));
                            this.fireEvent("change", [radio]);
                        }
                    }.bind(this));

                    Object.each(this.json.events, function(e, key){
                        if (e.code){
                            if (this.options.moduleEvents.indexOf(key)!=-1){
                            }else{
                                radio.addEvent(key, function(event){
                                    return this.form.Macro.fire(e.code, this, event);
                                }.bind(this));
                            }
                        }
                    }.bind(this));
                }.bind(this));
            }
        }.bind(this), function(){
            this.moduleSelectAG = null;
        }.bind(this));
        this.moduleSelectAG = p;
        if (p) p.then(function(){
            this.moduleSelectAG = null;
        }.bind(this), function(){
            this.moduleSelectAG = null;
        }.bind(this));

        // this.moduleSelectAG = o2.AG.all(optionItems).then(function(radioValues){
        //     this.moduleSelectAG = null;
        //
        //     if (!radioValues) radioValues = [];
        //     if (o2.typeOf(radioValues)==="array"){
        //         var flag = (new MWF.widget.UUID).toString();
        //         radioValues.each(function(item){
        //             var tmps = item.split("|");
        //             var text = tmps[0];
        //             var value = tmps[1] || text;
        //
        //             var radio = new Element("input", {
        //                 "type": "radio",
        //                 "name": (this.json.properties && this.json.properties.name) ? this.json.properties.name : flag+this.json.id,
        //                 "value": value,
        //                 "showText": text,
        //                 "styles": this.json.buttonStyles
        //             }).inject(this.node);
        //             //radio.appendText(text, "after");
        //
        //             var textNode = new Element( "span", {
        //                 "text" : text,
        //                 "styles" : { "cursor" : "default" }
        //             }).inject(this.node);
        //             textNode.addEvent("click", function( ev ){
        //                 if( this.radio.get("disabled") === true || this.radio.get("disabled") === "true" )return;
        //                 this.radio.checked = true;
        //                 this.radio.fireEvent("change");
        //                 this.radio.fireEvent("click");
        //             }.bind( {radio : radio} ) );
        //
        //             radio.addEvent("click", function(){
        //                 this.validationMode();
        //                 if (this.validation()) this._setBusinessData(this.getInputData("change"));
        //             }.bind(this));
        //
        //             Object.each(this.json.events, function(e, key){
        //                 if (e.code){
        //                     if (this.options.moduleEvents.indexOf(key)!=-1){
        //                     }else{
        //                         radio.addEvent(key, function(event){
        //                             return this.form.Macro.fire(e.code, this, event);
        //                         }.bind(this));
        //                     }
        //                 }
        //             }.bind(this));
        //         }.bind(this));
        //     }
        // }.bind(this))
        // if (this.moduleSelectAG) this.moduleSelectAG.then(function(){
        //     this.moduleSelectAG = null;
        // }.bind(this));
	},

    _setValue: function(value, m, fireChange){
        var mothed = m || "__setValue";
	    if (!!value){
            var p = o2.promiseAll(value).then(function(v){
                if (o2.typeOf(v)=="array") v = v[0];
                if (this.moduleSelectAG){
                    this.moduleValueAG = this.moduleSelectAG;
                    this.moduleSelectAG.then(function(){
                        this[mothed](v, fireChange);
                        return v;
                    }.bind(this), function(){});
                }else{
                    this[mothed](v, fireChange)
                }
                return v;
            }.bind(this), function(){});

            this.moduleValueAG = p;
            if (this.moduleValueAG) this.moduleValueAG.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
        }else{
            this[mothed](value, fireChange);
        }


        // this.moduleValueAG = o2.AG.all(value).then(function(v){
        //     if (o2.typeOf(v)=="array") v = v[0];
        //     if (this.moduleSelectAG){
        //         this.moduleValueAG = this.moduleSelectAG;
        //         this.moduleSelectAG.then(function(){
        //             this.__setValue(v);
        //         }.bind(this));
        //     }else{
        //         this.__setValue(v)
        //     }
        //     return v;
        // }.bind(this));
        //
        // if (this.moduleValueAG) this.moduleValueAG.then(function(){
        //     this.moduleValueAG = null;
        // }.bind(this));
    },

    __setValue: function(value){
        this.moduleValueAG = null;
        this._setBusinessData(value);

        if (this.isReadonly()){
            this._loadNodeRead();
        }else{
            var radios = this.node.getElements("input");
            for (var i=0; i<radios.length; i++){
                var radio = radios[i];
                if (radio.value==value){
                    radio.checked = true;
                    break;
                }
            }
        }
        this.fieldModuleLoaded = true;
	},

	_getInputTextData: function(){
		var inputs = this.node.getElements("input");
		var value = "";
		var text = "";
		if (inputs.length){
			for (var i=0; i<inputs.length; i++){
				var input = inputs[i];
				if (input.checked){
					value = input.get("value");
					text = input.get("showText");
					break;
				}
			}
		}
		return {"value": [value || ""] , "text": [text || value || ""]};
	},
    /**
     * @summary 获取选中项的text。
     * @return {String} 返回选中项的text
     * @example
     * var text = this.form.get('fieldId').getText(); //获取选中项的文本
     */
    getText: function(){
		var d = this.getTextData();
		if( typeOf(d.then) === "function" ){
			return d.then(function( d1 ){
				var texts = d1.text;
				return (texts && texts.length) ? texts[0] : "";
			})
		}else{
			var texts = d.text;
			return (texts && texts.length) ? texts[0] : "";
		}
	},
    getInputData: function(){
        if (this.isReadonly()){
            return this._getBusinessData();
        }else{
            var inputs = this.node.getElements("input");
            var value = "";
            if (inputs.length){
                for (var i=0; i<inputs.length; i++){
                    var input = inputs[i];
                    if (input.checked){
                        value = input.get("value");
                        break;
                    }
                }
            }
            return value;
        }
	},
    resetData: function(){
        this.setData(this.getValue());
    },

    /**
     * @summary 获取选中的Dom对象。
     * @return {Element} 返回选中的Dom对象
     * @example
     * var input = this.form.get('fieldId').getSelectedInput();
     */
    getSelectedInput: function(){
        var inputs = this.node.getElements("input");
        if (inputs.length){
            for (var i=0; i<inputs.length; i++){
                if (inputs[i].checked) return inputs[i];
            }
        }
        return null;
    },

    setData: function(data, fireChange){
        return this._setValue(data, "__setData", fireChange);
        // if (data && data.isAG){
        //     this.moduleValueAG = o2.AG.all(data).then(function(v){
        //         if (o2.typeOf(v)=="array") v = v[0];
        //         this.__setData(v);
        //     }.bind(this));
        // }else{
        //     this.__setData(data);
        // }

        // if (data && data.isAG){
        //     this.moduleValueAG = data;
        //     data.addResolve(function(v){
        //         this.setData(v);
        //     }.bind(this));
        // }else{
        //     this.__setData(data);
        //     this.moduleValueAG = null;
        // }
    },

    __setData: function(data, fireChange){
        this.moduleValueAG = null;
        var old = this.getInputData();
        this._setBusinessData(data);
		var inputs = this.node.getElements("input");
		
		if (inputs.length){
			for (var i=0; i<inputs.length; i++){
				if (data==inputs[i].get("value")){
					inputs[i].set("checked", true);
				}else{
					inputs[i].set("checked", false);
				}
			}
            this.validationMode();
		}
        this.fieldModuleLoaded = true;
        this.fireEvent("setData");
        if (fireChange && old!==data) this.fireEvent("change");
	},

    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("background", this.node.getStyles("background"));
            this.node.setStyle("background", "#ffdcdc");

            this.errNode = this.createErrorNode(text);
            if (this.iconNode){
                this.errNode.inject(this.iconNode, "after");
            }else{
                this.errNode.inject(this.node, "after");
            }
            this.showNotValidationMode(this.node);

            if (!this.errNode.isIntoView()) this.errNode.scrollIntoView(false);
        }
    },

    validationMode: function(routeName, opinion){
        // if (!this.validationConfig(routeName, opinion))  return false;

        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("background"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },

    getExcelData: function( type ){
		var value = this.getData();
		if( type === "value" )return value;

		var options = this.getOptionsObj();
		return Promise.resolve(options).then(function (opts) {
			var idx = opts.valueList.indexOf( value );
			var text = idx > -1 ? opts.textList[ idx ] : "";
			return text;
		});
	},
    setExcelData: function(d, type){
		var value = d.replace(/&#10;/g,""); //换行符&#10;
		this.excelData = value;
		if( type === "value" ){
			this.setData(value, true);
		}else{
            var options = this.getOptionsObj();
            this.moduleExcelAG = Promise.resolve(options).then(function (opts) {
                var idx = opts.textList.indexOf( value );
                value = idx > -1 ? opts.valueList[ idx ] : "";
                this.setData(value, true);
                this.moduleExcelAG = null;
            }.bind(this));
	    }
	}
	
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);

/** @class ReadLog 阅读记录组件。
 * @o2cn 阅读记录组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var log = this.form.get("name"); //获取组件
 * //方法2
 * var log = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.ReadLog = MWF.APPReadLog =  new Class(
    /** @lends MWF.xApplication.process.Xform.ReadLog# */
    {
        Extends: MWF.APP$Module,
        options: {
            /**
             * 加载数据后事件。
             * @event MWF.xApplication.process.Xform.ReadLog#postLoadData
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             * @example
             * //触发该事件的时候可以获取到流程数据ReadLog
             * var readLog = this.target.readLog;
             * //可以修改readLog达到定制化流程记录的效果
             * do something
             */

            /**
             * 加载每行流程信息以后触发，可以通过this.event获得下列信息：
             * <pre><code>
             *{
             * "data" : {}, //当前行记录信息，如果是已阅未单条记录（对象），如果是待阅有多条记录（数组）
             * "node" : node, //当前节点
             * "log" : object, //指向阅读记录
             * "type" : "readCompleted"  //"read"表示待阅，"readCompleted"表示已阅
             *}
             </code></pre>
             * @event MWF.xApplication.process.Xform.ReadLog#postLoadLine
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "moduleEvents": ["load", "queryLoad", "postLoad", "postLoadData", "postLoadLine"]
        },
        load: function(){
            this._queryLoaded();
            this.node.empty();
            if (!this.json.isDelay){
                this.active();
            }
        },
        /**
         * 激活阅读记录。设置了延迟加载的时候，可以通过这个方法来激活
         * @example
         * this.form.get("fieldId").active();
         */
        active: function(){
            this._loadModuleEvents();
            if (this.fireEvent("queryLoad")){
                this._queryLoaded();
                this._loadUserInterface();
                this._loadStyles();
                this._loadDomEvents();
                //this._loadEvents();

                this._afterLoaded();
                this.fireEvent("postLoad");
                this.fireEvent("load");
            }
        },
        _loadUserInterface: function(){
            this.node.setStyle("-webkit-user-select", "text");
            this.node.setStyles(this.form.css.logActivityNode_read);

            this.form.app.action.getReadRecord(this.form.businessData.work.id, function(json){
                this.readLog = json.data;
                this.fireEvent("postLoadData");
                this.loadReadLog();
            }.bind(this));
        },
        loadReadLog: function(){
            switch (this.json.mode){
                case "notShow":
                    return "";
                case "script":
                    this.loadReadLogByScript();
                    break;
                default:
                    this.loadReadLogDefault();
            }
        },
        loadReadLogByScript: function(){
            if (this.json.displayScript && this.json.displayScript.code){
                var code = this.json.displayScript.code;
                this.readLog.each(function(log){
                    if (!this.json.isShowRead && log.type === "read"){
                        //不显示待阅
                    }else{
                        this.form.Macro.environment.log = log;
                        this.form.Macro.environment.list = null;
                        var r = this.form.Macro.exec(code, this);
                        var t = o2.typeOf(r);
                        var lineNode;
                        if (t==="string"){
                            lineNode = new Element("div", {
                                html: r
                            }).inject(this.node);
                            //this.node.appendHTML(r);
                        }else if (t==="element"){
                            lineNode = this.node.appendChild(r);
                        }
                        this.fireEvent("postLoadLine",[{
                            "data" : log,
                            "node" : lineNode,
                            "log" : this,
                            "type" : "readCompleted"
                        }]);
                    }

                }.bind(this));
            }
        },
        loadReadLogDefault: function(){
            var text = this.json.textStyle;
            var readPersons = [];
            var readLogs = [];
            this.lineClass = "logTaskNode";
            this.readLog.each(function(log, i){

                if (this.json.textStyleScript && this.json.textStyleScript.code){
                    this.form.Macro.environment.log = log;
                    this.form.Macro.environment.list = null;
                    text = this.form.Macro.exec(this.json.textStyleScript.code, this);
                }

                if (log.type == "readCompleted"){
                    var div = new Element("div", {styles: this.form.css[this.lineClass]}).inject(this.node);
                    var leftDiv = new Element("div", {styles: this.form.css.logTaskIconNode_record}).inject(div);
                    var rightDiv = new Element("div", {styles: this.form.css.logTaskTextNode}).inject(div);
                    var html = text.replace(/{person}/g, o2.name.cn(log.person || ""))
                        .replace(/{datetime}/g, log.completedTime)
                        .replace(/{date}/g, log.completedTime.substring(0.10))
                        .replace(/{startDatetime}/g, log.startTime)
                        .replace(/{startDate}/g, log.startTime.substring(0.10))
                        .replace(/{startDatetime}/g, log.startTime)
                        .replace(/{unit}/g, o2.txt(o2.name.cn(log.unit)))
                        .replace(/{department}/g, o2.txt(o2.name.cn(log.unit)))
                        .replace(/{identity}/g, o2.name.cn(log.identity))
                        .replace(/{activity}/g, o2.txt(o2.name.cn(log.activityName)))
                        .replace(/{title}/g, o2.txt(log.title) || "")
                        .replace(/{opinion}/g, o2.txt(log.opinion) || "");
                    rightDiv.appendHTML(html);

                    if (this.lineClass === "logTaskNode"){
                        this.lineClass = "logTaskNode_even";
                    }else{
                        this.lineClass = "logTaskNode";
                    }

                    this.fireEvent("postLoadLine",[{
                        "data" : log,
                        "node" : div,
                        "log" : this,
                        "type" : "readCompleted"
                    }]);
                }
                if (!!this.json.isShowRead && log.type == "read"){
                    readPersons.push(o2.name.cn(log.person)+"("+o2.name.cn(log.unit)+")");
                    readLogs.push(log);
                }
            }.bind(this));
            if (readPersons.length){
                var div = new Element("div", {styles: this.form.css[this.lineClass]}).inject(this.node);
                var leftDiv = new Element("div", {styles: this.form.css.logTaskIconNode_record}).inject(div);
                var rightDiv = new Element("div", {styles: this.form.css.logTaskTextNode}).inject(div);
                leftDiv.setStyle("background-image", "url("+"../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)");
                rightDiv.appendHTML("<div><font style='font-weight: bold'>"+MWF.xApplication.process.Xform.LP.showReadTitle+": </font><font style='color: #00F'>"+readPersons.join(", ")+"</font></div>");
                this.fireEvent("postLoadLine",[{
                    "data" : readLogs,
                    "node" : div,
                    "log" : this,
                    "type" : "read"
                }]);
            }
        }
    });

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Relatedlink 相关推荐组件，本组件根据其当前流程实例的相关性分数列式其他流程实例（带权限）。
 * @o2cn 相关推荐组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var relatedlink = this.form.get("relatedlink"); //获取组件
 * //方法2
 * var relatedlink = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @since v7.3
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Relatedlink = MWF.APPRelatedlink =  new Class(
    /** @lends MWF.xApplication.process.Xform.Relatedlink# */
    {
	Implements: [Events],
    Extends: MWF.xApplication.process.Xform.$Module,
    options: {
        /**
         * 加载数据后事件。
         * @event MWF.xApplication.process.Xform.Relatedlink#postLoadData
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         * @example
         * //触发该事件的时候可以获取到链接数据linkData
         * var linkData = this.target.linkData;
         * //可以修改linkData达到定制化链接数据的效果
         * do something
         */
        /**
         * 创建每行需要导入的数据后触发，this.event指向当前链接对象。
         * @event MWF.xApplication.process.Xform.Relatedlink#postLoadLink
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         * @example
         * <caption>this.event格式如下：</caption>
         * {
         *  node: DomElement,
         *  data: {
         *   "title", "标题一",
         *    ...
         *  }
         * }
         */
        "moduleEvents": ["queryLoad","postLoad", "afterLoad", "postLoadData", "postLoadLink"]
    },
    _loadUserInterface: function(){
        this.node.empty();
        this.node.setStyle("-webkit-user-select", "text");

        switch (this.json.activeType) {
            case "click":
                this.loadButton();
                break;
            case "delay":
                break;
            case "immediately":
                this.loadContent();
                break;
        }
    },
    loadButton: function(){
        this.buttonNode = new Element("div.rlbutton", {
            "styles": this.json.buttonStyles || {},
            "text": this.json.buttonText,
            "events":{
                click: function () {
                    this.active();
                    this.buttonNode.destroy();
                    this.buttonNode = null;
                }.bind(this)
            }
        }).inject( this.node );
    },
    /**
     * @summary 当相关推荐被设置为延迟激活，通过active方法激活
     * @param {Function} callback 激活后的回调
     * @example
     * var relativeLink = this.form.get("fieldId");
     * relativeLink.active(function(){
     *     //do someting
     * })
     */
    active: function( callback ){
	    if( !this.loaded ){
	        this.loadContent( callback );
	    }else{
	        if(callback)callback();
        }
    },
    loadContent: function( callback ){
        o2.Actions.load("x_query_assemble_surface").MoreLikeThisAction.post({
            flag: this.getFlag(),
            category: this.getCategory(),
            count: (this.json.count || 6).toInt()
        }, function(json){
            this.linkData = json.data.moreLikeThisList;
            this.fireEvent("postLoadData");
            this.loadLinks();
            this.loaded = true;
            this.fireEvent("afterLoad");
            if(callback)callback();
        }.bind(this));
    },
    getFlag: function(){
        return this.form.businessData.work.id;
        // if (this.form.businessData.work && !this.form.businessData.work.completedTime) {
        //     return this.form.businessData.work.id;
        // } else {
        //     return this.form.businessData.workCompleted.id;
        // }
    },
    getCategory: function(){
        return "processPlatform";
    },
    loadLinks: function(){
        switch (this.json.mode){
            case "script":
                this.loadLinkByScript();
                break;
            case "text":
                this.loadLinkDefault();
                break;
            default:
                this.loadLinkTable();
        }
    },
    loadLinkTable: function(){
        var table = new Element("table", {
            "styles": this.json.tableStyles || this.form.css.relatedlinkTable,
            "border": "0",
            "cellSpacing": "0",
            "cellpadding": "3px",
            "width": "100%"
        }).inject(this.node);
        var tr = table.insertRow(0); //.setStyles( this.form.css.relatedlinkTableTitleLine );

        var lp = MWF.xApplication.process.Xform.LP;
        var thStyle = this.json.tableTitleCellStyles || this.form.css.relatedlinkTableTitle;
        var td = tr.insertCell(0).setStyles(thStyle);
        td.set("text", lp.title);
        td = tr.insertCell(1).setStyles(thStyle);
        td.set("text", lp.creatorPerson);
        td = tr.insertCell(2).setStyles(thStyle);
        td.set("text", lp.creatorUnit);
        td = tr.insertCell(3).setStyles(thStyle);
        td.set("text", lp.createTime);
        td = tr.insertCell(4).setStyles(thStyle);
        td.set("text", lp.updateTime);
        td = tr.insertCell(5).setStyles(thStyle);
        td.set("text", lp.score);

        var tdStyle = this.json.tableContentCellStyles || this.form.css.relatedlinkTableCell;
        this.linkData.each(function (log, idx) {
            var tr = table.insertRow(table.rows.length);
            tr.setStyles( this.json.tableContentLineStyles || this.form.css.relatedlinkTableLine );
            tr.addEvents({
                "mouseover": function () {
                    tr.setStyles( this.json.tableContentLineStyles_over || this.form.css.relatedlinkTableLine_over )
                }.bind(this),
                "mouseout": function () {
                    tr.setStyles( this.json.tableContentLineStyles || this.form.css.relatedlinkTableLine )
                }.bind(this)
            })

            var td = tr.insertCell(0).setStyles( tdStyle );
            td.set("text", log.title);
            td.setStyles( this.json.tableContentCellStyles_title || this.form.css.relatedlinkTableCell_title );

            td = tr.insertCell(1).setStyles(tdStyle);
            td.set("text", log.creatorPerson);
            td = tr.insertCell(2).setStyles(tdStyle);
            td.set("text", log.creatorUnit);
            td = tr.insertCell(3).setStyles(tdStyle);
            td.set("text", log.createTime);
            td = tr.insertCell(4).setStyles(tdStyle);
            td.set("text", log.updateTime);
            td = tr.insertCell(5).setStyles(tdStyle);
            td.set("text", log.score);

            this.setOpenEvent(tr, log);

            this.fireEvent("postLoadLink", [{
                node: tr,
                data: log
            }]);
        }.bind(this))
    },
    loadLinkByScript: function(){
        if (this.json.displayScript && this.json.displayScript.code){
            var code = this.json.displayScript.code;
            this.linkData.each(function(log){
                this.form.Macro.environment.link = log;
                var r = this.form.Macro.exec(code, this);

                var t = o2.typeOf(r);
                if (t==="string"){
                    this.node.appendHTML(r);
                }else if (t==="element"){
                    this.node.appendChild(r);
                }
                var node = this.node.getLast();
                this.setOpenEvent(node, log);
                this.fireEvent("postLoadLink", [{
                    node: node,
                    data: log
                }]);
            }.bind(this));
        }
    },
    loadLinkDefault: function(){
        var text = this.json.textStyle;
        var readPersons = [];
        this.lineClass = "relatedlinkNode";
        this.linkData.each(function(log, i){
            var div = new Element("div", {styles: this.form.css[this.lineClass]}).inject(this.node);
            var rightDiv = new Element("div", {styles: this.form.css.relatedlinkTextNode}).inject(div);
            var html = text.replace(/{flag}/g, log.flag)
                .replace(/{createDate}/g, log.createTime.substring(0.10))
                .replace(/{createTime}/g, log.createTime)
                .replace(/{updateDate}/g, log.updateTime.substring(0.10))
                .replace(/{updateTime}/g, log.updateTime)
                .replace(/{creatorUnit}/g, o2.name.cn(log.creatorUnit))
                .replace(/{creatorPerson}/g, o2.name.cn(log.creatorPerson))
                .replace(/{title}/g, log.title || "");
            rightDiv.appendHTML(html);

            if (this.lineClass === "relatedlinkNode"){
                this.lineClass = "relatedlinkNode_even";
            }else{
                this.lineClass = "relatedlinkNode";
            }
            this.setOpenEvent(div, log);
            this.fireEvent("postLoadLink", [{
                node: div,
                data: log
            }]);
        }.bind(this));
    },
    setOpenEvent: function(node, data){
        node.setStyle("cursor", "pointer");
        if (data.category==="cms"){
            node.addEvent("click", function(ev){
                this.openCMSDocument( data, false);
                ev.stopPropagation();
            }.bind(this));
        }else{
            node.addEvent("click", function(ev){
                this.openWork(data);
                ev.stopPropagation();
            }.bind(this));
        }
    },
    openWork: function(data){
        var appId = "process.Work"+data.flag;
        // if (layout.desktop.apps[appId]){
        //     if (!layout.desktop.apps[appId].window){
        //         layout.desktop.apps[appId] = null;
        //         layout.openApplication(null, layout.desktop.apps[appId].options.name, layout.desktop.apps[appId].options, layout.desktop.apps[appId].options.app, false, this, false);
        //     }else{
        //         layout.desktop.apps[appId].setCurrent();
        //     }
        // }else {
            var op = {
                "jobId": data.flag,
                "appId": appId
            };
            return layout.desktop.openApplication(this.event, "process.Work", op);
        // }
    },
    openCMSDocument : function( data, isEdited ){
        var appId = "cms.Document"+data.flag;
        // if (layout.desktop.apps[appId]){
        //     if (!layout.desktop.apps[appId].window){
        //         layout.desktop.apps[appId] = null;
        //         layout.openApplication(null, layout.desktop.apps[appId].options.name, layout.desktop.apps[appId].options, layout.desktop.apps[appId].options.app, false, this, false);
        //     }else{
        //         layout.desktop.apps[appId].setCurrent();
        //     }
        // }else {
            var options = {
                "documentId": data.flag,
                "appId": appId,
                "readonly" : !isEdited
            };
            layout.desktop.openApplication(null, "cms.Document", options);
        // }
    }
	
}); 

MWF.xDesktop.requireApp("process.Xform", "Select", null, false);
/** @class Security 密级选择组件。
 * 启用密级标识功能后，此组件允许选择客体密级
 * @o2cn 下拉选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * @extends MWF.xApplication.process.Xform.$Selector
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Security = MWF.APPSecurity =  new Class(
	/** @lends MWF.xApplication.process.Xform.Select# */
	{
		Implements: [Events],
		Extends: MWF.APPSelect,
		iconStyle: "selectIcon",

		/**
		 * 值改变时触发。可以通过this.event获取修改后的选择项（Dom对象）。
		 * @event MWF.xApplication.process.Xform.Security#change
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */

		/**
		 * @ignore
		 * @member {Element} descriptionNode
		 * @memberOf MWF.xApplication.process.Xform.Security#
		 */
		initialize: function(node, json, form, options){
			this.node = $(node);
			this.node.store("module", this);
			this.json = json;
			this.form = form;
			this.field = true;
			this.fieldModuleLoaded = false;
			this.nodeHtml = this.node.get("html");
		},
		__showValue: function(node, value, optionItems){
			if (value){
				value = value.toString();
				if (typeOf(value)!=="array") value = [value];
				var texts = [];
				optionItems.each(function(item){
					var tmps = item.split("|");
					var t = tmps[0];
					var v = tmps[1] || t;

					if (v){

						if (value.indexOf(v)!=-1){
							texts.push(t);
						}
					}

				});
				node.set("text", texts.join(", "));
			}
		},


		_getOptions: function(async, refresh){
			if (this.securityLabelList) return Promise.resolve(this.securityLabelList);

			return o2.Actions.load("x_general_assemble_control").SecurityClearanceAction.object().then(function(json){
				var opts = ["|"];
				Object.keys(json.data).forEach(function(k){
					opts.push(k+"|"+json.data[k]);
				}.bind(this))
				this.securityLabelList = opts;
				return this.securityLabelList;
			}.bind(this));
		},
		_setBusinessData: function(v, id){
			if (!this.isEditable) return;
			var value = v.toInt();
			this.setBusinessDataById(value, id);
			// this.form.businessData.data.$work.objectSecurityClearance = value;
		},
		getInputData: function(){
			if( this.isReadonly()){
				return this._getBusinessData();
			}else{
				var ops = this.node.getElements("option");
				var value = [];
				ops.each(function(op){
					if (op.selected){
						var v = op.get("value");
						value.push(v || "");
					}
				});
				if (!value.length) return null;
				return (value.length==1) ? value[0].toInt() : value.toInt();
			}
		},
		addOption: function(){}
	});

MWF.xDesktop.requireApp("process.Xform", "$Selector", null, false);
/** @class Select 下拉选择组件。
 * 在8.1之后，支持从数据字典、视图和查询获取可选项。获取过程为异步。
 * @o2cn 下拉选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * @extends MWF.xApplication.process.Xform.$Selector
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Select = MWF.APPSelect =  new Class(
	/** @lends MWF.xApplication.process.Xform.Select# */
	{
	Implements: [Events],
	Extends: MWF.APP$Selector,
	iconStyle: "selectIcon",

		/**
		 * 值改变时触发。可以通过this.event获取修改后的选择项（Dom对象）。
		 * @event MWF.xApplication.process.Xform.Select#change
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */

	/**
	 * @ignore
	 * @member {Element} descriptionNode
	 * @memberOf MWF.xApplication.process.Xform.Select#
	 */
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
		this.fieldModuleLoaded = false;
		this.nodeHtml = this.node.get("html");
    },
	/**
	 * @summary 重新加载组件。会执行postLoad事件。
	 * @example
	 * this.form.get("fieldId").reload(); //重新加载事件
	 */
	reload: function(){
		if (this.areaNode){
			this.node = this.areaNode;
			this.areaNode.empty();
			this.areaNode = null;
		}
		this._beforeReloaded();
		this._loadUserInterface();
		this._loadStyles();
		this._afterLoaded();
		this._afterReloaded();
		this.fireEvent("postLoad");
	},
    _loadNode: function(){
		if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if (this.isReadonly()){
				this._loadNodeRead();
			}else{
				this._loadNodeEdit();
			}
        }
    },
	_loadMergeReadContentNode: function( contentNode, data ){
		this._showValue(contentNode, data.data);
	},
    _loadNodeRead: function(){
        this.node.empty();
		this.node.set({
			"nodeId": this.json.id,
			"MWFType": this.json.type
		});
        var value = this.getValue();
        this._showValue( this.node, value );
    },
	__showValue: function(node, value, optionItems){
        if (value){
            if (typeOf(value)!=="array") value = [value];
            var texts = [];
            optionItems.each(function(item){
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                if (v){

                    if (value.indexOf(v)!=-1){
                        texts.push(t);
                    }
                }

            });
            node.set("text", texts.join(", "));
        }
	},
	_loadDomEvents: function(){
		Object.each(this.json.events, function(e, key){
			if (e.code){
				if (this.options.moduleEvents.indexOf(key)===-1){
					this.node.addEvent(key, function(event){
						return this.form.Macro.fire(e.code, this, event);
					}.bind(this));
				}
			}
		}.bind(this));
	},
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!=-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
	addModuleEvent: function(key, fun){
		if (this.options.moduleEvents.indexOf(key)!==-1){
			this.addEvent(key, function(event){
				return (fun) ? fun(this, event) : null;
			}.bind(this));
		}else{
			this.node.addEvent(key, function(event){
				return (fun) ? fun(this, event) : null;
			}.bind(this));
		}
	},
    _loadStyles: function(){
    	if (this.areaNode){
            if (this.json.styles) if (this.areaNode) this.areaNode.setStyles(this.json.styles);
            if (this.json.inputStyles) this.node.setStyles(this.json.inputStyles);
		}else{
            if (this.json.styles) this.node.setStyles(this.json.styles);
		}
    },
	_resetNodeEdit: function(){
		this.node.empty();
		var select = new Element("select");
		select.set(this.json.properties);
		select.inject(this.node);
	},
    _loadNodeEdit: function(){
		if (!this.json.preprocessing) this._resetNodeEdit();

		var select = this.node.getFirst();
		if( !select && this.nodeHtml ){
			this.node.set("html", this.nodeHtml);
			select = this.node.getFirst();
		}

		this.areaNode = this.node;
		this.areaNode.set({
			"id": this.json.id,
			"MWFType": this.json.type
		});
		this.node = select;

		this.node.set({
			"styles": {
				"margin-right": "12px"
			}
		});
		// this.node.set({
		// 	"id": this.json.id,
		// 	"MWFType": this.json.type,
		// 	"styles": {
		// 		"margin-right": "12px"
		// 	}
		// });
		
		this.setOptions();
        this.node.addEvent("change", function( ev ){
			var v = this.getInputData("change");
			this._setBusinessData(v);
            this.validationMode();
            if (this.validation()) {
				//this._setEnvironmentData(v);
				this.fireEvent("change", [this._getSelectedOption()]);
			}
        }.bind(this));

	},

	_setOptions: function(optionItems){
		var p = o2.promiseAll(optionItems).then(function(options){
			this.moduleSelectAG = null;
			if (!options) options = [];
			if (o2.typeOf(options)==="array"){
				options.each(function(item){
					var tmps = item.split("|");
					var text = tmps[0];
					var value = tmps[1] || text;

					var option = new Element("option", {
						"value": value,
						"text": text
					}).inject(this.node);
				}.bind(this));
				this.fireEvent("setOptions", [options])
			}
		}.bind(this), function(){
			this.moduleSelectAG = null;
		}.bind(this));
		this.moduleSelectAG = p;
		if (p) p.then(function(){
			this.moduleSelectAG = null;
		}.bind(this), function(){
			this.moduleSelectAG = null;
		}.bind(this));

		// this.moduleSelectAG = o2.AG.all(optionItems).then(function(options){
		// 	this.moduleSelectAG = null;
		// 	if (!options) options = [];
		// 	if (o2.typeOf(options)==="array"){
		// 		options.each(function(item){
		// 			var tmps = item.split("|");
		// 			var text = tmps[0];
		// 			var value = tmps[1] || text;
		//
		// 			var option = new Element("option", {
		// 				"value": value,
		// 				"text": text
		// 			}).inject(this.node);
		// 		}.bind(this));
		// 		this.fireEvent("setOptions", [options])
		// 	}
		// }.bind(this));
		// if (this.moduleSelectAG) this.moduleSelectAG.then(function(){
		// 	this.moduleSelectAG = null;
		// }.bind(this));
	},
	// __setOptions: function(){
	// 	var optionItems = this.getOptions();
    //     if (!optionItems) optionItems = [];
    //     if (o2.typeOf(optionItems)==="array"){
	// 		optionItems.each(function(item){
	// 			var tmps = item.split("|");
	// 			var text = tmps[0];
	// 			var value = tmps[1] || text;
	//
	// 			var option = new Element("option", {
	// 				"value": value,
	// 				"text": text
	// 			}).inject(this.node);
	// 		}.bind(this));
	// 		this.fireEvent("setOptions", [optionItems])
	// 	}
	// },
	addOption: function(text, value){
        var option = new Element("option", {
            "value": value || text,
            "text": text
        }).inject(this.node);
		this.fireEvent("addOption", [text, value])
	},

	_setValue: function(value, m, fireChange){
		var mothed = m || "__setValue";
		if (!!value){
			var p = o2.promiseAll(value).then(function(v){
				if (o2.typeOf(v)=="array") v = v[0];
				if (this.moduleSelectAG){
					this.moduleValueAG = this.moduleSelectAG;
					this.moduleSelectAG.then(function(){
						this[mothed](v, fireChange);
						return v;
					}.bind(this), function(){});
				}else{
					this[mothed](v, fireChange)
				}
				return v;
			}.bind(this), function(){});

			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
		}else{
			this[mothed](value, fireChange);
		}


		// this.moduleValueAG = o2.AG.all(value).then(function(v){
		// 	if (o2.typeOf(v)=="array") v = v[0];
		// 	if (this.moduleSelectAG){
		// 		this.moduleValueAG = this.moduleSelectAG;
		// 		this.moduleSelectAG.then(function(){
		// 			this.__setValue(v);
		// 		}.bind(this));
		// 	}else{
		// 		this.__setValue(v)
		// 	}
		// 	return v;
		// }.bind(this));

		// if (value && value.isAG){
		// 	this.moduleValueAG = o2.AG.all(value),then(function(v){
		// 		this._setValue(v);
		// 	}.bind(this));
		// 	// this.moduleValueAG = value;
		// 	// value.addResolve(function(v){
		// 	// 	this._setValue(v);
		// 	// }.bind(this));
		// }else{
		//
		// }
	},
	__setValue: function(value){
		if (!this.isReadonly()) {
			this._setBusinessData(value);

			var ops = this.node.getElements("option");
			for (var i=0; i<ops.length; i++){
				var option = ops[i];
				if (option.value==value){
					option.selected = true;
					//	break;
				}else{
					option.selected = false;
				}
			}
		}
		this.fieldModuleLoaded = true;
		this.moduleValueAG = null;
	},

	// _setValue: function(value){
	// 	if (!this.readonly && !this.json.isReadonly ) {
    //         this._setBusinessData(value);
    //         for (var i=0; i<this.node.options.length; i++){
    //             var option = this.node.options[i];
    //             if (option.value==value){
    //                 option.selected = true;
    //                 //	break;
    //             }else{
    //                 option.selected = false;
    //             }
    //         }
    //     }
	// 	//this.node.set("value", value);
	// },

	_getSelectedOption: function(){
		var ops = this.node.getElements("option");
		for( var i=0; i<ops.length; i++ ){
			if( ops[i].selected )return ops[i];
		}
		return null;
	},
	_getInputTextData: function(){
	    var value = [], text = [];
        var ops = this.node.getElements("option");
        ops.each(function(op){
            if (op.selected){
                var v = op.get("value");
                var t = op.get("text");
                value.push(v || "");
                text.push(t || v || "");
            }
        });
        if (!value.length) value = [""];
        if (!text.length) text = [""];
        return {"value": value, "text": text};
	},

	/**
	 * @summary 获取选中项的text。
	 * @return {String} 返回选中项的text
	 * @example
	 * var text = this.form.get('fieldId').getText(); //获取选中项的文本
	 */
	getText: function(){
		var d = this.getTextData();
		if( typeOf(d.then) === "function" ){
			return d.then(function( d1 ){
				var texts = d1.text;
				return (texts && texts.length) ? texts[0] : "";
			})
		}else{
			var texts = d.text;
			return (texts && texts.length) ? texts[0] : "";
		}
	},
    getInputData: function(){
		if( this.isReadonly()){
			return this._getBusinessData();
		}else{
			var ops = this.node.getElements("option");
			var value = [];
			ops.each(function(op){
				if (op.selected){
					var v = op.get("value");
					value.push(v || "");
				}
			});
			if (!value.length) return null;
			return (value.length==1) ? value[0] : value;
		}
	},
    resetData: function(){
        this.setData(this.getValue());
    },

	setData: function(data, fireChange){
		return this._setValue(data, "__setData", fireChange);
		// if (data && data.isAG){
		// 	this.moduleValueAG = o2.AG.all(data).then(function(v){
		// 		if (o2.typeOf(v)=="array") v = v[0];
		// 		this.__setData(v);
		// 	}.bind(this));
		// }else{
		// 	this.__setData(data);
		// }
		// if (data && data.isAG){
		// 	this.moduleValueAG = data;
		// 	data.addResolve(function(v){
		// 		this.setData(v);
		// 	}.bind(this));
		// }else{
		// 	this.__setData(data);
		// 	this.moduleValueAG = null;
		// }
	},

	__setData: function(data, fireChange){
		var old = this.getInputData();
        this._setBusinessData(data);
        var selectedOption = null;
		if (this.isReadonly()){
			var d = typeOf(data) === "array" ? data : [data];
			var ops = this.getOptionsObj();
			var result = [];
			if( typeOf(ops.then) === "function" ){
                this.moduleSelectAG = Promise.resolve(ops).then(function(){
                    d.each( function (v) {
                        var idx = ops.valueList.indexOf( v );
                        result.push( idx > -1 ? ops.textList[idx] : v);
                    })
                    this.node.set("text", result.join(","));
                }.bind(this))
			}else{
			    d.each( function (v) {
                    var idx = ops.valueList.indexOf( v );
                    result.push( idx > -1 ? ops.textList[idx] : v);
                })
                this.node.set("text", result.join(","));
			}
		}else{
			var ops = this.node.getElements("option");
			ops.each(function(op){
				if (typeOf(data)==="array"){
					if (data.indexOf(op.get("value"))!=-1){
						op.set("selected", true);
						selectedOption = op;
					}else{
						op.set("selected", false);
					}
				}else{
					if (data == op.get("value")){
						op.set("selected", true);
						selectedOption = op;
					}else{
						op.set("selected", false);
					}
				}
			});
			this.validationMode();
		}
		this.fieldModuleLoaded = true;
		this.fireEvent("setData", [data]);
		if (fireChange && old!==data) this.fireEvent("change", [selectedOption]);
	},

	getExcelData: function( type ){
		var value = this.getData();
		if( type === "value" )return value;

		var options = this.getOptionsObj();
		return Promise.resolve(options).then(function (opts) {
			var idx = opts.valueList.indexOf( value );
			var text = idx > -1 ? opts.textList[ idx ] : "";
			return text;
		});
	},
	setExcelData: function(d, type){
		var value = d.replace(/&#10;/g,""); //换行符&#10;
		this.excelData = value;
		if( type === "value" ){
			this.setData(value, true);
		}else{
			var options = this.getOptionsObj();
			this.moduleExcelAG = Promise.resolve(options).then(function (opts) {
				var idx = opts.textList.indexOf( value );
				value = idx > -1 ? opts.valueList[ idx ] : "";
				this.setData(value, true);
				this.moduleExcelAG = null;
			}.bind(this));
		}
	}
	
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
//MWF.require("MWF.widget.Tree", null, false);
/** @class Sidebar 侧边操作条。
 * @o2cn 侧边操作条
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var sidebar = this.form.get("fieldId"); //获取侧边操作条
 * //方法2
 * var sidebar = this.target; //在侧边操作条和操作本身的事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Sidebar = MWF.APPSidebar =  new Class(
    /** @lends MWF.xApplication.process.Xform.Sidebar# */
{
	Extends: MWF.APP$Module,
        options: {
            /**
             * 组件加载前触发。当前组件的queryLoad事件还没有在form里注册，通过this.form.get("fieldId")不能获取到当前组件，需要用this.target获取当前组件。
             * @event MWF.xApplication.process.Xform.Sidebar#queryLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载时触发。
             * @event MWF.xApplication.process.Xform.Sidebar#load
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载后事件.由于加载过程中有异步处理，这个时候操作条有可能还未生成。
             * @event MWF.xApplication.process.Xform.Sidebar#postLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载后事件。这个时候操作条已生成
             * @event MWF.xApplication.process.Xform.Sidebar#afterLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "moduleEvents": ["load", "queryLoad", "postLoad", "afterLoad"]
        },
    _loadUserInterface: function(){
        this.node.setStyles(this.form.css.sidebar);
        this.node.setStyles({
           "min-width":"126px",
           "max-width":"240px",
           "width": "auto"
        });
        // this.node.setStyle("width", this.node.getSize().x+"px");
        this.toolbarNode = this.node.getFirst("div");
        this.toolbarNode.empty();

        if (this.form.businessData.task){
            MWF.require("MWF.widget.Toolbar", function(){
                var toolbars = [];
                //this.form.businessData.task.routeNameList.each(function(route, i){
                //    if (!this.json.defaultTools) this.json.defaultTools = [];
                //    var o= {
                //        "type": "MWFToolBarButton",
                //        "img": "submit.png",
                //        "title": route,
                //        "action": "processWork:"+route,
                //        "text": route,
                //        "id": "action_processWork",
                //        "control": "allowProcessing",
                //        "condition": "",
                //        "read": false
                //    };
                //    toolbars.push(o);
                //}.bind(this));
                ( this.getRouteNameList() || [] ).each(function(route, i){
                    if (!this.json.defaultTools) this.json.defaultTools = [];
                    var o= {
                        "type": "MWFToolBarButton",
                        "img": "submit.png",
                        "title": route.displayName,
                        "action": "processWork:"+route.routeName,
                        "text": route.displayName,
                        "id": "action_processWork",
                        "control": "allowProcessing",
                        "condition": "",
                        "read": false
                    };
                    toolbars.push(o);
                }.bind(this));
                this.json.defaultTools = toolbars.concat(this.json.defaultTools);
                //this.json.defaultTools.unshift(o);

                /**
                 * @summary Toolbar组件，平台使用该组件生成操作条。
                 * @member {o2.widget.Toolbar}
                 * @example
                 *  //可以在脚本中获取该组件
                 * var toolbarWidget = this.form.get("fieldId").toolbarWidget; //获取组件对象
                 */
                this.toolbarWidget = new MWF.widget.Toolbar(this.toolbarNode, {
                    "style": this.json.style,
                    "onPostLoad" : function(){
                        this.fireEvent("afterLoad");
                    }.bind(this)
                }, this);
                //alert(this.readonly)

                if (this.json.hideSystemTools){
                    if (this.json.tools.length){
                        this.setCustomToolbars(this.json.tools, this.toolbarNode);
                        this.toolbarWidget.load();
                    }else{
                        this.toolbarNode.setStyle("display", "none");
                    }
                }else{
                    if (this.json.defaultTools.length || this.json.tools.length){
                        if (this.json.defaultTools){
                            this.setToolbars(this.json.defaultTools, this.toolbarNode, this.readonly);
                            this.setCustomToolbars(this.json.tools, this.toolbarNode);
                            this.toolbarWidget.load();
                        }else{
                            MWF.getJSON(this.form.path+"toolbars.json", function(json){
                                this.setToolbars(json, this.toolbarNode, this.readonly, true);
                                this.setCustomToolbars(this.json.tools, this.toolbarNode);
                                this.toolbarWidget.load();
                            }.bind(this), false);
                        }
                    }else{
                        this.toolbarNode.setStyle("display", "none");
                    }
                }
                if (this.toolbarWidget.children.length){
                    //this.form.app.addEvent("resize", this.loadPosition.bind(this));
                    this.node.setStyle("display", "none");
                    window.setTimeout(this.loadPosition.bind(this), 500);
                    var _self = this;
                    this.form.app.content.getFirst().addEvent("scroll", function(e){
                        _self.loadPosition(this);
                    });
                    this.form.app.addEvent("resize", function(e){
                        _self.loadPosition(this);
                    });
                }else{
                    this.toolbarNode.setStyle("display", "none");
                }
            }.bind(this));
        }else{
            this.node.setStyle("display", "none");
        }
    },
    loadPosition: function(){
        // this.node.setStyle("display", "block");
        // var parent = this.node.getParent();
        // while(parent && (!parent.get("MWFtype"))) parent = parent.getParent();
        //
        // var top = this.json.styles.top;
        // this.sideNode = parent || this.form.node;
        //
        // var size = this.form.app.content.getSize();
        // var scroll = this.form.app.content.getScroll();
        // var sideSize = this.sideNode.getSize();
        //
        // var y = (scroll.y+size.y/2)-sideSize.y/2;
        // var x = 5;
        //
        // var position = "centerRight";
        // var edge = "centerLeft";
        // if (!parent){
        //     edge = "centerRight";
        //     x = 5;
        // }
        //
        // if (this.json.barPosition=="left"){
        //     position = "centerLeft";
        //     edge = "centerRight";
        //     x = -5;
        //     if (!parent){
        //         edge = "centerLeft";
        //         x = 5;
        //     }
        // }
        //
        // this.node.position({
        //     "relativeTo": this.sideNode,
        //     "position": position,
        //     "edge": edge,
        //     "offset" : {"y": y, "x": x}
        // });
        // this.json.styles.top = top;
        // if (top) this.node.setStyle("top", top);

        this.node.setStyle("display", "block");
        var parent = this.node.getParent();
        while(parent && (!parent.get("MWFtype"))) parent = parent.getParent();
        this.sideNode = parent || this.form.node;
        var size = this.form.app.content.getSize();
        //var scroll = this.form.designer.designNode.getScroll();
        var sideSize = this.sideNode.getSize();
        var sidePosition = this.sideNode.getPosition(this.sideNode.getOffsetParent());
        var nodeSize = this.node.getSize();

        if (sideSize.y>size.y){
            var center = (size.y/2-nodeSize.y/2);
            if (center<sidePosition.y){
                this.node.setStyle("top", ""+sidePosition.y+"px");
            }else if (center>(sidePosition.y+sideSize.y)){
                var tmp = (sidePosition.y+sideSize.y)-nodeSize.y;
                this.node.setStyle("top", ""+tmp+"px");
            }else{
                this.node.setStyle("top", ""+center+"px");
            }
        }else{
            var top = sidePosition.y+sideSize.y/2-nodeSize.y/2;
            if (top>size.y){
                if (sidePosition.y+nodeSize.y>size.y){
                    this.node.setStyle("top", ""+sidePosition.y+"px");
                }else{
                    var tmp = size.y-nodeSize.y;
                    this.node.setStyle("top", ""+tmp+"px");
                }
            }else if(top<=0){
                if(sidePosition.y+sideSize.y<nodeSize.y){
                    var tmp = sidePosition.y+sideSize.y-nodeSize.y;
                    this.node.setStyle("top", ""+tmp+"px");
                }else{
                    this.node.setStyle("top", "45px");
                }
            }else{
                this.node.setStyle("top", ""+top+"px");
            }
        }


        //var left = sideSize.x+sidePosition.x+5;
        var x = sidePosition.x+sideSize.x+nodeSize.x;
        var left;
        if( x > size.x ){
            left = size.x - nodeSize.x - 5;
        }else{
            left = sideSize.x+sidePosition.x+5;
        }

        this.node.setStyle("left", ""+left+"px");
        this.node.setStyle("position", "absolute");
        this.node.setStyles({"right": "auto", "bottom": "auto"});

        // this.json.styles = this.node.getStyles(["top", "left", "bottom", "right", "position"]);
        //
        // var p = this.sideNode.getPosition();
        // var s = this.sideNode.getSize();
        // this.sidePosition = {"p": p, "s": s};

    },
    setCustomToolbars: function(tools, node){
        var path = "../x_component_process_FormDesigner/Module/Actionbar/";
        tools.each(function(tool){
            var flag = true;
            if (this.readonly){
                flag = tool.readShow;
            }else{
                flag = tool.editShow;
            }
            if (flag){
                flag = true;
                if (tool.control){
                    flag = this.form.businessData.control[tool.control]
                }
                if (tool.condition){
                    var hideFlag = this.form.Macro.exec(tool.condition, this);
                    flag = !hideFlag;
                }
                if (flag){
                    var actionNode = new Element("div", {
                        "id": tool.id,
                        "MWFnodetype": tool.type,
                        //"MWFButtonImage": this.form.path+""+this.form.options.style+"/actionbar/"+tool.img,
                        "MWFButtonImage": path+(this.form.options.style||"default") +"/custom/"+tool.img,
                        "title": tool.title,
                        "MWFButtonAction": "runCustomAction",
                        "MWFButtonText": tool.text
                    }).inject(node);
                    if (tool.actionScript){
                        actionNode.store("script", tool.actionScript);
                    }
                    if (tool.sub){
                        var subNode = node.getLast();
                        this.setCustomToolbars(tool.sub, subNode);
                    }
                }
            }
        }.bind(this));
    },
    setToolbars: function(tools, node, readonly, noCondition){
        var path = "../x_component_process_FormDesigner/Module/Actionbar/";
        tools.each(function(tool){
            var flag = true;
            if (tool.control){
                flag = this.form.businessData.control[tool.control]
            }
            if (!noCondition) if (tool.condition){
                var hideFlag = this.form.Macro.exec(tool.condition, this);
                flag = !hideFlag;
            }
            if (tool.id == "action_processWork"){
                if (!this.form.businessData.task){
                    flag = false;
                }
            }
            if (readonly) if (!tool.read) flag = false;
            if (flag){
                var actionNode = new Element("div", {
                    "id": tool.id,
                    "MWFnodetype": tool.type,
                    //"MWFButtonImage": this.form.path+""+this.form.options.style+"/actionbar/"+tool.img,
                    "MWFButtonImage": path+(this.form.options.style||"default") +"/tools/default/"+tool.img,
                    "title": tool.title,
                    "MWFButtonAction": tool.action,
                    "MWFButtonText": tool.text
                }).inject(node);
                if (tool.sub){
                    var subNode = node.getLast();
                    this.setToolbars(tool.sub, subNode, readonly, noCondition);
                }
            }
        }.bind(this));
    },
    getRouteNameList: function( routeList ){
        var _self = this;

        var list = [];
        if( !routeList )routeList = this.getRouteDataList();
        routeList.each(function(route, i){
            if( route.hiddenScriptText && this.form && this.form.Macro ){
                if( this.form.Macro.exec(route.hiddenScriptText, this).toString() === "true" )return;
            }
            var routeName = route.name;
            if( route.displayNameScriptText && this.form && this.form.Macro ){
                routeName = this.form.Macro.exec(route.displayNameScriptText, this);
            }

            list.push({
                "routeId" : route.id,
                "displayName" : routeName,
                "routeName" : route.name
            })
        }.bind(this));
        return list;
    },
    getRouteDataList : function(){
        if(this.routeDataList)return this.routeDataList;

        if (this.form && this.form.businessData && this.form.businessData.task && this.form.businessData.task.routeNameDisable){
            this.routeDataList = [{
                "id": o2.uuid(),
                "asyncSupported": false,
                "soleDirect": false,
                "name": "继续流转",
                "alias": "",
                "selectConfigList": []
            }];
            return this.routeDataList;
        }

        if( this.form && this.form.businessData && this.form.businessData.routeList ){
            this.form.businessData.routeList.sort( function(a, b){
                var aIdx = parseInt(a.orderNumber || "9999999");
                var bIdx = parseInt(b.orderNumber || "9999999");
                return aIdx - bIdx;
            }.bind(this));
            this.form.businessData.routeList.each( function(d){
                d.selectConfigList = JSON.parse(d.selectConfig || "[]");
            }.bind(this));
            this.routeDataList = this.form.businessData.routeList;
        }
        if( !this.routeDataList && this.form && this.form.businessData && this.form.businessData.task && this.form.businessData.task ){
            o2.Actions.get("x_processplatform_assemble_surface").listRoute( {"valueList":this.form.businessData.task.routeList} , function( json ){
                json.data.sort(function(a, b){
                    var aIdx = parseInt(a.orderNumber || "9999999");
                    var bIdx = parseInt(b.orderNumber || "9999999");
                    return aIdx - bIdx;
                }.bind(this));
                json.data.each( function(d){
                    d.selectConfigList = JSON.parse( d.selectConfig || "[]" );
                }.bind(this));
                this.routeDataList = json.data;
            }.bind(this), null, false );
        }
        return this.routeDataList;
    },
    isOpinionRequired: function( routeName ){
        var routeList = this.getRouteDataList();
        for( var i=0; i<routeList.length; i++ ){
            if( routeList[i].name === routeName ){
                return routeList[i].opinionRequired;
            }
        }
    },
    getRouteId: function( routeName ){
        var routeList = this.getRouteDataList();
        for( var i=0; i<routeList.length; i++ ){
            if( routeList[i].name === routeName ){
                return routeList[i].id;
            }
        }
    },
    getRouteData : function( routeId ){
        var routeList = this.getRouteDataList();
        for( var i=0; i<routeList.length; i++ ){
            if( routeList[i].id === routeId ){
                return routeList[i];
            }
        }
    },
    getOrgData: function (routeId) {
        var routeList = this.getRouteDataList();
        for (var i = 0; i < routeList.length; i++) {
            if (routeList[i].id === routeId) {
                return routeList[i].selectConfigList;
            }
        }
    },
    getVisableOrgData: function (routeId) {
        var selectConfigList = this.getOrgData(routeId);
        var list = [];
        (selectConfigList || []).each(function (config) {
            if (!this.isOrgHidden(config)) {
                list.push(config);
            }
        }.bind(this));
        return list;
    },
    isOrgHidden: function (d) {
        if (d.hiddenScript && d.hiddenScript.code) { //如果隐藏路由，返回
            var hidden = this.form.Macro.exec(d.hiddenScript.code, this);
            if (hidden && hidden.toString() === "true") return true;
        }
        return false;
    },
    runCustomAction: function(bt){
        var script = bt.node.retrieve("script");
        this.form.Macro.exec(script, this);
    },
    saveWork: function(){
        this.form.saveWork();
    },
    closeWork: function(){
        this.form.closeWork();
    },
    processWork: function(route){
        var opinion = this.form.getOpinion();

        if( !opinion.opinion && !opinion.medias.length && this.isOpinionRequired(route)){
            this.form.notice(MWF.xApplication.process.Work.LP.opinionRequired, "error");
            return false;
        }

        this.form.Macro.environment.form.currentRouteName = route;
        this.form.Macro.environment.form.opinion = opinion.opinion;
        this.form.Macro.environment.form.medias = opinion.medias;

        var routeId = this.getRouteId( route );
        var routeData = this.getRouteData( routeId );
        if (routeData.validationScriptText) {
            var validation = this.form.Macro.exec(routeData.validationScriptText, this);
            if (!validation || validation.toString() !== "true") {
                validation = typeOf(validation) === "string" ? validation : MWF.xApplication.process.Work.LP.routeValidFailure;
                this.form.notice(validation, "error");
                return false;
            }
        }

        if (!this.form.formCustomValidation()){
            this.form.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        if( this.getVisableOrgData( routeId ).length > 0 ){
            this.form.flowWork( routeId );
        }else{
            this.form.submitWork(route, opinion.opinion, opinion.medias)
        }

        // var opinionField = this.json.opinion || "opinion";
        // var data = this.form.getData();
        // var opinion = data[opinionField];
        // data[opinionField] = "";
        // this.form.submitWork(route, opinion, null, null, data);
    },
    resetWork: function(){
        this.form.resetWork();
    },
    retractWork: function(e, ev){
        this.form.retractWork(e, ev);
    },
    rerouteWork: function(e, ev){
        this.form.rerouteWork(e, ev);
    },
    deleteWork: function(){
        this.form.deleteWork();
    },
    printWork: function(){
        this.form.printWork();
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class SmartBI 统计图表组件。
 * @o2cn 统计图表组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var div = this.form.get("name"); //获取组件
 * //方法2
 * var div = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.SmartBI = MWF.APPSmartBI =  new Class({
    Extends: MWF.APP$Module,

    _loadUserInterface: function(){
        if (!this.json.smartbiresource || this.json.smartbiresource==="none") this.node.destroy();
        else{
            var url;
            var value = this.json.smartbiresource;
            var SmartBIAction = o2.Actions.load("x_custom_smartbi_assemble_control");
            var addressUri = SmartBIAction.ResourceAction.address;
            
            if(addressUri){
                SmartBIAction.ResourceAction.address(value,function(json){ 
                    if(json.data.value !==""){
                        url = json.data.value;
                        url = url +"&showtoolbar="+this.json.smartbidisplaytoolbar+"&showLeftTree="+this.json.smartbidisplaylefttree;
                    }
                }.bind(this),null,false)
            }else{
                var address = SmartBIAction.ResourceAction.action.getAddress();
                var uri = SmartBIAction.ResourceAction.action.actions.open.uri;
                var url = uri.replace("{id}", encodeURIComponent(value));

                url = url +"?showtoolbar="+this.json.smartbidisplaytoolbar+"&showLeftTree="+this.json.smartbidisplaylefttree;
                
                url = o2.filterUrl(address+url);
            }
                        
            this.iframe = new Element("iframe",{
                src:url,
                frameborder:"0",
                scrolling:"auto"
            }).inject(this.node,"after");
            
            var _properties = this.json.properties||{};
            this.node.destroy();
            this.node = this.iframe.setStyles({
                "width":"100%",
                "height":"100%",
                "min-height":"300px",
                "min-width":"300px"
            });

			this.node.set(_properties)
			
        }
        
	}
});
MWF.xDesktop.requireApp('process.Xform', 'Div', null, false);

/** @class Source 数据源组件。
 * @o2cn 数据源
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var source = this.form.get("fieldId"); //获取数据源组件
 * //方法2
 * var source = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.Div
 * @o2category FormComponents
 * @o2range {Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Source = MWF.APPSource = new Class(
    /** @lends MWF.xApplication.process.Xform.Source# */
    {
        Extends: MWF.APPDiv,
        options: {
            /**
             * 加载数据后执行，但这时还未加载下属组件，可以可以使用this.target.data获取数据进行修改。
             * @event MWF.xApplication.process.Xform.Source#postLoadData
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 加载数据、下属组件后执行。
             * @event MWF.xApplication.process.Xform.Source#loadData
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            moduleEvents: ['queryLoad', 'postLoad', 'load', 'postLoadData', 'loadData'],
        },

        _loadUserInterface: function () {
            this.currentPage = 1;
            this.data = null;
            if (this.json.path) {
                // this.loadPagination();
                if (this.json.sourceType == 'o2') {
                    if (this.json.path) this._getO2Source();
                } else {
                    this._getOtherSource();
                }
            }
        },
        _getO2Address: function () {
            try {
                this.json.service = JSON.parse(this.json.contextRoot);
            } catch (e) {
                this.json.service = {root: this.json.contextRoot, action: '', method: '', url: ''};
            }
            var addressObj = layout.serviceAddressList[this.json.service.root];

            var defaultPort = layout.config.app_protocol === 'https' ? '443' : '80';
            if (addressObj) {
                var appPort = addressObj.port || window.location.port;
                this.address =
                    layout.config.app_protocol +
                    '//' +
                    (addressObj.host || window.location.hostname) +
                    (!appPort || appPort.toString() === defaultPort ? '' : ':' + appPort) +
                    addressObj.context;
                // this.address = layout.config.app_protocol+"//"+addressObj.host+(addressObj.port==80 ? "" : ":"+addressObj.port)+addressObj.context;
            } else {
                var host = layout.desktop.centerServer.host || window.location.hostname;
                var port = layout.desktop.centerServer.port || window.location.port;
                this.address =
                    layout.config.app_protocol +
                    '//' +
                    host +
                    (!port || port.toString() === defaultPort ? '' : ':' + port) +
                    '/' +
                    this.json.service.root;
            }
        },
        //_getConfigParameters: function(){
        //
        //    return pars;
        //},
        _getO2Uri: function () {
            //var uri = this.json.path || this.json.selectPath;
            var uri = this.json.path;
            var pars = {};
            if (this.json.parameters) {
                Object.each(
                    this.json.parameters,
                    function (v, key) {
                        if (uri.indexOf('{' + key + '}') != -1) {
                            var reg = new RegExp('{' + key + '}', 'g');
                            uri = uri.replace(reg, encodeURIComponent(v && v.code ? this.form.Macro.exec(v.code, this) || '' : v));
                        } else {
                            pars[key] = v;
                        }
                    }.bind(this),
                );
            }

            var data = null;
            if (this.json.requestBody) {
                if (this.json.requestBody.code) {
                    data = this.form.Macro.exec(this.json.requestBody.code, this);
                }
            }

            if (
                this.json.httpMethod == 'GET' ||
                this.json.httpMethod == 'OPTIONS' ||
                this.json.httpMethod == 'HEAD' ||
                this.json.httpMethod == 'DELETE'
            ) {
                var tag = '?';
                if (uri.indexOf('?') != -1) tag = '&';
                Object.each(
                    pars,
                    function (v, k) {
                        var value = v && v.code ? this.form.Macro.exec(v.code, this) || '' : v;
                        uri = uri + tag + k + '=' + value;
                    }.bind(this),
                );
            } else {
                Object.each(
                    pars,
                    function (v, k) {
                        if (!data) data = {};
                        var value = v && v.code ? this.form.Macro.exec(v.code, this) || '' : v;
                        data[k] = value;
                    }.bind(this),
                );
            }
            this.body = data;
            this.uri = this.address + uri;
        },
        _getO2Source: function () {
            this._getO2Address();
            if (!this.json.isDelay) {
                this._getO2Uri();
                this._invoke(
                    function () {
                        this._loadSub(this.node);
                        // this._setPaginationCount();
                        this.fireEvent('loadData');
                    }.bind(this),
                );
            }
        },

        _getOtherSource: function () {
            if (this.json.otherHost) {
                this.address = this.json.otherHost;
                this._getO2Uri();

                var o = {
                    method: this.json.httpMethod,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                if (this.json.httpMethod == 'POST' || this.json.httpMethod == 'PUT') {
                    o.body = JSON.stringify(this.body);
                }
                fetch(this.uri, o)
                    .then((response) => response.json())
                    .then((json) => {
                        this.data = json;
                        this.fireEvent('postLoadData');
                        this._loadSub(this.node);
                        // this._setPaginationCount();
                        this.fireEvent('loadData');
                    });
            }
        },

        // _setPaginationCount: function (){
        //     if (this.json.countScript && this.json.countScript.code && this.pagination) {
        //         if (this.json.countScript.code) {
        //             var count = this.form.Macro.exec(this.json.countScript.code, this);
        //             this.pagination.setAttribute('total', count);
        //         }
        //     }
        // },
        // loadPagination: function (){
        //     var node = this.node.getElement('oo-pagination');
        //     if(node){
        //         node.destroy();
        //     }
        //     if( this.json.usePagination ){
        //         this.pagination = new Element('oo-pagination', {
        //             total: '300',
        //             pages: this.json.pages,
        //             size: this.json.size,
        //             'page-size': this.json.pageSize,
        //             jumper: this.json.jumper,
        //             first: this.json.first,
        //             last: this.json.last,
        //             'jumper-text': this.json.jumperText,
        //             // styles: this.css.moduleNodeMove,
        //             events: {
        //                 selectstart: function () {
        //                     return false;
        //                 },
        //             },
        //         }).inject(this.node);
        //         this.pagination.addEventListener('page', (e)=>{
        //             this.currentPage = e.detail;
        //             this.reload();
        //         });
        //         if (this.json.pagnationProperties) {
        //             this.pagination.set(this.json.pagnationProperties);
        //         }
        //         if (this.json.pagnationStyles) {
        //             this.pagination.setStyles(this.json.pagnationStyles);
        //         }
        //     }
        // },

        active: function () {
            this._getO2Uri();
            this._invoke(
                function () {
                    this._loadSub(this.node);
                    this.fireEvent('loadData');
                }.bind(this),
            );
        },
        _invoke: function (callback) {
            var cb = new MWF.xDesktop.Actions.RestActions.Callback(function (json) {
                /**
                 * @summary 该属性获取当前数据源的数据，当数据源加载完成后才有值。
                 * @member {Array|Object|String|Number|Boolean|Null}
                 * @example
                 * var field = this.form.get("fieldId").data; //获取数据源数据
                 */
                this.data = json;
                this.fireEvent('postLoadData');
                if (callback) callback();
            }.bind(this), null);

            MWF.restful(
                this.json.httpMethod,
                this.uri,
                JSON.encode(this.body),
                cb,
                true,
                true,
            );
        },
        setBody: function (data) {
            this.body = data;
        },
        /**
         * @summary 替换全部的url参数，但不刷新组件
         * @param {Object} url参数
         * @example
         * //如，原来的组件url参数为：
         * { "page" : 1, "count" : 10  }
         *
         * this.form.get("fieldId").setParameters({"id":"662ede34-4e21-428a-9c3b-f1bf14d15650"});
         *
         * //执行后变为
         * {"id":"662ede34-4e21-428a-9c3b-f1bf14d15650"}
         */
        setParameters: function (json) {
            this.json.parameters = json;
            this._getO2Address();
            this._getO2Uri();
        },
        /**
         * @summary 新增url参数，但不刷新组件。如果该参数key已经存在，则覆盖
         * @param {Object} url参数
         * @example
         * * //如，原来的组件url参数为：
         * { "page" : 1, "count" : 10  }
         *
         * this.form.get("fieldId").addParameters({
         *  "page" : 2,
         *  "id":"662ede34-4e21-428a-9c3b-f1bf14d15650"
         *  });
         *
         * //执行后变为
         * {
         *  "page" : 2,
         *  "count" : 10
         *  "id":"662ede34-4e21-428a-9c3b-f1bf14d15650"
         *  }
         */
        addParameters: function (json) {
            if (!this.json.parameters) this.json.parameters = {};
            Object.each(
                json,
                function (v, k) {
                    this.json.parameters[k] = v;
                }.bind(this),
            );
            this._getO2Address();
            this._getO2Uri();
        },
        /**
         * @summary 重新加载组件。会触发loadData事件
         * @param {Boolean} notInit - false表示不重新初始化子数据源和数据文本，true表示重新初始化，默认为false
         * @param {Function} callback 加载完成后的回调
         * @example
         * this.form.get("fieldId").reload(); //重新加载组件
         */
        reload: function (notInit, callback) {
            if (this.json.sourceType == 'o2') {
                this._getO2Uri();
                this._invoke(
                    function () {
                        this._loadSub(this.node, notInit);
                        this.fireEvent('loadData');
                        if (callback) callback();
                    }.bind(this),
                );
            } else {
                this._getOtherSource();
            }
        },
        _loadSub: function (dom, notInit) {
            var subDom = dom.getFirst();
            var module = null;
            while (subDom) {
                module = null;

                module = subDom.retrieve('module', null);
                if (module) {
                    if (module._loadJsonData) module._loadJsonData(notInit);
                } else {
                    this._loadSub(subDom);
                }

                //var type = subDom.get("MWFtype");
                //if (type){
                //    if (type=="sourceText"){
                //        module = subDom.retrieve("module");
                //        module._loadData();
                //    }else if (type=="subSource"){
                //        module = subDom.retrieve("module");
                //        module._loadData();
                //    }else{
                //        this._loadSub(subDom);
                //    }
                //}else{
                //   this._loadSub(subDom);
                //}
                subDom = subDom.getNext();
            }
        },
    },
);

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class SourceText 数据文本组件。
 * @o2cn 数据文本
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var sourceText = this.form.get("fieldId"); //获取组件
 * //方法2
 * var sourceText = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.SourceText = MWF.APPSourceText =  new Class({
    Extends: MWF.APP$Module,
    options: {
        "moduleEvents": ["loadText", "load", "queryLoad", "postLoad"]
    },

	_loadUserInterface: function(){
        /**
         * @ignore
         * @member parentLine
         * @memberOf MWF.xApplication.process.Xform.SourceText#
         */
        this._loadJsonData();
	},
    _getSource: function(){
        var parent = this.node.getParent();
        while(parent && (parent.get("MWFtype")!="source" && parent.get("MWFtype")!="subSource" && parent.get("MWFtype")!="subSourceItem")) parent = parent.getParent();
        return (parent) ? parent.retrieve("module") : null;
    },
    _loadJsonData: function(){
        this.node.set("text", "");
        this.source = this._getSource();
        if (this.source){
            if (this.source.data){
                COMMON.AjaxModule.load("JSONTemplate", function(){

                    this.template = new Template();
                    this.text = this.template.substitute("{"+this.json.jsonPath+"}", this.source.data);

                    if (this.json.jsonText){
                        if (this.json.jsonText.code){
                            this.text = this.form.Macro.exec(this.json.jsonText.code, this);
                            if( typeOf(this.text) === "string" )this.node.set("text", this.text);
                        }else{
                            this.node.set("text", this.text);
                        }
                    }else{
                        this.node.set("text", this.text);
                    }
                    this.fireEvent("loadText");

                }.bind(this));
            }
        }
    }
}); 
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
//MWF.xDesktop.requireApp("process.Xform", "widget.View", null, false);

/** @class Stat 统计组件。
 * @o2cn 统计组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var stat = this.form.get("fieldId"); //获取组件
 * //方法2
 * var stat = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Stat = MWF.APPStat =  new Class(
    /** @lends MWF.xApplication.process.Xform.Stat# */
{
	Extends: MWF.APP$Module,
    options: {
        /**
         * 组件异步加载完成触发.
         * @event MWF.xApplication.process.Xform.Stat#loadStat
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 图表加载完成触发.
         * @event MWF.xApplication.process.Xform.Stat#afterLoadStat
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "loadStat", "loadChart"]
    },

    _loadUserInterface: function(){
        this.node.empty();
    },
    _afterLoaded: function(){
        this.node.setStyle("min-height", "100px");
        this.loadStat();
    },
    active: function(){
        if (this.stat) this.stat.loadStatData();
    },
    reload: function(){
	    this.active();
    },
    loadStat: function( json ){
        var viewJson = Object.merge(this.getDefaultJson(), json || {});
	    if ( viewJson.application && viewJson.statName ){
            MWF.xDesktop.requireApp("query.Query", "Statistician", function(){
                /**
                 * @summary Statistician组件，平台使用该组件执行统计的逻辑
                 * @member {MWF.xApplication.query.Query.Statistician}
                 * @example
                 *  //可以在脚本中获取该组件
                 * var field = this.form.get("fieldId").stat; //获取组件对象
                 */
                this.stat = new MWF.xApplication.query.Query.Statistician(this.form.app, this.node, viewJson, {
                    "resizeNode": (this.node.getStyle("height").toString().toLowerCase()!=="auto" && this.node.getStyle("height").toInt()>0),
                    "onLoaded": function(){
                        this.fireEvent("loadStat");
                    }.bind(this),
                    "onLoadChart": function(){
                        this.fireEvent("loadChart");
                    }.bind(this)
                });
            }.bind(this));
        }
    },
    getDefaultJson: function(){
	    if( this.json.queryStat ){
	        return {
                "application": this.json.queryStat.appName,
                "statName": this.json.queryStat.name,
                "isChart": (this.json.isChart!=="no"),
                "isLegend": (this.json.isLegend!=="no"),
                "isTable": (this.json.isTable!=="no"),
                "isRowToColumn": (this.json.isRowToColumn!=="no"),
                "tableNodeStyles": this.json.tableNodeStyles,
                "chartNodeStyles": this.json.chartNodeStyles
            };
        }else{
	        return {};
        }
    },

    /**
     * @summary 重新加载统计。
     *  @param json {Object} 加载选项
     *  <pre><code class='language-js'>[{
     *     "application": "",   //数据中心应用名称
     *     "statName": "",         //统计名称
     *     "isChart": true, //是否显示图表
     *     "isLegend": true, //是否显示图例
     *     "isTable": true, //是否显示表格
     *     "isRowToColumn": true, //是否显示行列转换
     * }]</code></pre>
     *  @example
     *  this.form.get("fieldId").reloadStat({
     *      "application": "数据中心应用名称",
     *      "statName": "统计名称"
     *  });
     *  @return {Boolean} 是否通过校验
     */
    reloadStat: function(json){
        var viewJson = Object.merge(this.getDefaultJson(), json || {});
	    if( viewJson.application && viewJson.statName ){
	        if( this.stat ){
                this.stat.reload(viewJson);
            }else{
                this.loadStat(viewJson);
            }
        }
    },
    /**
     * @summary 获取统计数据。
     *  @return {Ojbect} 统计数据.
     *  @example
     *  var data = this.form.get("fieldId").getData();
     *  @return {Boolean} 是否通过校验
     */
    getData: function(){
        if (!this.stat) return null;
        if (!this.stat.stat) return null;
        return this.stat.stat.data;
    }
});
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
//MWF.xDesktop.requireApp("process.Xform", "widget.View", null, false);
/** @class Statement 查询视图组件。
 * @o2cn 查询视图
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var statement = this.form.get("fieldId"); //获取组件
 * //方法2
 * var statement = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Statement = MWF.APPStatement =  new Class(
    /** @lends MWF.xApplication.process.Xform.Statement# */
{
	Extends: MWF.APP$Module,
    options: {
        /**
         * 视图参数（options）已经准备好，还未加载视图时执行。可以通过this.event得到视图参数，并可修改this.event修改视图的加载。
         * @event MWF.xApplication.process.Xform.Statement#beforeLoadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 视图设计已经获取，容器也已经准备好。可以通过this.event得到视图参数，并可修改this.event修改视图的加载。
         * @event MWF.xApplication.process.Xform.Statement#loadViewLayout
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 异步加载查询视图后执行。
         * @event MWF.xApplication.process.Xform.Statement#loadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 选中查询视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.Statement#select
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 取消选中查询视图中的一条记录后执行。
         * @since V8.0
         * @event MWF.xApplication.process.Xform.Statement#unselect
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 打开查询视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.Statement#openDocument，可以通过this.event得到打开的文档参数
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "beforeLoadView", "loadViewLayout", "loadView", "queryLoad", "postLoad", "select", "unselect", "openDocument"]
    },

    _loadUserInterface: function(){
        MWF.xDesktop.requireApp("query.Query", "Statement", null, false);
        this.node.empty();
    },
    _afterLoaded: function(){
        if(!!this.json.statementType){
            this.loadView();
        }else if (this.json.queryStatement){
            this.loadView();
        }
    },
    /**
     * @summary 重新加载查询视图
     * @example
     * this.form.get("fieldId").reload()
     */
    reload: function( callback ){
        if (this.view){
            if (this.view.loadViewRes && this.view.loadViewRes.res) if (this.view.loadViewRes.res.isRunning()) this.view.loadViewRes.res.cancel();
            if (this.view.getViewRes && this.view.getViewRes.res) if (this.view.getViewRes.res.isRunning()) this.view.getViewRes.res.cancel();
        }
        this.node.empty();
        this.loadView( callback, true );
    },
    /**
     * @summary 当查询视图被设置为延迟加载（未立即载入），通过active方法激活
     * @example
     * this.form.get("fieldId").active()
     */
    active: function( callback ){
        if (this.view){
            if (!this.view.loadingAreaNode) this.view.loadView( callback );
        }else{
            this.loadView( callback, true );
        }
    },
    getViewName: function (){
        var appName, statementName, statementId;
        if (this.json.statementType === "script") {
            if (this.json.statementScript && this.json.statementScript.code) {
                var data = this.form.Macro.exec(this.json.statementScript.code, this);
                if (typeOf(data) === 'object') {
                    appName = data.application;
                    statementName = data.statement;
                }else if(typeOf(data) === 'string'){
                    statementName = data;
                }
            }
        }else{
            appName = (this.json.queryStatement) ? this.json.queryStatement.appName : this.json.application;
            statementName =  (this.json.queryStatement) ? this.json.queryStatement.name : this.json.statementName;
            statementId = (this.json.queryStatement) ? this.json.queryStatement.id : this.json.statementId;
        }
        return {appName: appName, statementName: statementName, statementId: statementId};
    },
    loadView: function( callback, force ){
        // if (!this.json.queryStatement) return "";
        var viewObj = this.getViewName();
        var appName = viewObj.appName, statementName = viewObj.statementName, statementId = viewObj.statementId;
        if( !statementName && !statementId ){
            if(callback) callback();
            return ;
        }

        var filter = null;
        if (this.json.filterList && this.json.filterList.length){
            filter = [];
            this.json.filterList.each(function(entry){
                entry.value = this.form.Macro.exec(entry.code.code, this);
                //delete entry.code;
                filter.push(entry);
            }.bind(this));
        }

        var parameter = null;
        if( this.json.parameterList && this.json.parameterList.length ){
            parameter = {};
            this.json.parameterList.each(function(entry){
                parameter[entry.parameter] = this.parseParameter(entry);
            }.bind(this));
        }



        //var data = JSON.parse(this.json.data);
        var viewJson = {
            "application": appName,
            "statementName": statementName,
            "statementId": statementId,
            "isTitle": this.json.isTitle || "yes",
            "select": this.json.select || "none",
            "titleStyles": this.json.titleStyles,
            "itemStyles": this.json.itemStyles,
            "isExpand": this.json.isExpand || "no",
            "showActionbar" : this.json.actionbar === "show",
            "filter": filter,
            "parameter": parameter,
            "parameterList": this.json.parameterList,
            "defaultSelectedScript" : this.json.defaultSelectedScript ? this.json.defaultSelectedScript.code : null,
            "selectedAbleScript" : this.json.selectedAbleScript ? this.json.selectedAbleScript.code : null
        };

        this.fireEvent("beforeLoadView", [viewJson]);

        //MWF.xDesktop.requireApp("query.Query", "Viewer", function(){
        /**
         * @summary Statement组件，平台使用该组件实现查询视图的功能
         * @member {MWF.xApplication.query.Query.Statement}
         * @example
         *  //可以在脚本中获取该组件
         * var view = this.form.get("fieldId").view; //获取组件对象
         */
            this.view = new MWF.xApplication.query.Query.Statement(this.node, viewJson, {
                "isload": force || (this.json.loadView!=="no"),
                "resizeNode": (this.node.getStyle("height").toString().toLowerCase()!=="auto" && this.node.getStyle("height").toInt()>0),
                "onLoadLayout": function () {
                    this.fireEvent("loadViewLayout");
                }.bind(this),
                "onLoadView": function(){
                    this.fireEvent("loadView");
                    if(callback)callback();
                }.bind(this),
                "onSelect": function(item){
                    this.fireEvent("select", [item]);
                }.bind(this),
                "onUnselect": function(item){
                    this.fireEvent("unselect", [item]);
                }.bind(this),
                "onOpenDocument": function(options, item){
                    this.openOptions = {
                        "options": options,
                        "item": item
                    };
                    this.fireEvent("openDocument", [this.openOptions]);
                    this.openOptions = null;
                }.bind(this)
            }, this.form.app, this.form.Macro);
        //}.bind(this));
    },
    /**
     * @summary 获取查询视图被选中行的数据
     * @return {Object[]} 被选中行的数据
     * @example
     * var data = this.form.get("fieldId").getData();
     */
    getData: function(){
        if (this.view.selectedItems.length){
            var arr = [];
            this.view.selectedItems.each(function(item){
                arr.push(item.data);
            });
            return arr;
        }else{
            return [];
        }
    },
    parseParameter: function (f) {
        var value = f.value;
        if( f.valueType === "script" ){
            value = this.form.Macro.exec(f.valueScript ? f.valueScript.code : "", this);
        }
        return value;
        // 后面的放在 queryStatement中解析了
        // if (typeOf(value) === "date") {
        //     value = value.format("db");
        // }
        // var user = layout.user;
        // switch (value) {
            // case "@person":
            //     value = user.distinguishedName;
            //     break;
            // case "@identityList":
            //     value = user.identityList.map(function (d) {
            //         return d.distinguishedName;
            //     });
            //     break;
            // case "@unitList":
            //     o2.Actions.load("x_organization_assemble_express").UnitAction.listWithPerson({"personList": [user.distinguishedName]}, function (json) {
            //         value = json.unitList;
            //     }, null, false);
            //     break;
            // case "@unitAllList":
            //     o2.Actions.load("x_organization_assemble_express").UnitAction.listWithIdentitySupNested({"personList": [user.distinguishedName]}, function (json) {
            //         value = json.unitList;
            //     }, null, false);
            //     break;
        //     case "@year":
        //         value = (new Date().getFullYear()).toString();
        //         break;
        //     case "@season":
        //         var m = new Date().format("%m");
        //         if (["01", "02", "03"].contains(m)) {
        //             value = "1"
        //         } else if (["04", "05", "06"].contains(m)) {
        //             value = "2"
        //         } else if (["07", "08", "09"].contains(m)) {
        //             value = "3"
        //         } else {
        //             value = "4"
        //         }
        //         break;
        //     case "@month":
        //         value = new Date().format("%Y-%m");
        //         break;
        //     case "@time":
        //         value = new Date().format("db");
        //         break;
        //     case "@date":
        //         value = new Date().format("%Y-%m-%d");
        //         break;
        //     default:
        // }
        //
        // if (f.formatType === "dateTimeValue" || f.formatType === "datetimeValue") {
        //     value = "{ts '" + value + "'}"
        // } else if (f.formatType === "dateValue") {
        //     value = "{d '" + value + "'}"
        // } else if (f.formatType === "timeValue") {
        //     value = "{t '" + value + "'}"
        // }
        // return value;
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xDesktop.requireApp("process.Xform", "ViewSelector", null, false);
/** @class StatementSelector 查询视图选择组件。
 * @o2cn 查询视图选择
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var statementSelector = this.form.get("fieldId"); //获取组件
 * //方法2
 * var statementSelector = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.ViewSelector
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.StatementSelector = MWF.APPStatementSelector =  new Class({
	Implements: [Events],
	Extends: MWF.xApplication.process.Xform.ViewSelector,
    options: {
        /**
         * 视图参数（options）已经准备好，还未加载视图时执行。可以通过this.event得到视图参数，并可修改this.event修改视图的加载。
         * @since V8.2
         * @event MWF.xApplication.process.Xform.StatementSelector#beforeLoadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 视图设计已经获取，容器也已经准备好。
         * @event MWF.xApplication.process.Xform.StatementSelector#loadViewLayout
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 异步加载查询视图后执行。
         * @since V8.2
         * @event MWF.xApplication.process.Xform.StatementSelector#loadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 选中查询视图中的一条记录后执行。
         * @since V8.2
         * @event MWF.xApplication.process.Xform.StatementSelector#select
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 取消选中查询视图中的一条记录后执行。
         * @since V8.2
         * @event MWF.xApplication.process.Xform.StatementSelector#unselect
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 打开查询视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.StatementSelector#openDocument，可以通过this.event得到打开的文档参数
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 加载对话框的时候执行，this.event可以获取到对话框对象。
         * @event MWF.xApplication.process.Xform.ViewSelector#loadDialog
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 显示对话框的时候执行，this.event可以获取到对话框对象。
         * @event MWF.xApplication.process.Xform.ViewSelector#showDialog
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "loadDialog", 'showDialog', "beforeLoadView", "loadViewLayout", "loadView", "queryLoad", "postLoad", "select", "unselect", "openDocument"]
    },
    doResult: function(data){
        if (this.json.result === "script"){
            this.selectedData = data;
            return (this.json.selectedScript.code) ? this.form.Macro.exec(this.json.selectedScript.code, this) : "";
        }else{
            Object.each(this.json.selectedSetValues, function(v, k){
                var value = "";
                data.each(function(d, idx){
                    // Object.each(d, function(dv, dk){
                    //     if (dk===v) value = (value) ? (value+", "+dv) : dv;
                    // }.bind(this));

                    var pathList = v.split(".");
                    for( var i=0; i<pathList.length; i++ ){
                        var p = pathList[i];
                        if( (/(^[1-9]\d*$)/.test(p)) )p = p.toInt();
                        if( d[ p ] ){
                            d = d[ p ];
                        }else{
                            d = "";
                            break;
                        }
                    }

                    if( typeOf(d) === "array" || typeOf(d) === "object" ) {
                        d = JSON.stringify(d);
                    }

                    value = (value) ? (value+", "+d) : d;

                }.bind(this));

                var field = this.form.all[k];
                if (field){
                    field.setData(value);
                    if (value){
                        if (field.descriptionNode) field.descriptionNode.setStyle("display", "none");
                    }else{
                        if (field.descriptionNode) field.descriptionNode.setStyle("display", "block");
                    }
                }
            }.bind(this));
        }
    },
    getViewName: function (){
        var appName, statementName, statementId;
        if (this.json.statementType === "script") {
            if (this.json.statementScript && this.json.statementScript.code) {
                var data = this.form.Macro.exec(this.json.statementScript.code, this);
                if (typeOf(data) === 'object') {
                    appName = data.application;
                    statementName = data.statement;
                }else if(typeOf(data) === 'string'){
                    statementName = data;
                }
            }
        }else{
            appName = (this.json.queryStatement) ? this.json.queryStatement.appName : "";
            statementName =  (this.json.queryStatement) ? this.json.queryStatement.name : "";
            statementId = (this.json.queryStatement) ? this.json.queryStatement.id : "";
        }
        return {appName: appName, statementName: statementName, statementId: statementId};
    },
    selectView: function(callback){

        var viewObj = this.getViewName();
        var appName = viewObj.appName, statementName = viewObj.statementName, statementId = viewObj.statementId;
        if( !statementName && !statementId ){
            if(callback) callback();
            return ;
        }

        var filter = null;
        if (this.json.filterList && this.json.filterList.length){
            filter = [];
            this.json.filterList.each(function(entry){
                entry.value = this.form.Macro.exec(entry.code.code, this);
                //delete entry.code;
                filter.push(entry);
            }.bind(this));
        }

        var parameter = null;
        if( this.json.parameterList && this.json.parameterList.length ){
            parameter = {};
            this.json.parameterList.each(function(entry){
                parameter[entry.parameter] = this.parseParameter(entry);
            }.bind(this));
        }

        var viewJson = {
            "application": appName,
            "statementName": statementName,
            "statementId": statementId,
            "isTitle": this.json.isTitle || "yes",
            "select": this.json.select || "single",
            "titleStyles": this.json.titleStyles,
            "itemStyles": this.json.itemStyles,
            "isExpand": this.json.isExpand || "no",
            "showActionbar" : this.json.actionbar === "show",
            "filter": filter,
            "parameter": parameter,
            "defaultSelectedScript" : this.json.defaultSelectedScript ? this.json.defaultSelectedScript.code : null,
            "selectedAbleScript" : this.json.selectedAbleScript ? this.json.selectedAbleScript.code : null
        };

        this.viewJson = viewJson;

        var viewOptions = {
            "style": "select",
            "onLoadLayout": function () {
                this.fireEvent("loadViewLayout");
            }.bind(this),
            "onLoadView": function(){
                this.fireEvent("loadView");
            }.bind(this),
            "onSelect": function(item){
                this.fireEvent("select", [item]);
            }.bind(this),
            "onUnselect": function(item){
                this.fireEvent("unselect", [item]);
            }.bind(this),
            "onOpenDocument": function(options, item){
                this.openOptions = {
                    "options": options,
                    "item": item
                };
                this.fireEvent("openDocument", [this.openOptions]);
                this.openOptions = null;
            }.bind(this)
        };
        this.viewOptions = viewOptions;

        var _self = this;

        var dlgOptions = {
            title: this.json.title,
            width: this.json.DialogWidth || "850",
            height: this.json.DialogHeight || "700",
            style: this.json.viewStyle || "v10_view",
            "onPostLoad": function (){
                _self.fireEvent("loadDialog", [this]);
            },
            "onPostShow": function(){
                if(layout.mobile){
                    this.node.setStyle("z-index",200);
                }
                _self.fireEvent("showDialog", [this]);
            }
        };
        this.dialogOptions = dlgOptions;

        this.fireEvent("beforeLoadView", [viewJson]);

        this.form.Macro.environment.statement.select(viewJson, callback, dlgOptions, viewOptions, (viewer)=>{
            this.view = viewer;
        });
    },
    parseParameter: function (f) {
        var value = f.value;
        if( f.valueType === "script" ){
            value = this.form.Macro.exec(f.valueScript ? f.valueScript.code : "", this);
        }
        if (typeOf(value) === "date") {
            value = value.format("db");
        }
        var user = layout.user;
        switch (value) {
            case "@person":
                value = user.distinguishedName;
                break;
            case "@identityList":
                value = user.identityList.map(function (d) {
                    return d.distinguishedName;
                });
                break;
            case "@unitList":
                o2.Actions.load("x_organization_assemble_express").UnitAction.listWithPerson({"personList": [user.distinguishedName]}, function (json) {
                    value = json.unitList;
                }, null, false);
                break;
            case "@unitAllList":
                o2.Actions.load("x_organization_assemble_express").UnitAction.listWithIdentitySupNested({"personList": [user.distinguishedName]}, function (json) {
                    value = json.unitList;
                }, null, false);
                break;
            case "@year":
                value = (new Date().getFullYear()).toString();
                break;
            case "@season":
                var m = new Date().format("%m");
                if (["01", "02", "03"].contains(m)) {
                    value = "1"
                } else if (["04", "05", "06"].contains(m)) {
                    value = "2"
                } else if (["07", "08", "09"].contains(m)) {
                    value = "3"
                } else {
                    value = "4"
                }
                break;
            case "@month":
                value = new Date().format("%Y-%m");
                break;
            case "@time":
                value = new Date().format("db");
                break;
            case "@date":
                value = new Date().format("%Y-%m-%d");
                break;
            default:
        }

        if (f.formatType === "dateTimeValue" || f.formatType === "datetimeValue") {
            value = "{ts '" + value + "'}"
        } else if (f.formatType === "dateValue") {
            value = "{d '" + value + "'}"
        } else if (f.formatType === "timeValue") {
            value = "{t '" + value + "'}"
        }
        return value;
    }

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Subform 子表单组件。
 * @o2cn 子表单
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var subform = this.form.get("fieldId"); //获取组件
 * //方法2
 * var subform = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Subform = MWF.APPSubform = new Class(
    /** @lends MWF.xApplication.process.Xform.Subform# */
{
    Extends: MWF.APP$Module,
    options: {
        /**
         * 子表单的设计已经获取到，但还没有插入html及生成内部组件。
         * @event MWF.xApplication.process.Xform.Subform#beforeModulesLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 子表单的设计已经获取到，已经插入html，组件json已经获取到，但未生成内部组件。
         * @example
         * //获取子表单所有组件id
         * var moduleIdList = Object.keys(this.target.subformData.json.moduleList);
         * @event MWF.xApplication.process.Xform.Subform#modulesLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 子表单内部组件加载完成。
         * @example
         * //获取子表单所有组件id
         * var moduleIdList = Object.keys(this.target.subformData.json.moduleList);
         * //获取子表单所有组件
         * var moduleList = moduleIdList.map(function(id){
         *     return this.form.get(id, subformId); //subformId为当前子表单ID，布局组件有可能id冲突，通过subformId来确定当前子表单的组件
         * }.bind(this))
         * @event MWF.xApplication.process.Xform.Subform#afterModulesLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "beforeModulesLoad", "modulesLoad", "afterModulesLoad"]
    },

    _loadUserInterface: function () {
        /**
         * @ignore
         * @member parentLine
         * @memberOf MWF.xApplication.process.Xform.Subform#
         */

        this.node.empty();

        this.modules = [];
        this.moduleList = {};

        if (this.json.isDelay) {
            if (this.form.subformLoadedCount) {
                this.form.subformLoadedCount++;
            } else {
                this.form.subformLoadedCount = 1
            }
            this.form.checkSubformLoaded();
            this.checked = true;
        } else {

            this.getSubform(function () {
                this.loadSubform();
            }.bind(this));
        }
    },
    /**
     * @summary 当子表单被设置为延迟加载，通过active方法激活
     * @param {Function} callback 激活后的回调方法，另外已经激活过该方法还会被执行。
     * @example
     * var subform = this.form.get("fieldId");
     * subform.active(function(){
     *     //do someting
     * })
     */
    active: function (callback) {
        if (!this.loaded) {
            this.reload(callback)
        } else {
            if (callback) callback();
        }
    },
    /**
     * @summary 重新加载子表单
     * @param {Function} callback 刷新后的回调
     * @example
     * this.form.get("fieldId").reload(function(){
     *     //do someting
     * })
     */
    reload: function (callback) {
        this.clean();

        this.getSubform(function () {
            this.loadSubform();
            if (callback) callback();
        }.bind(this));
    },
    clean: function(){
        (this.modules || []).each(function(module){
            if( module.json && module.json.type === "Subform" ){
                if(module.clean)module.clean();
            }
        }.bind(this));

        Object.each(this.moduleList || {}, function (module, formKey) {
            if (this.form.all[module.id]) delete this.form.all[module.id];
            if (this.form.forms[module.id])delete this.form.forms[module.id];
            this.form.modules.erase(module);

            if( module.name ){
                delete this.form.allForName[module.name];
            }

            delete this.form.json.moduleList[formKey];
        }.bind(this));

        if( this.subformData && this.subformData.json.id ){
            var id = this.subformData.json.id;
            if( this.form.subformLoaded && this.form.subformLoaded.length ){
                this.form.subformLoaded.erase(id);
            }
            if( this.parentformIdList && this.parentformIdList.length){
                this.parentformIdList.erase(id);
            }
        }

        this.modules = [];
        this.moduleList = {};

        this.node.empty();
    },
    loadCss: function () {
        if (this.subformData.json.css && this.subformData.json.css.code) {

            var cssText = this.subformData.json.css.code;

            //删除注释
            cssText = cssText.replace(/\/\*[\s\S]*?\*\/\n|([^:]|^)\/\/.*\n$/g, '').replace(/\\n/, '');

            cssText = this.form.parseCSS(cssText);

            var rex = new RegExp("(.+)(?=\\{)", "g");
            var match;
            var id = this.form.json.id.replace(/\-/g, "");
            var prefix = ".css" + id + " ";

            while ((match = rex.exec(cssText)) !== null) {
                var rulesStr = match[0];
                var startWith = rulesStr.substring(0, 1);
                if (startWith === "@" || startWith === ":" || rulesStr.indexOf("%") !== -1) {

                }else if (rulesStr.trim()==='from' || rulesStr.trim()==='to'){

                } else {
                    if (rulesStr.indexOf(",") != -1) {
                        //var rules = rulesStr.split(/\s*,\s*/g);
                        var rules = rulesStr.split(/,/g);
                        rules = rules.map(function (r) {
                            return prefix + r;
                        });
                        var rule = rules.join(",");
                        cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                        rex.lastIndex = rex.lastIndex + (prefix.length * rules.length);

                    } else {
                        var rule = prefix + match[0];
                        cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                        rex.lastIndex = rex.lastIndex + prefix.length;
                    }
                }
            }

            var styleNode = $("style" + this.form.json.id);
            if (!styleNode) {
                var styleNode = document.createElement("style");
                styleNode.setAttribute("type", "text/css");
                styleNode.id = "style" + this.form.json.id;
                styleNode.inject(this.form.container, "before");
            }

            if (styleNode.styleSheet) {
                var setFunc = function () {
                    styleNode.styleSheet.cssText += cssText;
                };
                if (styleNode.styleSheet.disabled) {
                    setTimeout(setFunc, 10);
                } else {
                    setFunc();
                }
            } else {
                var cssTextNode = document.createTextNode(cssText);
                styleNode.appendChild(cssTextNode);
            }
        }
    },
    checkSubformNested: function (id) {
        if (!id) return true;
        if (this.parentformIdList) {
            return !this.parentformIdList.contains(id);
        } else {
            return ![this.form.json.id].contains(id);
        }
    },
    checkSubformUnique: function (id) {
        if (!id) return true;
        if (!this.form.subformLoaded) return true;
        return !this.form.subformLoaded.contains(id);
    },
    getParentformIdList: function () {
        var parentformIdList;
        if (this.parentformIdList) {
            parentformIdList = Array.clone(this.parentformIdList);
            parentformIdList.push(this.subformData.json.id)
        } else {
            parentformIdList = [this.form.json.id, this.subformData.json.id];
        }
        return parentformIdList;
    },
    loadSubform: function () {
        if (this.subformData) {
            if (!this.checkSubformNested(this.subformData.json.id)) {
                this.form.notice(MWF.xApplication.process.Xform.LP.subformNestedError, "error");
            } else if (!this.checkSubformUnique(this.subformData.json.id)) {
                this.form.notice(MWF.xApplication.process.Xform.LP.subformUniqueError, "error");
            } else {
                //this.form.addEvent("postLoad", function(){

                this.fireEvent("beforeModulesLoad");

                this.loadCss();

                this.modules = [];
                this.moduleList = {};

                this.node.set("html", this.subformData.html);
                Object.each(this.subformData.json.moduleList, function (module, key) {
                    var formKey = key;
                    if( this.json.isReadonly )module.isReadonly = true;
                    if (this.form.json.moduleList[key]) {
                        formKey = this.json.id + "_" + key;
                        var moduleNode = this.node.getElement("#" + key);
                        if (moduleNode) moduleNode.set("id", formKey);
                        module.id = formKey;
                        module._originId = key;
                        module._subform = this.json.id;
                    }
                    this.form.json.moduleList[formKey] = module;
                    this.moduleList[formKey] = module;
                }.bind(this));

                this.fireEvent("modulesLoad");

                var moduleNodes = this.form._getModuleNodes(this.node);
                moduleNodes.each(function (node) {
                    if (node.get("MWFtype") !== "form") {
                        var _self = this;
                        var json = this.form._getDomjson(node);
                        //if( json.type === "Subform" || json.moduleName === "subform" )this.form.subformCount++;
                        var module = this.form._loadModule(json, node, function () {
                            this.parentformIdList = _self.getParentformIdList();
                        });
                        this.form.modules.push(module);
                        this.modules.push(module);
                    }
                }.bind(this));

                this.form.subformLoaded.push(this.subformData.json.id);

                this.fireEvent("afterModulesLoad");

                //}.bind(this));
            }
        }
        if (!this.checked) {
            if (this.form.subformLoadedCount) {
                this.form.subformLoadedCount++;
            } else {
                this.form.subformLoadedCount = 1
            }
            this.form.checkSubformLoaded();
        }
        //console.log( "add subformLoadedCount , this.form.subformLoadedCount = "+ this.form.subformLoadedCount)

        /**
         * @summary 表单是否加载（激活）过。
         * @member {Boolean}
         * @example
         * if( !this.form.get("fieldId").loaded ){ //判断子表单是否加载过
         *     this.form.get("fieldId").active(); //没有加载过则激活
         * }
         */
        this.loaded = true;
        this.checked = true;
    },
    getSubform: function (callback) {
        var method = (this.form.json.mode !== "Mobile" && !layout.mobile) ? "getForm" : "getFormMobile";

        if (this.json.subformType === "script") {
            if (this.json.subformScript && this.json.subformScript.code) {
                var data = this.form.Macro.exec(this.json.subformScript.code, this);
                if (data) {
                    var formName, app;
                    if (typeOf(data) === "string") {
                        formName = data;
                    } else {
                        if (data.application) app = data.application;
                        if (data.subform) formName = data.subform;
                    }
                    if (formName) {
                        if (!app) app = (this.form.businessData.work || this.form.businessData.workCompleted).application;
                        MWF.Actions.get("x_processplatform_assemble_surface")[method](formName, app, function (json) {
                            this.getSubformData(json.data);
                            if (callback) callback();
                        }.bind(this));
                    } else {
                        this.subformData = null;
                        if (callback) callback();
                    }
                } else {
                    this.subformData = null;
                    if (callback) callback();
                }
            }
        } else {
            if (this.json.subformSelected && this.json.subformSelected !== "none") {
                var subformData = (this.form.app.relatedFormMap) ? this.form.app.relatedFormMap[this.json.subformSelected] : null;
                if (subformData) {
                    this.getSubformData({"data": subformData.data});
                    if (callback) callback();
                } else {
                    var app;
                    if (this.json.subformAppSelected) {
                        app = this.json.subformAppSelected;
                    } else {
                        app = (this.form.businessData.work || this.form.businessData.workCompleted).application;
                    }
                    MWF.Actions.get("x_processplatform_assemble_surface")[method](this.json.subformSelected, app, function (json) {
                        this.getSubformData(json.data);
                        if (callback) callback();
                    }.bind(this));
                }
            } else {
                this.subformData = null;
                if (callback) callback();
            }
        }
    },
    getSubformData: function (data) {
        if (!data || typeOf(data) !== "object") return;
        var subformDataStr = null;
        // if ( this.form.json.mode !== "Mobile" && !layout.mobile){
        //     subformDataStr = data.data;
        // }else{
        //     subformDataStr = data.mobileData;
        // }
        subformDataStr = data.data;
        this.subformData = null;
        if (subformDataStr) {
            if( this.form.isParseLanguage ) {
                var jsonStr = o2.bindJson(MWF.decodeJsonString(subformDataStr), {"lp": MWF.xApplication.process.Xform.LP.form});
                this.subformData = JSON.decode(jsonStr);
            }else{
                this.subformData = JSON.decode(MWF.decodeJsonString(subformDataStr));
            }
            this.subformData.updateTime = data.updateTime;
        }
    }
});


MWF.xApplication.process.Xform.SubmitForm = MWF.APPSubmitform = new Class({
    Extends: MWF.APPSubform,
    _loadUserInterface: function () {
        // this.node.empty();
        this.getSubform(function () {
            this.loadSubform();
        }.bind(this));
    },
    reload: function () {
        // this.node.empty();
        this.getSubform(function () {
            this.loadSubform();
        }.bind(this));
    },
    show: function ( defaultRoute ) {
        if (this.json.submitScript && this.json.submitScript.code) {
            this.form.Macro.environment.defaultRoute = defaultRoute;
            this.form.Macro.exec(this.json.submitScript.code, this);
        }
        // this.fireSubFormEvent("load");
    },
    // fireSubFormEvent : function( name ){
    //     var events = this.subformData.json.events;
    //     if( events && events[name] && events[name]["code"] ){
    //         this.form.Macro.exec(events[name]["code"], this);
    //     }
    // },
    loadSubform: function () {
        if (this.subformData) {
            if (!this.checkSubformUnique(this.subformData.json.id)) { //如果提交表单已经嵌入到表单中，那么把这个表单弹出来
                // this.form.notice(MWF.xApplication.process.Xform.LP.subformUniqueError, "error");
                this.isEmbedded = true;
                this.fireEvent("afterModulesLoad");
            } else if (!this.checkSubformNested(this.subformData.json.id)) {
                this.form.notice(MWF.xApplication.process.Xform.LP.subformNestedError, "error");
            } else {
                //this.form.addEvent("postLoad", function(){

                // this.fireSubFormEvent("queryLoad");

                this.fireEvent("beforeModulesLoad");

                this.loadCss();

                this.node.set("html", this.subformData.html);
                Object.each(this.subformData.json.moduleList, function (module, key) {
                    var formKey = key;
                    if (this.form.json.moduleList[key]) {
                        formKey = this.json.id + "_" + key;
                        var moduleNode = this.node.getElement("#" + key);
                        if (moduleNode) moduleNode.set("id", formKey);
                        module.id = formKey;
                        module._originId = key;
                        module._subform = this.json.id;
                    }
                    this.form.json.moduleList[formKey] = module;
                }.bind(this));

                var moduleNodes = this.form._getModuleNodes(this.node);
                moduleNodes.each(function (node) {
                    if (node.get("MWFtype") !== "form") {
                        var _self = this;
                        var json = this.form._getDomjson(node);
                        //if( json.type === "Subform" || json.moduleName === "subform" )this.form.subformCount++;
                        var module = this.form._loadModule(json, node, function () {
                            this.parentformIdList = _self.getParentformIdList();
                        });
                        this.form.modules.push(module);
                    }
                }.bind(this));

                this.form.subformLoaded.push(this.subformData.json.id);
                this.fireEvent("afterModulesLoad");
                // this.fireSubFormEvent("postLoad");
                // this.fireSubFormEvent("load");
                // this.fireSubFormEvent("afterLoad");
            }
        }
        // if( this.form.subformLoadedCount ){
        //     this.form.subformLoadedCount++;
        // }else{
        //     this.form.subformLoadedCount = 1
        // }
        // this.form.checkSubformLoaded();
    },
    getSubform: function (callback) {
        var method = (this.form.json.mode !== "Mobile" && !layout.mobile) ? "getForm" : "getFormMobile";
        if (this.json.submitFormType === "script") {
            if (this.json.submitFormScript && this.json.submitFormScript.code) {
                var data = this.form.Macro.exec(this.json.submitFormScript.code, this);
                if (data) {
                    var formName, app;
                    if (typeOf(data) === "string") {
                        formName = data;
                    } else {
                        if (data.application) app = data.application;
                        if (data.form) formName = data.form;
                    }
                    if (formName) {
                        if (!app) app = (this.form.businessData.work || this.form.businessData.workCompleted).application;
                        MWF.Actions.get("x_processplatform_assemble_surface")[method](formName, app, function (json) {
                            this.getSubformData(json.data);
                            if (callback) callback();
                        }.bind(this));
                    } else {
                        this.subformData = null;
                        if (callback) callback();
                    }
                } else {
                    this.subformData = null;
                    if (callback) callback();
                }
            }
        } else {
            if (this.json.submitFormSelected && this.json.submitFormSelected !== "none") {
                var app;
                if (this.json.submitFormAppSelected) {
                    app = this.json.submitFormAppSelected;
                } else {
                    app = (this.form.businessData.work || this.form.businessData.workCompleted).application;
                }
                MWF.Actions.get("x_processplatform_assemble_surface")[method](this.json.submitFormSelected, app, function (json) {
                    this.getSubformData(json.data);
                    if (callback) callback();
                }.bind(this));
            } else {
                this.subformData = null;
                if (callback) callback();
            }
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xApplication.process.Xform.Subpage = MWF.APPSubpage =  new Class({
    Extends: MWF.APP$Module,

    _loadUserInterface: function(){
        this.node.empty();

        this.modules = [];
        this.moduleList = {};

        this.getSubpage(function(){
            this.loadSubpage();
        }.bind(this));
    },
    reload: function(){
        this.clean();

        this.getSubpage(function(){
            this.loadSubpage();
        }.bind(this));
    },
    clean: function(){
        (this.modules || []).each(function(module){
            this.form.modules.erase(module);
        }.bind(this));

        Object.each(this.moduleList || {}, function (module, formKey) {
            delete this.form.json.moduleList[formKey];
        }.bind(this));

        if( this.subpageData && this.subpageData.json.id ){
            var id = this.subpageData.json.id;
            // if( this.form.subformLoaded && this.form.subformLoaded.length ){
            //     this.form.subformLoaded.erase(id);
            // }
            if( this.parentpageIdList && this.parentpageIdList.length){
                this.parentpageIdList.erase(id);
            }
        }

        if( this.json.id && this.form.subpageModules && this.form.subpageModules[ this.json.id ] ){
            this.form.subpageModules[ this.json.id ] = {}
        }

        this.modules = [];
        this.moduleList = {};

        this.node.empty();
    },
    loadCss: function(){
        if (this.subpageData.json.css && this.subpageData.json.css.code){
            var cssText = this.form.parseCSS(this.subpageData.json.css.code);
            var rex = new RegExp("(.+)(?=\\{)", "g");
            var match;
            var id = this.form.json.id.replace(/\-/g, "");
            while ((match = rex.exec(cssText)) !== null) {
                var prefix = ".css" + id + " ";
                var rule = prefix + match[0];
                cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                rex.lastIndex = rex.lastIndex + prefix.length;
            }

            var styleNode = $("style"+this.form.json.id);
            if (!styleNode){
                var styleNode = document.createElement("style");
                styleNode.setAttribute("type", "text/css");
                styleNode.id="style"+this.form.json.id;
                styleNode.inject(this.form.container, "before");
            }

            if(styleNode.styleSheet){
                var setFunc = function(){
                    styleNode.styleSheet.cssText += cssText;
                };
                if(styleNode.styleSheet.disabled){
                    setTimeout(setFunc, 10);
                }else{
                    setFunc();
                }
            }else{
                var cssTextNode = document.createTextNode(cssText);
                styleNode.appendChild(cssTextNode);
            }
        }
    },
    checkSubpageNested : function( id ){
        if( this.parentpageIdList ){
            return !this.parentpageIdList.contains( id );
        }else{
            return ![ this.form.json.id ].contains( id );
        }
    },
    getParentpageIdList : function(){
        var parentpageIdList;
        if( this.parentpageIdList ){
            parentpageIdList = Array.clone( this.parentpageIdList );
            parentpageIdList.push( this.subpageData.json.id )
        }else{
            parentpageIdList = [ this.form.json.id, this.subpageData.json.id ];
        }
        return parentpageIdList;
    },
    loadSubpage: function(){
        if (this.subpageData ){
            if( this.checkSubpageNested( this.subpageData.json.id ) ){
                //this.form.addEvent("postLoad", function(){

                this.loadCss();

                this.form.subpageModules =  this.form.subpageModules || {};
                var subpageModules = this.form.subpageModules[ this.json.id ] = {};

                var params = this.getPageParamenters();
                if( typeOf(params) === "object" && this.form.Macro && this.form.Macro.environment ){
                    var environment = this.form.Macro.environment;
                    environment.subpageParameters = environment.subpageParameters || {};
                    environment.subpageParameters[ this.json.id ] = params;
                }

                this.node.set("html", this.subpageData.html);
                Object.each(this.subpageData.json.moduleList, function(module, key){
                    var formKey = key;
                    if (this.form.json.moduleList[key]){
                        formKey = this.json.id+"_"+key;
                        var moduleNode = this.node.getElement("#"+key);
                        if (moduleNode) moduleNode.set("id", formKey);
                        module.orgiginalId = key;
                        module.id = formKey;
                    }
                    this.form.json.moduleList[formKey] = module;
                    this.moduleList[formKey] = module;
                }.bind(this));

                var moduleNodes = this.form._getModuleNodes(this.node);
                moduleNodes.each(function(node){
                    if (node.get("MWFtype")!=="form"){
                        var _self = this;
                        var json = this.form._getDomjson(node);
                        var module = this.form._loadModule(json, node, function(){
                            this.subpage = _self;
                            this.parentpageIdList = _self.getParentpageIdList();
                        });
                        this.form.modules.push(module);
                        this.modules.push(module);
                        subpageModules[ json.orgiginalId || json.id ] = module;
                    }
                }.bind(this));
                //}.bind(this));
            }else{
                this.form.notice(MWF.xApplication.process.Xform.LP.subpageNestedError, "error");
            }
        }
        if( this.form.subpageLoadedCount ){
            this.form.subpageLoadedCount++;
        }else{
            this.form.subpageLoadedCount = 1
        }
        this.form.checkSubformLoaded();
    },
    getSubpage: function(callback){
        var method = (this.form.json.mode !== "Mobile" && !layout.mobile) ? "getPageByName": "getPageByNameMobile";

        if (this.json.subpageType==="script"){
            if (this.json.subpageScript && this.json.subpageScript.code){
                var formNome = this.form.Macro.exec(this.json.subpageScript.code, this);
                if (formNome){
                    var app = this.form.businessData.pageInfor.portal;
                    o2.Actions.get("x_portal_assemble_surface")[method](formNome, app, function(json){
                        this.getSubpageData(json.data);
                        if (callback) callback();
                    }.bind(this));
                }else{
                    if (callback) callback();
                }
            }
        }else{
            if (this.json.subpageSelected && this.json.subpageSelected!=="none"){
                var app = this.form.businessData.pageInfor.portal;
                o2.Actions.get("x_portal_assemble_surface")[method](this.json.subpageSelected, app, function(json){
                    this.getSubpageData(json.data);
                    if (callback) callback();
                }.bind(this));
            }else{
                if (callback) callback();
            }
        }
    },
    getSubpageData: function(data){
        var subpageDataStr = null;
        // if (this.form.json.mode !== "Mobile" && !layout.mobile){
        //     subpageDataStr = data.data;
        // }else{
        //     subpageDataStr = data.mobileData;
        // }
        subpageDataStr = data.data;
        this.subpageData = null;
        if (subpageDataStr){
            var jsonStr = o2.bindJson(MWF.decodeJsonString(subpageDataStr),  {"lp": MWF.xApplication.process.Xform.LP.form});
            this.subpageData = JSON.decode(jsonStr);
            this.subpageData.updateTime = data.updateTime;
        }
    },
    getPageParamenters : function(){
        var params = null;
        if( this.json.parameterType === "map" ){
            params = this.json.parametersMapList;
        }else if( this.json.parameterType === "script" ){
            var code = (this.json.parametersScript) ? this.json.parametersScript.code : "";
            if (code){
                params = this.form.Macro.exec(code, this);
            }
        }
        return params;
    }
});

MWF.xDesktop.requireApp('process.Xform', '$Module', null, false);
//COMMON.AjaxModule.load("JSONTemplate", null, false);
/** @class SubSource 子数据源。
 * @o2cn 子数据源
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var subSource = this.form.get("fieldId"); //获取组件
 * //方法2
 * var subSource = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.SubSource = MWF.APPSubSource = new Class(
    /** @lends MWF.xApplication.process.Xform.SubSource# */
    {
        Extends: MWF.APP$Module,
        options: {
            /**
             * 加载数据后执行，但这时还未加载下属组件，可以可以使用this.target.data获取数据进行修改。
             * @event MWF.xApplication.process.Xform.SubSource#postLoadData
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 加载数据、下属组件后执行。
             * @event MWF.xApplication.process.Xform.SubSource#loadData
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            moduleEvents: ['queryLoad', 'postLoad', 'load', 'postLoadData', 'loadData'],
        },
        load: function () {
            /**
             * @ignore
             * @member parentLine
             * @memberOf MWF.xApplication.process.Xform.SubSource#
             */

            this._loadModuleEvents();
            this._queryLoaded();
            this._loadUserInterface();
            // this._loadStyles();
            //this._loadEvents();
            // this._loadDomEvents();

            this._afterLoaded();
        },
        _loadUserInterface: function () {
            this.loopNodes = [];
            this.subSourceItems = [];
            var node = new Element('div.subsource').inject(this.node, 'before');
            // var node = this.node.clone(false).inject(this.node, "before");
            // this.node.inject(node);
            this.loopNode = this.node.dispose();
            this.node = node;
            var id = node.get('id');
            node.set('id', '');
            this.node.set({
                id: id,
                mwftype: node.get('mwftype'),
            });
            this.node.store('module', this);
            this._loadJsonData();
        },
        _getSource: function () {
            var parent = this.node.getParent();
            while (
                parent &&
                parent.get('MWFtype') != 'source' &&
                parent.get('MWFtype') != 'subSource' &&
                parent.get('MWFtype') != 'subSourceItem'
            )
                parent = parent.getParent();
            return parent ? parent.retrieve('module') : null;
        },
        _getSourceData: function (sourceData) {
            var data = sourceData;
            if (this.json.jsonPath != '.') {
                var paths = this.json.jsonPath.split('.');
                paths.each(
                    function (p) {
                        data = data[p];
                    }.bind(this),
                );
            }
            /**
             * @summary 该属性获取当前子数据源的数据，当所在上级数据源加载完成后才有值。
             * @member {Array|Object|String|Number|Boolean|Null}
             * @example
             * var field = this.form.get("fieldId").data; //获取子数据源数据
             */
            this.data = data;
        },
        _loopSub: function (dom, i) {
            var _self = this;
            var moduleNodes = this.form._getModuleNodes(dom);
            moduleNodes.each(
                function (node) {
                    var json = this.form._getDomjson(node);
                    var subJson = Object.clone(json);
                    subJson.id = subJson.id + '_' + i;
                    node.set('id', subJson.id);

                    var module = this.form._loadModule(
                        subJson,
                        node,
                        function () {
                            if (_self.widget) this.widget = _self.widget;
                        },
                        true,
                    );
                    //this.modules.push(module);
                }.bind(this),
            );
        },
        _loopData: function () {
            var _self = this;
            this.data.each(
                function (d, i) {
                    var node = this.loopNode.clone(true, true);
                    node.inject(this.node);
                    var json = Object.clone(this.json);
                    json.id = json.id + '_' + i;
                    json.type = 'SubSourceItem';
                    node.set({
                        id: json.id,
                        mwftype: 'subSourceItem',
                    });

                    var module = this.form._loadModule(
                        json,
                        node,
                        function () {
                            if (_self.widget) this.widget = _self.widget;
                            this.data = d;
                            this.position = i;
                        },
                        true,
                    );
                    this.subSourceItems.push(module);
                    this.loopNodes.push(node);

                    this._loopSub(node, i);
                }.bind(this),
            );
        },
        _initSubSource: function () {
            if (this.loopNode) {
                var moduleNodes = this.form._getModuleNodes(this.node);
                moduleNodes.each(
                    function (node) {
                        var module = node.retrieve('module');
                        if (module) {
                            if (module.json.type == 'SubSource') {
                                module._initSubSource();
                            } else {
                                MWF.release(module);
                            }
                        }
                    }.bind(this),
                );
                this.node.empty();
            }
            this.loopNodes = [];
            this.subSourceItems = [];
        },
        _loadJsonData: function (notInit) {
            if (!notInit) this._initSubSource();
            this.source = this._getSource();
            if (this.source) {
                if (this.source.data) {
                    this._getSourceData(this.source.data);
                    this.fireEvent('postLoadData');
                    if (typeOf(this.data) !== 'array') this.data = [this.data];
                    if (typeOf(this.data) == 'array') {
                        this._loopData();
                        this.fireEvent('loadData');
                    } else {
                        var _self = this;
                        this.form._loadModules(
                            this.node,
                            function () {
                                if (_self.widget) this.widget = _self.widget;
                            },
                            true,
                        );
                    }

                    //this.tmpDiv = new Element("div");
                    //var html = "{loop:"+this.json.jsonPath+"}"+this.node.outerHTML+"{/loop:"+this.json.jsonPath+"}";
                    ////this.template = new Template();
                    ////var loopHtml = this.template.substitute("{"+this.json.jsonPath+"}", this.source.data);
                    //this.node.set("text", this.text);
                }
            }
        },
    },
);

MWF.xApplication.process.Xform.SubSourceItem = MWF.APPSubSourceItem = new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function () {
        this.loopNodes = [];
        this.subSourceItems = [];
    },
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.require("MWF.widget.Tab", null, false);
/** @class Tab 分页组件。
 * @o2cn 分页组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var tab = this.form.get("fieldId"); //获取组件
 * //方法2
 * var tab = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Tab = MWF.APPTab =  new Class(
    /** @lends MWF.xApplication.process.Xform.Tab# */
{
	Extends: MWF.APP$Module,

	_loadUserInterface: function(){
        this.elements = [];
        this.containers = [];

        var style = "form";
        if (layout.mobile) style = "mobileForm";

        /**
         * @summary tab组件，平台使用该组件实现分页组件的功能
         * @member {MWF.widget.Tab}
         * @example
         *  //可以在脚本中获取该组件
         * var tab = this.form.get("fieldId").tab; //获取组件对象
         * var pages = tab.pages //获取每个分页
         * pages[1].addEvent("queryShow", function(){
         *     //添加显示分页前事件
         * })
         * pages[1].addEvent("postShow", function(){
         *     //添加显示分页后事件
         * })
         * pages[1]._showTab(); //显示第2个分页
         */
		this.tab = new MWF.widget.Tab(this.node, {"style": style});
		
		this._setTabWidgetStyles();

		this.tab.tabNodeContainer = this.node.getFirst("div");
		this.tab.contentNodeContainer = this.tab.tabNodeContainer.getNext("div");

		var lastNode = this.tab.tabNodeContainer.getLast();
		var tabs;
		if (lastNode && lastNode.hasClass("tabNodeContainerLeft")){
            this.tab.tabNodeContainerRight = this.tab.tabNodeContainer.getFirst();
            this.tab.tabNodeContainerLeft = lastNode;
            this.tab.tabNodeContainerArea = lastNode.getFirst();

            var menuNode = this.node.getElement(".MWFMenu");
            if (menuNode) menuNode.destroy();
            this.tab.load();
            tabs = this.tab.tabNodeContainerArea.getChildren("div");
        }else{
            tabs = this.tab.tabNodeContainer.getChildren("div");
            this.tab.load();
        }

		var contents = this.tab.contentNodeContainer.getChildren("div");
		tabs.each(function(tab, idx){
			this.tab.rebuildTab(contents[idx], contents[idx].getFirst(), tab);
		}.bind(this));

		if( this.json.defaultIndex && this.tab.pages[this.json.defaultIndex]){
            this.tab.pages[this.json.defaultIndex]._showTab();
        }else{
            this.tab.pages[0]._showTab();
        }
        this.loadSubModule();
	},
    loadSubModule: function(){
        this.tab.pages.each(function(page){
            var node = page.tabNode;
            var json = this.form._getDomjson(node);
            var tab = this;
            var module = this.form._loadModule(json, node, function(){
                if( tab.widget )this.widget = tab.widget;
                this.tab = tab;
            });
            this.elements.push(module);
            this.form.modules.push(module);

            if( json.width && json.width.toInt()>60 ){
                node.setStyle("width", json.width+"px");
            }
            if( json.description){
                node.set("title", json.description);
            }
            if (page.isShow){
                this.showContentModule.call(page, this);
            }else{
                if (this.json.isDelay){
                    var _self = this;
                    page.showContentModuleFun = function(){_self.showContentModule.call(page, _self)};
                    page.addEvent("show", page.showContentModuleFun);
                }else{
                    this.showContentModule.call(page, this);
                }
            }
        }.bind(this));
    },
    showContentModule: function(_self){
	    var page = this;
        var node = this.contentNode;
        node.isLoadModule = true;
        var json = _self.form._getDomjson(node);
        var tab = _self;
        var module = _self.form._loadModule(json, node, function(){
            if( _self.widget )this.widget = _self.widget;
            this.tab = tab;
            this.page = page;
        });
        _self.containers.push(module);
        _self.form.modules.push(module);

        if (this.showContentModuleFun) this.removeEvent("show", this.showContentModuleFun);
    },

	_setTabWidgetStyles: function(){
        if (this.json.tabNodeContainer) this.tab.css.tabNodeContainer = Object.clone(this.json.tabNodeContainer);
        if (this.json.contentNodeContainer) this.tab.css.contentNodeContainer = Object.clone(this.json.contentNodeContainer);
		this.tab.css.tabNode = Object.clone(this.json.tabStyles);
		this.tab.css.tabTextNode = Object.clone(this.json.tabTextStyles);
		this.tab.css.tabNodeCurrent = Object.clone(this.json.tabCurrentStyles);
		this.tab.css.tabTextNodeCurrent = Object.clone(this.json.tabTextCurrentStyles);
	}
});
MWF.xApplication.process.Xform.tab$Page = MWF.APPTab$Page =  new Class({
    Extends: MWF.APP$Module
});
MWF.xApplication.process.Xform.tab$Content = MWF.APPTab$Content =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        var _self = this;
        this.form._loadModules(this.node, function () {
            if( _self.widget )this.widget = _self.widget;
        });
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Table 表格组件。
 * @o2cn 表格
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var table = this.form.get("fieldId"); //获取组件
 * //方法2
 * var table = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Table = MWF.APPTable =  new Class(
    /** @lends MWF.xApplication.process.Xform.Table# */
{
	Extends: MWF.APP$Module,
	_afterLoaded: function(){
        /**
         * @summary table，DOM对象
         * @member {Element} table
         * @memberOf MWF.xApplication.process.Xform.Table#
         * @example
         *  //可以在脚本中获取该组件
         * var table = this.form.get("fieldId").table; //获取组件对象
         */
        if (!this.table) this.table = this.node.getElement("table");
		//var tds = this.node.getElements("td");
		var rows = this.table.rows;
		for (var i=0; i<rows.length; i++){
		    var row = rows[i];
            for (var j=0; j<row.cells.length; j++){
                var td = row.cells[j];

                var json = this.form._getDomjson(td);
                if (json){
                    var table = this;
                    var module = this.form._loadModule(json, td, function(){
                        if( table.widget )this.widget = table.widget;
                        this.table = table;
                    });
                    this.form.modules.push(module);
                }
            }
        }

        // this.table.rows.each(function(row){
        //     row.cells.each(function(td){
        //         var json = this.form._getDomjson(td);
        //         var table = this;
        //         var module = this.form._loadModule(json, td, function(){
        //             this.table = table;
        //         });
        //
        //         this.form.modules.push(module);
        //     }.bind(this));
        // }.bind(this));


		// tds.each(function(td){
		// 	var json = this.form._getDomjson(td);
         //    var table = this;
		// 	var module = this.form._loadModule(json, td, function(){
         //        this.table = table;
         //    });
        //
		// 	this.form.modules.push(module);
		// }.bind(this));
	},
    _loadBorderStyle: function(){
        if( this.json.styles && this.json.styles["table-layout"] ){
            this.table.setStyle("table-layout",this.json.styles["table-layout"]);
        }
        if (this.json.styles && this.json.styles.border){
            if (!this.table) this.table = this.node.getElement("table");
            if (!this.json.styles["border-collapse"]) this.table.setStyle("border-collapse","separate");
            this.table.set("cellspacing", "0");
            this.table.setStyles({
                "border-top": this.json.styles.border,
                "border-left": this.json.styles.border
            });
            var ths = this.table.getElements("th");
            ths.setStyles({
                "border-bottom": this.json.styles.border,
                "border-right": this.json.styles.border
            });
            var tds = this.table.getElements("td");
            tds.setStyles({
                "border-bottom": this.json.styles.border,
                "border-right": this.json.styles.border
                //"background": "transparent"
            });
        }
    },
    _loadStyles: function(){
        Object.each(this.json.styles, function(value, key){
            var reg = /^border\w*/ig;
            if (!key.test(reg)){
                this.node.setStyle(key, value);
            }
        }.bind(this));
        //if (this.form.json["$version"]!=="5.2")
            this._loadBorderStyle();

        if(this.json.tableStyles){
            if( !this.table )this.table = this.node.getElement("table");
            if(this.table)this.table.setStyles( this.json.tableStyles );
        }
    }
});
/** @class Table$Td 单元格组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var td = this.form.get("fieldId"); //获取组件
 * //方法2
 * var td = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Table$Td = MWF.APPTable$Td =  new Class({
	Extends: MWF.APP$Module,
    _loadStyles: function(){

        var addStyles = {};
        if (this.json.cellType=="title"){
            addStyles = this.table.json.titleTdStyles;
        }
        if (this.json.cellType=="content"){
            addStyles = this.table.json.contentTdStyles;
        }
        if (this.json.cellType=="layout"){
            addStyles = this.table.json.layoutTdStyles;
        }
        Object.each(addStyles, function(value, key){
            if ((value.indexOf("x_processplatform_assemble_surface")!==-1 || value.indexOf("x_portal_assemble_surface")!==-1) && !value.includes("../")){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                value = o2.filterUrl(value);
                this.node.setStyle(key, value);
            }else{
                if (!this.json.preprocessing) this.node.setStyle(key, value);
            }

        }.bind(this));


        Object.each(this.json.styles, function(value, key){
            if ((value.indexOf("x_processplatform_assemble_surface")!==-1 || value.indexOf("x_portal_assemble_surface")!==-1) && !value.includes("../")){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                value = o2.filterUrl(value);
            }
            this.node.setStyle(key, value);
           
        }.bind(this));

        //table的 _loadBorderStyle 会忽略当前单元格的边框
        Object.each(this.json.recoveryStyles || {}, function(value, key){
            if( key.indexOf("border") === 0 ){
                this.node.setStyle(key, value);
            }
        }.bind(this));

        if (this.json.cellType=="content"){
            this.form.addEvent("postLoad", function(){
                var inputs = this.node.getElements("input");
                inputs.each(function(input){
                    var inputType = input.get("type").toLowerCase();
                    if (inputType!="radio" && inputType!="checkbox" && inputType!="submit" && inputType!="buttom" && inputType!="image"){
                        var style = input.getStyle("width");
                        if( !style || style === "auto")input.setStyle("width", "100%");
                    }
                }.bind(this));
                var textareas = this.node.getElements("textarea");
                textareas.each(function(textarea){
                    var style = textarea.getStyle("width");
                    if( !style || style === "auto")textarea.setStyle("width", "100%");
                }.bind(this));

            }.bind(this))
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @class Textarea 多行文本组件。
 * @o2cn 多行文本输入
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Textarea = MWF.APPTextarea =  new Class({
	Implements: [Events],
	Extends: MWF.APP$Input,
    _loadNode: function(){
        if (!this.isReadable && !!this.isHideUnreadable){
            this.node.setStyle('display', 'none');
        }else{
            if (this.isReadonly()){
                this._loadNodeRead();
            }else{
                this._loadNodeEdit();
            }
        }  
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
    },
    _loadMergeEditNodeByDefault: function(){
        var data = this.getSortedSectionData();
        data = data.map(function(d){ return d.data; });
        this._setBusinessData( data.join("\n") );
        this._loadNode();
    },

    getInputData: function(){
        if( this.isReadonly()) {
            return this._getBusinessData();
        }else if (this.node.getFirst()){
            return this.node.getFirst().get("value");
        }else{
            return this._getBusinessData();
        }
    },

    toHtml: function(value){
        var reg = new RegExp("\n","g");
        var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
        var reg3 = new RegExp("\u003e","g");
        return ( value || "").replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
    },

    __setData: function(data){
        var old = this.getInputData();
        this._setBusinessData(data);
        if( this.isReadonly()){
            this.node.set("html", this.toHtml(data));
        }else if (this.node.getFirst()){
            this.node.getFirst().set("value", data);
            this.checkDescription();
            this.validationMode();
        }else{
            this.node.set("html", this.toHtml(data));
        }
        if (old!==data) this.fireEvent("change");
        this.moduleValueAG = null;
    },


    _setValue: function(value){
	    if (!value) value = "";
        var p = o2.promiseAll(value).then(function(v){
            if (o2.typeOf(v)=="array") v = v[0];
            this._setBusinessData(v);
            if (this.node.getFirst()) this.node.getFirst().set("value", v || "");
            if (this.isReadonly()){
                this.node.set("html", this.toHtml(value));
            }
            this.fieldModuleLoaded = true;
            //this.__setValue(v);
        }.bind(this), function(){});
        this.moduleValueAG = p;
        p.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));

        // this.moduleValueAG = o2.AG.all(value).then(function(v){
        //     this.moduleValueAG = null;
        //     if (o2.typeOf(v)=="array") v = v[0];
        //     this._setBusinessData(v);
        //     if (this.node.getFirst()) this.node.getFirst().set("value", v || "");
        //     if (this.readonly || this.json.isReadonly){
        //         var reg = new RegExp("\n","g");
        //         var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
        //         var reg3 = new RegExp("\u003e","g");
        //         var text = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
        //         this.node.set("html", text);
        //     }
        // }.bind(this));
        //
        // if (this.moduleValueAG) this.moduleValueAG.then(function(){
        //     this.moduleValueAG = null;
        // }.bind(this));

        return value;

        // if (value && value.isAG){
        //     this.moduleValueAG = value;
        //     value.addResolve(function(v){
        //         this._setValue(v);
        //     }.bind(this));
        // }else{
        //     this._setBusinessData(value);
        //     if (this.node.getFirst()) this.node.getFirst().set("value", value || "");
        //     if (this.readonly || this.json.isReadonly){
        //         var reg = new RegExp("\n","g");
        //         var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
        //         var reg3 = new RegExp("\u003e","g");
        //         var text = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
        //         this.node.set("html", text);
        //     }
        //     return value;
        // }
    },

    getTextData: function(){
        //var value = this.node.get("value");
        //var text = this.node.get("text");
        if (this.isReadonly()){
            var value = this._getBusinessData();
            return {"value": [value || ""] , "text": [value || ""]};
        }else{
            var value = (this.node.getFirst()) ? this.node.getFirst().get("value") : this.node.get("text");
            var text = (this.node.getFirst()) ? this.node.getFirst().get("text") : this.node.get("text");
            return {"value": [value || ""] , "text": [text || value || ""]};
        }
    },

    // _setValue: function(value){
    //     this._setBusinessData(value);
    //     if (this.node.getFirst()) this.node.getFirst().set("value", value || "");
    //     if (this.readonly || this.json.isReadonly){
    //             var reg = new RegExp("\n","g");
    //             var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
    //             var reg3 = new RegExp("\u003e","g");
    //             var text = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
    //             this.node.set("html", text);
    //     }
    // },
    _resetNodeEdit: function(){
        var input = new Element("textarea", {"styles": {
                "background": "transparent",
                "width": (this.json.inputStyles && this.json.inputStyles.width) ? this.json.inputStyles.width : "100%",
                "border": "0px"
            }});
        var node = new Element("div", {"styles": {
                // "ovwrflow": (this.json.styles && this.json.styles.overflow) ? this.json.styles.overflow : "hidden",
                "position": "relative",
                "padding-right": "2px"
            }}).inject(this.node, "after");
        input.inject(node);
        this.node.destroy();
        this.node = node;
    },
    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        if( !input && this.nodeHtml ){
            this.node.set("html", this.nodeHtml);
            input = this.node.getFirst();
        }
        input.set(this.json.properties);

        if( this.form.json.textareaDisableResize )input.setStyle("resize","none");

		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type
		});
        this.node.addEvent("change", function(){
            this._setBusinessData(this.getInputData());
            this.fireEvent("change");
        }.bind(this));

        this.node.addEvent("input", function(e){
            var v=e.target.get("value");
            this._setBusinessData(v);
        }.bind(this));

        this.node.getFirst().addEvent("blur", function(){
            this.validation();
        }.bind(this));
        this.node.getFirst().addEvent("keyup", function(){
            this.validationMode();
        }.bind(this));
	},
	_afterLoaded: function(){
        if (!this.readonly){
            this.loadDescription();
        }
	},
    loadDescription: function(){
        if (this.isReadonly())return;
        var v = this._getBusinessData();
        if (!v){
            if (this.json.description){
             var size, w;
                if( this.node.offsetParent === null ){ //隐藏
                    size = { y: 26 }
                }else{
                    size = this.node.getFirst().getSize();
                    // w = size.x-3;
                    // if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ){
                    //     w = size.x-23;
                    // }
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.descriptionNode.setStyles({
                    "width": "auto",
                    "overflow": "auto"
                });
                // if( w )this.descriptionNode.setStyles({
                //     "width": ""+w+"px"
                // });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            if (COMMON.Browser.Platform.name==="ios"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                    }.bind(this)
                });
            }else if (COMMON.Browser.Platform.name==="android"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                    }.bind(this)
                });
            }else{
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                    }.bind(this)
                });
            }
            this.node.getFirst().addEvents({
                "focus": function(){
                    this.descriptionNode.setStyle("display", "none");
                }.bind(this),
                "blur": function(){
                    if (!this.node.getFirst().get("value")) this.descriptionNode.setStyle("display", "block");
                }.bind(this)
            });
        }
    },

    setExcelData: function (d) {
        var value = d.replace(/&#10;/g,"\n"); //换行符&#10;
        this.excelData = value;
        this.setData(value, true);
    }

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/**树组件数据结构
 * @typedef {Object} TreeData
 * @example
 * [
 * {
 *    "expand": true, //是否默认展开
 *    "title": "", //鼠标移上叶子节点的文字
 *    "text": "根节点", //叶子节点的文字
 *    "action": "", //执行的脚本
 *    "default": true, //是否默认选中
 *    "icon": "folder.png", //图标
 *    "sub": [ //该节点的子节点
 *      {
 *        "expand": true,
 *        "title": "",
 *        "text": "[none]",
 *        "action": "",
 *        "default": false,
 *        "icon": "folder.png",
 *        "sub": []
 *      },
 *      ...
 *    ]
 *  }
 * ]
 */

/** @class Tree 树组件。
 * @o2cn 树组件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datagrid = this.form.get("name"); //获取组件
 * //方法2
 * var datagrid = this.target; //在组件事件脚本中获取
 * @see {@link TreeData|树组件数据结构}
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Tree = MWF.APPTree =  new Class(
	/** @lends MWF.xApplication.process.Xform.Tree# */
{
	Extends: MWF.APP$Module,
	options: {
		/**
		 * 异步加载树前执行。this.target指向当前组件。
		 * @event MWF.xApplication.process.Xform.Tree#beforeLoadTree
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		/**
		 * 异步加载树后执行。this.target指向当前组件。
		 * @event MWF.xApplication.process.Xform.Tree#afterLoadTree
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		/**
		 * 加载树的叶子前执行。this.target指向加载的叶子。
		 * @event MWF.xApplication.process.Xform.Tree#beforeLoadTreeNode
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		/**
		 * 加载树的叶子后执行。this.target指向加载的叶子。
		 * @event MWF.xApplication.process.Xform.Tree#afterLoadTreeNode
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		/**
		 * 加载树的叶子后执行。this.target指向加载的叶子。
		 * @event MWF.xApplication.process.Xform.Tree#expand
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		/**
		 * 折叠节点的时候执行。this.target指向被折叠的节点。
		 * @event MWF.xApplication.process.Xform.Tree#collapse
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		/**
		 * 选中节点前执行。此时原来被选中的节点还未取消。this.target指向选中的节点。
		 * @event MWF.xApplication.process.Xform.Tree#beforeSelect
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		/**
		 * 选中节点后执行。this.target指向选中的节点。
		 * @event MWF.xApplication.process.Xform.Tree#afterSelect
		 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
		 */
		"moduleEvents": ["load", "queryLoad", "postLoad", "beforeLoadTree", "afterLoadTree", "beforeLoadTreeNode", "afterLoadTreeNode", "expand", "collapse", "beforeSelect", "afterSelect"]
	},

	_loadUserInterface: function(){
		this.node.empty();

		MWF.require("MWF.widget.Tree", function(){
			var options = {"style":"form"};
			if( this.json.events && typeOf(this.json.events) === "object" ){
				[
					{ "beforeLoadTree" :  "onQueryLoad" },
					{ "afterLoadTree" :  "onPostLoad" },
					{ "beforeLoadTreeNode" :  "onBeforeLoadTreeNode" },
					{ "afterLoadTreeNode" :  "onAfterLoadTreeNode" },
					{ "expand" :  "onPostExpand" },
					{ "collapse" :  "onPostCollapse" },
					{ "beforeSelect" : "onBeforeSelect" },
					{ "afterSelect" : "onAfterSelect" }
				].each( function (obj) {
					var moduleEvent = Object.keys(obj)[0];
					var treeEvent = obj[moduleEvent];
					if( this.json.events[moduleEvent] && this.json.events[moduleEvent].code ){
						options[treeEvent] = function( target ){
							return this.form.Macro.fire(this.json.events[moduleEvent].code, target || this);
						}.bind(this)
					}
				}.bind(this));
			}

			/**
			 * @summary 树组件，平台使用该组件实现树的功能，该组件为异步加载
			 * @member {o2.widget.Tree}
			 * @example
			 *  //可以在脚本中获取该组件
			 * var tree = this.form.get("fieldId").tree; //获取组件对象
			 * var children = tree.children[]; //获取第一层树叶
			 * tree.reLoad( json ); //给整颗树重新赋数据，并重新加载
			 */
			this.tree = new MWF.widget.Tree(this.node, options);
			this.tree.form = this.form;

			this._setTreeWidgetStyles();


			var treeData = this.json.data;
			if (this.json.dataType == "script") treeData = this.form.Macro.exec(((this.json.dataScript) ? this.json.dataScript.code : ""), this);

			this.tree.load(treeData);
		}.bind(this));
	},
	_setTreeWidgetStyles: function(){
		this.tree.css.areaNode = this.json.areaNodeStyle;
		this.tree.css.treeItemNode = this.json.treeItemNodeStyle;
		this.tree.css.textDivNode = this.json.textDivNodeStyle;
		this.tree.css.textDivNodeSelected = this.json.textDivNodeSelectedStyle;
	}
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
//MWF.xDesktop.requireApp("process.Xform", "widget.View", null, false);
/** @class View 视图组件。
 * @o2cn 视图
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var view = this.form.get("fieldId"); //获取组件
 * //方法2
 * var view = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.View = MWF.APPView =  new Class(
    /** @lends MWF.xApplication.process.Xform.View# */
{
	Extends: MWF.APP$Module,
    options: {
        /**
         * 视图参数（options）已经准备好，还未加载视图时执行。可以通过this.event得到视图参数，并可修改this.event修改视图的加载。
         * @event MWF.xApplication.process.Xform.View#beforeLoadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 视图设计已经获取，容器也已经准备好。可以通过this.event得到视图参数，并可修改this.event修改视图的加载。
         * @event MWF.xApplication.process.Xform.View#loadViewLayout
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 异步加载视图后执行。
         * @event MWF.xApplication.process.Xform.View#loadView
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 选中视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.View#select
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 取消选中视图中的一条记录后执行。
         * @since V8.0
         * @event MWF.xApplication.process.Xform.View#unselect
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 打开视图中的一条记录后执行。
         * @event MWF.xApplication.process.Xform.View#openDocument，可以通过this.event得到打开的文档参数
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "beforeLoadView", "loadViewLayout", "loadView", "queryLoad", "postLoad", "select", "unselect", "openDocument"]
    },

    _loadUserInterface: function(){
        MWF.xDesktop.requireApp("query.Query", "Viewer", null, false);
        this.node.empty();
    },
    _afterLoaded: function(){
        if(!!this.json.viewType){
            this.loadView();
        }else if (this.json.queryView){
            this.loadView();
        }else{
            if (this.json.selectViewType==="cms"){
                this.loadCMSView();
            }else if (this.json.selectViewType==="process"){
                this.loadPrcessView();
            }else{
                this.loadView();
            }
        }
    },
    /**
     * @summary 重新加载视图
     * @param callback {Function} 刷新后的回调.
     * @example
     * this.form.get("fieldId").reload()
     */
    reload: function( callback ){
        if (this.view){
            if (this.view.loadViewRes && this.view.loadViewRes.res) if (this.view.loadViewRes.res.isRunning()) this.view.loadViewRes.res.cancel();
            if (this.view.getViewRes && this.view.getViewRes.res) if (this.view.getViewRes.res.isRunning()) this.view.getViewRes.res.cancel();
        }
        this.node.empty();
        this.loadView( callback, true );
    },
    /**
     * @summary 当视图被设置为延迟加载（未立即载入），通过active方法激活
     * @example
     * this.form.get("fieldId").active()
     */
    active: function( callback ){
        if (this.view){
            if (!this.view.loadingAreaNode) this.view.loadView( callback );
        }else{
            this.loadView( callback, true );
        }
    },
    getViewName: function (){
        var appName, viewName;
        if (this.json.viewType === "script") {
            if (this.json.viewScript && this.json.viewScript.code) {
                var data = this.form.Macro.exec(this.json.viewScript.code, this);
                if (data) {
                    appName = data.application;
                    viewName = data.view;
                }
            }
        }else{
            appName = (this.json.queryView) ? this.json.queryView.appName : this.json.application;
            viewName = (this.json.queryView) ? this.json.queryView.name : this.json.viewName;
        }
        return {appName: appName, viewName: viewName};
    },
    loadView: function( callback, force ){
        var viewObj = this.getViewName();
        var appName = viewObj.appName, viewName = viewObj.viewName;
        if( !appName || !viewName ){
            if(callback) callback();
            return ;
        }

        var filter = null;
        if (this.json.filterList && this.json.filterList.length){
            filter = [];
            this.json.filterList.each(function(entry){
                entry.value = this.form.Macro.exec(entry.code.code, this);
                //delete entry.code;
                filter.push(entry);
            }.bind(this));
        }

        //var data = JSON.parse(this.json.data);
        var viewJson = {
            "application": appName,
            "viewName": viewName,
            "isTitle": this.json.isTitle || "yes",
            "select": this.json.select || "none",
            "titleStyles": this.json.titleStyles,
            "itemStyles": this.json.itemStyles,
            "isExpand": this.json.isExpand || "no",
            "showActionbar" : this.json.actionbar === "show",
            "filter": filter,
            "defaultSelectedScript" : this.json.defaultSelectedScript ? this.json.defaultSelectedScript.code : null,
            "selectedAbleScript" : this.json.selectedAbleScript ? this.json.selectedAbleScript.code : null
        };

        this.fireEvent("beforeLoadView", [viewJson]);

        //MWF.xDesktop.requireApp("query.Query", "Viewer", function(){

        /**
         * @summary view组件，平台使用该组件实现视图的功能
         * @member {MWF.xApplication.query.Query.Viewer}
         * @example
         *  //可以在脚本中获取该组件
         * var view = this.form.get("fieldId").view; //获取组件对象
         */
            this.view = new MWF.xApplication.query.Query.Viewer(this.node, viewJson, {
                "isload": force || (this.json.loadView!=="no"),
                "resizeNode": (this.node.getStyle("height").toString().toLowerCase()!=="auto" && this.node.getStyle("height").toInt()>0),
                "onLoadLayout": function () {
                    this.fireEvent("loadViewLayout");
                }.bind(this),
                "onLoadView": function(){
                    this.fireEvent("loadView");
                    if(callback)callback();
                }.bind(this),
                "onSelect": function(item){
                    this.fireEvent("select", [item]);
                }.bind(this),
                "onUnselect": function(item){
                    this.fireEvent("unselect", [item]);
                }.bind(this),
                "onOpenDocument": function(options, item){
                    this.openOptions = {
                        "options": options,
                        "item": item
                    };
                    this.fireEvent("openDocument", [this.openOptions]);
                    this.openOptions = null;
                }.bind(this)
            }, this.form.app, this.form.Macro);
        //}.bind(this));
    },

    loadPrcessView: function(){
        var filter = null;
        if (this.json.filterList && this.json.filterList.length){
            filter = [];
            this.json.filterList.each(function(entry){
                entry.value = this.form.Macro.exec(entry.code.code, this);
                //delete entry.code;
                filter.push(entry);
            }.bind(this));
        }
        var viewJson = {
            "application": this.json.processView.application,
            "viewName": this.json.processView.name,
            "isTitle": this.json.isTitle || "yes",
            "select": this.json.select || "none",
            "titleStyles": this.json.titleStyles,
            "itemStyles": this.json.itemStyles,
            "isExpand": this.json.isExpand || "no",
            "showActionbar" : this.json.actionbar === "show",
            "filter": filter
        };
        MWF.xDesktop.requireApp("process.Application", "Viewer", function(){
            this.view = new MWF.xApplication.process.Application.Viewer(this.node, viewJson, {
                "resizeNode": (this.node.getStyle("height").toString().toLowerCase()!=="auto" && this.node.getStyle("height").toInt()>0),
                "onSelect": function(){
                    this.fireEvent("select");
                }.bind(this)
            });
        }.bind(this));
    },
    loadCMSView: function(){
        var filter = null;
        if (this.json.filterList && this.json.filterList.length){
            filter = [];
            this.json.filterList.each(function(entry){
                entry.value = this.form.Macro.exec(entry.code.code, this);
                //delete entry.code;
                filter.push(entry);
            }.bind(this));
        }
        var viewJson = {
            "application": this.json.cmsView.appId,
            "viewName": this.json.cmsView.name,
            "isTitle": this.json.isTitle || "yes",
            "select": this.json.select || "none",
            "titleStyles": this.json.titleStyles,
            "itemStyles": this.json.itemStyles,
            "isExpand": this.json.isExpand || "no",
            "showActionbar" : this.json.actionbar === "show",
            "filter": filter
        };

        MWF.xDesktop.requireApp("process.Application", "Viewer", function(){
            this.view = new MWF.xApplication.process.Application.Viewer(this.node, viewJson, {
                "actions": {
                    "lookup": {"uri": "/jaxrs/queryview/flag/{view}/application/flag/{application}/execute", "method":"PUT"},
                    "getView": {"uri": "/jaxrs/queryview/flag/{view}/application/flag/{application}"}
                },
                "actionRoot": "x_cms_assemble_control",
                "resizeNode": (this.node.getStyle("height").toString().toLowerCase()!=="auto" && this.node.getStyle("height").toInt()>0),
                "onSelect": function(){
                    this.fireEvent("select");
                }.bind(this)
            });
        }.bind(this));
    },
    /**
     * @summary 获取视图被选中行的数据
     * @return {Object[]} 被选中行的数据
     * @example
     * var data = this.form.get("fieldId").getData();
     */
    getData: function(){
        if (this.view.selectedItems.length){
            var arr = [];
            this.view.selectedItems.each(function(item){
                arr.push(item.data);
            });
            return arr;
        }else{
            return [];
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Widget 门户的部件组件。
 * @o2cn 部件
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var widget = this.form.get("fieldId"); //获取组件
 * //方法2
 * var widget = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Widget = MWF.APPWidget =  new Class(
    /** @lends MWF.xApplication.process.Xform.Widget# */
    {
    Extends: MWF.APP$Module,
    options: {
        /**
         * 部件的设计已经获取到，但还没有插入html及生成内部组件。
         * @event MWF.xApplication.process.Xform.Widget#beforeModulesLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 部件的设计已经获取到，已经插入html，组件json已经获取到，但未生成内部组件。
         * * @example
         * //获取部件所有组件id
         * var moduleIdList = Object.keys(this.target.widgetData.json.moduleList);
         * @event MWF.xApplication.process.Xform.Widget#modulesLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 部件内部组件加载完成。
         * @example
         * //获取部件所有组件id
         * var moduleIdList = Object.keys(this.target.widgetData.json.moduleList);
         * //获取部件所有组件
         * var moduleList = moduleIdList.map(function(id){
         *     return this.form.get(id, widgetId); //widgetId为当前部件ID，布局组件有可能id冲突，通过widgetId来确定当前部件的组件
         * }.bind(this))
         * @event MWF.xApplication.process.Xform.Widget#afterModulesLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "beforeModulesLoad", "modulesLoad", "afterModulesLoad"]
    },

    _loadUserInterface: function(){
        this.node.empty();

        this.modules = [];
        this.moduleList = {};

        if (this.json.isDelay) {
            if (this.form.widgetLoadedCount) {
                this.form.widgetLoadedCount++;
            } else {
                this.form.widgetLoadedCount = 1
            }
            this.form.checkSubformLoaded();
            this.checked = true;
        } else {
            this.getWidget(function(){
                this.loadWidget();
            }.bind(this));
        }
    },
    /**
     * @summary 当部件被设置为延迟加载，通过active方法激活
     * @param {Function} callback 激活后的回调方法，另外已经激活过该方法还会被执行。
     * @example
     * var widget = this.form.get("fieldId");
     * widget.active(function(){
     *     //do someting
     * })
     */
    active: function (callback) {
        if (!this.loaded) {
            this.reload(callback)
        } else {
            if (callback) callback();
        }
    },
    /**
     * @summary 重新加载部件
     * @param callback {Function} 刷新后的回调.
     * @example
     * this.form.get("fieldId").reload()
     */
    reload: function( callback ){
        this.clean();

        this.getWidget(function(){
            this.loadWidget( callback );
        }.bind(this));
    },
    clean: function(){
        (this.modules || []).each(function(module){
            if( module.json && module.json.type === "Widget" ){
                if(module.clean)module.clean();
            }
        }.bind(this));

        Object.each(this.moduleList || {}, function (module, formKey) {
            if (this.form.all[module.id]) delete this.form.all[module.id];
            if (this.form.forms[module.id])delete this.form.forms[module.id];
            this.form.modules.erase(module);

            if( module.name ){
                delete this.form.allForName[module.name];
            }

            delete this.form.json.moduleList[formKey];
        }.bind(this));

        if( this.widgetData && this.widgetData.json.id ){
            var id = this.widgetData.json.id;
            // if( this.form.subformLoaded && this.form.subformLoaded.length ){
            //     this.form.subformLoaded.erase(id);
            // }
            if( this.parentpageIdList && this.parentpageIdList.length){
                this.parentpageIdList.erase(id);
            }
        }

        if( this.json && this.json.id && this.form.widgetModules && this.form.widgetModules[ this.json.id ] ){
            this.form.widgetModules[ this.json.id ] = {};
        }

        this.modules = [];
        this.moduleList = {};

        this.node.empty();
    },
    loadCss: function(){
        if (this.widgetData.json.css && this.widgetData.json.css.code){

            var cssText = this.widgetData.json.css.code;

            //删除注释
            cssText = cssText.replace(/\/\*[\s\S]*?\*\/\n|([^:]|^)\/\/.*\n$/g, '').replace(/\\n/, '');
            cssText = this.form.parseCSS(cssText);

            var rex = new RegExp("(.+)(?=\\{)", "g");
            var match;
            var id = this.form.json.id.replace(/\-/g, "");
            var prefix = ".css" + id + " ";

            while ((match = rex.exec(cssText)) !== null) {
                var rulesStr = match[0];
                var startWith = rulesStr.substring(0, 1);
                if (startWith === "@" || startWith === ":" || rulesStr.indexOf("%") !== -1) {

                }else if (rulesStr.trim()==='from' || rulesStr.trim()==='to'){

                } else {
                    if (rulesStr.indexOf(",") != -1) {
                        //var rules = rulesStr.split(/\s*,\s*/g);
                        var rules = rulesStr.split(/,/g);
                        rules = rules.map(function (r) {
                            return prefix + r;
                        });
                        var rule = rules.join(",");
                        cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                        rex.lastIndex = rex.lastIndex + (prefix.length * rules.length);

                    } else {
                        var rule = prefix + match[0];
                        cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                        rex.lastIndex = rex.lastIndex + prefix.length;
                    }
                }
            }

            var styleNode = $("style"+this.form.json.id);
            if (!styleNode){
                var styleNode = document.createElement("style");
                styleNode.setAttribute("type", "text/css");
                styleNode.id="style"+this.form.json.id;
                styleNode.inject(this.form.container, "before");
            }

            if(styleNode.styleSheet){
                var setFunc = function(){
                    styleNode.styleSheet.cssText += cssText;
                };
                if(styleNode.styleSheet.disabled){
                    setTimeout(setFunc, 10);
                }else{
                    setFunc();
                }
            }else{
                var cssTextNode = document.createTextNode(cssText);
                styleNode.appendChild(cssTextNode);
            }
        }
    },
    checkWidgetNested : function( id ){
        if( this.parentpageIdList ){
            return !this.parentpageIdList.contains( id );
        }else{
            return ![ this.form.json.id ].contains( id );
        }
    },
    getParentpageIdList : function(){
        var parentpageIdList;
        if( this.parentpageIdList ){
            parentpageIdList = Array.clone( this.parentpageIdList );
            parentpageIdList.push( this.widgetData.json.id )
        }else{
            parentpageIdList = [ this.form.json.id, this.widgetData.json.id ];
        }
        return parentpageIdList;
    },
    loadWidget: function( callback ){
        if (this.widgetData ){
            if( this.checkWidgetNested( this.widgetData.json.id ) ){
                //this.form.addEvent("postLoad", function(){

                this.fireEvent("beforeModulesLoad");

                this.loadCss();

                this.modules = [];
                this.moduleList = {};

                this.form.widgetModules =  this.form.widgetModules || {};
                var widgetModules = this.form.widgetModules[ this.json.id ] = {};

                var params = this.getPageParamenters();
                if( typeOf(params) === "object" && this.form.Macro && this.form.Macro.environment ){
                    var environment = this.form.Macro.environment;
                    environment.widgetParameters = environment.widgetParameters || {};
                    environment.widgetParameters[ this.json.id ] = params;
                }

                this.node.set("html", this.widgetData.html);
                if( this.widgetData.json.styles ){
                    this.node.getFirst().setStyles(this.widgetData.json.styles);
                }

                Object.each(this.widgetData.json.moduleList, function(module, key){
                    var formKey = key;
                    if (this.form.json.moduleList[key]){
                        formKey = this.json.id+"_"+key;
                        var moduleNode = this.node.getElement("#"+key);
                        if (moduleNode) moduleNode.set("id", formKey);
                        module.orgiginalId = key;
                        module.id = formKey;
                    }
                    this.form.json.moduleList[formKey] = module;
                    this.moduleList[formKey] = module;
                }.bind(this));

                this.fireEvent("modulesLoad");

                var moduleNodes = this.form._getModuleNodes(this.node);
                moduleNodes.each(function(node){
                    if (node.get("MWFtype")!=="form"){
                        var _self = this;
                        var json = this.form._getDomjson(node);
                        var module = this.form._loadModule(json, node, function(){
                            this.widget = _self;
                            this.parentpageIdList = _self.getParentpageIdList();
                        });
                        this.form.modules.push(module);
                        this.modules.push(module);

                        widgetModules[ json.orgiginalId || json.id ] = module;
                    }
                }.bind(this));

                this.fireEvent("afterModulesLoad");

                if(callback)callback();

                //}.bind(this));
            }else{
                this.form.notice(MWF.xApplication.process.Xform.LP.widgetNestedError, "error");
            }
        }
        if( this.form.widgetLoadedCount ){
            this.form.widgetLoadedCount++;
        }else{
            this.form.widgetLoadedCount = 1
        }
        this.form.checkSubformLoaded();
    },
    getWidget: function(callback){
        var method = (this.form.options.mode !== "Mobile" && !layout.mobile) ? "getWidgetByName" : "getWidgetByNameMobile";
        if (this.json.widgetType==="script"){
            if (this.json.widgetScript && this.json.widgetScript.code){
                var data = this.form.Macro.exec(this.json.widgetScript.code, this);
                if (data){
                    var widgetName, app;
                    if (typeOf(data) === "string") {
                        widgetName = data;
                    } else {
                        if (data.application) app = data.application;
                        if (data.widget) widgetName = data.widget;
                    }
                    if (widgetName) {
                        if (!app)  app = this.form.businessData.pageInfor.portal;
                        o2.Actions.get("x_portal_assemble_surface")[method](widgetName, app, function(json){
                            this.getWidgetData(json.data);
                            if (callback) callback();
                        }.bind(this));
                    }else{
                        this.widgetData = null;
                        if (callback) callback();
                    }
                }else{
                    this.widgetData = null;
                    if (callback) callback();
                }
            }
        }else{
            if (this.json.widgetSelected && this.json.widgetSelected!=="none"){

                var widgetData = (this.form.app.relatedFormMap) ? this.form.app.relatedFormMap[this.json.widgetSelected] : null;
                if (widgetData){
                    this.getWidgetData({"data": widgetData.data});
                    if (callback) callback();

                }else{
                    var app;
                    if (this.json.widgetAppSelected) {
                        app = this.json.widgetAppSelected;
                    } else {
                        app = this.form.businessData.pageInfor.portal;
                    }
                    o2.Actions.get("x_portal_assemble_surface")[method](this.json.widgetSelected, app, function(json){
                        this.getWidgetData(json.data);
                        if (callback) callback();
                    }.bind(this));
                }
            }else{
                this.widgetData = null;
                if (callback) callback();
            }
        }
    },
    getWidgetData: function(data){
        var widgetDataStr = null;
        //if (this.form.options.mode !== "Mobile" && !layout.mobile){
        //    widgetDataStr = data.data;
        //}else{
        //    widgetDataStr = data.mobileData;
        //}
        widgetDataStr = data.data;
        this.widgetData = null;
        if (widgetDataStr){
            if( this.form.isParseLanguage ){
                var jsonStr = o2.bindJson(MWF.decodeJsonString(widgetDataStr),  {"lp": MWF.xApplication.process.Xform.LP.form});
                this.widgetData = JSON.decode(jsonStr);
            }else{
                this.widgetData = JSON.decode(MWF.decodeJsonString(widgetDataStr));
            }
            this.widgetData.updateTime = data.updateTime;
        }
    },
    /**
     * @summary 获取设计部件时设置的参数
     * @return 设置的参数
     * @example
     * var param = this.form.get("fieldId").getPageParamenters()
     */
    getPageParamenters : function(){
        var params = null;
        if( this.json.parameterType === "map" ){
            params = this.json.parametersMapList;
        }else if( this.json.parameterType === "script" ){
            var code = (this.json.parametersScript) ? this.json.parametersScript.code : "";
            if (code){
                params = this.form.Macro.exec(code, this);
            }
        }
        return (this.widgetData.json.defaultParameters) ? Object.assign({}, this.widgetData.json.defaultParameters, params) : params;
        // return params;
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class WritingBoard 手写板组件。
 * @o2cn 手写板
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var writingBoard = this.form.get("name"); //获取组件
 * //方法2
 * var writingBoard = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.WritingBoard = MWF.APPWritingBoard = new Class(
    /** @lends MWF.xApplication.process.Xform.WritingBoard# */
    {
        Implements: [Events],
        Extends: MWF.APP$Module,
        options: {
            "moduleEvents": ["load", "queryLoad", "postLoad","change"]
        },
        initialize: function (node, json, form, options) {
            this.node = $(node);
            this.node.store("module", this);
            this.json = json;
            this.form = form;
            this.field = true;
            this.fieldModuleLoaded = false;
        },
        _loadUserInterface: function(){
            this.field = true;
            this.node.empty();

            if ( this.isSectionMergeRead() ) { //区段合并显示
                this._loadMergeReadNode();
            }else{
                // if( this.isSectionMergeEdit() ){
                //     this._loadMergeEditNode();
                // }else{
                this._loadNode();
                // }
            }
        },
        _loadMergeReadContentNode: function( contentNode, data ){
            //ontentNode.set("text", data.data)
            this._loadNode( contentNode, data.data, true );
        },
        _loadNode: function (node, data, readonly) {
            node = node || this.node;
            if (!readonly && !this.isReadonly()) {

                var actionNode = new Element("div").inject(node);
                actionNode.set({
                    //"id": this.json.id,
                    "text": this.json.name || this.json.id,
                    "styles": this._parseStyles(this.json.actionStyles || {})
                });
                actionNode.addEvent("click", function () {
                    this.validationMode();
                    var d = this._getBusinessData();
                    if (layout.mobile) {
                        window.setTimeout(function () {
                            this.handwriting(d);
                        }.bind(this), 100)
                    } else {
                        this.handwriting(d);
                    }
                }.bind(this));
            }


            data = data || this._getBusinessData();
            if (data) {
                var img = new Element("img", {
                    src: MWF.xDesktop.getImageSrc(data)
                });
                if (this.json.imageStyles) {
                    img.setStyles(this._parseStyles(this.json.imageStyles));
                }
                if( !this.json.imageStyles || !this.json.imageStyles["max-width"] ){
                    img.setStyles({
                        "max-width": "90%"
                    })
                }
                img.inject(node);
            }

            this.fieldModuleLoaded = true;
        },
        getTextData: function () {
            var value = this._getBusinessData() || "";
            return {"value": [value], "text": [value]};
        },
        /**
         * @summary 判断组件值是否为空.
         * @example
         * if( this.form.get('fieldId').isEmpty() ){
         *     this.form.notice('请进行手写', 'warn');
         * }
         * @return {Boolean} 值是否为空.
         */
        isEmpty: function () {
            return !this.getData();
        },
        /**
         * 获取手写图片的ID。
         * @summary 获取手写图片的ID。
         * @example
         * var id = this.form.get('fieldId').getData(); //获取手写图片的ID
         * var url = MWF.xDesktop.getImageSrc( id ); //获取图片的url
         */
        getData: function (data) {
            return this._getBusinessData() || "";
        },
        setData: function (data) {
            this._setBusinessData(data);
            var img = this.node.getElement("img");
            if( !data ){
                if(img)img.destroy();
                return;
            }
            if (img){
                img.set("src", MWF.xDesktop.getImageSrc(data))
            }else{
                img = new Element("img", {
                    src: MWF.xDesktop.getImageSrc(data)
                }).inject(this.node);
            }
            if (this.json.imageStyles) {
                img.setStyles(this._parseStyles(this.json.imageStyles));
            }
            if( !this.json.imageStyles || !this.json.imageStyles["max-width"] ){
                img.setStyles({
                    "max-width": "90%"
                })
            }
        },
        /**
         * @summary 弹出手写板.
         * @example
         * this.form.get("fieldId").handwriting();
         */
        handwriting: function () {
            if (!this.handwritingNode) this.createHandwriting();
            this.handwritingNode.show();
            if (layout.mobile) {
                this.handwritingNode.setStyles({
                    "top": "0px",
                    "left": "0px"
                });

            } else {
                this.handwritingNode.position({
                    "relativeTo": this.form.app.content || this.form.container,
                    "position": "center",
                    "edge": "center"
                });
                //var p = this.handwritingNode.getPosition(this.form.app.content);
                var p = this.handwritingNode.getPosition(this.handwritingNode.getOffsetParent());
                var top = p.y;
                var left = p.x;
                if (p.y < 0) top = 10;
                if (p.x < 0) left = 10;
                this.handwritingNode.setStyles({
                    "top": "" + top + "px",
                    "left": "" + left + "px"
                });
            }

        },
        createHandwriting: function () {
            /**
             * @summary 手写板容器.
             * @member {Element}
             */
            this.handwritingNode = new Element("div", {"styles": this.form.css.handwritingNode}).inject(this.node, "after");
            var x, y;
            if(layout.mobile){
                var bodySize = $(document.body).getSize();
                x = bodySize.x;
                y = bodySize.y;
                this.json.tabletWidth = 0;
                this.json.tabletHeight = 0;
            }else{
                var size = this.node.getSize();
                x = Math.max(this.json.tabletWidth || size.x, 600);
                this.json.tabletWidth = x;
                y = Math.max(this.json.tabletHeight ? (parseInt(this.json.tabletHeight) + 110) : size.y, 320);
            }

            var zidx = this.node.getStyle("z-index").toInt() || 0;
            zidx = (zidx < 1000) ? 1000 : zidx;
            this.handwritingNode.setStyles({
                "height": "" + y + "px",
                "width": "" + x + "px",
                "z-index": zidx + 1
            });
            if (layout.mobile) {
                this.handwritingNode.addEvent('touchmove', function (e) {
                    e.preventDefault();
                });
                this.handwritingNode.setStyles({
                    "top": "0px",
                    "left": "0px"
                }).inject($(document.body));
            } else {
                this.handwritingNode.position({
                    "relativeTo": this.node,
                    "position": "center",
                    "edge": "center"
                });
            }
            this.handwritingAreaNode = new Element("div", {"styles": this.form.css.handwritingAreaNode}).inject(this.handwritingNode);
            if( !layout.mobile ){
                this.handwritingActionNode = new Element("div", {
                    "styles": this.form.css.handwritingActionNode,
                    "text": MWF.xApplication.process.Work.LP.saveWrite
                }).inject(this.handwritingNode);
                var h = this.handwritingActionNode.getSize().y + this.handwritingActionNode.getStyle("margin-top").toInt() + this.handwritingActionNode.getStyle("margin-bottom").toInt();
                h = y - h;
                this.handwritingAreaNode.setStyle("height", "" + h + "px");
            }else{
                this.handwritingAreaNode.setStyle("height", "" + y + "px");
            }

            this.handwritingFile = {};
            MWF.require("MWF.widget.Tablet", function () {
                var id = this.getData();
                var opt = {
                    "style": "default",
                    "imageSrc": id ? MWF.xDesktop.getImageSrc( id ) : "",
                    "toolHidden": this.json.toolHidden || [],
                    "contentWidth": this.json.tabletWidth || 0,
                    "contentHeight": this.json.tabletHeight || 0,
                    "onSave": function (base64code, base64Image, imageFile) {
                        this.handwritingNode.hide();

                        if( this.tablet.isBlank() ){
                            this.setData("");
                            this.validation();
                            this.fireEvent("change");
                        }else{
                            this.upload(function (json) {
                                var data = json.data;
                                this.setData(data ? data.id : "");
                                this.validation();
                                this.fireEvent("change");
                            }.bind(this));
                        }


                    }.bind(this),
                    "onCancel": function () {
                        this.handwritingNode.hide();
                    }.bind(this)
                };
                if (layout.mobile) {
                    opt.tools = [
                        "save", "|",
                        "undo",
                        "redo", "|",
                        "reset", "|",
                        "cancel"
                    ]
                }

                /**
                 * @summary 手写板组件.
                 * @member {o2.widget.Tablet}
                 * @example
                 * var tablet = this.form.get("fieldId").tablet; //获取手写板
                 * tablet.cancel(); //关闭手写板
                 */
                this.tablet = new MWF.widget.Tablet(this.handwritingAreaNode, opt, null);
                this.tablet.load();
            }.bind(this));

            if(this.handwritingActionNode){
                this.handwritingActionNode.addEvent("click", function () {
                    //this.handwritingNode.hide();
                    if (this.tablet) this.tablet.save();
                }.bind(this));
            }
        },
        upload: function( callback ){
            var img = this.tablet.getImage( null, true );
            if(img)Promise.resolve( img ).then(function( image ){
                Promise.resolve( this.tablet.getFormData(image) ).then(function (formData) {
                    var fileName = "handwriting"+"_"+new Date().getTime();
                    if( image.type && image.type.contains("/") ) {
                        image.name = fileName + "." + image.type.split("/")[1];
                    }
                    o2.xDesktop.uploadImageByScale(
                        this.form.businessData.work.job,
                        "processPlatformJob",
                        0, //maxSize
                        formData,
                        image,
                        function (json) {
                            if (callback) callback(json);
                        }.bind(this),
                        function () {

                        }.bind(this)
                    );
                }.bind(this))
            }.bind(this))
        },
        createErrorNode: function (text) {
            node = new Element("div", {styles:{
                "margin-top": "0.3em"  
            }});
            var iconNode = new Element("div.ooicon-error", {
                "styles": {
                    "width": "20px",
                    "height": "1.2em",
                    "float": "left",
                    "display": "flex",
                    "color": "red",
                    "align-items": "center",
                    "justify-content": "center"
                    // "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                }
            }).inject(node);
            var textNode = new Element("div", {
                "styles": {
                    "height": "auto",
                    "line-height": "1.2em",
                    "margin-left": "20px",
                    "color": "red",
                    "word-break": "keep-all"
                },
                "text": text
            }).inject(node);
            return node;
        },
        notValidationMode: function (text) {
            if (!this.isNotValidationMode) {
                this.isNotValidationMode = true;
                this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
                this.node.setStyle("border", "1px solid red");

                this.errNode = this.createErrorNode(text).inject(this.node, "after");
                this.showNotValidationMode(this.node);
                if (!this.errNode.isIntoView()) this.errNode.scrollIntoView(false);
            }
        },
        showNotValidationMode: function (node) {
            var p = node.getParent("div");
            if (p) {
                if (p.get("MWFtype") == "tab$Content") {
                    if (p.getParent("div").getStyle("display") == "none") {
                        var contentAreaNode = p.getParent("div").getParent("div");
                        var tabAreaNode = contentAreaNode.getPrevious("div");
                        var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                        var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                        tabNode.click();
                        p = tabAreaNode.getParent("div");
                    }
                }
                this.showNotValidationMode(p);
            }
        },
        validationMode: function () {
            if (this.isNotValidationMode) {
                this.isNotValidationMode = false;
                this.node.setStyles(this.node.retrieve("borderStyle"));
                if (this.errNode) {
                    this.errNode.destroy();
                    this.errNode = null;
                }
            }
        },
        validationConfigItem: function (routeName, data) {
            var flag = (data.status == "all") ? true : (routeName == data.decision);
            if (flag) {
                var n = this.getData();
                var v = (data.valueType == "value") ? n : n.length;
                switch (data.operateor) {
                    case "isnull":
                        if (!v) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notnull":
                        if (v) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "gt":
                        if (v > data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "lt":
                        if (v < data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "equal":
                        if (v == data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "neq":
                        if (v != data.value) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "contain":
                        if (v.indexOf(data.value) != -1) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notcontain":
                        if (v.indexOf(data.value) == -1) {
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                }
            }
            return true;
        },
        validationConfig: function (routeName, opinion) {
            if (this.json.validationConfig) {
                if (this.json.validationConfig.length) {
                    for (var i = 0; i < this.json.validationConfig.length; i++) {
                        var data = this.json.validationConfig[i];
                        if (!this.validationConfigItem(routeName, data)) return false;
                    }
                }
                return true;
            }
            return true;
        },
        validation: function (routeName, opinion) {
            if( !this.isReadonly() ){
                if (!this.validationConfig(routeName, opinion)) return false;

                if (!this.json.validation) return true;
                if (!this.json.validation.code) return true;
                this.currentRouteName = routeName;
                var flag = this.form.Macro.exec(this.json.validation.code, this);
                this.currentRouteName = "";
                if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
                if (flag.toString() != "true") {
                    this.notValidationMode(flag);
                    return false;
                }
            }
            return true;
        },
        _parseStyles: function (styles) {
            Object.each(styles, function (v, key) {
                var value = v.toString();
                if ((value.indexOf("x_processplatform_assemble_surface") != -1 || value.indexOf("x_portal_assemble_surface") != -1 || value.indexOf("x_cms_assemble_control") != -1) && !value.includes("../")) {
                    var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                    var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                    var host3 = MWF.Actions.getHost("x_cms_assemble_control");
                    if (value.indexOf("/x_processplatform_assemble_surface") !== -1) {
                        value = value.replace("/x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                    } else if (value.indexOf("x_processplatform_assemble_surface") !== -1) {
                        value = value.replace("x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                    }
                    if (value.indexOf("/x_portal_assemble_surface") !== -1) {
                        value = value.replace("/x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                    } else if (value.indexOf("x_portal_assemble_surface") !== -1) {
                        value = value.replace("x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                    }
                    if (value.indexOf("/x_cms_assemble_control") !== -1) {
                        value = value.replace("/x_cms_assemble_control", host3 + "/x_cms_assemble_control");
                    } else if (value.indexOf("x_cms_assemble_control") !== -1) {
                        value = value.replace("x_cms_assemble_control", host3 + "/x_cms_assemble_control");
                    }
                    value = o2.filterUrl(value);
                }
            }.bind(this));

            return styles;
        }

    });

MWF.xApplication.process = MWF.xApplication.process || {};
MWF.xApplication.process.Work = MWF.xApplication.process.Work || {};
MWF.xDesktop.requireApp("process.Work", "lp." + MWF.language, null, false);

MWF.xApplication.process.Work.Processor = new Class({
    Extends: MWF.widget.Common,
    Implements: [Options, Events],
    options: {
        "style": "default",
        "mediaNode": null,
        "opinion": "",
        "defaultRoute": "",
        "isHandwriting": true,
        "tabletToolHidden": [],
        "tabletWidth": 0,
        "tabletHeight": 0,
        "orgHeight": 276,
        "inFlow": false,
        "maxOrgCountPerline": 2,
        "isManagerProcess": false, //是否为管理员提交
        "useDefaultOpinion": true
    },

    initialize: function (node, task, options, form) {
        this.setOptions(options);

        this.path = "../x_component_process_Work/$Processor/";
        this.cssPath = "../x_component_process_Work/$Processor/" + this.options.style + "/css.wcss";
        this._loadCss();

        this.task = task;
        this.node = $(node);
        this.selectedRoute = null;

        this.form = form;

        this.load();
    },
    load: function () {
        if (layout.mobile) {
            this.content = new Element("div").inject(this.node);
        } else {
            this.content = this.node;
        }
        if (!this.form && this.options.isManagerProcess) {
            this.managerProcessNoticeNode = new Element("div", {
                "styles": this.css.managerProcessNoticeNode,
                "html": MWF.xApplication.process.Work.LP.managerProcessNotice
            }).inject(this.content);
            this.managerLoginNode = new Element("div", {
                "styles": this.css.managerLoginNode,
                "text": MWF.xApplication.process.Work.LP.managerLogin
            }).inject(this.content);

            this.managerLoginNode.addEvent("click", function (ev) {
                this.managerLogin(ev);
            }.bind(this));

            //var text = MWF.xApplication.process.Work.LP.managerLoginReturn.replace( "{user}", layout.session.user.name );
            //this.managerLoginReturnNode = new Element("div", {"styles": this.css.managerLoginNode, "text": text }).inject(this.content);
            //this.managerLoginReturnNode.hide();
            //this.managerPerson = layout.session.user.distinguishedName;
            //this.managerLoginReturnNode.addEvent("click", function(ev){
            //    this.managerLoginReturn(ev);
            //}.bind(this))
        }

        this.routeOpinionTile = new Element("div", {
            "styles": this.css.routeOpinionTile,
            "text": MWF.xApplication.process.Work.LP.inputOpinion
        }).inject(this.content);
        this.routeOpinionTile.hide();
        this.routeOpinionArea = new Element("div", {"styles": this.css.routeOpinionArea}).inject(this.content);
        this.routeOpinionArea.hide();

        this.setOpinion();

        if (this.form) {
            if (layout.mobile) {
                this.orgsArea = new Element("div", {"styles": this.css.orgsArea}).inject(this.content);
                this.orgsTile = new Element("div", {
                    "styles": this.css.orgsTitle,
                    "text": MWF.xApplication.process.Work.LP.selectPerson
                }).inject(this.orgsArea);
                this.orgsArea.hide();
            } else {
                this.orgsArea = new Element("div", {"styles": this.css.orgsArea}).inject(this.content);
                this.orgsTile = new Element("div", {
                    "styles": this.css.orgsTitle,
                    "text": MWF.xApplication.process.Work.LP.selectPerson
                }).inject(this.orgsArea);
            }
        }

        if (layout.mobile) {
            this.buttonsArea = new Element("div", {"styles": this.css.buttonsArea}).inject(this.node);
        } else {
            this.buttonsArea = new Element("div", {"styles": this.css.buttonsArea}).inject(this.content);
        }
        this.setButtons();

        if (this.form) {
            if (layout.mobile) {
                this.getRouteGroupList();
                if (this.hasDecisionOpinion) {
                    this.routeContainer = new Element("div", {
                        "styles": this.css.routeContainer
                    }).inject(this.routeOpinionTile, "before");
                    this.routeGroupTitle = new Element("div", {
                        "styles": this.css.routeSelectorTile,
                        "text": MWF.xApplication.process.Work.LP.selectRouteGroup
                    }).inject(this.routeContainer);
                    this.routeGroupArea = new Element("div", {"styles": this.css.routeSelectorArea}).inject(this.routeContainer);

                    this.routeSelectorTile = new Element("div", {
                        "styles": this.css.routeSelectorTile,
                        "text": MWF.xApplication.process.Work.LP.selectRoute
                    }).inject(this.routeContainer);
                    this.routeSelectorArea = new Element("div", {"styles": this.css.routeSelectorArea}).inject(this.routeContainer);

                    this.setRouteGroupList();
                } else {
                    this.routeSelectorTile = new Element("div", {
                        "styles": this.css.routeSelectorTile,
                        "text": MWF.xApplication.process.Work.LP.selectRoute
                    }).inject(this.routeOpinionTile, "before");
                    this.routeSelectorArea = new Element("div", {"styles": this.css.routeSelectorArea}).inject(this.routeSelectorTile, "after");
                    this.setRouteList();
                }
            } else {
                this.getRouteGroupList();
                if (this.hasDecisionOpinion) {
                    //if( this.getMaxOrgLength() > 1 ){
                    this.routeContainer = new Element("div", {
                        "styles": this.css.routeContainer
                    }).inject(this.routeOpinionTile, "before");

                    this.routeLeftWarper = new Element("div").inject(this.routeContainer);
                    if( this.getMaxOrgLength() > 1 ){
                        this.routeLeftWarper.setStyles( this.options.inFlow ? this.css.routeLeftWarper_flow : this.css.routeLeftWarper );
                    }else{
                        this.routeLeftWarper.setStyles( this.css.routeLeftWarper_single );
                    }
                    this.routeGroupTitle = new Element("div", {
                        "styles": this.css.routeSelectorTile,
                        "text": MWF.xApplication.process.Work.LP.selectRouteGroup
                    }).inject(this.routeLeftWarper);
                    this.routeGroupArea = new Element("div", {"styles": this.css.routeSelectorArea_hasGroup}).inject(this.routeLeftWarper);

                    this.routeRightWarper = new Element("div").inject(this.routeContainer);
                    if( this.getMaxOrgLength() > 1 ){
                        this.routeLeftWarper.setStyles( this.options.inFlow ? this.css.routeRightWarper_flow : this.css.routeRightWarper );
                    }else{
                        this.routeLeftWarper.setStyles( this.css.routeRightWarper_single );
                    }
                    this.routeSelectorTile = new Element("div", {
                        "styles": this.css.routeSelectorTile,
                        "text": MWF.xApplication.process.Work.LP.selectRoute
                    }).inject(this.routeRightWarper);
                    this.routeSelectorArea = new Element("div", {"styles": this.css.routeSelectorArea_hasGroup}).inject(this.routeRightWarper);
                    this.setRouteGroupList();
                    //}else{
                    //    this.routeGroupTile = new Element("div", {"styles": this.css.routeSelectorTile, "text": MWF.xApplication.process.Work.LP.selectRoute }).inject(this.routeOpinionTile, "before");
                    //    this.routeGroupArea = new Element("div", {"styles": this.css.routeSelectorArea_hasGroup_wide }).inject(this.routeGroupTile, "after");
                    //    this.setRouteGroupList();
                    //}
                } else {
                    this.routeSelectorTile = new Element("div", {
                        "styles": this.css.routeSelectorTile,
                        "text": MWF.xApplication.process.Work.LP.selectRoute
                    }).inject(this.routeOpinionTile, "before");
                    this.routeSelectorArea = new Element("div", {"styles": this.css.routeSelectorArea}).inject(this.routeSelectorTile, "after");
                    this.setRouteList();
                }
            }
        } else { //快速处理
            this.routeSelectorTile = new Element("div", {
                "styles": this.css.routeSelectorTile,
                "text": MWF.xApplication.process.Work.LP.selectRoute
            }).inject(this.routeOpinionTile, "before");
            this.routeSelectorArea = new Element("div", {"styles": this.css.routeSelectorArea}).inject(this.routeSelectorTile, "after");
            this.setRouteList_noform();
            this.setSize_noform();
        }

        this.fireEvent("postLoad");
    },
    getRouteGroupList: function () {
        if (this.routeGroupObject) return this.routeGroupObject;
        this.routeGroupObject = {};
        this.routeGroupNameList = [];
        this.hasDecisionOpinion = false;
        var routeList = this.getRouteDataList();
        routeList.each(function (route, i) {

            if (route.hiddenScriptText && this.form && this.form.Macro) { //如果隐藏路由，返回
                if (this.form.Macro.exec(route.hiddenScriptText, this).toString() === "true") return;
            }

            if (route.displayNameScriptText && this.form && this.form.Macro) { //如果有显示名称公式
                route.displayName = this.form.Macro.exec(route.displayNameScriptText, this);
            } else {
                route.displayName = route.name;
            }

            if (route.decisionOpinion) {
                this.hasDecisionOpinion = true;
                var decisionOpinionList = route.decisionOpinion.split("#");
                decisionOpinionList.each(function (decisionOption) {
                    this.routeGroupNameList.combine([decisionOption]);
                    var d = this.splitByStartNumber(decisionOption);
                    if (!this.routeGroupObject[d.name]) this.routeGroupObject[d.name] = [];
                    this.routeGroupObject[d.name].push(route);
                }.bind(this))
            } else {
                var defaultName = MWF.xApplication.process.Work.LP.defaultDecisionOpinionName;
                this.routeGroupNameList.combine([defaultName]);
                if (!this.routeGroupObject[defaultName]) this.routeGroupObject[defaultName] = [];
                this.routeGroupObject[defaultName].push(route);
            }
        }.bind(this));
        return this.routeGroupObject;
    },
    splitByStartNumber: function (str) {
        var obj = {
            name: "",
            order: ""
        };
        for (var i = 0; i < str.length; i++) {
            if (parseInt(str.substr(i, 1)).toString() !== "NaN") {
                obj.order = obj.order + str.substr(i, 1);
            } else {
                obj.name = str.substr(i, str.length);
                break;
            }
        }
        return obj;
    },
    setRouteGroupList: function () {
        debugger;
        var _self = this;
        //var keys = Object.keys( this.routeGroupObject );
        //var length = keys.length;
        //var sortArray = MWF.xApplication.process.Work.LP.routeGroupOrderList;
        //keys.sort( function( a, b ){
        //    var aIdx = sortArray.indexOf(a);
        //    var bIdx = sortArray.indexOf(b);
        //    if( aIdx === -1 )aIdx = sortArray.length;
        //    if( bIdx === -1 )aIdx = sortArray.length;
        //    return aIdx - bIdx;
        //});

        var keys = this.routeGroupNameList;
        keys.sort(function (a, b) {
            var aIdx = parseInt(this.splitByStartNumber(a).order || "9999999");
            var bIdx = parseInt(this.splitByStartNumber(b).order || "9999999");
            return aIdx - bIdx;
        }.bind(this));

        var list = [];
        keys.each(function (k) {
            list.push(this.splitByStartNumber(k).name)
        }.bind(this));

        var flag = true;
        var matchRoutes = [];
        list.each(function (routeGroupName) {
            var routeList = this.routeGroupObject[routeGroupName];
            var routeGroupNode = new Element("div", {
                "styles": this.css.routeGroupNode,
                "text": routeGroupName
            }).inject(this.routeGroupArea);
            routeGroupNode.store("routeList", routeList);
            routeGroupNode.store("routeGroupName", routeGroupName);

            routeGroupNode.addEvents({
                "mouseover": function (e) {
                    _self.overRouteGroup(this);
                },
                "mouseout": function (e) {
                    _self.outRouteGroup(this);
                },
                "click": function (e) {
                    _self.selectRouteGroup(this);
                }
            });

            if (keys.length === 1) {
                this.selectRouteGroup(routeGroupNode);
                flag = false;
            }else if( matchRoutes.length === 0 && this.options.defaultRoute ){
                matchRoutes = routeList.filter(function(r){ return r.id === this.options.defaultRoute || r.name === this.options.defaultRoute; }.bind(this));
                if( matchRoutes.length ){
                    this.selectRouteGroup(routeGroupNode);
                }
                flag = false;
            }
        }.bind(this))
        if (flag) {
            this.setSize(0);
        }
    },
    overRouteGroup: function (node) {
        if (this.selectedRouteGroup) {
            if (this.selectedRouteGroup.get("text") != node.get("text")) {
                node.setStyles(this.css.routeGroupNode_over);
            }
        } else {
            node.setStyles(this.css.routeGroupNode_over);
        }
    },
    outRouteGroup: function (node) {
        if (this.selectedRouteGroup) {
            if (this.selectedRouteGroup.get("text") != node.get("text")) {
                node.setStyles(this.css.routeGroupNode);
            }
        } else {
            node.setStyles(this.css.routeGroupNode);
        }
    },
    selectRouteGroup: function (node) {
        if (this.selectedRouteGroup) {
            if (this.selectedRouteGroup.get("text") != node.get("text")) {
                this.selectedRouteGroup.setStyles(this.css.routeGroupNode);
                //this.selectedRouteGroup.removeClass("mainColor_bg");

                this.selectedRouteGroup = node;
                this.selectedRouteGroup.setStyles(this.css.routeGroupNode_selected);
                //this.selectedRouteGroup.addClass("mainColor_bg");

                var routeList = this.selectedRouteGroup.retrieve("routeList");
                this.setRouteList(routeList);

            } else {
                //this.selectedRouteGroup.setStyles(this.css.routeNode);
                //this.selectedRouteGroup.getFirst().setStyles(this.css.routeIconNode);
                //this.selectedRouteGroup.getLast().setStyles(this.css.routeTextNode);
                //
                //this.selectedRouteGroup = null;
            }
        } else {
            this.selectedRouteGroup = node;
            node.setStyles(this.css.routeGroupNode_selected);
            //this.selectedRouteGroup.addClass("mainColor_bg");

            var routeList = this.selectedRouteGroup.retrieve("routeList");
            this.setRouteList(routeList);
        }
        this.routeGroupArea.setStyle("background-color", "#FFF");
    },
    setRouteList_noform: function (routeList) {
        var _self = this;
        this.routeSelectorArea.empty();
        this.selectedRoute = null;

        var isSelectedDefault = false;

        //this.task.routeNameList = ["送审核", "送办理", "送公司领导阅"];
        if (!routeList) routeList = this.getRouteDataList();
        routeList.each(function (route, i) {
            var routeName = route.name;
            var routeNode = new Element("div", {
                "styles": this.css.routeNode,
                "text": routeName
            }).inject(this.routeSelectorArea);
            routeNode.store("route", route.id);
            routeNode.store("routeName", route.name);

            routeNode.addEvents({
                "mouseover": function (e) {
                    _self.overRoute(this);
                },
                "mouseout": function (e) {
                    _self.outRoute(this);
                },
                "click": function (e) {
                    _self.selectRoute_noform(this);
                }
            });

            if( route.id === this.options.defaultRoute || route.name === this.options.defaultRoute ){
                this.selectRoute_noform(routeNode);
                isSelectedDefault = true;
            }else if ( !isSelectedDefault && (routeList.length == 1 || route.sole)) {
                this.selectRoute_noform(routeNode);
            }

        }.bind(this));
    },
    setRouteList: function (routeList) {
        var _self = this;
        //if( this.hasDecisionOpinion && this.getMaxOrgLength() === 1 ){
        //    if( this.routeSelectorArea )this.routeSelectorArea.destroy();
        //    this.routeSelectorArea = new Element("div", { styles : this.css.routeSelectorArea_hasGroup_single }).inject( this.selectedRouteGroup, "after" );
        //}else{
        this.routeSelectorArea.empty();
        //}
        this.selectedRoute = null;
        //this.task.routeNameList = ["送审核", "送办理", "送公司领导阅"];
        if (!routeList) routeList = this.getRouteDataList();
        //this.task.routeNameList.each(function(route, i){
        var isSelected = false;
        var isSelectedDefault = false;
        var selecteRouteId;
        routeList.each(function (route, i) {
            if (route.hiddenScriptText && this.form && this.form.Macro) {
                if (this.form.Macro.exec(route.hiddenScriptText, this).toString() === "true") return;
            }
            var routeName = route.name;
            if (route.displayNameScriptText && this.form && this.form.Macro) {
                routeName = this.form.Macro.exec(route.displayNameScriptText, this);
            }
            var routeNode = new Element("div", {
                "styles": this.css.routeNode,
                "text": routeName
            }).inject(this.routeSelectorArea);
            //var routeIconNode = new Element("div", {"styles": this.css.routeIconNode}).inject(routeNode);
            //var routeTextNode = new Element("div", {"styles": this.css.routeTextNode, "text": routeName}).inject(routeNode);
            routeNode.store("route", route.id);
            routeNode.store("routeName", route.name);

            routeNode.addEvents({
                "mouseover": function (e) {
                    _self.overRoute(this);
                },
                "mouseout": function (e) {
                    _self.outRoute(this);
                },
                "click": function (e) {
                    _self.selectRoute(this);
                }
            });

            if( route.id === this.options.defaultRoute || route.name === this.options.defaultRoute) {
                selecteRouteId = route.id;
                this.selectRoute(routeNode);
                isSelected = true;
                isSelectedDefault = true;
            }else if ( !isSelectedDefault && (routeList.length == 1 || route.sole )) { //sole表示优先路由
                selecteRouteId = route.id;
                this.selectRoute(routeNode);
                isSelected = true;
            }
        }.bind(this));
        if (!isSelected) {
            this.setSize(0);
            if( this.orgsArea )this.orgsArea.hide();
        }else{
            var dataVisable = this.getVisableOrgData(selecteRouteId);
            this.setSize(dataVisable.length);
        }
    },
    overRoute: function (node) {
        if (this.selectedRoute) {
            if (this.selectedRoute.get("text") != node.get("text")) {
                node.setStyles(this.css.routeNode_over);
                node.addClass("lightColor_bg");
                //node.setStyle("background-color", "#f7e1d0");
            }
        } else {
            node.setStyles(this.css.routeNode_over);
            node.addClass("lightColor_bg");
        }
    },
    outRoute: function (node) {
        if (this.selectedRoute) {
            if (this.selectedRoute.get("text") != node.get("text")) {
                node.setStyles(this.css.routeNode);
                node.removeClass("lightColor_bg");
            }
        } else {
            node.setStyles(this.css.routeNode);
            node.removeClass("lightColor_bg");
        }
    },
    selectRoute_noform: function (node) {
        if (this.selectedRoute) {
            if (this.selectedRoute.get("text") != node.get("text")) {
                this.selectedRoute.setStyles(this.css.routeNode);
                this.selectedRoute.removeClass("mainColor_bg");

                this.selectedRoute = node;
                node.setStyles(this.css.routeNode_selected);
                node.addClass("mainColor_bg");
                node.removeClass("lightColor_bg");

            } else {
                this.selectedRoute.setStyles(this.css.routeNode);
                this.selectedRoute.addClass("lightColor_bg");
                this.selectedRoute.removeClass("mainColor_bg");
                this.selectedRoute = null;
            }
        } else {
            this.selectedRoute = node;
            node.setStyles(this.css.routeNode_selected);
            node.addClass("mainColor_bg");
            node.removeClass("lightColor_bg");
        }
        this.routeSelectorArea.setStyle("background-color", "#FFF");
    },
    getDefaultOpinion: function( node ){
        var routeId = node.retrieve("route");
        var routeDate = this.getRouteData( routeId );
        return routeDate.opinion || "";
    },
    selectRoute: function (node) {
        if (this.selectedRoute) {
            if (this.selectedRoute.get("text") != node.get("text")) { //选中其他路由
                this.selectedRoute.setStyles(this.css.routeNode);
                this.selectedRoute.removeClass("mainColor_bg");
                //this.selectedRoute.getFirst().setStyles(this.css.routeIconNode);
                //this.selectedRoute.getLast().setStyles(this.css.routeTextNode);

                if( this.options.useDefaultOpinion ){
                    if( this.inputTextarea.get("value") === ( this.lastDefaultOpinion || "" ) ||
                        this.inputTextarea.get("value") === (MWF.xApplication.process.Work.LP.inputText || "")
                    ){
                        this.lastDefaultOpinion = this.getDefaultOpinion(node) || "";
                        this.inputTextarea.set("value", this.lastDefaultOpinion || (MWF.xApplication.process.Work.LP.inputText || "") );
                    }
                }

                this.selectedRoute = node;
                node.setStyles(this.css.routeNode_selected);
                node.addClass("mainColor_bg");
                node.removeClass("lightColor_bg");
                //node.setStyle("background-color", "#da7429");
                //node.getFirst().setStyle("background-image", "url(../x_component_process_Work/$Processor/default/checked.png)");
                //node.getLast().setStyle("color", "#FFF");

            } else { //取消选中当前路由
                if( this.options.useDefaultOpinion ) {
                    if (this.inputTextarea.get("value") === this.getDefaultOpinion(this.selectedRoute)) {
                        this.lastDefaultOpinion = "";
                        this.inputTextarea.set("value", MWF.xApplication.process.Work.LP.inputText || "");
                    }
                }
                this.selectedRoute.setStyles(this.css.routeNode);
                this.selectedRoute.addClass("lightColor_bg");
                this.selectedRoute.removeClass("mainColor_bg");
                //this.selectedRoute.getFirst().setStyles(this.css.routeIconNode);
                //this.selectedRoute.getLast().setStyles(this.css.routeTextNode);

                this.selectedRoute = null;
            }
        } else {
            if( this.options.useDefaultOpinion ) {
                if ( (this.inputTextarea.get("value") === (MWF.xApplication.process.Work.LP.inputText || "")) ||
                    (this.inputTextarea.get("value") === this.lastDefaultOpinion )
                ) {
                    this.lastDefaultOpinion = this.getDefaultOpinion(node) || "";
                    if (this.lastDefaultOpinion) this.inputTextarea.set("value", this.lastDefaultOpinion);
                }
            }

            this.selectedRoute = node;
            node.setStyles(this.css.routeNode_selected);
            node.addClass("mainColor_bg");
            node.removeClass("lightColor_bg");
            //node.setStyle("background-color", "#da7429");
            //node.getFirst().setStyle("background-image", "url(../x_component_process_Work/$Processor/default/checked.png)");
            //node.getLast().setStyle("color", "#FFF");
        }
        this.routeSelectorArea.setStyle("background-color", "#FFF");
        if (layout.mobile) {
            this.loadOrgs_mobile(this.selectedRoute ? this.selectedRoute.retrieve("route") : "");
        } else {
            this.loadOrgs(this.selectedRoute ? this.selectedRoute.retrieve("route") : "");
        }

        //临时添加
        if (this.form.data.json.events && this.form.data.json.events.afterSelectRoute) {
            this.form.Macro.exec(this.form.data.json.events.afterSelectRoute.code, node);
        }

    },

    setOpinion: function () {
        this.selectIdeaNode = new Element("div", {"styles": this.css.selectIdeaNode}).inject(this.routeOpinionArea);
        this.selectIdeaScrollNode = new Element("div", {"styles": this.css.selectIdeaScrollNode}).inject(this.selectIdeaNode);
        this.selectIdeaAreaNode = new Element("div", {
            "styles": {
                "overflow": "hidden"
            }
        }).inject(this.selectIdeaScrollNode);

        this.inputOpinionNode = new Element("div", {"styles": this.css.inputOpinionNode}).inject(this.routeOpinionArea);
        this.inputTextarea = new Element("textarea", {
            "styles": this.css.inputTextarea,
            "value": this.options.opinion || MWF.xApplication.process.Work.LP.inputText
        }).inject(this.inputOpinionNode);
        this.inputTextarea.setStyle("resize", "none");
        this.inputTextarea.addEvents({
            "focus": function () {
                if (this.get("value") == MWF.xApplication.process.Work.LP.inputText) this.set("value", "");
            },
            "blur": function () {
                if (!this.get("value")) this.set("value", MWF.xApplication.process.Work.LP.inputText);
            },
            "keydown": function () {
                this.inputTextarea.setStyles(this.inputTextareaStyle || this.css.inputTextarea);
            }.bind(this)
        });

        if( this.options.isHandwriting ){
            this.mediaActionArea = new Element("div", {"styles": this.css.inputOpinionMediaActionArea}).inject(this.inputOpinionNode);
            this.handwritingAction = new Element("div", {
                "styles": this.css.inputOpinionHandwritingAction,
                "text": MWF.xApplication.process.Work.LP.handwriting
            }).inject(this.mediaActionArea);
            this.handwritingAction.addEvent("click", function () {
                if (layout.mobile) {
                    window.setTimeout(function () {
                        this.handwriting();
                    }.bind(this), 100)
                } else {
                    this.handwriting();
                }
            }.bind(this));
        }

        // if (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia){
        //     this.audioRecordAction = new Element("div", {"styles": this.css.inputOpinionAudioRecordAction, "text": MWF.xApplication.process.Work.LP.audioRecord}).inject(this.mediaActionArea);
        //     this.audioRecordAction.addEvent("click", function(){
        //         this.audioRecord();
        //     }.bind(this));
        // }

        // if (layout.mobile) {
        //     this.selectIdeaNode.inject(this.routeOpinionArea, "after");
        // }

        MWF.require("MWF.widget.ScrollBar", function () {
            new MWF.widget.ScrollBar(this.selectIdeaScrollNode, {
                "style": "small",
                "where": "before",
                "distance": 30,
                "friction": 4,
                "indent": false,
                "axis": {"x": false, "y": true}
            });
        }.bind(this));

        MWF.require("MWF.widget.UUID", function () {
            MWF.UD.getDataJson("idea", function (json) {
                if (json) {
                    if (json.ideas) {
                        this.setIdeaList(json.ideas);
                    }
                } else {
                    MWF.UD.getPublicData("idea", function (pjson) {
                        if (pjson) {
                            if (pjson.ideas) {
                                this.setIdeaList(pjson.ideas);
                            }
                        }
                    }.bind(this));
                }
            }.bind(this));
        }.bind(this));
    },
    audioRecord: function () {
        if (!this.audioRecordNode) this.createAudioRecord();
        this.audioRecordNode.show();
        this.audioRecordNode.position({
            "relativeTo": this.options.mediaNode || this.node,
            "position": "center",
            "edge": "center"
        });

        MWF.require("MWF.widget.AudioRecorder", function () {
            this.audioRecorder = new MWF.widget.AudioRecorder(this.audioRecordNode, {
                "onSave": function (blobFile) {
                    this.soundFile = blobFile;
                    this.audioRecordNode.hide();
                    // this.page.get("div_image").node.set("src",base64Image);
                }.bind(this),
                "onCancel": function () {
                    this.soundFile = null;
                    this.audioRecordNode.hide();
                }.bind(this)
            }, null);
        }.bind(this));
    },
    createAudioRecord: function () {
        this.audioRecordNode = new Element("div", {"styles": this.css.handwritingNode}).inject(this.node, "after");
        var size = (this.options.mediaNode || this.node).getSize();
        // var y = Math.max(size.y, 320);
        // var x = Math.max(size.x, 400);

        // for (k in this.node.style){
        //     if (this.node.style[k]) this.audioRecordNode.style[k] = this.node.style[k];
        // }
        var zidx = this.node.getStyle("z-index");
        this.audioRecordNode.setStyles({
            "height": "" + size.y + "px",
            "width": "" + size.x + "px",
            "z-index": zidx + 1
        });
    },

    handwriting: function () {
        if (!this.handwritingNode) this.createHandwriting();
        if (this.handwritingNodeMask) this.handwritingNodeMask.show();
        this.handwritingNode.show();
        if (layout.mobile) {
            this.handwritingNode.setStyles({
                "top": "0px",
                "left": "0px"
            });
        } else {
            this.handwritingNode.position({
                "relativeTo": this.options.mediaNode || this.node,
                "position": "center",
                "edge": "center"
            });
        }
    },
    createHandwriting: function () {
        this.handwritingNodeMask = new Element("div.handwritingMask", {"styles": this.css.handwritingMask}).inject(this.node);

        this.handwritingNode = new Element("div.handwritingNode", {"styles": this.css.handwritingNode}).inject(this.node, "after");
        //var size = (this.options.mediaNode || this.node).getSize();
        //var y = size.y;
        //var x = size.x;
        //兼容以前的默认高宽
        var x = 600;
        var y = 320;
        if (!layout.mobile) {

            x = Math.max(this.options.tabletWidth || x, 600);
            this.options.tabletWidth = x;
            y = Math.max(this.options.tabletHeight ? (parseInt(this.options.tabletHeight) + 110) : y, 320);

            //y = Math.max(size.y, 320);
            //x = Math.max(size.x, 480);
        } else {
            var bodySize = $(document.body).getSize();
            x = bodySize.x;
            y = bodySize.y;
            this.options.tabletWidth = 0;
            this.options.tabletHeight = 0;
        }
        // for (k in this.node.style){
        //     if (this.node.style[k]) this.handwritingNode.style[k] = this.node.style[k];
        // }
        var zidx = this.node.getStyle("z-index");
        this.handwritingNode.setStyles({
            "height": "" + y + "px",
            "width": "" + x + "px",
            "z-index": zidx + 1
        });
        if (layout.mobile) {
            debugger;
            this.handwritingNode.addEvent('touchmove', function (e) {
                e.preventDefault();
            });
            this.handwritingNode.setStyles({
                "top": "0px",
                "left": "0px"
            });
            //this.handwritingNode.position({
            //    "relativeTo": this.node,
            //    "position": "center",
            //    "edge": "center"
            //});
        } else {
            this.handwritingNode.position({
                "relativeTo": this.options.mediaNode || this.node,
                "position": "center",
                "edge": "center"
            });
        }
        this.handwritingAreaNode = new Element("div", {"styles": this.css.handwritingAreaNode}).inject(this.handwritingNode);
        if( !layout.mobile ) {
            this.handwritingActionNode = new Element("div", {
                "styles": this.css.handwritingActionNode,
                "text": MWF.xApplication.process.Work.LP.saveWrite
            }).inject(this.handwritingNode);
            var h = this.handwritingActionNode.getSize().y + this.handwritingActionNode.getStyle("margin-top").toInt() + this.handwritingActionNode.getStyle("margin-bottom").toInt();
            h = y - h;
            this.handwritingAreaNode.setStyle("height", "" + h + "px");
        }else{
            this.handwritingAreaNode.setStyle("height", "" + y + "px");
        }

        MWF.require("MWF.widget.Tablet", function () {
            var handWritingOptions = {
                "style": "default",
                "toolHidden": this.options.tabletToolHidden || [],
                "contentWidth": this.options.tabletWidth || 0,
                "contentHeight": this.options.tabletHeight || 0,
                "onSave": function (base64code, base64Image, imageFile) {
                    if( !this.tablet.isBlank() ){
                        this.handwritingFile = imageFile;
                        this.handwritingAction.setStyles( this.css.inputOpinionHandwritingOkAction )
                    }else{
                        this.handwritingFile = null
                        this.handwritingAction.setStyles( this.css.inputOpinionHandwritingAction );
                    }
                    this.handwritingNode.hide();
                    this.handwritingNodeMask.hide();
                    // this.page.get("div_image").node.set("src",base64Image);

                }.bind(this),
                "onCancel": function () {
                    this.handwritingFile = null;
                    this.handwritingAction.setStyles( this.css.inputOpinionHandwritingAction );
                    this.handwritingNode.hide();
                    this.handwritingNodeMask.hide();
                }.bind(this)
            };
            if (layout.mobile) {
                handWritingOptions.tools = [
                    "undo",
                    "redo", "|",
                    "reset", "|",
                    "size",
                    "cancel"
                ]
            }

            this.tablet = new MWF.widget.Tablet(this.handwritingAreaNode, handWritingOptions, null);
            this.tablet.load();
        }.bind(this));

        if(this.handwritingActionNode) {
            this.handwritingActionNode.addEvent("click", function () {
                //this.handwritingNode.hide();
                if (this.tablet) this.tablet.save();
            }.bind(this));
        }
    },

    setIdeaList: function (ideas) {
        var _self = this;
        ideas.each(function (idea) {
            if (!idea) return;
            new Element("div", {
                "styles": this.css.selectIdeaItemNode,
                "text": idea,
                "events": {
                    "click": function () {
                        if (_self.inputTextarea.get("value") == MWF.xApplication.process.Work.LP.inputText) {
                            _self.inputTextarea.set("value", this.get("text"));
                        } else {
                            _self.inputTextarea.set("value", _self.inputTextarea.get("value") + ", " + this.get("text"));
                        }
                    },
                    "dblclick": function () {
                        if (_self.inputTextarea.get("value") == MWF.xApplication.process.Work.LP.inputText) {
                            _self.inputTextarea.set("value", this.get("text"));
                        } else {
                            _self.inputTextarea.set("value", _self.inputTextarea.get("value") + ", " + this.get("text"));
                        }
                    },
                    "mouseover": function () {
                        this.setStyles(_self.css.selectIdeaItemNode_over);
                    },
                    "mouseout": function () {
                        this.setStyles(_self.css.selectIdeaItemNode);
                    }
                }
            }).inject(this.selectIdeaAreaNode);
        }.bind(this));
    },
    setButtons: function () {
        this.cancelButton = new Element("div", {"styles": this.css.cancelButton}).inject(this.buttonsArea);
        var iconNode = new Element("div", {"styles": this.css.cancelIconNode}).inject(this.cancelButton);
        var textNode = new Element("div", {
            "styles": this.css.cancelTextNode,
            "text": MWF.xApplication.process.Work.LP.cancel
        }).inject(this.cancelButton);

        this.okButton = new Element("div", {"styles": this.css.okButton}).inject(this.buttonsArea);
        var iconNode = new Element("div", {"styles": this.css.okIconNode}).inject(this.okButton);
        var textNode = new Element("div", {
            "styles": this.css.okTextNode,
            "text": MWF.xApplication.process.Work.LP.ok
        }).inject(this.okButton);

        this.cancelButton.addEvent("click", function () {
            this.destroy();
            this.fireEvent("cancel");
        }.bind(this));

        this.okButton.addEvent("click", function (ev) {
            if (!this.form && this.options.isManagerProcess) {
                this.submit_withoutForm(ev)
            }else if (layout.mobile) {
                this.submit_mobile(ev)
            } else {
                this.submit_pc(ev)
            }
        }.bind(this));
    },
    submit_mobile: function (ev) {
        if (this.hasDecisionOpinion && !this.selectedRouteGroup) {
            this.routeGroupArea.setStyle("background-color", "#ffe9e9");
            MWF.xDesktop.notice(
                "error",
                {"x": "center", "y": "top"},
                MWF.xApplication.process.Work.LP.mustSelectRouteGroup,
                this.routeGroupArea,
                null,  //{"x": 0, "y": 30}
                {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
            );
            return false;
        }

        if (!this.selectedRoute) {
            this.routeSelectorArea.setStyle("background-color", "#ffe9e9");
            new mBox.Notice({
                type: "error",
                position: {"x": "center", "y": "top"},
                move: false,
                target: this.routeSelectorArea,
                delayClose: 6000,
                content: MWF.xApplication.process.Work.LP.mustSelectRoute
            });
            return false;
        }
        var routeName = this.selectedRoute.retrieve("routeName") || this.selectedRoute.get("text");
        var opinion = this.inputTextarea.get("value");
        if (opinion === MWF.xApplication.process.Work.LP.inputText) opinion = "";
        var medias = [];
        if (this.handwritingFile) medias.push(this.handwritingFile);
        if (this.soundFile) medias.push(this.soundFile);
        if (this.videoFile) medias.push(this.videoFile);

        var currentRouteId = this.selectedRoute.retrieve("route");
        var routeData = this.getRouteData(currentRouteId);
        if (!opinion && medias.length === 0) {
            if (routeData.opinionRequired == true) {
                this.inputTextarea.setStyle("background-color", "#ffe9e9");
                new mBox.Notice({
                    type: "error",
                    position: {"x": "center", "y": "top"},
                    move: false,
                    target: this.inputTextarea,
                    delayClose: 6000,
                    content: MWF.xApplication.process.Work.LP.opinionRequired
                });
                return false;
            }
        }

        var appendTaskOrgItem;
        if (routeData.type === "appendTask" && routeData.appendTaskIdentityType === "select") {
            if (!this.orgItems || this.orgItems.length === 0) {
                new mBox.Notice({
                    type: "error",
                    position: {"x": "center", "y": "top"},
                    move: false,
                    target: this.orgsArea,
                    delayClose: 6000,
                    content: MWF.xApplication.process.Work.LP.noAppendTaskIdentityConfig //"没有配置转交人，请联系管理员"
                });
                return false;
            } else {
                appendTaskOrgItem = this.orgItems[0]
            }
        }

        if (!this.saveOrgs()) return false;

        //this.saveOrgsWithCheckEmpower( function(){
        var appandTaskIdentityList;
        if (appendTaskOrgItem) {
            appandTaskIdentityList = appendTaskOrgItem.getData();
            if (!appandTaskIdentityList || appandTaskIdentityList.length === 0) {
                new mBox.Notice({
                    type: "error",
                    position: {"x": "center", "y": "top"},
                    move: false,
                    target: this.orgsArea,
                    delayClose: 6000,
                    content: MWF.xApplication.process.Work.LP.selectAppendTaskIdentityNotice //"请选择转交人"
                });
                return;
            }
        }

        if (routeData.validationScriptText) {
            var validation = this.form.Macro.exec(routeData.validationScriptText, this);
            if (!validation || validation.toString() !== "true") {
                if (typeOf(validation) === "string") {
                    MWF.xDesktop.notice(
                        "error",
                        {"x": "center", "y": "center"},
                        validation,
                        this.node,
                        {"x": 0, "y": 30},
                        {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                    );
                    return false;
                } else {
                    //"路由校验失败"
                    MWF.xDesktop.notice(
                        "error",
                        {"x": "center", "y": "center"},
                        MWF.xApplication.process.Work.LP.routeValidFailure,
                        this.node,
                        {"x": 0, "y": 30},
                        {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                    );
                    return false;
                }
            }
        }

        this.node.mask({
            "inject": {"where": "bottom", "target": this.node},
            "destroyOnHide": true,
            "style": {
                "background-color": "#999",
                "opacity": 0.3,
                "z-index": 600
            }
        });

        var array = [routeName, opinion, medias, appandTaskIdentityList, this.orgItems, function () {
            if (appendTaskOrgItem) appendTaskOrgItem.setData([]);
        }];

        this.fireEvent("submit", array);
        //}.bind(this))
    },
    submit_pc: function (ev) {
        if (this.hasDecisionOpinion && !this.selectedRouteGroup) {
            this.routeGroupArea.setStyle("background-color", "#ffe9e9");
            MWF.xDesktop.notice(
                "error",
                {"x": "center", "y": "top"},
                MWF.xApplication.process.Work.LP.mustSelectRouteGroup,
                this.routeGroupArea,
                null,  //{"x": 0, "y": 30}
                {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
            );
            return false;
        }

        if (!this.selectedRoute) {
            this.routeSelectorArea.setStyle("background-color", "#ffe9e9");
            MWF.xDesktop.notice(
                "error",
                {"x": "center", "y": "top"},
                MWF.xApplication.process.Work.LP.mustSelectRoute,
                this.routeSelectorArea,
                null,  //{"x": 0, "y": 30}
                {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
            );
            return false;
        }
        var routeName = this.selectedRoute.retrieve("routeName") || this.selectedRoute.get("text");
        var opinion = this.inputTextarea.get("value");
        if (opinion === MWF.xApplication.process.Work.LP.inputText) opinion = "";
        var medias = [];
        if (this.handwritingFile) medias.push(this.handwritingFile);
        if (this.soundFile) medias.push(this.soundFile);
        if (this.videoFile) medias.push(this.videoFile);

        var currentRouteId = this.selectedRoute.retrieve("route");
        var routeData = this.getRouteData(currentRouteId);
        if (!opinion && medias.length === 0) {
            if (routeData.opinionRequired == true) {
                this.inputTextarea.setStyle("background-color", "#ffe9e9");
                MWF.xDesktop.notice(
                    "error",
                    {"x": "center", "y": "top"},
                    MWF.xApplication.process.Work.LP.opinionRequired,
                    this.inputTextarea,
                    null,  //{"x": 0, "y": 30}
                    {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                );
                return false;
            }
        }

        var appendTaskOrgItem = "";
        if (routeData.type === "appendTask" && routeData.appendTaskIdentityType === "select") {
            if (!this.orgItems || this.orgItems.length === 0) {
                MWF.xDesktop.notice(
                    "error",
                    {"x": "center", "y": "center"},
                    MWF.xApplication.process.Work.LP.noAppendTaskIdentityConfig,
                    this.node,
                    null,  //{"x": 0, "y": 30}
                    {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                );
                return false;
            } else {
                appendTaskOrgItem = this.orgItems[0]
            }
        }

        this.saveOrgsWithCheckEmpower(function () {
            var appandTaskIdentityList;
            if (appendTaskOrgItem) {
                appandTaskIdentityList = appendTaskOrgItem.getData();
                if (!appandTaskIdentityList || appandTaskIdentityList.length === 0) {
                    MWF.xDesktop.notice(
                        "error",
                        {"x": "center", "y": "center"},
                        MWF.xApplication.process.Work.LP.selectAppendTaskIdentityNotice,
                        this.node,
                        {"x": 0, "y": 30},
                        {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                    );
                    return;
                }
            }

            if (routeData.validationScriptText) {
                var validation = this.form.Macro.exec(routeData.validationScriptText, this);
                if (!validation || validation.toString() !== "true") {
                    if (typeOf(validation) === "string") {
                        MWF.xDesktop.notice(
                            "error",
                            {"x": "center", "y": "center"},
                            validation,
                            this.node,
                            {"x": 0, "y": 30},
                            {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                        );
                        return false;
                    } else {
                        //"路由校验失败"
                        MWF.xDesktop.notice(
                            "error",
                            {"x": "center", "y": "center"},
                            MWF.xApplication.process.Work.LP.routeValidFailure,
                            this.node,
                            {"x": 0, "y": 30},
                            {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                        );
                        return false;
                    }
                }
            }

            this.node.mask({
                "inject": {"where": "bottom", "target": this.node},
                "destroyOnHide": true,
                "style": {
                    "background-color": "#999",
                    "opacity": 0.3,
                    "z-index": 600
                }
            });


            var array = [routeName, opinion, medias, appandTaskIdentityList, this.orgItems, function () {
                if (appendTaskOrgItem) appendTaskOrgItem.setData([]);
            }];

            this.fireEvent("submit", array);
        }.bind(this))
    },

    submit_withoutForm: function (ev) {
        if (this.hasDecisionOpinion && !this.selectedRouteGroup) {
            this.routeGroupArea.setStyle("background-color", "#ffe9e9");
            MWF.xDesktop.notice(
                "error",
                {"x": "center", "y": "top"},
                MWF.xApplication.process.Work.LP.mustSelectRouteGroup,
                this.routeGroupArea,
                null,  //{"x": 0, "y": 30}
                {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
            );
            return false;
        }

        if (!this.selectedRoute) {
            this.routeSelectorArea.setStyle("background-color", "#ffe9e9");
            MWF.xDesktop.notice(
                "error",
                {"x": "center", "y": "top"},
                MWF.xApplication.process.Work.LP.mustSelectRoute,
                this.routeSelectorArea,
                null,  //{"x": 0, "y": 30}
                {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
            );
            return false;
        }
        var routeName = this.selectedRoute.retrieve("routeName") || this.selectedRoute.get("text");
        var opinion = this.inputTextarea.get("value");
        if (opinion === MWF.xApplication.process.Work.LP.inputText) opinion = "";
        var medias = [];
        if (this.handwritingFile) medias.push(this.handwritingFile);
        if (this.soundFile) medias.push(this.soundFile);
        if (this.videoFile) medias.push(this.videoFile);

        var currentRouteId = this.selectedRoute.retrieve("route");
        var routeData = this.getRouteData(currentRouteId);
        if (!opinion && medias.length === 0) {
            if (routeData.opinionRequired == true) {
                this.inputTextarea.setStyle("background-color", "#ffe9e9");
                MWF.xDesktop.notice(
                    "error",
                    {"x": "center", "y": "top"},
                    MWF.xApplication.process.Work.LP.opinionRequired,
                    this.inputTextarea,
                    null,  //{"x": 0, "y": 30}
                    {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
                );
                return false;
            }
        }

        var appandTaskIdentityList = [];
        this.node.mask({
            "inject": {"where": "bottom", "target": this.node},
            "destroyOnHide": true,
            "style": {
                "background-color": "#999",
                "opacity": 0.3,
                "z-index": 600
            }
        });


        var array = [routeName, opinion, medias, appandTaskIdentityList, this.orgItems, function () {
        }];

        this.fireEvent("submit", array);
    },


    destroy: function () {
        if (this.orgItems && this.orgItems.length){
            this.orgItems.each(function (org) {
                if(org.clearTooltip)org.clearTooltip();
            })
        }
        if (this.node) this.node.empty();
        delete this.task;
        delete this.node;
        delete this.routeSelectorTile;
        delete this.routeSelectorArea;
        delete this.routeOpinionTile;
        delete this.routeOpinionArea;
        delete this.buttonsArea;
        delete this.inputOpinionNode;
        delete this.inputTextarea;
        delete this.cancelButton;
        delete this.okButton;
    },
    getRouteDataList: function () {
        if(this.routeDataList)return this.routeDataList;

        if (this.task.routeNameDisable){
            this.routeDataList = [{
                "id": o2.uuid(),
                "asyncSupported": false,
                "soleDirect": false,
                "name": "继续流转",
                "alias": "",
                "selectConfigList": []
            }];
            return this.routeDataList;
        }

        if( this.form && this.form.businessData && this.form.businessData.routeList ){
            this.form.businessData.routeList.sort( function(a, b){
                var aIdx = parseInt(a.orderNumber || "9999999");
                var bIdx = parseInt(b.orderNumber || "9999999");
                return aIdx - bIdx;
            }.bind(this));
            this.form.businessData.routeList.each( function(d){
                d.selectConfigList = JSON.parse(d.selectConfig || "[]");
            }.bind(this));
            this.routeDataList = this.form.businessData.routeList;
        }
        if (!this.routeDataList) {
            o2.Actions.get("x_processplatform_assemble_surface").listRoute({"valueList": this.task.routeList}, function (json) {
                json.data.sort(function(a, b){
                    var aIdx = parseInt(a.orderNumber || "9999999");
                    var bIdx = parseInt(b.orderNumber || "9999999");
                    return aIdx - bIdx;
                }.bind(this));
                json.data.each(function (d) {
                    d.selectConfigList = JSON.parse(d.selectConfig || "[]");
                }.bind(this));
                this.routeDataList = json.data;
            }.bind(this), null, false);
        }
        return this.routeDataList;
    },
    getRouteData: function (routeId) {
        var routeList = this.getRouteDataList();
        for (var i = 0; i < routeList.length; i++) {
            if (routeList[i].id === routeId) {
                return routeList[i];
            }
        }
    },
    getMaxOrgLength: function () {
        var routeList = this.getRouteDataList();
        var length = 0;
        routeList.each(function (route) {
            if (route.hiddenScriptText) { //如果隐藏路由，返回
                if (this.form.Macro.exec(route.hiddenScriptText, this).toString() === "true") return;
            }
            length = Math.max(length, route.selectConfigList.length);
        }.bind(this));
        return length;
    },
    getOrgData: function (routeId) {
        var routeList = this.getRouteDataList();
        for (var i = 0; i < routeList.length; i++) {
            if (routeList[i].id === routeId) {
                return routeList[i].selectConfigList;
            }
        }
    },
    getVisableOrgData: function (routeId) {
        var selectConfigList = this.getOrgData(routeId);
        var list = [];
        (selectConfigList || []).each(function (config) {
            if (!this.isOrgHidden(config)) {
                list.push(config);
            }
        }.bind(this));
        return list;
    },
    isOrgHidden: function (d) {
        if (d.hiddenScript && d.hiddenScript.code) { //如果隐藏路由，返回
            var hidden = this.form.Macro.exec(d.hiddenScript.code, this);
            if (hidden && hidden.toString() === "true") return true;
        }
        return false;
    },

    loadOrgs_mobile: function (route) {
        debugger;
        if (!this.form || !route) {
            this.orgsArea.hide();
            this.setSize(0);
            return;
        } else {
            this.orgsArea.show();
        }
        if (!this.orgTableObject) this.orgTableObject = {};
        if (!this.orgItemsObject) this.orgItemsObject = {};
        if (!this.orgItemsMap) this.orgItemsMap = {};
        var isLoaded = false;
        for (var key in this.orgTableObject) {
            if (route === key) {
                isLoaded = true;
            } else {
                this.orgTableObject[key].hide();
            }
        }
        if (isLoaded) {
            this.showOrgs_mobile(route);
        } else {
            this.createOrgs_mobile(route)
        }
    },
    showOrgs_mobile: function (route) {
        this.orgItemMap = this.orgItemsMap[route] || {};
        var dataVisable = this.getVisableOrgData(route);
        if (dataVisable.length) {
            if (this.isSameArray(Object.keys(this.orgItemMap), dataVisable.map(function (d) {
                return d.name
            }))) {
                this.orgTableObject[route].show();
                this.orgItems = this.orgItemsObject[route] || [];
                this.setSize(dataVisable.length);
            } else {
                this.loadOrgTable_mobile(route);
            }
        } else {
            this.orgsArea.hide();
            this.orgItemMap = {};
            this.orgItems = [];
            this.setSize(0);
        }
    },
    createOrgs_mobile: function (route) {
        var dataVisable = this.getVisableOrgData(route);
        if (dataVisable.length) {
            this.loadOrgTable_mobile(route);
        } else {
            this.setSize(dataVisable.length);
            this.orgItemMap = {};
            this.orgItems = [];
            this.orgsArea.hide();
        }
    },
    loadOrgTable_mobile: function (route) {
        var dataVisable = this.getVisableOrgData(route);
        this.setSize(dataVisable.length);

        this.orgsArea.show();

        var table_old = this.orgTableObject[route];
        var divsMap_old = {};
        if (table_old) {
            var divs = table_old.getChildren("div");
            divs.each(function (div) {
                divsMap_old[div.retrieve("orgName")] = div;
            });
        }

        var orgItems_old = this.orgItemsObject[route] || [];
        var orgItemMap_old = this.orgItemsMap[route] || {};

        this.orgItemsObject[route] = [];
        this.orgItemsMap[route] = {};

        this.orgItems = this.orgItemsObject[route];
        this.orgItemMap = this.orgItemsMap[route];

        var routeOrgTable = new Element("div", {
            "styles": this.css.routeOrgTable
        }).inject(this.orgsArea);
        this.orgTableObject[route] = routeOrgTable;

        var ignoreFirstOrgOldData = false

        dataVisable.each(function (config, i) {
            var sNode = new Element("div", {
                "styles": this.css.routeOrgTr
            }).inject(routeOrgTable);
            sNode.store("orgName", config.name);
            if (orgItemMap_old[config.name]) {
                var org = orgItemMap_old[config.name];
                this.orgItems.push(org);
                this.orgItemMap[config.name] = org;

                var div = divsMap_old[config.name];
                div.getChildren().inject(sNode);
            } else {
                this.loadOrg_mobile(sNode, config, ignoreFirstOrgOldData && i == 0)
            }
        }.bind(this));
        if (table_old) table_old.destroy();

    },
    // loadOrgs_mobile: function (route) {
    //     if (!this.form || !route) {
    //         this.orgsArea.hide();
    //         return;
    //     } else {
    //         this.orgsArea.show();
    //     }
    //     if (!this.orgTableObject) this.orgTableObject = {};
    //     if (!this.orgItemsObject) this.orgItemsObject = {};
    //     if (!this.orgItemsMap) this.orgItemsMap = {};
    //
    //     var isLoaded = false;
    //     for (var key in this.orgTableObject) {
    //         if (route === key) {
    //             this.orgTableObject[key].show();
    //             this.orgItems = this.orgItemsObject[key] || [];
    //             var data = this.getOrgData(route);
    //             isLoaded = true;
    //         } else {
    //             this.orgTableObject[key].hide();
    //         }
    //     }
    //     if (isLoaded) return;
    //
    //     this.orgItems = [];
    //     this.orgItemsObject[route] = this.orgItems;
    //
    //     var data = this.getOrgData(route);
    //     var routeConfig = this.getRouteData(route);
    //     var ignoreFirstOrgOldData = false; //(routeConfig.type === "appendTask" && routeConfig.appendTaskIdentityType === "select");
    //     this.setSize(data.length);
    //     if (data.length) {
    //         this.orgsArea.show();
    //
    //         var routeOrgTable = new Element("div", {
    //             "styles": this.css.routeOrgTable
    //         }).inject(this.orgsArea);
    //         this.orgTableObject[route] = routeOrgTable;
    //
    //         data.each(function (config, i) {
    //             var sNode = new Element("div", {
    //                 "styles": this.css.routeOrgTr
    //             }).inject(routeOrgTable);
    //             this.loadOrg_mobile(sNode, config, ignoreFirstOrgOldData && i == 0)
    //         }.bind(this))
    //     } else {
    //         this.orgsArea.hide();
    //     }
    // },
    loadOrg_mobile: function (container, json, ignoreOldData) {
        var titleNode = new Element("div.selectorTitle", {
            "styles": this.css.selectorTitle
        }).inject(container);
        var titleTextNode = new Element("div.selectorTitleText", {
            "text": json.title,
            "styles": this.css.selectorTitleText
        }).inject(titleNode);

        var contentNode = new Element("div.selectorContent", {
            "styles": this.css.selectorContent
        }).inject(container);

        var errorNode = new Element("div.selectorErrorNode", {
            "styles": this.css.selectorErrorNode
        }).inject(container);

        var org = new MWF.xApplication.process.Work.Processor.Org(contentNode, this.form, json, this, {
            onSelect: function (items, data) {
                if (!data || !data.length) {
                    contentNode.setStyles(this.css.selectorContent_noItem);
                } else {
                    contentNode.setStyles(this.css.selectorContent);
                }
            }.bind(this)
        });
        org.ignoreOldData = ignoreOldData;
        org.errContainer = errorNode;
        org.summitDlalog = this;
        this.orgItems.push(org);
        this.orgItemMap[json.name] = org;

        titleNode.addEvent("click", function () {
            this.load();
        }.bind(org));
        contentNode.addEvent("click", function () {
            this.load();
        }.bind(org));

        var defaultValue = org.getValue();
        org.loadOrgWidget(defaultValue, contentNode);
        if (!defaultValue || defaultValue.length == 0) {
            contentNode.setStyles(this.css.selectorContent_noItem);
        }

    },

    isSameArray: function (arr1, arr2) {
        if (arr1.length !== arr2.length) return false;
        for (var i = 0; i < arr1.length; i++) {
            if (arr1[i] !== arr2[i]) return false;
        }
        return true;
    },
    loadOrgs: function (route) {
        if (!this.form || !route) {
            this.orgsArea.hide();
            this.setSize(0);
            return;
        } else {
            this.orgsArea.show();
        }
        if (!this.orgTableObject) this.orgTableObject = {};
        if (!this.orgItemsObject) this.orgItemsObject = {};
        if (!this.orgItemsMap) this.orgItemsMap = {};
        var isLoaded = false;
        for (var key in this.orgTableObject) {
            if (route === key) {
                isLoaded = true;
            } else {
                this.orgTableObject[key].hide();
            }
        }
        if (isLoaded) {
            this.showOrgs(route);
        } else {
            this.createOrgs(route)
        }
    },
    showOrgs: function (route) {
        this.orgItemMap = this.orgItemsMap[route] || {};
        var dataVisable = this.getVisableOrgData(route);
        if (dataVisable.length) {
            if (this.isSameArray(Object.keys(this.orgItemMap), dataVisable.map(function (d) { return d.name }))) {
                this.orgTableObject[route].show();
                this.orgItems = this.orgItemsObject[route] || [];
                this.setSize(dataVisable.length);
            } else {
                this.loadOrgTable(route);
            }
        } else {
            this.orgsArea.hide();
            this.orgItemMap = {};
            this.orgItems = [];
            this.setSize(0);
        }
    },
    createOrgs: function (route) {
        var dataVisable = this.getVisableOrgData(route);
        if (dataVisable.length) {
            this.loadOrgTable(route);
        } else {
            this.setSize(dataVisable.length);
            this.orgItemMap = {};
            this.orgItems = [];
            this.orgsArea.hide();
        }
    },
    loadOrgTable: function (route) {
        var data = this.getOrgData(route);
        var dataVisable = this.getVisableOrgData(route);
        this.setSize(dataVisable.length);

        this.orgsArea.show();

        var table_old = this.orgTableObject[route];
        var tdsMap_old = {};
        if (table_old) {
            var tds = table_old.getElements("td");
            tds.each(function (td) {
                tdsMap_old[td.retrieve("orgName")] = td;
            });
        }

        var orgItems_old = this.orgItemsObject[route] || [];
        var orgItemMap_old = this.orgItemsMap[route] || {};

        this.orgItemsObject[route] = [];
        this.orgItemsMap[route] = {};

        this.orgItems = this.orgItemsObject[route];
        this.orgItemMap = this.orgItemsMap[route];

        var len = dataVisable.length;

        var routeOrgTable = new Element("table", {
            "cellspacing": 0, "cellpadding": 0, "border": 0, "width": "100%",
            "styles": this.css.routeOrgTable
        }).inject(this.orgsArea);
        this.orgTableObject[route] = routeOrgTable;

        var lines = ((len + 1) / 2).toInt();
        for (var n = 0; n < lines; n++) {
            var tr = new Element("tr").inject(routeOrgTable);
            new Element("td", {"width": "50%", "valign": "bottom", "styles": this.css.routeOrgOddTd}).inject(tr);
            new Element("td", {"width": "50%", "valign": "bottom", "styles": this.css.routeOrgEvenTd}).inject(tr);
        }

        var trs = routeOrgTable.getElements("tr");

        // var routeConfig = this.getRouteData( route );
        var ignoreFirstOrgOldData = false; //(routeConfig.type === "appendTask" && routeConfig.appendTaskIdentityType === "select");

        dataVisable.each(function (config, i) {
            var sNode;
            var width;
            if (i + 1 == len && (len % 2 === 1)) {
                sNode = trs[trs.length - 1].getFirst("td");
                sNode.set("colspan", 2);
                trs[trs.length - 1].getLast("td").destroy();
                sNode.setStyle("border", "0px");
                sNode.set("width", "100%");
                sNode.store("orgName", config.name);

                if (orgItemMap_old[config.name]) {
                    var org = orgItemMap_old[config.name];
                    this.orgItems.push(org);
                    this.orgItemMap[config.name] = org;

                    var td = tdsMap_old[config.name];
                    td.getChildren().inject(sNode);
                } else {
                    this.loadOrg(sNode, config, "all", ignoreFirstOrgOldData && i == 0)
                }
            } else {
                var row = ((i + 2) / 2).toInt();
                var tr = trs[row - 1];
                sNode = (i % 2 === 0) ? tr.getFirst("td") : tr.getLast("td");
                sNode.store("orgName", config.name);

                if (orgItemMap_old[config.name]) {
                    var org = orgItemMap_old[config.name];
                    this.orgItems.push(org);
                    this.orgItemMap[config.name] = org;

                    var td = tdsMap_old[config.name];
                    td.getChildren().inject(sNode);
                } else {
                    this.loadOrg(sNode, config, (i % 2 === 0) ? "left" : "right", ignoreFirstOrgOldData && i == 0)
                }
            }
        }.bind(this));
        if (table_old) table_old.destroy();
    },
    loadOrg: function (container, json, position, ignoreOldData) {
        var titleNode = new Element("div.selectorTitle", {
            "styles": this.css.selectorTitle
        }).inject(container);
        var titleTextNode = new Element("div.selectorTitleText", {
            "text": json.title,
            "styles": this.css.selectorTitleText
        }).inject(titleNode);

        var errorNode = new Element("div.selectorErrorNode", {
            "styles": this.css.selectorErrorNode
        }).inject(titleNode);

        var contentNode = new Element("div.selectorContent", {
            "styles": this.css.selectorContent
        }).inject(container);
        var org = new MWF.xApplication.process.Work.Processor.Org(contentNode, this.form, json, this);
        org.ignoreOldData = ignoreOldData;
        org.errContainer = errorNode;
        org.summitDlalog = this;
        org.load();
        this.orgItems.push(org);
        this.orgItemMap[json.name] = org;

    },
    showOrgsByRoute: function (route) {
        this.loadOrgs(route);
    },
    clearAllOrgs: function () {
        //清空组织所选人
        for (var key in this.orgItemsObject) {
            var orgItems = this.orgItemsObject[key] || [];
            orgItems.each(function (org) {
                org.setDataToOriginal();
            })
        }
        //
        this.orgTableObject = {};
        this.orgItemsObject = {};
        this.orgItemsMap = {};
        this.orgsArea.empty();
    },
    getCurrentRouteSelectorList: function () {
        var selectorList = [];
        var currentRoute = this.selectedRoute ? this.selectedRoute.retrieve("route") : "";
        var orgList = this.orgItemsObject[currentRoute];
        if (!orgList) return [];
        orgList.each(function (org) {
            if (org.selector && org.selector.selector) {
                selectorList.push(org.selector.selector);
            }
        }.bind(this))
        return selectorList;
    },
    getCurrentRouteOrgList: function () {
        var currentRoute = this.selectedRoute ? this.selectedRoute.retrieve("route") : "";
        var orgList = this.orgItemsObject[currentRoute];
        return orgList || [];
    },
    getSelectorSelectedData: function (filedName) {
        var data = [];
        var orgList = this.getCurrentRouteOrgList();
        for (var i = 0; i < orgList.length; i++) {
            var org = orgList[i];
            if (org.json.name === filedName) {
                var selector = org.selector.selector;
                selector.selectedItems.each(function (item) {
                    data.push(item.data)
                })
            }
        }
        return data;
    },
    getOffsetY: function (node) {
        return (node.getStyle("margin-top").toInt() || 0) +
            (node.getStyle("margin-bottom").toInt() || 0) +
            (node.getStyle("padding-top").toInt() || 0) +
            (node.getStyle("padding-bottom").toInt() || 0) +
            (node.getStyle("border-top-width").toInt() || 0) +
            (node.getStyle("border-bottom-width").toInt() || 0);
    },
    setSize_noform: function () {
        var height = 0;
        if (this.managerProcessNoticeNode) height = height + this.getOffsetY(this.managerProcessNoticeNode) + this.managerProcessNoticeNode.getStyle("height").toInt();
        if (this.managerLoginNode) height = height + this.getOffsetY(this.managerLoginNode) + this.managerLoginNode.getStyle("height").toInt();
        if (this.routeSelectorTile) height = height + this.getOffsetY(this.routeSelectorTile) + this.routeSelectorTile.getStyle("height").toInt();
        if (this.routeSelectorArea) height = height + this.getOffsetY(this.routeSelectorArea) + this.routeSelectorArea.getStyle("height").toInt();
        if (this.routeOpinionTile) height = height + this.getOffsetY(this.routeOpinionTile) + this.routeOpinionTile.getStyle("height").toInt();
        if (this.routeOpinionArea) height = height + this.getOffsetY(this.routeOpinionArea) + this.routeOpinionArea.getStyle("height").toInt();
        this.node.setStyle("height", height+30);
        this.fireEvent("resize");
    },
    setSize: function (currentOrgLength, flag) {
        if (layout.mobile) {
            this.setSize_mobile();
        } else {
            this.setSize_pc(currentOrgLength, flag);
        }
        //this.node.store("width", this.node.getStyle("width").toInt() + ( flag ? 20 : 0 ));
        if (!flag) this.fireEvent("resize");
    },
    setSize_mobile: function () {
        if (this.buttonsArea) {
            debugger;
            var bodySize = $(document.body).getSize();
            var nodeHeight = bodySize.y - this.getOffsetY(this.node);
            this.node.setStyles({
                "overflow-y": "hidden",
                "height": nodeHeight
            });
            var buttonsAreaSize = this.buttonsArea.getSize();
            this.content.setStyles({
                "height": nodeHeight - buttonsAreaSize.y - this.getOffsetY(this.buttonsArea) - this.getOffsetY(this.content),
                "overflow-y": "auto"
            })
        }
    },
    setSize_pc: function (currentOrgLength, flag) {
        var lines = ((currentOrgLength + 1) / 2).toInt();

        var height = 0;
        if (this.routeSelectorTile) height = height + this.getOffsetY(this.routeSelectorTile) + this.routeSelectorTile.getStyle("height").toInt();
        if (this.routeSelectorArea) height = height + this.getOffsetY(this.routeSelectorArea) + this.routeSelectorArea.getStyle("height").toInt();
        //if (this.routeOpinionTile) height = height + this.getOffsetY(this.routeOpinionTile) + this.routeOpinionTile.getStyle("height").toInt();
        //if (this.routeOpinionArea) height = height + this.getOffsetY(this.routeOpinionArea) + this.routeOpinionArea.getStyle("height").toInt();
        //if( this.buttonsArea )height = height + this.getOffsetY(this.buttonsArea) +  this.buttonsArea.getStyle("height").toInt();

        if (lines > 0) {
            if (this.orgsArea) this.orgsArea.show();

            if (flag) {
                // if( this.orgsTile )height = height + this.getOffsetY(this.orgsTile) +  this.orgsTile.getStyle("height").toInt();
                this.orgsArea.getChildren().each(function (el) {
                    height += el.getSize().y + this.getOffsetY(el);
                }.bind(this))
                this.node.setStyle("height", height);
            } else {
                if (this.orgsTile) height = height + this.getOffsetY(this.orgsTile) + this.orgsTile.getStyle("height").toInt();
                height = height + lines * this.options.orgHeight + this.getOffsetY(this.orgsArea);
                this.node.setStyle("height", height);
            }
        } else {
            if (this.orgsArea) this.orgsArea.hide();
            this.node.setStyle("height", height);
            //this.node.store("height", 401 );
        }
        debugger;
        if (this.getMaxOrgLength() > 1) {
            if( this.options.inFlow ){
                this.node.setStyles(this.css.node_wide_flow);
                this.inputOpinionNode.setStyles(this.css.inputOpinionNode_wide_flow);
                this.inputTextarea.setStyles(this.css.inputTextarea_wide_flow);
                this.inputTextareaStyle = this.css.inputTextarea_wide_flow;
                this.selectIdeaNode.setStyles(this.css.selectIdeaNode_wide_flow);
            }else{
                this.node.setStyles(this.css.node_wide);
                this.inputOpinionNode.setStyles(this.css.inputOpinionNode_wide);
                this.inputTextarea.setStyles(this.css.inputTextarea_wide);
                this.inputTextareaStyle = this.css.inputTextarea_wide;
                this.selectIdeaNode.setStyles(this.css.selectIdeaNode_wide);
            }

        } else {
            this.node.setStyles(this.css.node);
            this.inputOpinionNode.setStyles(this.css.inputOpinionNode);
            this.inputTextarea.setStyles(this.css.inputTextarea);
            this.inputTextareaStyle = this.css.inputTextarea;
            this.selectIdeaNode.setStyles(this.css.selectIdeaNode);
        }
    },
    isErrorHeightOverflow: function () {
        var hasOverflow = false;
        (this.orgItems || []).each(function (item) {
            if (item.errorHeightOverflow) {
                hasOverflow = true;
            }
        }.bind(this));
        return hasOverflow;
    },
    checkErrorHeightOverflow: function (force) {
        if (force || this.isErrorHeightOverflow()) {
            this.setSize(this.orgItems.length, true);
        }
    },
    errorHeightChange: function () {
        debugger;
        this.checkErrorHeightOverflow(true)
    },
    validationOrgs: function () {
        if (!this.orgItems || !this.orgItems.length) return true;
        var flag = true;
        this.orgItems.each(function (item) {
            if (!item.validation()) flag = false;
        }.bind(this));
        this.checkErrorHeightOverflow();
        return flag;
    },
    isOrgsHasEmpower: function () {
        if (!this.orgItems || !this.orgItems.length) return true;
        var flag = false;
        this.needCheckEmpowerOrg = [];
        this.orgItems.each(function (item) {
            if (item.hasEmpowerIdentity()) {
                this.needCheckEmpowerOrg.push(item);
                flag = true;
            }
        }.bind(this));
        return flag;
    },
    saveOrgs: function (keepSilent) {
        if (!this.orgItems || !this.orgItems.length) return true;
        var flag = true;
        this.orgItems.each(function (item) {
            if (!item.save(!keepSilent)) flag = false;
        }.bind(this));
        return flag;
    },
    saveOrgsWithCheckEmpower: function (callback) {
        var currentRoute = this.selectedRoute ? this.selectedRoute.retrieve("route") : "";

        var visableOrg = this.getVisableOrgData( currentRoute || this.selectedRouteId || "" );
        var needOrgLength = visableOrg.length;

        var loadedOrgLength = 0;
        if ( this.orgItems && this.orgItems.length)loadedOrgLength = this.orgItems.length;

        if( needOrgLength !== loadedOrgLength ){
            MWF.xDesktop.notice(
                "error",
                {"x": "center", "y": "center"},
                MWF.xApplication.process.Work.LP.loadedOrgCountUnexpected,
                this.node,
                {"x": 0, "y": 30},
                {"closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000}
            );
            return false;
        }

        if (!this.orgItems || !this.orgItems.length) {
            if (callback) callback();
            return true;
        }
        if (!this.validationOrgs()) return false;
        if (layout.mobile) {
            if (callback) callback();
            return true;
        } else {
            if (!this.isOrgsHasEmpower()) {
                if (callback) callback();
                return true;
            }
            //this.checkEmpowerMode = true;
            this.showEmpowerDlg(callback);
        }
    },
    showEmpowerDlg: function (callback) {
        //this.empowerMask = new Element("div", {"styles": this.css.handwritingMask}).inject(this.node);

        //this.needCheckEmpowerOrg.each( function(org){
        //    org.saveCheckedEmpowerData();
        //}.bind(this));

        var empowerNode = new Element("div.empowerNode", {"styles": this.css.empowerNode});
        var empowerTitleNode = new Element("div", {
            text: MWF.xApplication.process.Xform.LP.empowerDlgText,
            styles: this.css.empowerTitleNode
        }).inject(empowerNode);

        var orgs = this.needCheckEmpowerOrg;
        var len = orgs.length;
        var lines = ((len + 1) / 2).toInt();

        var empowerTable = new Element("table", {
            "cellspacing": 0, "cellpadding": 0, "border": 0, "width": "100%",
            "styles": this.css.empowerTable
        }).inject(empowerNode);

        for (var n = 0; n < lines; n++) {
            var tr = new Element("tr").inject(empowerTable);
            new Element("td", {"width": "50%", "styles": this.css.empowerOddTd}).inject(tr);
            new Element("td", {"width": "50%", "styles": this.css.empowerEvenTd}).inject(tr);
        }

        var trs = empowerTable.getElements("tr");
        orgs.each(function (org, i) {
            var sNode;
            var width;
            if (i + 1 == len && (len % 2 === 1)) {
                sNode = trs[trs.length - 1].getFirst("td");
                sNode.set("colspan", 2);
                trs[trs.length - 1].getLast("td").destroy();
                width = "50%";
            } else {
                var row = ((i + 2) / 2).toInt();
                var tr = trs[row - 1];
                sNode = (i % 2 === 0) ? tr.getFirst("td") : tr.getLast("td");
            }

            var titleNode = new Element("div.empowerAreaTitle", {
                "styles": this.css.empowerAreaTitle
            }).inject(sNode);

            var titleTextNode = new Element("div.empowerAreaTitleText", {
                "text": org.json.title,
                "styles": this.css.empowerAreaTitleText
            }).inject(titleNode);

            var selectAllNode = new Element("div", {
                styles: {
                    float: "right"
                }
            }).inject(titleNode);

            var contentNode = new Element("div.empowerAreaContent", {
                "styles": this.css.empowerAreaContent
            }).inject(sNode);

            org.loadCheckEmpower(null, contentNode, selectAllNode);

        }.bind(this));

        empowerNode.setStyle("height", lines * this.options.orgHeight + 20);
        //var dlgHeight = Math.min( Math.floor( this.form.app.content.getSize().y * 0.9) , lines*this.options.orgHeight + 151 );

        //var width = this.node.retrieve("width");
        //empowerNode.setStyle( "width", width );
        var width = 840;
        //if( len > 1 ){
        //    width = "840"
        //}else{
        //    width = "420"
        //}
        empowerNode.setStyle("width", width + "px");

        this.node.getParent().mask({
            "style": this.css.mask
        });
        this.empowerDlg = o2.DL.open({
            "title": MWF.xApplication.process.Xform.LP.selectEmpower,
            "style": this.form.json.dialogStyle || "user",
            "isResize": false,
            "content": empowerNode,
            //"container" : this.node,
            "width": width + 40, //600,
            "height": "auto", //dlgHeight,
            "mark": false,
            "onPostLoad": function () {
                if (this.nodeWidth) {
                    this.node.setStyle("width", this.nodeWidth + "px");
                }
                if (this.nodeHeight) {
                    this.node.setStyle("height", this.nodeHeight + "px");
                }
            },
            "buttonList": [
                {
                    "type": "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function (d, e) {
                        //if (this.empowerDlg) this.empowerDlg.okButton.click();

                        orgs.each(function (org, i) {
                            org.saveCheckedEmpowerData(function () {
                                if (i === orgs.length - 1) {
                                    if (callback) callback();
                                    this.node.getParent().unmask();
                                    this.empowerDlg.close();
                                }
                            }.bind(this))
                        }.bind(this))
                    }.bind(this)
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function () {
                        this.node.getParent().unmask();
                        this.empowerDlg.close();
                    }.bind(this)
                }
            ]
        });
    },
    managerLogin: function (e) {
        debugger;
        var _self = this;
        var user = (this.task.identityDn || this.task.identity).split("@")[0];
        var text = MWF.xApplication.process.Work.LP.managerLoginConfirmContent.replace("{user}", user);
        MWF.xDesktop.confirm("infor", e, MWF.xApplication.process.Work.LP.managerLoginConfirmTitle, text, 450, 120, function () {
            o2.Actions.load("x_organization_assemble_authentication").AuthenticationAction.switchUser({"credential": (_self.task.personDn || _self.task.person)}, function () {
                var text = MWF.xApplication.process.Work.LP.managerLoginSuccess.replace("{user}", user);
                MWF.xDesktop.notice("success", {x: "right", y: "top"}, text);
                window.open(o2.filterUrl("../x_desktop/work.html?workid=" + _self.task.work));
            }.bind(this));
            this.close();
        }, function () {
            this.close();
        }, null, null);
    }

});

//兼容快速流转，所以需要判断
if (MWF.xApplication.process.Xform && MWF.xApplication.process.Xform.Form) {
    MWF.xDesktop.requireApp("process.Xform", "Org", null, false);

    MWF.xApplication.process.Work.Processor.Org = new Class({
        Implements: [Options, Events],
        options: {
            moduleEvents: ["queryLoadSelector", "postLoadSelector", "postLoadContent", "queryLoadCategory", "postLoadCategory",
                "selectCategory", "unselectCategory", "queryLoadItem", "postLoadItem", "selectItem", "unselectItem", "change"]
        },
        initialize: function (container, form, json, processor, options) {
            this.form = form;
            this.json = json;
            this.processor = processor;
            this.container = $(container);
            this.orgAction = MWF.Actions.get("x_organization_assemble_control");
            this.setOptions(options);
        },
        load: function () {
            if (layout.mobile) {
                setTimeout(function () { //如果有输入法界面，这个时候页面的计算不对，所以等100毫秒
                    var options = this.getOptions();
                    if (options) {
                        //this.selector = new MWF.O2Selector(this.container, options);
                        this.selector = new MWF.O2Selector($(document.body), options);
                    }
                }.bind(this), 100)
            } else {
                var options = this.getOptions();
                if (options) {
                    this.selector = new MWF.O2Selector(this.container, options);
                }
            }
        },
        clearTooltip: function(){
            if( this.selector && this.selector.selector && this.selector.selector.clearTooltip ){
                this.selector.selector.clearTooltip();
            }
        },
        _getOrgOptions: function () {
            this.selectTypeList = typeOf(this.json.selectType) == "array" ? this.json.selectType : [this.json.selectType];
            if (this.selectTypeList.contains("identity")) {
                this.identityOptions = new MWF.xApplication.process.Work.Processor.IdentityOptions(this.form, this.json);
            }
            if (this.selectTypeList.contains("unit")) {
                this.unitOptions = new MWF.xApplication.process.Work.Processor.UnitOptions(this.form, this.json);
            }
            if( this.selectTypeList.contains( "group" ) ){
               this.groupOptions = new MWF.xApplication.process.Work.Processor.GroupOptions( this.form, this.json );
            }
        },
        getOptions: function () {
            var _self = this;
            this._getOrgOptions();
            if (this.selectTypeList.length === 0) return false;
            var exclude = [];
            if (this.json.exclude) {
                var v = this.form.Macro.exec(this.json.exclude.code, this);
                exclude = typeOf(v) === "array" ? v : [v];
            }

            var identityOpt;
            if (this.identityOptions) {
                identityOpt = this.identityOptions.getOptions();
                if (this.json.identityRange !== "all") {
                    if (!identityOpt.noUnit && (!identityOpt.units || !identityOpt.units.length)) {
                        this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange, "error", this.node);
                        identityOpt.disabled = true;
                        // return false;
                    }
                }
                if (!identityOpt.noUnit && this.json.dutyRange && this.json.dutyRange !== "all") {
                    if (!identityOpt.dutys || !identityOpt.dutys.length) {
                        this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange, "error", this.node);
                        identityOpt.disabled = true;
                        // return false;
                    }
                }
                if (this.ignoreOldData) {
                    identityOpt.values = this._computeValue() || [];
                } else {
                    identityOpt.values = this.getValue() || [];
                }
                identityOpt.exclude = exclude;
            }

            var unitOpt;
            if (this.unitOptions) {
                unitOpt = this.unitOptions.getOptions();
                if (this.json.unitRange !== "all") {
                    if (!unitOpt.units || !unitOpt.units.length) {
                        this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange, "error", this.node);
                        unitOpt.disabled = true;
                        // return false;
                    }
                }
                if (this.ignoreOldData) {
                    unitOpt.values = this._computeValue() || [];
                } else {
                    unitOpt.values = this.getValue() || [];
                }
                unitOpt.exclude = exclude;
            }

            var groupOpt;
            if( this.groupOptions ){
               groupOpt = this.groupOptions.getOptions();
                if (this.ignoreOldData) {
                    groupOpt.values = this._computeValue() || [];
                } else {
                    groupOpt.values = this.getValue() || [];
                }
               groupOpt.exclude = exclude;
            }

            var defaultOpt;
            if (layout.mobile) {
                defaultOpt = {
                    "style": "default",
                    "zIndex": 3000
                };
            } else {
                defaultOpt = {
                    "style": "process",
                    "width": "auto",
                    "height": "240",
                    "embedded": true,
                    "hasLetter": false, //字母
                    "hasTop": true //可选、已选的标题
                };
            }

            if (this.json.events && typeOf(this.json.events) === "object") {
                Object.each(this.json.events, function (e, key) {
                    if (e.code) {
                        if (this.options.moduleEvents.indexOf(key) !== -1) {
                            //this.addEvent(key, function(event){
                            //    return this.form.Macro.fire(e.code, this, event);
                            //}.bind(this));
                            if (key === "postLoadSelector") {
                                this.addEvent("loadSelector", function (selector) {
                                    return this.form.Macro.fire(e.code, selector);
                                }.bind(this))
                            } else if (key === "queryLoadSelector") {
                                defaultOpt["onQueryLoad"] = function (target) {
                                    return this.form.Macro.fire(e.code, target);
                                }.bind(this)
                            } else {
                                defaultOpt["on" + key.capitalize()] = function (target) {
                                    return this.form.Macro.fire(e.code, target);
                                }.bind(this)
                            }
                        }
                    }
                }.bind(this));
            }

            if (this.needValid()) {
                defaultOpt["onValid"] = function (selector) {
                    this.validOnSelect();
                }.bind(this);
            }

            if (this.form.json.selectorStyle) {
                defaultOpt = Object.merge(Object.clone(this.form.json.selectorStyle), defaultOpt);
                if (this.form.json.selectorStyle.style) defaultOpt.style = this.form.json.selectorStyle.style;
            }

            var mobileEvents = {
                "onComplete": function (items) {
                    this.selectOnComplete(items);
                }.bind(this),
                "onCancel": this.selectOnCancel.bind(this),
                "onClose": this.selectOnClose.bind(this)
            };

            if (this.selectTypeList.length === 1) {
                var opts = Object.merge(
                    defaultOpt,
                    {
                        "type": this.selectTypeList[0],
                        "onLoad": function () {
                            //this 为 selector
                            _self.selectOnLoad(this, this.selector)
                        }
                        //"onComplete": function(items){
                        //    this.selectOnComplete(items);
                        //}.bind(this),
                        //"onCancel": this.selectOnCancel.bind(this),
                        //"onClose": this.selectOnClose.bind(this)
                    },
                    layout.mobile ? mobileEvents : {},
                    identityOpt || unitOpt || groupOpt
                )
                return this.filterOptionValues( opts, this.selectTypeList[0] );
            } else if (this.selectTypeList.length > 1) {
                var options = {
                    "type": "",
                    "types": this.selectTypeList,
                    "onLoad": function () {
                        //this 为 selector
                        _self.selectOnLoad(this)
                    }
                    //"onComplete": function(items){
                    //    this.selectOnComplete(items);
                    //}.bind(this),
                    //"onCancel": this.selectOnCancel.bind(this),
                    //"onClose": this.selectOnClose.bind(this)
                };
                if (identityOpt) {
                    options.identityOptions = Object.merge(
                        defaultOpt,
                        layout.mobile ? mobileEvents : {},
                        identityOpt
                    );
                }
                if (unitOpt) {
                    options.unitOptions = Object.merge(
                        defaultOpt,
                        layout.mobile ? mobileEvents : {},
                        unitOpt
                    );
                }
                if (groupOpt) {
                    options.groupOptions = Object.merge(
                        defaultOpt,
                        layout.mobile ? mobileEvents : {},
                        groupOpt
                    );
                }
                return options;
            }
        },
        filterOptionValues: function( options, type ){
            var suffix;
            switch (type) {
                case "identity": suffix = "I"; break;
                case "unit": suffix = "U"; break;
                case "group": suffix = "G"; break;
            }
            options.values = (options.values || []).filter(function (v) {
                if( typeOf(v) === "string" ){
                    if( v.contains("@") ){
                        return v.split("@").getLast().toUpperCase() === suffix;
                    }else{
                        return true;
                    }
                }else if( typeOf(v) === "object" ){
                    if( v.distinguishedName ){
                        return v.distinguishedName.split("@").getLast().toUpperCase() === suffix;
                    }else{
                        return false;
                    }
                }
                return false;
            }.bind(this));
            return options;
        },
        selectOnComplete: function (items) { //移动端才执行
            var array = [];
            items.each(function (item) {
                array.push(item.data);
            }.bind(this));

            var simple = this.json.storeRange === "simple";

            this.checkEmpower(array, function (data) {
                var values = [];
                data.each(function (d) {
                    values.push(MWF.org.parseOrgData(d, true, simple));
                }.bind(this));

                this.setData(values);

                //this.validationMode();
                //this.validation();

                this.container.empty();
                this.loadOrgWidget(values, this.container);

                this.selector = null;

                this.fireEvent("select", [items, values]);
            }.bind(this))
        },
        selectOnCancel: function () { //移动端才执行
            //this.validation();
        },
        selectOnLoad: function (selector) {
            //if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
            this.fireEvent("loadSelector", [selector])
        },
        selectOnClose: function () {
            var v = this._getBusinessData();
            //if (!v || !v.length) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
        },
        loadOrgWidget: function (value, node) {
            var height = node.getStyle("height").toInt();
            if (node.getStyle("overflow") === "visible" && !height) node.setStyle("overflow", "hidden");
            if (value && value.length) {
                value.each(function (data) {
                    if( typeOf(data) === "string" ){
                        data = { distinguishedName : data, name : o2.name.cn(data) };
                    }
                    var flag = data.distinguishedName.substr(data.distinguishedName.length - 1, 1);
                    var copyData = Object.clone(data);
                    if (this.json.displayTextScript && this.json.displayTextScript.code) {
                        this.currentData = copyData;
                        var displayName = this.form.Macro.exec(this.json.displayTextScript.code, this);
                        if (displayName) {
                            copyData.displayName = displayName;
                        }
                        this.currentData = null;
                    }

                    var widget;
                    switch (flag.toLowerCase()) {
                        case "i":
                            widget = new MWF.widget.O2Identity(copyData, node, {"style": "xform", "lazy": true});
                            break;
                        case "p":
                            widget = new MWF.widget.O2Person(copyData, node, {"style": "xform", "lazy": true});
                            break;
                        case "u":
                            widget = new MWF.widget.O2Unit(copyData, node, {"style": "xform", "lazy": true});
                            break;
                        case "g":
                            widget = new MWF.widget.O2Group(copyData, node, {"style": "xform", "lazy": true});
                            break;
                        default:
                            widget = new MWF.widget.O2Other(copyData, node, {"style": "xform", "lazy": true});
                    }
                    widget.field = this;
                    if (layout.mobile) {
                        //widget.node.setStyles({
                        //    "float" : "none"
                        //})
                    }
                }.bind(this));
            }
        },

        hasEmpowerIdentity: function () {
            var data = this.getData();
            if (!this.empowerChecker) this.empowerChecker = new MWF.xApplication.process.Work.Processor.EmpowerChecker(this.form, this.json, this.processor);
            return this.empowerChecker.hasEmpowerIdentity(data);
        },
        checkEmpower: function (data, callback, container, selectAllNode) {
            if (typeOf(data) === "array" && this.identityOptions && this.json.isCheckEmpower && this.json.identityResultType === "identity") {
                if (!this.empowerChecker) this.empowerChecker = new MWF.xApplication.process.Work.Processor.EmpowerChecker(this.form, this.json, this.processor);
                this.empowerChecker.selectAllNode = selectAllNode;
                this.empowerChecker.load(data, callback, container);
            } else {
                if (callback) callback(data);
            }
        },

        loadCheckEmpower: function (callback, container, selectAllNode) {
            this.checkEmpower(this.getData(), callback, container, selectAllNode)
        },
        saveCheckedEmpowerData: function (callback) {
            var data = this.getData();
            var simple = this.json.storeRange === "simple";
            //this.empowerChecker.replaceEmpowerIdentity(data, function( newData ){
            this.empowerChecker.setIgnoreEmpowerFlag(data, function (newData) {
                var values = [];
                newData.each(function (d) {
                    values.push(MWF.org.parseOrgData(d, true, simple));
                }.bind(this));
                this.setData(values);
                if (callback) callback(values)
            }.bind(this))
        },

        //saveWithCheckEmpower: function( isValid, callback ){
        //    var checkEmpowerData = function(){
        //        var array = this.getData();
        //        this.checkEmpower( array, function( data ){
        //            var values = [];
        //            data.each(function(d){
        //                values.push(MWF.org.parseOrgData(d, true));
        //            }.bind(this));
        //            this.setData( values );
        //            if( callback )callback(values)
        //        }.bind(this), container, selectAllNode)
        //    }.bind(this)
        //    if( isValid ){
        //        if( this.validation() ){
        //            checkEmpowerData( function(){
        //                if(callback)callback();
        //            }.bind(this));
        //            return true;
        //        }else{
        //            return false;
        //        }
        //    }else{
        //        //this.setData( this.getData() );
        //        checkEmpowerData( function(){
        //            if(callback)callback();
        //        }.bind(this));
        //        return true;
        //    }
        //},

        save: function (isValid) {
            if (isValid) {
                if (this.validation()) {
                    return true;
                } else {
                    this.processor.checkErrorHeightOverflow();
                    return false;
                }
            } else {
                this.setData(this.getData());
                return true;
            }
        },

        resetSelectorData: function () {
            if (this.selector && this.selector.selector) {
                this.selector.selector.emptySelectedItems();
                this.selector.selector.options.values = this.getValue() || [];
                this.selector.selector.setSelectedItem();
            }
        },
        setDataToOriginal: function () {
            var v = this._computeValue();
            this.setData(v || "");
        },
        resetData: function () {
            var v = this.getValue() || [];
            //this.setData((v) ? v.join(", ") : "");
            this.setData(v);
        },
        getData: function () {
            if (this.selector && !layout.mobile) {
                return this.getSelectedData();
            } else {
                return this.getValue();
            }
        },
        getSelectedData: function () {
            if (layout.mobile) {
                return this.getValue();
            } else {
                var simple = this.json.storeRange === "simple";
                var data = [];
                if (this.selector && this.selector.selector) {
                    this.selector.selector.selectedItems.each(function (item) {
                        data.push(MWF.org.parseOrgData(item.data, true, simple));
                    })
                }
                return data;
            }
        },
        getValue: function () {
            var value = this._getBusinessData();
            if (!value) value = this._computeValue();
            return value || "";
        },
        _computeValue: function () {
            var values = [];
            if (this.json.identityValue) {
                this.json.identityValue.each(function (v) {
                    if (v) values.push(v)
                });
            }
            if (this.json.unitValue) {
                this.json.unitValue.each(function (v) {
                    if (v) values.push(v)
                });
            }
            // if (this.json.groupValue) {
            //     this.json.groupValue.each(function (v) {
            //         if (v) values.push(v)
            //     });
            // }
            if (this.json.dutyValue) {
                var dutys = JSON.decode(this.json.dutyValue);
                var par;
                if (dutys.length) {
                    dutys.each(function (duty) {
                        if (duty.code) par = this.form.Macro.exec(duty.code, this);
                        var code = "return this.org.getDuty(\"" + duty.name + "\", \"" + par + "\")";

                        var d = this.form.Macro.exec(code, this);
                        if (typeOf(d) !== "array") d = (d) ? [d.toString()] : [];
                        d.each(function (dd) {
                            if (dd) values.push(dd);
                        });

                    }.bind(this));
                }
            }
            if (this.json.defaultValue && this.json.defaultValue.code) {
                var fd = this.form.Macro.exec(this.json.defaultValue.code, this);
                if (typeOf(fd) !== "array") fd = (fd) ? [fd] : [];
                fd.each(function (fdd) {
                    if (fdd) {
                        if (typeOf(fdd) === "string") {
                            var data;
                            this.getOrgAction()[this.getValueMethod(fdd)](function (json) {
                                data = json.data
                            }.bind(this), null, fdd, false);
                            values.push(data);
                        } else {
                            values.push(fdd);
                        }
                    }
                }.bind(this));
            }
            if (this.json.count > 0) {
                return values.slice(0, this.json.count);
            }
            return values;
            //return (this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
        },
        getOrgAction: function () {
            if (!this.orgAction) this.orgAction = MWF.Actions.get("x_organization_assemble_control");
            //if (!this.orgAction) this.orgAction = new MWF.xApplication.Selector.Actions.RestActions();
            return this.orgAction;
        },
        setData: function (value) {

            if (!value) return false;
            var oldValues = this.getValue();
            var values = [];

            var simple = this.json.storeRange === "simple";

            var type = typeOf(value);
            if (type === "array") {
                value.each(function (v) {
                    var vtype = typeOf(v);
                    var data = null;
                    if (vtype === "string") {
                        this.getOrgAction()[this.getValueMethod(v)](function (json) {
                            data = MWF.org.parseOrgData(json.data, true, simple);
                        }.bind(this), null, v, false);
                    }
                    if (vtype === "object") {
                        data = MWF.org.parseOrgData(v, true, simple);
                        if (data.woPerson) delete data.woPerson;
                    }
                    if (data) values.push(data);
                }.bind(this));
            }
            if (type === "string") {
                var vData;
                this.getOrgAction()[this.getValueMethod(value)](function (json) {
                    vData = MWF.org.parseOrgData(json.data, true, simple);
                }.bind(this), null, value, false);
                if (vData) values.push(vData);
            }
            if (type === "object") {
                var vData = MWF.org.parseOrgData(value, true, simple);
                if (vData.woPerson) delete vData.woPerson;
                values.push(vData);
            }

            var change = false;
            if (oldValues.length && values.length) {
                if (oldValues.length === values.length) {
                    for (var i = 0; i < oldValues.length; i++) {
                        if ((oldValues[i].distinguishedName !== values[i].distinguishedName) || (oldValues[i].name !== values[i].name) || (oldValues[i].unique !== values[i].unique)) {
                            change = true;
                            break;
                        }
                    }
                } else {
                    change = true;
                }
            } else if (values.length || oldValues.length) {
                change = true;
            }
            this._setBusinessData(values);
            if (change) this.fireEvent("change");
        },

        getValueMethod: function (value) {
            if (value) {
                var flag = value.substr(value.length - 1, 1);
                switch (flag.toLowerCase()) {
                    case "i":
                        return "getIdentity";
                    case "p":
                        return "getPerson";
                    case "u":
                        return "getUnit";
                    case "g":
                        return "getGroup";
                    default:
                        return (this.json.selectType === "unit") ? "getUnit" : "getIdentity";
                }
            }
            return (this.json.selectType === "unit") ? "getUnit" : "getIdentity";
        },

        _getBusinessData: function () {
            if (this.json.section == "yes") {
                return this._getBusinessSectionData();
            } else {
                if (this.json.type === "Opinion") {
                    return this._getBusinessSectionDataByPerson();
                } else {
                    return this.form.businessData.data[this.json.name] || "";
                }
            }
        },
        _getBusinessSectionData: function () {
            switch (this.json.sectionBy) {
                case "person":
                    return this._getBusinessSectionDataByPerson();
                case "unit":
                    return this._getBusinessSectionDataByUnit();
                case "activity":
                    return this._getBusinessSectionDataByActivity();
                case "splitValue":
                    return this._getBusinessSectionDataBySplitValue();
                case "script":
                    return this._getBusinessSectionDataByScript(this.json.sectionByScript.code);
                default:
                    return this.form.businessData.data[this.json.name] || "";
            }
        },
        _getBusinessSectionDataByPerson: function () {
            this.form.sectionListObj[this.json.name] = layout.desktop.session.user.id;
            var dataObj = this.form.businessData.data[this.json.name];
            return (dataObj) ? (dataObj[layout.desktop.session.user.id] || "") : "";
        },
        _getBusinessSectionDataByUnit: function () {
            this.form.sectionListObj[this.json.name] = "";
            var key = (this.form.businessData.task) ? this.form.businessData.task.unit : "";
            if (key) this.form.sectionListObj[this.json.name] = key;
            var dataObj = this.form.businessData.data[this.json.name];
            if (!dataObj) return "";
            return (key) ? (dataObj[key] || "") : "";
        },
        _getBusinessSectionDataByActivity: function () {
            this.form.sectionListObj[this.json.name] = "";
            var key = (this.form.businessData.work) ? this.form.businessData.work.activity : "";
            if (key) this.form.sectionListObj[this.json.name] = key;
            var dataObj = this.form.businessData.data[this.json.name];
            if (!dataObj) return "";
            return (key) ? (dataObj[key] || "") : "";
        },
        _getBusinessSectionDataBySplitValue: function () {
            this.form.sectionListObj[this.json.name] = "";
            var key = (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
            if (key) this.form.sectionListObj[this.json.name] = key;
            var dataObj = this.form.businessData.data[this.json.name];
            if (!dataObj) return "";
            return (key) ? (dataObj[key] || "") : "";
        },
        _getBusinessSectionDataByScript: function (code) {
            this.form.sectionListObj[this.json.name] = "";
            var dataObj = this.form.businessData.data[this.json.name];
            if (!dataObj) return "";
            var key = this.form.Macro.exec(code, this);
            if (key) this.form.sectionListObj[this.json.name] = key;
            return (key) ? (dataObj[key] || "") : "";
        },

        loadPathData: function (path) {
            var data = null;
            this.form.workAction.getJobDataByPath(this.form.businessData.work.job, path, function (json) {
                data = json.data || null;
            }, null, false);
            return data;
        },

        _setBusinessData: function (v) {
            if (this.json.section == "yes") {
                // var d = this.loadPathData(this.json.name);
                // if (d) this.form.businessData.data[this.json.name] = d;
                this._setBusinessSectionData(v);
            } else {
                if (this.json.type === "Opinion") {
                    // var d = this.loadPathData(this.json.name);
                    // if (d) this.form.businessData.data[this.json.name] = d;
                    this._setBusinessSectionDataByPerson(v);
                } else {
                    if (this.form.businessData.data[this.json.name]) {
                        this.form.businessData.data[this.json.name] = v;
                    } else {
                        this.form.businessData.data[this.json.name] = v;
                        this.form.Macro.environment.setData(this.form.businessData.data);
                    }
                    if (this.json.isTitle) this.form.businessData.work.title = v;
                }
            }
        },
        _setBusinessSectionData: function (v) {
            switch (this.json.sectionBy) {
                case "person":
                    this._setBusinessSectionDataByPerson(v);
                    break;
                case "unit":
                    this._setBusinessSectionDataByUnit(v);
                    break;
                case "activity":
                    this._setBusinessSectionDataByActivity(v);
                    break;
                case "splitValue":
                    this._setBusinessSectionDataBySplitValue(v);
                    break;
                case "script":
                    this._setBusinessSectionDataByScript(this.json.sectionByScript.code, v);
                    break;
                default:
                    if (this.form.businessData.data[this.json.name]) {
                        this.form.businessData.data[this.json.name] = v;
                    } else {
                        this.form.businessData.data[this.json.name] = v;
                        this.form.Macro.environment.setData(this.form.businessData.data);
                    }
            }
        },
        _setBusinessSectionDataByPerson: function (v) {
            var resetData = false;
            var key = layout.desktop.session.user.id;
            this.form.sectionListObj[this.json.name] = key;

            var dataObj = this.form.businessData.data[this.json.name];
            if (!dataObj) {
                dataObj = {};
                this.form.businessData.data[this.json.name] = dataObj;
                resetData = true;
            }
            if (!dataObj[key]) resetData = true;
            dataObj[key] = v;

            if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
        },
        _setBusinessSectionDataByUnit: function (v) {
            var resetData = false;
            var key = (this.form.businessData.task) ? this.form.businessData.task.unit : "";

            if (key) {
                this.form.sectionListObj[this.json.name] = key;
                var dataObj = this.form.businessData.data[this.json.name];
                if (!dataObj) {
                    dataObj = {};
                    this.form.businessData.data[this.json.name] = dataObj;
                    resetData = true;
                }
                if (!dataObj[key]) resetData = true;
                dataObj[key] = v;
            }

            if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
        },
        _setBusinessSectionDataByActivity: function (v) {
            var resetData = false;
            var key = (this.form.businessData.work) ? this.form.businessData.work.activity : "";

            if (key) {
                this.form.sectionListObj[this.json.name] = key;
                var dataObj = this.form.businessData.data[this.json.name];
                if (!dataObj) {
                    dataObj = {};
                    this.form.businessData.data[this.json.name] = dataObj;
                    resetData = true;
                }
                if (!dataObj[key]) resetData = true;
                dataObj[key] = v;
            }

            if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
        },
        _setBusinessSectionDataBySplitValue: function (v) {
            var resetData = false;
            var key = (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";

            if (key) {
                this.form.sectionListObj[this.json.name] = key;
                var dataObj = this.form.businessData.data[this.json.name];
                if (!dataObj) {
                    dataObj = {};
                    this.form.businessData.data[this.json.name] = dataObj;
                    resetData = true;
                }
                if (!dataObj[key]) resetData = true;
                dataObj[key] = v;
            }

            if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
        },
        _setBusinessSectionDataByScript: function (code, v) {
            var resetData = false;
            var key = this.form.Macro.exec(code, this);

            if (key) {
                this.form.sectionListObj[this.json.name] = key;
                var dataObj = this.form.businessData.data[this.json.name];
                if (!dataObj) {
                    dataObj = {};
                    this.form.businessData.data[this.json.name] = dataObj;
                    resetData = true;
                }
                if (!dataObj[key]) resetData = true;
                dataObj[key] = v;
            }

            if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
        },

        createErrorNode: function (text) {
            var _self = this;
            var node;
            if (this.processor.css.errorContentNode) {
                node = new Element("div", {
                    "styles": this.processor.css.errorContentNode,
                    "text": text
                });
                if (this.processor.css.errorCloseNode) {
                    var closeNode = new Element("div", {
                        "styles": this.processor.css.errorCloseNode,
                        "events": {
                            "click": function () {
                                this.destroy();
                                if (_self.errorHeightOverflow) {
                                    _self.errorHeightOverflow = false;
                                    _self.processor.errorHeightChange();
                                }
                            }.bind(node)
                        }
                    }).inject(node);
                }
            } else {
                node = new Element("div");
                var iconNode = new Element("div", {
                    "styles": {
                        "width": "20px",
                        "height": "20px",
                        "float": "left",
                        "background": "url(" + "../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                    }
                }).inject(node);
                var textNode = new Element("div", {
                    "styles": {
                        "height": "auto",
                        "min-height": "20px",
                        "line-height": "20px",
                        "margin-left": "20px",
                        "color": "red",
                        "word-break": "break-all"
                    },
                    "text": text
                }).inject(node);
            }
            return node;
        },
        notValidationMode: function (text) {
            if (!this.isNotValidationMode) {
                //this.isNotValidationMode = true;
                //this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
                //this.node.setStyle("border-color", "red");

                this.errNode = this.createErrorNode(text);
                if (this.errContainer) {
                    this.errContainer.empty();
                    this.errNode.inject(this.errContainer);
                } else {
                    this.errNode.inject(this.container, "after");
                }
                var errorSize = this.errNode.getSize();
                debugger;
                if (!layout.mobile && errorSize.y > 26) {
                    this.errorHeightOverflow = true;
                }

                //this.showNotValidationMode(this.node);
                //if (!this.node.isIntoView()) this.node.scrollIntoView();
            }
        },
        needValid: function () {
            return ((this.json.validationCount && typeOf(this.json.validationCount.toInt()) === "number") ||
                (this.json.validation && this.json.validation.code));
        },
        validOnSelect: function () {
            if (!this.errNode) return true;
            var flag = true;
            if (this.json.validationCount && typeOf(this.json.validationCount.toInt()) === "number") {
                if (this.selector.selector.selectedItems.length < this.json.validationCount.toInt()) {
                    flag = MWF.xApplication.process.Xform.LP.selectItemCountNotice.replace("{count}", this.json.validationCount);
                }
            }
            if (flag === true) {
                if (this.json.validation && this.json.validation.code) {
                    var data = this.getData();
                    this.setData(data);
                    flag = this.form.Macro.exec(this.json.validation.code, this);
                    if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
                }
            }
            if (flag.toString() != "true") {
                this.notValidationMode(flag);
                this.processor.errorHeightChange();
                return false;
            } else if (this.errNode) {
                this.errNode.destroy();
                this.errNode = null;
                if (this.errorHeightOverflow) {
                    this.errorHeightOverflow = false;
                    this.processor.errorHeightChange();
                }
            }
            return true;
        },
        validation: function () {
            var data = this.getData();
            this.setData(data);
            var flag = true;
            if (this.json.validationCount && typeOf(this.json.validationCount.toInt()) === "number") {
                if (data.length < this.json.validationCount.toInt()) {
                    //"请至少选择" + this.json.validationCount + "项"
                    flag = MWF.xApplication.process.Xform.LP.selectItemCountNotice.replace("{count}", this.json.validationCount);
                }
            }

            if (flag === true) {
                if (this.json.validation && this.json.validation.code) {
                    flag = this.form.Macro.exec(this.json.validation.code, this);
                    if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
                }
            }

            if (flag.toString() != "true") {
                this.notValidationMode(flag);
                return false;
            } else if (this.errNode) {
                this.errNode.destroy();
                this.errNode = null;
            }
            return true;
        }
    });

    MWF.xApplication.process.Work.Processor.EmpowerChecker = new Class({
        Extends: MWF.APPOrg.EmpowerChecker,
        initialize: function (form, json, processor) {
            this.form = form;
            this.json = json;
            this.processor = processor;
            this.css = this.processor.css;
            this.checkedAllItems = true;
        },
        load: function (data, callback, container) {
            if (typeOf(data) === "array" && this.json.isCheckEmpower && this.json.identityResultType === "identity") {
                var array = [];
                data.each(function (d) {
                    if (d.distinguishedName) {
                        var flag = d.distinguishedName.substr(d.distinguishedName.length - 1, 1).toLowerCase();
                        if (flag === "i") {
                            array.push(d.distinguishedName)
                        }
                    }
                }.bind(this));
                if (array.length > 0) {
                    o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({
                        "application": (this.form.businessData.work || this.form.businessData.workCompleted).application,
                        "process": (this.form.businessData.work || this.form.businessData.workCompleted).process,
                        "work": (this.form.businessData.work || this.form.businessData.workCompleted).id,
                        "identityList": array
                    }, function (json) {
                        var arr = [];
                        json.data.each(function (d) {
                            if (d.fromIdentity !== d.toIdentity) arr.push(d);
                        });
                        if (arr.length > 0) {
                            if (layout.mobile) {
                                this.openSelectEmpowerDlg(arr, data, callback, container);
                            } else {
                                this.openSelectEmpowerDlg_embedded(arr, data, callback, container);
                            }
                        } else {
                            if (callback) callback(data);
                        }
                    }.bind(this), function () {
                        if (callback) callback(data);
                    }.bind(this))
                } else {
                    if (callback) callback(data);
                }
            } else {
                if (callback) callback(data);
            }
        },
        hasEmpowerIdentity: function (data) {
            var flag = false;
            if (typeOf(data) === "array" && this.json.isCheckEmpower && this.json.identityResultType === "identity") {
                var array = [];
                data.each(function (d) {
                    if (d.distinguishedName) {
                        var flag = d.distinguishedName.substr(d.distinguishedName.length - 1, 1).toLowerCase();
                        if (flag === "i") array.push(d.distinguishedName)
                    }
                }.bind(this));
                if (array.length > 0) {
                    o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({
                        "application": (this.form.businessData.work || this.form.businessData.workCompleted).application,
                        "process": (this.form.businessData.work || this.form.businessData.workCompleted).process,
                        "work": (this.form.businessData.work || this.form.businessData.workCompleted).id,
                        "identityList": array
                    }, function (json) {
                        var arr = [];
                        json.data.each(function (d) {
                            if (d.fromIdentity !== d.toIdentity)
                                arr.push(d);
                        });
                        if (arr.length > 0) {
                            flag = true;
                        }
                    }.bind(this), null, false)
                }
            }
            return flag;
        },
        openSelectEmpowerDlg_embedded: function (data, orgData, callback, container) {
            var node = new Element("div", {"styles": this.css.empowerAreaNode});
            //var html = "<div style=\"line-height: 30px; color: #333333; overflow: hidden\">"+MWF.xApplication.process.Xform.LP.empowerDlgText+"</div>";
            var html = "<div style=\"margin-bottom:10px; margin-top:10px; overflow-y:auto;\"></div>";
            node.set("html", html);
            var itemNode = node.getLast();
            this.getEmpowerItems(itemNode, data);
            node.inject(container || this.form.app.content);

            if (this.selectAllNode) {
                var selectNode = this.createSelectAllEmpowerNode();
                selectNode.inject(this.selectAllNode);
                if (this.checkedAllItems) {
                    selectNode.store("isSelected", true);
                    selectNode.setStyles(this.css.empowerSelectAllItemNode_selected);
                }
            }
        },
        getSelectedData: function (callback) {
            var json = {};
            this.empowerSelectNodes.each(function (node) {
                if (node.retrieve("isSelected")) {
                    var d = node.retrieve("data");
                    json[d.fromIdentity] = d;
                }
            }.bind(this));
            if (callback) callback(json);
        }
    });

    MWF.xApplication.process.Work.Processor.UnitOptions = new Class({
        Extends: MWF.APPOrg.UnitOptions
    });

    MWF.xApplication.process.Work.Processor.IdentityOptions = new Class({
        Extends: MWF.APPOrg.IdentityOptions
    });

    MWF.xApplication.process.Work.Processor.GroupOptions = new Class({
        Extends: MWF.APPOrg.GroupOptions
    });
}
