(function(e){if(typeof exports=="object"&&typeof module=="object")e(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../ruby/ruby"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror","../htmlmixed/htmlmixed","../ruby/ruby"],e);else e(CodeMirror)})(function(e){"use strict";e.defineMode("haml",function(t){var n=e.getMode(t,{name:"htmlmixed"});var i=e.getMode(t,"ruby");function r(e){return function(t,n){var i=t.peek();if(i==e&&n.rubyState.tokenize.length==1){t.next();n.tokenize=u;return"closeAttributeTag"}else{return o(t,n)}}}function o(e,t){if(e.match("-#")){e.skipToEnd();return"comment"}return i.token(e,t.rubyState)}function u(e,t){var i=e.peek();if(t.previousToken.style=="comment"){if(t.indented>t.previousToken.indented){e.skipToEnd();return"commentLine"}}if(t.startOfLine){if(i=="!"&&e.match("!!")){e.skipToEnd();return"tag"}else if(e.match(/^%[\w:#\.]+=/)){t.tokenize=o;return"hamlTag"}else if(e.match(/^%[\w:]+/)){return"hamlTag"}else if(i=="/"){e.skipToEnd();return"comment"}}if(t.startOfLine||t.previousToken.style=="hamlTag"){if(i=="#"||i=="."){e.match(/[\w-#\.]*/);return"hamlAttribute"}}if(t.startOfLine&&!e.match("-->",false)&&(i=="="||i=="-")){t.tokenize=o;return t.tokenize(e,t)}if(t.previousToken.style=="hamlTag"||t.previousToken.style=="closeAttributeTag"||t.previousToken.style=="hamlAttribute"){if(i=="("){t.tokenize=r(")");return t.tokenize(e,t)}else if(i=="{"){t.tokenize=r("}");return t.tokenize(e,t)}}return n.token(e,t.htmlState)}return{startState:function(){var e=n.startState();var t=i.startState();return{htmlState:e,rubyState:t,indented:0,previousToken:{style:null,indented:0},tokenize:u}},copyState:function(t){return{htmlState:e.copyState(n,t.htmlState),rubyState:e.copyState(i,t.rubyState),indented:t.indented,previousToken:t.previousToken,tokenize:t.tokenize}},token:function(e,t){if(e.sol()){t.indented=e.indentation();t.startOfLine=true}if(e.eatSpace())return null;var n=t.tokenize(e,t);t.startOfLine=false;if(n&&n!="commentLine"){t.previousToken={style:n,indented:t.indented}}if(e.eol()&&t.tokenize==o){e.backUp(1);var i=e.peek();e.next();if(i&&i!=","){t.tokenize=u}}if(n=="hamlTag"){n="tag"}else if(n=="commentLine"){n="comment"}else if(n=="hamlAttribute"){n="attribute"}else if(n=="closeAttributeTag"){n=null}return n}}},"htmlmixed","ruby");e.defineMIME("text/x-haml","haml")});