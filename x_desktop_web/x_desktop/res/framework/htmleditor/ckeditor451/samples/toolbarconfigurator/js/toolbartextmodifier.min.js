(function(){function t(t){o.call(this,t);this.hintContainer=this.codeContainer=null}var o=ToolbarConfigurator.AbstractToolbarModifier,r=ToolbarConfigurator.FullToolbarEditor;ToolbarConfigurator.ToolbarTextModifier=t;t.prototype=Object.create(o.prototype);t.prototype._onInit=function(t,r){o.prototype._onInit.call(this,void 0,r);this._createModifier(r?this.actualConfig:void 0);"function"===typeof t&&t(this.mainContainer)};t.prototype._createModifier=function(t){function e(t){var o=i(t);if(null!==o.charsBetween){var r=s.getUnusedButtonsArray(s.actualConfig.toolbar,!0,o.charsBetween),e=t.getCursor(),o=CodeMirror.Pos(e.line,e.ch-o.charsBetween.length),a=t.getTokenAt(e);"{"===t.getTokenAt({line:e.line,ch:a.start}).string&&(r=["name"]);if(0!==r.length)return new n(o,e,r)}}function n(t,o,r){this.from=t;this.to=o;this.list=r;this._handlers=[]}function i(t,o){var r={};r.cur=t.getCursor();r.tok=t.getTokenAt(r.cur);r["char"]=o||r.tok.string.charAt(r.tok.string.length-1);var e=t.getRange(CodeMirror.Pos(r.cur.line,0),r.cur).split("").reverse().join(""),e=e.replace(/(['|"]\w*['|"])/g,"");r.charsBetween=e.match(/(^\w*)(['|"])/);r.charsBetween&&(r.endChar=r.charsBetween[2],r.charsBetween=r.charsBetween[1].split("").reverse().join(""));return r}function a(t){setTimeout(function(){t.state.completionActive||CodeMirror.showHint(t,e,{hintsClass:"toolbar-modifier",completeSingle:!1})},100);return CodeMirror.Pass}var s=this;this._createToolbar();this.toolbarContainer&&this.mainContainer.append(this.toolbarContainer);o.prototype._createModifier.call(this);this._setupActualConfig(t);var t=this.actualConfig.toolbar,t=CKEDITOR.tools.isArray(t)?"\tconfig.toolbar = "+("[\n\t\t"+r.map(t,function(t){return o.stringifyJSONintoOneLine(t,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0})}).join(",\n\t\t")+"\n\t]")+";":"config.toolbar = [];",t=["CKEDITOR.editorConfig = function( config ) {\n",t,"\n};"].join(""),l=new CKEDITOR.dom.element("div");l.addClass("codemirror-wrapper");this.modifyContainer.append(l);this.codeContainer=CodeMirror(l.$,{mode:{name:"javascript",json:!0},lineNumbers:!1,lineWrapping:!0,viewportMargin:Infinity,value:t,smartIndent:!1,indentWithTabs:!0,indentUnit:4,tabSize:4,theme:"neo",extraKeys:{Left:a,Right:a,"'''":a,"'\"'":a,Backspace:a,Delete:a,"Shift-Tab":"indentLess"}});this.codeContainer.on("endCompletion",function(t,o){var r=i(t);void 0!==o&&t.replaceSelection(r.endChar)});this.codeContainer.on("change",function(){var t=s.codeContainer.getValue(),t=s._evaluateValue(t);null!==t?(s.actualConfig.toolbar=t.toolbar?t.toolbar:s.actualConfig.toolbar,s._fillHintByUnusedElements(),s._refreshEditor(),s.mainContainer.removeClass("invalid")):s.mainContainer.addClass("invalid")});this.hintContainer=new CKEDITOR.dom.element("div");this.hintContainer.addClass("toolbarModifier-hints");this._fillHintByUnusedElements();this.hintContainer.insertBefore(l)};t.prototype._fillHintByUnusedElements=function(){var t=this.getUnusedButtonsArray(this.actualConfig.toolbar,!0),t=this.groupButtonNamesByGroup(t),o=r.map(t,function(t){var o=r.map(t.buttons,function(t){return"<code>"+t+"</code> "}).join("");return["<dt><code>",t.name,"</code></dt><dd>",o,"</dd>"].join("")}).join(" "),e='<dt class="list-header">Toolbar group</dt><dd class="list-header">Unused items</dd>';t.length||(e="<p>All items are in use.</p>");this.codeContainer.refresh();this.hintContainer.setHtml("<h3>Unused toolbar items</h3><dl>"+e+o+"</dl>")};t.prototype.getToolbarGroupByButtonName=function(t){var o=this.fullToolbarEditor.buttonNamesByGroup,r;for(r in o)for(var e=o[r],n=e.length;n--;)if(t===e[n])return r;return null};t.prototype.getUnusedButtonsArray=function(o,e,n){var e=!0===e?!0:!1,i=t.mapToolbarCfgToElementsList(o),o=Object.keys(this.fullToolbarEditor.editorInstance.ui.items),o=r.filter(o,function(t){var o="-"===t,t=void 0===n||0===t.toLowerCase().indexOf(n.toLowerCase());return!o&&t}),o=r.filter(o,function(t){return-1==CKEDITOR.tools.indexOf(i,t)});e&&o.sort();return o};t.prototype.groupButtonNamesByGroup=function(t){var o=[],e=JSON.parse(JSON.stringify(this.fullToolbarEditor.buttonNamesByGroup)),n;for(n in e){var i=e[n],i=r.filter(i,function(o){return-1!==CKEDITOR.tools.indexOf(t,o)});i.length&&o.push({name:n,buttons:i})}return o};t.mapToolbarCfgToElementsList=function(t){function o(t){return"-"!==t}for(var e=[],n=t.length,i=0;i<n;i+=1)t[i]&&"string"!==typeof t[i]&&(e=e.concat(r.filter(t[i].items,o)));return e};t.prototype._setupActualConfig=function(t){t=t||this.editorInstance.config;CKEDITOR.tools.isArray(t.toolbar)||(t.toolbarGroups||(t.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig(!0)),this._fixGroups(t),t.toolbar=this._mapToolbarGroupsToToolbar(t.toolbarGroups,this.actualConfig.removeButtons),this.actualConfig.toolbar=t.toolbar,this.actualConfig.removeButtons="")};t.prototype._mapToolbarGroupsToToolbar=function(t,o){for(var o=o||this.editorInstance.config.removedBtns,o="string"==typeof o?o.split(","):[],r=t.length;r--;){var e=this._mapToolbarSubgroup(t[r],o);"separator"===t[r].type?t[r]="/":CKEDITOR.tools.isArray(e)&&0===e.length?t.splice(r,1):t[r]="string"==typeof e?e:{name:t[r].name,items:e}}return t};t.prototype._mapToolbarSubgroup=function(t,o){if("string"==typeof t)return t;for(var r=t.groups?t.groups.length:0,e=[],n=0;n<r;n+=1){var i=t.groups[n],i=this.fullToolbarEditor.buttonsByGroup["string"===typeof i?i:i.name]||[],i=this._mapButtonsToButtonsNames(i,o),a=i.length,e=e.concat(i);a&&e.push("-")}"-"==e[e.length-1]&&e.pop();return e};t.prototype._mapButtonsToButtonsNames=function(t,o){for(var r=t.length;r--;){var e=t[r],e="string"===typeof e?e:this.fullToolbarEditor.getCamelCasedButtonName(e.name);-1!==CKEDITOR.tools.indexOf(o,e)?t.splice(r,1):t[r]=e}return t};t.prototype._evaluateValue=function(t){var o;try{var r={};Function("var CKEDITOR = {}; "+t+"; return CKEDITOR;")().editorConfig(r);o=r;for(var e=o.toolbar.length;e--;)o.toolbar[e]||o.toolbar.splice(e,1)}catch(t){o=null}return o};t.prototype.mapToolbarToToolbarGroups=function(t){function o(t,o){for(var t=t.slice(),r=o.length;r--;){var e=t.indexOf(o[r]);-1!==e&&t.splice(e,1)}return t}for(var r={},e=[],n=[],e=t.length,i=0;i<e;i++)if("/"===t[i])n.push("/");else{var a=t[i].items,s={};s.name=t[i].name;s.groups=[];for(var l=a.length,u=0;u<l;u++){var c=a[u];if("-"!==c){var f=this.getToolbarGroupByButtonName(c);-1===s.groups.indexOf(f)&&s.groups.push(f);r[f]=r[f]||{};f=r[f].buttons=r[f].buttons||{};f[c]=f[c]||{used:0,origin:s.name};f[c].used++}}n.push(s)}e=function(t,r){var e=[],n;for(n in t)var i=t[n],a=r[n].slice(),e=e.concat(o(a,Object.keys(i.buttons)));return e}(r,this.fullToolbarEditor.buttonNamesByGroup);return{toolbarGroups:n,removeButtons:e.join(",")}};return t})();